<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">EKS Anywhere on vSphere Homelab | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/kubernetes/eks-anywhere"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="EKS Anywhere on vSphere Homelab | Cloud Catalyst"><meta data-rh="true" name="description" content="vSphere homelab 환경에서 EKS Anywhere 구성하기"><meta data-rh="true" property="og:description" content="vSphere homelab 환경에서 EKS Anywhere 구성하기"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-03-06T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Kubernetes,vsphere,eks anywhere,eks,flux,gitops"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/kubernetes/eks-anywhere"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/eks-anywhere" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/eks-anywhere" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J5EMWGFKQM-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.62ad1f5f.js" as="script">
<link rel="preload" href="/assets/js/main.43a59d48.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="intro" href="/docs/intro">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Intro</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/presentation">Presentation</a><a class="navbar__item navbar__link" href="/archive">Archive</a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/pang4u">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere-adv">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/kubernetes/eks-anywhere">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/what-is-tailscale">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/prometheus/synology-prometheus">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/vSphere-with-Tanzu-homelab-2">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">EKS Anywhere on vSphere Homelab</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-06T00:00:00.000Z" itemprop="datePublished">March 6, 2022</time> · <!-- -->31 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-anywhere">EKS Anywhere<a class="hash-link" href="#eks-anywhere" title="Direct link to heading">​</a></h2><p><code>EKS Anywhere</code>는 eksctl를 사용하는 환경에서 <a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener noreferrer">Kubernetes Cluster API Provider vSphere</a> 인 CAPV를 통해 vSphere 기반으로 쿠버네티스 클러스터를 구성해주는 오픈소스이다. CAPV Spec은 <a href="https://cluster-api.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">Kubernetes Cluster API</a> 기반으로 쿠버네티스 스타일 API형태의 선언적(Declarative) 방식으로 쿠버네티스 클러스터의 Lifecycle을 관리하는 프로젝트이다. </p><p>Ubuntu 또는 Mac admin 환경에서 eksctl 명령어로 로컬 클러스터들을 관리하고 클러스터를 생성, 삭제할 수 있다. 일단 기본적으로 클러스터를 생성하고 관리하는 방식이 eksctl과 거의 유사하다. 또한 EKS 서비스의 배포 버전과 동일한 버전을 사용함으로써 (포스팅 당시 버전 1.21) vSphere 기반 하이브리드 환경에서의 쿠버네티스 클러스터 및 워크로드 관리를 편하게 할 수 있다.</p><p>크게 EKS native 서비스와 크게 다른점 몇가지는 다음과 같다. </p><ul><li>컴퓨팅 환경 : vSphere, Docker(개발환경 구성시)</li><li>노드 지원 OS :  BottleRocket, Ubuntu</li><li>CNI : Cilium</li></ul><p>자세한 내용은 <a href="https://anywhere.eks.amazonaws.com/docs/concepts/eksafeatures/" target="_blank" rel="noopener noreferrer">비교표</a>를 참고하자.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-준비사항">사전 준비사항<a class="hash-link" href="#사전-준비사항" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="로컬-관리-환경">로컬 관리 환경<a class="hash-link" href="#로컬-관리-환경" title="Direct link to heading">​</a></h3><ul><li>Docker 20.x 이상 버전  </li><li>Mac OS(10.15) / Ubuntu(20.04.2 LTS)</li><li>CPU 4코어</li><li>메모리 16GB</li><li>디스크 30GB</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vsphere">vSphere<a class="hash-link" href="#vsphere" title="Direct link to heading">​</a></h3><p><a href="https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/</a></p><ul><li>vCenter 환경의 vSphere 7.0 이상</li><li>최소 VM 4대 (각 2 vCPU, 8GB 메모리, 25GB 디스크 이상 권장)<ul><li>Control Plane 1대</li><li>etcd 노드 1대</li><li>worker 노드 2대</li></ul></li><li>DHCP 환경</li><li>API 서버 용 Static IP 1개</li><li>외부 바이너리, 이미지 다운로드를 위한 네트워크 환경<ul><li>클러스터 자체에서 방화벽 등으로 인한 인터넷이 안되는 경우 <a href="https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/proxy/" target="_blank" rel="noopener noreferrer">프록시 구성</a>을 통해 가능함</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="homelab-구성환경">Homelab 구성환경<a class="hash-link" href="#homelab-구성환경" title="Direct link to heading">​</a></h2><p>기존에 운영하던 ESXi 환경을 그대로 활용하도록 했다. 추가적으로 하드웨어를 구비하기 위해 비용이 발생한부분은 없다.   </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hardware">Hardware<a class="hash-link" href="#hardware" title="Direct link to heading">​</a></h3><ul><li>Dell Precision Tower 3620<ul><li>Intel(R) Xeon(R) CPU E3-1240L v5</li><li>TeamGroup DDR4-2666 16GB * 4ea</li><li>(VM 용) SAMSUNG NVMe SSD PM981 - 1TB</li><li>(ESXi 용) Sandisk SSD Z410- 240GB</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="software">Software<a class="hash-link" href="#software" title="Direct link to heading">​</a></h3><ul><li>vSphere 7.0 Update 3</li><li>vCenter 7.0.3 (VSCA)</li><li>Docker Desktop <a href="https://docs.docker.com/desktop/mac/release-notes/#docker-desktop-420" target="_blank" rel="noopener noreferrer">4.2.0</a>버전을 사용 <ul><li>4.3.0 버전 하위 호환 문제가있어 금번 테스트 환경에서는 4.2.0 사용</li><li>도커 리소스를 최소 <code>8vCPU</code>, <code>16GB</code>로 설정</li></ul></li><li><a href="https://kubernetes.io/ko/docs/tasks/tools/" target="_blank" rel="noopener noreferrer">kubectl</a> v1.23.4</li><li><a href="https://eksctl.io/introduction/#installation" target="_blank" rel="noopener noreferrer">eksctl</a> v0.85.0</li><li><a href="https://anywhere.eks.amazonaws.com/docs/getting-started/install/" target="_blank" rel="noopener noreferrer">eksctl-anywhere</a> v0.7.0</li><li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html" target="_blank" rel="noopener noreferrer">aws-iam-authenticator</a> v0.5.5</li><li><a href="https://anywhere.eks.amazonaws.com/docs/reference/artifacts/" target="_blank" rel="noopener noreferrer">bottlerocket OVA</a> v1.21 (자동 생성되는 OVA로 별도 구성이 필요없다)  </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-환경구성">클러스터 환경구성<a class="hash-link" href="#클러스터-환경구성" title="Direct link to heading">​</a></h2><p><a href="https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/" target="_blank" rel="noopener noreferrer">공식 홈페이지의 클러스터 생성, 삭제 워크플로우</a>를 참고하여 사전 구성된 Homelab에 적용한다. </p><p><img loading="lazy" src="https://anywhere.eks.amazonaws.com/images/eks-a_create_cluster.png" alt="workflow" class="img_E7b_"></p><p>처음에는 eksctl 명령으로 클러스터를 생성하는 과정으로 사전에 생성한 cluster config yaml을 통해 로컬 도커 엔진에 bootstrap을 하는 명령을 내린다. 이때 로컬 도커 엔진에서는 Docker in Docker 엔진인 <a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">kind</a>를 통해 클러스터 번들 컨피그를 생성한다. </p><p><a href="https://github.com/kubernetes-sigs/cluster-api/tree/main/cmd/clusterctl" target="_blank" rel="noopener noreferrer">clusterctl</a>를 통해 <a href="https://github.com/kubernetes-sigs/cluster-api/tree/main/test/infrastructure/docker" target="_blank" rel="noopener noreferrer">Cluster API Provider Docker</a>형태로 부모(bootstrap) 클러스터를 만드는 과정이 <code>eksctl anywhere</code> 명령으로 추상화 되는것이라 볼 수 있다. </p><p>해당 단계에서 먼저 Bastion Host나 관리 머신에 <code>kubectl</code>, <code>eksctl</code>, <code>eksctl-anywhere</code>, <code>aws-iam-authenticator</code> 등이 설치되어 있는지 확인한다.</p><p><a href="https://anywhere.eks.amazonaws.com/docs/getting-started/install/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/getting-started/install/</a></p><p><code>homelab</code> 이름으로 클러스터 컨피그를 생성한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">CLUSTER_NAME=homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksctl anywhere generate clusterconfig $CLUSTER_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   --provider vsphere &gt; $CLUSTER_NAME.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 컨피그에 대한 상세 설정은 <a href="https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/vsphere/" target="_blank" rel="noopener noreferrer">vSphere configuration</a> 에서 확인할 수 있다. </p><p>생성된 컨피그를 하나씩 살펴보자. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterNetwork</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cni</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">pods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.0.0/20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 10.96.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controlPlaneConfiguration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.31.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datacenterRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereDatacenterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">externalEtcdConfiguration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gitOpsRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitOpsConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gitops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubernetesVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.21&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">managementCluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workerNodeGroupConfigurations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>첫번째는 <code>Cluster</code> 리소스로 Cluster의 이름과 클러스터 전반 설정과 Control Plane, Data Plane, etcd VM의 버전, 개수 등을 정할 수 있다. </p><p>클러스터 이름은 <code>homelab</code>으로 설정한다. 기본적으로 CNI는 Cilium을 사용하는 구조이기 때문에 필수적으로 <code>cilium</code>로 설정해야 한다. 그리고 kubeadm 구성시 필요한 <code>pods.cidrBlocks</code>과 <code>services.cidrBlocks</code>에서 파드와 서비스가 사용할 네트워크 대역을 설정한다. 둘다 CNI에서 통신되는 가상 네트워크 대역이기 때문에 현재 사용중인 샤오미 공유기 대역(192.168.31.x)과 충돌하지 않으면서 라우팅에 문제되지 않고 현재 네트워크에 사용되지 않는 대역(192.168.0.0/20, 10.96.0.0/12) 으로 설정했다.  </p><blockquote><p>DHCP 유의사항: 본인의 경우 Xiaomi 공유기를 사용중인데 별도의 DHCP서버를 구성하지 않고 사용을 하고 있어서인지, 신규 노드를 위한 VM이 생성되고 <code>bottlerocket</code> OS가 기동될때 호스트명이 <code>MiWifi-R3600-SRV</code> 이런식으로 대소문자를 포함한 형태로 자동 생성되다 보니 부팅이 되지 않는 현상이 발생했다. 이에 <a href="https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-dhcp/" target="_blank" rel="noopener noreferrer">별도의 DHCP 구성</a>을 통해 진행을 하면 해당 이슈를 피할수 있다. </p></blockquote><p><code>controlPlaneConfiguration</code> 필드에서는 controlPlane 노드의 <code>count</code>와 <code>endpoint</code>를 설정해야 한다. <code>count</code> 초기 값은 <code>2</code>로 되어 있지만 홈랩의 자원이 부족하기 때문에 <code>1</code>로 설정했다. 실제 프로덕션에서는 2이상을 권고한다. 그리고 <code>endpoint.host</code>는 쿠버네티스 API서버 엔드포인트로 실제 kubectl 명령 및 사용자와 인터페이스를 위한 접근 가능한 DHCP 할당으로 충돌되지 않는 네트워크 대역의 고정 IP로 설정한다. <code>machineGroupRef</code>는 이후 생성할 VM spec에 매칭시킬 label 값으로 자동 생성된다. </p><p><code>externalEtcdConfiguration</code>는 etcd 구성을 위한 필드로 <code>count</code>는 기본설정 값이 <code>3</code>이지만 홈랩 환경에서는 <code>1</code>로 구성하였다. 실제 프로덕션에서는 Raft 알고리즘 기반 Redundancy 구성을 위해 <code>3</code>이상을 권고한다.</p><p><code>gitOpsRef</code>는 GitOps 형태로 클러스터를 관리하기 위해 참조하는 값으로 아래 <code>GitOpsConfig</code> 에서 사용할 이름 <code>cluster-gitops</code> 를 명시한다. </p><p><code>kubernetesVersion</code>은 EKS 배포 버전와 동일한 <code>1.21</code>로 설정한다. </p><p><code>workerNodeGroupConfigurations</code>은 워커노드 구성으로 <code>count</code>를 <code>2</code>로 설정하였다. </p><p>다음은 배포되는 vSphere spec을 정의하는 리소스로 <code>VSphereDatacenterConfig</code>이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereDatacenterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datacenter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Datacenter&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">insecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">network</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VM Network&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.31.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">thumbprint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>spec</code>에서는 실제 vCenter의 엔드포인트, datacenter, network 정보 등을 입력한다. </p><blockquote><p>유의사항 : <code>insecure</code> 옵션의 경우 기본값이 false로 되어 있다. 해당 값이 <code>false</code>의 경우 아래 그림에 있는 것 처럼 보통 vCenter 메뉴에서 <code>thumbprint</code> 값을 확인할 수 있고 해당 값을 <code>**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**</code> 형태로 변경하여 사용하거나 <a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">govc</a>를 사용하여 <code>govc about.cert -thumbprint -k</code> 명령어로 확인이 가능하다.</p></blockquote><p><img loading="lazy" alt="cert" src="/assets/images/vsphere_cert-46b8ff831c6ea16844e8182f910d0650.png" width="1762" height="1214" class="img_E7b_"></p><p>마지막은 각 노드 역할(control plane, etcd, worker)별로 사용할 OS 및 리소스 spec을 정의하는 컨피그이다. 위 <code>Cluster</code> 리소스에서 설정된 <code>machineGroupRef.name</code>으로 매칭되는 값을 metadata로 자동 생성 해주고 모두 유사하기 때문에 이중 <code>VSphereMachineConfig</code>만 살펴본다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datastore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;datastore2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">diskGiB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">folder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">memoryMiB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8192</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">numCPUs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">osFamily</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourcePool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/Resources&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ec2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sshAuthorizedKeys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ssh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rsa AAAAB3</span><span class="token important">******U=</span><span class="token plain"> vsphere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Datacenter에 구성한 <code>datastore</code>중 설치되는 VM 영역이 사용할 대상 datastore를 입력한다. VM디스크 <code>diskGiB</code>, Datacenter <code>folder</code>, VM메모리 <code>memoryMiB</code>, vCPU <code>numCPUs</code>를 입력하고, <code>resourcePool</code>은 지정 리소스 그룹을 별도로 설정하지 않았기 때문에 <code>&quot;*/Resources&quot;</code>로 설정한다. 그리고 <code>osFamily</code>는 ubuntu, bottlerocket두가지로 제공이 되는데 기본값은 bottlerocket이고, 해당 이미지의 기본 user는 <code>ec2-user</code>로 설정하고 해당 VM에 SSH접근을 위해서 별도로 생성한 <code>sshAuthorizedKeys</code>를 입력한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitOpsConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gitops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">flux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">github</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">branch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">clusterConfigPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> clusters/homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fluxSystemNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">personal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">anywhere</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">homelab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>마지막은 클러스터를 GitOps 스타일로 관리하기 위해 <code>GitOpsConfig</code>를 추가한다. spec 에서 사용할 github의 <code>branch</code>, github 레포 아래 컨피그가 저장될 경로인 <code>clusterConfigPath</code>, gitops 오픈소스인 <a href="https://fluxcd.io/docs/get-started/" target="_blank" rel="noopener noreferrer">Flux</a>가 구성될 네임스페이스인 <code>fluxSystemNamespace</code>, github account인 <code>owner</code>, repo 이름이 되는 <code>repository</code> 까지 설정한다. 해당 구성을 포함한 채로 클러스터를 배포하게 되면 클러스터가 생성되는 중에 선언한 <code>repository</code>로 이후 관리될 클러스터 컨피그 및 kustomize 파일 등을 <code>commit</code>하게 된다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-생성">클러스터 생성<a class="hash-link" href="#클러스터-생성" title="Direct link to heading">​</a></h2><p>나머지 etcd, worker node 도 <code>VSphereMachineConfig</code>를 동일한 형식으로 작성하고, vSphere 관련 인증정보와 gitops로 활용할 레포의 github token을 환경변수로 입력하여 클러스터 생성을 진행한다. 홈랩으로 구성한 샘플 컨피그는 <a href="https://raw.githubusercontent.com/ddiiwoong/eks-anywhere-homelab/main/clusters/homelab/homelab/eksa-system/eksa-cluster.yaml" target="_blank" rel="noopener noreferrer">링크</a>에서 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_VSPHERE_USERNAME=&#x27;administrator@ddii.local&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_VSPHERE_PASSWORD=&#x27;***********&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_GITHUB_TOKEN=ghp_************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl anywhere create cluster -f homelab.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: The recommended size of an external etcd cluster is 3 or 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checking Github Access Token permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Github personal access token has the required repo permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Performing setup and validations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Connected to server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Authenticated to vSphere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datacenter validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Network validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Control plane and Workload templates validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Vsphere Provider setup is valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Flux path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Create preflight validations pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating new bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing cluster-api providers on bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Provider specific setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating new workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing networking on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing storage class on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing cluster-api providers on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing EKS-A secrets on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Moving cluster management from bootstrap to workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing EKS-A custom components (CRD and controller) on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating EKS-A CRDs instances on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing AddonManager and GitOps Toolkit on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Adding cluster configuration files to Git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enumerating objects: 20, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Counting objects: 100% (20/20), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compressing objects: 100% (12/12), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total 20 (delta 1), reused 19 (delta 0), pack-reused 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finalized commit and committed to local repository  {&quot;hash&quot;: &quot;ea4293c849725e593704c2a8ff71a708ad8cf8f2&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Writing cluster config file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deleting bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">🎉 Cluster created!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>각 단계를 순서대로 간단히 살펴보면 처음 bootstrap cluster 구성 단계에서는 아래와 같은 일을 수행한다.</p><ul><li>Github Access Token 권한 확인</li><li>vSphere 인증</li><li>vSphere 리소스(Datacenter, Network, Datastore, Folder 등) 검증</li><li>Control Plane, Workload Plane 템플릿 검증</li><li>kind로 bootstrap cluster 생성</li><li>cluster-api provider 역할을 하는 CAPI(Cluster API) 설치</li></ul><p>다음은 생성된 bootstrap cluster의 CAPI 관리도구가 vSphere 클러스터에 연결후에 진행한다.</p><ul><li><a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">govc</a>를 사용해서 연결된 vSphere 클러스터에 새로운 etcd를 포함한 Control, Workload 노드 생성</li><li><a href="https://cilium.io/" target="_blank" rel="noopener noreferrer">Cilium</a> CNI 추가</li><li>Storage Class 추가</li><li>구성된 Workload Cluster에 CAPI 추가<ul><li>provider 셋업</li><li>추가적인 CRD 및 GitOps 컴포넌트 추가</li></ul></li><li>GitOps를 위해 최초 생성된 cluster config를 지정한 repo에 Commit </li><li>마지막으로 로컬 관리 머신에 cluster config를 저장</li></ul><p>각각의 단계에 대한 설명은 <a href="https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/#4-authenticate-and-create-bootstrap-cluster" target="_blank" rel="noopener noreferrer">다음 링크</a>에서 확인할 수 있다. </p><p>처음 몇번 시도를 하다보면 여러가지 에러사항을 만나게 된다. 해당 단계의 디버그 레벨 출력을 보기 위해서는 <code>-v 9</code> 플래그를 추가해서 설치를 진행하면 상세 내역을 확인할 수 있는데 debug 레벨로 마지막 몇줄 로그를  살펴보면 도커에서 kind로 도커내에 클러스터를 구성한 이후에 docker내 kind 클러스터를 삭제하는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:33.638+0900    V4      Deleting kind cluster   {&quot;name&quot;: &quot;homelab-eks-a-cluster&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:33.638+0900    V6      Executing command       {&quot;cmd&quot;: &quot;/usr/local/bin/docker exec -i eksa_1646374542969789000 kind delete cluster --name homelab-eks-a-cluster&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deleting cluster &quot;homelab-eks-a-cluster&quot; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V0      🎉 Cluster upgraded!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      Task finished   {&quot;task_name&quot;: &quot;delete-kind-cluster&quot;, &quot;duration&quot;: &quot;4.560798797s&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      ----------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      Tasks completed {&quot;duration&quot;: &quot;7m50.030420843s&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:37.227+0900    V3      Cleaning up long running container      {&quot;name&quot;: &quot;eksa_1646374542969789000&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:37.228+0900    V6      Executing command       {&quot;cmd&quot;: &quot;/usr/local/bin/docker rm -f -v eksa_1646374542969789000&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>몇가지 경험한 에러 사항을 나열해 보면 위에서도 언급한 내용과 같이 Cluster 컨피그 내 <code>vSphere thumbprint</code>를 반드시 넣어주는것이 좋다. 공식 가이드에는 <code>insecure</code> 필드를 true로 설정하고 <code>thumbprint</code>를 null로 진행할 경우 아래와 같이 kubeconfg secret을 구성단계에서 실패하거나 Workload 노드가 join할 때 에러가 발생하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl anywhere create cluster -f eksa-mgmt-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collecting management cluster diagnostics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⏳ Collecting support bundle from cluster, this can take a while {&quot;cluster&quot;: &quot;bootstrap-cluster&quot;, &quot;bundle&quot;: &quot;mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml&quot;, &quot;since&quot;: 1646227532274217000, &quot;kubeconfig&quot;: &quot;mgmt/generated/mgmt.kind.kubeconfig&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Support bundle archive created  {&quot;path&quot;: &quot;support-bundle-2022-03-02T14_25_34.tar.gz&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Analyzing support bundle    {&quot;bundle&quot;: &quot;mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml&quot;, &quot;archive&quot;: &quot;support-bundle-2022-03-02T14_25_34.tar.gz&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Analysis output generated   {&quot;path&quot;: &quot;mgmt/generated/bootstrap-cluster-2022-03-02T23:27:23+09:00-analysis.yaml&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collecting workload cluster diagnostics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: failed to create cluster: error checking availability of kubeconfig secret: kubeconfig secret does not exist</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 클러스터 배포가 되었으면 eksctl config yaml이 포함된 디렉토리 하위에 클러스터 이름으로 새로운 디렉토리와 <code>kubeconfig</code>와 실제 배포된 cluster config를 확인 할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── homelab-eks-a-cluster.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── homelab-eks-a-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── homelab.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존 kubeconfig와 merge를 위해 <a href="https://github.com/kubernetes-sigs/krew" target="_blank" rel="noopener noreferrer">krew</a>를 통해 설치한  <a href="https://github.com/corneliusweig/konfig" target="_blank" rel="noopener noreferrer">konfig</a> 도구를 사용해서 기존 컨피그와 병합한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl konfig merge ~/.kube/config ./homelab/homelab-eks-a-cluster.kubeconfig &gt; merged-and-flattened-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; mv merged-and-flattened-config ~/.kube/config</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성된 리소스를 확인해보면 <code>Bottlerocket</code> OS 이미지와 <code>containerd://1.5.8+bottlerocket</code> CRI를 확인할 수 있다. 노드 이름이 IP로 보이는 이유는 DHCP서버를 별도로 두지 않아 Prefix 할당이 되지 않는 가정용 공유기 환경에서 발생하는 현상이다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP      EXTERNAL-IP      OS-IMAGE                                  KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.186   Ready    control-plane,master   9m     v1.21.6   192.168.31.186   192.168.31.186   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.187   Ready    &lt;none&gt;                 8m     v1.21.6   192.168.31.187   192.168.31.187   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.188   Ready    &lt;none&gt;                 7m     v1.21.6   192.168.31.188   192.168.31.188   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.189   Ready    control-plane,master   7m     v1.21.6   192.168.31.189   192.168.31.189   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>CRD 리스트를 확인해보자. 많은 CRD중에 <code>x-k8s.io</code>로 필터를 하면 <code>machine</code>, <code>vsphere</code>, <code>cluster</code> 관련된 정보를 확인할수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get crd | grep &quot;x-k8s.io&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterclasses.cluster.x-k8s.io                              2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterresourcesetbindings.addons.cluster.x-k8s.io           2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterresourcesets.addons.cluster.x-k8s.io                  2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusters.cluster.x-k8s.io                                    2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadmclusters.etcdcluster.cluster.x-k8s.io                 2022-03-04T14:30:41Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:38Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:34Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmconfigtemplates.bootstrap.cluster.x-k8s.io            2022-03-04T14:30:34Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmcontrolplanes.controlplane.cluster.x-k8s.io           2022-03-04T14:30:45Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io   2022-03-04T14:30:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinedeployments.cluster.x-k8s.io                          2022-03-04T14:30:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinehealthchecks.cluster.x-k8s.io                         2022-03-04T14:30:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinepools.cluster.x-k8s.io                                2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machines.cluster.x-k8s.io                                    2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinesets.cluster.x-k8s.io                                 2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">providers.clusterctl.cluster.x-k8s.io                        2022-03-04T14:27:56Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclusteridentities.infrastructure.cluster.x-k8s.io     2022-03-04T14:30:51Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclusters.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclustertemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheredeploymentzones.infrastructure.cluster.x-k8s.io       2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspherefailuredomains.infrastructure.cluster.x-k8s.io        2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheremachines.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheremachinetemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspherevms.infrastructure.cluster.x-k8s.io                   2022-03-04T14:30:54Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이중 <code>machine</code> CRD를 확인해보면 etcd를 볼 수 있는데 이는 VM인스턴스 형태의 외부 리소스 형태로 배포되기 때문에 쿠버네티스 노드 정보에서는 확인할수 없던 <code>etcd</code> 머신을 확인을 할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get machine -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   11m     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   11m     v1.21.5-eks-1-21-8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 구성 파드들을 살펴보면 CAPI 관련 리소스, cert-manager, eks-anywhere, Cilium CNI, vSphere 관련 컨트롤러 등을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get pod -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-694cc79bb7-2h29c       1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-5b6b48dd8c-g6md4   1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-system                         capi-controller-manager-689cd9b4fd-vxpc8                         1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capv-system                         capv-controller-manager-6b467446b9-n865b                         1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-7988d4fb6c-72fw7                                    1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-cainjector-6bc8dcdb64-7d7qg                         1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-webhook-68979bfb95-hjq8m                            1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system                         eksa-controller-manager-5c74596687-45v8t                         2/2     Running   0          3h41m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadm-bootstrap-provider-system   etcdadm-bootstrap-provider-controller-manager-74c86ffb56-cpw9k   1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadm-controller-system           etcdadm-controller-controller-manager-7894945688-js7z4           1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-bq5gq                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-fn2f7                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-lgptt                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-operator-86d59d5c88-76z2t                                 1/1     Running   1          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-operator-86d59d5c88-9p4s9                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-w55nc                                                     1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-wk89j                                                     1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         coredns-745c7986c7-k729b                                         1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         coredns-745c7986c7-thtbm                                         1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-apiserver-192.168.31.189                                    1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-controller-manager-192.168.31.189                           1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-6xcdk                                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-d4qbv                                                 1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-mhzb4                                                 1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-vrw2p                                                 1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-xkfmh                                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-scheduler-192.168.31.189                                    1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-vip-192.168.31.189                                          1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-bxp4t                           1/1     Running   2          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jdncv                           1/1     Running   3          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jhbbp                           1/1     Running   2          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jpn89                           1/1     Running   2          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-qblld                           1/1     Running   1          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-controller-576c9c8dc8-9k2lm                          5/5     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-9fbs2                                           3/3     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-ffjlv                                           3/3     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-lrkqk                                           3/3     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-s49x6                                           3/3     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-z5hdz                                           3/3     Running   0          3h44m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="로드밸런서-구성">로드밸런서 구성<a class="hash-link" href="#로드밸런서-구성" title="Direct link to heading">​</a></h2><p>쿠버네티스 v1.14.2 이후 버전부터는 <code>IPVS</code>모드에서 kube-proxy 사용을 위해 MetalLB 구성전에 <a href="https://metallb.universe.tf/installation/#preparation" target="_blank" rel="noopener noreferrer">strict ARP 모드를 활성화</a>해야한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -e &quot;s/strictARP: false/strictARP: true/&quot; | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl describe configmap -n kube-system kube-proxy | grep ARP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strictARP: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>미리 서비스에서 사용할 IP 대역을 지정하기 위해 helm chart configmap value를 미리 생성한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; &#x27;EOF&#x27; &gt;&gt; values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configInline:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address-pools:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: layer2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addresses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - 192.168.31.10-192.168.31.19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>metallb가 사용할 네임스페이스 <code>metallb-system</code>를 만들고 위 configmap value파일로 metalLB를 설치한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add metallb https://metallb.github.io/metallb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns metallb-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install metallb metallb/metallb -n metallb-system -f values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get all -n metallb-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-controller-69bbb4669c-2pdnk   1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-2km46                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-cm9xw                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-dptbx                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-jk7hn                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-kgfkl                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-t7qkw                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/metallb-speaker   6         6         6       6            6           kubernetes.io/os=linux   115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/metallb-controller   1/1     1            1           115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                            DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/metallb-controller-69bbb4669c   1         1         1       115s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>metallb 리소스가 모두 정상으로 올라오면 서비스 하나를 LoadBalancer 타입으로 배포하고 해당 서비스로 접속해본다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f https://anywhere.eks.amazonaws.com/manifests/hello-eks-a.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl expose deployment hello-eks-a --port=80 --type=LoadBalancer --name=hello-eks-a-lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; SVC1EXIP=$(kubectl get svc hello-eks-a-lb -o jsonpath=&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; curl $SVC1EXIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thank you for using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████╗██╗  ██╗███████╗                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔════╝██║ ██╔╝██╔════╝                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">█████╗  █████╔╝ ███████╗                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══╝  ██╔═██╗ ╚════██║                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████╗██║  ██╗███████║                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">╚══════╝╚═╝  ╚═╝╚══════╝                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> █████╗ ███╗   ██╗██╗   ██╗██╗    ██╗██╗  ██╗███████╗██████╗ ███████╗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══██╗████╗  ██║╚██╗ ██╔╝██║    ██║██║  ██║██╔════╝██╔══██╗██╔════╝</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████║██╔██╗ ██║ ╚████╔╝ ██║ █╗ ██║███████║█████╗  ██████╔╝█████╗  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══██║██║╚██╗██║  ╚██╔╝  ██║███╗██║██╔══██║██╔══╝  ██╔══██╗██╔══╝  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██║  ██║██║ ╚████║   ██║   ╚███╔███╔╝██║  ██║███████╗██║  ██║███████╗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝    ╚══╝╚══╝ ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You have successfully deployed the hello-eks-a pod hello-eks-a-9644dd8dc-647bq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For more information check out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://anywhere.eks.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="인그레스-컨트롤러-설치">인그레스 컨트롤러 설치<a class="hash-link" href="#인그레스-컨트롤러-설치" title="Direct link to heading">​</a></h2><p>API Gateway 오픈소스인 <a href="https://docs.solo.io/gloo-edge/latest/" target="_blank" rel="noopener noreferrer">Gloo Edge</a>를 인그레스 컨트롤러로 사용할 수 있다. <code>Envoy</code> 기반의 경량화된 오픈소스로 쿠버네티스 네이티브한 옵션들을 제공하기 때문에 개인적으로 선호하는편이다. 공식 설치 문서는 다음 링크에서 확인할 수 있다.</p><p><a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/" target="_blank" rel="noopener noreferrer">https://docs.solo.io/gloo-edge/latest/installation/ingress/</a></p><p>공식 CLI인 <a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-glooctl" target="_blank" rel="noopener noreferrer">glooctl</a>나 <a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-helm" target="_blank" rel="noopener noreferrer">Helm Chart</a>로 설치를 진행할 수 있다. ingress를 구성하기 위해 <code>gateway.enabled</code> value값을 <code>false</code>로 <code>ingress.enabled</code> value를 <code>true</code>로 변경하여 inline 구성으로 배포를 진행한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add gloo https://storage.googleapis.com/solo-public-helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install gloo gloo/gloo --namespace gloo-system \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set gateway.enabled=false,ingress.enabled=true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get all -n gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/discovery-9694c78f6-zrf4l        1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/gloo-7cd566cb69-bfghh            1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ingress-7fb5c9687d-qq98j         1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ingress-proxy-5cc555c45b-9mj9n   1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                               AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/gloo            ClusterIP      10.100.162.70   &lt;none&gt;          9977/TCP,9976/TCP,9988/TCP,9979/TCP   88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/ingress-proxy   LoadBalancer   10.107.107.38   192.168.31.11   80:32207/TCP,443:32228/TCP            88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/discovery       1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/gloo            1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/ingress         1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/ingress-proxy   1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                       DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/discovery-9694c78f6        1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/gloo-7cd566cb69            1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/ingress-7fb5c9687d         1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/ingress-proxy-5cc555c45b   1         1         1       88s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>샘플 <code>petstore</code> 서비스를 배포하고, 인그레스 클래스 어노테이션을 <code>kubernetes.io/ingress.class: gloo</code>로 선언하고 <code>ddiiwoong.com</code> 호스트 이름으로 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://raw.githubusercontent.com/solo-io/gloo/v1.2.9/example/petstore/petstore.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: petstore-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # note: this annotation is only required if you&#x27;ve set </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # REQUIRE_INGRESS_CLASS=true in the environment for </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # the ingress deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/ingress.class: gloo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: ddiiwoong.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - path: /.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pathType: ImplementationSpecific</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name: petstore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            port:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              number: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME               CLASS    HOSTS           ADDRESS         PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">petstore-ingress   &lt;none&gt;   ddiiwoong.com   192.168.31.11   80      7m41s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 호스트로 정상 라우팅되어 접속되는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; curl -H &quot;Host: ddiiwoong.com&quot; 192.168.31.11/api/pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{&quot;id&quot;:1,&quot;name&quot;:&quot;Dog&quot;,&quot;status&quot;:&quot;available&quot;},{&quot;id&quot;:2,&quot;name&quot;:&quot;Cat&quot;,&quot;status&quot;:&quot;pending&quot;}]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gitops-컨트롤러로-클러스터-관리">GitOps 컨트롤러로 클러스터 관리<a class="hash-link" href="#gitops-컨트롤러로-클러스터-관리" title="Direct link to heading">​</a></h2><p>gitops 오픈소스인 <a href="https://fluxcd.io/docs/get-started/" target="_blank" rel="noopener noreferrer">Flux</a>를 사용해서 여러가지 클러스터 관리를 수행할 수 있다. 위에서 생성한 <code>desired state</code>인 클러스터 컨피그를 github repo에서 Flux 컨트롤러를 통해 클러스터 운영을 수행할 수 있다. </p><p><a href="https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/</a></p><p>Worker 노드와 Control Plan, Etcd등의 vSphere에서 관리하는 datastore, 디스크, 메모리, CPU, resourcepool 등을 관리할 수 있다. 단, EKS의 관리형 노드그룹과 유사한 방식으로 노드그룹의 VM의 숫자를 늘리거나 줄일수 있지만 아직까지 신규로 worker 노드그룹을 생성하거나 삭제하는 기능은 제공하지 않는다.</p><p>초기 클러스터 컨피그에 아래와 같이 기존 노드그룹 <code>md-0</code>에 신규 VM 1대를 추가해보자. (2대-&gt;3대)</p><ul><li><code>clusters/$CLUSTER_NAME/eksa-system/eksa-cluster.yaml</code></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workerNodeGroupConfigurations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 환경에서 구성된 gitops repo에 수정된 파일을 커밋한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git add clusters/homelab/eksa-system/eksa-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git commit -m &#x27;Scale from 2 to 3 at WorkerNodeGroup md-0 &#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push origin main</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>md-0</code> 노드그룹에 VM이 새롭게 추가된 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get machine -n eksa-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   75m   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-j68fd   homelab   192.168.31.190   vsphere://421bc1ee-eac7-f1db-b351-5fac25b45fc0   Running   11m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   75m   v1.21.5-eks-1-21-8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 eks-anywhere 오픈소스를 vSphere 홈서버에서 테스트를 진행한 경험을 정리했다. </p><p>설치를 진행하면서 에러가 나면 하나하나 공식 문서를 확인하고, 회사 슬랙 찬스도 사용하면서 힘들게 설치를 완료했다. 생각보다 디버깅을 하는데 많은 시간을 허비했는데 실제로 2일 이상 고생을 했다. 대부분의 경우 디버그 레벨의 로그를 보면서 트러블슈팅을 통해 문제 해결이 가능했고 그 과정에서 EKS Anywhere의 내부 구성요소들과 실제 Cluster API 워크플로우를 이해할 수 있었다. </p><p>다만 아직까지 문서화나 커뮤니티에 많은 유스케이스가 없다는 점과 Cilium을 메인 CNI로 활용함에도 불구하고 <code>CiliumNetworkPolicy</code> API를 사용하지 못하는 점이나 Cilium 유저 인터페이스인 <a href="https://github.com/cilium/hubble-ui" target="_blank" rel="noopener noreferrer">Hubble UI</a>를 활성화해서 사용할 수가 없는 <a href="https://anywhere.eks.amazonaws.com/docs/tasks/workload/networking-and-security/#additional-cilium-features" target="_blank" rel="noopener noreferrer">제약사항</a>등이 있었고, 쿠버네티스 관련해서는 <code>Persistent Volume</code> 관련하여 vSAN을 사용하지 않은 환경에서는 VMDK를 수동으로 생성하고 해당 볼륨을 매핑시켜야 활용이 가능한 제약사항이 존재하는 것이 조금 아쉬운 부분이다.</p><p>실제 프로덕션 환경에서 사용할 정도라기 보단 EKS를 사용하는 관점에서 유사한 경험을 바탕으로 개발환경을 가져갈수 있고 tanzu나 다른 cluster-api를 활용한 도구들 보다 좀더 유연하고 오픈소스에 가까운 경험성을 제공한다고 생각한다. 게다가 Flux의 <code>Server-side reconciliation</code> 기반 <a href="https://kubernetes.io/docs/reference/using-api/server-side-apply/" target="_blank" rel="noopener noreferrer">쿠버네티스 리소스 관리 방식</a>으로 클러스터를 매우 유연하게 관리할 수 있다는 것도 주목해볼만한 내용이라 생각한다. 클러스터 자체도 인프라 리소스라 가정하고 최초에 원하는 형태로 선언하고 구성이후에도 쿠버네티스 CRD 형식으로 노드그룹과 인스턴스 등의 여러 리소스를 GitOps 방식으로 관리하는 방식을 채택하고 있기 때문에 실제 인프라 관리를 하는 운영자를 위한 가장 효과적인 방법을 채택했다고 볼 수 있다.</p><p>그리고 표준규격의 Managed 하드웨어를 사용하는 Outpost와 비교하는 자료들이 최근 많이 올라오고 있는데 EKS Anywhere의 가장 큰 장점은 내가 가진 하드웨어를 EKS Distro기반의 오픈소스를 통해 사용할 수 있고 AWS 환경과의 직접적인 통신이 없이도 자체적인 워크로드 운영이 가능한게 가장 큰 장점이라고 생각한다. </p><p>현재 재직중인 회사의 제품과 관련해서 로드맵을 자세히 언급하지는 못하지만 엔터프라이즈 vSphere 환경과 동시에 EKS를 사용하는 조직에서는 중요한 하나의 선택지가 될 수 있다는 점에서도 지켜볼만하다고 생각한다. </p><p>다음 포스팅에서는 해당 클러스터에 OpenTelemetry collector, Loki, Prometheus 구성을 통한 observability 환경 구성을 진행해볼 예정이다.</p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vsphere">vsphere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks-anywhere">eks anywhere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks">eks</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/flux">flux</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitops">gitops</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ddiiwoong/newblog/tree/main/blog/2022-03-06-eks-anywhere.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubernetes/eks-anywhere-adv"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">EKS Anywhere Advanced Usages</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kubernetes/what-is-tailscale"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">What is Tailscale?</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eks-anywhere" class="table-of-contents__link toc-highlight">EKS Anywhere</a></li><li><a href="#사전-준비사항" class="table-of-contents__link toc-highlight">사전 준비사항</a><ul><li><a href="#로컬-관리-환경" class="table-of-contents__link toc-highlight">로컬 관리 환경</a></li><li><a href="#vsphere" class="table-of-contents__link toc-highlight">vSphere</a></li></ul></li><li><a href="#homelab-구성환경" class="table-of-contents__link toc-highlight">Homelab 구성환경</a><ul><li><a href="#hardware" class="table-of-contents__link toc-highlight">Hardware</a></li><li><a href="#software" class="table-of-contents__link toc-highlight">Software</a></li></ul></li><li><a href="#클러스터-환경구성" class="table-of-contents__link toc-highlight">클러스터 환경구성</a></li><li><a href="#클러스터-생성" class="table-of-contents__link toc-highlight">클러스터 생성</a></li><li><a href="#로드밸런서-구성" class="table-of-contents__link toc-highlight">로드밸런서 구성</a></li><li><a href="#인그레스-컨트롤러-설치" class="table-of-contents__link toc-highlight">인그레스 컨트롤러 설치</a></li><li><a href="#gitops-컨트롤러로-클러스터-관리" class="table-of-contents__link toc-highlight">GitOps 컨트롤러로 클러스터 관리</a></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.62ad1f5f.js"></script>
<script src="/assets/js/main.43a59d48.js"></script>
</body>
</html>