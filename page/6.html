<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">Cloud Catalyst | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/page/6"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="Cloud Catalyst | Cloud Catalyst"><meta data-rh="true" name="description" content="My little thought may as a catalyst in other engineer&#x27;s career"><meta data-rh="true" property="og:description" content="My little thought may as a catalyst in other engineer&#x27;s career"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/page/6"><link data-rh="true" rel="alternate" href="https://ddii.dev/page/6" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/page/6" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J5EMWGFKQM-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.fedfc763.js" as="script">
<link rel="preload" href="/assets/js/main.1aff5f87.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="intro" href="/docs/intro">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Intro</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/presentation">Presentation</a><a class="navbar__item navbar__link" href="/archive">Archive</a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/pang4u">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/18/eks-anywhere-adv">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/06/eks-anywhere">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/05/what-is-tailscale">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/06/11/synology-prometheus">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2020/12/06/vSphere-with-Tanzu-homelab-2">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/07/26/dex">Dex</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-26T00:00:00.000Z" itemprop="datePublished">July 26, 2018</time> · <!-- -->10 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dex---a-federated-openid-connect-provider">Dex - A federated OpenID Connect provider<a class="hash-link" href="#dex---a-federated-openid-connect-provider" title="Direct link to heading">​</a></h2><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dex는-기본적으로-openid-connect를-사용하여-다른-애플리케이션의-인증을-하게-해주는-identity-서비스다">dex는 기본적으로 OpenID Connect를 사용하여 다른 애플리케이션의 인증을 하게 해주는 identity 서비스다.<a class="hash-link" href="#dex는-기본적으로-openid-connect를-사용하여-다른-애플리케이션의-인증을-하게-해주는-identity-서비스다" title="Direct link to heading">​</a></h3><p><a href="https://github.com/coreos/dex" target="_blank" rel="noopener noreferrer">https://github.com/coreos/dex</a></p><p>Dex는 &quot;connectors&quot;를 통해 다른 identity provider의 포털(게이트웨이, 중계자) 역할을 한다. 이를 통해 LDAP, SAML또는 GitHub, Google, AD(Active Directory)와 같은 기존 인증을 dex에게 위임할 수 있다. 클라이언트는 일단 인증 로직을 작성하여 dex와 통신하면 dex는 주어진 백엔드(여기서는 예시로 kubernetes 클러스터)에 대한 프로토콜을 처리하게 된다. </p><p>하지만 향후 Cloud Native 인증 카탈로그 중 하나로서 생각하고 있는 오픈소스이다 보니 테스트는 진행해봐야 할 것 같다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="openid-connect">OpenID Connect<a class="hash-link" href="#openid-connect" title="Direct link to heading">​</a></h3><p>기본적으로 Dex는 OIDC(OpenID Connect)를 사용한다.<br>
<!-- -->그러므로 <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#using-kubectl" target="_blank" rel="noopener noreferrer">kubernetes 클러스터 사용자 인증용도</a>로 Dex를 붙일수 있는 것이다.<br>
<!-- -->또한 위에서 말한것과 같이 다른 identity provider를 사용하여 사용자를 인증하는데 아래 그림과 같이 <a href="https://github.com/coreos/dex#connectors" target="_blank" rel="noopener noreferrer">connectors</a>를 사용한다. </p><p><img loading="lazy" alt="dex_image" src="/assets/images/dex-flow-1eef87ca6cace19b3f458729579af0bd.png" width="760" height="460" class="img_E7b_"></p><p>위 그림과 같이 &quot;connectors&quot;는 다른 identity provider를 통해 사용자를 인증하기 위해 dex에서 사용하는 기본 도구다. 결국 Dex는 기존에 활용하던 GitHub, LinkedIn 및 Microsoft AD와 같은 벤더 플랫폼이나 LDAP 및 SAML과 같은 기존 프로토콜 방식을 사용하여 kubernetes 클러스터 사용자 인증을 쉽게 구현할 수 있는 것이다. 큰 회사??들은 OpenLDAP이나 Microsoft Active Directory와 같은 사내 디렉토리 서비스를 운용하거나 내가 있는 작은 규모의 팀들은 대부분 Github이나 Google 계정은 가지고 있을 것이기 때문에 Dex와 같은 오픈소스를 사용함으로써 기존 identity provider 와 kubernetes를 쉽게 통합할 수 있다고 본다.</p><p><img loading="lazy" alt="dex_kube" src="/assets/images/dex_architect-a6de41c76b10157ce30883eb12fec059.png" width="561" height="321" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-oidc">Kubernetes OIDC<a class="hash-link" href="#kubernetes-oidc" title="Direct link to heading">​</a></h3><p>아래 그림처럼 Identity Provider 위치에 Dex를 구성하면 된다.</p><p><img loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/d65bee40cabcf886c89d1015334555540d38f12e/c6a46/img/docs/admin/k8s_oidc_login.svg" alt="kube_openid" class="img_E7b_"></p><p>public managed kubernetes 환경에서는 현실적으로 kubeapi-server를 컨트롤하기 어렵기 때문에 일단 Native 클러스터에 구성을 하도록 한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="github-연동하기">Github 연동하기<a class="hash-link" href="#github-연동하기" title="Direct link to heading">​</a></h3><p>테스트로 Github을 연동해보자. 일단 아래와 같이 인증서를 생성하는 스크립트를 하나만든다.<br>
<!-- -->아래에서 DNS.1 부분은 /etc/hosts로 테스트로 등록할 도메인으로 가상으로 만들었다. (generator.sh)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; EOF &gt; ssl/req.cnf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[req]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">req_extensions = v3_req</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguished_name = req_distinguished_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[req_distinguished_name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ v3_req ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">basicConstraints = CA:FALSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjectAltName = @alt_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[alt_names]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.1 = dex.newtech.academy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -out ssl/ca-key.pem 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -x509 -new -nodes -key ssl/ca-key.pem -days 10 -out ssl/ca.pem -subj &quot;/CN=kube-ca&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -out ssl/key.pem 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -key ssl/key.pem -out ssl/csr.pem -subj &quot;/CN=kube-ca&quot; -config ssl/req.cnf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -req -in ssl/csr.pem -CA ssl/ca.pem -CAkey ssl/ca-key.pem -CAcreateserial -out ssl/cert.pem -days 10 -extensions v3_req -extfile ssl/req.cnf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Namespace도 하나 만들자. (dex-ns.yaml)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: dex</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kubernetest 클러스터용 인증서를 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./generator.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f dex-ns.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret tls dex.newtech.academy.tls -n dex --cert=ssl/cert.pem --key=ssl/key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cp ssl/ca.pem pki/openid-ca.pem</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Github에 가서 아래와 같이 Org OAuth App.을 신규로 생성한다.  </p><p><img loading="lazy" alt="github" src="/assets/images/dex_github-1ed6b600c442333faa787c6ced1743ff.png" width="556" height="407" class="img_E7b_"></p><p>만든 위 앱정보로 Github-Client Secret을 만든다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export GITHUB_CLIENT_ID=&lt;Client ID&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export GITHUB_CLIENT_SECRET=&lt;Client Secret&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generic github-client \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -n dex \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-literal=client-id=$GITHUB_CLIENT_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-literal=client-secret=$GITHUB_CLIENT_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                  TYPE                                  DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-f29fb   kubernetes.io/service-account-token   3         27m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex.newtech.academy.tls    kubernetes.io/tls                     2         27m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github-client         Opaque                                2         6s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret github-client -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client-id: xxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client-secret: xxxxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: 2018-07-24T15:14:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: github-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceVersion: &quot;7044721&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selfLink: /api/v1/namespaces/dex/secrets/github-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uid: 42dfa0e9-8f54-11e8-8d6d-2aaad36eb114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type: Opaque</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 이야기 했지만 여기까지 아무생각없이 퍼블릭에서 구성하다가 생각해보니 kube-apiserver를 변경하려면 직접 클러스터를 써야한다는 이런 바보같은 실수를 또 저지르고 말았다. 그래서 다시 VM에 재구성을 ㅜㅜ</p><p>그리고 kube-apiserver manifest 파일에 아래 내용을 추가한다.<br>
<!-- -->/etc/kubernetes/manifests/kube-apiserver.manifest</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-issuer-url=https://dex.newtech.academy:32000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-client-id=example-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-ca-file=/pki/openid-ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-username-claim=email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-groups-claim=groups</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 kubelet 재시작을 한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl restart kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>테스트를 위해 dex sample app을 빌드하고 만든 인증서와 함께 실행하게 되면 아래와 같이 샘플페이지를 볼수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo apt-get install make golang-1.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/coreos/dex.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git checkout v2.10.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export PATH=$PATH:/usr/lib/go-1.9/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go get github.com/coreos/dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ make bin/example-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export MY_IP=$(curl -s ifconfig.co)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./bin/example-app --issuer https://dex.newtech.academy:32000 --issuer-root-ca /pki/openid-ca.pem --listen http://${MY_IP}:5555 --redirect-uri http://${MY_IP}:5555/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2018/07/25 14:37:52 listening on http://169.56.94.55:5555</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="dex_sample" src="/assets/images/dex_sample-9a5c8b5247b98ec2212ebe08f1643d4b.png" width="334" height="181" class="img_E7b_"></p><p>그리고 로그인을 하게 되면 아래와 같이 Github 인증을 통해 kubernetes 클러스터에서 사용하려고 하는 Token을 획득할 수 있다.</p><p><img loading="lazy" alt="kube_dex" src="/assets/images/kube_dex-ccd37f6afcbbc44fd31782cf20991954.png" width="538" height="657" class="img_E7b_"></p><p><img loading="lazy" alt="dex_token" src="/assets/images/dex_token-4c8c3ec72343e5a92fc01a139b4e03e2.png" width="686" height="462" class="img_E7b_"></p><p>다음으로 위에서 만든 token을 사용하기 위해서 Role, RoleBinding과 실제 로그인할 github 계정을 User로 사용하도록 아래와 같이 작성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources: [&quot;pods&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ddiiwoong@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>계정생성을 하고 위에서 만든 token을 가지고 developer 사용자를 설정하고 context설정로 dev-default로 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f user.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role.rbac.authorization.k8s.io &quot;exampleUser&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io &quot;exampleUser&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export TOKEN=&lt;dex_sample_app_token&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config set-credentials developer --auth-provider=oidc --auth-provider-arg=idp-issuer-url=https://dex.newtech.academy:32000 --auth-provider-arg=client-id=example-app --auth-provider-arg=idp-certificate-authority=/pki/openid-ca.pem  --auth-provider-arg=id-token=${TOKEN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User &quot;developer&quot; set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config set-context dev-default --cluster=kubernetes --namespace=default --user=developer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Context &quot;dev-default&quot; created.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위처럼 만들고 나면 현재 클러스터의 context들을 확인할수 있다. 확인후에 context를 dev-default로 바꿔보자.<br>
<!-- -->새로운 context를 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         admin-cluster.local   cluster.local   admin-cluster.local   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          dev-default           kubernetes      developer             default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config use-context dev-default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Switched to context &quot;dev-default&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          admin-cluster.local   cluster.local   admin-cluster.local   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         dev-default           kubernetes      developer             default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                                    READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-42d44                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-r9p9d                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-w5s2m                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-2bqll                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-cljb2                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-svh5n                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-apiserver-node1                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-controller-manager-node1           1/1       Running   2          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-7bd4d5fbb6-7bb2j               3/3       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-7bd4d5fbb6-g8lz8               3/3       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node1                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node2                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node3                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-scheduler-node1                    1/1       Running   2          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kubedns-autoscaler-679b8b455-qxlvw      1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kubernetes-dashboard-55fdfd74b4-mbkm8   1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   nginx-proxy-node2                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   nginx-proxy-node3                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   tiller-deploy-5c688d5f9b-52tls          1/1       Running   0          13h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h3><p>처음에도 언급했듯이 kubernetes 인증을 위해 무거운 keycloak을 사용을 하는 경우들이 많은데 간단하게 사용할 수 있는 dex를 사용하여 여러가지 identity provider의 connector 역할로 사용하기에는 무난한것 같다.<br>
<!-- -->결국 Dex를 이용하면 GitHub를 비롯해 다양한 OpenID, OAuth 2.0 인증 서비스와 Kubernetes 클러스터를 엮기 쉬울수 있다.<br>
<!-- -->단, 최근 commit이 3-4달전이라는것과 처음 stable helm에 등록된 후 업데이트가 없었다는 점이 걱정되는 부분이긴 하다. (묘하게 Redhat과 합병 일정이 오버랩 되긴한다...)</p><p>거의 2주만에 포스팅인데 &#x27;18 Google Next 키노트에서 <a href="https://github.com/knative/" target="_blank" rel="noopener noreferrer">knative</a>라는 현재 개발중인 프로젝트와 유사한 오픈소스가 공개되었다. 다음번엔 knative도 한번 테스트를 해봐야 할듯 하다. </p><p>퍼블릭과 프라이빗 클러스터에 대한 고민이 생기기 시작한다. 다시금 오픈소스 플랫폼에 집중하기 위해 프라이빗으로 돌아가야 하나라는 고민에도 빠져있는 상태에서 knative, GKE on Premise 같은 엔터프라이즈에서 프라이빗 구축을 위한 것들도 나오고 있어서 더더욱 고민에 빠진 요즘이다...</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/dex">dex</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/identity-service">identity service</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oidc">OIDC</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/connectors">connectors</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/07/13/cert-manager">Cert-manager</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-13T00:00:00.000Z" itemprop="datePublished">July 13, 2018</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tls-인증서">TLS 인증서<a class="hash-link" href="#tls-인증서" title="Direct link to heading">​</a></h2><p>제한된 예산과 시간, 인력으로 서비스를 만들다 보니 어려운 점들이 참 많다. 특히나 TLS 인증서 같은 경우 관리하는것이 은근히 귀찮다. 인증서 만료일 관리하는것 부터 어느 페이지까지를 평문으로만 두어야 하는지도... 그런데 바보같은 이슈를 저지르고 말았다. 도메인을 신청하고 fanout, Name based virtual hosting 방식중에 고민하다가 설계를 virtual host로 하였다.  </p><p>그런데 문제는 어이없는곳에서 나왔다. *.xxxxx.io 라고 wildcard SSL 인증서를 신청하였는데 virtual host방식으로 2차 subdomin (예, api.stg.xxxxx.io)으로 ingress를 마구잡이로 생성하고 인증서를 적용을 했다. 하지만 인증서 오류 ㅋㅋ</p><p>인터넷 비지니스를 거의 해보지 않아서 인지, 이런 기본적인 내용도 간과하고 서비스를 구상한 내가 모든걸 책임져야하는 상황이 와버렸다. </p><p>설계를 이상하게 해서 wildcard 도메인을 몇십개를 신규로 계약해야하는 쓸데없는 비용을 들어야하는 처지가 되었다. 하지만 그냥 죽으란 법은 없는게 사람사는 세상이고 이런 고민들을 분명 다른사람들도 했을거야라고 생각하면서 떠오른게 let&#x27;s encrypt 였고 찾아보니 이걸 또 kubernetes에서 발급부터 갱신까지 해주는 오픈소스를 찾아 적용까지 하고 이렇게 포스팅을 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cert-manager">Cert-manager<a class="hash-link" href="#cert-manager" title="Direct link to heading">​</a></h3><p>인증서 없이 구성할수도 있지만 기본적으로 kubernetes 는 secret과 ingress의 간단한 설정만으로 TLS를 구성할 수 있다.  </p><ul><li>Cert-manager : K8s 클러스터내에서 TLS인증서를 자동으로 프로비저닝 및 관리하는 오픈소스</li><li>Let’s Encrypt :  자율적으로 작동하는 개방된 CA(Certificate authority-인증기관)으로 공공성(공공의 이익)을 위해서 운영되는 오픈소스</li></ul><p><a href="http://docs.cert-manager.io/en/latest/" target="_blank" rel="noopener noreferrer">Cert-manager</a>는 AWS의 Certificate Manager와 유사하게 인증서를 발급하고 설정할수 있다. 3개월 유효기간을 가지는 <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">let&#x27;s encrypt</a>를 사용하기에 인증서 만료시 문제가 될거라 생각했지만 이것도 자동으로 갱신을 해주는 관리 app.을 같이 배포하기 때문에 인증서 관리에 대한 부담을 덜수 있다.  </p><p>기본적으로 Cert-manager는 <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">let&#x27;s encrypt</a>, <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault</a> 같은 것을들 사용하여 인증서 발급을 할 수 있다. 인증서 발급후에도 만료가 되기 전에 바로 갱신을 자동으로 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구성">구성<a class="hash-link" href="#구성" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="http://docs.cert-manager.io/en/latest/_images/high-level-overview.png" alt="certmanager" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전준비사항">사전준비사항<a class="hash-link" href="#사전준비사항" title="Direct link to heading">​</a></h3><ul><li><a href="https://docs.helm.sh/using_helm/#installing-helm-client" target="_blank" rel="noopener noreferrer">helm</a></li><li>k8s cluster (1.7+) - CRD 사용이 가능해야함</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="설치">설치<a class="hash-link" href="#설치" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm install --name cert-manager --version v0.3.1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace kube-system stable/cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm status cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Fri Jun 15 10:02:45 2018</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: DEPLOYED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1/Pod(related)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY  STATUS   RESTARTS  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager-5f76b676b4-5tdh8  1/1    Running  0         2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1/ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       SECRETS  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  1        28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/CustomResourceDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificates.certmanager.k8s.io    28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuers.certmanager.k8s.io  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">issuers.certmanager.k8s.io         28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  1        1        1           1          28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager has been deployed successfully!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In order to begin issuing certificates, you will need to set up a ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or Issuer resource (for example, by creating a &#x27;letsencrypt-staging&#x27; issuer).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">More information on the different types of issuers and how to configure them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">can be found in our documentation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://cert-manager.readthedocs.io/en/latest/reference/issuers.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For information on how to configure cert-manager to automatically provision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Certificates for Ingress resources, take a look at the `ingress-shim`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">documentation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://cert-manager.readthedocs.io/en/latest/reference/ingress-shim.html</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="인증서-설정-및-배포">인증서 설정 및 배포<a class="hash-link" href="#인증서-설정-및-배포" title="Direct link to heading">​</a></h3><p>인증서 등록 및 만료시 noti를 받기 위한 변수 설정을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export EMAIL=zaction@sk.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 issuer manifest를 배포한다.<br>
<!-- -->(letsencrypt-issuer.yaml)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Copyright 2018 Google Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># you may not use this file except in compliance with the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># You may obtain a copy of the License at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     https://www.apache.org/licenses/LICENSE-2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Unless required by applicable law or agreed to in writing, software</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># See the License for the specific language governing permissions and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># limitations under the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: letsencrypt-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: https://acme-staging-v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email: &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privateKeySecretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: letsencrypt-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http01: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: https://acme-v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email: &#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privateKeySecretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http01: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>두개의 endpoint를 생성한다. (Staging, Prod)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e &quot;s/email: &#x27;&#x27;/email: $EMAIL/g&quot; letsencrypt-issuer.yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuer &quot;letsencrypt-staging&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuer &quot;letsencrypt-prod&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Web App을 HTTP Ingress 형태로 배포한다. TLS발급전에 미리 HTTP(80) Ingress를 배포해야 한다. 이후 Let&#x27;s encrypt TLS배포 후 TLS spec을 추가하고 재배포를 해야한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          serviceName: faas-auth-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          servicePort: 8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tls-인증서-발급">TLS 인증서 발급<a class="hash-link" href="#tls-인증서-발급" title="Direct link to heading">​</a></h3><p>인증서를 발급할때는 위에서 만든 Ingress로 생성하고namespace별 생성이 필요하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-dev-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: auth #### namespace별 생성</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secretName: auth-dev-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  issuerRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commonName: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dnsNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http01:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ingress: auth-ingress ### 기존에 만든 HTTP ingress 명</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      domains:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - auth.dev.action.cloudz.co.kr</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f auth-dev-tls.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificate &quot;auth-dev-tls&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 TLS 생성 상태를 확인한다. 이때 Message에서 <code>Normal   CeritifcateIssued     Certificated issued successfully</code> 문구가 확인되면 인증서 발급이 정상적으로 되었다고 볼 수 있다.<br>
<!-- -->이때 발급되는 시간이 네트워크 환경에 따라 1~5분정도 소요될때로 있는것으로 보인다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe -f auth-dev-tls.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type     Reason                Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----     ------                -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning  ErrorCheckCertificate Error checking existing TLS certificate: secret &quot;auth-dev-tls&quot; not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   PrepareCertificate    Preparing certificate with issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   PresentChallenge      Presenting http-01 challenge for domain foo.kubernetes.tips</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   SelfCheck             Performing self-check for domain auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   ObtainAuthorization   Obtained authorization for domain auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   IssueCertificate      Issuing certificate...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   CeritifcateIssued     Certificated issued successfully</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>secret이 생성된것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret | grep tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth-dev-tls                 kubernetes.io/tls                     2         3h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 위에서 만든 Ingress에 TLS를 적용한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ingress.bluemix.net/hsts: enabled=true maxAge=&lt;31536000&gt; includeSubdomains=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ingress.bluemix.net/redirect-to-https: &quot;True&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          serviceName: faas-auth-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          servicePort: 8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretName: auth-dev-tls</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 설정을 적용하고 상태를 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f auth-tls-ingress.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           HOSTS                          ADDRESS         PORTS     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth-ingress   auth.dev.action.cloudz.co.kr   10.1.1.182   80, 443   14h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="cert-tls" src="/assets/images/cert-tls-44f1bafbb8d04958c83803b445548083.png" width="1174" height="1022" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>설계의 실수로 시작되었지만 정리하다보니 인증서 갱신이 자동을 된다는 점과 또한 Kubernetes환경에서 TLS관리가 간편하다는것을 알게 되었다. 인증서 비용을 아낀것도 하나의 성과이기도 하다. 인증서는 써야하겠고 정말 많은 애플리케이션들을 생성/삭제를 상시 해야하는 환경이라면 한번 적용해볼만한 가치가 있는것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cert-manager">Cert-manager</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tls">TLS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/manage-tls-certificates">Manage TLS Certificates</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/security">Security</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/https">HTTPS</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/07/09/operator">Operators &amp; CRDs(CustomResourceDefinitions) on Kubernetes</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-09T00:00:00.000Z" itemprop="datePublished">July 9, 2018</time> · <!-- -->11 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-in-kubernetes">Operators in Kubernetes<a class="hash-link" href="#operators-in-kubernetes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-란">Operators 란?<a class="hash-link" href="#operators-란" title="Direct link to heading">​</a></h3><p>정의(<a href="https://coreos.com/operators/" target="_blank" rel="noopener noreferrer">Definition</a>) : Kubernetes Application 을 패키징, 배포, 관리하는 방법. Helm과는 조금 달라 따로 이야기 해보고자 한다.</p><p>기본적으로 Kubernetest Application은 kubernetes에 의해 배포되고 kubect과 kube-API를 사용하여 관리한다.</p><p>결론적으로 말하면 Kubernetes에 내가 만든 application을 서비스하고 관리하려면 결국 Kubernetes의 API들을 모두 이해하고 사용할수 있어야 한다. 일반적인 개발자에게 진입장벽이 어느정도 있다고 보여지며 이를 모두 이해시키는것도 조직적인 측면에서는 낭비일수 도 있다. 그래서 Helm등을 통한 application배포 전략을 세우기도 하지만 이것도 한계가 있을수 있다. 그래서 Operator는 Kubernetes상에서 application을 관리하는 런타임이라고 생각하는게 맞는것 같다.</p><p><img loading="lazy" src="https://coreos.com/sites/default/files/inline-images/Overview-etcd_0.png" alt="etcd" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators">Operators<a class="hash-link" href="#operators" title="Direct link to heading">​</a></h2><p>Operators는 application마다 운영정보를 넣을수 있다.</p><p>Kubernetes 에 배포된 응용프로그램의 모든 특성을 알 필요가 없고 이를 통해 사용자는 매니지드 클라우드 서비스 경험(기존 IaaS/PaaS관리와 유사)과 유사하게 운영이 가능하다.  </p><p>Operator가 배포되면 Kubernetes API확장 개념인 CRDs(Custom
Resource Definitions)을 사용하여 관리할수 있다.
Kubernetes에 Stateful 서비스를 배포하는 단순하고 좋은 방법이 될수 있다.  </p><p>예를 들면, Postgres 클러스터, Prometheus 클러스터, Etcd 클러스터 같이 운영측면의 application들을 유지, 운영하는데 쓰일수 있다. (자세한건 뒤쪽 예시로 설명하겠다)</p><p>그러면 먼저 CRDs(Custom Resource Definitions)에 대해서 먼저 알아본다. CRDs에 대해서는 별도로 정리하려 하다가 내용이 많이 않아 핵심적인 내용만 같이 적어본다.</p><ul><li>Custom Resource Definitions(a.k.a CRDs)</li><li>k8s Object를 확장해서 사용할 수 있는 가장 간단한 방법</li><li>CRDs는 Kubernetes의 확장 기능</li><li>Kubernetes 사용자가 클러스터내에서 직접 custom Object를 yaml형태로 생성, 수정, 삭제, 사용할수 있도록 하는 기능  <ul><li>K8s database(etcd)와 API를 그대로 활용할 수 있음)</li><li>CRUD 가능 (Create, Read, Update, Delete)</li></ul></li><li>모든 클러스터에 동적으로 resource 등록/삭제 가능</li><li>Operators는 CRDs를 포함하고 있음<ul><li>Operator를 추가하면 CRDs가 등록됨</li></ul></li><li>Resource 당 하나의 API 버전만 지원(~1.10버전, 1.11버전 이후 개수 제한 없어짐)</li><li>1.8+ 이후부터 JSON 스키마 유효성 검증 가능
<strong> *주의사항 : etcd가 별도 분리된 managed서비스나 etcd 인스턴스가 분리된 환경에서 사용권고</strong></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="주요-활용용도">주요 활용용도<a class="hash-link" href="#주요-활용용도" title="Direct link to heading">​</a></h3><ul><li>Operators</li><li>Application 정보 저장</li><li>RouteRule on istio</li><li>GameServer on Agones</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="crds-관련-발표자료">CRDs 관련 발표자료<a class="hash-link" href="#crds-관련-발표자료" title="Direct link to heading">​</a></h2><p><a href="https://ddiiwoong.github.io/2018/openinfraday18/" target="_blank" rel="noopener noreferrer">https://ddiiwoong.github.io/2018/openinfraday18/</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-example">Operators example<a class="hash-link" href="#operators-example" title="Direct link to heading">​</a></h3><p><a href="https://coreos.com/operators/etcd/docs/latest" target="_blank" rel="noopener noreferrer">etcd</a>, <a href="https://github.com/rook/rook" target="_blank" rel="noopener noreferrer">Rook</a>, <a href="https://coreos.com/operators/prometheus/docs/latest" target="_blank" rel="noopener noreferrer">Prometheus</a>, <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault</a>, <a href="https://github.com/oracle/mysql-operator" target="_blank" rel="noopener noreferrer">MySQL</a>, <a href="https://github.com/CrunchyData/postgres-operator" target="_blank" rel="noopener noreferrer">Postgres</a>, <a href="https://github.com/spotahome/redis-operator" target="_blank" rel="noopener noreferrer">Redis</a>, <a href="https://github.com/nbogojevic/kafka-operator" target="_blank" rel="noopener noreferrer">kafka-비공식</a> 등 Operator로 배포될수 있는 예시들은 해당 링크를 보면 자세히 확인할 수 있다. (오라클이 공격적으로 K8s비지니스로 뛰어드는듯한 그림이다…)  </p><p>주로 저장소나 키-밸류 스토어, RDB등의 운영안정성을 위한 클러스터 구성을 위한것들이 대부분이며 점점 도입을 해나가는 추세이긴것 같긴 하다. 이번에 진행해보고자 하는건 분산 키-밸류 스토어이자 kubernetes의 메인저장소로 쓰이는 etcd 이다.</p><p>기본적으로 etcd cluster objects는 CRDs로 생성한다. Kubernetes 기본 resource가 아닌 CRDs 이기 때문에 안정성 측면에서 불안하다고 생각할수도 있다. 하지만 <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/aggregated-api-servers.md" target="_blank" rel="noopener noreferrer">User Aggregated API Servers</a> 를 적용하여 안정성, 유효성 검사 및 버전 관리가 개선되었다고 한다. Aggregated API를 사용하면 사용자에게 최소한의 영향을 주면서 Kubernetes objects가 생성되거나 사용자가 etcd operator를 배포,관리할수 있다. (말이 길어서 그렇지 그냥 etcd 클러스터 구성)</p><p>현재 프로젝트는 베타로 0.9.2까지 나와 있으며 RedHat이 CoreOS를 합병하는 바람에 문서들이 업데이트가 늦어지는것 같긴하지만 조만간에 1.0이 나올것 같긴 하다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="etcd-operator"><a href="https://github.com/coreos/etcd-operator/#overview" target="_blank" rel="noopener noreferrer">etcd-operator</a><a class="hash-link" href="#etcd-operator" title="Direct link to heading">​</a></h3><p>etcd operator는 기본적으로 다음과 같은 기능을 한다.</p><ul><li>Create and Destroy</li><li>Resize</li><li>Failover</li><li>Rolling upgrade</li><li>Backup and Restore</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h4><ul><li>Kubernetes 1.8+</li><li>etcd 3.2.13+</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="installation-guide">Installation guide<a class="hash-link" href="#installation-guide" title="Direct link to heading">​</a></h3><p>설치는 단순하다. 먼저 RBAC설정을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/coreos/etcd-operator.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ example/rbac/create_role.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 etcd-operator 배포</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: quay.io/coreos/etcd-operator:v0.9.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Uncomment to act for resources in all namespaces. More information in doc/clusterwide.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #- -cluster-wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: MY_POD_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: MY_POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fieldPath: metadata.name</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>deployment.yaml 내용을 보면 CustomResourceDefinition이 존재하지 않는다.
etcd-operator가 자동으로 CRD를 생성하기 때문에 아래와 같이 CRD를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get customresourcedefinitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                    KIND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdclusters.etcd.database.coreos.com   CustomResourceDefinition.v1beta1.apiextensions.k8s.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="etcd-cluster-createresizefailoverupgrade">etcd cluster create/resize/failover/upgrade<a class="hash-link" href="#etcd-cluster-createresizefailoverupgrade" title="Direct link to heading">​</a></h3><p>operator를 이용하여 etc cluster를 구성한다. operator를 통한 클러스터 구성내용을 확인하면 아주 단순하다. 버전과 사이즈뿐이다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;etcd.database.coreos.com/v1beta2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: &quot;EtcdCluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;example-etcd-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Adding this annotation make this cluster managed by clusterwide operators</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## namespaced operators ignore it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #   etcd.database.coreos.com/scope: clusterwide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  size: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: &quot;3.2.13&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdcluster.etcd.database.coreos.com/example-etcd-cluster created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>순차적으로 etcd cluster가 구성되는것을 볼수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-wrhxz    1/1       Running   0          3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          1m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이번에는 scale-out 테스트를 진행한다.<br>
<!-- -->example/example-etcd-cluster.yaml 내용에서 <code>size: 3</code> 을 <code>size: 5</code> 로 변경하고 다시 적용하면 2 node가 추가로 생성된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-wrhxz    1/1       Running   0          3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          34s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          50s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          8m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>반대로 줄이는것도 동일하다.</p><p>failover 테스트의 경우에도 그냥 pod를 삭제하거나 worker를 날리는것으로도 동일하게 spec을 유지하는 kubernetes resource 특성으로 인해 바로 생성이 되는것을 확인할수 있다.</p><p>이번에는 operator만 날려보겠다. 아래처럼 operator deployment만 삭제를 해도 pods는 남아있는것을 볼수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;etcd-operator&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions &quot;etcd-operator&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          13m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>etcd pod 하나를 날려본다. 4개 pod만 남은것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete pod example-etcd-cluster-2kd4t667j5 --now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod &quot;example-etcd-cluster-2kd4t667j5&quot; deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          18m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          17m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다시한번 operator를 배포하게 되면 잠시후에 5개로 다시 pod가 복원된것을 확인할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions/etcd-operator created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-8ks8m    1/1       Running   0          44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-kskgvlbsm9   1/1       Running   0          10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          19m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>업그레이드의 경우도 다른 resource와 동일하게 version 부분을 변경하여 rollout이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>다음 소스를 통해 직접 operator를 개발이 가능하다.<br>
<!-- -->(Source: <a href="https://coreos.com/operators/" target="_blank" rel="noopener noreferrer">https://coreos.com/operators/</a>)</p><p>Operator SDK를 사용하면 Kubernetes API 상세스펙을 배우지 않고도 쉽게 operator 빌드가 가능하다.
또한 관리를 위한 Operator Lifecycle Manager나 Operator Metering 같은 기능을 사용하여 좀더 관리측면에서 강화하고자 하는 CoreOS진영의 노력이 보이는듯 하다.</p><p>아직 alpha, beta단계의 operator 프로젝트들이 대부분이지만 helm차트와 같이 kubernetes API 스펙을 이해하고 사용하지 않고도 쉽게 운영자가 기반 어플리케이션을 관리 할수 있다는것으로 보아 향후 RedHat이나 Oracle 진영에서 본인들 kubernetes 관련 제품들을 홍보하고 서비스라인에 포함시키는 방향으로 적극적으로 개발을 하고 있는것으로 보인다. 앞으로 mysql, redis, kakfa 등을 operator로 배포하고 관리하는 일이 더 많아 질것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/operators">Operators</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cr-ds">CRDs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/custom-resource-definitions">CustomResourceDefinitions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/07/06/cilium-1">Cilium</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2018</time> · <!-- -->17 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-누구냐-넌">Cilium 누구냐 넌?<a class="hash-link" href="#cilium-누구냐-넌" title="Direct link to heading">​</a></h2><p>처음에 놀랐다. 번역하면 &#x27;자궁&#x27;, &#x27;섬모&#x27;, &#x27;속눈썹&#x27;등 익숙치 않은 단어라서 놀랐지만 차근히 보다보니 결국 OS내부(리눅스 커널)에서부터 컨테이너간 또는 외부와의 연결을 보호하는 역할이라고 하니 이해가 되는 것 같다.</p><p>홈페이지에 정의된 내용을 보면 아래 내용과 같다. </p><blockquote><p><a href="https://cilium.readthedocs.io/en/v1.1/intro/#what-is-cilium" target="_blank" rel="noopener noreferrer">Cilium</a> - Docker 및 Kubernetes와 같은 Linux 컨테이너 관리 플랫폼을 사용하여 배포된 응용 프로그램 서비스 간의 네트워크 연결을 보호하는 오픈 소스 소프트웨어</p></blockquote><p>페북에 <a href="https://www.facebook.com/groups/korelnxuser/" target="_blank" rel="noopener noreferrer">한국 리눅스 사용자 그룹</a>에서도 <a href="https://www.facebook.com/tommy.lee.98229" target="_blank" rel="noopener noreferrer">Tommy Lee</a>님이나 <a href="https://www.facebook.com/changan.song" target="_blank" rel="noopener noreferrer">송창안</a>님이 몇몇 게시물을 올려주셔서 관심있게 보던중에 아래와 같은 내용을 보고 이거다 하고 파보기 시작했다.</p><blockquote><p>Cilium은 Docker 및 Kubernetes와 같은 리눅스 컨테이너 프레임 워크에 API 기반의 네트워크 보안 필터링을 제공하며,
또한, BPF라는 새로운 Linux 커널 기술을 사용하여 컨테이너/POD ID를 기반으로 네트워크 계층 및 응용 프로그램 계층 보안 정책을 정의 및 적용하는 것에 있어서 간단하면서 효율적인 방법을 제공하고 있습니다.</p></blockquote><p>윗분들처럼 커널 자체를 분석하고 공부하고 기여하려면 소요되는 시간이 더 걸릴거 같고 서비스를 운영하고 개발하는 입장에서는 내 프로젝트에 적용 가능성을 검증하는것이 나을것 같아 정리를 해본다.</p><p>iptables을 기반으로 IP와 Port기반의 전통적인 포워딩 기술은 벌써 20년이라는 세월동안 널리 사용되어 왔다. 특히 퍼블릭/프라이빗 클라우드 제품군들 모두 iptables기반의 Security Group등을 기본으로 제공하고 있고 Kubernetes 마저도 CNI 핵심으로 iptables을 활용하고 있다.  </p><p>동적으로 변화하고 매우 복잡한 마이크로서비스를 사용하는 시대에 전통적인 방식의 IP, Port관리는 비효율적인 측면이 없지 않다. BPF(아래인용)을 활용하여 리눅스 커널내에서 데이터 포워딩을 할 수 있고 Kubernetes Service기반 Load Balancing이나 istio와 같은 Service Mesh를 위한 Proxy Injection 을 통해 여러 활용을 할 수 있을거라고 Cilium 프로젝트는 이야기 하고 있다. </p><blockquote><p>버클리 패킷 필터(Berkeley Packet Filter, BPF)</p><p>BPF는 버클리 패킷 필터(Berkeley Packet Filter)의 줄임말이다. 이름 그대로 패킷을 걸러내는 필터이다. 그런데 BSD에서의 BPF는 네트워크 탭(리눅스의 PF_PACKET)까지 아우르는 개념이다. 옛날 옛적에 유닉스에는 CSPF(CMU/Stanford Packet Filter)라는 게 있었는데 BPF라는 새 구조가 이를 대체했다. 이후 리눅스에서는 네트워크 탭을 나름의 방식으로 구현하고 패킷 필터 부분만 가져왔다. 리눅스의 패킷 필터를 리눅스 소켓 필터링(LSF: Linux Socket Filtering)이라고도 한다.<br>
<!-- -->(발췌) <a href="https://wariua.github.io/facility/extended-bpf.html" target="_blank" rel="noopener noreferrer">https://wariua.github.io/facility/extended-bpf.html</a> </p></blockquote><p>Cilium은 Dockercon 2017에서 최초 <a href="https://www.youtube.com/watch?v=ilKlmTDdFgk" target="_blank" rel="noopener noreferrer">announce</a>를 하였고 2018년 4월 24일에 1.0이 정식 Release된 이후 많은 관심을 받을것으로 예상되어 실제 서비스에 적용해볼 필요가 있을거 같아 minikube로 테스트한 내용을 끄젹여 본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-architecture">Cilium Architecture<a class="hash-link" href="#cilium-architecture" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="Cilium Architecture" src="/assets/images/cilium_arch-96f6efd4a70465e9cbfd890e9da1f159.png" width="700" height="624" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="main-feature">Main Feature<a class="hash-link" href="#main-feature" title="Direct link to heading">​</a></h2><ul><li>고효율 BPF Datapath  <ul><li>모든 데이터 경로가 클러스터 전체에 완전 분산</li><li>Envoy같은 proxy injection 제공, 추후 sidecar proxy 형태 제공예정</li></ul></li><li>CNI, CMM plugins  <ul><li>Kubernetes, Mesos, Docker에 쉽게 통합가능</li></ul></li><li>Packet, API 네트워크 보안<br>패킷기반 네트워크 보안과 API 인증을 결합하여 전통적인 패킷기반 네트워크 보안과 마이크로서비스 아키텍처 모두에게 보안 제공가능  <ul><li><a href="http://docs.cilium.io/en/doc-1.0/concepts/#arch-id-security" target="_blank" rel="noopener noreferrer">ID기반</a> - Source IP에만 의존하지 않고 모든패킷에 workload identity를 encoding하여 식별성 강화  </li><li><a href="http://docs.cilium.io/en/doc-1.0/policy/language/#ip-cidr-based" target="_blank" rel="noopener noreferrer">IP/CIDR기반</a>이외에도 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#services-based" target="_blank" rel="noopener noreferrer">Kubernetes Service기반</a>으로 정책 설정가능</li><li>L7기반 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#layer-7-examples" target="_blank" rel="noopener noreferrer">API보안</a> 적용가능</li></ul></li><li>분산,확장가능한 Load Balacing
BPF를 사용한 고성능 L3,L4 Load Balancer 제공
(Hasing, Weighted round-robin)<ul><li>kube-proxy 대체 - Kubernetes ClusterIP가 생성될때 BPF기반으로 자동으로 적용됨 </li><li><a href="http://docs.cilium.io/en/doc-1.0/api/" target="_blank" rel="noopener noreferrer">API driven</a> - 직접 API를 활용하여 확장가능</li></ul></li><li>단순화된 네트워크 모델<br>Overlay/VXLAN, Direct/Native Routing 지원</li><li>가시성  <ul><li><a href="https://github.com/cilium/microscope" target="_blank" rel="noopener noreferrer">Microscope</a> - 클러스터 레벨에서 모든 이벤트 필터링 가능</li><li>API기반 가시성 제공</li></ul></li><li>운영<ul><li>클러스터 헬스체크 - HTTP, ICMP기준 클러스터 latency 체크가능</li><li>Prometheus 통합 - 모든 메트릭을 Prometheus로 전달가능</li><li>클러스터 분석 및 <a href="http://docs.cilium.io/en/doc-1.0/troubleshooting/#cluster-diagnosis-tool" target="_blank" rel="noopener noreferrer">리포트툴</a> </li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h2><ul><li>kubectl &gt;= 1.7.0</li><li>minikube &gt;= 0.22.3</li></ul><p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a> 설치와 <a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="noopener noreferrer">minikube</a> 구성은 별도로 해야한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="start-minikube">Start minikube<a class="hash-link" href="#start-minikube" title="Direct link to heading">​</a></h2><p>넉넉하게 4GB 이상 메모리로 minikube를 구동한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start --kubernetes-version v1.9.0 --network-plugin=cni --extra-config=kubelet.network-plugin=cni --memory=5120 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-minikube-cluster-status">Check minikube cluster status<a class="hash-link" href="#check-minikube-cluster-status" title="Direct link to heading">​</a></h2><p>minikube구성이 완료되면 아래와 같이 클러스터 상태를 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE              ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   {&quot;health&quot;: &quot;true&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-etcd-dependency-of-cilium">Install etcd (dependency of cilium)<a class="hash-link" href="#install-etcd-dependency-of-cilium" title="Direct link to heading">​</a></h2><p>cilium 의존성을 위해 etcd를 별도로 배포한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -n kube-system -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/addons/etcd/standalone-etcd.yaml  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service &quot;etcd-cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps &quot;etcd-cilium&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-all-pods-etcd">Check all pods (etcd)<a class="hash-link" href="#check-all-pods-etcd" title="Direct link to heading">​</a></h2><p>모든 pod가 <code>Running</code> 상태인지 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-cilium-0                      1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-minikube                      1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-addon-manager-minikube        1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-apiserver-minikube            1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-controller-manager-minikube   1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-86f4d74b45-lhzfv          3/3       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-tcd7h                   1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-scheduler-minikube            1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   storage-provisioner                1/1       Running   0          4m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-cilium">Install Cilium<a class="hash-link" href="#install-cilium" title="Direct link to heading">​</a></h2><p>Kubernetes 클러스터에 Cilium을 인스톨한다. 기본적으로 DaemonSet 형태로 배포되기 때문에 Node당 한개의 Cilium Pod를 볼 수 있다. Cilium은 <code>kube-system</code> namespace에서 실행된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/1.9/cilium.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap &quot;cilium-config&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret &quot;cilium-etcd-secrets&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.extensions &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount &quot;cilium&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kube-system namespace에 RBAC설정과 함께 Cilium이 배포되고, ConfigMap, DaemonSet 형태로 배포가 된다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-deployment">Check deployment<a class="hash-link" href="#check-deployment" title="Direct link to heading">​</a></h2><p>Cilium Deployment가 <code>READY</code> 상태로 바뀔때까지 기다린다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get daemonsets -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium    1         1         1         1            0           &lt;none&gt;          2m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploy-demo-app">Deploy Demo App.<a class="hash-link" href="#deploy-demo-app" title="Direct link to heading">​</a></h2><p>아래 데모그림을 보면 스타워즈의 영감을 받아서인지 deathstar, xwing 등으로 구분한것을 확인할수 있다. deathstar deployments의 경우 80포트로 http 웹서버가 2개의 pod replica로 Load Balancing되고 있다. deathstar 서비스는 우주선이 착륙할수 있도록 활주로를 서비스하고 있다. 하지만 제국군의 tiefighter 만 착륙하도록 해야하므로 보안설정을 해야하는 상황이다. </p><p><img loading="lazy" src="https://cilium.readthedocs.io/en/v1.1/_images/cilium_http_gsg.png" alt="starwars" class="img_E7b_"></p><p>아래 <code>http-sw-app.yaml</code> 은 세가지 deployment를 가지고 있고 각각의 deployment는 <code>(org=empire, class=deathstar)</code>, <code>(org=empire, class=tiefighter)</code>, <code>(org=alliance, class=xwing)</code>와 같이 label 정보를 가진다. deathstar Service는 <code>(org=empire, class=deathstar)</code> label을 가지고 Load Balancing을 한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/http-sw-app.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service &quot;deathstar&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;deathstar&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;tiefighter&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;xwing&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>총 4개의 pod와 1개의 서비스를 확인할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-mqgfs   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/deathstar    ClusterIP   10.109.80.174   &lt;none&gt;        80/TCP    1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>각각의 pod는 Cilium에서는 <a href="https://cilium.readthedocs.io/en/v1.1/concepts/#endpoint" target="_blank" rel="noopener noreferrer">Endpoints</a>형태로 표현된다. 아래와 같이 ingress, egress policy를 확인할수 있고 아직 아무런 network policy 적용을 하지 않았기 때문에 모두 <code>Disabled</code> 상태로 보인다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system get pods -l k8s-app=cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-jmxk2   1/1       Running   0          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                    IPv6                 IPv4            STATUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ENFORCEMENT        ENFORCEMENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5023       Disabled           Disabled          2008       k8s:io.cilium.k8s.policy.serviceaccount=istio-ingress-service-account          f00d::a0f:0:0:139f   10.15.170.241   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7415       Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:1cf7   10.15.16.224    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7979       Disabled           Disabled          4          reserved:health                                                                f00d::a0f:0:0:1f2b   10.15.96.215    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17917      Disabled           Disabled          60941      k8s:class=tiefighter                                                           f00d::a0f:0:0:45fd   10.15.58.61     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">22602      Disabled           Disabled          53004      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:584a   10.15.190.2     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=telemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">31992      Disabled           Disabled          33709      k8s:io.cilium.k8s.policy.serviceaccount=istio-egressgateway-service-account    f00d::a0f:0:0:7cf8   10.15.85.192    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=egressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">33958      Disabled           Disabled          64389      k8s:io.cilium.k8s.policy.serviceaccount=istio-citadel-service-account          f00d::a0f:0:0:84a6   10.15.59.151    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=citadel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">49215      Disabled           Disabled          40629      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:c03f   10.15.48.171    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55129      Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:d759   10.15.17.253    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55930      Disabled           Disabled          46893      k8s:app=prometheus                                                             f00d::a0f:0:0:da7a   10.15.196.220   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57491      Disabled           Disabled          775        k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:e093   10.15.253.210   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=statsd-prom-bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57651      Disabled           Disabled          44171      k8s:io.cilium.k8s.policy.serviceaccount=istio-ingressgateway-service-account   f00d::a0f:0:0:e133   10.15.74.164    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61352      Disabled           Disabled          888        k8s:io.cilium.k8s.policy.serviceaccount=istio-pilot-service-account            f00d::a0f:0:0:efa8   10.15.118.68    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=pilot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61355      Disabled           Disabled          36797      k8s:class=xwing                                                                f00d::a0f:0:0:efab   10.15.56.79     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=alliance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 상태에서는 모든 우주선이 deathstar에 착륙이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l3l4-policy-적용">L3/L4 Policy 적용<a class="hash-link" href="#l3l4-policy-적용" title="Direct link to heading">​</a></h2><p>결국 하고 싶은건 제국군 우주선 즉, tiefighter만 접근이 가능해야 하므로 아래처럼 정책을 설정한다. </p><p>정책은 직관적으로 설정이 가능하다.</p><p><code>org=empire, class=deathstar</code> label을 가진 endpoint로의 ingress 방향의 80포트 접근은 <code>org=empire</code> label을 가진 pod만 가능하도록 한다는 의미이다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;cilium.io/v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: &quot;L3-L4 policy to restrict deathstar access to empire ships only&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;rule1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는 </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_policy.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 설정하고 나서 tiefighter를 착륙시켜보자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상착륙!<br>
<!-- -->이번에는 xwing 차례</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>착륙실패!</p><p>이어서 정책을 다시 확인해보면 Enabled로 변한 정책 2개를 확인할 수 있다.<br>
<!-- -->(pod가 2개이므로 2개의 정책을 볼 수 있다)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>상세 정책 확인 (Very Simple!!)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cnp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar   2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule1           5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$  kubectl describe cnp rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    30312</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  65</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l7-정책-적용">L7 정책 적용<a class="hash-link" href="#l7-정책-적용" title="Direct link to heading">​</a></h2><p>마지막으로 deathstar API를 호출하는 서비스에 대한 정책을 제어하는것을 테스트해본다.</p><p>아래 예시처럼 exhaust-port API(포트를 소진시키는 API)를 수행하면 특정 pod가 에러가 나고 재기동 되는것을 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Panic: deathstar exploded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goroutine 1 [running]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:9 +0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:5 +0x85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   0/1       Error     0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   1/1       Running   1          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그래서 이번에는 exhaust-port API는 차단하고 request-landing API만 허용하는 정책을 테스트해본다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;cilium.io/v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: &quot;L7 policy to restrict access to specific HTTP call&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;rule1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - method: &quot;POST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path: &quot;/v1/request-landing&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_l7_policy.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ciliumnetworkpolicy.cilium.io/rule1 configured</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 동일한 테스트를 해보면 다른 결과를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access denied</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다시한번 상세 정책 확인을 해보면 ingress POST 허용정책을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe ciliumnetworkpolicies rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  kubectl.kubernetes.io/last-applied-configuration={&quot;apiVersion&quot;:&quot;cilium.io/v2&quot;,&quot;description&quot;:&quot;L7 policy to restrict access to specific HTTP call&quot;,&quot;kind&quot;:&quot;CiliumNetworkPolicy&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    32814</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Method:  POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Path:    /v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Kubectl . Kubernetes . Io / Last - Applied - Configuration:  {&quot;apiVersion&quot;:&quot;cilium.io/v2&quot;,&quot;description&quot;:&quot;L7 policy to restrict access to specific HTTP call&quot;,&quot;kind&quot;:&quot;CiliumNetworkPolicy&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;rule1&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;endpointSelector&quot;:{&quot;matchLabels&quot;:{&quot;class&quot;:&quot;deathstar&quot;,&quot;org&quot;:&quot;empire&quot;}},&quot;ingress&quot;:[{&quot;fromEndpoints&quot;:[{&quot;matchLabels&quot;:{&quot;org&quot;:&quot;empire&quot;}}],&quot;toPorts&quot;:[{&quot;ports&quot;:[{&quot;port&quot;:&quot;80&quot;,&quot;protocol&quot;:&quot;TCP&quot;}],&quot;rules&quot;:{&quot;http&quot;:[{&quot;method&quot;:&quot;POST&quot;,&quot;path&quot;:&quot;/v1/request-landing&quot;}]}}]}]}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cilium CLI로도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl -n kube-system exec cilium-jmxk2 cilium policy get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;endpointSelector&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;reserved:init&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ingress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fromEntities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;host&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;egress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toPorts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ports&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;port&quot;: &quot;53&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;protocol&quot;: &quot;UDP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toEntities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;all&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toEndpoints&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;istio-system&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;labels&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;istio-sidecar&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;endpointSelector&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;any:class&quot;: &quot;deathstar&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;any:org&quot;: &quot;empire&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ingress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fromEndpoints&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;any:org&quot;: &quot;empire&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toPorts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ports&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;port&quot;: &quot;80&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;protocol&quot;: &quot;TCP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;rules&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;http&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;path&quot;: &quot;/v1/request-landing&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;method&quot;: &quot;POST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;labels&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;rule1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision: 71</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이외에도 Cilium Metric을 Prometheus에서 확인하는것도 간단하게 할수 있다고 한다. </p><p>여기까지가 기본적으로 L3/L4, L7 기반 network policy를 적용해본것이고 다음번에는 istio와 연계 부분이나 실제 Cluster 구성방법에 대해서 다뤄보도록 하겠다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cilium">Cilium</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/network-policy">network policy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bpf">BPF</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cni">CNI</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/07/03/spinnaker-advanced-1">Spinnaker on Kubernetes #1</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-03T00:00:00.000Z" itemprop="datePublished">July 3, 2018</time> · <!-- -->4 min read</div></header><div class="markdown" itemprop="articleBody"><p>지난번 <a href="https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster" target="_blank" rel="noopener noreferrer">OpenInfraDay발표</a>때 질문을 해주셨는데 요즘 Spinnaker를 많이들 쓰거나 검토를 많이 하는것으로 알고 있다.  </p><p>Spinnaker를 설치하는 내용은 많이 있으니 아래 halyard로 설치하는 포스트를 참고하면 된다.</p><p><a href="https://yunsangjun.github.io/blog/spinnaker/2018/06/03/installing-spinnaker.html" target="_blank" rel="noopener noreferrer">윤상준의 기술 블로그 - Spinnaker 설치하기</a></p><p>이번에 이야기하고자 하는 부분은 실제 Spinnaker를 설치하고 난 후 운영상에 고려해야할 부분들과 팁들을 공유해보려고 한다.</p><p>사실 Spinnaker를 구성하면서 가장 어려웠던 부분들은 용어, halyard config 관리와 custom resourse 인식부분 이였다. 나머지들은 뭐 튜토리얼을 따라가면 별로 어렵진 않으니 아래 내용을 차근차근 따라가면서 이해하면 될것 같다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="용어들">용어들<a class="hash-link" href="#용어들" title="Direct link to heading">​</a></h2><p>사용하면서 혼돈이 많이 생기는 부분이다 이게 GCE나 EC2를 쓰면 용어 매칭이 쉬운데 k8s를 위한 별도의 메뉴가 아닌 기능을 통합하다보니 용어가 조금 혼동스럽게 구성이 되었다.<br>
<!-- -->특히 Load Balancer 부분은 Service로 매핑되고 퍼블릭 k8s에서 제공하는 Type LoadBalancer는 미지원한다.<br>
<!-- -->그리고 모든 Resource들은 Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)을 지원하며 Versioning이 지원된다.  Versioning은 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy" target="_blank" rel="noopener noreferrer">여기</a>에 설명된 대로 <code>strategy.spinnaker.io/versioned</code> annotation을 통해 manifest별로 재정의가 가능하다.</p><table><thead><tr><th align="center">Spinnaker</th><th align="center">Kubernetes</th><th align="center">비고</th></tr></thead><tbody><tr><td align="center">Server Group</td><td align="center"><a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a></td><td align="center"><a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">CRD의 경우 별도 Build</a></td></tr><tr><td align="center">Clusters</td><td align="center">Logical Server Group</td><td align="center"></td></tr><tr><td align="center">Load Balancer</td><td align="center">Services</td><td align="center">LoadBalancer(k8s) 미지원</td></tr><tr><td align="center">Firewall</td><td align="center">NetworkPolicies</td><td align="center"></td></tr></tbody></table><p>Spinnaker Server Group으로 분류 된 항목은 모두 Spinnaker의 클러스터 탭에 표시가 된다. 가능한 경우 모든 포드가 표기되지만, 해당 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a> 이외의 CRD(Custom Resource Definition)는 halconfig에서 아래와 같이 customResources config를 추가하면 deploy는 가능하나 Spinnaker UI에서 보이지는 않는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-k8s-account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        customResources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - kubernetesKind: GameServer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이유는 바로 다음 링크처럼 <a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">(CRD의 경우 별도 Build필요)</a>
별도로 Java를 빌드해야 한다. Spinnaker Slack에 문의를 몇번했는데 질문하는 사람만 있고 답은 아무도 안해준다는...<br>
<a href="https://spinnakerteam.slack.com/" target="_blank" rel="noopener noreferrer">https://spinnakerteam.slack.com/</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jenkins-연동">Jenkins 연동<a class="hash-link" href="#jenkins-연동" title="Direct link to heading">​</a></h2><p><a href="https://www.spinnaker.io/setup/ci/jenkins/" target="_blank" rel="noopener noreferrer">Spinnaker, Jenkins integration 상세내용 공식문서 </a></p><p>Jenkins와 연동하면서 가장 어이없이 헤맨부분은 아래 그림처럼 되어있어야 하는데 Security Realm을 Jenkins Default admin 계정만을 가지고 integration 하려다가 계속 실패하였다. Delegate to servlet container 말고 Jenkins 자체 사용자 DB로 별도 계정을 생성하고 아래 그림처럼 설정을 해야한다.</p><p><img loading="lazy" alt="Jenkins Config" src="/assets/images/jenkins_config-ebc060e294614bf3e83967c95b1cb527.png" width="896" height="778" class="img_E7b_"></p><p>위 설정 이후 아래와 같이 Spinnaker UI에서 Jenkins API연동이 가능하다.  </p><p><img loading="lazy" alt="Spinnaker Jenkins" src="/assets/images/spin_jenkins-dd2e9b5ec5faf44637c141dba0020e45.png" width="1176" height="888" class="img_E7b_"></p><p>오늘은 여기까지만 하고 다음글에서는 배포전략이나 Network Policy 연동등을 상세히 적어볼 예정이다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spinnaker">Spinnaker</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/5"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/7"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.fedfc763.js"></script>
<script src="/assets/js/main.1aff5f87.js"></script>
</body>
</html>