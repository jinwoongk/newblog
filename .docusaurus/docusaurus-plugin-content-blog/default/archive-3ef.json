{
  "blogPosts": [
    {
      "id": "kubernetes/eks-anywhere-adv/",
      "metadata": {
        "permalink": "/kubernetes/eks-anywhere-adv/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2022-03-18-eks-anywhere-adv.md",
        "source": "@site/blog/2022-03-18-eks-anywhere-adv.md",
        "title": "EKS Anywhere Advanced Usages",
        "description": "EKS Anywhere ë¡œ êµ¬ì„±ëœ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° í™œìš© ",
        "date": "2022-03-18T00:00:00.000Z",
        "formattedDate": "March 18, 2022",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "vsphere",
            "permalink": "/tags/vsphere"
          },
          {
            "label": "eks anywhere",
            "permalink": "/tags/eks-anywhere"
          },
          {
            "label": "eks connector",
            "permalink": "/tags/eks-connector"
          },
          {
            "label": "eks",
            "permalink": "/tags/eks"
          },
          {
            "label": "opentelemetry",
            "permalink": "/tags/opentelemetry"
          },
          {
            "label": "cilium",
            "permalink": "/tags/cilium"
          },
          {
            "label": "observability",
            "permalink": "/tags/observability"
          },
          {
            "label": "prometheus",
            "permalink": "/tags/prometheus"
          },
          {
            "label": "grafana",
            "permalink": "/tags/grafana"
          },
          {
            "label": "loki",
            "permalink": "/tags/loki"
          },
          {
            "label": "microservice",
            "permalink": "/tags/microservice"
          },
          {
            "label": "istio",
            "permalink": "/tags/istio"
          }
        ],
        "readingTime": 17.06,
        "truncated": true,
        "authors": [
          {
            "name": "Jinwoong Kim",
            "title": "Technologist and Cloud Consultant",
            "url": "https://www.linkedin.com/in/ddiiwoong/",
            "imageURL": "https://s.gravatar.com/avatar/e8bfebcbeacb5b9a0c90614e792febf2?s=80",
            "key": "jinwoong"
          }
        ],
        "frontMatter": {
          "layout": "single",
          "title": "EKS Anywhere Advanced Usages",
          "comments": true,
          "classes": "wide",
          "description": "EKS Anywhere ë¡œ êµ¬ì„±ëœ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° í™œìš© ",
          "authors": "jinwoong",
          "toc": true,
          "toc_label": "Table of Contents",
          "slug": "kubernetes/eks-anywhere-adv/",
          "date": "2022-03-18T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "vsphere",
            "eks anywhere",
            "eks-anywhere",
            "eks connector",
            "eks",
            "opentelemetry",
            "cilium",
            "observability",
            "prometheus",
            "grafana",
            "loki",
            "microservice",
            "istio"
          ]
        },
        "nextItem": {
          "title": "EKS Anywhere on vSphere Homelab",
          "permalink": "/kubernetes/eks-anywhere/"
        }
      },
      "content": "ì§€ë‚œê¸€ì— ì´ì–´ ì´ë²ˆì—ëŠ” í™ˆë©ìœ¼ë¡œ êµ¬ì„±í•œ EKS Anywhere í´ëŸ¬ìŠ¤í„°ì—ì„œ ìš´ì˜, ê°œë°œí™˜ê²½ êµ¬ì„±ì„ ìœ„í•œ ì—¬ëŸ¬ê°€ì§€ ë„êµ¬ë¥¼ ì„¤ì¹˜í•´ë³´ëŠ” ê³¼ì •ì„ ì •ë¦¬í•˜ê³ ì í•œë‹¤. \n\nì§€ë‚œ í¬ìŠ¤íŒ…ì€ ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n> ì´ì „ê¸€ - [vSphere homelab í™˜ê²½ì—ì„œ EKS Anywhere êµ¬ì„±í•˜ê¸°](https://ddii.dev/kubernetes/eks-anywhere/)\n\n<!--truncate-->\n\n## EKS Connector\n\nEKS Connectorë¥¼ í†µí•´ EKS Anywhereë¥¼ í¬í•¨í•œ ì™¸ë¶€ì˜ ëª¨ë“  í´ëŸ¬ìŠ¤í„°ë¥¼ AWS ì½˜ì†”ì— ì—°ê²°í•  ìˆ˜ ìˆë‹¤. eks connector ì»¨í…Œì´ë„ˆë¥¼ í†µí•´ proxy í˜•íƒœë¡œ ì™¸ë¶€ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ APIì„œë²„ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ AWS System Managerë¡œ ì „ë‹¬í•˜ëŠ” ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì›Œí¬ë¡œë“œ ê´€ë¦¬ë¥¼ ì§„í–‰í•œë‹¤.\n\n- ìœ ì €ê°€ì´ë“œ - [https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html](https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html)  \n- AWS ë¸”ë¡œê·¸ - [https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/](https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/)\n\n### í´ëŸ¬ìŠ¤í„° ë“±ë¡\n\n![overview](https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-03-at-4.28.27-PM.png)\n\nEKS Anywhereë¥¼ í¬í•¨í•œ ì™¸ë¶€ K8s í´ëŸ¬ìŠ¤í„°ëŠ” AWS CLI, eksctl, ì½˜ì†”ì„ ì‚¬ìš©í•´ì„œ ë“±ë¡(register)ì´ ê°€ëŠ¥í•˜ë‹¤. eksctlë¡œ ë“±ë¡ì„ ì§„í–‰í•˜ë©´ ë¨¼ì € ê´€ë ¨ëœ Roleì„ ìƒì„±í•´ì£¼ê³  ë˜í•œ ClusterRole, ClusterRoleBinding ë° Connector StatefulSetì„ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ ìë™ìœ¼ë¡œ manifestë¥¼ ìƒì„±í•´ì£¼ê¸° ë•Œë¬¸ì— eksctlë¡œ í´ëŸ¬ìŠ¤í„° ë“±ë¡ì„ ì§„í–‰í•˜ëŠ” ê²ƒì´ í¸í•˜ë‹¤. AWS Managed IAM ì—­í• ì¸ `AWSServiceRoleForAmazonEKSConnector`ì„ ìƒì„±í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë°œìƒì„ í•œë‹¤. ì—ëŸ¬ê°€ ë‚œ ì´í›„ì— AWS ì½˜ì†”ì´ë‚˜ CLIë¥¼ í†µí•´ í™•ì¸í•˜ë©´ ìƒˆë¡­ê²Œ ìƒì„±ëœ `AWSServiceRoleForAmazonEKSConnector` IAM ì—­í• ê³¼ í•´ë‹¹ ì—­í• ì— ì—°ê²°ëœ Policyì¸ `AmazonEKSConnectorServiceRolePolicy`ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```sh\n> eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong\n\n2022-03-09 18:50:44 [â„¹]  creating IAM role \"eksctl-20220309185044427640\"\n2022-03-09 18:50:49 [â„¹]  deleting IAM role \"eksctl-20220309185044427640\"\nError: error registering cluster: error calling RegisterCluster: ResourcePropagationDelayException: Service linked role 'arn:aws:iam::492935017096:role/aws-service-role/eks-connector.amazonaws.com/AWSServiceRoleForAmazonEKSConnector' is propagating, please retry later.\n```\n\nì‹¤íŒ¨ë¥¼ ì§„í–‰í•œ í›„ì— ë‹¤ì‹œ ë“±ë¡ ì‹œë„ë¥¼ í•˜ë©´ ì•„ë˜ ì¶œë ¥ë¡œê·¸ì™€ ê°™ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œ ë””ë ‰í† ë¦¬ì— EKS Connector ê´€ë ¨ ë¦¬ì†ŒìŠ¤ manifests(eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\n> eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong\n2022-03-08 22:59:15 [â„¹ï¸]  creating IAM role \"eksctl-20220308225915739385\"\n2022-03-08 22:59:29 [â„¹ï¸]  registered cluster \"homelab\" successfully\n2022-03-08 22:59:29 [â„¹ï¸]  wrote file eks-connector.yaml to /Users/jinwoong/study/eks-anywhere-homelab\n2022-03-08 22:59:29 [â„¹ï¸]  wrote file eks-connector-clusterrole.yaml to /Users/jinwoong/study/eks-anywhere-homelab\n2022-03-08 22:59:29 [â„¹ï¸]  wrote file eks-connector-console-dashboard-full-access-group.yaml to /Users/jinwoong/study/eks-anywhere-homelab\n2022-03-08 22:59:29 [!]  note: \"eks-connector-clusterrole.yaml\" and \"eks-connector-console-dashboard-full-access-group.yaml\" give full EKS Console access to IAM identity \"arn:aws:iam::492935017096:user/jinwoong\", edit if required; read https://docs.aws.amazon.com/eks/latest/userguide/connector-grant-access.html for more info\n2022-03-08 22:59:29 [â„¹ï¸]  run kubectl apply -f eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml before 11 Mar 22 13:59 UTC to connect the cluster\n```\n\neks-connector.yaml ì—ëŠ” `Namespace`, `Secret`, `Role`, `ServiceAccount`, `RoleBinding`, `ConfigMap`ê³¼ ë°°í¬ë  `StatefulSet` ì´ ë‹´ê²¨ìˆì–´ í•´ë‹¹ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.\n\ní•˜ì§€ë§Œ ì‹¤ì œ ì½˜ì†”ì—ì„œ ë…¸ë“œì™€ ì›Œí¬ë¡œë“œ ì •ë³´ë¥¼ ë³´ê¸° ìœ„í•´ì„œ eks-connector-console-dashboard-full-access-group.yamlì— ì½˜ì†” ì ‘ì†ì´ í•„ìš”í•œ IAM ì‚¬ìš©ìì™€ ì ‘ê·¼ì„ ìœ„í•œ íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ë¥¼ `ClusterRole` ë° `ClusterRoleBinding`ì— ì¶”ê°€í•´ì•¼ í•œë‹¤. \n\nìì„¸í•œ ë‚´ìš©ì€ [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html)ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. \n\nìœ„ì—ì„œ ìƒì„±ëœ manifestsê°€ EKS Anywhere í´ëŸ¬ìŠ¤í„°ì— ì ìš©ë˜ë©´ StatefulSet í˜•íƒœë¡œ ë°°í¬ëœ EKS Connect ì—ì´ì „íŠ¸ëŠ” Amazon EventBridgeë¥¼ í†µí•´ EKSì— ì•Œë¦¼ì„ ë³´ë‚´ëŠ” System Manager ì„œë¹„ìŠ¤ì— ì—°ê²°í•œë‹¤. ì´í›„ EKS ConnectëŠ” ì—°ê²°ëœ í´ëŸ¬ìŠ¤í„°ì˜ kubernetes API ì„œë²„ì— EKS ì½˜ì†” ìš”ì²­ì„ ì „ë‹¬í•˜ë¯€ë¡œ ìƒì„±í•œ ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ë¥¼ EKS Connect ì—­í• ê³¼ ì—°ê²°í•˜ì—¬ AWS IAM ì—”í‹°í‹°ë¥¼ ê°€ì¥(impersonate) í•  ìˆ˜ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ê²Œ ëœë‹¤. \n\nstatefulsetì„ ì¢€ë” ì‚´í´ë³´ë©´ ìœ„ì—ì„œ ì´ì•¼ê¸°í•˜ëŠ” ì—ì´ì „íŠ¸ ì—­í• ì„ í•˜ëŠ” `connector-agent` ì™€ í”„ë¡ì‹œ ì—­í• ì„ í•˜ëŠ” `connector-proxy` ì»¨í…Œì´ë„ˆ ë‘ê°œê°€ ë– ìˆëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤. ì‚¬ìš©ìê°€ ì½˜ì†”ì—ì„œ í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œë‚˜ ì›Œí¬ë¡œë“œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê²Œ ë˜ë©´ EKSëŠ” System Manager ì„œë¹„ìŠ¤ì—ê²Œ ì„¸ì…˜ì„ ìš”ì²­í•˜ê³  ì´í›„ System Managerê°€ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ `connector-agent` ì»¨í…Œì´ë„ˆë¥¼ invokeí•˜ë©´ `connector-proxy` ì»¨í…Œì´ë„ˆ ìœ„ì—ì„œ ë§ˆìš´íŠ¸ëœ ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ë¡œ ì¸ì¦ì„ í•˜ê³  ê°€ì¥(impersonation)í•œ ìƒíƒœë¡œ EKS Anywhere í´ëŸ¬ìŠ¤íŠ¸ì˜ APIë¥¼ í˜¸ì¶œí•´ì„œ ê´€ë ¨ëœ ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ ë³´ì—¬ì£¼ê²Œ ëœë‹¤.\n\n![connector](https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-05-at-7.51.33-AM.png)\n\n\n```sh\n> kubectl describe statefulset eks-connector -n eks-connector\nName:               eks-connector\nNamespace:          eks-connector\nCreationTimestamp:  Wed, 09 Mar 2022 22:53:23 +0900\nSelector:           app=eks-connector\nLabels:             app=eks-connector\nAnnotations:        <none>\nReplicas:           2 desired | 2 total\nUpdate Strategy:    RollingUpdate\n  Partition:        0\nPods Status:        2 Running / 0 Waiting / 0 Succeeded / 0 Failed\nPod Template:\n  ...\n  Containers:\n   connector-agent:\n    Image:      public.ecr.aws/amazon-ssm-agent/amazon-ssm-agent:3.1.90.0\n    Port:       <none>\n    Host Port:  <none>\n    Environment:\n      AWS_EC2_METADATA_DISABLED:  true\n    Mounts:\n      /etc/amazon/ssm/amazon-ssm-agent.json from eks-agent-config (rw,path=\"amazon-ssm-agent.json\")\n      /etc/amazon/ssm/seelog.xml from eks-agent-config (rw,path=\"seelog.xml\")\n      /var/eks/shared from eks-connector-shared (rw)\n      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)\n   connector-proxy:\n    Image:      public.ecr.aws/eks-connector/eks-connector:0.0.3\n    Port:       <none>\n    Host Port:  <none>\n    Args:\n      server\n    Environment:\n      POD_NAME:   (v1:metadata.name)\n    Mounts:\n      /var/eks/shared from eks-connector-shared (rw)\n      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)\n      /var/run/secrets/kubernetes.io/serviceaccount from service-account-token (rw)\n  ...\n```\n## Istio í™˜ê²½ êµ¬ì„±\n\nIstio í™˜ê²½ì—ì„œ ì•±ì„ ë°°í¬í•˜ê³  Tracing ê°€ì‹œì„± í™•ë³´ë¥¼ í•˜ëŠ” ì‹¤ìŠµì„ ì§„í–‰í•˜ê¸° ìœ„í•´ ê°„ë‹¨í•˜ê²Œ êµ¬ì„±ì— ëŒ€í•œ ê·¸ë¦¼ì„ ê·¸ë ¤ë´¤ë‹¤. \n\n![istio](/img/istio_o11y.png)\n\nIstio í™˜ê²½ì—ì„œ sidecar í˜•íƒœë¡œ envoy proxyê°€ ê° Observability êµ¬ì„±ìš”ì†Œë¡œ ë°ì´í„°ê°€ ì „ë‹¬ë˜ë„ë¡ êµ¬ì„±í•œë‹¤. ì´ë•Œ ì‚¬ìš©ë˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ìŠ¤íƒì€ ë‹¤ìŒê³¼ ê°™ë‹¤.\n\n- Tracing \n  - Collect : [OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector)\n  - Backend : [Tempo](https://github.com/grafana/tempo)\n\n- Logging\n  - Collect : [Fluentbit](https://github.com/fluent/fluent-bit)\n  - Backend : [Loki](https://github.com/grafana/loki)\n\n- Metrics\n  - Collect : [Exporters](https://istio.io/latest/docs/ops/integrations/prometheus/)\n  - Backend : [Prometheus](https://github.com/prometheus)\n\n- Visualization\n  - [Grafana](https://github.com/grafana/grafana)\n\n### Istio ì„¤ì¹˜\n\nIstioOperatorë¥¼ í†µí•´ Istioë¥¼ ì„¤ì¹˜í•œë‹¤.\n\n```sh\n> istioctl operator init\n```\n\nIstioOperatorê°€ ì„¤ì¹˜ë˜ë©´ ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•˜ì—¬ istio ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤. envoy proxyì—ëŠ” ë‹¤ì–‘í•œ í—¤ë”ë“¤ì„ í†µí•´ trace ì •ë³´ë¥¼ propagate í•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ `x-b3-traceid`ë¥¼ traceidë¡œ ë¡œê·¸ í¬ë§·ì„ êµ¬ì„±í•˜ë„ë¡ í•˜ê³  trace í™œì„±í™”ë¥¼ ìœ„í•´ `enableTracing: true` ë¥¼ ì„¤ì •í•˜ê³  Prometheusì—ì„œ ìŠ¤í¬ë©ì„ í•  ìˆ˜ ìˆë„ë¡ `enablePrometheusMerge: true`ë¡œ ì„¤ì •í•œë‹¤.\n\në§ˆì§€ë§‰ìœ¼ë¡œ zipkin í”„ë¡œí† ì½œë¡œ OpenTelemetry Collectorë¡œ ì „ë‹¬í• ê²ƒì´ê¸° ì—”ë“œí¬ì¸ë“œ ì •ë³´ë„ ë¯¸ë¦¬ ì‘ì„±í–ˆë‹¤.\n\n```yaml\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  name: istio-operator\n  namespace: istio-system\nspec:\n  profile: default\n  meshConfig:\n    accessLogFile: /dev/stdout\n    accessLogFormat: |\n      [%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\" %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\" %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME% traceID=%REQ(x-b3-traceid)%\n    enableTracing: true\n    enablePrometheusMerge: true\n    defaultConfig:\n      tracing:\n        sampling: 100\n        max_path_tag_length: 99999\n        zipkin:\n          address: otel-collector.tracing.svc:9411\n```\n\nIstioì˜ ëŒ€í‘œì ì¸ ìƒ˜í”Œì•±ì¸ [bookinfo](https://istio.io/latest/docs/examples/bookinfo/)ë¥¼ `bookinfo` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì„¤ì¹˜í•œë‹¤.\n\n```\n> kubectl create ns bookinfo\n> kubectl label namespace bookinfo istio-injection=enabled --overwrite\n> kubectl apply -n bookinfo -f https://raw.githubusercontent.com/istio/istio/release-1.10/samples/bookinfo/platform/kube/bookinfo.yaml\n```\n\nì„œë¹„ìŠ¤ ì ‘ê·¼ì„ ìœ„í•œ `Gateway`ì™€ `VirtualService` ë„ êµ¬ì„±í•œë‹¤. \n\n```yaml\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: bookinfo-gateway\n  namespace: bookinfo\nspec:\n  selector:\n    istio: ingressgateway # use istio default controller\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - \"*\" # Mind the hosts. This matches all\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: bookinfo\n  namespace: bookinfo\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - tracing/bookinfo-gateway\n  - bookinfo-gateway\n  http:\n  - match:\n    - uri:\n        prefix: \"/\"\n    route:\n    - destination:\n        host: productpage.bookinfo.svc.cluster.local\n        port:\n          number: 9080\n```\n\nì„œë¹„ìŠ¤ í™•ì¸ì„ ìœ„í•´ `LoadBalancer`ë¡œ êµ¬ì„±ëœ istio-ingressgateway EXTERNAL-IPì¸ [http://192.168.31.10/productpage](http://192.168.31.10/productpage)ë¡œ ì ‘ì†ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\nâ¯ kubectl get svc -n istio-system\nNAME                   TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                      AGE\nistio-ingressgateway   LoadBalancer   10.97.92.31      192.168.31.10   15021:30184/TCP,80:32738/TCP,443:31058/TCP   2d23h\nistiod                 ClusterIP      10.107.186.201   <none>          15010/TCP,15012/TCP,443/TCP,15014/TCP        2d23h\n```\n\n## metric-server ì„¤ì¹˜\n\n[https://github.com/kubernetes-sigs/metrics-server](https://github.com/kubernetes-sigs/metrics-server)\n\nHPA ë‚˜ Kubernetes ëŒ€ì‹œë³´ë“œë¥¼ í™œìš©í•˜ê¸° ìœ„í•´ì„œ metric-serverë¥¼ ì„¤ì¹˜í•œë‹¤. kubelet tls ì¸ì¦ì„œ ì—ëŸ¬ê°€ ë‚  ê²½ìš° ì„¤ì¹˜ íŒŒì¼ì„ ë°›ì•„ì„œ ARGì— `--kubelet-insecure-tls` í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•´ì„œ ì„¤ì¹˜í•˜ë©´ ëœë‹¤.\n\n```\n> kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml\nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n\n> kubectl top nodes\nNAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   \n192.168.31.186   175m         9%     2228Mi          29%       \n192.168.31.187   82m          4%     893Mi           11%       \n192.168.31.188   64m          3%     795Mi           10%       \n192.168.31.189   134m         6%     1817Mi          23%       \n192.168.31.190   43m          2%     636Mi           8% \n```\n\n## Observability Stack ì„¤ì¹˜\n\nì°¨íŠ¸ë¡œ ì¼ê´„ë°°í¬ë¥¼ ìœ„í•´ [Loki-stack](https://github.com/grafana/helm-charts/tree/main/charts/loki-stack)ë¥¼ ì‚¬ìš©í–ˆê³ , í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ êµ¬ì„±ìœ¼ë¡œ êµ¬ì„± ë³€ê²½ì„ í•œ chart valuesëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. \n\n- [Prometheus](https://github.com/prometheus) - ì‹œê³„ì—´ ë°ì´í„°(ë©”íŠ¸ë¦­)ì„ ìˆ˜ì§‘í•˜ê³  ì €ì¥í•˜ëŠ” í”„ë¡œì íŠ¸ì´ë©°, í‚¤-ë°¸ë¥˜ í˜•íƒœë¡œ ì¿¼ë¦¬ì™€ ì—°ì‚°ì´ ê°€ëŠ¥í•œ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ë‹¤. node-exporter, alertmanager, pushgateway ë„ ì°¨íŠ¸ë¡œ ê°™ì´ ì„¤ì¹˜í•œë‹¤. \n- [Grafana](https://github.com/grafana/grafana) - ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ëŠ” í”Œë«í¼ìœ¼ë¡œ ë‹¤ì–‘í•œ ë¡œê·¸, ë©”íŠ¸ë¦­, íŠ¸ë ˆì´ìŠ¤ ë°ì´í„°ë¥¼ ì‹œì‘í™”í•˜ê³  ì•Œë¦¼ ê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.\n- [Loki](https://github.com/grafana/loki) - ë‹¤ë¥¸ ë¡œê¹… ì‹œìŠ¤í…œê³¼ ë‹¬ë¦¬ ë¡œê·¸ë¥¼ ì œì™¸í•œ ë©”íƒ€ë°ì´í„° ì¸ë±ì‹±ë§Œ í•˜ê¸° ë•Œë¬¸ì— Prometheusì²˜ëŸ¼ ë ˆì´ë¸”ì„ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„ëœ ë¡œê¹… ë°ì´í„°ìŠ¤í† ì–´ ì‹œìŠ¤í…œì´ë‹¤.\n- [Fluent Bit](https://github.com/fluent/fluent-bit) - ë¡œê¹… ì»¬ë ‰í„°(Collector)ë¡œ fluentd ë³´ë‹¤ ê²½ëŸ‰í™”ë˜ê³  ë¹ ë¥¸ ë¡œê·¸ í”„ë¡œì„¸ìŠ¤ì´ì ì „ë‹¬ì(Forwarder)ë¡œ ë‹¤ë¥¸ ë¡œê¹… ì»¬ë ‰í„°ì¸ promtail, filebeat, logstashëŠ” falseë¡œ ì„¤ì •í•œë‹¤. \n- [Tempo](https://github.com/grafana/tempo) - TempoëŠ” ë¶„ì‚° ì¶”ì (Tracing)ì„ ìœ„í•œ ë¹„ìš© íš¨ìœ¨ì ì¸ ë°±ì—”ë“œ ë°ì´í„°ìŠ¤í† ì–´ í”„ë¡œì íŠ¸ë¡œ ìœ„ì—ì„œ êµ¬ì„±í•œ Prometheus, Grafana, Loki ë“±ê³¼ ê°™ì€ ë‹¤ë¥¸ Observability í”„ë¡œì íŠ¸ì™€ í†µí•©ì´ ì‰¬ìš´ê²ƒì´ íŠ¹ì§•ì´ë‹¤.\n\n### Prometheus, Loki ì„¤ì¹˜\n\n`Prometheus`ì™€ `Loki`ëŠ” Loki-Stackìœ¼ë¡œ êµ¬ì„±í•œë‹¤. fluent-bitëŠ” ë³„ë„ êµ¬ì„± íŒŒì¼ì„ í•„ìš”ë¡œ í•˜ê¸° ë•Œë¬¸ì— ë‚˜ì¤‘ì— ì„¤ì¹˜í•  ì˜ˆì •ì´ë‹¤. PrometheusëŠ” Persistent Volumeì€ ë³„ë„ë¡œ êµ¬ì„±í•˜ì§€ ì•Šì€ ìƒíƒœë¡œ `persistentVolume`ì„ `false`ë¡œ ì„¤ì •í•˜ì—¬ ë°°í¬í•œë‹¤.\n\n```sh\n> kubectl create ns tracing\n> helm repo add grafana https://grafana.github.io/helm-charts\n> helm repo update\n> helm install loki grafana/loki-stack --version 2.4.1 -n tracing -f - << 'EOF'\nfluent-bit:\n  enabled: false\npromtail:\n  enabled: false\nprometheus:\n  enabled: true\n  server:\n    persistentVolume:\n      enabled: false\n  alertmanager:\n    persistentVolume:\n      enabled: false\nEOF\n```\n\n`Tempo`ëŠ” ë¡œê·¸ ì •ë³´ì™€ tracingì„ ìˆ˜ì‹ í•  ë¦¬ì‹œë²„ í”„ë¡œí† ì½œ ë“¤(zipkin, otlp)ì„ ì •ì˜í•œ ì±„ë¡œ Chartë¡œ ë°°í¬í•œë‹¤. \n\n```sh\nhelm install tempo grafana/tempo --version 0.7.4 -n tracing -f - << 'EOF'\ntempo:\n  extraArgs:\n    \"distributor.log-received-traces\": true\n  receivers:\n    zipkin:\n    otlp:\n      protocols:\n        http:\n        grpc:\nEOF\n```\n\n### OpenTelemetry Collector êµ¬ì„±\n\nì´ì œê¹Œì§€ observability ê´€ë ¨ ë°ì´í„° ì €ì¥ì†Œë“¤ì„ êµ¬ì„±í–ˆìœ¼ë‹ˆ ë§ˆì§€ë§‰ìœ¼ë¡œ íŠ¸ë ˆì´ì‹±ì„ ìœ„í•œ ë„êµ¬ì¸ [OpenTelemetry Collector](https://opentelemetry.io/docs/collector/getting-started/)ë¥¼ ì„¤ì¹˜í•œë‹¤. \n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n name: otel-collector-conf\n labels:\n   app: opentelemetry\n   component: otel-collector-conf\ndata:\n otel-collector-config: |\n   receivers:   \n     zipkin:\n        endpoint: 0.0.0.0:9411\n   exporters:\n     otlp:\n       endpoint: tempo.tracing.svc.cluster.local:55680\n       insecure: true\n   service:\n     pipelines:\n       traces:\n         receivers: [zipkin]\n         exporters: [otlp]\n```\n\nì´ˆê¸° Collect êµ¬ì„± ì»¨í”¼ê·¸ëŠ” ë‹¤ë¦„ê³¼ ê°™ì´ ì„¤ì •í–ˆë‹¤. ìì„¸í•œ ì„¤ì • ë°©ë²•ì€ [https://opentelemetry.io/docs/collector/configuration/](https://opentelemetry.io/docs/collector/configuration/)ì—ì„œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.\n\n- `spec.config.receivers.zipkin.endpoint`ëŠ” traceì •ë³´ë¥¼ ë°›ì„ ì—”ë“œí¬ì¸íŠ¸ êµ¬ì„±ìœ¼ë¡œ zipkin í¬ë§·ìœ¼ë¡œ ìˆ˜ì‹ í•œë‹¤. \n- `spec.config.exporters[]`ì—ì„œëŠ” Tempoë¡œ ë³´ë‚´ê¸° ìœ„í•œ endpoint ì„¤ì •ì„ í•œë‹¤.\n- `spec.config.service`ì—ì„œëŠ” ì´í›„ collectorì—ì„œ ì‚¬ìš©í•  protocolì´ë‚˜ backend datasource ì— ëŒ€í•œ ì„¤ì •ì´ë©° ë°˜ë“œì‹œ í™œì„±í™”ê°€ ë˜ì–´ì•¼ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.  \n\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: otel-collector\n  labels:\n    app: opentelemetry\n    component: otel-collector\nspec:\n  ports:\n  - name: otlp # Default endpoint for OpenTelemetry receiver.\n    port: 55680\n    protocol: TCP\n    targetPort: 55680\n  - name: jaeger-grpc # Default endpoint for Jaeger gRPC receiver\n    port: 14250\n  - name: jaeger-thrift-http # Default endpoint for Jaeger HTTP receiver.\n    port: 14268\n  - name: zipkin # Default endpoint for Zipkin receiver.\n    port: 9411\n  - name: metrics # Default endpoint for querying metrics.\n    port: 8888\n  - name: prometheus # prometheus exporter\n    port: 8889\n  selector:\n    component: otel-collector\n```\n\nServiceì—ì„œ ì£¼ë£Œ ì‚¬ìš©í•˜ê²Œë  í¬íŠ¸ëŠ” `zipkin`ì˜ `9411`ì´ë‹¤.\n\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: otel-collector\n  labels:\n    app: opentelemetry\n    component: otel-collector\nspec:\n  selector:\n    matchLabels:\n      app: opentelemetry\n      component: otel-collector\n  template:\n    metadata:\n      labels:\n        app: opentelemetry\n        component: otel-collector\n    spec:\n      containers:\n      - command:\n          - \"/otelcontribcol\"\n          - \"--config=/conf/otel-collector-config.yaml\"\n          - \"--mem-ballast-size-mib=683\"\n          - \"--log-level=DEBUG\"\n        image: otel/opentelemetry-collector-contrib:0.29.0\n        name: otel-collector\n        ports:\n        - containerPort: 55679 # Default endpoint for ZPages.\n        - containerPort: 55680 # Default endpoint for OpenTelemetry receiver.\n        - containerPort: 14250 # Default endpoint for Jaeger HTTP receiver.\n        - containerPort: 14268 # Default endpoint for Jaeger HTTP receiver.\n        - containerPort: 9411 # Default endpoint for Zipkin receiver.\n        - containerPort: 8888  # Default endpoint for querying metrics.\n        - containerPort: 8889  # prometheus exporter       \n        volumeMounts:\n        - name: otel-collector-config-vol\n          mountPath: /conf\n      volumes:\n        - configMap:\n            name: otel-collector-conf\n            items:\n              - key: otel-collector-config\n                path: otel-collector-config.yaml\n          name: otel-collector-config-vol\n```\n\n\n### Fluentbit êµ¬ì„±\n\ní´ëŸ¬ìŠ¤í„° dataplaneê³¼ controlplaneì˜ logging ë°ì´í„°ë¥¼ `Loki` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•œ configë¡œ í™•ì¸í•˜ê³  Chartë¥¼ ë°°í¬í•œë‹¤. \n\n```sh\n> helm repo add fluent https://fluent.github.io/helm-charts\n> helm repo update\n> helm install fluent-bit fluent/fluent-bit --version 0.16.1 -n tracing -f - << 'EOF'\nlogLevel: trace\nconfig:\n  service: |\n    [SERVICE]\n        Flush 1\n        Daemon Off\n        Log_Level trace\n        Parsers_File custom_parsers.conf\n        HTTP_Server On\n        HTTP_Listen 0.0.0.0\n        HTTP_Port {{ .Values.service.port }}\n  inputs: |\n    [INPUT]\n        Name tail\n        Path /var/log/containers/*.log\n        Parser cri\n        Tag kube.*\n        Mem_Buf_Limit 5MB\n  outputs: |\n    [OUTPUT]\n        name loki\n        match *\n        host loki.tracing.svc\n        port 3100\n        tenant_id \"\"\n        labels job=fluentbit\n        label_keys $trace_id\n        auto_kubernetes_labels on\n  customParsers: |\n    [PARSER]\n        Name cri\n        Format regex\n        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$\n        Time_Key    time\n        Time_Format %Y-%m-%dT%H:%M:%S.%L%z\nEOF\n```\n\në§ˆì§€ë§‰ìœ¼ë¡œ ìœ„ 3ê°€ì§€ ë°ì´í„°ì†ŒìŠ¤(Prometheus, Loki, Tempo)ê°€ ë“±ë¡ëœ ìƒíƒœì˜ `Grafana` Chartë¥¼ ë°°í¬í•œë‹¤. \n\n```sh\n> helm install grafana grafana/grafana -n tracing --version 6.13.5Â  -f - << 'EOF'\ndatasources:\n  datasources.yaml:\n    apiVersion: 1\n    datasources:\n      - name: Tempo\n        type: tempo\n        access: browser\n        orgId: 1\n        uid: tempo\n        url: http://tempo.tracing.svc:3100\n        isDefault: true\n        editable: true\n      - name: Prometehus\n        type: prometheus\n        access: browser\n        orgId: 1\n        uid: prometheus\n        url: http://loki-prometheus-server.tracing.svc\n        isDefault: false\n        editable: true\n      - name: Loki\n        type: loki\n        access: browser\n        orgId: 1\n        uid: loki\n        url: http://loki.tracing.svc:3100\n        isDefault: false\n        editable: true\n        jsonData:\n          derivedFields:\n            - datasourceName: Tempo\n              matcherRegex: \"traceID=(\\\\w+)\"\n              name: TraceID\n              url: \"$${__value.raw}\"\n              datasourceUid: tempo\nenv:\n  JAEGER_AGENT_PORT: 6831\nadminUser: admin\nadminPassword: password\nservice:\n  type: LoadBalancer\nEOF\n```\n\n### bookinfo productpage ì ‘ì† ë° trace í™•ì¸\n\n`LoadBalancer`ë¡œ êµ¬ì„±ëœ istio-ingressgateway EXTERNAL-IPì¸ [http://192.168.31.10/productpage](http://192.168.31.10/productpage)ë¡œ ì ‘ì†í•˜ëŠ” ìƒíƒœì—ì„œ traceë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```sh\n> ISTIOINGRESSGW=$(kubectl get pod -n istio-system -l app=istio-ingressgateway -o jsonpath='{.items[0].status.hostIP}')\necho -e \"PRODUCTPAGE UI URL = http://$ISTIOINGRESSGW/productpage\"\nPRODUCTPAGE UI URL = http://192.168.31.187/productpage\n```\n\n```sh\n> for i in {1..100};  do curl -s $ISTIOINGRESSGW/productpage | grep -o \"<title>.*</title>\" ; done\n```\n\nGrafana Explorer ë©”ë‰´ì—ì„œ `Loki` ë°ì´í„°ì†ŒìŠ¤ë¥¼ ì„ íƒí•˜ê³  Log browserì— `{app=\"productpage\"}`ë¥¼ ì…ë ¥í•˜ê²Œ ë˜ë©´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ íŠ¸ë ˆì´ìŠ¤ ì •ë³´ë¥¼ ë¡œê·¸ë‚´ì—ì„œ í™•ì¸í•˜ê³  í•´ë‹¹ traceid ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ `Tempo` ë©”ë‰´ì—ì„œ íƒìƒ‰ì„ í•˜ë©´ ê´€ë ¨ëœ trace ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n![tempo](/img/tempo-grafana.png)\n\n## ì •ë¦¬ \nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” eks-anywhere í´ëŸ¬ìŠ¤í„°ì— ì—¬ëŸ¬ê°€ì§€ 3rd party êµ¬ì„±ìš”ì†Œë“¤ì„ ì„¤ì¹˜í•˜ê³  ì‹¤ì œ ìš´ì˜í™˜ê²½ê³¼ ìœ ì‚¬í•˜ê²Œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë´¤ë‹¤. EKSë¥¼ ì‚¬ìš©í•˜ëŠ” ê´€ì ì—ì„œ ìœ ì‚¬í•œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ê°œë°œí™˜ê²½ì„ ê°€ì ¸ê°ˆìˆ˜ ìˆê¸°ì— vSphereë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ë‚´ ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ëŠ” íŒ€ì—ê²ŒëŠ” ì¢‹ì€ í•˜ë‚˜ì˜ ì„ íƒì§€ê°€ ì¶”ê°€ë˜ì—ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤. Direct Connectë‚˜ VPNê³¼ ê°™ì´ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„±ë§Œ í™•ë³´ëœë‹¤ë©´ ì‹¤ì œ ê¸°ì—…í™˜ê²½ì—ì„œëŠ” AWS ë„¤ì´í‹°ë¸Œ ì„œë¹„ìŠ¤ì™€ì˜ ì—°ê³„ê°€ ë” ìš©ì´í•´ì§€ê¸° ë•Œë¬¸ì— ì¢‹ì€ ê°œë°œ, í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë‹¤ê°€ê°ˆ ìˆ˜ ìˆì„ê±°ë¼ ìƒê°í•œë‹¤.  \n\nì¬ë¯¸ìˆëŠ” ê²½í—˜ì´ì—ˆê³  ë‹¹ë¶„ê°„ì€ ê°œì¸í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ” í™ˆë© í™˜ê²½ì€ EKS Anywhereë¡œ ì •ì°©í•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ê³„ì† ì§„í–‰í•˜ë ¤ê³  í•œë‹¤. \n\n> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤."
    },
    {
      "id": "kubernetes/eks-anywhere/",
      "metadata": {
        "permalink": "/kubernetes/eks-anywhere/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2022-03-06-eks-anywhere.md",
        "source": "@site/blog/2022-03-06-eks-anywhere.md",
        "title": "EKS Anywhere on vSphere Homelab",
        "description": "vSphere homelab í™˜ê²½ì—ì„œ EKS Anywhere êµ¬ì„±í•˜ê¸°",
        "date": "2022-03-06T00:00:00.000Z",
        "formattedDate": "March 6, 2022",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "vsphere",
            "permalink": "/tags/vsphere"
          },
          {
            "label": "eks anywhere",
            "permalink": "/tags/eks-anywhere"
          },
          {
            "label": "eks",
            "permalink": "/tags/eks"
          },
          {
            "label": "flux",
            "permalink": "/tags/flux"
          },
          {
            "label": "gitops",
            "permalink": "/tags/gitops"
          }
        ],
        "readingTime": 30.095,
        "truncated": true,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "EKS Anywhere on vSphere Homelab",
          "comments": true,
          "classes": "wide",
          "description": "vSphere homelab í™˜ê²½ì—ì„œ EKS Anywhere êµ¬ì„±í•˜ê¸°",
          "toc": true,
          "toc_label": "Table of Contents",
          "slug": "kubernetes/eks-anywhere/",
          "date": "2022-03-06T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "vsphere",
            "eks anywhere",
            "eks",
            "flux",
            "gitops",
            "eks-anywhere"
          ]
        },
        "prevItem": {
          "title": "EKS Anywhere Advanced Usages",
          "permalink": "/kubernetes/eks-anywhere-adv/"
        },
        "nextItem": {
          "title": "What is Tailscale?",
          "permalink": "/kubernetes/what-is-tailscale/"
        }
      },
      "content": "## EKS Anywhere\n\n`EKS Anywhere`ëŠ” eksctlë¥¼ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ì—ì„œ [Kubernetes Cluster API Provider vSphere](https://github.com/kubernetes-sigs/cluster-api-provider-vsphere) ì¸ CAPVë¥¼ í†µí•´ vSphere ê¸°ë°˜ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•´ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ì´ë‹¤. CAPV Specì€ [Kubernetes Cluster API](https://cluster-api.sigs.k8s.io/) ê¸°ë°˜ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ìŠ¤íƒ€ì¼ APIí˜•íƒœì˜ ì„ ì–¸ì (Declarative) ë°©ì‹ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ Lifecycleì„ ê´€ë¦¬í•˜ëŠ” í”„ë¡œì íŠ¸ì´ë‹¤. \n\nUbuntu ë˜ëŠ” Mac admin í™˜ê²½ì—ì„œ eksctl ëª…ë ¹ì–´ë¡œ ë¡œì»¬ í´ëŸ¬ìŠ¤í„°ë“¤ì„ ê´€ë¦¬í•˜ê³  í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±, ì‚­ì œí•  ìˆ˜ ìˆë‹¤. ì¼ë‹¨ ê¸°ë³¸ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°©ì‹ì´ eksctlê³¼ ê±°ì˜ ìœ ì‚¬í•˜ë‹¤. ë˜í•œ EKS ì„œë¹„ìŠ¤ì˜ ë°°í¬ ë²„ì „ê³¼ ë™ì¼í•œ ë²„ì „ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ (í¬ìŠ¤íŒ… ë‹¹ì‹œ ë²„ì „ 1.21) vSphere ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ í™˜ê²½ì—ì„œì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ë° ì›Œí¬ë¡œë“œ ê´€ë¦¬ë¥¼ í¸í•˜ê²Œ í•  ìˆ˜ ìˆë‹¤.\n\n<!--truncate-->\n\ní¬ê²Œ EKS native ì„œë¹„ìŠ¤ì™€ í¬ê²Œ ë‹¤ë¥¸ì  ëª‡ê°€ì§€ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. \n\n- ì»´í“¨íŒ… í™˜ê²½ : vSphere, Docker(ê°œë°œí™˜ê²½ êµ¬ì„±ì‹œ)\n- ë…¸ë“œ ì§€ì› OS :  BottleRocket, Ubuntu\n- CNI : Cilium\n\nìì„¸í•œ ë‚´ìš©ì€ [ë¹„êµí‘œ](https://anywhere.eks.amazonaws.com/docs/concepts/eksafeatures/)ë¥¼ ì°¸ê³ í•˜ì.\n\n## ì‚¬ì „ ì¤€ë¹„ì‚¬í•­ \n### ë¡œì»¬ ê´€ë¦¬ í™˜ê²½\n- Docker 20.x ì´ìƒ ë²„ì „  \n- Mac OS(10.15) / Ubuntu(20.04.2 LTS)\n- CPU 4ì½”ì–´\n- ë©”ëª¨ë¦¬ 16GB\n- ë””ìŠ¤í¬ 30GB\n\n### vSphere\n[https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/](https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/)\n\n- vCenter í™˜ê²½ì˜ vSphere 7.0 ì´ìƒ\n- ìµœì†Œ VM 4ëŒ€ (ê° 2 vCPU, 8GB ë©”ëª¨ë¦¬, 25GB ë””ìŠ¤í¬ ì´ìƒ ê¶Œì¥)\n  - Control Plane 1ëŒ€\n  - etcd ë…¸ë“œ 1ëŒ€\n  - worker ë…¸ë“œ 2ëŒ€\n- DHCP í™˜ê²½\n- API ì„œë²„ ìš© Static IP 1ê°œ\n- ì™¸ë¶€ ë°”ì´ë„ˆë¦¬, ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ í™˜ê²½\n  - í´ëŸ¬ìŠ¤í„° ìì²´ì—ì„œ ë°©í™”ë²½ ë“±ìœ¼ë¡œ ì¸í•œ ì¸í„°ë„·ì´ ì•ˆë˜ëŠ” ê²½ìš° [í”„ë¡ì‹œ êµ¬ì„±](https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/proxy/)ì„ í†µí•´ ê°€ëŠ¥í•¨\n\n## Homelab êµ¬ì„±í™˜ê²½\n\nê¸°ì¡´ì— ìš´ì˜í•˜ë˜ ESXi í™˜ê²½ì„ ê·¸ëŒ€ë¡œ í™œìš©í•˜ë„ë¡ í–ˆë‹¤. ì¶”ê°€ì ìœ¼ë¡œ í•˜ë“œì›¨ì–´ë¥¼ êµ¬ë¹„í•˜ê¸° ìœ„í•´ ë¹„ìš©ì´ ë°œìƒí•œë¶€ë¶„ì€ ì—†ë‹¤.   \n\n### Hardware\n- Dell Precision Tower 3620\n  - Intel(R) Xeon(R) CPU E3-1240L v5\n  - TeamGroup DDR4-2666 16GB * 4ea\n  - (VM ìš©) SAMSUNG NVMe SSD PM981 - 1TB\n  - (ESXi ìš©) Sandisk SSD Z410- 240GB\n\n### Software\n- vSphere 7.0 Update 3\n- vCenter 7.0.3 (VSCA)\n- Docker Desktop [4.2.0](https://docs.docker.com/desktop/mac/release-notes/#docker-desktop-420)ë²„ì „ì„ ì‚¬ìš© \n  - 4.3.0 ë²„ì „ í•˜ìœ„ í˜¸í™˜ ë¬¸ì œê°€ìˆì–´ ê¸ˆë²ˆ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” 4.2.0 ì‚¬ìš©\n  - ë„ì»¤ ë¦¬ì†ŒìŠ¤ë¥¼ ìµœì†Œ `8vCPU`, `16GB`ë¡œ ì„¤ì •\n- [kubectl](https://kubernetes.io/ko/docs/tasks/tools/) v1.23.4\n- [eksctl](https://eksctl.io/introduction/#installation) v0.85.0\n- [eksctl-anywhere](https://anywhere.eks.amazonaws.com/docs/getting-started/install/) v0.7.0\n- [aws-iam-authenticator](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html) v0.5.5\n- [bottlerocket OVA](https://anywhere.eks.amazonaws.com/docs/reference/artifacts/) v1.21 (ìë™ ìƒì„±ë˜ëŠ” OVAë¡œ ë³„ë„ êµ¬ì„±ì´ í•„ìš”ì—†ë‹¤)  \n\n## í´ëŸ¬ìŠ¤í„° í™˜ê²½êµ¬ì„±\n\n[ê³µì‹ í™ˆí˜ì´ì§€ì˜ í´ëŸ¬ìŠ¤í„° ìƒì„±, ì‚­ì œ ì›Œí¬í”Œë¡œìš°](https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/)ë¥¼ ì°¸ê³ í•˜ì—¬ ì‚¬ì „ êµ¬ì„±ëœ Homelabì— ì ìš©í•œë‹¤. \n\n![workflow](https://anywhere.eks.amazonaws.com/images/eks-a_create_cluster.png)\n\nì²˜ìŒì—ëŠ” eksctl ëª…ë ¹ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ìœ¼ë¡œ ì‚¬ì „ì— ìƒì„±í•œ cluster config yamlì„ í†µí•´ ë¡œì»¬ ë„ì»¤ ì—”ì§„ì— bootstrapì„ í•˜ëŠ” ëª…ë ¹ì„ ë‚´ë¦°ë‹¤. ì´ë•Œ ë¡œì»¬ ë„ì»¤ ì—”ì§„ì—ì„œëŠ” Docker in Docker ì—”ì§„ì¸ [kind](https://kind.sigs.k8s.io/)ë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„° ë²ˆë“¤ ì»¨í”¼ê·¸ë¥¼ ìƒì„±í•œë‹¤. \n\n[clusterctl](https://github.com/kubernetes-sigs/cluster-api/tree/main/cmd/clusterctl)ë¥¼ í†µí•´ [Cluster API Provider Docker](https://github.com/kubernetes-sigs/cluster-api/tree/main/test/infrastructure/docker)í˜•íƒœë¡œ ë¶€ëª¨(bootstrap) í´ëŸ¬ìŠ¤í„°ë¥¼ ë§Œë“œëŠ” ê³¼ì •ì´ `eksctl anywhere` ëª…ë ¹ìœ¼ë¡œ ì¶”ìƒí™” ë˜ëŠ”ê²ƒì´ë¼ ë³¼ ìˆ˜ ìˆë‹¤. \n\ní•´ë‹¹ ë‹¨ê³„ì—ì„œ ë¨¼ì € Bastion Hostë‚˜ ê´€ë¦¬ ë¨¸ì‹ ì— `kubectl`, `eksctl`, `eksctl-anywhere`, `aws-iam-authenticator` ë“±ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.\n\nhttps://anywhere.eks.amazonaws.com/docs/getting-started/install/\n\n`homelab` ì´ë¦„ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ì»¨í”¼ê·¸ë¥¼ ìƒì„±í•œë‹¤.\n\n```sh\nCLUSTER_NAME=homelab\neksctl anywhere generate clusterconfig $CLUSTER_NAME \\\n   --provider vsphere > $CLUSTER_NAME.yaml\n```\n\nëª¨ë“  ì»¨í”¼ê·¸ì— ëŒ€í•œ ìƒì„¸ ì„¤ì •ì€ [vSphere configuration](https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/vsphere/) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\nìƒì„±ëœ ì»¨í”¼ê·¸ë¥¼ í•˜ë‚˜ì”© ì‚´í´ë³´ì. \n\n```yaml\napiVersion: anywhere.eks.amazonaws.com/v1alpha1\nkind: Cluster\nmetadata:\n  name: homelab\n  namespace: default\nspec:\n  clusterNetwork:\n    cni: cilium\n    pods:\n      cidrBlocks:\n      - 192.168.0.0/20\n    services:\n      cidrBlocks:\n      - 10.96.0.0/12\n  controlPlaneConfiguration:\n    count: 2\n    endpoint:\n      host: 192.168.31.3\n    machineGroupRef:\n      kind: VSphereMachineConfig\n      name: homelab-cp\n  datacenterRef:\n    kind: VSphereDatacenterConfig\n    name: homelab\n  externalEtcdConfiguration:\n    count: 1\n    machineGroupRef:\n      kind: VSphereMachineConfig\n      name: homelab-etcd\n  gitOpsRef:\n    kind: GitOpsConfig\n    name: cluster-gitops\n  kubernetesVersion: \"1.21\"\n  managementCluster:\n    name: homelab\n  workerNodeGroupConfigurations:\n  - count: 2\n    machineGroupRef:\n      kind: VSphereMachineConfig\n      name: homelab\n    name: md-0\n```\n\nì²«ë²ˆì§¸ëŠ” `Cluster` ë¦¬ì†ŒìŠ¤ë¡œ Clusterì˜ ì´ë¦„ê³¼ í´ëŸ¬ìŠ¤í„° ì „ë°˜ ì„¤ì •ê³¼ Control Plane, Data Plane, etcd VMì˜ ë²„ì „, ê°œìˆ˜ ë“±ì„ ì •í•  ìˆ˜ ìˆë‹¤. \n\ní´ëŸ¬ìŠ¤í„° ì´ë¦„ì€ `homelab`ìœ¼ë¡œ ì„¤ì •í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ CNIëŠ” Ciliumì„ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ì´ê¸° ë•Œë¬¸ì— í•„ìˆ˜ì ìœ¼ë¡œ `cilium`ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  kubeadm êµ¬ì„±ì‹œ í•„ìš”í•œ `pods.cidrBlocks`ê³¼ `services.cidrBlocks`ì—ì„œ íŒŒë“œì™€ ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•  ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ì„¤ì •í•œë‹¤. ë‘˜ë‹¤ CNIì—ì„œ í†µì‹ ë˜ëŠ” ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ê¸° ë•Œë¬¸ì— í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ìƒ¤ì˜¤ë¯¸ ê³µìœ ê¸° ëŒ€ì—­(192.168.31.x)ê³¼ ì¶©ëŒí•˜ì§€ ì•Šìœ¼ë©´ì„œ ë¼ìš°íŒ…ì— ë¬¸ì œë˜ì§€ ì•Šê³  í˜„ì¬ ë„¤íŠ¸ì›Œí¬ì— ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ëŒ€ì—­(192.168.0.0/20, 10.96.0.0/12) ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤.  \n\n> DHCP ìœ ì˜ì‚¬í•­: ë³¸ì¸ì˜ ê²½ìš° Xiaomi ê³µìœ ê¸°ë¥¼ ì‚¬ìš©ì¤‘ì¸ë° ë³„ë„ì˜ DHCPì„œë²„ë¥¼ êµ¬ì„±í•˜ì§€ ì•Šê³  ì‚¬ìš©ì„ í•˜ê³  ìˆì–´ì„œì¸ì§€, ì‹ ê·œ ë…¸ë“œë¥¼ ìœ„í•œ VMì´ ìƒì„±ë˜ê³  `bottlerocket` OSê°€ ê¸°ë™ë ë•Œ í˜¸ìŠ¤íŠ¸ëª…ì´ `MiWifi-R3600-SRV` ì´ëŸ°ì‹ìœ¼ë¡œ ëŒ€ì†Œë¬¸ìë¥¼ í¬í•¨í•œ í˜•íƒœë¡œ ìë™ ìƒì„±ë˜ë‹¤ ë³´ë‹ˆ ë¶€íŒ…ì´ ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒí–ˆë‹¤. ì´ì— [ë³„ë„ì˜ DHCP êµ¬ì„±](https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-dhcp/)ì„ í†µí•´ ì§„í–‰ì„ í•˜ë©´ í•´ë‹¹ ì´ìŠˆë¥¼ í”¼í• ìˆ˜ ìˆë‹¤. \n\n`controlPlaneConfiguration` í•„ë“œì—ì„œëŠ” controlPlane ë…¸ë“œì˜ `count`ì™€ `endpoint`ë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤. `count` ì´ˆê¸° ê°’ì€ `2`ë¡œ ë˜ì–´ ìˆì§€ë§Œ í™ˆë©ì˜ ìì›ì´ ë¶€ì¡±í•˜ê¸° ë•Œë¬¸ì— `1`ë¡œ ì„¤ì •í–ˆë‹¤. ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” 2ì´ìƒì„ ê¶Œê³ í•œë‹¤. ê·¸ë¦¬ê³  `endpoint.host`ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ APIì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì‹¤ì œ kubectl ëª…ë ¹ ë° ì‚¬ìš©ìì™€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìœ„í•œ ì ‘ê·¼ ê°€ëŠ¥í•œ DHCP í• ë‹¹ìœ¼ë¡œ ì¶©ëŒë˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì˜ ê³ ì • IPë¡œ ì„¤ì •í•œë‹¤. `machineGroupRef`ëŠ” ì´í›„ ìƒì„±í•  VM specì— ë§¤ì¹­ì‹œí‚¬ label ê°’ìœ¼ë¡œ ìë™ ìƒì„±ëœë‹¤. \n\n`externalEtcdConfiguration`ëŠ” etcd êµ¬ì„±ì„ ìœ„í•œ í•„ë“œë¡œ `count`ëŠ” ê¸°ë³¸ì„¤ì • ê°’ì´ `3`ì´ì§€ë§Œ í™ˆë© í™˜ê²½ì—ì„œëŠ” `1`ë¡œ êµ¬ì„±í•˜ì˜€ë‹¤. ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” Raft ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ Redundancy êµ¬ì„±ì„ ìœ„í•´ `3`ì´ìƒì„ ê¶Œê³ í•œë‹¤.\n\n`gitOpsRef`ëŠ” GitOps í˜•íƒœë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì°¸ì¡°í•˜ëŠ” ê°’ìœ¼ë¡œ ì•„ë˜ `GitOpsConfig` ì—ì„œ ì‚¬ìš©í•  ì´ë¦„ `cluster-gitops` ë¥¼ ëª…ì‹œí•œë‹¤. \n\n`kubernetesVersion`ì€ EKS ë°°í¬ ë²„ì „ì™€ ë™ì¼í•œ `1.21`ë¡œ ì„¤ì •í•œë‹¤. \n\n`workerNodeGroupConfigurations`ì€ ì›Œì»¤ë…¸ë“œ êµ¬ì„±ìœ¼ë¡œ `count`ë¥¼ `2`ë¡œ ì„¤ì •í•˜ì˜€ë‹¤. \n\në‹¤ìŒì€ ë°°í¬ë˜ëŠ” vSphere specì„ ì •ì˜í•˜ëŠ” ë¦¬ì†ŒìŠ¤ë¡œ `VSphereDatacenterConfig`ì´ë‹¤.\n\n```yaml\napiVersion: anywhere.eks.amazonaws.com/v1alpha1\nkind: VSphereDatacenterConfig\nmetadata:\n  name: homelab\nspec:\n  datacenter: \"Datacenter\"\n  insecure: false\n  network: \"VM Network\"\n  server: \"192.168.31.2\"\n  thumbprint: \"**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**\"\n```\n\n`spec`ì—ì„œëŠ” ì‹¤ì œ vCenterì˜ ì—”ë“œí¬ì¸íŠ¸, datacenter, network ì •ë³´ ë“±ì„ ì…ë ¥í•œë‹¤. \n> ìœ ì˜ì‚¬í•­ : `insecure` ì˜µì…˜ì˜ ê²½ìš° ê¸°ë³¸ê°’ì´ falseë¡œ ë˜ì–´ ìˆë‹¤. í•´ë‹¹ ê°’ì´ `false`ì˜ ê²½ìš° ì•„ë˜ ê·¸ë¦¼ì— ìˆëŠ” ê²ƒ ì²˜ëŸ¼ ë³´í†µ vCenter ë©”ë‰´ì—ì„œ `thumbprint` ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆê³  í•´ë‹¹ ê°’ì„ `**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**` í˜•íƒœë¡œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ê±°ë‚˜ [govc](https://github.com/vmware/govmomi/tree/master/govc)ë¥¼ ì‚¬ìš©í•˜ì—¬ `govc about.cert -thumbprint -k` ëª…ë ¹ì–´ë¡œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.\n\n![cert](/img/vsphere_cert.png)\n\në§ˆì§€ë§‰ì€ ê° ë…¸ë“œ ì—­í• (control plane, etcd, worker)ë³„ë¡œ ì‚¬ìš©í•  OS ë° ë¦¬ì†ŒìŠ¤ specì„ ì •ì˜í•˜ëŠ” ì»¨í”¼ê·¸ì´ë‹¤. ìœ„ `Cluster` ë¦¬ì†ŒìŠ¤ì—ì„œ ì„¤ì •ëœ `machineGroupRef.name`ìœ¼ë¡œ ë§¤ì¹­ë˜ëŠ” ê°’ì„ metadataë¡œ ìë™ ìƒì„± í•´ì£¼ê³  ëª¨ë‘ ìœ ì‚¬í•˜ê¸° ë•Œë¬¸ì— ì´ì¤‘ `VSphereMachineConfig`ë§Œ ì‚´í´ë³¸ë‹¤. \n\n```yaml\napiVersion: anywhere.eks.amazonaws.com/v1alpha1\nkind: VSphereMachineConfig\nmetadata:\n  name: homelab-cp\nspec:\n  datastore: \"datastore2\"\n  diskGiB: 25\n  folder: \"cp\"\n  memoryMiB: 8192\n  numCPUs: 2\n  osFamily: bottlerocket\n  resourcePool: \"*/Resources\"\n  users:\n  - name: ec2-user\n    sshAuthorizedKeys:\n    - ssh-rsa AAAAB3******U= vsphere\n\n```\n\nDatacenterì— êµ¬ì„±í•œ `datastore`ì¤‘ ì„¤ì¹˜ë˜ëŠ” VM ì˜ì—­ì´ ì‚¬ìš©í•  ëŒ€ìƒ datastoreë¥¼ ì…ë ¥í•œë‹¤. VMë””ìŠ¤í¬ `diskGiB`, Datacenter `folder`, VMë©”ëª¨ë¦¬ `memoryMiB`, vCPU `numCPUs`ë¥¼ ì…ë ¥í•˜ê³ , `resourcePool`ì€ ì§€ì • ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ì„ ë³„ë„ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— `\"*/Resources\"`ë¡œ ì„¤ì •í•œë‹¤. ê·¸ë¦¬ê³  `osFamily`ëŠ” ubuntu, bottlerocketë‘ê°€ì§€ë¡œ ì œê³µì´ ë˜ëŠ”ë° ê¸°ë³¸ê°’ì€ bottlerocketì´ê³ , í•´ë‹¹ ì´ë¯¸ì§€ì˜ ê¸°ë³¸ userëŠ” `ec2-user`ë¡œ ì„¤ì •í•˜ê³  í•´ë‹¹ VMì— SSHì ‘ê·¼ì„ ìœ„í•´ì„œ ë³„ë„ë¡œ ìƒì„±í•œ `sshAuthorizedKeys`ë¥¼ ì…ë ¥í•œë‹¤. \n\n```yaml\napiVersion: anywhere.eks.amazonaws.com/v1alpha1\nkind: GitOpsConfig\nmetadata:\n  name: cluster-gitops\n  namespace: default\nspec:\n  flux:\n    github:\n      branch: main\n      clusterConfigPath: clusters/homelab\n      fluxSystemNamespace: flux-system\n      owner: ddiiwoong\n      personal: true\n      repository: eks-anywhere-homelab\n```\n\në§ˆì§€ë§‰ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ GitOps ìŠ¤íƒ€ì¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ `GitOpsConfig`ë¥¼ ì¶”ê°€í•œë‹¤. spec ì—ì„œ ì‚¬ìš©í•  githubì˜ `branch`, github ë ˆí¬ ì•„ë˜ ì»¨í”¼ê·¸ê°€ ì €ì¥ë  ê²½ë¡œì¸ `clusterConfigPath`, gitops ì˜¤í”ˆì†ŒìŠ¤ì¸ [Flux](https://fluxcd.io/docs/get-started/)ê°€ êµ¬ì„±ë  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì¸ `fluxSystemNamespace`, github accountì¸ `owner`, repo ì´ë¦„ì´ ë˜ëŠ” `repository` ê¹Œì§€ ì„¤ì •í•œë‹¤. í•´ë‹¹ êµ¬ì„±ì„ í¬í•¨í•œ ì±„ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ê²Œ ë˜ë©´ í´ëŸ¬ìŠ¤í„°ê°€ ìƒì„±ë˜ëŠ” ì¤‘ì— ì„ ì–¸í•œ `repository`ë¡œ ì´í›„ ê´€ë¦¬ë  í´ëŸ¬ìŠ¤í„° ì»¨í”¼ê·¸ ë° kustomize íŒŒì¼ ë“±ì„ `commit`í•˜ê²Œ ëœë‹¤. \n\n## í´ëŸ¬ìŠ¤í„° ìƒì„±\n\në‚˜ë¨¸ì§€ etcd, worker node ë„ `VSphereMachineConfig`ë¥¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , vSphere ê´€ë ¨ ì¸ì¦ì •ë³´ì™€ gitopsë¡œ í™œìš©í•  ë ˆí¬ì˜ github tokenì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì…ë ¥í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ìƒì„±ì„ ì§„í–‰í•œë‹¤. í™ˆë©ìœ¼ë¡œ êµ¬ì„±í•œ ìƒ˜í”Œ ì»¨í”¼ê·¸ëŠ” [ë§í¬](https://raw.githubusercontent.com/ddiiwoong/eks-anywhere-homelab/main/clusters/homelab/homelab/eksa-system/eksa-cluster.yaml)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```sh\n> export EKSA_VSPHERE_USERNAME='administrator@ddii.local'\n> export EKSA_VSPHERE_PASSWORD='***********'\n> export EKSA_GITHUB_TOKEN=ghp_************************\n> eksctl anywhere create cluster -f homelab.yaml\nWarning: The recommended size of an external etcd cluster is 3 or 5\nChecking Github Access Token permissions\nâœ… Github personal access token has the required repo permissions\nPerforming setup and validations\nâœ… Connected to server\nâœ… Authenticated to vSphere\nâœ… Datacenter validated\nâœ… Network validated\nâœ… Datastore validated\nâœ… Folder validated\nâœ… Resource pool validated\nâœ… Datastore validated\nâœ… Folder validated\nâœ… Resource pool validated\nâœ… Datastore validated\nâœ… Folder validated\nâœ… Resource pool validated\nâœ… Control plane and Workload templates validated\nâœ… Vsphere Provider setup is valid\nâœ… Flux path\nâœ… Create preflight validations pass\nCreating new bootstrap cluster\nInstalling cluster-api providers on bootstrap cluster\nProvider specific setup\nCreating new workload cluster\nInstalling networking on workload cluster\nInstalling storage class on workload cluster\nInstalling cluster-api providers on workload cluster\nInstalling EKS-A secrets on workload cluster\nMoving cluster management from bootstrap to workload cluster\nInstalling EKS-A custom components (CRD and controller) on workload cluster\nCreating EKS-A CRDs instances on workload cluster\nInstalling AddonManager and GitOps Toolkit on workload cluster\nAdding cluster configuration files to Git\nEnumerating objects: 20, done.\nCounting objects: 100% (20/20), done.\nCompressing objects: 100% (12/12), done.\nTotal 20 (delta 1), reused 19 (delta 0), pack-reused 0\nFinalized commit and committed to local repository\t{\"hash\": \"ea4293c849725e593704c2a8ff71a708ad8cf8f2\"}\nWriting cluster config file\nDeleting bootstrap cluster\nğŸ‰ Cluster created!\n```\n\nê° ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´ ì²˜ìŒ bootstrap cluster êµ¬ì„± ë‹¨ê³„ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ ì¼ì„ ìˆ˜í–‰í•œë‹¤.\n- Github Access Token ê¶Œí•œ í™•ì¸\n- vSphere ì¸ì¦\n- vSphere ë¦¬ì†ŒìŠ¤(Datacenter, Network, Datastore, Folder ë“±) ê²€ì¦\n- Control Plane, Workload Plane í…œí”Œë¦¿ ê²€ì¦\n- kindë¡œ bootstrap cluster ìƒì„±\n- cluster-api provider ì—­í• ì„ í•˜ëŠ” CAPI(Cluster API) ì„¤ì¹˜\n\në‹¤ìŒì€ ìƒì„±ëœ bootstrap clusterì˜ CAPI ê´€ë¦¬ë„êµ¬ê°€ vSphere í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í›„ì— ì§„í–‰í•œë‹¤.\n\n- [govc](https://github.com/vmware/govmomi/tree/master/govc)ë¥¼ ì‚¬ìš©í•´ì„œ ì—°ê²°ëœ vSphere í´ëŸ¬ìŠ¤í„°ì— ìƒˆë¡œìš´ etcdë¥¼ í¬í•¨í•œ Control, Workload ë…¸ë“œ ìƒì„±\n- [Cilium](https://cilium.io/) CNI ì¶”ê°€\n- Storage Class ì¶”ê°€\n- êµ¬ì„±ëœ Workload Clusterì— CAPI ì¶”ê°€\n  - provider ì…‹ì—…\n  - ì¶”ê°€ì ì¸ CRD ë° GitOps ì»´í¬ë„ŒíŠ¸ ì¶”ê°€\n- GitOpsë¥¼ ìœ„í•´ ìµœì´ˆ ìƒì„±ëœ cluster configë¥¼ ì§€ì •í•œ repoì— Commit \n- ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œì»¬ ê´€ë¦¬ ë¨¸ì‹ ì— cluster configë¥¼ ì €ì¥\n\n\nê°ê°ì˜ ë‹¨ê³„ì— ëŒ€í•œ ì„¤ëª…ì€ [ë‹¤ìŒ ë§í¬](https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/#4-authenticate-and-create-bootstrap-cluster)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\nì²˜ìŒ ëª‡ë²ˆ ì‹œë„ë¥¼ í•˜ë‹¤ë³´ë©´ ì—¬ëŸ¬ê°€ì§€ ì—ëŸ¬ì‚¬í•­ì„ ë§Œë‚˜ê²Œ ëœë‹¤. í•´ë‹¹ ë‹¨ê³„ì˜ ë””ë²„ê·¸ ë ˆë²¨ ì¶œë ¥ì„ ë³´ê¸° ìœ„í•´ì„œëŠ” `-v 9` í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•´ì„œ ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ë©´ ìƒì„¸ ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° debug ë ˆë²¨ë¡œ ë§ˆì§€ë§‰ ëª‡ì¤„ ë¡œê·¸ë¥¼  ì‚´í´ë³´ë©´ ë„ì»¤ì—ì„œ kindë¡œ ë„ì»¤ë‚´ì— í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•œ ì´í›„ì— dockerë‚´ kind í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```sh\n2022-03-04T15:23:33.638+0900    V4      Deleting kind cluster   {\"name\": \"homelab-eks-a-cluster\"}\n2022-03-04T15:23:33.638+0900    V6      Executing command       {\"cmd\": \"/usr/local/bin/docker exec -i eksa_1646374542969789000 kind delete cluster --name homelab-eks-a-cluster\"}\nDeleting cluster \"homelab-eks-a-cluster\" ...\n2022-03-04T15:23:36.244+0900    V0      ğŸ‰ Cluster upgraded!\n2022-03-04T15:23:36.244+0900    V4      Task finished   {\"task_name\": \"delete-kind-cluster\", \"duration\": \"4.560798797s\"}\n2022-03-04T15:23:36.244+0900    V4      ----------------------------------\n2022-03-04T15:23:36.244+0900    V4      Tasks completed {\"duration\": \"7m50.030420843s\"}\n2022-03-04T15:23:37.227+0900    V3      Cleaning up long running container      {\"name\": \"eksa_1646374542969789000\"}\n2022-03-04T15:23:37.228+0900    V6      Executing command       {\"cmd\": \"/usr/local/bin/docker rm -f -v eksa_1646374542969789000\"}\n```\n\nëª‡ê°€ì§€ ê²½í—˜í•œ ì—ëŸ¬ ì‚¬í•­ì„ ë‚˜ì—´í•´ ë³´ë©´ ìœ„ì—ì„œë„ ì–¸ê¸‰í•œ ë‚´ìš©ê³¼ ê°™ì´ Cluster ì»¨í”¼ê·¸ ë‚´ `vSphere thumbprint`ë¥¼ ë°˜ë“œì‹œ ë„£ì–´ì£¼ëŠ”ê²ƒì´ ì¢‹ë‹¤. ê³µì‹ ê°€ì´ë“œì—ëŠ” `insecure` í•„ë“œë¥¼ trueë¡œ ì„¤ì •í•˜ê³  `thumbprint`ë¥¼ nullë¡œ ì§„í–‰í•  ê²½ìš° ì•„ë˜ì™€ ê°™ì´ kubeconfg secretì„ êµ¬ì„±ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ê±°ë‚˜ Workload ë…¸ë“œê°€ joiní•  ë•Œ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.  \n\n```sh\n$ eksctl anywhere create cluster -f eksa-mgmt-cluster.yaml\n...\ncollecting management cluster diagnostics\nâ³ Collecting support bundle from cluster, this can take a while\t{\"cluster\": \"bootstrap-cluster\", \"bundle\": \"mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml\", \"since\": 1646227532274217000, \"kubeconfig\": \"mgmt/generated/mgmt.kind.kubeconfig\"}\nSupport bundle archive created\t{\"path\": \"support-bundle-2022-03-02T14_25_34.tar.gz\"}\nAnalyzing support bundle\t{\"bundle\": \"mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml\", \"archive\": \"support-bundle-2022-03-02T14_25_34.tar.gz\"}\nAnalysis output generated\t{\"path\": \"mgmt/generated/bootstrap-cluster-2022-03-02T23:27:23+09:00-analysis.yaml\"}\ncollecting workload cluster diagnostics\nError: failed to create cluster: error checking availability of kubeconfig secret: kubeconfig secret does not exist\n```\n\nì •ìƒì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë°°í¬ê°€ ë˜ì—ˆìœ¼ë©´ eksctl config yamlì´ í¬í•¨ëœ ë””ë ‰í† ë¦¬ í•˜ìœ„ì— í´ëŸ¬ìŠ¤í„° ì´ë¦„ìœ¼ë¡œ ìƒˆë¡œìš´ ë””ë ‰í† ë¦¬ì™€ `kubeconfig`ì™€ ì‹¤ì œ ë°°í¬ëœ cluster configë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. \n\n```\n> tree\n.\nâ”œâ”€â”€ homelab\nâ”‚   â”œâ”€â”€ homelab-eks-a-cluster.kubeconfig\nâ”‚   â””â”€â”€ homelab-eks-a-cluster.yaml\nâ”œâ”€â”€ homelab.yaml\n```\n\nê¸°ì¡´ kubeconfigì™€ mergeë¥¼ ìœ„í•´ [krew](https://github.com/kubernetes-sigs/krew)ë¥¼ í†µí•´ ì„¤ì¹˜í•œ  [konfig](https://github.com/corneliusweig/konfig) ë„êµ¬ë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ì¡´ ì»¨í”¼ê·¸ì™€ ë³‘í•©í•œë‹¤. \n\n```sh\n> kubectl konfig merge ~/.kube/config ./homelab/homelab-eks-a-cluster.kubeconfig > merged-and-flattened-config\n> mv merged-and-flattened-config ~/.kube/config\n```\n\nìƒì„±ëœ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´ `Bottlerocket` OS ì´ë¯¸ì§€ì™€ `containerd://1.5.8+bottlerocket` CRIë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë…¸ë“œ ì´ë¦„ì´ IPë¡œ ë³´ì´ëŠ” ì´ìœ ëŠ” DHCPì„œë²„ë¥¼ ë³„ë„ë¡œ ë‘ì§€ ì•Šì•„ Prefix í• ë‹¹ì´ ë˜ì§€ ì•ŠëŠ” ê°€ì •ìš© ê³µìœ ê¸° í™˜ê²½ì—ì„œ ë°œìƒí•˜ëŠ” í˜„ìƒì´ë‹¤. \n\n```sh\n> kubectl get node -o wide\nNAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP      EXTERNAL-IP      OS-IMAGE                                  KERNEL-VERSION   CONTAINER-RUNTIME\n192.168.31.186   Ready    control-plane,master   9m     v1.21.6   192.168.31.186   192.168.31.186   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket\n192.168.31.187   Ready    <none>                 8m     v1.21.6   192.168.31.187   192.168.31.187   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket\n192.168.31.188   Ready    <none>                 7m     v1.21.6   192.168.31.188   192.168.31.188   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket\n192.168.31.189   Ready    control-plane,master   7m     v1.21.6   192.168.31.189   192.168.31.189   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket\n```\n\nCRD ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ë³´ì. ë§ì€ CRDì¤‘ì— `x-k8s.io`ë¡œ í•„í„°ë¥¼ í•˜ë©´ `machine`, `vsphere`, `cluster` ê´€ë ¨ëœ ì •ë³´ë¥¼ í™•ì¸í• ìˆ˜ ìˆë‹¤.\n\n```sh\n> kubectl get crd | grep \"x-k8s.io\"\nclusterclasses.cluster.x-k8s.io                              2022-03-04T14:30:28Z\nclusterresourcesetbindings.addons.cluster.x-k8s.io           2022-03-04T14:30:28Z\nclusterresourcesets.addons.cluster.x-k8s.io                  2022-03-04T14:30:28Z\nclusters.cluster.x-k8s.io                                    2022-03-04T14:30:28Z\netcdadmclusters.etcdcluster.cluster.x-k8s.io                 2022-03-04T14:30:41Z\netcdadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:38Z\nkubeadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:34Z\nkubeadmconfigtemplates.bootstrap.cluster.x-k8s.io            2022-03-04T14:30:34Z\nkubeadmcontrolplanes.controlplane.cluster.x-k8s.io           2022-03-04T14:30:45Z\nkubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io   2022-03-04T14:30:47Z\nmachinedeployments.cluster.x-k8s.io                          2022-03-04T14:30:29Z\nmachinehealthchecks.cluster.x-k8s.io                         2022-03-04T14:30:29Z\nmachinepools.cluster.x-k8s.io                                2022-03-04T14:30:30Z\nmachines.cluster.x-k8s.io                                    2022-03-04T14:30:30Z\nmachinesets.cluster.x-k8s.io                                 2022-03-04T14:30:30Z\nproviders.clusterctl.cluster.x-k8s.io                        2022-03-04T14:27:56Z\nvsphereclusteridentities.infrastructure.cluster.x-k8s.io     2022-03-04T14:30:51Z\nvsphereclusters.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:52Z\nvsphereclustertemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:52Z\nvspheredeploymentzones.infrastructure.cluster.x-k8s.io       2022-03-04T14:30:52Z\nvspherefailuredomains.infrastructure.cluster.x-k8s.io        2022-03-04T14:30:53Z\nvspheremachines.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:53Z\nvspheremachinetemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:53Z\nvspherevms.infrastructure.cluster.x-k8s.io                   2022-03-04T14:30:54Z\n```\n\nì´ì¤‘ `machine` CRDë¥¼ í™•ì¸í•´ë³´ë©´ etcdë¥¼ ë³¼ ìˆ˜ ìˆëŠ”ë° ì´ëŠ” VMì¸ìŠ¤í„´ìŠ¤ í˜•íƒœì˜ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í˜•íƒœë¡œ ë°°í¬ë˜ê¸° ë•Œë¬¸ì— ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œ ì •ë³´ì—ì„œëŠ” í™•ì¸í• ìˆ˜ ì—†ë˜ `etcd` ë¨¸ì‹ ì„ í™•ì¸ì„ í•  ìˆ˜ ìˆë‹¤. \n\n```\n> kubectl get machine -A\nNAMESPACE     NAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE     VERSION\neksa-system   homelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   11m     \neksa-system   homelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   11m     v1.21.5-eks-1-21-8\neksa-system   homelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   11m     v1.21.5-eks-1-21-8\neksa-system   homelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   11m     v1.21.5-eks-1-21-8\neksa-system   homelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   11m     v1.21.5-eks-1-21-8\n```\n\nì´ˆê¸° êµ¬ì„± íŒŒë“œë“¤ì„ ì‚´í´ë³´ë©´ CAPI ê´€ë ¨ ë¦¬ì†ŒìŠ¤, cert-manager, eks-anywhere, Cilium CNI, vSphere ê´€ë ¨ ì»¨íŠ¸ë¡¤ëŸ¬ ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\n> kubectl get pod -A\nNAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE\ncapi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-694cc79bb7-2h29c       1/1     Running   0          3h42m\ncapi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-5b6b48dd8c-g6md4   1/1     Running   0          3h42m\ncapi-system                         capi-controller-manager-689cd9b4fd-vxpc8                         1/1     Running   0          3h42m\ncapv-system                         capv-controller-manager-6b467446b9-n865b                         1/1     Running   0          3h42m\ncert-manager                        cert-manager-7988d4fb6c-72fw7                                    1/1     Running   0          3h44m\ncert-manager                        cert-manager-cainjector-6bc8dcdb64-7d7qg                         1/1     Running   0          3h44m\ncert-manager                        cert-manager-webhook-68979bfb95-hjq8m                            1/1     Running   0          3h44m\neksa-system                         eksa-controller-manager-5c74596687-45v8t                         2/2     Running   0          3h41m\netcdadm-bootstrap-provider-system   etcdadm-bootstrap-provider-controller-manager-74c86ffb56-cpw9k   1/1     Running   0          3h42m\netcdadm-controller-system           etcdadm-controller-controller-manager-7894945688-js7z4           1/1     Running   0          3h42m\nkube-system                         cilium-bq5gq                                                     1/1     Running   0          3h44m\nkube-system                         cilium-fn2f7                                                     1/1     Running   0          3h44m\nkube-system                         cilium-lgptt                                                     1/1     Running   0          3h44m\nkube-system                         cilium-operator-86d59d5c88-76z2t                                 1/1     Running   1          3h44m\nkube-system                         cilium-operator-86d59d5c88-9p4s9                                 1/1     Running   0          3h44m\nkube-system                         cilium-w55nc                                                     1/1     Running   0          68m\nkube-system                         cilium-wk89j                                                     1/1     Running   0          68m\nkube-system                         coredns-745c7986c7-k729b                                         1/1     Running   0          3h46m\nkube-system                         coredns-745c7986c7-thtbm                                         1/1     Running   0          3h46m\nkube-system                         kube-apiserver-192.168.31.189                                    1/1     Running   0          3h46m\nkube-system                         kube-controller-manager-192.168.31.189                           1/1     Running   0          3h46m\nkube-system                         kube-proxy-6xcdk                                                 1/1     Running   0          3h44m\nkube-system                         kube-proxy-d4qbv                                                 1/1     Running   0          68m\nkube-system                         kube-proxy-mhzb4                                                 1/1     Running   0          3h46m\nkube-system                         kube-proxy-vrw2p                                                 1/1     Running   0          68m\nkube-system                         kube-proxy-xkfmh                                                 1/1     Running   0          3h44m\nkube-system                         kube-scheduler-192.168.31.189                                    1/1     Running   0          3h46m\nkube-system                         kube-vip-192.168.31.189                                          1/1     Running   0          3h46m\nkube-system                         vsphere-cloud-controller-manager-bxp4t                           1/1     Running   2          68m\nkube-system                         vsphere-cloud-controller-manager-jdncv                           1/1     Running   3          3h44m\nkube-system                         vsphere-cloud-controller-manager-jhbbp                           1/1     Running   2          3h44m\nkube-system                         vsphere-cloud-controller-manager-jpn89                           1/1     Running   2          68m\nkube-system                         vsphere-cloud-controller-manager-qblld                           1/1     Running   1          3h46m\nkube-system                         vsphere-csi-controller-576c9c8dc8-9k2lm                          5/5     Running   0          3h46m\nkube-system                         vsphere-csi-node-9fbs2                                           3/3     Running   0          68m\nkube-system                         vsphere-csi-node-ffjlv                                           3/3     Running   0          3h44m\nkube-system                         vsphere-csi-node-lrkqk                                           3/3     Running   0          68m\nkube-system                         vsphere-csi-node-s49x6                                           3/3     Running   0          3h46m\nkube-system                         vsphere-csi-node-z5hdz                                           3/3     Running   0          3h44m\n```\n\n\n## ë¡œë“œë°¸ëŸ°ì„œ êµ¬ì„±\n\nì¿ ë²„ë„¤í‹°ìŠ¤ v1.14.2 ì´í›„ ë²„ì „ë¶€í„°ëŠ” `IPVS`ëª¨ë“œì—ì„œ kube-proxy ì‚¬ìš©ì„ ìœ„í•´ MetalLB êµ¬ì„±ì „ì— [strict ARP ëª¨ë“œë¥¼ í™œì„±í™”](https://metallb.universe.tf/installation/#preparation)í•´ì•¼í•œë‹¤. \n\n```sh\n> kubectl get configmap kube-proxy -n kube-system -o yaml | \\\nsed -e \"s/strictARP: false/strictARP: true/\" | \\\nkubectl apply -f - -n kube-system\n\n> kubectl describe configmap -n kube-system kube-proxy | grep ARP\n  strictARP: true\n```\n\në¯¸ë¦¬ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•  IP ëŒ€ì—­ì„ ì§€ì •í•˜ê¸° ìœ„í•´ helm chart configmap valueë¥¼ ë¯¸ë¦¬ ìƒì„±í•œë‹¤. \n\n```\ncat << 'EOF' >> values.yaml\nconfigInline:\n  address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 192.168.31.10-192.168.31.19\nEOF\n```\n\nmetallbê°€ ì‚¬ìš©í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ `metallb-system`ë¥¼ ë§Œë“¤ê³  ìœ„ configmap valueíŒŒì¼ë¡œ metalLBë¥¼ ì„¤ì¹˜í•œë‹¤.\n\n```\n> helm repo add metallb https://metallb.github.io/metallb\n> kubectl create ns metallb-system\n> helm install metallb metallb/metallb -n metallb-system -f values.yaml\n> kubectl get all -n metallb-system\nNAME                                      READY   STATUS    RESTARTS   AGE\npod/metallb-controller-69bbb4669c-2pdnk   1/1     Running   0          115s\npod/metallb-speaker-2km46                 1/1     Running   0          115s\npod/metallb-speaker-cm9xw                 1/1     Running   0          115s\npod/metallb-speaker-dptbx                 1/1     Running   0          115s\npod/metallb-speaker-jk7hn                 1/1     Running   0          115s\npod/metallb-speaker-kgfkl                 1/1     Running   0          115s\npod/metallb-speaker-t7qkw                 1/1     Running   0          115s\n\nNAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE\ndaemonset.apps/metallb-speaker   6         6         6       6            6           kubernetes.io/os=linux   115s\n\nNAME                                 READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/metallb-controller   1/1     1            1           115s\n\nNAME                                            DESIRED   CURRENT   READY   AGE\nreplicaset.apps/metallb-controller-69bbb4669c   1         1         1       115s\n```\n\nmetallb ë¦¬ì†ŒìŠ¤ê°€ ëª¨ë‘ ì •ìƒìœ¼ë¡œ ì˜¬ë¼ì˜¤ë©´ ì„œë¹„ìŠ¤ í•˜ë‚˜ë¥¼ LoadBalancer íƒ€ì…ìœ¼ë¡œ ë°°í¬í•˜ê³  í•´ë‹¹ ì„œë¹„ìŠ¤ë¡œ ì ‘ì†í•´ë³¸ë‹¤.  \n\n```\n> kubectl apply -f https://anywhere.eks.amazonaws.com/manifests/hello-eks-a.yaml\n> kubectl expose deployment hello-eks-a --port=80 --type=LoadBalancer --name=hello-eks-a-lb\n> SVC1EXIP=$(kubectl get svc hello-eks-a-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\n> curl $SVC1EXIP\nâ¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢\n\nThank you for using\n\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                                             \nâ–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•                                             \nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                                             \nâ–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â•šâ•â•â•â•â–ˆâ–ˆâ•‘                                             \nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘                                             \nâ•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•                                             \n                                                                     \n â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\nâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  \nâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  \nâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\nâ•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•    â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•\n                                                                     \nYou have successfully deployed the hello-eks-a pod hello-eks-a-9644dd8dc-647bq\n\nFor more information check out\nhttps://anywhere.eks.amazonaws.com\n\nâ¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢â¬¡â¬¢\n```\n## ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜\n\nAPI Gateway ì˜¤í”ˆì†ŒìŠ¤ì¸ [Gloo Edge](https://docs.solo.io/gloo-edge/latest/)ë¥¼ ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. `Envoy` ê¸°ë°˜ì˜ ê²½ëŸ‰í™”ëœ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤ì´í‹°ë¸Œí•œ ì˜µì…˜ë“¤ì„ ì œê³µí•˜ê¸° ë•Œë¬¸ì— ê°œì¸ì ìœ¼ë¡œ ì„ í˜¸í•˜ëŠ”í¸ì´ë‹¤. ê³µì‹ ì„¤ì¹˜ ë¬¸ì„œëŠ” ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n[https://docs.solo.io/gloo-edge/latest/installation/ingress/](https://docs.solo.io/gloo-edge/latest/installation/ingress/)\n\nê³µì‹ CLIì¸ [glooctl](https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-glooctl)ë‚˜ [Helm Chart](https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-helm)ë¡œ ì„¤ì¹˜ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤. ingressë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ `gateway.enabled` valueê°’ì„ `false`ë¡œ `ingress.enabled` valueë¥¼ `true`ë¡œ ë³€ê²½í•˜ì—¬ inline êµ¬ì„±ìœ¼ë¡œ ë°°í¬ë¥¼ ì§„í–‰í•œë‹¤.\n\n```sh\nhelm repo add gloo https://storage.googleapis.com/solo-public-helm\nhelm repo update\nkubectl create namespace gloo-system\nhelm install gloo gloo/gloo --namespace gloo-system \\\n  --set gateway.enabled=false,ingress.enabled=true\n```\n\n```sh\n> kubectl get all -n gloo-system\nNAME                                 READY   STATUS    RESTARTS   AGE\npod/discovery-9694c78f6-zrf4l        1/1     Running   0          88s\npod/gloo-7cd566cb69-bfghh            1/1     Running   0          88s\npod/ingress-7fb5c9687d-qq98j         1/1     Running   0          88s\npod/ingress-proxy-5cc555c45b-9mj9n   1/1     Running   0          88s\n\nNAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                               AGE\nservice/gloo            ClusterIP      10.100.162.70   <none>          9977/TCP,9976/TCP,9988/TCP,9979/TCP   88s\nservice/ingress-proxy   LoadBalancer   10.107.107.38   192.168.31.11   80:32207/TCP,443:32228/TCP            88s\n\nNAME                            READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/discovery       1/1     1            1           88s\ndeployment.apps/gloo            1/1     1            1           88s\ndeployment.apps/ingress         1/1     1            1           88s\ndeployment.apps/ingress-proxy   1/1     1            1           88s\n\nNAME                                       DESIRED   CURRENT   READY   AGE\nreplicaset.apps/discovery-9694c78f6        1         1         1       88s\nreplicaset.apps/gloo-7cd566cb69            1         1         1       88s\nreplicaset.apps/ingress-7fb5c9687d         1         1         1       88s\nreplicaset.apps/ingress-proxy-5cc555c45b   1         1         1       88s\n```\n\nìƒ˜í”Œ `petstore` ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•˜ê³ , ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ ì–´ë…¸í…Œì´ì…˜ì„ `kubernetes.io/ingress.class: gloo`ë¡œ ì„ ì–¸í•˜ê³  `ddiiwoong.com` í˜¸ìŠ¤íŠ¸ ì´ë¦„ìœ¼ë¡œ ë°°í¬í•œë‹¤.\n\n```sh\nkubectl apply -f \\\n  https://raw.githubusercontent.com/solo-io/gloo/v1.2.9/example/petstore/petstore.yaml\n```\n\n```\ncat <<EOF | kubectl apply -f -\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n name: petstore-ingress\n annotations:\n    # note: this annotation is only required if you've set \n    # REQUIRE_INGRESS_CLASS=true in the environment for \n    # the ingress deployment\n    kubernetes.io/ingress.class: gloo\nspec:\n  rules:\n  - host: ddiiwoong.com\n    http:\n      paths:\n      - path: /.*\n        pathType: ImplementationSpecific\n        backend:\n          service:\n            name: petstore\n            port:\n              number: 8080\nEOF\n```\n\n```\n> kubectl get ingress\nNAME               CLASS    HOSTS           ADDRESS         PORTS   AGE\npetstore-ingress   <none>   ddiiwoong.com   192.168.31.11   80      7m41s\n```\n\ní•´ë‹¹ í˜¸ìŠ¤íŠ¸ë¡œ ì •ìƒ ë¼ìš°íŒ…ë˜ì–´ ì ‘ì†ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n> curl -H \"Host: ddiiwoong.com\" 192.168.31.11/api/pets\n\n[{\"id\":1,\"name\":\"Dog\",\"status\":\"available\"},{\"id\":2,\"name\":\"Cat\",\"status\":\"pending\"}]\n```\n\n## GitOps ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ í´ëŸ¬ìŠ¤í„° ê´€ë¦¬\n\ngitops ì˜¤í”ˆì†ŒìŠ¤ì¸ [Flux](https://fluxcd.io/docs/get-started/)ë¥¼ ì‚¬ìš©í•´ì„œ ì—¬ëŸ¬ê°€ì§€ í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤. ìœ„ì—ì„œ ìƒì„±í•œ `desired state`ì¸ í´ëŸ¬ìŠ¤í„° ì»¨í”¼ê·¸ë¥¼ github repoì—ì„œ Flux ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„° ìš´ì˜ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤. \n\n[https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/](https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/)\n\nWorker ë…¸ë“œì™€ Control Plan, Etcdë“±ì˜ vSphereì—ì„œ ê´€ë¦¬í•˜ëŠ” datastore, ë””ìŠ¤í¬, ë©”ëª¨ë¦¬, CPU, resourcepool ë“±ì„ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. ë‹¨, EKSì˜ ê´€ë¦¬í˜• ë…¸ë“œê·¸ë£¹ê³¼ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ ë…¸ë“œê·¸ë£¹ì˜ VMì˜ ìˆ«ìë¥¼ ëŠ˜ë¦¬ê±°ë‚˜ ì¤„ì¼ìˆ˜ ìˆì§€ë§Œ ì•„ì§ê¹Œì§€ ì‹ ê·œë¡œ worker ë…¸ë“œê·¸ë£¹ì„ ìƒì„±í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì€ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.\n\nì´ˆê¸° í´ëŸ¬ìŠ¤í„° ì»¨í”¼ê·¸ì— ì•„ë˜ì™€ ê°™ì´ ê¸°ì¡´ ë…¸ë“œê·¸ë£¹ `md-0`ì— ì‹ ê·œ VM 1ëŒ€ë¥¼ ì¶”ê°€í•´ë³´ì. (2ëŒ€->3ëŒ€)\n\n- `clusters/$CLUSTER_NAME/eksa-system/eksa-cluster.yaml`\n\n```yaml\napiVersion: anywhere.eks.amazonaws.com/v1alpha1\nkind: Cluster\nmetadata:\n  name: homelab\n  namespace: default\nspec:\n  ...\n  workerNodeGroupConfigurations:\n  - count: 3\n    machineGroupRef:\n      kind: VSphereMachineConfig\n      name: homelab\n    name: md-0\n```\n\nì´ˆê¸° í™˜ê²½ì—ì„œ êµ¬ì„±ëœ gitops repoì— ìˆ˜ì •ëœ íŒŒì¼ì„ ì»¤ë°‹í•œë‹¤.\n\n```sh\ngit add clusters/homelab/eksa-system/eksa-cluster.yaml\ngit commit -m 'Scale from 2 to 3 at WorkerNodeGroup md-0 '\ngit push origin main\n```\n\n`md-0` ë…¸ë“œê·¸ë£¹ì— VMì´ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```sh\n> kubectl get machine -n eksa-system\nNAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE   VERSION\nhomelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   75m   \nhomelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   75m   v1.21.5-eks-1-21-8\nhomelab-md-0-76478bb486-j68fd   homelab   192.168.31.190   vsphere://421bc1ee-eac7-f1db-b351-5fac25b45fc0   Running   11m   v1.21.5-eks-1-21-8\nhomelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   75m   v1.21.5-eks-1-21-8\nhomelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   75m   v1.21.5-eks-1-21-8\nhomelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   75m   v1.21.5-eks-1-21-8\n```\n\n## ì •ë¦¬ \nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” eks-anywhere ì˜¤í”ˆì†ŒìŠ¤ë¥¼ vSphere í™ˆì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ ê²½í—˜ì„ ì •ë¦¬í–ˆë‹¤. \n\nì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ë©´ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ í•˜ë‚˜í•˜ë‚˜ ê³µì‹ ë¬¸ì„œë¥¼ í™•ì¸í•˜ê³ , íšŒì‚¬ ìŠ¬ë™ ì°¬ìŠ¤ë„ ì‚¬ìš©í•˜ë©´ì„œ í˜ë“¤ê²Œ ì„¤ì¹˜ë¥¼ ì™„ë£Œí–ˆë‹¤. ìƒê°ë³´ë‹¤ ë””ë²„ê¹…ì„ í•˜ëŠ”ë° ë§ì€ ì‹œê°„ì„ í—ˆë¹„í–ˆëŠ”ë° ì‹¤ì œë¡œ 2ì¼ ì´ìƒ ê³ ìƒì„ í–ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ë””ë²„ê·¸ ë ˆë²¨ì˜ ë¡œê·¸ë¥¼ ë³´ë©´ì„œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì„ í†µí•´ ë¬¸ì œ í•´ê²°ì´ ê°€ëŠ¥í–ˆê³  ê·¸ ê³¼ì •ì—ì„œ EKS Anywhereì˜ ë‚´ë¶€ êµ¬ì„±ìš”ì†Œë“¤ê³¼ ì‹¤ì œ Cluster API ì›Œí¬í”Œë¡œìš°ë¥¼ ì´í•´í•  ìˆ˜ ìˆì—ˆë‹¤. \n\në‹¤ë§Œ ì•„ì§ê¹Œì§€ ë¬¸ì„œí™”ë‚˜ ì»¤ë®¤ë‹ˆí‹°ì— ë§ì€ ìœ ìŠ¤ì¼€ì´ìŠ¤ê°€ ì—†ë‹¤ëŠ” ì ê³¼ Ciliumì„ ë©”ì¸ CNIë¡œ í™œìš©í•¨ì—ë„ ë¶ˆêµ¬í•˜ê³  `CiliumNetworkPolicy` APIë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ëŠ” ì ì´ë‚˜ Cilium ìœ ì € ì¸í„°í˜ì´ìŠ¤ì¸ [Hubble UI](https://github.com/cilium/hubble-ui)ë¥¼ í™œì„±í™”í•´ì„œ ì‚¬ìš©í•  ìˆ˜ê°€ ì—†ëŠ” [ì œì•½ì‚¬í•­](https://anywhere.eks.amazonaws.com/docs/tasks/workload/networking-and-security/#additional-cilium-features)ë“±ì´ ìˆì—ˆê³ , ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨í•´ì„œëŠ” `Persistent Volume` ê´€ë ¨í•˜ì—¬ vSANì„ ì‚¬ìš©í•˜ì§€ ì•Šì€ í™˜ê²½ì—ì„œëŠ” VMDKë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•˜ê³  í•´ë‹¹ ë³¼ë¥¨ì„ ë§¤í•‘ì‹œì¼œì•¼ í™œìš©ì´ ê°€ëŠ¥í•œ ì œì•½ì‚¬í•­ì´ ì¡´ì¬í•˜ëŠ” ê²ƒì´ ì¡°ê¸ˆ ì•„ì‰¬ìš´ ë¶€ë¶„ì´ë‹¤.\n\nì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ì •ë„ë¼ê¸° ë³´ë‹¨ EKSë¥¼ ì‚¬ìš©í•˜ëŠ” ê´€ì ì—ì„œ ìœ ì‚¬í•œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ê°œë°œí™˜ê²½ì„ ê°€ì ¸ê°ˆìˆ˜ ìˆê³  tanzuë‚˜ ë‹¤ë¥¸ cluster-apië¥¼ í™œìš©í•œ ë„êµ¬ë“¤ ë³´ë‹¤ ì¢€ë” ìœ ì—°í•˜ê³  ì˜¤í”ˆì†ŒìŠ¤ì— ê°€ê¹Œìš´ ê²½í—˜ì„±ì„ ì œê³µí•œë‹¤ê³  ìƒê°í•œë‹¤. ê²Œë‹¤ê°€ Fluxì˜ `Server-side reconciliation` ê¸°ë°˜ [ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ë°©ì‹](https://kubernetes.io/docs/reference/using-api/server-side-apply/)ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë§¤ìš° ìœ ì—°í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒë„ ì£¼ëª©í•´ë³¼ë§Œí•œ ë‚´ìš©ì´ë¼ ìƒê°í•œë‹¤. í´ëŸ¬ìŠ¤í„° ìì²´ë„ ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ë¼ ê°€ì •í•˜ê³  ìµœì´ˆì— ì›í•˜ëŠ” í˜•íƒœë¡œ ì„ ì–¸í•˜ê³  êµ¬ì„±ì´í›„ì—ë„ ì¿ ë²„ë„¤í‹°ìŠ¤ CRD í˜•ì‹ìœ¼ë¡œ ë…¸ë“œê·¸ë£¹ê³¼ ì¸ìŠ¤í„´ìŠ¤ ë“±ì˜ ì—¬ëŸ¬ ë¦¬ì†ŒìŠ¤ë¥¼ GitOps ë°©ì‹ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì±„íƒí•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì‹¤ì œ ì¸í”„ë¼ ê´€ë¦¬ë¥¼ í•˜ëŠ” ìš´ì˜ìë¥¼ ìœ„í•œ ê°€ì¥ íš¨ê³¼ì ì¸ ë°©ë²•ì„ ì±„íƒí–ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.\n\nê·¸ë¦¬ê³  í‘œì¤€ê·œê²©ì˜ Managed í•˜ë“œì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” Outpostì™€ ë¹„êµí•˜ëŠ” ìë£Œë“¤ì´ ìµœê·¼ ë§ì´ ì˜¬ë¼ì˜¤ê³  ìˆëŠ”ë° EKS Anywhereì˜ ê°€ì¥ í° ì¥ì ì€ ë‚´ê°€ ê°€ì§„ í•˜ë“œì›¨ì–´ë¥¼ EKS Distroê¸°ë°˜ì˜ ì˜¤í”ˆì†ŒìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆê³  AWS í™˜ê²½ê³¼ì˜ ì§ì ‘ì ì¸ í†µì‹ ì´ ì—†ì´ë„ ìì²´ì ì¸ ì›Œí¬ë¡œë“œ ìš´ì˜ì´ ê°€ëŠ¥í•œê²Œ ê°€ì¥ í° ì¥ì ì´ë¼ê³  ìƒê°í•œë‹¤. \n\ní˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì˜ ì œí’ˆê³¼ ê´€ë ¨í•´ì„œ ë¡œë“œë§µì„ ìì„¸íˆ ì–¸ê¸‰í•˜ì§€ëŠ” ëª»í•˜ì§€ë§Œ ì—”í„°í”„ë¼ì´ì¦ˆ vSphere í™˜ê²½ê³¼ ë™ì‹œì— EKSë¥¼ ì‚¬ìš©í•˜ëŠ” ì¡°ì§ì—ì„œëŠ” ì¤‘ìš”í•œ í•˜ë‚˜ì˜ ì„ íƒì§€ê°€ ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì—ì„œë„ ì§€ì¼œë³¼ë§Œí•˜ë‹¤ê³  ìƒê°í•œë‹¤. \n\në‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œëŠ” í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì— OpenTelemetry collector, Loki, Prometheus êµ¬ì„±ì„ í†µí•œ observability í™˜ê²½ êµ¬ì„±ì„ ì§„í–‰í•´ë³¼ ì˜ˆì •ì´ë‹¤.\n\n> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤."
    },
    {
      "id": "kubernetes/what-is-tailscale/",
      "metadata": {
        "permalink": "/kubernetes/what-is-tailscale/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2022-02-05-what-is-tailscale.md",
        "source": "@site/blog/2022-02-05-what-is-tailscale.md",
        "title": "What is Tailscale?",
        "description": "wireguardì™€ tailscaleì„ ë¹„êµí•˜ê³  kubernetes í™˜ê²½ì—ì„œ í™œìš©ë°©ì•ˆ ê²€í† ",
        "date": "2022-02-05T00:00:00.000Z",
        "formattedDate": "February 5, 2022",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "wireguard",
            "permalink": "/tags/wireguard"
          },
          {
            "label": "tailscale",
            "permalink": "/tags/tailscale"
          },
          {
            "label": "vpn",
            "permalink": "/tags/vpn"
          },
          {
            "label": "network",
            "permalink": "/tags/network"
          }
        ],
        "readingTime": 28.07,
        "truncated": true,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "What is Tailscale?",
          "comments": true,
          "classes": "wide",
          "description": "wireguardì™€ tailscaleì„ ë¹„êµí•˜ê³  kubernetes í™˜ê²½ì—ì„œ í™œìš©ë°©ì•ˆ ê²€í† ",
          "slug": "kubernetes/what-is-tailscale/",
          "date": "2022-02-05T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "wireguard",
            "tailscale",
            "vpn",
            "network"
          ]
        },
        "prevItem": {
          "title": "EKS Anywhere on vSphere Homelab",
          "permalink": "/kubernetes/eks-anywhere/"
        },
        "nextItem": {
          "title": "Synology monitoring with Prometheus and snmp exporter",
          "permalink": "/prometheus/synology-prometheus/"
        }
      },
      "content": "> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.\n\nì´ì§ì„ í•˜ê³  ë¸”ë¡œê·¸ì— ì†ì„ ë†“ê³  ìˆë‹¤ê°€ í˜ì´ìŠ¤ë¶ [Kubernetes Korea Group](https://ko-kr.facebook.com/groups/)ì— ì˜¬ë¼ì˜¨ [ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë”” ëª¨ì§‘ ê³µê³ ](https://gasidaseo.notion.site/c9cd413265ea4ea1b1ae38eb36dfda94)ë¥¼ ë³´ê²Œë˜ì—ˆë‹¤. ì´ì§í›„ì— ëŒ€ë¶€ë¶„ì˜ í”„ë¡œì íŠ¸ê°€ ì¿ ë²„ë„¤í‹°ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰ë˜ë‹¤ ë³´ë‹ˆ ë„¤íŠ¸ì›Œí¬ ì „ë¬¸ê°€ ì´ì‹  [ê°€ì‹œë‹¤](https://www.facebook.com/jongho.seo.5811)ë‹˜ì˜ [íŒ€ ë¸”ë¡œê·¸](https://cloudneta.github.io/)ë‚˜ ì´ë‚˜ ì—¬ëŸ¬ ì–‘ì§ˆì˜ ê²Œì‹œê¸€ë“¤ì„ ì°¸ê³ ë§Œ í•˜ë‹¤ê°€ ì¡°ê¸ˆë” ê¹Šì´ í•™ìŠµì„ í•˜ê³  ì‹¶ì–´ ìŠ¤í„°ë””ë¥¼ ì‹ ì²­í–ˆê³ , ê°„ë‹¨í•œ ë©´ì ‘(??)í›„ì— ì •ì‹ìœ¼ë¡œ ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ê²Œ ë˜ì—ˆë‹¤.  \n\në³¸ë¡ ìœ¼ë¡œ ëŒì•„ê°€ì„œ calico ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•˜ë‹¤ê°€ [wireguard](https://www.wireguard.com/)ë¼ëŠ” opensource vpnì„ ì•Œê²Œ ë˜ì—ˆê³  í•´ë‹¹ íŒ¨í‚¤ì§€ë¥¼ ì´ê²ƒì €ê²ƒ í…ŒìŠ¤íŠ¸í•˜ë‹¤ê°€ ê¸°ì¡´ì— ì‚¬ìš©ì¤‘ì¸ [tailscale](https://tailscale.com/) ê³¼ ìœ ì‚¬í•˜ë‹¤ëŠ” ê²ƒì„ ì¸ì§€í•˜ê³  ë‚´ë¶€ êµ¬ì„±ì„ ì¡°ê¸ˆ ì°¾ì•„ë³´ê¸°ë¡œ í–ˆë‹¤.  \n\ní™•ì¸í•´ë³´ë‹ˆ tailscaleì€ wireguard ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ë™ì¼ ê¸°ìˆ ì˜ ìƒìš© ì†”ë£¨ì…˜ì´ì˜€ê³ , ì´ì— ëª‡ê°€ì§€ ê³µë¶€ì°¨ ì •ë¦¬ë¥¼ ìœ„í•´ í•´ë‹¹ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ê²Œ ë˜ì—ˆë‹¤. \n\n<!--truncate-->\n\n## Wireguard\n\n- [https://www.wireguard.com/](https://www.wireguard.com/)\n\në¨¼ì € WireGuardë¥¼ ê°„ë‹¨í•˜ê²Œ ì •ì˜í•˜ë©´ ë³´ì•ˆì— ì´ˆì ì„ ë‘ê³  ë‹¨ìˆœí•¨ê³¼ ì‰¬ìš´ ì‚¬ìš©ì„ ëŒ€í‘œì ì¸ íŠ¹ì§•ìœ¼ë¡œ ë‚´ì„¸ìš°ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ê¸°ë°˜ VPN ì†Œí”„íŠ¸ì›¨ì–´ë¡œ IPsecê³¼ OpenVPNë³´ë‹¤ ì‚¬ìš©í•˜ê¸° ìš©ì´í•˜ê³  ê°€ë²¼ìš´ ê²ƒì„ ê°•ì ìœ¼ë¡œ [Linux 5.6 ì»¤ë„ ì´í›„ë¶€í„° ê¸°ë³¸ íŒ¨í‚¤ì§€](https://lore.kernel.org/wireguard/CAHmME9qOpDeraWo5rM31EWQW574KEduRBTL-+0A2ZyqBNDeYkg@mail.gmail.com/T/#u)ë¡œ íƒ‘ì¬ê°€ ë˜ì—ˆë‹¤. ì œì´ìŠ¨ ë„ë„¨í•„ë“œ(Jason Donenfeld, [@zx2c4](https://twitter.com/zx2c4))ê°€ ì„¤ê³„í•œ WireGuardëŠ” ì•”í˜¸í™” ë¯¼ì²©ì„±, ì¦‰ ë‹¤ì–‘í•œ ì•”í˜¸í™”, í‚¤ êµí™˜, í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ ì„ íƒê¶Œì„ ì œê³µí•œë‹¤ëŠ” ê°œë…ì„ ë²„ë¦¬ê³  ì•„ì£¼ ê°„ê²°í•œ ì½”ë“œ êµ¬ì¡°ë¥¼ í†µí•´ ì»¤ë„ì—ì„œ ì§ì ‘ ë™ì‘í•˜ê³  ì£¼ìš” ì•”í˜¸ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ì„œ ë³‘ë ¬ì²˜ë¦¬í•˜ë¯€ë¡œ ë¹ ë¥¸ ì†ë„ë¥¼ ìë‘í•œë‹¤.  \n\ní™ˆí˜ì´ì§€ì— ê²Œì‹œëœ ëª‡ê°€ì§€ íŠ¹ì§•ì„ ì •ë¦¬í•˜ë©´ \n- Simple & Easy-to-use : SSH ì²˜ëŸ¼ í‚¤êµí™˜ ë°©ì‹ìœ¼ë¡œ ì§„í–‰ë˜ê³  WireGuardì— ì˜í•´ ê´€ë¦¬ë˜ê¸° ë•Œë¬¸ì— ì‰½ê²Œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ê³ , IPê°€ ë³€ê²½ë˜ëŠ” ëª¨ë°”ì¼ ë¡œë°ì¤‘ì—ì„œ ì—°ê²°ì´ ë³´ì¥ë˜ëŠ” ê²ƒì´ íŠ¹ì§•ì´ë‹¤. \n- Cryptographically Sound : [Noise protocol framework](http://www.noiseprotocol.org/), [Curve25519](http://cr.yp.to/ecdh.html), [ChaCha20](http://cr.yp.to/chacha.html), [Poly1305](http://cr.yp.to/mac.html), [BLAKE2](https://blake2.net/), [SipHash24](https://131002.net/siphash/), [HKDF](https://eprint.iacr.org/2010/264) ì™€ ê°™ì€ ê°€ì¥ ë¹ ë¥´ê³  ìµœì‹ ì˜ ì•”í˜¸, í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œë‹¤.  \n- Minimal Attack Surface : WireGuardëŠ” êµ¬í˜„ ìš©ì´ì„±ê³¼ ë‹¨ìˆœì„±ì„ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„ë˜ì—ˆë‹¤. ë§¤ìš° ì ì€ ì½”ë“œ ë¼ì¸ìœ¼ë¡œ êµ¬í˜„ë˜ì„œ ë³´ì•ˆ ì·¨ì•½ì ì— ëŒ€í•´ ì‰½ê²Œ ê°ì‚¬í•  ìˆ˜ ìˆë‹¤. ê·¸ë§Œí¼ ì² ì €íˆ ê²€ì¦ë  ê°€ëŠ¥ì„±ì´ ë†’ê³ , ì˜ˆìƒì¹˜ ëª»í•œ ê³³ì—ì„œì˜ ë²„ê·¸ë¡œ ì¸í•œ ì·¨ì•½ì ì´ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìƒëŒ€ì ìœ¼ë¡œ ì ë‹¤ëŠ” ì–˜ê¸°ê°€ ëœë‹¤.  \n- High Performance : ëª¨ë“  ê²ƒì´ kernelì—ì„œ ë™ì‘í•˜ê³  ì•ˆì „í•œ ë„¤íŠ¸ì›Œí‚¹ì´ ë§¤ìš° ë¹ ë¥¸ ì†ë„ ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ìŠ¤ë§ˆíŠ¸í°ê³¼ ë°±ë³¸ ë¼ìš°í„°ì™€ ê°™ì€ ì‘ì€ ì„ë² ë””ë“œ ì¥ì¹˜ ë“± ëª¨ë‘ì— ì í•©í•˜ë‹¤.  \n- Well Defined & Thoroughly Considered : WireguardëŠ” [ë°±ì„œ](https://www.wireguard.com/papers/wireguard.pdf)ê°€ ë°œí–‰ë  ì •ë„ë¡œ ê¸°ìˆ ì ìœ¼ë¡œ ì—¬ëŸ¬ê°€ì§€ ê³ ë ¤ì‚¬í•­ë“¤ì„ ëª…í™•í•˜ê²Œ ì •ì˜í•´ë†¨ë‹¤.\n\nê´€ë ¨í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë°±ì„œ](https://www.wireguard.com/papers/wireguard.pdf) ë¥¼ ì°¸ê³ í•œë‹¤.\n\n### Wireguard in Calico CNI\n\nìŠ¤í„°ë””ë¥¼ ì§„í–‰í• ë•ŒëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ íŒŒë“œì™€ íŒŒë“œ ì‚¬ì´ì˜ íŒ¨í‚·ì„ ë„¤íŠ¸ì›Œí¬ ë ˆë²¨ë¡œ ì•”í˜¸í™” í•˜ëŠ” ë„êµ¬ë¡œ Calicoì— ë‚´ì¥ëœ WireGuard í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•´ì„œ íŒŒë“œê°„ í„°ë„ì„ ì„¤ì •í•˜ê³  íŠ¸ë˜í”½ì„ ì•”í˜¸í™” í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê²Œ ë˜ì—ˆë‹¤. Calico CNIì—ì„œ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì€ `calicoctl`ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ì •í•˜ê¸° ë•Œë¬¸ì— ê°„ë‹¨í•˜ë‹¤. \n\n```\n$ calicoctl patch felixconfiguration default --type='merge' -p '{\"spec\":{\"wireguardEnabled\":true}}'\n\n$ calicoctl get felixconfiguration default -o yaml | grep wireguardEnabled\n  wireguardEnabled: true\n```\n\níŒŒë“œê°„ì˜ ping testë¥¼ ì§„í–‰í•˜ê³  ë‚œ ì´í›„ íŒŒë“œ ë ˆë²¨ì—ì„œ íŒ¨í‚· ë¤í”„í•œ ë‚´ìš©ì„ wiresharkë¡œ í™•ì¸í•œ ë‚´ìš©ì´ë‹¤. ê·¸ë¦¼ì—ì„œì²˜ëŸ¼ icmp íŒ¨í‚·ì€ í™•ì¸ì´ ì•ˆë˜ê³  udpì™€ wireguard í”„ë¡œí† ì½œì„ í†µí•´ ë°ì´í„°ê°€ ì•”í˜¸í™” ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n![wg](/img/wg.png)\n\nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” tailscale í™œìš©ë°©ì•ˆì„ ì†Œê°œí•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ calicoë¥¼ í†µí•´ wireguard ì„¤ì •í•˜ëŠ” ê²ƒì€ ë„˜ì–´ê°„ë‹¤. ë‹¤ë¥¸ ì¢‹ì€ ë‚´ìš©ë“¤ì€ ë‹¤ìŒ ë§í¬ë“¤ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n### ì°¸ê³ ìë£Œ\n- [WireGuardë¡œ ë©‹ì§„ VPN ì„œë²„ êµ¬ì¶•í•˜ê¸° - devsisters](https://tech.devsisters.com/posts/wireguard-vpn-1/)\n- [WireGuard VPN í•´ë¶€ - Slowboot](https://slowbootkernelhacks.blogspot.com/2020/09/wireguard-vpn.html)\n- [Kilo - multi-cloud k8s network overlay built on WireGuard](https://github.com/squat/kilo)\n- [Go implementation of WireGuard](https://git.zx2c4.com/wireguard-go/about/)\n\n## Tailscale\n\n- [https://tailscale.com/](https://tailscale.com/)\n\nTailScaleì€ ì„œë²„, ì»´í“¨í„° ë° í´ë¼ìš°ë“œ ì¸ìŠ¤í„´ìŠ¤ê°„ì— ë³´ì•ˆ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§Œë“œëŠ” VPNìœ¼ë¡œ Wireguard í”„ë¡œí† ì½œì„ ì‚¬ìš©í•´ì„œ ë§Œë“  í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì´ë‹¤. Tailscaleì´ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ëŠ” [ê³µì‹ ë¸”ë¡œê·¸](https://tailscale.com/blog/how-tailscale-works/)ì—ì„œ ê°„ë‹¨íˆ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\nê°„ë‹¨í•˜ê²Œ ë¸”ë¡œê·¸ ë‚´ìš©ì„ ì •ë¦¬í•´ë³´ë©´ ê¸°ì¡´ì˜ VPN ë°©ì‹ì€ Hub-and-spoke ë°©ì‹ìœ¼ë¡œ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ Gateway ë°©ì‹ìœ¼ë¡œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ë¥¼ ì—°ê²°í•˜ëŠ”ê²Œ ê¸°ì¡´ì˜ ë°©ì‹ì´ë‹¤. ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ë‚˜ ì„œë²„ê°€ ì¶”ê°€ë  ê²½ìš° ìƒˆë¡œìš´ í‚¤ë¥¼ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ë°°í¬í•˜ê²Œ ë˜ê³  ì´ëŠ” ì¥ë¹„ê°€ ì¦ê°€í•¨ì— ë”°ë¼ ë§ì€ ì‘ì—…ì´ í•„ìš”ë¡œ í•˜ê²Œ ëœë‹¤.\n\n![hub](https://tailscale.com/blog/how-tailscale-works/hub-and-spoke-single.svg)\n\nWireguard í„°ë„ì„ ì´ìš©í•˜ë©´ ë…¸ë“œê°„ì˜ ì—°ê²°ì´ ì§ì ‘ ì´ë¤„ì§€ê²Œ ë˜ê³  ì´ëŠ” ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ë©”ì‰¬ í˜•íƒœë¡œ êµ¬ì„±ë˜ê²Œ ëœë‹¤. \n\n![mesh](https://tailscale.com/blog/how-tailscale-works/mesh-network.svg)\n\nì´ëŸ° ë©”ì‰¬ë°©ì‹ì˜ ê°€ì¥ í° ë‹¨ì ì€ í”¼ì–´ë¼ë¦¬ ì—°ê²°í•˜ëŠ” ë…¸ë“œ ë„¤íŠ¸ì›Œí¬ì˜ ê²½ìš° ì—°ê²°ë˜ëŠ” ê²½ìš°ì˜ ìˆ˜ê°€ `n(n-1)`ìœ¼ë¡œ ê·¸ë¦¼ì˜ ì˜ˆì‹œì—ì„œë„ 10*9 = 90ê°œì˜ ì—°ê²° êµ¬ì„±ì´ í•„ìš”í•˜ê²Œ ëœë‹¤. ëª¨ë“  ë…¸ë“œê°€ í•´ë‹¹ ì‚¬í•­ìœ¼ë¡œ Wireguardì˜ keyë¥¼ ë¡œí…Œì´íŠ¸í•˜ê±°ë‚˜ ì‚¬ìš©ìë¥¼ ì¶”ê°€, ì œê±°í• ë•Œë§ˆë‹¤ ê° ë…¸ë“œì— ì—…ë°ì´íŠ¸ê°€ ë˜ì–´ì•¼ í•œë‹¤. ë§Œì•½ì—ë¼ë„ ê° ë…¸ë“œì— static ipê°€ ì—†ì„ ê²½ìš° ë…¸ë“œë¼ë¦¬ ì°¾ëŠ”ì¼ì´ ê²°ê³  ì‰½ì§€ëŠ” ì•Šì„ ê²ƒì´ë‹¤. íŠ¹íˆ ë°©í™”ë²½ì„ ìš´ì˜í•˜ëŠ” ì—”í„°í”„ë¼ì´ì¦ˆ ì¡°ì§ì˜ ê²½ìš°ì— ë”ìš±ë” ê¹Œë‹¤ë¡œìš´ ì¼ì´ ëœë‹¤ê³  ë§í•œë‹¤.\n\nê·¸ë˜ì„œ Tailscaleì—ì„œ ì´ì•¼ê¸°í•˜ëŠ” ê°€ì¥ í•µì‹¬ì€ ë…¸ë“œ ê°„ì˜ íŠ¸ë˜í”½ì„ ê°ì‚¬, í†µì œí•  ìˆ˜ ìˆëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì„ ë‘ëŠ”ê²ƒì´ë‹¤. ë°©í™”ë²½ì´ë‚˜ static ipê°€ ì—†ëŠ” í™˜ê²½ì—ì„œë„ ë…¸ë“œ, í”¼ì–´ê°„ì˜ í†µì œê°€ ê°€ëŠ¥í•œ í™˜ê²½ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ê¸°ë³¸ ì‚¬ìƒì´ë‹¤. \n\n![controlplane](https://tailscale.com/blog/how-tailscale-works/mesh-coordination-server.svg)\n\n### ê¸°ë³¸ ì‘ë™ë°©ì‹\n\n- ê° ë…¸ë“œ(í´ë¼ì´ì–¸íŠ¸)ëŠ” ëœë¤ ê³µê°œí‚¤ì™€ ê°œì¸í‚¤ë¥¼ ìƒì„±í•˜ê³  ê³µê°œí‚¤ë¥¼ ID(tailscale account)ì™€ ì—°ê²°í•œë‹¤.\n- ë…¸ë“œëŠ” ì¤‘ì•™ì˜ tailscaleì„œë²„ì— ê³µê°œí‚¤ì™€ í•´ë‹¹ ë…¸ë“œê°€ í˜„ì¬ ì—°ê²°ê°€ëŠ¥í•œì§€ì™€ ë„ë©”ì¸ ì •ë³´(client name) ì •ë³´ë¥¼ ì „ë‹¬í•œë‹¤. \n- ë…¸ë“œëŠ” tailscaleì„œë²„ ì—…ë°ì´íŠ¸ëœ ë„ë©”ì¸ì˜ ê³µê°œí‚¤ ë° ì£¼ì†Œ ëª©ë¡ì„ ë‹¤ìš´ë¡œë“œ í•œë‹¤.\n- ë…¸ë“œëŠ” ë‚´ë ¤ë°›ì€ ê³µê°œ í‚¤ ì„¸íŠ¸ë¡œ Wireguard ì¸ìŠ¤í„´ìŠ¤ë¥¼ êµ¬ì„±í•œë‹¤.\n\nì´ëŠ” ë‹¤ì‹œ hub-and-spoke ëª¨ë¸ë¡œ ëŒì•„ê°„ê²ƒ ê°™ì§€ë§Œ ì‹¤ì œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ê³¼ ë°ì´í„° í”Œë ˆì¸ì„ ë¶„ë¦¬í•´ì„œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì‹¤ì œ ì¤‘ì•™ ì„œë²„ê°€ ê´€ë¦¬í•˜ëŠ” ê²ƒì€ ê³µê°œí‚¤ ì„¸íŠ¸ì™€ ì—°ê²°ê°€ëŠ¥í•œ ë…¸ë“œ ë¦¬ìŠ¤íŠ¸ ì •ë³´ë¿ì´ë‹¤.\n\n## Tailscale í…ŒìŠ¤íŠ¸\n\n### talescale ì„¤ì¹˜ (macOS ê¸°ì¤€)\n\n- [https://tailscale.com/download](https://tailscale.com/download)\n\nmacOSìš© CLI ì„¤ì¹˜ ì •ë³´ëŠ” ì•„ë˜ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n- [https://tailscale.com/kb/1065/macos-variants/](https://tailscale.com/kb/1065/macos-variants/)\n\nmacOSìš© GUI í´ë¼ì´ì–¸íŠ¸ì— CLIë„ ë‚´ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— `.zshrc`ì— aliasë¥¼ ì¶”ê°€í–ˆë‹¤. \n\n```\nalias tailscale=\"/Applications/Tailscale.app/Contents/MacOS/Tailscale\"\n```\n\n2022ë…„ 2ì›” 5ì¼ì ê¸°ì¤€ìœ¼ë¡œ 1.20.2 ë²„ì „ì„ ì‚¬ìš©í•œë‹¤. \n\n```\n$ tailscale version\n1.20.2\n  tailscale commit: 312750ddd288cf4073cfaef56a45102b9c1e8421\n  other commit: 2c164d9c7443e2f3014fa54ea45e946b35152680\n  go version: go1.17.6-tse44d304e54\n```\n\nwindowsì—ì„œë„ ì‰½ê²Œ ì„¤ì¹˜ê°€ ê°€ëŠ¥í•˜ê³ , ë¬¼ë¡  ì• ì •í•˜ëŠ” Synologyì—ë„ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤. \n\n[https://github.com/tailscale/tailscale-synology](https://github.com/tailscale/tailscale-synology)\n\nì„¤ì¹˜ëœ í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ë¥¼ tailscale ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ VPNì—°ê²°ì´ ëë‚œë‹¤. \n\nì—°ê²°ëœ ë¨¸ì‹ ë¦¬ìŠ¤íŠ¸ëŠ” ì•„ë˜ì™€ ê°™ì´ [Machines](https://login.tailscale.com/admin/machines) ë©”ë‰´ ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆê³  ê° ë…¸ë“œë‚˜ í´ë¼ì´ì–¸íŠ¸ë¡œ í• ë‹¹ëœ `100.*` ëŒ€ì—­ IPë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤. \n\n![machine](/img/tailscale-web.png)\n\nì—¬ê¸°ì„œ machine nameìœ¼ë¡œ ì§ì ‘ ì ‘ì†ì´ ê°€ëŠ¥í•˜ê¸° ìœ„í•´ì„œëŠ” MagicDNS ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ë° `beta` ê¸°ëŠ¥ìœ¼ë¡œ [í™œì„±í™”](https://login.tailscale.com/admin/dns)ë¥¼ í•  ìˆ˜ ìˆê³  ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” ì¥ì¹˜ì˜ DNS ì´ë¦„ì„ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.\n\n- DNS ì„¤ì •ê°€ì´ë“œ : [https://tailscale.com/kb/1081/magicdns/](https://tailscale.com/kb/1081/magicdns/)\n\nCLIë¡œ í˜„ì¬ ì—°ê²°ëœ client ì •ë³´ë‚˜ publickey ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\n$ tailscale status\n100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -\n100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline\n100.95.209.95   proxy                ddiiwoong@   linux   -\n100.106.65.5    win11                ddiiwoong@   windows -\n\n$ tailscale status --json | jq '.Self.PublicKey'\n\"nodekey:97c4dc44ecdf56******************adb3246d87fd9e270\"\n```\n\nDNS ë“±ë¡ ë°©ì‹ì€ ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ë˜ê³ \n\n![magicdns](https://tailscale.com/kb/1081/magicdns/magic-dns-naming.png)\n\në‚´ê°€ ë“±ë¡í•œ ë¨¸ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ win11 ì€ ë‹¤ìŒ ì •ë³´ë¡œ ë„ë©”ì¸ì´ ë“±ë¡ëœë‹¤.\n\n```\nwin11.ddiiwoong.gmail.com.beta.tailscale.net\n```\n\në‘ê°€ì§€ ë°©ì‹ìœ¼ë¡œ í•´ë‹¹ ë¨¸ì‹ ì— ping checkë¥¼ í•  ìˆ˜ ìˆë‹¤.\n\n```sh\n$ ping win11\nPING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes\n64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=124.031 ms\n64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.180 ms\n64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.776 ms\n\n$ ping win11.ddiiwoong.gmail.com.beta.tailscale.net\nPING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes\n64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=5.086 ms\n64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.060 ms\n64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.213 ms\n```\n\n### kubernetes í™˜ê²½êµ¬ì„±\n\nkubernetes ë¦¬ì†ŒìŠ¤ë¡œ tailscaleì„ êµ¬ì„±ì„ í•´ë³´ì. ë¨¼ì € `1.16` ë²„ì „ ì´ìƒì˜ kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì¤€ë¹„í•œë‹¤. ì•„ë˜ êµ¬ì„±í™˜ê²½ì€ `1.21.5` ë²„ì „ìœ¼ë¡œ eksctlë¡œ ì„¤ì¹˜í•œ ê¸°ë³¸ EKS í´ëŸ¬ìŠ¤í„°ì´ë‹¤. \n\n```sh\n$ kubectl get node\nNAME                                                 STATUS   ROLES    AGE   VERSION\nip-192-168-101-195.ap-northeast-2.compute.internal   Ready    <none>   19h   v1.21.5-eks-9017834\nip-192-168-134-35.ap-northeast-2.compute.internal    Ready    <none>   19h   v1.21.5-eks-9017834\nip-192-168-186-235.ap-northeast-2.compute.internal   Ready    <none>   19h   v1.21.5-eks-9017834\n```\n\n### authKey ë°œê¸‰ ë° Secret ë“±ë¡\n\nauthKeyëŠ” tailscale ë„¤íŠ¸ì›Œí¬ì— ë“±ë¡í•˜ê¸° ìœ„í•œ Keyë¡œ ì•„ë˜ì™€ ê°™ì´ ê´€ë¦¬ë¥¼ Webì—ì„œ í•  ìˆ˜ ìˆë‹¤.\n\n![key](/img/tailscale-key.png)\n\n[Keys](https://login.tailscale.com/admin/settings/keys) ë©”ë‰´ë¡œ ì´ë™í•´ì„œ auth Keyë¥¼ ë°œê¸‰ë°›ëŠ”ë‹¤. ë°œê¸‰ì„ í• ë•Œ ì—¬ëŸ¬ë¨¸ì‹ ì—ì„œ ì‚¬ìš©í•  ê²½ìš°ëŠ” `Reusable`, ì„ì‹œë¡œ í‚¤ë¥¼ ì‚¬ìš©í• ë•ŒëŠ” `Ephemeral` ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤. ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë°œê¸‰ë˜ê³ , í•´ë‹¹ keyëŠ” kubernetes `Secret` ë¦¬ì†ŒìŠ¤ì— ë“±ë¡ì„ í•´ì„œ ì‚¬ìš©í•  ê²ƒì´ë‹¤.\n\n```\ntskey-kZAinb5CNTRL-********************\n```\n\ní•´ë‹¹ auth Keyë¥¼ Secretìœ¼ë¡œ ìƒì„±í•œë‹¤.\n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: tailscale-auth\nstringData:\n  AUTH_KEY: tskey-kZAinb5CNTRL-********************\n```\n```sh\n$ kubectl get secret -n tailscale\nNAME                    TYPE                                  DATA   AGE\ndefault-token-fww2j     kubernetes.io/service-account-token   3      18h\ntailscale-auth          Opaque                                3      18h\ntailscale-token-7cgsc   kubernetes.io/service-account-token   3      17h\n```\n\n### image build & push\n\ntailscale imageë¥¼ ë¹Œë“œí•œë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•œë‹¤.  \n- [https://github.com/tailscale/tailscale/tree/main/docs/k8s](https://github.com/tailscale/tailscale/tree/main/docs/k8s)\n\nDockerfileì€ ë‹¤ìŒê³¼ ê°™ì´ ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•œë‹¤. \n```dockerfile\nFROM ghcr.io/tailscale/tailscale:latest\nCOPY run.sh /run.sh\nCMD \"/run.sh\"\n```\n\n[run.sh](https://github.com/tailscale/tailscale/blob/main/docs/k8s/run.sh)ì„ ì‚´í´ë³´ë©´ `tailscaled` ë°ëª¬ì„ ì‹¤í–‰í• ë•Œ ëª‡ê°€ì§€ í™˜ê²½ë³€ìˆ˜ë¥¼ ì…ë ¥ë°›ì•„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. \n\n`AUTH_KEY`ì™€ `KUBE_SECRET`ì€ ìœ„ Secretìœ¼ë¡œ ì²˜ë¦¬ë¥¼ í•˜ê³  ì—¬ëŸ¬ ì‚¬ìš© ëª¨ë“œ(router, userspace)ë„ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ì‹œ ì…ë ¥ë°›ì•„ ì²˜ë¦¬í•œë‹¤. ë˜í•œ, ë§ˆì§€ë§‰ êµ¬ë¬¸ì„ ë³´ë©´ ëª©ì ì§€ IP DNAT ì²˜ë¦¬ë¥¼ ìœ„í•œ iptables ë“±ë¡ ì˜µì…˜ë„ ìˆë‹¤.\n\n```sh\n#! /bin/sh\n\nexport PATH=$PATH:/tailscale/bin\n\nAUTH_KEY=\"${AUTH_KEY:-}\"\nROUTES=\"${ROUTES:-}\"\nDEST_IP=\"${DEST_IP:-}\"\nEXTRA_ARGS=\"${EXTRA_ARGS:-}\"\nUSERSPACE=\"${USERSPACE:-true}\"\nKUBE_SECRET=\"${KUBE_SECRET:-tailscale}\"\n\nset -e\n\nTAILSCALED_ARGS=\"--state=kube:${KUBE_SECRET} --socket=/tmp/tailscaled.sock\"\n\nif [[ \"${USERSPACE}\" == \"true\" ]]; then\n  if [[ ! -z \"${DEST_IP}\" ]]; then\n    echo \"IP forwarding is not supported in userspace mode\"\n    exit 1\n  fi\n  TAILSCALED_ARGS=\"${TAILSCALED_ARGS} --tun=userspace-networking\"\nelse\n  if [[ ! -d /dev/net ]]; then\n    mkdir -p /dev/net\n  fi\n\n  if [[ ! -c /dev/net/tun ]]; then\n    mknod /dev/net/tun c 10 200\n  fi\nfi\n\necho \"Starting tailscaled\"\ntailscaled ${TAILSCALED_ARGS} &\nPID=$!\n\nUP_ARGS=\"--accept-dns=false\"\nif [[ ! -z \"${ROUTES}\" ]]; then\n  UP_ARGS=\"--advertise-routes=${ROUTES} ${UP_ARGS}\"\nfi\nif [[ ! -z \"${AUTH_KEY}\" ]]; then\n  UP_ARGS=\"--authkey=${AUTH_KEY} ${UP_ARGS}\"\nfi\nif [[ ! -z \"${EXTRA_ARGS}\" ]]; then\n  UP_ARGS=\"${UP_ARGS} ${EXTRA_ARGS:-}\"\nfi\n\necho \"Running tailscale up\"\ntailscale --socket=/tmp/tailscaled.sock up ${UP_ARGS}\n\nif [[ ! -z \"${DEST_IP}\" ]]; then\n  echo \"Adding iptables rule for DNAT\"\n  iptables -t nat -I PREROUTING -d \"$(tailscale --socket=/tmp/tailscaled.sock ip -4)\" -j DNAT --to-destination \"${DEST_IP}\"\nfi\n\nwait ${PID}\n```\n\nbuildí•˜ê³  ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ push í•˜ì.\n```sh\n$ export IMAGE_TAG=ddiiwoong/tailscale-k8s:latest\n$ docker build . -t $(IMAGE_TAG)\n$ docker push $(IMAGE_TAG)\n$ docker images ddiiwoong/tailscale-k8s:latest\nREPOSITORY            TAG       IMAGE ID       CREATED        SIZE\nddiiwoong/tailscale-k8s   latest    9dc489da64c4   18 hours ago   44.1MB\n```\n\n### RBAC ë¦¬ì†ŒìŠ¤ ìƒì„±\n\nrbac ì„¤ì •ì„ ìœ„í•´ì„œ `role`, `rolebinding`, `serviceaccount`ë¥¼ ìƒì„±í•œë‹¤.\n\n```sh\nexport SA_NAME=tailscale\nexport KUBE_SECRET=tailscale-auth\n```\n\nìœ„ ENVê°’ì„ ì¹˜í™˜í•´ì„œ ìƒì„±í•œë‹¤.\n\n```yaml\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: tailscale\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: tailscale\nrules:\n- apiGroups: [\"\"] # \"\" indicates the core API group\n  resources: [\"secrets\"]\n  # Create can not be restricted to a resource name.\n  verbs: [\"create\"]\n- apiGroups: [\"\"] # \"\" indicates the core API group\n  resourceNames: [\"tailscale-auth\"]\n  resources: [\"secrets\"]\n  verbs: [\"get\", \"update\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: tailscale\nsubjects:\n- kind: ServiceAccount\n  name: tailscale\nroleRef:\n  kind: Role\n  name: tailscale\n  apiGroup: rbac.authorization.k8s.io\n```\n\n### sidecar ë°°í¬\n\nsidecar ìƒì„±ì„ ìœ„í•´ manifestë¥¼ í™•ì¸í•œë‹¤. ìì„¸íˆ ì‚´í´ë³´ë©´ `ts-sidecar` ì»¨í…Œì´ë„ˆ securityContextì— `NET_ADMIN` ê¶Œí•œì´ ì¶”ê°€ëœê²ƒì„ ë³¼ìˆ˜ ìˆë‹¤. ì´ëŠ” sidecar íŒŒë“œê°€ í„°ë„ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ ìƒìœ„ ë…¸ë“œ `CAP_NET_ADMIN` ê¶Œí•œì„ ì·¨ë“í•˜ê¸° ìœ„í•¨ì´ë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [Set capabilities for a Container](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container) ë¬¸ì„œë¥¼ í™•ì¸í•˜ì. \n\nê·¸ë¦¬ê³  ì¶”ê°€ sidecarë¡œ `nicolaka/netshoot`ë¥¼ ì¶”ê°€í–ˆëŠ”ë° ì´ëŠ” [ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì²˜ë¦¬ì— ìœ ìš©í•œ í”„ë¡œì íŠ¸](https://github.com/nicolaka/netshoot)ë¡œ ì—¬ëŸ¬ê°€ì§€ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  serviceAccountName: tailscale\n  containers:\n  - name: nginx\n    image: nginx\n  - name: netshoot\n    image: nicolaka/netshoot \n    command: [\"tail\"]\n    args: [\"-f\", \"/dev/null\"]\n  - name: ts-sidecar\n    imagePullPolicy: Always\n    image: ddiiwoong/tailscale-k8s:latest\n    env:\n      # Store the state in a k8s secret\n    - name: KUBE_SECRET\n      value: tailscale-auth\n    - name: USERSPACE\n      value: \"false\"\n    - name: AUTH_KEY\n      valueFrom:\n        secretKeyRef:\n          name: tailscale-auth\n          key: AUTH_KEY\n          optional: true\n    securityContext:\n      capabilities:\n        add:\n        - NET_ADMIN\n```\n\nìƒì„±ì„ í•˜ê³  ì‚´í´ë³´ë©´ sidecar nginx íŒŒë“œê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```sh\n$ kubectl get pod nginx -n tailscale\nNAME    READY   STATUS    RESTARTS   AGE\nnginx   3/3     Running   0          25s\n```\n\ntailscale sidecar ë¡œê·¸ë¥¼ ì ê¹ ì‚´í´ë³´ì. ìƒˆë¡œìš´ `tailscale0` tun ì¸í„°í˜ì´ìŠ¤ê°€ ì¶”ê°€ë˜ê³  ì›ë˜ pod eth0 ì¸í„°í˜ì´ìŠ¤ ipë„ í™•ì¸ì´ ëœë‹¤. ë˜í•œ `wireguard` deviceë„ ì˜¬ë¼ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```sh\n$ kubectl logs nginx ts-sidecar -n tailscale\nStarting tailscaled\nRunning tailscale up\n2022/02/05 12:20:26 logtail started\n2022/02/05 12:20:26 Program starting: v1.20.2-t8e643357d, Go 1.17.6-tse44d304e54: []string{\"tailscaled\", \"--state=kube:tailscale-auth\", \"--socket=/tmp/tailscaled.sock\"}\n2022/02/05 12:20:26 LogID: 31416c9a454e3667661bf0f21ccde8ebf72604d7434660b0db55e838be372bc4\n2022/02/05 12:20:26 logpolicy: using system state directory \"/var/lib/tailscale\"\nlogpolicy.Read /var/lib/tailscale/tailscaled.log.conf: open /var/lib/tailscale/tailscaled.log.conf: no such file or directory\n2022/02/05 12:20:26 wgengine.NewUserspaceEngine(tun \"tailscale0\") ...\n2022/02/05 12:20:26 router: disabling tunneled IPv6 due to system IPv6 config: disable_ipv6 is set\n2022/02/05 12:20:26 dns: [rc=unknown ret=direct]\n2022/02/05 12:20:26 dns: using *dns.directManager\n2022/02/05 12:20:26 link state: interfaces.State{defaultRoute=eth0 ifs={eth0:[192.168.118.89/32]} v4=true v6=false}\n2022/02/05 12:20:26 magicsock: disco key = d:1b04c57ebf000fe0\n2022/02/05 12:20:26 Creating wireguard device...\n2022/02/05 12:20:26 Bringing wireguard device up...\n2022/02/05 12:20:26 Bringing router up...\n2022/02/05 12:20:26 external route: up\n2022/02/05 12:20:26 Clearing router settings...\n2022/02/05 12:20:26 Starting link monitor...\n2022/02/05 12:20:26 Engine created.\n2022/02/05 12:20:26 netmap packet filter: (not ready yet)\n2022/02/05 12:20:26 Start\n2022/02/05 12:20:26 using backend prefs\n...\n2022/02/05 12:20:28 active login: ddiiwoong@gmail.com\n2022/02/05 12:20:28 netmap packet filter: 1 filters\n...\n2022/02/05 12:20:28 dns: Set: {DefaultResolvers:[] Routes:{} SearchDomains:[] Hosts:4}\n2022/02/05 12:20:28 dns: Resolvercfg: {Routes:{} Hosts:4 LocalDomains:[]}\n2022/02/05 12:20:28 dns: OScfg: {Nameservers:[] SearchDomains:[] MatchDomains:[]}\n2022/02/05 12:20:28 Taildrop disabled; no state directory\n2022/02/05 12:20:28 peerapi starting without Taildrop directory configured\n2022/02/05 12:20:28 peerapi: serving on http://100.95.209.95:34980\n...\n```\n\nnetshoot íŒŒë“œë‚´ì—ì„œë„ `tailscale0` ì¸í„°í˜ì´ìŠ¤ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```sh\n$ kubectl exec -it nginx -c netshoot -- ip -c addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n3: eth0@if8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default\n    link/ether 6e:f8:f5:f3:47:11 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 192.168.118.89/32 scope global eth0\n       valid_lft forever preferred_lft forever\n4: tailscale0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1280 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none\n    inet 100.95.209.95/32 scope global tailscale0\n       valid_lft forever preferred_lft forever\n```\n\në¡œì»¬ì—ì„œ `tailscale` CLIë¥¼ í†µí•´ IPì •ë³´ë„ ë™ì¼í•œ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.\n\n```sh\n$ tailscale status\n100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -\n100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline\n100.95.209.95   nginx                ddiiwoong@   linux   -\n100.106.65.5    win11                ddiiwoong@   windows -\n```\n\në¨¼ì € ì–´ë– í•œ kubernetes ì„œë¹„ìŠ¤ë„ ì—†ëŠ” ê²ƒì„ í™•ì¸í•˜ê³ , ë¯¸ë¦¬ magicdnsë¥¼ êµ¬ì„±í•´ë†¨ê¸° ë•Œë¬¸ì— `nginx` ì£¼ì†Œë¡œ ì§ì ‘ í†µì‹ ì„ ì‹œë„í•´ë³´ì. \n\n```\n$ kubectl get svc -n A\nNo resources found in A namespace.\n\n$ ping nginx\nPING nginx.ddiiwoong.gmail.com.beta.tailscale.net (100.95.209.95): 56 data bytes\n64 bytes from 100.95.209.95: icmp_seq=0 ttl=255 time=193.606 ms\n64 bytes from 100.95.209.95: icmp_seq=1 ttl=255 time=95.747 ms\n64 bytes from 100.95.209.95: icmp_seq=2 ttl=255 time=94.441 ms\n\n$ curl http://nginx\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n...\n```\n\n### Userspace Sidecar í…ŒìŠ¤íŠ¸\n\nuserspace ëª¨ë“œë¡œ ì‹¤í–‰í•´ë³´ì. ìœ„ì™€ ì°¨ì´ì ì€ `NET_ADMIN` ê¶Œí•œì„ ë¹¼ê³ , `runAsUser: 1000`ì™€ `runAsGroup: 1000`ì„ ì¶”ê°€í–ˆë‹¤. í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ë‚˜ ë…¸ë“œê°€ ì™¸ë¶€ë¡œ í†µì‹ ì„ ìœ„í•´ì„œëŠ” [SOCKS5 ì´ë‚˜ HTTP proxy ëª¨ë“œ](https://tailscale.com/kb/1112/userspace-networking/)ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤. ì´ë²ˆ ë°ëª¨ì—ì„œëŠ” êµ¬ì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.\n\nuserspace ëª¨ë“œëŠ” ì£¼ë¡œ ì„œë²„ë¦¬ìŠ¤ ì›Œí¬ë¡œë“œ(Heroku, Google Cloud Run, AWS Lambda, Github Action)ì—ì„œ í™œìš©ì„ í•  ë•Œ ì¢‹ë‹¤. ë‹¨ ë³´ì•ˆì„ ìœ„í•´ authKeyë¥¼ `ephemeral` í˜•íƒœë¡œ êµ¬ì„±í•˜ëŠ”ê²Œ ì¢‹ë‹¤.\n\n```\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  serviceAccountName: tailscale\n  containers:\n  - name: nginx\n    image: nginx\n  - name: netshoot\n    image: nicolaka/netshoot \n    command: [\"tail\"]\n    args: [\"-f\", \"/dev/null\"]\n  - name: ts-sidecar\n    imagePullPolicy: Always\n    image: ddiiwoong/tailscale-k8s:latest\n    securityContext:\n      runAsUser: 1000\n      runAsGroup: 1000\n    env:\n    - name: KUBE_SECRET\n      value: tailscale-auth\n    - name: USERSPACE\n      value: \"true\"\n    - name: AUTH_KEY\n      valueFrom:\n        secretKeyRef:\n          name: tailscale-auth\n          key: AUTH_KEY\n          optional: true\n```\n\në™ì¼í•˜ê²Œ ì ‘ì†ì´ ê°€ëŠ¥í•œë°, userspace ëª¨ë“œ ì´ê¸° ë•Œë¬¸ì— netshoot ì»¨í…Œì´ë„ˆë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¸í•˜ë©´ ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì— eth0 ë§Œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤. \n\n```sh\n$ kubectl exec -it nginx -c netshoot -- ip -c addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n3: eth0@if10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default\n    link/ether 3a:c5:b6:cf:d1:bd brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 192.168.117.251/32 scope global eth0\n       valid_lft forever preferred_lft forever\n```\n\n### Proxy ëª¨ë“œ í…ŒìŠ¤íŠ¸\n\nê¸°ì¡´ì˜ ë°°í¬ëœ Service ë¦¬ì†ŒìŠ¤ì— ì—°ê²°í•˜ëŠ” ë°©ì‹ì´ë‹¤. ë¯¸ë¦¬ nginxë¥¼ ë„ì›Œ ë†“ê³  ClusterIPë¥¼ í™•ì¸í•œë‹¤.\n\n```\n$ kubectl create deployment nginx --image nginx\n$ kubectl expose deployment nginx --port 80\n$ kubectl get svc nginx -o=jsonpath='{.spec.clusterIP}'\ndeployment.apps/nginx created\nservice/nginx exposed\n10.100.213.92%\n```\n\nProxy íŒŒë“œë¥¼ ë°°í¬í•œë‹¤. ì°¸ê³ í•  ì‚¬í•­ì€ `sysctler` ì»¨í…Œì´ë„ˆì¸ë°, ê¸°ë³¸ì ìœ¼ë¡œ `net.ipv4.ip_forward` í”Œë˜ê·¸ëŠ” `Kubelet`ì—ì„œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ê°€ ë˜ì–´ ìˆì§€ ì•Šìœ¼ë¯€ë¡œ ë‚´ë¶€ì—ì„œ IP Forwardingì„ ìœ„í•´ì„œ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤. \n\n```\napiVersion: v1\nkind: Pod\nmetadata:\n  name: proxy\nspec:\n  serviceAccountName: tailscale\n  initContainers:\n  - name: sysctler\n    image: busybox\n    securityContext:\n      privileged: true\n    command: [\"/bin/sh\"]\n    args:\n      - -c\n      - sysctl -w net.ipv4.ip_forward=1\n    resources:\n      requests:\n        cpu: 1m\n        memory: 1Mi\n  containers:\n  - name: tailscale\n    imagePullPolicy: Always\n    image: ddiiwoong/tailscale-k8s:latest\n    env:\n    - name: KUBE_SECRET\n      value: tailscale-auth\n    - name: USERSPACE\n      value: \"false\"\n    - name: AUTH_KEY\n      valueFrom:\n        secretKeyRef:\n          name: tailscale-auth\n          key: AUTH_KEY\n          optional: true\n    - name: DEST_IP\n      value: 10.100.213.92\n    securityContext:\n      capabilities:\n        add:\n        - NET_ADMIN\n```\n\n```\nkubectl get pod -n tailscale\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-6799fc88d8-5g49v   1/1     Running   0          5m59s\nproxy                    1/1     Running   0          22s\n```\n\nì •ìƒì ìœ¼ë¡œ ë°°í¬ëœ proxy ì»¨í…Œì´ë„ˆë¡œ ì ‘ì†í•´ë³´ë©´ ë™ì¼í•˜ê²Œ ì ‘ê·¼ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n\n```sh\n$ tailscale status\n100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -\n100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline\n100.95.209.95   proxy                ddiiwoong@   linux   idle, tx 788 rx 1452\n100.106.65.5    win11                ddiiwoong@   windows -\n\n$ curl https://proxy\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n...\n```\n\n### Subnet Router ëª¨ë“œ í…ŒìŠ¤íŠ¸\n\nTailscaleì—ì„œ Subnet Router ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ì „ì²´ í´ëŸ¬ìŠ¤í„°ì˜ subnet ëŒ€ì—­ìœ¼ë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤. \n\nê¸°ë³¸ì ìœ¼ë¡œ EKS APIëŠ” ì„œë¹„ìŠ¤ subnetìœ¼ë¡œ `10.100.0.0/16` ë˜ëŠ” `172.20.0.0/16` ì„ ì‚¬ìš©í•œë‹¤. ë°°í¬í•œ eksctlë¡œ êµ¬ì„±í•œ EKS í´ëŸ¬ìŠ¤í„° subnetì€ 3ê°œ AZì— 19bitë¡œ ë‚˜ë‰˜ì–´ ë°°í¬ë˜ì—ˆê³  `192.168.96.0/19`, `192.168.128.0/19`, `192.168.160.0/19`ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. \n\n```\n$ kubectl get node -o wide\nNAME                                                 STATUS   ROLES    AGE   VERSION               INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                CONTAINER-RUNTIME\nip-192-168-101-195.ap-northeast-2.compute.internal   Ready    <none>   23h   v1.21.5-eks-9017834   192.168.101.195   <none>        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7\nip-192-168-134-35.ap-northeast-2.compute.internal    Ready    <none>   23h   v1.21.5-eks-9017834   192.168.134.35    <none>        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7\nip-192-168-186-235.ap-northeast-2.compute.internal   Ready    <none>   23h   v1.21.5-eks-9017834   192.168.186.235   <none>        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7\n\n$ kubectl get pod -o wide\nNAME                     READY   STATUS    RESTARTS   AGE     IP                NODE                                                 NOMINATED NODE   READINESS GATES\nnginx-6799fc88d8-5g49v   1/1     Running   0          11m     192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   <none>           <none>\nproxy                    1/1     Running   0          5m39s   192.168.155.196   ip-192-168-134-35.ap-northeast-2.compute.internal    <none>           <none>\n\n$ kubectl get svc -o wide\nNAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR\nnginx   ClusterIP   10.100.213.92   <none>        80/TCP    11m   app=nginx\n```\n\ní•´ë‹¹ subnet ëŒ€ì—­ì„ ì ‘ì†í•˜ê¸° ìœ„í•´ì„œ ì„œë¹„ìŠ¤ ëŒ€ì—­ì¸ `10.100.0.0/16`ì™€ íŒŒë“œ ëŒ€ì—­ì¸ `192.168.96.0/19`, `192.168.128.0/19`, `192.168.160.0/19`ë¥¼ ì„¤ì •í•´ì„œ router ëª¨ë“œë¡œ tailscaleì„ ì‹¤í–‰í•˜ì.\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: subnet-router\n  labels:\n    app: tailscale\nspec:\n  serviceAccountName: tailscale\n  containers:\n  - name: tailscale\n    imagePullPolicy: Always\n    image: ddiiwoong/tailscale-k8s:latest\n    env:\n    - name: KUBE_SECRET\n      value: tailscale-auth\n    - name: USERSPACE\n      value: \"true\"\n    - name: AUTH_KEY\n      valueFrom:\n        secretKeyRef:\n          name: tailscale-auth\n          key: AUTH_KEY\n          optional: true\n    - name: ROUTES\n      value: 10.100.0.0/16,192.168.96.0/19,192.168.128.0/19,192.168.160.0/19\n    securityContext:\n      runAsUser: 1000\n      runAsGroup: 1000\n```\n\në°°í¬ëœ router ë””ë°”ì´ìŠ¤ì™€, ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ íŒŒë“œì™€ ì„œë¹„ìŠ¤ IPë¥¼ í™•ì¸í•œë‹¤.\n\n```sh\n$ tailscale status\n100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -\n100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline\n100.95.209.95   subnet-router        ddiiwoong@   linux   idle, tx 1556 rx 2908\n100.106.65.5    win11                ddiiwoong@   windows -\n\n$ kubectl get pod -n tailscale\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-6799fc88d8-5g49v   1/1     Running   0          39m\nsubnet-router            1/1     Running   0          9m47s\n\n$ kubectl get pod -n tailscale -o wide\nNAME                     READY   STATUS    RESTARTS   AGE   IP                NODE                                                 NOMINATED NODE   READINESS GATES\nnginx-6799fc88d8-5g49v   1/1     Running   0          39m   192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   <none>           <none>\nsubnet-router            1/1     Running   0          10m   192.168.137.188   ip-192-168-134-35.ap-northeast-2.compute.internal    <none>           <none>\n\n$ kubectl get svc -n tailscale\nNAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nnginx   ClusterIP   10.100.213.92   <none>        80/TCP    40m\n```\n\në°”ë¡œ ì ‘ì†ì„ í•´ë³´ë©´ ì ‘ì†ì´ ì•ˆëœë‹¤ëŠ”ê±¸ ì•Œìˆ˜ ìˆë‹¤. [tailscale ì„œë¹„ìŠ¤](https://login.tailscale.com/admin/machines)ë¡œ ì´ë™í•´ route ì„¤ì •ì—ì„œ ì ‘ê·¼í•  ëŒ€ì—­ì„ ì•„ë˜ì™€ ê°™ì´ í™œì„±í™”í•˜ê³  curlë¡œ ì ‘ì†í•´ë³´ë©´ ì •ìƒì ìœ¼ë¡œ ì ‘ê·¼ì´ ëœë‹¤ëŠ”ê±¸ ì•Œìˆ˜ ìˆë‹¤. ì´ê±¸ë¡œ ìƒê°í•´ë´¤ì„ ë•Œ `NetworkPolicy` ë“±ê³¼ í•¨ê»˜ ì„¤ì •ì„ í•˜ë©´ ë‚´ë¶€ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ í†µì œë„ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ìƒê°ëœë‹¤. \n\n![router](/img/subnetmode.png)\n\n```\n$ curl 192.168.112.183\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n...\n\n$ curl 10.100.213.92\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n...\n```\n\n## í™œìš©ë°©ì•ˆ\n\nê¸°ì¡´ì—ëŠ” ì§‘ ë‚´ë¶€ì— ìˆëŠ” ìì› NASë‚˜ macOS ë“±ì„ ì›ê²©ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ìš©ë„ì˜€ë‹¤ë©´, ì´ë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ê¸°ë³¸ Personal ë¬´ë£Œ Planìœ¼ë¡œë„ í™œìš©ê°€ëŠ¥í•œ ëª‡ê°€ì§€ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ìƒê°í•´ë´¤ë‹¤.  \n\n- ì¶”ê°€ì ì¸ VPN êµ¬ì„±ì—†ì´ ì›ê²©ì§€ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì— ì¡´ì¬í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë²„ê¹… ë° ê´€ë¦¬ ê°€ëŠ¥ (Telepresence ëŒ€ì²´)\n- sidecar ëª¨ë“œë¡œ í™œìš©ì‹œ Private ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì„œë¹„ìŠ¤ êµ¬ì„± ë° IPê´€ë¦¬ ë¶ˆí•„ìš” \n- Prometheus Service Discovryë¥¼ tailscaleë¡œ ì§„í–‰í•˜ì—¬ ê°œì¸ ê´€ë¦¬ ë””ë°”ì´ìŠ¤ ì „ì²´ ëª¨ë‹ˆí„°ë§\n- ëª¨ë°”ì¼ ì›¹ì•± í…ŒìŠ¤íŠ¸ì‹œ ë³¸ì¸ íœ´ëŒ€í°ìœ¼ë¡œ ì§ì ‘ ì•¡ì„¸ìŠ¤ ê°€ëŠ¥\n- í˜„ì¬ ê°œì¸ í”„ë¡œì íŠ¸ë¡œ í™œìš©ì¤‘ì¸ Plex(ë¯¸ë””ì–´ì„œë²„), ë…¸íŠ¸ ì•± ë“±ì„ ì„œë¹„ìŠ¤ êµ¬ì„±ì—†ì´ ACL ë° MFA ì ìš©ì„ í†µí•œ ë³´ì•ˆ ê°•í™”\n- wireguard í”„ë¡œí† ì½œì„ í™œìš©í•˜ê¸° ë•Œë¬¸ì— ì–´ë””ì„œë“  ëŠê¹€ì—†ì´ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ì ‘ê·¼\n- í˜„ì¬ êµ¬ì„±ì¤‘ì¸ site-to-site vpn ëŒ€ì²´ (OCI-OCIê°„)\n\në” ë§ì€ í™œìš©ë°©ì•ˆì´ ìˆì„í…ë° ì¼ë‹¨ ìƒê°ë‚˜ëŠ” ê²ƒë“¤ë§Œ ì ì–´ë³´ì•˜ë‹¤.\n\n## ì •ë¦¬\n\nì´ë²ˆ í¬ìŠ¤íŒ…ì€ ë„¤íŠ¸ì›Œí¬ ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•˜ë©´ì„œ ê³¼ì œë¡œ ì‘ì„±ëœ ë¶€ë¶„ì´ ì—†ì§€ ì•Šë‹¤. ì •ë§ ì´ë²ˆ ìŠ¤í„°ë””ëŠ” ì—­ëŒ€ê¸‰ìœ¼ë¡œ í€„ë¦¬í‹°ë‚˜ ì—¬ëŸ¬ê°€ì§€ë©´ì—ì„œ ì¢‹ì€ ì ì´ ë§ë‹¤. í•­ìƒ ëŒ€ë‹¨í•˜ë‹¤ê³  ëŠë¼ëŠ” ë¶„ë“¤ê³¼ í•¨ê»˜í•˜ê³  ìˆì–´ì„œ ë§ˆì§€ë§‰ê¹Œì§€ ì™„ì£¼í•  ìˆ˜ ìˆë„ë¡ ì¡°ê¸ˆ ë” ê³µë¶€í•´ì•¼ ê² ë‹¤ëŠ” ìƒê°ì´ ë“ ë‹¤. ë‹¤ì‹œí•œë²ˆ [ê°€ì‹œë‹¤](https://www.facebook.com/jongho.seo.5811)ë‹˜ì„ `shout-out` í•˜ê³  2022ë…„ ì²« í¬ìŠ¤íŒ…ì€ ì´ê²ƒìœ¼ë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.\n\n> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤."
    },
    {
      "id": "/prometheus/synology-prometheus/",
      "metadata": {
        "permalink": "/prometheus/synology-prometheus/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2021-06-11-synology-prometheus.md",
        "source": "@site/blog/2021-06-11-synology-prometheus.md",
        "title": "Synology monitoring with Prometheus and snmp exporter",
        "description": "Prometheusë¡œ ì‹œë†€ë¡œì§€ NAS Monitoringí•˜ëŠ” ë°©ë²• ì •ë¦¬",
        "date": "2021-06-11T00:00:00.000Z",
        "formattedDate": "June 11, 2021",
        "tags": [
          {
            "label": "Prometheus, Synology, ì‹œë†€ë¡œì§€",
            "permalink": "/tags/prometheus-synology-ì‹œë†€ë¡œì§€"
          }
        ],
        "readingTime": 11.165,
        "truncated": true,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Synology monitoring with Prometheus and snmp exporter",
          "comments": true,
          "classes": "wide",
          "description": "Prometheusë¡œ ì‹œë†€ë¡œì§€ NAS Monitoringí•˜ëŠ” ë°©ë²• ì •ë¦¬",
          "slug": "/prometheus/synology-prometheus/",
          "date": "2021-06-11T00:00:00.000Z",
          "categories": [
            "prometheus"
          ],
          "tags": [
            "Prometheus, Synology, ì‹œë†€ë¡œì§€"
          ]
        },
        "prevItem": {
          "title": "What is Tailscale?",
          "permalink": "/kubernetes/what-is-tailscale/"
        },
        "nextItem": {
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (2/2)",
          "permalink": "/kubernetes/vSphere-with-Tanzu-homelab-2/"
        }
      },
      "content": "ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì•„ì¬ë¼ë©´ ë‹¤ë“¤ í•˜ë‚˜ì”© êµ¬ë¹„í•˜ê³  ìˆì„ ì‹œë†€ë¡œì§€(Synology) NASë¥¼ Prometheusì™€ snmp_exporterë¥¼ í™œìš©í•´ì„œ ëª¨ë‹ˆí„°ë§ í•˜ëŠ” ë°©ë²•ì„ ì •ë¦¬í•œë‹¤.\n\n<!--truncate-->\n\n## êµ¬ì„±ë°©ì•ˆ\n\nì´ 5ê°œì˜ êµ¬ì„±ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒì„ êµ¬ì„±í•˜ë ¤ê³  í•œë‹¤.  \n\nêµ¬ì„±ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ë‹¤. ëª¨ë“  êµ¬ì„±ìš”ì†ŒëŠ” ì‹œë†€ë¡œì§€ë‚´ ë„ì»¤ ì»¨í…Œì´ë„ˆë¡œ êµ¬ì„±ë  ì˜ˆì •ì´ë‹¤.\n\n- Prometheus : ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥ì„ ë‹´ë‹¹í•˜ëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤\n- Alertmanager : Prometheusì—ì„œ ë°œìƒëœ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì „ë‹¬\n- Node Exporter : Linux Nodeì˜ ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë¥¼ Expose\n- SNMP Exporter : SNMP ê¸°ë°˜ ë””ë°”ì´ìŠ¤ì˜ ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë¥¼ Expose\n- Grafana : ì‹œê°í™” ë„êµ¬\n\n![arch](/img/synology/arch.png)  \n\n\n## ì‹œë†€ë¡œì§€ ëª¨ë‹ˆí„°ë§\n\nê¸°ë³¸ì ìœ¼ë¡œ ì‹œë†€ë¡œì§€ UIì—ì„œë„ ê´€ë ¨ëœ ë°ì´í„°ë“¤ì„ í™•ì¸í• ìˆ˜ ìˆê³  ë””ìŠ¤í¬ ì˜¤ë¥˜ë‚˜ ì „ì› ë“± íŠ¹ë³„í•œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ê²½ìš°ëŠ” ë³„ë„ë¡œ ì´ë©”ì¼ì´ë‚˜ ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì§€ë§Œ ë©”íŠ¸ë¦­ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” íŠ¹ì • ìƒí™©ì—ì„œ ì•Œë¦¼ì„ ë°›ê±°ë‚˜ ë‚´ê°€ ì›í•˜ëŠ” ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œë¥¼ ê¾¸ë¯¸ê¸° ìœ„í•œ ìš©ìœ¼ë¡œ ì‹œë†€ë¡œì§€ëŠ” SNMPê¸°ë°˜ì˜ ëª¨ë‹ˆí„°ë§ì„ ì œê³µí•œë‹¤. ë‹¤ë¥¸ NMS ë˜ëŠ” ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“±ì„ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” ì—…ë¬´ì™€ ê´€ë ¨ìˆëŠ” ì‹¤ì œ SNMP exporterë¥¼ êµ¬ì„±í•´ë³´ê³  í”„ë¡œë©”í…Œìš°ìŠ¤ì™€ ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œë¥¼ í†µí•´ ëª¨ë‹ˆí„°ë§ì„ í•˜ëŠ”ë° ëª©ì ì´ ìˆë‹¤.\n\n## ì‹œë†€ë¡œì§€ ì„¤ì •\n\n### ì‚¬ì „ ìš”êµ¬ì‚¬í•­\n- [ì‹œë†€ë¡œì§€ Docker](https://www.synology.com/en-global/dsm/packages/Docker)\n- SSH í—ˆìš©\n- Admin ê¶Œí•œ\n- SNMP ì„¤ì •\n\nSNMP ì„¤ì •ì„ ì œì™¸í•œ 3ê°€ì§€ êµ¬ì„±ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë˜ì–´ìˆë‹¤ ê°€ì •í•˜ê³  ì§„í–‰í•œë‹¤.  \n\nì‹œë†€ë¡œì§€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ SNMP ì„¤ì •ì´ ë¹„í™œì„±í™” ìƒíƒœì´ê¸° ë•Œë¬¸ì— ë³€ê²½ì´ í•„ìš”í•˜ë‹¤. ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì‹œë†€ë¡œì§€ì˜ ì œì–´íŒ - í„°ë¯¸ë„ ë° SNMP - SNMPíƒ­ ìœ¼ë¡œ ì´ë™í•´ì„œ SNMP ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”ë¥¼ ì²´í¬í•˜ê³  ì´í›„ snmp exporter ì„¤ì •ì—ì„œ ì‚¬ìš©ë  communityê°’ì„ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë³€ê²½í•œ í›„ ì €ì¥í•œë‹¤.  \n\n![snmp](/img/synology/snmp.png)\n\nê·¸ëŸ¼ ì´ì œ ì‹œë†€ë¡œì§€ëŠ” ì™¸ë¶€ í†µì‹ ì„ ìœ„í•œ Portì¸ UDP 161 portë¡œ snmpdì„ ì‹¤í–‰í•˜ê²Œ ëœë‹¤. \n\n```sh\nroot@DSM2:~# netstat -unlp | grep 161\nudp        0      0 0.0.0.0:161             0.0.0.0:*                           9437/snmpd\nudp6       0      0 :::161                  :::*                                9437/snmpd\n```\n\n## SNMP Exporter\n\n[https://github.com/prometheus/snmp_exporter](https://github.com/prometheus/snmp_exporter)\n\nSNMP ExporterëŠ” í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ìˆ˜ì§‘í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ SNMP ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ Expose í• ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì „í†µì ì¸ ëª¨ë‹ˆí„°ë§ ë„êµ¬ì™€ ë§ˆì°¬ê°€ì§€ë¡œ MIBë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤. ë ˆí¬ì§€í† ë¦¬ ì»¨ì…‰ì—ë„ ì„¤ëª…ì´ ì í˜€ìˆë“¯ì´ SNMP ë°ì´í„°ëŠ” ê³„ì¸µí˜• ë°ì´í„° êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆê³  í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” ë‹¤ì°¨ì› ë§¤íŠ¸ë¦­ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë‘ ì‹œìŠ¤í…œì€ ì˜ ë§ëŠ”ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.\n\nSNMP ë°ì´í„° êµ¬ì¡°ë¥¼ ì—¬ê¸°ì„œ ìì„¸íˆ ì„¤ëª…í•˜ì§€ëŠ” ì•Šê² ì§€ë§Œ  SNMP indexì™€ labelì„ ë§¤í•‘í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•œë‹¤. ë‹¤ë¥¸ ìµìŠ¤í¬í„°ì™€ ë™ì¼í•˜ê²Œ daemon í˜•íƒœë¡œ ì‹¤í–‰ì´ ë˜ê³  `http://localhost:9116/snmp?module=if_mib&target=1.2.3.4` ì™€ ê°™ì´ moduleê³¼ targetì„ ì„¤ì •í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ì„ í•  ìˆ˜ ìˆë‹¤.\n\nê¸°ë³¸ config íŒŒì¼ì„ `snmp.yml`ì„ ì°¸ì¡°í•˜ê²Œ ë˜ëŠ”ë° ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ generatorë¥¼ í†µí•´ ìƒì„±í•˜ê²Œ ëœë‹¤.  \n[https://github.com/prometheus/snmp_exporter/tree/main/generator](https://github.com/prometheus/snmp_exporter/tree/main/generator)\n\ní•´ë‹¹ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯ì´ generatorì—ì„œ ë²¤ë”ë³„ MIB íŒŒì¼ê³¼ generator.ymlë¥¼ ì°¸ì¡°í•´ì„œ ë¹Œë“œ, ì‹¤í–‰í•˜ê³  ê²°ê³¼ê°’ìœ¼ë¡œ snmp.ymlì´ ìƒì„±ë˜ê²Œ ëœë‹¤. ë”°ë¡œ ë§Œë“¤ì–´ë„ ë˜ì§€ë§Œ ì‹œë†€ë¡œì§€ì—ë§Œ í•´ë‹¹ íŒŒì¼ì„ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘ì‹  ë¶„ì´ ê³„ì…”ì„œ [tumak](https://grafana.com/orgs/tumak)ì˜ ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œë¥¼ ì°¸ì¡°í•˜ì˜€ë‹¤. ê·¸ë¦¬ê³  ì´í›„ ì‹œë†€ë¡œì§€ ëŒ€ì‹œë³´ë“œë¡œë„ ì‚¬ìš©í•  ì˜ˆì •ì´ë‹¤.  \n\n[https://grafana.com/grafana/dashboards/14284](https://grafana.com/grafana/dashboards/14284)\n\në§Œë“¤ì–´ì§„ `snmp.yml`ì—ì„œ ë³€ê²½í•´ì•¼ í•  ë¶€ë¶„ì€ í˜„ì¬ ì‹œë†€ë¡œì§€ì—ì„œ ì„¤ì •ëœ SNMP community ì„¤ì •ì´ë‹¤. snmp.yml ë§¨ ì•„ë˜ community ê°’ì„ ì‹œë†€ë¡œì§€ì— ì„¤ì •í•œ ê°’ê³¼ ì¼ì¹˜í•˜ê²Œ ë³€ê²½í•œë‹¤.  \n\n```yaml\n  auth:\n    community: synology\n```\n\n## Prometheus, Alertmanager, Exporter, Grafana êµ¬ì„±\n\nê°„ë‹¨í•œ ì•„í‚¤í…ì²˜ êµ¬ì„±ë„ë¡œ ì‹œë†€ë¡œì§€ ìì²´ ë˜ëŠ” OSê¸°ë°˜ì—ì„œ ë°œìƒí•˜ëŠ” ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ê°ê°ì˜ Exporterë¥¼ êµ¬ì„±í•˜ê³  í•´ë‹¹ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” Prometheus ì„œë²„ì™€ ê´€ë ¨ ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ëŠ” Grafanaê¹Œì§€ í•œë²ˆì— êµ¬ì„±í•˜ê¸° ìœ„í•´ Docker-composeë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì´ë‹¤.  \n\nDocker Compose íŒŒì¼ì„ ë§¨ ì•„ë˜ snmp exporter ë¶€í„° í•˜ë‚˜ì”© ìª¼ê°œì„œ ì‚´í´ë³´ì.  \n\nSNMP ExporterëŠ” ìœ„ì—ì„œ ë§Œë“  snmp.yml íŒŒì¼ì„ ë§ˆìš´íŠ¸í•´ì„œ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤. ê·¸ëŸ¬ë©´ SNMP exporterê°€ ì‹¤í–‰ë˜ë©´ì„œ snmpíŒŒì¼ì„ ì°¸ì¡°í•´ì„œ ì‹¤í–‰ì´ ë˜ê³  prometheus.yamlì—ì„œ ì •ì˜í•œ targetê³¼ SNMP í”„ë¡œí† ì½œì„ í†µí•´ ê´€ë ¨ëœ ë©”íŠ¸ë¦­ ê°’ì„ ìˆ˜ì§‘í•´ì„œ Exposeí•˜ê²Œ ë  ê²ƒì´ë‹¤.  \n\n```yaml\n  snmp-exporter:\n    image: prom/snmp-exporter\n    container_name: snmp_exporter\n    volumes:\n      - ./snmp_exporter/:/etc/snmp_exporter/\n    ports:\n      - 9116:9116\n    volumes:\n      - ./snmp-synology/snmp.yml:/etc/snmp_exporter/snmp.yml\n    command:\n      - \"--config.file=/etc/snmp_exporter/snmp.yml\"\n```\n\në‹¤ìŒì€ Node Exporterë¥¼ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ ì‹œìŠ¤í…œì— ê´€ë ¨ëœ ê¶Œí•œì´ í•„ìš”í•˜ë¯€ë¡œ `/proc, /sys, /` ë“± íŒŒì¼ì‹œìŠ¤í…œì˜ read only ê¶Œí•œê³¼ `privileged: true` ì„¤ì •ì„ í†µí•´ ì‹¤í–‰ë˜ê²Œ ë  ê²ƒì´ë‹¤.\n\n```yaml\n  node-exporter:\n    privileged: true\n    image: prom/node-exporter\n    container_name: node-exporter\n    restart: always\n    ports:\n      - \"9100:9100\"\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n    command:\n      - \"--path.procfs=/host/proc\"\n      - \"--path.sysfs=/host/sys\"\n      - \"--collector.filesystem.ignored-mount-points\"\n      - \"^/(rootfs/)?(dev|etc|host|proc|run|sys|volume1)($$|/)\"\n```\n\në‹¤ìŒì€ ì‹œê°í™”ì™€ ì•Œë¦¼ì„ ë‹´ë‹¹í•  Grafanaì™€ Alertmanager ë¶€ë¶„ìœ¼ë¡œ Alertmanagerì˜ ê²½ìš° ê¸°ë³¸ì ì¸ configë¥¼ ë§ˆìš´íŠ¸í•´ì„œ ì‹¤í–‰ì„ í•  ì˜ˆì •ì´ë‹¤.\n\n```yaml\n  grafana:\n    container_name: grafana\n    image: grafana/grafana\n    ports:\n      - \"3000:3000\"\n    depends_on:\n      - prometheus\n\n  alertmanager:\n    container_name: alertmanager\n    image: prom/alertmanager:v0.21.0\n    ports:\n      - 9093:9093\n    volumes:\n      - ./config/alertmanager.yml:/etc/alertmanager/alertmanager.yml\n    restart: always\n```\n\në§ˆì§€ë§‰ìœ¼ë¡œ, PrometheusëŠ” ì•Œë¦¼ë£°ì„ ìƒì„±í•˜ê¸° ìœ„í•´ì„œ ë³„ë„ë¡œ rules ë””ë ‰í† ë¦¬ì™€ ë¯¸ë¦¬ ìƒì„±í•´ë‘” configë¥¼ mount ì‹œí‚¨ë‹¤.  \n\n```yaml\nversion: \"3.8\"\nservices:\n  prometheus:\n    container_name: prometheus\n    image: quay.io/prometheus/prometheus:v2.26.0\n    volumes:\n      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml\n      - ./rules:/etc/prometheus/rules\n    command: \"--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus\"\n    ports:\n      - 9090:9090\n```\n\nprometheus.yml configë¥¼ ì‚´í´ë³´ë©´ ìˆ˜ì§‘ì£¼ê¸°ëŠ” 1ë¶„ìœ¼ë¡œ, ë‚˜ë¨¸ì§€ ì–¼ëŸ¿ë§¤ë‹ˆì €ì™€ ìˆ˜ì§‘í•  ëŒ€ìƒì¸ exporterë“¤ì˜ target endpointë¥¼ ì¶”ê°€í•˜ì—¬ ì‹¤í–‰í•  ì˜ˆì •ì´ë‹¤. ì—¬ê¸°ì„œëŠ” ì‹œë†€ë¡œì§€ SNMP ì„œë¹„ìŠ¤ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ SNMP Exporterì˜ targetì„ ì‹¤ì œ ì‚¬ìš©ì¤‘ì¸ ì‹œë†€ë¡œì§€ IPë¥¼ ë“±ë¡í•˜ë„ë¡ í•œë‹¤.  \n\n```yaml\nglobal:\n  scrape_interval:     1m\n  evaluation_interval: 1m\n\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets: ['alertmanager:9093']\n\nrule_files:\n  - \"/etc/prometheus/rules/*\"\n\nscrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n        labels:\n          group: 'prometheus'\n  - job_name: node\n    static_configs:\n    - targets: ['node-exporter:9100']\n  - job_name: 'snmp-exporter'\n    static_configs:\n    - targets: ['192.168.0.100']\n    metrics_path: /snmp\n    params:\n      module: [synology]\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 192.168.0.100:9116  # The SNMP exporter's real synology hostname:port. \n```\n\n## Stack ì‹¤í–‰\n\nëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ë©´ ì¼ë‹¨ ê¸°ë³¸ì ì¸ ì‹¤í–‰ì´ ê°€ëŠ¥í•œ ìƒíƒœë¡œ ì‹œë†€ë¡œì§€ CLIë¥¼ ì‹¤í–‰í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì‹œë†€ë¡œì§€ëŠ” adminê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì„œ sudo ê¶Œí•œì„ í†µí•´ Docker Compose ì‹¤í–‰ì„ í•´ì•¼ í•œë‹¤.  \n\n```sh\nssh admin@192.168.31.7\nsudo -i\n```\n\n[https://github.com/ddiiwoong/synology-prometheus.git](https://github.com/ddiiwoong/synology-prometheus.git)ì„ cloneí•´ì„œ /snmp-synology/snmp.yml íŒŒì¼ì˜ community ê°’ì„ ë³¸ì¸ì˜ synology ê°’ìœ¼ë¡œ ë³€ê²½í•œ í›„ Docker Composeë¥¼ ë°ëª¬í˜•íƒœë¡œ ì‹¤í–‰í•œë‹¤.  \n\n```sh\ndocker-compose up -d\n```\n\në³¸ì¸ì˜ `http://<ì‹œë†€ë¡œì§€ IP>:9090/targets` ìœ¼ë¡œ ì ‘ì†í•´ì„œ 3ê°œì˜ targetì´ ì •ìƒì¸ì§€ í™•ì¸í•œë‹¤. ê·¸ë¦¬ê³  í‘œí˜„ì‹ ë¸Œë¼ìš°ì €ë¡œ ëŒì•„ì™€ì„œ `node_cpu_seconds_total` ê³¼ `diskModel`ì„ í†µí•´ ë‘ê°œì˜ exporterì—ì„œ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `diskModel`ì€ ì‹œë†€ë¡œì§€ì— ì¥ì°©ëœ í•˜ë“œë””ìŠ¤í¬ ëª¨ë¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” ë©”íŠ¸ë¦­ì´ë‹¤.  \n\n![diskmodel](/img/synology/diskmodel.png)\n\nê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œëŠ” `http://<ì‹œë†€ë¡œì§€ IP>:3000` ë¡œ ì ‘ì†í•´ì„œ ì´ˆê¸° ê³„ì •ì¸ `admin:admin`ì„ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ê¸°ë³¸ í™”ë©´ì„ ë³¼ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì„œ ì¢Œì¸¡ì˜ ê¸°ì–´ëª¨ì–‘ ë©”ë‰´(Configuration)ì˜ `Data Sources`ë¥¼ í´ë¦­í•˜ê³  í”„ë¡œë©”í…Œìš°ìŠ¤ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë“±ë¡í•œë‹¤.  \n\nDocker Composeë¡œ ì‹¤í–‰í•  ë•Œ ì•„ë˜ì™€ ê°™ì´ `prometheus` ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰í–ˆê¸° ë•Œë¬¸ì— HTTP URLì— `prometheus:9090`ì„ ì…ë ¥í•˜ê³  `Save & Test`ë¡œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì €ì¥í•œë‹¤.  \n\n![grafana](/img/synology/grafana.png)\n\n## ì‹œë†€ë¡œì§€ ëŒ€ì‹œë³´ë“œ êµ¬ì„±\n\në§ˆì§€ë§‰ìœ¼ë¡œ [https://grafana.com/grafana/dashboards/14284](https://grafana.com/grafana/dashboards/14284)ì˜ ëŒ€ì‹œë³´ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•œë‹¤.  \n\nì¢Œì¸¡ì˜ + ë©”ë‰´(Create)ì˜ `Import`ë¥¼ í´ë¦­í•˜ê³  ìœ„ ëŒ€ì‹œë³´ë“œ ID `14284`ë¥¼ ì…ë ¥í•˜ê³  ë“±ë¡í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì‹œë†€ë¡œì§€ì˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n![synology](/img/synology/synology.png)\n\n## ì •ë¦¬\n\nê°„ë‹¨(?)í•˜ê²Œ ì‹œë†€ë¡œì§€ ë‚˜ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì •ë¦¬í•´ë´¤ë‹¤. ëˆ„êµ°ê°€ì—ê²ŒëŠ” ì¬ë¯¸ë¡œ ëˆ„êµ°ê°€ì—ê²ŒëŠ” ë„ì›€ì´ ë˜ê¸¸ ë°”ë¼ë©°, í¬ìŠ¤íŒ…ê³¼ ê´€ë ¨ëœ ëª¨ë“ ê²ƒì€ ê°œì¸ ì·¨ë¯¸ë¡œ ì‘ì„±ëœ ë‚´ìš©ìœ¼ë¡œ íšŒì‚¬ë‚˜ ë‚˜ìŠ¤ì™€ ê´€ë ¨ëœ ì œí’ˆê³¼ ê´€ê³„ê°€ ì—†ìŒì„ ì•Œë¦°ë‹¤."
    },
    {
      "id": "kubernetes/vSphere-with-Tanzu-homelab-2/",
      "metadata": {
        "permalink": "/kubernetes/vSphere-with-Tanzu-homelab-2/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2020-12-06-vSphere-with-Tanzu-homelab-2.md",
        "source": "@site/blog/2020-12-06-vSphere-with-Tanzu-homelab-2.md",
        "title": "vSphere with Tanzu homelab running on ASUS PN50 (2/2)",
        "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Tanzu Clusterë¥¼ ë‹¨ì¼ í™ˆë© vSphere ì„œë²„ì— ì˜¬ë ¤ë³¸ë‹¤",
        "date": "2020-12-06T00:00:00.000Z",
        "formattedDate": "December 6, 2020",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Tanzu",
            "permalink": "/tags/tanzu"
          },
          {
            "label": "vSphere",
            "permalink": "/tags/v-sphere"
          },
          {
            "label": "Homelab",
            "permalink": "/tags/homelab"
          },
          {
            "label": "ASUS",
            "permalink": "/tags/asus"
          },
          {
            "label": "PN50",
            "permalink": "/tags/pn-50"
          }
        ],
        "readingTime": 17.815,
        "truncated": true,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (2/2)",
          "comments": true,
          "classes": "wide",
          "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Tanzu Clusterë¥¼ ë‹¨ì¼ í™ˆë© vSphere ì„œë²„ì— ì˜¬ë ¤ë³¸ë‹¤",
          "slug": "kubernetes/vSphere-with-Tanzu-homelab-2/",
          "date": "2020-12-06T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "Tanzu",
            "vSphere",
            "Homelab",
            "ASUS",
            "PN50"
          ]
        },
        "prevItem": {
          "title": "Synology monitoring with Prometheus and snmp exporter",
          "permalink": "/prometheus/synology-prometheus/"
        },
        "nextItem": {
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (1/2)",
          "permalink": "/kubernetes/vSphere-with-Tanzu-homelab/"
        }
      },
      "content": "ì§€ë‚œê¸€ì— ì´ì–´ ì´ë²ˆì—ëŠ” ë„¤íŠ¸ì›Œí¬ êµ¬ì„±í•˜ëŠ” ë°©ë²•ê³¼ vSphere Clusterì— ì¶”ê°€ì ì¸ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ëŠ” ê²ƒì— ëŒ€í•´ ì´ì•¼ê¸° í•˜ê³ ì í•œë‹¤. ì´ë²ˆ ê¸€ë„ ì§€ë‚œê¸€ê³¼ ë™ì¼í•˜ê²Œ [virtuallyGhetto](https://www.virtuallyghetto.com/) ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì—¬ ê·¸ëŒ€ë¡œ ì§„í–‰í•œ ë‚´ìš©ì´ë¼ê³  ë³´ë©´ ëœë‹¤.\n\n[https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html](https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html)\n\nì§€ë‚œ í¬ìŠ¤íŒ…ì€ ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n> ì´ì „ê¸€ - [vSphere with Tanzu homelab running on ASUS PN50 (1/2)](https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab/)\n\n<!--truncate-->\n\n\n![vcsa](/img/vcsa.png)\n\n## VDS(vSphere Distributed Switch) êµ¬ì„±\n\nì´ë²ˆ êµ¬ì„±ì˜ ê²½ìš°ì—ëŠ” usb nicë¥¼ í•˜ë‚˜ë§Œì„ ì‚¬ìš©í•´ì„œ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ìœ„ì—ì„œ ì„¤ì •í–ˆë˜ 3ê°œì˜ ë„¤íŠ¸ì›Œí¬(Management, Frontend, Workload)ë¡œ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ VDSë¥¼ ì‹ ê·œë¡œ ìƒì„±í•˜ê³  ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ì–´ëŒ‘í„°ë¥¼ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤.  \n\në¨¼ì € ì‹ ê·œ êµ¬ì„±í•œ vCenter UI([https://vcsa.tanzu.local/ui](https://vcsa.tanzu.local/ui))ë¡œ ì ‘ì†í•´ `Networking` ë©”ë‰´ë¡œ ì´ë™í•´ì„œ `VDS` ë©”ë‰´ ìš°í´ë¦­ í›„ `Add and Manage Hosts`ë¥¼ ì„ íƒí•œë‹¤. \n\n![network](/img/vcsa_network_menu.png)\n\nVDS ì„¤ì •í•˜ëŠ” 6ë‹¨ê³„ë¥¼ ì§„í–‰í•œë‹¤. \n\n* 1ë‹¨ê³„ -  `Add hosts`ë¥¼ ì„ íƒí•œë‹¤.\n* 2ë‹¨ê³„ - ESXi hostë¥¼ ì„ íƒí•œë‹¤. \n* 3ë‹¨ê³„ - pyhysical adapterë¥¼ ìƒì„±í•œ í›„ì— ì„ íƒí•˜ê²Œ ë˜ëŠ”ë° êµ¬ì„±í•œ ë©ì—ì„œëŠ” USB TYPE NICë¥¼ ì‚¬ìš©í•˜ì—¬ `vusb0` ì–´ëŒ‘í„°ë¥¼ ì„ íƒí•˜ê³  `Assign uplink`ì—ì„œ `dvUplink1`ë¥¼ Assigní•œë‹¤.\n* 4ë‹¨ê³„ - VMkernel adapterì—ì„œ vmk0ì„ ì„ íƒí•˜ê³  `Assign port group`ì—ì„œ Networkë¥¼ Managementë¥¼ Assigní•œë‹¤.\n* 5ë‹¨ê³„ - VM Migrationì€ ìƒëµí•œë‹¤.\n* 6ë‹¨ê³„ - ì„¤ì •ë˜ëŠ” ë‚´ìš©ì„ í™•ì¸í•˜ê³  Finishë¥¼ í•˜ê²Œ ë˜ë©´ ê¸°ì¡´ VCSAì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ê°€ `vSwitch`ì—ì„œ `VDS`ë¡œ ë³€ê²½ë˜ì—ˆê¸° ë•Œë¬¸ì— VSCA Client ì ‘ì†ì´ ëŠì–´ì§€ê²Œ ëœë‹¤. \n\në‹¤ì‹œ ESXi Clientë¡œ ì ‘ì†í•´ì„œ VCSA Port Group(ë„¤íŠ¸ì›Œí¬)ì„ ì•„ë˜ì™€ ê°™ì´ ê¸°ì¡´ `VM Network`ì—ì„œ `Management`ë¡œ ë³€ê²½í•˜ë©´ ë‹¤ì‹œ VSCA Clientë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ê²Œ ëœë‹¤.\n\n![network_adapter](/img/vcsa_network.png)\n\n## RouterVMì˜ Network Port Group ì¶”ê°€(Frontend, Workload)\n\nì´ì „ í¬ìŠ¤íŒ…ì—ì„œ ìƒì„±í•œ Router VMì€ êµ¬ì„±í•  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬(10.10.0.0/24 & 10.20.0.0/24)ë¡œì˜ ë¼ìš°íŒ…ê³¼ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ë¡œ NAT ë° í¬ì›Œë”©ì„ ìœ„í•´ì„œ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— vSphere ë˜ëŠ” VCSA Clientì—ì„œ `router.tanzu.local`ì˜ ë„¤íŠ¸ì›Œí¬ ì–´ëŒ‘í„°ë¥¼ `Frontend`, `Workload`ë¡œ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.\n\n![routervm](/img/routervm.png)\n\nêµ¬ì„±ì„ ì™„ë£Œí•œ í›„ì— ê°„ë‹¨í•œ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ì„ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.  \n\n![vswitch](/img/vswitch.png)\n\në¬¼ë¦¬ ì¸í„°í˜ì´ìŠ¤ `vusb0` ì•„ë˜ ê°€ìƒ ìŠ¤ìœ„ì¹˜ê°€ 3ê°œ êµ¬ì„±ë˜ì–´ ìˆê³  ì™¸ë¶€ì—ì„œë„ RouterVMì„ í†µí•´ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë„ë¡ ì ‘ì†í•˜ëŠ” ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ë¼ìš°íŒ… ê²½ë¡œ ì¶”ê°€ê°€ í•„ìš”í•˜ë‹¤.\n\n* Windows  \n  `route print` ëª…ë ¹ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ IDë¥¼ ë¨¼ì € í™•ì¸í•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•œë‹¤.\n\n  ```powershell\n  route ADD 10.10.0.0 MASK 255.255.255.0 192.168.0.201 METRIC 3 IF 5\n  route ADD 10.20.0.0 MASK 255.255.255.0 192.168.0.201 METRIC 3 IF 5\n  ```\n\n* MacOS\n  ```sh\n  sudo route -n add -net 10.10.0.0/24 192.168.0.201\n  sudo route -n add -net 10.20.0.0/24 192.168.0.201\n  ```\n\n* WSL\n  ```sh\n  sudo route -n add -net 10.10.0.0/24 gw <Gateway IP>\n  sudo route -n add -net 10.20.0.0/24 gw <Gateway IP>\n  ```\n\n## HAProxyVM ì„¤ì •\n\nì´ì „ í¬ìŠ¤íŒ…ì—ì„œ ìƒì„±í•œ HAProxyë„ ì¶”ê°€ëœ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ìœ¼ë¡œ ì„¤ì •ì„ í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤.   \n\n* [https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/deploy_3nic_haproxy.ps1](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/deploy_3nic_haproxy.ps1)\n\nêµ¬ì„±í•œ í™˜ê²½ì— ë§ê²Œ ìŠ¤í¬ë¦½íŠ¸ë‚´ ë³€ìˆ˜ë“¤ì„ ìˆ˜ì •í•œ í›„ ì‹¤í–‰í•œë‹¤.\n\n```powershell\n$HAProxyOVA = \"C:\\esxi\\vmware-haproxy-v0.1.8.ova\"\n\n$Cluster = \"Tanzu-Cluster\"\n$VMHost = \"esxi-01.tanzu.local\"\n$Datastore = \"datastore1\"\n\n$HAProxyDisplayName = \"haproxy.tanzu.local\"\n$HAProxyHostname = \"haproxy.tanzu.local\"\n$HAProxyDNS = \"192.168.0.201\"\n$HAProxyManagementNetwork = \"Management\"\n$HAProxyManagementIPAddress = \"192.168.0.203/24\" # Format is IP Address/CIDR Prefix\n$HAProxyManagementGateway = \"192.168.0.1\"\n$HAProxyFrontendNetwork = \"Frontend\"\n$HAProxyFrontendIPAddress = \"10.10.0.2/24\" # Format is IP Address/CIDR Prefix\n$HAProxyFrontendGateway = \"10.10.0.1\"\n$HAProxyWorkloadNetwork = \"Workload\"\n$HAProxyWorkloadIPAddress = \"10.20.0.2/24\" # Format is IP Address/CIDR Prefix\n$HAProxyWorkloadGateway = \"10.20.0.1\"\n$HAProxyLoadBalanceIPRange = \"10.10.0.64/26\" # Format is Network CIDR Notation\n$HAProxyOSPassword = \"VMware1!\"\n$HAProxyPort = \"5556\"\n$HAProxyUsername = \"wcp\"\n$HAProxyPassword = \"VMware1!\"\n...\n```\n\n```powershell\n./deploy_3nic_haproxy.ps1\n```\n\nì´í›„ HAProxy VMë‚´ì—ì„œ ì—¬ëŸ¬ ì¸í„°í˜ì´ìŠ¤ì—ì„œ `Reverse Path Filtering`ì„ `Disable`í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤. \n\n*[setup_haproxy.sh](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_haproxy.sh)  \n\n```sh\n#!/bin/bash\n\ntouch /etc/sysctl.d/999-tanzu.conf\nchmod +x /etc/sysctl.d/999-tanzu.conf\n\nIFS=$'\\n'\nfor i in $(sysctl -a | grep rp_filter | grep 1);\ndo\n    SYSCTL_SETTING=$(echo ${i} | awk '{print $1}')\n    # Update live system\n    sysctl -w ${SYSCTL_SETTING}=0\n    # Persist settings upon reboot\n    echo \"${SYSCTL_SETTING}=0\" >> /etc/sysctl.d/999-tanzu.conf\ndone\n```\n\n> `Reverse Path Filtering`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì—¬ëŸ¬ê°œì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ì˜ ì†ŒìŠ¤IPì— ëŒ€í•´ì„œ ë¼ìš°íŒ… í…Œì´ë¸”ì„ í™•ì¸í•œ í›„ íŒ¨í‚·ì´ ë“¤ì–´ì˜¨ ë™ì¼í•œ ì¸í„°í˜ì´ìŠ¤ë¡œ ë‹¤ì‹œ ë‚˜ê°€ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤. `rp_filter`ê°€ 1ë¡œ ì„¤ì •ì´ ë˜ì–´ìˆìœ¼ë©´, íŠ¹ì • ì¸í„°í˜ì´ìŠ¤ë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚· ì •ë³´ì™€ OSì˜ FIB(Forward Information Base)ì— ì •ì˜ëœ ì •ë³´ì™€ ì¼ì¹˜í•˜ì§€ ì•Šì„ê²½ìš°, ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ ë²„ë¦¬ëŠ” ê¸°ëŠ¥ì„ í•˜ê¸° ë•Œë¬¸ì— ìœ„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ rp_filter ê°’ì„ ëª¨ë‘ 0ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì´ë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [https://access.redhat.com/solutions/53031](https://access.redhat.com/solutions/53031)ë¥¼ ì°¸ê³ í•˜ì.\n\n## Content Library êµ¬ì„±\n\n`Content Library`ëŠ” ë ˆí¬ì§€í† ë¦¬ì˜ ê°œë…ìœ¼ë¡œ ì—¬ëŸ¬ vApp í…œí”Œë¦¿ê³¼ ISO ì´ë¯¸ì§€ ë“±ê³¼ ê°™ì€ íŒŒì¼ë“¤ê³¼ ì»¨í…Œì´ë„ˆ ê°œì²´ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ë„êµ¬ì´ë‹¤. ë ˆì§€ìŠ¤íŠ¸ë¦¬(Registry)ì™€ ìœ ì‚¬í•˜ì§€ë§Œ `Content Library`ì—ëŠ” VM templates, OVA, OVF íŒŒì¼ ë“±ì´ ì €ì¥ëœë‹¤.  \n\n`Menu` -> `Content Libraries`ë¡œ ì´ë™í•´ì„œ ìƒˆë¡œìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€ë¥¼ í•œë‹¤. ì´ë¦„ê³¼ vCenter Serverë¥¼ ì„ íƒí•˜ê³  2ë²ˆì§¸ ë‹¨ê³„ì—ì„œ Subscribed content libraryë¥¼ ì„ íƒí•˜ê³  `Subscription URL`ì— https://wp-content.vmware.com/v2/latest/lib.json ë¥¼ ì…ë ¥í•˜ê³  3ë²ˆì§¸ ë‹¨ê³„ì—ì„œ ì €ì¥ë  ë°ì´í„°ìŠ¤í† ì–´ë¥¼ ì„ íƒí•˜ë©´ ëœë‹¤.  \n\nì‹¤ì œ ìœ„ URLì€ `OVF Template` ì—¬ëŸ¬ê°œë¥¼ ë‹¤ìš´ë°›ëŠ”ë° Tanzu Clusterë‚´ì—ì„œ Masterì™€ Worker Nodeë“¤ë¡œ ì“°ì¼ Kubernetes 1.16 ~ 1.18ê¹Œì§€ ì—¬ëŸ¬ê°œì˜ VMì´ë¯¸ì§€ (photon OS)ë“¤ì´ ì¶”ê°€ê°€ ë˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì„ ë³´ë©´ í˜„ì¬ Tanzuì—ì„œ ì‚¬ìš©ë˜ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„° ë²„ì „ì´ 1.18.5ë¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.\n\n![tkg](/img/content_tkg.png)\n\n## Workload Management êµ¬ì„±\n\nWorkload Managementë€ ì‰½ê²Œ ìƒê°í•˜ë©´ vSphere ê¸°ë°˜ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤íŠ¸ë¥¼ í”„ë¡œë¹„ì €ë‹í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” ë„êµ¬ë¼ ë³´ë©´ ëœë‹¤.  \n\nWorkload ManagementëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ í•œë‹¤.  \n\n* Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ì»´í“¨íŒ…, ìŠ¤í† ë¦¬ì§€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì‚¬ì´ì§• ë° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬\n* Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ë„¤íŠ¸ì›Œí¬ ë° DNS, NTP ë° VDSê°™ì€ ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬\n* Kubernetes í´ëŸ¬ìŠ¤í„° ìƒì„¸ ì •ë³´ (Node ê°œìˆ˜ ë° ìƒíƒœ ì •ë³´)\n\nWorkload Managementì—ì„œ í´ëŸ¬ìŠ¤í„° ìƒì„±ì„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§„í–‰í•˜ê¸° ì „ì— PowerCLIë¥¼ í†µí•´ ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ í•œë‹¤. \n\n```powershell\nConnect-VIServer -Server vcsa.tanzu.local -User administrator@vsphere.local -Password VMware1!\nConnect-CisServer -Server vcsa.tanzu.local -User administrator@vsphere.local -Password VMware1!\n```\n\nê·¸ë¦¬ê³  PowerCLI Workload Management ëª¨ë“ˆì„ ì„¤ì¹˜í•˜ê³  ì—¬ëŸ¬ í™˜ê²½ë³€ìˆ˜ë“¤ì„ ì„¤ì •í•œë‹¤. ê¸°ì¡´ì— ì‚¬ìš©í•œ ì •ë³´ë“¤ê³¼ ìœ„ì—ì„œ ë§Œë“  Content Library ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ê³  ì‹¤í–‰í•œë‹¤.  \n\n```powershell\nImport-Module VMware.WorkloadManagement\n\n$vSphereWithTanzuParams = @{\n    ClusterName = \"Tanzu-Cluster\";\n    TanzuvCenterServer = \"vcsa.tanzu.local\";\n    TanzuvCenterServerUsername = \"administrator@vsphere.local\";\n    TanzuvCenterServerPassword = \"VMware1!\";\n    TanzuContentLibrary = \"TKG\"; # Content Library ì´ë¦„\n    ControlPlaneSize = \"TINY\";\n    MgmtNetwork = \"Management\";\n    MgmtNetworkStartIP = \"192.168.0.220\";\n    MgmtNetworkSubnet = \"255.255.255.0\";\n    MgmtNetworkGateway = \"192.168.0.1\";\n    MgmtNetworkDNS = @(\"192.168.0.201\");\n    MgmtNetworkDNSDomain = \"tanzu.local\";\n    MgmtNetworkNTP = @(\"162.159.200.123\");\n    WorkloadNetwork = \"Workload\";\n    WorkloadNetworkStartIP = \"10.20.0.10\";\n    WorkloadNetworkIPCount = 20;\n    WorkloadNetworkSubnet = \"255.255.255.0\";\n    WorkloadNetworkGateway = \"10.20.0.1\";\n    WorkloadNetworkDNS = @(\"192.168.0.201\");\n    WorkloadNetworkServiceCIDR = \"10.96.0.0/24\";\n    StoragePolicyName = \"Tanzu-Storage-Policy\";\n    HAProxyVMvCenterServer = \"vcsa.tanzu.local\";\n    HAProxyVMvCenterUsername = \"administrator@vsphere.local\";\n    HAProxyVMvCenterPassword = \"VMware1!\";\n    HAProxyVMName = \"haproxy.tanzu.local\";\n    HAProxyIPAddress = \"192.168.0.203\";\n    HAProxyRootPassword = \"VMware1!\";\n    HAProxyPassword = \"VMware1!\";\n    LoadBalancerStartIP = \"10.10.0.64\";\n    LoadBalancerIPCount = 64\n}\nNew-WorkloadManagement2 @vSphereWithTanzuParams\n```\n\ní´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ëŠ” ì‹œê°„ì€ ì•½ 40ë¶„ ì´ìƒ ì†Œìš”ë˜ëŠ”ë° Tanzu-Clusterì˜ Control Plane Node (Master Node) ìƒì„±ì´ ì™„ë£Œë˜ë©´ IPê°€ 10.10.0.64(HAProxy Load Balancerì—ì„œ í• ë‹¹ëœ ì²«ë²ˆì§¸ ì£¼ì†Œ)ë¡œ í• ë‹¹ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\në‹¤ìŒì€ Namespaceë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•œë‹¤. `Workload Management`ì—ì„œ `NEW NAMESPACE`ë©”ë‰´ë¥¼ í´ë¦­í•˜ê³  ìœ„ì—ì„œ ìƒì„±í•œ `Tanzu-Cluster`ë¥¼ ì„ íƒí•˜ê³  ì´ë¦„(test)ì„ ì…ë ¥í•˜ê³  Namespaceë¥¼ ìƒì„±í•œë‹¤. \n\n![tkg_permission](/img/tkg_permission.png)\n\n## Cluster ì ‘ì†  (Kubernetes CLI)\n\nìƒì„±ëœê±¸ í™•ì¸í•œ í›„ ë¸Œë¼ìš°ì €ì— í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì˜ Control Plane IP (https://10.10.0.64)ë¡œ ì ‘ì†í•˜ë©´ OSë³„(Linux, MacOS, Windows)ë¡œ CLI í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤.  \n\nì„¤ì¹˜ ë° PATH ì„¤ì •ì„ ì§„í–‰í•˜ê³  ì•„ë˜ì™€ ê°™ì´ Control Planeìœ¼ë¡œ CLI ë¡œê·¸ì¸ì„ í•˜ë©´ í˜„ì¬ ì„¤ì •ëœ Context í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. \n\n```sh\n> kubectl vsphere login --server=10.10.0.64 -u administrator@vsphere.local --insecure-skip-tls-verify\n\n        ğŸ¥³vSphere with Tanzu Basic Cluster enabled by William Lam's Script ğŸ¥³\n\nPassword:\nLogged in successfully.\n\nYou have access to the following contexts:\n   10.10.0.64\n   docker-desktop\n   nexclipper\n   test\n\nIf the context you wish to use is not in this list, you may need to try\nlogging in again later, or contact your cluster administrator.\n\nTo change context, use `kubectl config use-context <workload name>`\n```\n\n```sh\n> kubectl config use-context nexclipper\nSwitched to context \"nexclipper\".\n\n> kubectl get nodes\nNAME                               STATUS   ROLES    AGE     VERSION\n422f46864113e3de3361943d14073728   Ready    master   4d21h   v1.18.2-6+38ac483e736488\n422faddc15554b09d82907c0dfb57752   Ready    master   4d21h   v1.18.2-6+38ac483e736488\n```\n\nnexclipper namespaceë¡œ contextë¥¼ ì „í™˜í•˜ê³  nodeë¥¼ í™•ì¸í•˜ë©´ master nodeë¥¼ 2ê°œ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° ì´ëŠ” `nexclipper`ë¼ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì´ê´„í•˜ëŠ” Super Master(Control Plane) ê°™ì€ ê°œë…ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. ì²˜ìŒì— í´ëŸ¬ìŠ¤í„° ë°°í¬ì „ì— Namespace ë¦¬ì†ŒìŠ¤ë¥¼ ë§Œë“¤ê¸¸ë˜ ë‹¤ì†Œ í—·ê°ˆë¦¬ê¸´ í–ˆì§€ë§Œ Tanzuì—ì„œì˜ NamespaceëŠ” ê¸°ì¡´ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ì»¨ì…‰ì´ ì•„ë‹Œ, ì •í•´ì§„ ë¦¬ì†ŒìŠ¤ì™€ ìœ ì €ì™€ ê·¸ë£¹ì˜ ê¶Œí•œì„ ë¨¼ì € Namespaceë¡œ í• ë‹¹í•˜ê³  ê·¸ë‹´ì— ë‹¤ì‹œ ì¡°ì§ì´ë‚˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³„ë¡œ Kubernetes Workloadë¥¼ ë‹¤ì‹œ ì œê³µí•˜ëŠ” ì»¨ì…‰ì´ë¼ê³  ë³´ë©´ëœë‹¤.  \n\nìµœê·¼ì— `SKT`ë‚˜ `Kakao Enterprise` ì²˜ëŸ¼ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ë¼ì´í”„ì‚¬ì´í´ì„ ì¿ ë²„ë„¤í‹°ìŠ¤ë¡œ ê´€ë¦¬í•˜ëŠ” ì»¨ì…‰ìœ¼ë¡œ ì´í•´í•˜ë©´ ì¢‹ë‹¤. ì•„ë˜ ê·¸ë¦¼ì„ ì°¸ê³ í•˜ë©´ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.  \n\n![tanzu](https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/img/GUID-DF8905E1-C098-4882-BFC1-B0BAC668B424-high.png)  \nì°¸ì¡° : https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/img/GUID-DF8905E1-C098-4882-BFC1-B0BAC668B424-high.png\n\nTanzuKubernetesCluster CRDë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‹ ê·œë¡œ ìƒì„±í•œë‹¤.  \n`namespace: nexclipper`ë¡œ ì„¤ì •í•˜ê³  ì›í•˜ëŠ” ë°°í¬ ë²„ì „ê³¼ ì´ë¦„, CNI, Control Plane, Worker Node ê°œìˆ˜ ë“±ì„ ê¸°ì¬í•˜ê²Œ ë˜ëŠ”ë° íŠ¹ì´í•œ ê²ƒì€ CNIëŠ” [Antrea](https://github.com/vmware-tanzu/antrea)ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n```yaml\napiVersion: run.tanzu.vmware.com/v1alpha1\nkind: TanzuKubernetesCluster\nmetadata:\n  name: nexclipper-cluster\n  namespace: nexclipper\nspec:\n  distribution:\n    version: v1.17.8+vmware.1-tkg.1.5417466\n  settings:\n    network:\n      cni:\n        name: antrea\n      pods:\n        cidrBlocks:\n        - 193.0.2.0/16\n      serviceDomain: managedcluster.local\n      services:\n        cidrBlocks:\n        - 195.51.100.0/12\n  topology:\n    controlPlane:\n      class: best-effort-xsmall\n      count: 1\n      storageClass: tanzu-storage-policy\n    workers:\n      class: best-effort-xsmall\n      count: 1\n      storageClass: tanzu-storage-policy\n```\n\nì‹ ê·œ TKG í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•œë‹¤. \n\n```sh\n> kubectl apply -f tkc.yaml  \n\ntanzukubernetescluster.run.tanzu.vmware.com/nexclipper-cluster created\n```\n\në°°í¬í•˜ê³  tanzukubernetescluster ë¥¼ ì¡°íšŒí•´ë³´ë©´ Control Plane 1ê°œ, Worker Node 1ê°œì˜  v1.17.8 ë²„ì „ì˜ í´ëŸ¬ìŠ¤í„°ê°€ ë°°í¬ëœê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. \n\n```\n> kubectl get tanzukubernetescluster\nNAME                 CONTROL PLANE   WORKER   DISTRIBUTION                     AGE   PHASE\nnexclipper-cluster   1               1        v1.17.8+vmware.1-tkg.1.5417466   33m   running\n```\n\nìƒì„±í•œ tanzukubernetesclusterë¡œ ì ‘ì†í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.\n\n```\n> kubectl-vsphere login --server=10.10.0.64 -u administrator@vsphere.local --insecure-skip-tls-verify --tanzu-kubernetes-cluster-name nexclipper-cluster --tanzu-kubernetes-cluster-namespace nexclipper\n\n> kubectl config use-context nexclipper-cluster\nSwitched to context \"nexclipper-cluster\".\n\n> kubectl get nodes\nNAME                                                STATUS   ROLES    AGE     VERSION\nnexclipper-cluster-control-plane-95nhv              Ready    master   3h10m   v1.17.8+vmware.1\nnexclipper-cluster-workers-kp68q-78df45db5c-jzmmv   Ready    <none>   3h6m    v1.17.8+vmware.1\n```\n\nìƒì„±í•œ í´ëŸ¬ìŠ¤í„°ì— ê°„ë‹¨í•œ ì•±ì„ ë°°í¬í•œë‹¤.  \n[Kubedoom](https://github.com/storax/kubedoom)ì€ Doom ê²Œì„ë‚´ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜(ê´´ë¬¼)ì„ ì¼ë¶€ëŸ¬ ì¢…ë£Œì‹œì¼œ ë³µì›ì„±ì„ ë³´ê²Œí•˜ëŠ” ì¬ë¯¸ìˆëŠ” ì•±ì´ë‹¤.\n\n```\n> git clone https://github.com/storax/kubedoom.git\n> cd kubedoom\n> kubectl apply -f manifest/\n> kubectl -n kubedoom port-forward deployment/kubedoom 5900:5900\nForwarding from 127.0.0.1:5900 -> 5900\nForwarding from [::1]:5900 -> 5900\n```\n\në°°í¬í•œí›„ì— í¬íŠ¸í¬ì›Œë”©ì„ í•œ ì•±ìœ¼ë¡œ VNC viewerë¡œ ì ‘ì†í•˜ë©´ ì¬ë¯¸ìˆëŠ” í™”ë©´ì„ ë³¼ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤. VNC íŒ¨ìŠ¤ì›Œë“œëŠ” `idbehold`ì´ë‹¤.\n\n![doom](/img/doom.png)\n\n## Tanzu ì¥ë‹¨ì  (ê°œì¸ì˜ê²¬)\n\ní•˜ë“œì›¨ì„œ ê³ ë¯¼, êµ¬ë§¤, ESXi ì„¤ì¹˜, vCenter, TKGì„ ì„¤ì¹˜í•˜ê³  ì•„í‚¤í…ì²˜ë“¤ì„ ì°¾ì•„ë³´ë©´ì„œ ëª‡ê°€ì§€ ì¥ë‹¨ì ì´ ëˆˆì— ë³´ì˜€ëŠ”ë° ê°€ì¥ í° ì¥ì ì€ í•˜ë‚˜ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ Super Master(Control Plane)ë¥¼ ë¨¼ì € êµ¬ì„±í•˜ê³  ìì›(ì»´í“¨íŒ…, ë„¤íŠ¸ì›Œí¬, ìŠ¤í† ë¦¬ì§€ ë“±)ê³¼ ê¸°ì¡´ì— ë³´ìœ í•˜ê³  ìˆëŠ” ê¶Œí•œ ì²´ê³„ë¡œ í• ë‹¹ì„ í•œ ë’¤ í•„ìš”í• ë•Œ ë§ˆë‹¤ íŠ¹ì • íŒ€ì´ë‚˜ ì¡°ì§ì—ê²Œ ë³„ë„ì˜ í´ëŸ¬ìŠ¤í„°ë¥¼ í• ë‹¹í•˜ëŠ” ì•„í‚¤í…ì²˜ë¥¼ ì¶”êµ¬í•˜ê³  ìˆì–´ VMware í™˜ê²½ì—ì„œ Kubernetesë¥¼ ì‹ ê·œ ë„ì…í•˜ê³  ì—”í„°í”„ë¼ì´ì¦ˆì— ì ìš©í•˜ê¸° ìš©ì´í•˜ë‹¤ëŠ” ì ì´ë‹¤.  \n\në˜í•œ ê¸°ë³¸ì ìœ¼ë¡œ ê°–ì¶°ì•¼ í•˜ëŠ” Security Policyë‚˜ ë¦¬ì†ŒìŠ¤ í• ë‹¹ì´ í´ëŸ¬ìŠ¤í„° êµ¬ì¶•ì´í›„ì— ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì´ë¯¸ ì •ì˜ëœ ê·œì¹™ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì´ ì´í›„ì— ì§„í–‰ë˜ê¸° ë•Œë¬¸ì— ê´€ë¦¬ì ì¸ ì¸¡ë©´ì—ì„œë„ ì¥ì ì´ ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤. \n\ní•˜ì§€ë§Œ ê°œì¸ì ìœ¼ë¡œ ìƒê°í•˜ëŠ” ë‹¨ì ë“¤ë„ ëª‡ê°€ì§€ ìˆëŠ”ë° ì²«ë²ˆì§¸ëŠ” ìš©ì–´ì˜ ì¤‘ë³µìœ¼ë¡œ ì¸í•œ í˜¼ë™ì´ ìˆì—ˆë‹¤ëŠ”ì ì´ë‹¤. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë‚˜ ê¸°ì¡´ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ë§ì´ ì‚¬ìš©ë˜ëŠ” ìš©ì–´ë³´ë‹¤ëŠ” VMwareì—ì„œ ë§Œë“  CRDë“±ì„ ë¯¸ë¦¬ í•™ìŠµí•˜ê±°ë‚˜ ì•Œê³  ìˆì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ê²½í—˜ì´ ìˆëŠ” ìœ ì €ë„ ì ‘ê·¼ì„±ì´ ë–¨ì–´ì§ˆ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤. \n\në¹„ìš© ì¸¡ë©´ì—ì„œëŠ” ì¼ë‹¨ `vCenter` ì´ì™¸ì— `Workload Management` ë¼ì´ì„¼ìŠ¤ê°€ ë³„ë„ë¡œ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ìì„¸íˆ ì•Œì•„ë³´ì§„ ì•Šì•˜ì§€ë§Œ ì ì§€ ì•Šì€ ë¹„ìš©ì´ ë“¤ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤. ê²Œë‹¤ê°€ ë§ì€ êµ¬ì„±ìš”ì†Œë¡œ ì¸í•œ ìì›ì´ ì†Œìš”ê°€ ìˆì–´ í•˜ë‚˜ì˜ ì‘ì€ í´ëŸ¬ìŠ¤í„°ë§Œ ë„ì› ìŒì—ë„ 64GB ë¨¸ì‹ ì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ê±°ì˜ 60GBì— ìœ¡ë°•í–ˆê¸° ë•Œë¬¸ì— ê¸°ì¡´ ì¸í”„ë¼ ë¹„ìš©ì— ì¶”ê°€ì ì¸ ë¹„ìš©ì— ëŒ€í•œ ê³ ë ¤ê°€ ë°˜ë“œì‹œ í•„ìš”í•  ê²ƒ ê°™ë‹¤. \n\nìœ„ì—ë„ ì–¸ê¸‰í–ˆì§€ë§Œ ëŸ¬ë‹ì»¤ë¸Œì— ëŒ€í•œ ë¶€ë¶„ë„ ë¬¸ì œì ì´ ë  ìˆ˜ ìˆì„ê²ƒì´ë‹¤. NSXê¸°ë°˜ì˜ ìƒˆë¡œìš´ CNIë¿ë§Œ ì•„ë‹ˆë¼ ê¸°ì¡´ VMware ìš´ì˜ì„ í•˜ë˜ DevOpsíŒ€ì´ë‚˜ ì¸í”„ë¼ ìš´ì˜ì¡°ì§ì˜ ëŸ¬ë‹ì»¤ë¸Œ, ì¶”ìƒí™” ë ˆë²¨ì´ ë†’ì•„ì ¸ì„œ ë‚´ê°€ ì›í•˜ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ì´ë²¤íŠ¸ë‚˜ ë¡œê·¸ë¥¼ í™•ì¸í•  ë•Œ íƒìƒ‰ì ìœ¼ë¡œ ë©”ë‰´ë¥¼ ì°¾ê¸°ê°€ ì‰½ì§€ ì•Šì€ ë¶€ë¶„ë“¤ì´ ìˆì—ˆë‹¤. ê·¸ë˜ì„œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë•Œì—ë„ ë¡œê·¸ì˜ ì›ì²œì„ ì°¾ëŠ”ë° ì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦¬ê¸°ë„ í–ˆë‹¤. \n\n\n## ì •ë¦¬\n\ní•œ ì¼ì£¼ì¼ë™ì•ˆ ìŠ¤í† ë¦¬ì§€ ì˜¤ë¥˜ë¡œ ì”¨ë¦„í•˜ë‹¤ê°€ ê²¨ìš° ì•±ì„ ë°°í¬í–ˆì§€ë§Œ ê±°ì˜ 2ì£¼ë™ì•ˆ ì¬ë¯¸ìˆê²Œ êµ¬ì„±í•´ë³¼ìˆ˜ ìˆì—ˆë‹¤. ì†”ì§íˆ ì´ì•¼ê¸°í•˜ìë©´ ê°œì¸ í´ëŸ¬ìŠ¤í„°ë¡œ êµ¬ì„±í•˜ëŠ”ë°ëŠ” ì¶”ì²œí•˜ì§€ ì•Šì§€ë§Œ Tanzuë¥¼ ê³µë¶€í•˜ê³  ìš´ì˜í•´ì•¼ í•˜ëŠ” ê²½ìš°ë‚˜ ìê²©ì¦ì„ ì·¨ë“í•˜ëŠ” ë¶€ë¶„ì´ í•„ìš”í•˜ë‹¤ë©´ í•œë²ˆì¯¤ì€ í•´ë³¼ ê°€ì¹˜ê°€ ìˆë‹¤ê³  ìƒê°í•œë‹¤.  \n\nê±°ì˜ 1ë…„ë§Œì— í¬ìŠ¤íŒ…ì„ ì‘ì„±í–ˆëŠ”ë° ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ëŠ” Security Policy ê´€ë ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ì—°ë§ì„ ì •ë¦¬í•´ë³¼ ìƒê°ì´ë‹¤."
    },
    {
      "id": "kubernetes/vSphere-with-Tanzu-homelab/",
      "metadata": {
        "permalink": "/kubernetes/vSphere-with-Tanzu-homelab/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2020-11-30-vSphere-with-Tanzu-homelab.md",
        "source": "@site/blog/2020-11-30-vSphere-with-Tanzu-homelab.md",
        "title": "vSphere with Tanzu homelab running on ASUS PN50 (1/2)",
        "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Tanzu Clusterë¥¼ ë‹¨ì¼ í™ˆë© vSphere ì„œë²„ì— ì˜¬ë ¤ë³¸ë‹¤",
        "date": "2020-11-30T00:00:00.000Z",
        "formattedDate": "November 30, 2020",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Tanzu",
            "permalink": "/tags/tanzu"
          },
          {
            "label": "vSphere",
            "permalink": "/tags/v-sphere"
          },
          {
            "label": "Homelab",
            "permalink": "/tags/homelab"
          },
          {
            "label": "ASUS",
            "permalink": "/tags/asus"
          },
          {
            "label": "PN50",
            "permalink": "/tags/pn-50"
          }
        ],
        "readingTime": 18.245,
        "truncated": true,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (1/2)",
          "comments": true,
          "classes": "wide",
          "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Tanzu Clusterë¥¼ ë‹¨ì¼ í™ˆë© vSphere ì„œë²„ì— ì˜¬ë ¤ë³¸ë‹¤",
          "slug": "kubernetes/vSphere-with-Tanzu-homelab/",
          "date": "2020-11-30T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "Tanzu",
            "vSphere",
            "Homelab",
            "ASUS",
            "PN50"
          ]
        },
        "prevItem": {
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (2/2)",
          "permalink": "/kubernetes/vSphere-with-Tanzu-homelab-2/"
        },
        "nextItem": {
          "title": "2019 Retrospective",
          "permalink": "/retrospective/2020plan/"
        }
      },
      "content": "ìŠ¤íƒ€íŠ¸ì—…ìœ¼ë¡œ ì´ì§í›„ ì •ì‹ ì—†ëŠ” 6ê°œì›”ì„ ë³´ëƒˆê³  ì§‘ì—ì„œ í•˜ëŠ” ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë‚˜ ê³µë¶€í•˜ëŠ” ê²ƒë“¤ì´ ì†Œí™€í•´ì§€ëŠ”ê²ƒ ê°™ì•„ ë§ˆìŒì„ ë‹¤ì¡ê³ ì ì‘ì„±í•˜ëŠ” í¬ìŠ¤íŒ…ì´ë‹¤. ìµœê·¼ ëª‡ê°œì›” ê°„ì€ íšŒì‚¬ ë¸”ë¡œê·¸ ê¸€ë§Œ ì‘ì„±í•˜ë‹¤ë³´ë‹ˆ ê°œì¸ ë¸”ë¡œê·¸ë¥¼ ê±°ì˜ ëª»í•˜ê³  ìˆì–´ì„œ íšŒì‚¬ ì œí’ˆê³¼ëŠ” ì•„ì§ê¹Œì§€ ê±°ë¦¬ê°€ ìˆëŠ” í”Œë«í¼ ê³µë¶€ì°¨ ì‘ì„±í•œë‹¤. ìˆœìˆ˜í•˜ê²Œ ì •ë³´ê³µìœ ì°¨ ì‘ì„±í•˜ëŠ” ê²ƒì´ë©°, íŠ¹ì •íšŒì‚¬ì˜ íšŒì‚¬ì˜ ì œí’ˆì´ë‚˜ í”Œë«í¼ì„ í™ë³´í•˜ê³ ì í•¨ì€ ì•„ë‹ˆë‹¤.\n\n<!--truncate-->\n\n## Tanzu\n\n[https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio](https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio)  \n\nTanzuëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œ, êµ¬ë™, ìš´ì˜í•˜ëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆ í™˜ê²½ì„ í†µí•© ê´€ë¦¬í•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ìƒìš©í™” í•œ ì œí’ˆìœ¼ë¡œ ì´í•´í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì‰½ë‹¤. \n\n![tanzu](/img/tanzu.png)  \n(ì¶œì²˜ : VMì›¨ì–´ ì½”ë¦¬ì•„ ë°œí‘œìë£Œ ê°ˆë¬´ë¦¬)\n\ní¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´ ê¸°ì¡´ ì¸í”„ë¼ë¥¼ êµ¬ì„±í•˜ëŠ” ë ˆì´ì–´ì¸ vSphere ìœ„ì— `VMware Tanzu Kubernetes Grid`ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.  \n\nì˜¤ëŠ˜ì€ ê¸°ì¡´ Pivotal ì´ë‚˜ Spring Bootë¥¼ ì œì™¸í•œ í”Œë«í¼ ë ˆì´ì–´ì˜ TKG(Tanzu Kubernetes Grid)ë¥¼ í™ˆë©ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í–ˆë‹¤. \n\nëª¨ë“  ê³¼ì •ì€ virtuallyGhetto ë¸”ë¡œê·¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±í–ˆê³  ê°€ì¥ ë”°ë¼í•œ ë¶€ë¶„ì€ ì•„ë˜ í¬ìŠ¤íŒ…ì´ë‹ˆ NUCìœ¼ë¡œ êµ¬ì„±í•˜ë ¤ë©´ ì›ë¬¸ì„ ì°¸ê³ í•˜ë©´ ëœë‹¤.  \n[https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments](https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments)\n\n## ì¤€ë¹„ì‚¬í•­(Hardware)\n\n* ASUS PN50  \n  [https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/](https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/)\n\n  PN50 ë² ì–´ë³¸ì„ ì„ íƒí•œ ì´ìœ ëŠ” ì¼ë‹¨ AMD Ryzen 4800u CPUê°€ ì €ì „ë ¥ì¸ë°ë„ ë¶ˆêµ¬í•˜ê³  8ì½”ì–´ 16ìŠ¤ë ˆë“œ, 64GB sodimmì´ ì§€ì›ë˜ë©°, 2.5ì¸ì¹˜ì™€ M.2 SSDê°€ ë™ì‹œ ì¥ì°©ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì ì´ë‹¤. ì˜¨ë³´ë“œ NIC ë“œë¼ì´ë²„ê°€ vSphere 7.0ì—ì„œ ì§€ì›ë˜ì§€ ì•Šì§€ë§Œ USB Network Adapterë¥¼ í†µí•´ êµ¬ì„±ì´ ê°€ëŠ¥í–ˆê¸° ë•Œë¬¸ì— ë§ì„¤ì„ ì—†ì´ êµ¬ë§¤ë¥¼ ê²°ì •í–ˆë‹¤. êµ¬ì…ì€ ë„¤ì´ë²„ ê²€ìƒ‰(asus pn50 4800u)ì„ í†µí•´ 71ë§Œì› ì •ë„ì— êµ¬ë§¤ë¥¼ í–ˆë‹¤. ì´ë„ ìŠ¤ë§ˆì¼ ìºì‹œë¥¼ ì§ì ‘ êµ¬ë§¤í•´ì„œ ì‹¤ì œ êµ¬ë§¤ê¸ˆì•¡ì€ 65ë§Œì› ì •ë„ê°€ ì†Œìš”ë˜ì—ˆë‹¤.\n\n* SODIMM DDR4 32G PC4-25600 (TeamGroup)  \n  í•´ë‹¹ ì œí’ˆì€ ê°€ì„±ë¹„ë¡œ ê°€ì¥ ì €ë ´í•˜ê²Œ ì‚´ ìˆ˜ ìˆëŠ” êµ­ë‚´ ì›ŒëŸ°í‹°ê°€ ê°€ëŠ¥í•œ SODIMM ë©”ëª¨ë¦¬ë¡œ 32G 2ê°œë¥¼ êµ¬ë§¤í–ˆìœ¼ë©° ë„¤ì´ë²„ ê²€ìƒ‰ìœ¼ë¡œ 2ê°œ 25ë§Œì› ì •ë„ë¡œ êµ¬ë§¤í–ˆë‹¤.\n\n* 2.5 SSD (ADATA SU655 240GB)  \n  ESXi ì„œë²„ ì„¤ì¹˜ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê¸°ì¡´ì— ê°–ê³  ìˆë˜ ADATA SU655 240GBë¥¼ ì‚¬ìš©í–ˆê³  í˜„ì¬ 3.5ë§Œì› ì •ë„ì— êµ¬ë§¤ê°€ëŠ¥í•˜ë‹¤. \n\n* M.2 SSD (WD BLACK SN750 M.2 NVMe 500GB)  \n  ì•„ë§ˆì¡´ì—ì„œ ì§êµ¬í•œ ë…€ì„ìœ¼ë¡œ 69.99ë‹¬ëŸ¬ ì†Œìš”ë˜ì—ˆë‹¤. ë°°ëŒ€ì§€ ê°€ê²©ì„ í•©ì¹˜ë©´ 8.5ë§Œì› ì •ë„ ì†Œìš”ë˜ì—ˆë‹¤. \n\n* Gigabit USB Lancard (tplink UE300C)  \n  ESXi 7.0ë²„ì „ì—ì„œ ì˜¨ë³´ë“œ NIC ì¸ì‹ì´ ë¶ˆê°€ëŠ¥í•œ ì´ìœ ë¡œ ë³„ë„ë¡œ ê¸°ê¸°ë¹„íŠ¸ ìœ ì„  ëœì¹´ë“œë¥¼ êµ¬ë§¤í–ˆë‹¤. 1.5ë§Œì› ì •ë„ì— êµ¬ë§¤ê°€ëŠ¥ í•˜ê³  3ë…„ ë³´ì¦ì´ ë˜ëŠ” TPLINKì œí’ˆìœ¼ë¡œ ì„ íƒí•˜ì˜€ë‹¤.  \n  [https://coupa.ng/bM0lN8](https://coupa.ng/bM0lN8) -> `í•´ë‹¹ ë§í¬ë¥¼ í†µí•´ êµ¬ë§¤í•˜ë©´ ì €ì—ê²Œ ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ë¥¼ í†µí•´ ì ë¦½ê¸ˆì´ ì§€ê¸‰ë˜ë‹ˆ í•„ìš”í•˜ì‹  ë¶„ì€ ì•„ë˜ë¥¼ í†µí•´ êµ¬ë§¤ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤`\n\nì‹¤ì œ ìœ„ ìŠ¤í™ìœ¼ë¡œ ëŒ€ì¶© êµ¬ë§¤ë¥¼ ì§„í–‰í•˜ê²Œ ë˜ë©´ `104ë§Œì›` ì •ë„ ì†Œìš”ê°€ ë ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤. í™˜ìœ¨ì´ë‚˜ í• ì¸ì„ ì „í˜€ ë°›ì§€ ì•Šê³  1ê°œì˜ SSDë¡œ êµ¬ì„±í•œë‹¤ê³  ê°€ì •í•´ë„ ì•½ 8ì½”ì–´ 16ìŠ¤ë ˆë“œ 64GB ë¨¸ì‹ ì„ `110ë§Œì›` ì •ë„ë¡œ êµ¬ì„±ì´ ê°€ëŠ¥í•˜ë‹¤. ë¬¼ë¡  ì„œë²„ë‚˜ ì›Œí¬ìŠ¤í…Œì´ì…˜ì´ë‚˜ Intel NUCê¸°ë°˜ìœ¼ë¡œë„ êµ¬ì„±ì´ ê°€ëŠ¥í•˜ì§€ë§Œ ì „ë ¥ì†Œëª¨ì™€ ì§‘ì•ˆì„ ì°¨ì§€í•˜ëŠ” ë¶€í”¼ë¥¼ ê³ ë ¤í•˜ë©´ ê¸ˆì•¡ì ìœ¼ë¡œ ë©”ë¦¬íŠ¸ê°€ ìˆë‹¤ê³  ìƒê°í•œë‹¤.\n\n## ì¤€ë¹„ì‚¬í•­(Software)\n\n* Windows PC (with Powershell, WSL) or MAC\nWindowë¥¼ ì‚¬ìš©ì„ í•˜ì§€ ì•Šê³  MACì´ë‚˜ ë¦¬ëˆ…ìŠ¤ë¡œ êµ¬ì„±í•˜ë ¤ í–ˆìœ¼ë‚˜ ì˜¨ë³´ë“œ NIC ì¸ì‹ì„ ìœ„í•œ ë“œë¼ì´ë²„ í†µí•© ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ì‘ì„± í¸ì˜ë¥¼ ìœ„í•´ Window í™˜ê²½ì„ ì‚¬ìš©í•˜ì˜€ë‹¤.\n\n* [ventoy](https://www.ventoy.net/en/index.html)  \n  ESXi ë¶€íŒ… ì´ë¯¸ì§€ ì œì‘ì„ ìœ„í•œ íˆ´ì´ë©° [rufus](https://rufus.ie/)ì— ë¹„í•´ í™œìš©ë„ê°€ ë†’ë‹¤.\n* [vSphere 7.0 Update 1](https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0)  \n  í‰ê°€íŒì€ [https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7](https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7) ì—ì„œ ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•˜ë‹¤.\n* [PowerShell 7.10](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0)  \n  ê¸°ë³¸ì ìœ¼ë¡œ Windowì—ëŠ” 6.x ë²„ì „ì˜ PowerShellì´ ì„¤ì¹˜ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— 7.1.0 ë²„ì „ì„ ì‹ ê·œë¡œ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.\n* [PowerCLI](https://www.powershellgallery.com/packages?q=VMware.PowerCLI)  \n  https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493\n  ì»¤ìŠ¤í…€ ESXi 7.0 ì´ë¯¸ì§€ ì œì‘ì„ ìœ„í•´ í•„ìš”í•˜ë‹¤.\n* [USB Network Native Driver for ESXi](https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip)  \n  PN50 USB NIC(RTL8153) ì¸ì‹ì„ ìœ„í•œ ë„¤ì´í‹°ë¸Œ ë“œë¼ì´ë²„.\n* [OVFTool](https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&productId=974)  \n  OVAë¥¼ ë°°í¬í•˜ê¸° ìœ„í•œ ë„êµ¬ë¡œ Linux 64 bundleë¡œ WSLì— ì„¤ì¹˜í•œë‹¤. \n* [vcsa-deploy](https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7)  \n  vCenterë¥¼ ë°°í¬í•˜ëŠ” ë„êµ¬ë¡œ ì´ë¯¸ì§€ë‚´ì— í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— vCenter Server Appliance ISOë¥¼ ë‹¤ìš´ë°›ì•„ ì••ì¶•ì„ í’€ë©´ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n## ìµœì¢… ì˜ˆìƒ êµ¬ì„±ìš”ì†Œ\n* vCenter Server Appliance\n* VMFS Storage\n* vSphere with Tanzu Cluster\n* HAProxy\n* Router (Forwarding, DNS)\n* Supervisor Control Plane VMs (Master 2ea, Worker 3ea)\n\n## ESXi ì„¤ì¹˜\n\nì´ˆë°˜ì—ë„ ì´ì•¼ê¸° í–ˆë“¯ì´ ESXi 7.0ì´ìƒì—ì„œëŠ” ASUS PN50ì˜ ì˜¨ë³´ë“œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤. ê·¸ë˜ì„œ ë³„ë„ë¡œ êµ¬ë§¤í•œ USB ì¸í„°í˜ì´ìŠ¤ì˜ RTL8153 ì¹©ì…‹ì„ ì´ë¯¸ì§€ì— í†µí•©ì‹œí‚¤ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.  \n\në“œë¼ì´ë²„ ì´ë¯¸ì§€ í†µí•©ì„ ìœ„í•œ ë‚´ìš©ì€ ì•„ë˜ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í–ˆë‹¤.  \n* [https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/](https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/)\n* [https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/](https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/)\n\n### ESXi ë‹¤ìš´ë¡œë“œ\n\në‹¤ìŒ ë§í¬ì—ì„œ `VMware vSphere 7.0 Update 1` ë¥¼ ë‹¤ìš´ë¡œë“œ í•œë‹¤.  \n* [https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0](https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0)\n\nê¸°ë³¸ì ìœ¼ë¡œ VMware íšŒì›ê°€ì…ì´ í•„ìš”í•˜ë©° ë¼ì´ì„¼ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° 60ì¼ trialë¡œ ê°€ëŠ¥í•˜ë‹¤.  \n* [https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7](https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7)\n\n### USB Network Native Driver for ESXi\n\nUSB NIC Fling ë“œë¼ì´ë²„ë¥¼ ì¤€ë¹„í•œë‹¤. \n\n* [https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip\n](https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip)\n\n### PowerShell 7.1.0 ì„¤ì¹˜\n\nê¸°ë³¸ì ìœ¼ë¡œ Windowì—ëŠ” 6.x ë²„ì „ì˜ PowerShellì´ ì„¤ì¹˜ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— íŠ¹ì • ìŠ¤í¬ë¦½íŠ¸ë¥¼ êµ¬ë™í•˜ê¸° ìœ„í•´ì„œëŠ” 7.1.0 ë²„ì „ì„ ì‹ ê·œë¡œ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.  \n\n* [https://github.com/PowerShell/PowerShell](https://github.com/PowerShell/PowerShell)\n\n\n### PowerCLI ì¤€ë¹„\n\nPowerCLI ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜\n* [https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493](https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493)\n\nê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ PowerShellì„ ì‹¤í–‰í•˜ê³  PowerCLI ëª¨ë“ˆ ì„¤ì¹˜ì „ì— ì‹¤í–‰ ê¶Œí•œì„ ìˆ˜ì •í•œë‹¤.  \n* ì°¸ê³  : [https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1)\n\n```powershell\nSet-ExecutionPolicy -ExecutionPolicy RemoteSigned\n```\n\nPowerCLIë¥¼ ì„¤ì¹˜í•œë‹¤.\n```powershell\nInstall-Module -Name VMware.PowerCLI -Scope CurrentUser\n```\n\n### Image Profile í™•ì¸\ní¬ìŠ¤íŒ…ì„ í•˜ëŠ” 20ë…„ 11ì›” 29ì¼ ìµœì‹  ESXi ì´ë¯¸ì§€ëŠ” `ESXi-7.0U1b-17168206-standard`ë¡œ vSphere ESXi 7.0 ì´ë¯¸ì§€ í”„ë¡œí•„ì€ ì•„ë˜ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.  \n* [https://www.virten.net/vmware/vmware-esxi-image-profiles/](https://www.virten.net/vmware/vmware-esxi-image-profiles/)\n\nstable ë¦´ë¦¬ìŠ¤ë¡œ êµ¬ì„±í•˜ê¸° ìœ„í•´ ì´ì „ ë¦´ë¦¬ìŠ¤ì¸ `ESXi-7.0.1-16850804-standard` ì´ë¯¸ì§€ í”„ë¡œí•„ë¡œ ì„¤ì¹˜ë¥¼ ì§„í–‰í•œë‹¤.  \n\nì„¤ì¹˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‚´í´ë³´ë©´ `Add-EsxSoftwareDepot`ë¡œ repoì„¤ì •ì„ í•˜ê³  `Export-ESXImageProfile`ë¥¼ í†µí•´ ì›í•˜ëŠ” ì´ë¯¸ì§€ í”„ë¡œí•„ì˜ bundleì„ ë‹¤ìš´ë¡œë“œ ë°›ëŠ”ë‹¤. ìœ„ì—ì„œ ë‹¤ìš´ë¡œë“œ ë°›ì€ ë“œë¼ì´ë²„ë¥¼ `Add-EsxSoftwarePackage`ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€í•˜ê³  ìƒˆë¡œìš´ ISOì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì„ ì•Œ ìˆ˜ ìˆë‹¤.  \n\nì´ë¯¸ì§€ í”„ë¡œí•„ ë³€ê²½ì„ í†µí•´ ì›í•˜ëŠ” ì´ë¯¸ì§€ ë²„ì „ìœ¼ë¡œ êµ¬ì„±ì´ ê°€ëŠ¥í•˜ë‹¤.  \n\n```powershell\nAdd-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml\nExport-ESXImageProfile -ImageProfile \"ESXi-7.0.1-16850804-standard\" -ExportToBundle -filepath  ESXi-7.0.1-16850804-standard.zip\nRemove-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml\nAdd-EsxSoftwareDepot .\\ESXi-7.0.0-15843807-standard.zip\nAdd-EsxSoftwareDepot .\\ESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip\nNew-EsxImageProfile -CloneProfile \"ESXi-7.0.1-16850804-standard\" -name \"ESXi-7.0.1-16850804-USBNIC\" -Vendor \"virten.net\"\nAdd-EsxSoftwarePackage -ImageProfile \"ESXi-7.0.1-16850804-USBNIC\" -SoftwarePackage \"vmkusb-nic-fling\"\nExport-ESXImageProfile -ImageProfile \"ESXi-7.0.1-16850804-USBNIC\" -ExportToIso -filepath ESXi-7.0.1-16850804-USBNIC.iso\nExport-ESXImageProfile -ImageProfile \"ESXi-7.0.1-16850804-USBNIC\" -ExportToBundle -filepath ESXi-7.0.1-16850804-USBNIC.zip\n```\n\n### ESXi ì„¤ì¹˜ ì´ë¯¸ì§€ ì œì‘\n\nESXi ë¶€íŒ… ì´ë¯¸ì§€ ì œì‘ì€ [rufus](https://rufus.ie/), [ventoy](https://www.ventoy.net/en/index.html) ë‘˜ ì¤‘ í¸í•œ ë„êµ¬ë¡œ ì„ íƒí•˜ë©´ ë˜ëŠ”ë° ventoyê°€ ì¡°ê¸ˆ ë” í™œìš©ë„ê°€ ë†’ë‹¤ê³  íŒë‹¨í•˜ì—¬ ì§„í–‰í–ˆê³ , OSì„¤ì¹˜ USB ìƒì„±ì€ ìƒëµí•œë‹¤. \n\n### ë¶€íŒ… ë° ì„¤ì¹˜ \n\nì¼ë°˜ì ì¸ ë°”ì´ì˜¤ìŠ¤ ì„¤ì •ê³¼ ë™ì¼í•˜ê²Œ Boot ìš°ì„ ìˆœìœ„ë¥¼ USBë¡œ ì„¤ì •í•˜ê³  ë‹¤ìŒê³¼ ê°™ì€ ventoyí™”ë©´ì—ì„œ ì•ì„œ ìƒì„±í•œ `ESXi-7.0.1-16850804-USBNIC.iso` ì´ë¯¸ì§€ë¡œ ESXi ì„¤ì¹˜ë¥¼ ì§„í–‰í•œë‹¤.\n\n![ventoy](https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png)\nhttps://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png  \n\n\nì´í›„ ì¹œìˆ™í•œ DCUI(Direct Console User Interface)ë¡œ ì ‘ì†í•˜ì—¬ F2ëª¨ë“œë¡œ ì ‘ì†í•˜ì—¬ Static IP ì„¤ì •ê³¼ network í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.  \n\n![esxi](/img/esxi7.png)\n\n\n### vSphere Web Client ì ‘ì†\n\nì„¤ì •í•œ Static IPë¡œ ì ‘ì†í•˜ì—¬ í™˜ê²½ì„ ì ê²€í•œë‹¤.  \n\n![nw](/img/esxi_network.png)\n\nManagement Networkì— vSwitch0ì´ êµ¬ì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\nê·¸ë¦¬ê³  ì„¤ì¹˜í•œ M.2 SSDë¡œ datastore2ë¥¼ ì¶”ê°€í•˜ì—¬ vCenter ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ë„ë¡ í•œë‹¤.\n\n![storage](/img/esxi_storage.png)\n\n## Router ì„¤ì¹˜ ë° í™˜ê²½ êµ¬ì„±\n\nRouter VMì€ DNS ì„œë²„ì˜ ì—­í• ë¿ ì•„ë‹ˆë¼ ì•ìœ¼ë¡œ êµ¬ì„±ë  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬(10.10.0.0/24 & 10.20.0.0/24)ì™€ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì˜ í¬ì›Œë”©ê³¼ NAT ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.  \n\nPhoton OS 3.0 OVAë¡œ ë°°í¬ë˜ë©° [OVFTool](https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&productId=974)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬ë¥¼ ì§„í–‰í•˜ëŠ”ë° ì´ë¯¸ ì‘ì„±ëœ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•œë‹¤. \n\n* [Photon OS 3.0 OVA](https://packages.vmware.com/photon/3.0/Rev3/ova/photon-hw13_uefi-3.0-a383732.ova)\n* [https://github.com/lamw/vsphere-with-tanzu-homelab-scripts](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git)\n\n\n### Router ì„¤ì¹˜\n\nìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì€ ë™ì¼í•œ PowerShellì´ ë™ì‘í•˜ëŠ” Window WSL2 í™˜ê²½ì—ì„œ ìˆ˜í–‰í–ˆê¸° ë•Œë¬¸ì— Window `hosts` íŒŒì¼ê³¼ WSLí™˜ê²½ì˜ `/etc/hosts` íŒŒì¼ì— ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” IPì£¼ì†Œë¥¼ ë¯¸ë¦¬ ë“±ë¡í•´ë†“ëŠ”ë‹¤.  \n\n```\n192.168.0.10    esxi-01.tanzu.local\n192.168.0.201   router.tanzu.local\n192.168.0.202   vcsa.tanzu.local\n192.168.0.203   haproxy.tanzu.local\n```\n\n[ìŠ¤í¬ë¦½íŠ¸ ë ˆí¬](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git)ì˜ `deploy_photon_router_ova.sh`ë¥¼ ìì‹ ì˜ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•œë‹¤. WSLë‚´ì—ì„œ Window ì‹œìŠ¤í…œë‚´ì— ë‹¤ìš´ë¡œë“œí•œ OVAíŒŒì¼ ê²½ë¡œëŠ” WSLë‚´ì—ì„œ ì‹¤í–‰ë  ê²ƒì´ê¸°ì— `/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova`ë¡œ ë³€ê²½í•˜ì˜€ë‹¤. Routerì™€ ESXi hostname, passwordë“±ì„ í™•ì¸í•˜ê³  Networkê³¼ DatastoreëŠ” ìœ„ì—ì„œ í™•ì¸í•œ ë‚´ìš©ìœ¼ë¡œ ìˆ˜ì •í•œë‹¤.\n\n```sh\n#!/bin/bash\n# William Lam\n# www.virtuallyghetto\n\nPhotonOVA=\"/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova\"\nPhotonRouterVMName=\"router.tanzu.local\"\nESXiHostname=\"esxi-01.tanzu.local\"\nESXiUsername=\"root\"\nESXiPassword='VMware1!'\n\nPhotonRouterNetwork=\"VM Network\"\nPhotonRouterDatastore=\"datastore1\"\n\n### DO NOT EDIT BEYOND HERE ###\n\novftool \\\n--name=${PhotonRouterVMName} \\\n--X:waitForIpv4 \\\n--powerOn \\\n--acceptAllEulas \\\n--noSSLVerify \\\n--datastore=${PhotonRouterDatastore} \\\n--net:\"None=${PhotonRouterNetwork}\" \\\n${PhotonOVA} \\\n\"vi://${ESXiUsername}:${ESXiPassword}@${ESXiHostname}\"\n```\n\nìŠ¤í¬ë¦½ë“œë¥¼ ì‹¤í–‰í•˜ë©´ OVAíŒŒì¼ì„ ë°°í¬í•˜ê²Œ ëœë‹¤.  \n\n```sh\n$ ./deploy_photon_router_ova.sh\nOpening OVA source: /mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova\nThe manifest validates\nThe provided certificate is in valid period\nSource is signed and the certificate validates\nCertificate information:\n  CertIssuer:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.\n  CertSubject:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.\n  -----BEGIN CERTIFICATE-----\n  ...\n  -----END CERTIFICATE-----\n\n\nWarning:\n - Line -1: Unsupported value 'uefi.secureBoot.enabled' for attribute 'key' on element 'ExtraConfig'.\nOpening VI target: vi://root@esxi-01.tanzu.local:443/\nDeploying to VI: vi://root@esxi-01.tanzu.local:443/\nTransfer Completed\nPowering on VM: router.tanzu.local\nTask Completed\nReceived IP address: 192.168.0.47\nCompleted successfully\n```\n\nìœ„ì™€ ê°™ì´ DHCPë¥¼ í†µí•´ ì„ì˜ì˜ ì£¼ì†Œ(192.168.0.47)ë¥¼ í• ë‹¹ ë°›ê²Œ ë˜ê³  í•´ë‹¹ IPë¡œ SSHì ‘ì†í•˜ì—¬ ê¸°ë³¸ íŒ¨ìŠ¤ì›Œë“œ(`changeme`)ë¥¼ ì›í•˜ëŠ” íŒ¨ìŠ¤ì›Œë“œë¡œ ë³€ê²½í•œë‹¤.\n\n```sh\n$ ssh root@192.168.0.47\nThe authenticity of host '192.168.0.47 (192.168.0.47)' can't be established.\nECDSA key fingerprint is SHA256:ESpN1DMTIu9PKWW4QZIYs4DZ602SsdhjxEYhugkmi+g.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '192.168.0.47' (ECDSA) to the list of known hosts.\nPassword:\n\ncat > /etc/systemd/network/10-static-eth0.network << EOF\nYou are required to change your password immediately (administrator enforced)\nChanging password for root.\nCurrent password:\nNew password:\nRetype new password:\n 08:58:54 up 32 min,  0 users,  load average: 0.00, 0.00, 0.00\ntdnf update info not available yet!\nroot@photon-machine [ ~ ]#\nroot@photon-machine [ ~ ]# exit\nlogout\nConnection to 192.168.0.47 closed.\n```\n\n### Router í™˜ê²½ êµ¬ì„±\n\nìœ„ ìŠ¤í¬ë¦½íŠ¸ [ë ˆí¬ì§€í† ë¦¬](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts)ì—ì„œ DNSì—­í• , í¬ì›Œë”©ì„ ìˆ˜í–‰í•˜ë„ë¡ [`setup_photon_router.sh`](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_photon_router.sh)ë¥¼ ìˆ˜ì •í•œë‹¤. \n\n* `PHOTON_ROUTER_IP`=192.168.0.201 : Router ì„¤ì •í•  IP\n* `PHOTON_ROUTER_GW`=192.168.0.1 : Routerì˜ ê²Œì´íŠ¸ì›¨ì´\n* `PHOTON_ROUTER_DNS`=192.168.0.1 : Routerì˜ Forwader DNS\n* `SETUP_DNS_SERVER`=1 : Routerê°€ í´ëŸ¬ìŠ¤í„° ë‚´ DNS ì—­í• ì„ ìˆ˜í–‰\n\nìœ„ ì„¤ì • ì´ì™¸ì—ë„ ì¶”í›„ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±ì„ ìœ„í•œ iptables êµ¬ì„±ì´ í¬í•¨ë˜ì–´ ìˆë‹¤.  \n\n```sh\n#!/bin/bash\n\nPHOTON_ROUTER_IP=192.168.0.201\nPHOTON_ROUTER_GW=192.168.0.1\nPHOTON_ROUTER_DNS=192.168.0.1\nSETUP_DNS_SERVER=1\n\ntdnf -y update\nif [ ${SETUP_DNS_SERVER} -eq 1 ]; then\n    tdnf install -y unbound\n\n    cat > /etc/unbound/unbound.conf << EOF\n    server:\n        interface: 0.0.0.0\n        port: 53\n        do-ip4: yes\n        do-udp: yes\n        access-control: 192.168.0.0/24 allow\n        access-control: 10.10.0.0/24 allow\n        access-control: 10.20.0.0/24 allow\n        verbosity: 1\n\n    local-zone: \"tanzu.local.\" static\n\n    local-data: \"router.tanzu.local A 192.168.0.201\"\n    local-data-ptr: \"192.168.0.201 router.tanzu.local\"\n\n    local-data: \"vcsa.tanzu.local A 192.168.0.202\"\n    local-data-ptr: \"192.168.0.202 vcsa.tanzu.local\"\n\n    local-data: \"haproxy.tanzu.local A 192.168.0.203\"\n    local-data-ptr: \"192.168.0.203 haproxy.tanzu.local\"\n\n    local-data: \"esxi-01.tanzu.local A 192.168.0.10\"\n    local-data-ptr: \"192.168.0.10 esxi-01.tanzu.local\"\n...\n```\n\ní•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê³  ë‚˜ë©´ IPê°€ ë³€ê²½ë˜ê³  ì™¸ë¶€ì—ì„œë„ Router DNSë¥¼ í†µí•´ ì¿¼ë¦¬ê°€ ê°€ëŠ¥í•œê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n```powershell\nPS C:\\Users\\rokak> nslookup vmware.com 192.168.0.201\nì„œë²„:    router.tanzu.local\nAddress:  192.168.0.201\n\nê¶Œí•œ ì—†ëŠ” ì‘ë‹µ:\nì´ë¦„:    vmware.com\nAddresses:  2a02:e980:b5::b7\n            2a02:e980:b1::b7\n            45.60.101.183\n            45.60.11.183\n```\n\n### VCSA(vCenter Server Appliance) ë°°í¬ ë° êµ¬ì„±\n\n`vcsa-deploy`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬ë¥¼ ì§„í–‰í•œë‹¤. `vcsa-deploy`ëŠ” VCSA ì´ë¯¸ì§€ë‚´ì— ë°”ì´ë„ˆë¦¬ í˜•íƒœë¡œ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— ë¨¼ì € VCSA 7.0 Update 1 ISOë¥¼ ë‹¤ìš´ë¡œë“œí•œë‹¤.  \n* [https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7](https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7)\n\nìœ„ ìŠ¤í¬ë¦½íŠ¸ [ë ˆí¬ì§€í† ë¦¬](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts)ì—ì„œ [`vcsa.tanzu.local.json`](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/vcsa.tanzu.local.json)ë¥¼ ìˆ˜ì •í•œë‹¤.  \n\níŒ¨ìŠ¤ì›Œë“œ, `Network`ì™€ `Datastore`ë¥¼ ì„¤ì •í•˜ê³  `dns_servers`ë¥¼ Router IPë¡œ ë³€ê²½í•œë‹¤. ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤. \n\n```json\n{\n            ...\n            \"deployment_network\": \"VM Network\",\n            \"datastore\": \"datastore2\"\n        },\n        \"appliance\": {\n            \"__comments\": [\n            ...\n            ],\n            \"thin_disk_mode\": true,\n            \"deployment_option\": \"tiny\",\n            \"name\": \"vcsa.tanzu.local\"\n        },\n        \"network\": {\n            \"ip_family\": \"ipv4\",\n            \"mode\": \"static\",\n            \"system_name\": \"vcsa.tanzu.local\",\n            \"ip\": \"192.168.0.202\",\n            \"prefix\": \"24\",\n            \"gateway\": \"192.168.0.1\",\n            \"dns_servers\": [\n                \"192.168.0.201\"\n            ]\n        },\n    ...\n}\n```\n\nìœ„ì—ì„œ ë‹¤ìš´ë¡œë“œ ë°›ì•˜ë˜ VCSA ISOë¥¼ ì••ì¶•ì„ í’€ê³  ìœ„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¸ì¡°í•˜ì—¬ ë°°í¬ ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤. \n\n```sh\n$ cd VMware-VCSA-all-7.0.1-17004997/\n$ ./vcsa-deploy install --accept-eula --acknowledge-ceip --no-ssl-certificate-verification /mnt/c/esxi/vsphere-with-tanzu-homelab-scripts/vcsa.tanzu.local.json\n```\n\nvCenterê°€ ì„¤ì¹˜ê°€ ì™„ë£Œëœ í›„ SSHë¡œ ì ‘ì†í•œë‹¤. ê¸°ë³¸ Shellì´ Bashê°€ ì•„ë‹ˆë¯€ë¡œ `shell` ëª…ë ¹ìœ¼ë¡œ ì ‘ì†í•œí›„ `chsh -s /bin/bash`ë¡œ ê¸°ë³¸ Shellì„ Bashë¡œ ë³€ê²½í•œë‹¤.  \n\n```sh\n$ ssh root@192.168.0.202\nThe authenticity of host '192.168.0.202 (192.168.0.202)' can't be established.\nECDSA key fingerprint is SHA256:oMr5nJ9RDeZS9E3m586kSFDoNXM76yNiLYaIyDQ6ca4.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '192.168.0.202' (ECDSA) to the list of known hosts.\n\nVMware vCenter Server 7.0.1.00100\n\nType: vCenter Server with an embedded Platform Services Controller\n\nroot@192.168.0.202's password:\nConnected to service\n\n    * List APIs: \"help api list\"\n    * List Plugins: \"help pi list\"\n    * Launch BASH: \"shell\"\n\nCommand>\nCommand> shell\nShell access is granted to root\nroot@vcsa [ ~ ]# chsh -s /bin/bash\n```\n\n### VCSA ì„¤ì • ë³€ê²½\n\në©”ëª¨ë¦¬ ì ˆì•½ì„ ìœ„í•´ ë§ˆìŠ¤í„° ë…¸ë“œ ê°œìˆ˜ë¥¼ ë³€ê²½í•œë‹¤. `/etc/vmware/wcp/wcpsvc.yaml` ì—ì„œ `clusterconfig.minmasters` ì™€ `clusterconfig.maxmasters` ê°’ì„ 2ë¡œ ë³€ê²½í•˜ë©´ ëœë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ì¡°í•œë‹¤.\n\n* [https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html](https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html)\n\n```yaml\nlogging:\n  level: debug\n  maxsizemb: 10\n# By default, WCP Agent VM OVF URL points to the ovf bundled in vCSA, served\n# through lighttpd web server. To override it, set kubevmconfig.ovfurl param.\n#kubevm:\n#  ovfurl: 'https://this_vc_pnid:5480/wcpagent/photon-ova-%%SIZE%%.ovf'\n#  apiserverport: 6443\n#  authproxyport: 443\nrhttpproxy_port: 443\nclusterconfig:\n  minmasters: 2\n  maxmasters: 2\n  disable_ssl: false\n  namespace_graceful_disable_duration: 1800\n  upgrade_precheck_timeout: 300\n# force_upgrade_clusters:\n  force_version_for_enable: v1\\.18\\..*\n  logging_fluentbit_enabled: false\n# logging_fluentbit_rsyslog: \"\"\ncsisetting:\n   csi_enabled: true\nhdcsconfig:\n  ovf_url: 'file:///storage/lifecycle/vmware-hdcs'\n```\n\nvCenter UIì‚¬ìš©ì„ ìœ„í•´ [`setup_vcsa.ps1`](https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_vcsa.ps1) ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í•œë‹¤.  \n\n```powershell\n.\\setup_vcsa.ps1\nConnect-VIServer: C:\\esxi\\vsphere-with-tanzu-homelab-scripts\\setup_vcsa.ps1:17\nLine |\n  17 |  $vc = Connect-VIServer $VCSAHostname -User $VCSAUsername -Password $V â€¦\n     |        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n     | 2020-11-30 ì˜¤ì „ 12:45:18 Connect-VIServer  The SSL connection could not be established,\n     | see inner exception.\n```\n\nìœ„ì™€ ê°™ì´ SSL connection ì—ëŸ¬ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì¸ì¦ì„œ ì²´í¬ë¥¼ ë¬´ì‹œí•˜ëŠ” ì„¤ì •ì„ ë¨¼ì„œ í•œë‹¤. \n\n```powershell\nSet-PowerCLIConfiguration -InvalidCertificateAction:Ignore\n```\n\n`$VCSAPassword`, `$DatastoreName`, `$ESXiPassword` ë“±ì„ ìˆ˜ì •í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.\n\n```powershell\nPS C:\\esxi\\vsphere-with-tanzu-homelab-scripts> .\\setup_vcsa.ps1\n```\n\nì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ ì‹ ê·œUIë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•´ì§„ë‹¤. ì´ì œë¶€í„°ëŠ” VCSAë¡œ ì§ì ‘ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤.  \nê¸°ë³¸ ë¡œê·¸ì¸ ì•„ì´ë””ëŠ” `administrator@vsphere.local`ë¡œ `vcsa.tanzu.local.json` ì—ì„œ ì„¤ì •í•œ íŒ¨ìŠ¤ì›Œë“œë¡œ ì ‘ì†í•˜ë©´ vCenter ê¸°ë°˜ì˜ Client UIë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì •ìƒì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°ëœ ESXi í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n![VCSA](/img/vcsa_home.png)\n\n\n\n## ì •ë¦¬\n\nì¼ë‹¨ ì•„ì£¼ ì‘ì€ í•˜ë“œì›¨ì–´ë¡œ ê°€ì„±ë¹„ ì¢‹ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” PN50ìœ¼ë¡œ Tanzu í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ í•˜ê¸° ìœ„í•œ ê¸°ì´ˆì‘ì—…ì´ ì™„ë£Œë˜ì—ˆë‹¤.  \n\nê¸€ì´ ê¸¸ì–´ì§€ëŠ” ê´€ê³„ë¡œ VDS(vSphere Distributed Switch)ë¥¼ êµ¬ì„±í•˜ëŠ” ì´í›„ ë¶€ë¶„ì€ ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œ ê³„ì† ì´ì–´ë‚˜ê°ˆ ì˜ˆì •ì´ë‹¤. \n\n> ë‹¤ìŒê¸€ - [vSphere with Tanzu homelab running on ASUS PN50 (2/2)](https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab-2/)"
    },
    {
      "id": "retrospective/2020plan/",
      "metadata": {
        "permalink": "/retrospective/2020plan/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2020-01-03-2020plan.md",
        "source": "@site/blog/2020-01-03-2020plan.md",
        "title": "2019 Retrospective",
        "description": "19ë…„ë„ë¥¼ ëŒì•„ë³´ë©°",
        "date": "2020-01-03T00:00:00.000Z",
        "formattedDate": "January 3, 2020",
        "tags": [
          {
            "label": "Retrospective",
            "permalink": "/tags/retrospective"
          },
          {
            "label": "2019",
            "permalink": "/tags/2019"
          },
          {
            "label": "2020",
            "permalink": "/tags/2020"
          },
          {
            "label": "Planning",
            "permalink": "/tags/planning"
          }
        ],
        "readingTime": 6.255,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "2019 Retrospective",
          "comments": true,
          "classes": "wide",
          "description": "19ë…„ë„ë¥¼ ëŒì•„ë³´ë©°",
          "slug": "retrospective/2020plan/",
          "date": "2020-01-03T00:00:00.000Z",
          "categories": [
            "Retrospective"
          ],
          "tags": [
            "Retrospective",
            "2019",
            "2020",
            "Planning"
          ]
        },
        "prevItem": {
          "title": "vSphere with Tanzu homelab running on ASUS PN50 (1/2)",
          "permalink": "/kubernetes/vSphere-with-Tanzu-homelab/"
        },
        "nextItem": {
          "title": "CircleCIë¡œ AWS BATCH(ECS) CI/CD Pipeline êµ¬ì„±",
          "permalink": "/devops/circleci-ecs/"
        }
      },
      "content": "ë˜ í•œí•´ê°€ ì§€ë‚˜ê°”ë‹¤. 2019ë…„ í•œì¼ ì •ë¦¬í•˜ë©´ì„œ 2020ë…„ í”Œëœ ê¸°ë¡ìš©ìœ¼ë¡œ ë„ì ê±°ë ¤ë³¸ë‹¤.\n\n- Work\n    - 18ë…„ë„ ê¹Œì§€ ì„œë¹„ìŠ¤ ê°œë°œì„ ë§¡ì•˜ì§€ë§Œ ê°‘ì‘ìŠ¤ëŸ½ê²Œ ë¶€ì„œ ì´ë™ìœ¼ë¡œ ì¸í•´ FaaS ê°œë°œì„ ì†ì„ ë–¼ê³  ì‹ ê·œ ë¶€ì„œë¡œ ì´ì „í•˜ê²Œ ë˜ì—ˆë‹¤. ì‘ë…„ ì´ˆì—ë„ í° ë³€í™”ì˜€ëŠ”ë° ì´ë²ˆì—ë„ ë” í° ë³€í™”ì˜€ë‹¤.\n    - ë¬¸ì œëŠ” ê°œë°œë³´ë‹¤ëŠ” ê¸°íšìª½ì— ë” ê°€ê¹Œìš´ ì—…ë¬´ì˜€ê³  ë°ì´í„° ë¶„ì„ ê´€ë ¨í•œ í”Œë«í¼ì„ ê°œë°œí•˜ëŠ” TFì— í¬í•¨ë˜ê²Œ ë˜ì—ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹, ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§ê³¼ëŠ” ë‹´ì„ ìŒ“ì•˜ì—ˆì§€ë§Œ ì–´ì©”ìˆ˜ ì—†ì´ ë¶„ì„ ê´€ë ¨í•˜ì—¬ ê³¼ì œ ìˆ˜í–‰\n    - 1-3ì›”ì—ëŠ” ì£¼ë¡œ ëª¨ë¹Œë¦¬í‹° ê´€ë ¨ ì—ì½”íŒŒíŠ¸ë„ˆë“¤ê³¼ í˜‘ë ¥ ë° ì‚¬ì—…ê°œë°œì„ ìœ„í•œ ê¸°ìˆ ê²€í†  ë° ê²€ì¦.\n    - 4-6ì›”ì—ëŠ” ê·¸ë£¹ ê´€ê³„ì‚¬ë“¤ì˜ ë°ì´í„°ë ˆì´í¬ì— ëŒ€í•œ ì •ì˜ì™€ ì„¤ê³„, í”Œë«í¼ êµ¬í˜„ì„ ìœ„í•œ Design-Thinking, ì„œë¹„ìŠ¤ í¬í„¸ ê¸°íš ë“±ì„ ìˆ˜í–‰í•˜ê³  ê·¸ë£¹ ê´€ê³„ì‚¬ë“¤ì˜ ë°ì´í„°ë ˆì´í¬ì— ëŒ€í•œ ì •ì˜ì™€ ì„¤ê³„ ì§„í–‰.\n    - 7-9ì›”ì—ëŠ” ì„œë¹„ìŠ¤ í¬í„¸ ê°œë°œì„ ìœ„í•œ CI/CD ì„ ì • ë° devops íŒŒì´í”„ë¼ì¸ êµ¬ì„±, ë°ì´í„° preparation íˆ´ ê²€í†  ë° AWS Managed ì„œë¹„ìŠ¤ ê²€ì¦ ë° êµ¬í˜„ ì—…ë¬´ë¥¼ ìˆ˜í–‰í–ˆë‹¤. ë˜í•œ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì²˜ë¦¬ë¥¼ ìœ„í•œ ëŒë‹¤í•¨ìˆ˜ ê°œë°œ ë° documents ë ˆí¬ì§€í† ë¦¬ êµ¬ì¶• ì§„í–‰.\n    - 10-12ì›”ê¹Œì§€ëŠ” ì„œë¹„ìŠ¤ í¬í„¸ ì˜¤í”ˆ ë° ê³ ë„í™”, ë‹¤ìŒ ë‹¨ê³„ ì„œë¹„ìŠ¤ ê¸°íš ìˆ˜í–‰í•¨.\n\n- Main Tools\n    - Python, Node.js, Java(Springboot)\n    - AWS - ECS, Lambda, CloudFront, Athena, Glue, S3, SageMaker\n    - IBM Cloud - Object Storage\n    - Github Team\n    - CircleCI, Github Action\n\n- Side (Communityí¬í•¨)\n    - ë²ˆì—­ : [í”„ë¡œë©”í…Œìš°ìŠ¤ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ëª¨ë‹ˆí„°ë§ [ê°€ìƒë¨¸ì‹ , ì»¨í…Œì´ë„ˆ í™˜ê²½ì˜ í”„ë¡œë©”í…Œìš°ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹¤ìŠµê³¼ í™œìš©]](http://acornpub.co.kr/book/monitoring-prometheus)\n    - ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… - 13íšŒ (ëª©í‘œ 25íšŒ ë¯¸ë‹¬ì„±)\n    - ì‚¬ë‚´ ì—°êµ¬ ê³¼ì œ - ë©€í‹°í´ë¼ìš°ë“œ êµ¬í˜„ì„ ìœ„í•œ IaC ì—°êµ¬ (5-10ì›”)\n        - Terraform, Terratest, Ansible, Kubespary, CircleCI ì¡°í•©ìœ¼ë¡œ í•˜ë‚˜ì˜ íŒŒì´í”„ë¼ì¸ì—ì„œ Bastion ì—†ì´ ë©€í‹° í´ë¼ìš°ë“œ(AWS, IBM, GCP) í™˜ê²½ì— Elastic ë° K8s í´ëŸ¬ìŠ¤í„° ë°°í¬ ë° í…ŒìŠ¤íŠ¸ ìë™í™” í™˜ê²½ êµ¬ì„±\n    - Istio ìŠ¤í„°ë”” (9-11ì›”)\n        - ë‹¤ì–‘í•œ íšŒì‚¬ë¶„ë“¤ê³¼ ìŠ¤í„°ë”” ì§„í–‰ (ì¹´ì¹´ì˜¤ë±…í¬, ì´ë² ì´, í•˜ì´í¼ì»¤ë„¥íŠ¸)\n            - ë‹¤ì–‘í•œ ê²½í—˜ì„ ë“¤ì„ìˆ˜ ìˆì–´ì„œ ì¢‹ì€ ê²½í—˜!!\n        - ìë£Œ : [https://github.com/dev-chulbuji/istio-study](https://github.com/dev-chulbuji/istio-study)\n    - K8s Korea Group ëª¨ë‹ˆí„°ë§ ì†Œëª¨ì„ ì§„í–‰\n        - 1ì°¨ (4/25) SK u-tower\n            - ë°œí‘œ1 : OpenCensus with Prometheus and Kubernetes (ê¹€ì§„ì›…)\n            - ë°œí‘œ2 - Service Mesh(Istio) Monitoring (ë‚˜ì •í˜¸)\n        - 2ì°¨(6/4) ë©”ê°€ì¡´\n            - ë°œí‘œ1 : ì¿ ë²„ë„¤í‹°ìŠ¤ ìš´ì˜ ê´€ë¦¬ ì˜¤í”ˆì†ŒìŠ¤: NexClipper ì†Œê°œ (ê¹€ì§„ìš©)\n            - ë°œí‘œ2 : ë‚œìƒí† ì˜ (ëª¨ë‹ˆí„°ë§, ì•„í‚¤í…ì²˜ ê²½í—˜ ë“± ììœ ì£¼ì œ ê³µìœ , í† ì˜)\n    - AWS Korea User ì†Œëª¨ì„ ì°¸ì—¬\n        - íŒêµ, ì»¨í…Œì´ë„ˆ, ì„œë²„ë¦¬ìŠ¤, ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤, ë¨¸ì‹ ëŸ¬ë‹ ìŠ¤í„°ë””, ë°ë¸Œì˜µìŠ¤\n    - CircleCI ë°‹ì—… ì°¸ì—¬\n        - 1ì°¨ (5/14), 2ì°¨ (8/27)\n    - Open Infrastructure & Cloud Native Days Korea 2019 ì°¸ì—¬ (7/18-19)\n    - Kubernetes Forum Seoul ì°¸ì—¬ (12/9)\n        - CFP íƒˆë½ ã… ã… \n    - ê°œì¸ ì„œë²„, NAS 2ëŒ€ Shutdown (ì „ê¸°ì„¸ ì••ë°•ì—ì„œ í•´ë°©ë¨)\n        - G Suite Business ë¡œ ê°ˆì•„íƒ\n    - ë¯¸ë””ì–´ í™˜ê²½ ê°œí¸\n        - ìŠ¤ë§ˆíŠ¸TV ì§êµ¬ (75SM8670PUA)\n        - PS4 êµ¬ë§¤ (ë‹Œí…ë„ ìŠ¤ìœ„ì¹˜, Xbox ê¸°ì¡´ë³´ìœ )\n    - K3s Home Labêµ¬ì„± ë° ì´ë”íŒ¨ë“œ ì„œë¹„ìŠ¤ ìš´ì˜\n        - 1.16 í´ëŸ¬ìŠ¤í„° : 1 Master, 3 Workers\n    - ë…ì„œ\n        - 20ê¶Œ ë‚´ì™¸ (ê¸°ìˆ ì„œ í¬í•¨)\n    - êµìœ¡\n        - Google Study Jam - í´ë¼ìš°ë“œ 4íšŒ, ë¨¸ì‹ ëŸ¬ë‹ 4íšŒ ìˆ˜ë£Œ\n        - Udemy - CKA, CKAD\n        - Elasticsearch Engineer I, II\n\n- Speak\n    - 2018ë…„ì— ë¹„í•´ ëŒ€ì™¸ ë°œí‘œê°€ ë§ì´ ì ì—ˆë‹¤. ì‹¤ì œ K8s ê´€ë ¨ ì—…ë¬´ë¥¼ í•˜ì§€ ì•Šì•„ ê·¸ëŸ° ë“¯ í•˜ë‹¤.\n    - 4ì›” AWS Korea User Group íŒêµì†Œëª¨ì„\n        - [Amazon EKS Workshop ì‚´í´ë³´ê¸°](https://www.slideshare.net/JinwoongKim8/eks-workshop-140043415)\n    - 4ì›” Kubernetes Korea Group ëª¨ë‹ˆí„°ë§ ì†Œëª¨ì„\n        - [Opencensus with prometheus and kubernetes](https://www.slideshare.net/JinwoongKim8/open-census-with-prometheus-and-kubernetes)\n    - 4ì›” Google Cloud Next â€˜19 Extended Korea\n        - [Knativeë¡œ ì„œë²„ë¦¬ìŠ¤ ì›Œí¬ë¡œë“œ êµ¬í˜„](https://www.slideshare.net/JinwoongKim8/knative)\n    - 6ì›” Korea DevOps MeetUP â€˜19 - 4ì›” ë°œí‘œ ìˆ˜ì •\n        - [OpenCensus with Prometheus and Kubernetes](https://www.slideshare.net/JinwoongKim8/opencensus-with-prometheus-and-kubernetes)\n    - 7ì›” CircleCI Korea User Group 2nd Meetup\n        - [Data(?)Ops with CircleCI](https://www.slideshare.net/JinwoongKim8/dataops-with-circleci)\n    - 9ì›” AWS Korea User Group íŒêµì†Œëª¨ì„\n        - [DataOps with CircleCI](https://www.slideshare.net/JinwoongKim8/dataops-with-circleci)\n    - 11ì›” ì‚¬ë‚´ Open Tech Lounge ë°œí‘œ\n        - ë©€í‹°í´ë¼ìš°ë“œ êµ¬í˜„ì„ ìœ„í•œ IaC ì—°êµ¬\n\n- 2020 ëª©í‘œ\n    - ì»¤ë®¤ë‹ˆí‹° í™œë™ì€ ìµœëŒ€í•œ ì¤„ì´ê¸° (í•„ìˆ˜ì ì¸ ë¶€ë¶„ë§Œ)\n        - SRE group í™œì„±í™” ë°©ì•ˆ ê³ ë¯¼\n        - ë°‹ì—…, ì„¸ë¯¸ë‚˜ ê´€ë ¨ ìº˜ë¦°ë” ì—°ë™ ìë™í™” ë°©ì•ˆ ê³ ë¯¼\n    - ë²ˆì—­ ë° ì±… ì“°ëŠ”ê±´ ê³ ë¯¼ì„ ë”...\n    - Level Up\n        - ì˜ì–´!! - ë°œí‘œê¹Œì§€\n        - Full-Stack ??\n        - ë¨¸ì‹ ëŸ¬ë‹, ë”¥ëŸ¬ë‹\n        - ELK ì¿¼ë¦¬ ì˜ì§œê¸°\n        - NoSQL\n    - ê¸°ì¡´ì—…ë¬´ K8s ì „í™˜ ë° ê³ ë„í™”\n        - ì„œë²„ë¦¬ìŠ¤, ë§¤ë‹ˆì§€ë“œ ë°©í–¥ìœ¼ë¡œ\n    - ì‚¬ì´ë“œ í”„ë¡œì íŠ¸\n        - í™ˆ ë¯¸ë””ì–´ ê´€ë¦¬ ê³ ë„í™” (Plex)\n        - [nextcloud](https://nextcloud.com/) ì„œë¹„ìŠ¤ ì˜¤í”ˆ (ì§€ì¸ ëŒ€ìƒ)\n        - ëª¨ë°”ì¼ ì›¹ì•± 3ê°œ ë§Œë“¤ê¸° (ë¯¸ë””ì–´ ê´€ë¦¬, ì½”ë¯¹ ë·°ì–´, ìŠ¤íŠ¸ë¦¬ë°)\n        - ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬"
    },
    {
      "id": "devops/circleci-ecs/",
      "metadata": {
        "permalink": "/devops/circleci-ecs/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-06-30-circleci-ecs.md",
        "source": "@site/blog/2019-06-30-circleci-ecs.md",
        "title": "CircleCIë¡œ AWS BATCH(ECS) CI/CD Pipeline êµ¬ì„±",
        "description": "ì´ì „ í¬ìŠ¤íŒ…ì—ì„œ EKS í´ëŸ¬ìŠ¤í„°ì™€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í…ŒìŠ¤íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ í•´ë´¤ë‹¤.  ì´ë²ˆì—ëŠ” AWS ECS ë˜ëŠ” AWS Batch Applicationì„ CircleCIë¥¼ í†µí•´ ë°°í¬ ë° ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²ƒì„ ì•Œì•„ë³¸ë‹¤.",
        "date": "2019-06-30T00:00:00.000Z",
        "formattedDate": "June 30, 2019",
        "tags": [
          {
            "label": "DevOps",
            "permalink": "/tags/dev-ops"
          },
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Pipeline",
            "permalink": "/tags/pipeline"
          },
          {
            "label": "CircleCI",
            "permalink": "/tags/circle-ci"
          },
          {
            "label": "GitHub",
            "permalink": "/tags/git-hub"
          },
          {
            "label": "GitOps",
            "permalink": "/tags/git-ops"
          },
          {
            "label": "ECS",
            "permalink": "/tags/ecs"
          },
          {
            "label": "AWS Batch",
            "permalink": "/tags/aws-batch"
          }
        ],
        "readingTime": 10.595,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "CircleCIë¡œ AWS BATCH(ECS) CI/CD Pipeline êµ¬ì„±",
          "comments": true,
          "classes": "wide",
          "slug": "devops/circleci-ecs/",
          "date": "2019-06-30T00:00:00.000Z",
          "categories": [
            "DevOps"
          ],
          "tags": [
            "DevOps",
            "CI/CD",
            "Pipeline",
            "CircleCI",
            "GitHub",
            "GitOps",
            "ECS",
            "AWS Batch"
          ]
        },
        "prevItem": {
          "title": "2019 Retrospective",
          "permalink": "/retrospective/2020plan/"
        },
        "nextItem": {
          "title": "CircleCI - GitHub ì—°ë™ ë° EKS êµ¬ì„±í•˜ê¸°",
          "permalink": "/devops/circleci/"
        }
      },
      "content": "[ì´ì „ í¬ìŠ¤íŒ…](https://ddii.dev/devops/circleci/)ì—ì„œ EKS í´ëŸ¬ìŠ¤í„°ì™€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í…ŒìŠ¤íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ í•´ë´¤ë‹¤.  ì´ë²ˆì—ëŠ” AWS ECS ë˜ëŠ” AWS Batch Applicationì„ CircleCIë¥¼ í†µí•´ ë°°í¬ ë° ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²ƒì„ ì•Œì•„ë³¸ë‹¤.  \n\n## Application ìš”êµ¬ì‚¬í•­\nê¸°ë³¸ì ìœ¼ë¡œ í˜„ì¬ ì—…ë¬´ ì¤‘ì— IBMí´ë¼ìš°ë“œì—ì„œ AWSë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ëŠ” ì—…ë¬´ê°€ ìƒê²¨ì„œ ì‹œì‘ë˜ì—ˆê³  ì •ê¸°ì ìœ¼ë¡œ ë§¤ì¼ ìƒˆë²½ì— í¬ë¡¤ë§(Pull)ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³µì œí•´ì•¼í•˜ëŠ” Use-Caseë¥¼ êµ¬í˜„í•´ì•¼ í–ˆë‹¤.  \nCI/CD Pipelineêµ¬ì„±ì´ ì£¼ ëª©ì ìœ¼ë¡œ Applicationêµ¬í˜„ì€ í¬ìŠ¤íŒ… ë‚´ìš©ì—ì„œ ì œì™¸í•˜ì˜€ë‹¤.  \n\n### ê¸°ë³¸ ìš”êµ¬ì‚¬í•­\n* Github Account\n* CircleCI Account (Github Auth)\n* AWS ECR(Elastic Container Registry)\n* AWS Batch(ECS) \n\n## CI/CD êµ¬ì„±ì•ˆ\n\nì‹¤ì œ í”„ë¡œì íŠ¸ì— ì ìš©í•  êµ¬ì„±ì•ˆì´ë‹¤.  \nê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  êµ¬ì„±ì€ ìµœëŒ€í•œ ë¹„ìš©ì´ ë“¤ì§€ ì•Šê³  AWS ì¢…ì†ì„±ì„ ì œê±°í•œ ë°©ë²•ìœ¼ë¡œ êµ¬ì„±í•˜ì˜€ë‹¤.  \n\n* Code Repository : Github\n* CI : CircleCI\n* Registry : AWS ECR\n* CD : CircleCI\n* Target : AWS Batch(ECS)\n* Notification : Slack\n\nì´ë²ˆ ë°ëª¨ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì§„í–‰í•˜ë ¤ê³  í•œë‹¤.  \n1. Terraformìœ¼ë¡œ AWS Batch ìƒì„±\n2. Githubì— ìˆ˜ì •ëœ Batch Code(Shell Script) Commit & Triggering CircleCI\n3. Docker Build & AWS ECRë¡œ Push\n4. S3ë¡œ myjob shell íŒŒì¼ ë³µì‚¬\n5. AWS Batch(ECS) Job Definition ë³€ê²½(Change Image)\n\n### AWS Batch\nê¸°ë³¸ì ìœ¼ë¡œ Batch ì»´í“¨íŒ…ì„ ëª©ì ìœ¼ë¡œ í•˜ëŠ” ì„œë¹„ìŠ¤ë¡œ ì»´í“¨íŒ… íƒ€ì…ì„ Fargate ë˜ëŠ” EC2 ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë™ì ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•˜ëŠ” ì„œë¹„ìŠ¤ì´ë‹¤.  \nì´ˆê¸° ì„¤ì •ì´ ë²ˆê±°ë¡­ê¸´ í•˜ì§€ë§Œ í•œë²ˆ êµ¬ì„±í•˜ê³  ë‚˜ë©´ ë³„ë„ ê´€ë¦¬ê°€ í•„ìš”ì—†ê³  Batchì‘ì—…ì´ ë°œìƒí•˜ëŠ”ê²ƒê³¼ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë³´ê´€ë¹„ìš© ì´ì™¸ì—ëŠ” ì¶”ê°€ ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë¹„ìš©ì¸¡ë©´ì—ì„œ ì¥ì ì´ ìˆëŠ” ì„œë¹„ìŠ¤ì´ë‹¤.  \nìœ„ì—ì„œ ì´ì•¼ê¸°í•œ ì •ê¸°ì ìœ¼ë¡œ ìƒˆë²½ë§ˆë‹¤ í¬ë¡¤ë§(Pull)ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³µì œí•´ì•¼í•˜ëŠ” Use-Caseë¥¼ êµ¬í˜„í•˜ëŠ”ê²ƒì´ ì ë‹¹í•œ ì›Œí¬ë¡œë“œ êµ¬í˜„ë°©ë²•ì´ë¼ ìƒê°í–ˆê¸° ë•Œë¬¸ì— AWS Batch ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆë‹¤.  \n\nê°„ë‹¨í•œ Batch demoëŠ” [https://github.com/awslabs/aws-batch-helpers/](https://github.com/awslabs/aws-batch-helpers/)ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë©° CircleCIì—°ë™ì„ ìœ„í•´ Forkí›„  ì§„í–‰í•˜ì˜€ë‹¤.\n\nDemo Repository : [https://github.com/ddiiwoong/aws-batch-helpers/](https://github.com/ddiiwoong/aws-batch-helpers/)\n\n### CircleCI\nëª¨ë“  Pipelineì€ CircleCIê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ë‹¤.  í˜¹ìëŠ” AWS Code Commit, Pipelineì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠëƒê³  ë¬¸ì˜í•˜ì‹œëŠ” ë¶„ë“¤ë„ ìˆëŠ”ë° ë‹¤ìŒê³¼ ê°™ì€ ì´ìœ ë¡œ CircleCIë¥¼ ì„ íƒí•˜ì˜€ë‹¤.  \n\n* Fully Managed (Serverless)\n* AWS ì¢…ì†ì„± ìµœì†Œí™”  \n* Git, Registry, CDì˜ì—­ì˜ í™•ì¥ì„± ê³ ë ¤\n* AWS Console ì ‘ì† ìµœì†Œí™”\n* ì‰½ê³  ë‹¨ìˆœí•˜ê²Œ ë¹Œë“œ í™˜ê²½êµ¬ì„±\n* ì†Œê·œëª¨ í”„ë¡œì íŠ¸ ë¹ ë¥´ê²Œ ì‹œì‘ ê°€ëŠ¥\n\n### Amazon Elastic Container Registry (ECR)\nê°œì¸ì ìœ¼ë¡œ RegistryëŠ” êµ¬ì¶•í˜•ë³´ë‹¤ëŠ” Managedì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤ê³  ë³´ê¸° ë•Œë¬¸ì— Webhookì„ Nativeí•˜ê²Œ ì§€ì›í•˜ëŠ” DockerHubë„ ëŒ€ì²´ ê°€ëŠ¥í•˜ë‹¤ê³  ìƒê°í•œë‹¤.  \n* Fully Managed\n* Security (IAM) ì—°ë™\n* CircleCI Orbs ì œê³µ\n* EKS, ECS ì—°ë™ ìš©ì´\n\n### Terraform\n\n[https://www.terraform.io/docs/providers/aws/index.html](https://www.terraform.io/docs/providers/aws/index.html)  \n\nì„ ì–¸ì  ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê´€ë¦¬ ë„êµ¬ë¡œ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë„êµ¬ì´ë©° Docsì™€ ë¸”ë¡œê·¸ ìë£Œê°€ ë§ì€ ê´€ê³„ë¡œ ë”°ë¡œ ì„¤ëª…í•˜ì§€ ì•Šê² ë‹¤.  \nì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” AWS Batchë¥¼ ìƒì„±í•˜ëŠ” ì˜ì—­ì„ Terraformì´ ë‹´ë‹¹í•œë‹¤.  \n\n## CircleCI Config ì‘ì„±\n```yaml\nversion: 2.1\norbs:\n  aws-ecr: circleci/aws-ecr@6.1.0\n  aws-ecs: circleci/aws-ecs@0.0.8\n  aws-s3: circleci/aws-s3@1.0.11\n  aws-cli: circleci/aws-cli@0.1.13\njobs:\n  sh-s3-upload:\n    docker:\n      - image: 'circleci/python:2.7'\n    steps:\n      - checkout\n      - aws-s3/copy:\n          from: ./myjob.sh\n          to: 's3://batch-ecr-test/myjob.sh'\n  deploy-batch:\n    executor: aws-cli/default\n    steps:\n      - checkout\n      - aws-cli/install\n      - run:\n          name: Update AWS Batch Job\n          command: |\n            aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties '{ \"image\": \"823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623\", \"vcpus\": 1, \"memory\": 512}'\nworkflows:\n  build-and-deploy:\n    jobs:\n      - aws-ecr/build-and-push-image:\n          repo: $AWS_RESOURCE_NAME_PREFIX\n          tag: v20190623\n      - sh-s3-upload:\n          name: sh-s3-upload\n          requires:\n            - aws-ecr/build-and-push-image\n      - deploy-batch:\n          name: deploy-batch\n          requires:\n            - sh-s3-upload\n```\n\në‹¨ê³„ë³„ ì„¤ëª…ì„ ìœ„í•´ ë¶€ë¶„ì ìœ¼ë¡œ ì„¤ëª…í•˜ë„ë¡ í•˜ê² ë‹¤.  \n1. Terraformìœ¼ë¡œ Batch ë°°í¬\n    ```json\n    resource \"aws_batch_compute_environment\" \"default\"{ \n      compute_environment_name = \"env_fetch_and_run\" \n      compute_resources { \n        instance_role = \"arn:aws:iam::823928750534:instance-profile/ecsInstanceRole\" \n        instance_type = [\n          \"optimal\",\n        ]\n        desired_vcpus = 1 \n        max_vcpus = 1 \n        min_vcpus = 0 \n        security_group_ids = [\n          \"sg-0632cf81b5c4dff17\" \n        ]\n        subnets = [\n          \"subnet-0c4f8135b536e8fab\",\n          \"subnet-0a261950d894cf27e\"\n        ] \n        type = \"EC2\" \n      } \n      service_role = \"arn:aws:iam::823928750534:role/service-role/AWSBatchServiceRole\" \n      type =\"MANAGED\"\n    }\n    ```\n    Batch Computing í™˜ê²½ì„ êµ¬ì„±í•˜ê²Œ ë˜ëŠ”ë° `\"aws_batch_compute_environment\"`ë¥¼ ì‚¬ìš©í•œë‹¤.  \n    * compute_environment_name : (í•„ìˆ˜) ì»´í“¨íŒ… í™˜ê²½ ì´ë¦„\n    * compute_resources.instance_role : (í•„ìˆ˜) EC2ì— ì ìš©ë˜ëŠ” Role\n    * compute_resources.instance_type : (í•„ìˆ˜) ì‚¬ìš© ê°€ëŠ¥í•œ instance ìœ í˜•\n    * compute_resources.desired_vcpus : (ì˜µì…˜) ì›í•˜ëŠ” CPUìˆ˜\n    * compute_resources.max_vcpus : (í•„ìˆ˜) ìµœëŒ€ CPUìˆ˜  \n    * compute_resources.min_vcpus : (í•„ìˆ˜) ìµœì†Œ CPUìˆ˜\n    * compute_resources.security_group_ids : (í•„ìˆ˜) EC2ì— ì ìš©ë˜ëŠ” Security Group\n    * compute_resources.subnets : (í•„ìˆ˜) Subnets ëª©ë¡\n    * compute_resources.type : (í•„ìˆ˜) EC2ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±, SPOT instance ì‚¬ìš©ê°€ëŠ¥  \n    * service_role : (í•„ìˆ˜) AWS Batchê°€ ë‹¤ë¥¸ AWS ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œ í• ìˆ˜ìˆê²Œ í•´ì£¼ëŠ” IAM Role(ARN)\n    * type : (í•„ìˆ˜) MANAGEDë‚˜ UNMANAGEDë¥¼ ì„ íƒí•  ìˆ˜ ìˆê³ , MANAGEDì˜ ê²½ìš° compute_resourcesì— ì„¸ë¶€ ì‚¬í•­ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.  \n\n    ```json\n    resource \"aws_batch_job_definition\" \"default\" {\n      name = \"fetch_and_run\" \n      type = \"container\"\n\n      container_properties = <<CONTAINER_PROPERTIES\n    {\n        \"command\": [],\n        \"image\": \"823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623\",\n        \"vcpus\": 1,\n        \"memory\": 512,\n        \"volumes\": [],\n        \"environment\": [],\n        \"mountPoints\": [],\n        \"ulimits\": [] \n    }\n    CONTAINER_PROPERTIES\n    }\n    ```\n    Job Definition ì •ì˜(\"aws_batch_job_definition\")ì—ì„œëŠ” Resource spec ë° Command(Docker RUN), Container IMAGE ë“±ì„ ì„ ì–¸í•˜ê²Œ ëœë‹¤.  \n    * name : (í•„ìˆ˜) Job Definition ì´ë¦„\n    * type : (í•„ìˆ˜) Job Definition ìœ í˜•, ECSë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ containerë¡œ ì„ íƒ\n    * container_properties : (ì„ íƒ) JSON í˜•íƒœë¡œ ì‘ì„±í•˜ëŠ” container ì†ì„±ì •ë³´ (Image, Resources, Command, MountPoint ë“±)\n\n2. .circleci/config.ymlì— CircleCI ë²„ì „ ëª…ì‹œ ë° ê´€ë ¨ orb(ecr,ecs,s3,cli) ì¶”ê°€  \n    ê¸°ë³¸ì ìœ¼ë¡œ 2.1ë¡œ ì„¤ì •ì„ í•´ì•¼ ecs, eks orb ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.\n    ```yaml\n    version: 2.1\n      orbs:\n        aws-ecr: circleci/aws-ecr@6.1.0\n        aws-ecs: circleci/aws-ecs@0.0.8\n        aws-s3: circleci/aws-s3@1.0.11\n        aws-cli: circleci/aws-cli@0.1.13\n    ```\n\n3. workflow êµ¬ì„±\n\n    `build-and-push-image` -> `sh-s3-upload` -> `deploy-batch` ìˆœìœ¼ë¡œ ìˆœì°¨ì ìœ¼ë¡œ pipelineêµ¬ì„±ì„ í•˜ì˜€ë‹¤.  \n\n    ```\n    workflows:\n      build-and-deploy:\n        jobs:\n          - aws-ecr/build-and-push-image:\n              repo: $AWS_RESOURCE_NAME_PREFIX # data-crawler-test\n              tag: v20190623\n              # create-repo: true\n              # dockerfile: Dockerfile\n          - sh-s3-upload:\n              name: sh-s3-upload\n              requires:\n                - aws-ecr/build-and-push-image\n          - deploy-batch:\n              name: deploy-batch\n              requires:\n                - sh-s3-upload\n    ```\n\n    ê¸°ë³¸ì ìœ¼ë¡œ CircleCIì—ì„œëŠ” orb jobì„ [orb name]/[predefined-job] í˜•ì‹ìœ¼ë¡œ ì„ ì–¸í•œë‹¤.  \n\n    I. ì²«ë²ˆì§¸ stepì—ì„œëŠ” container imageë¥¼ buildí•˜ê³  pushí•˜ëŠ” Jobì„ ìˆ˜í–‰í•˜ë¯€ë¡œ `aws-ecr/build-and-push-image`ì„ ì„ ì–¸í•œë‹¤.  \n    ìì„¸í•œ ë‚´ìš©ì€ [https://circleci.com/orbs/registry/orb/circleci/aws-ecr](https://circleci.com/orbs/registry/orb/circleci/aws-ecr)ë¥¼ í™•ì¸í•˜ì.  \n\n    II. ë‘ë²ˆì§¸ stepì—ì„œëŠ” S3ì— ë°°ì¹˜ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì˜¬ë¦¬ëŠ” Custom Jobì„ ìˆ˜í–‰í•œë‹¤.  Jobì€ Stepì˜ ëª¨ìŒìœ¼ë¡œ ì„ í–‰ë˜ì–´ì•¼í•  Jobì€ ìƒìœ„ì— `requires:` ì—ì„œ ì„ ì–¸í•˜ë©´ ëœë‹¤.  \n\n    III. ì„¸ë²ˆì§¸ stepì—ì„œëŠ” AWS Batch job definitionì˜ container imageë¥¼ êµì²´(revision ë³€ê²½)í•˜ëŠ” Custom Jobì„ ìˆ˜í–‰í•œë‹¤.  \n\n4. custom job êµ¬ì„±\n    Workflowì—ì„œ ì„ ì–¸í•œ Custom Jobì˜ ìƒì„¸ definitionì„ ê¸°ì¬í•œë‹¤.  \n    ```yaml\n    jobs:\n      sh-s3-upload:\n        docker:\n          - image: 'circleci/python:2.7'\n        steps:\n          - checkout\n          - aws-s3/copy:\n              from: ./myjob.sh\n              to: 's3://batch-ecr-test/myjob.sh'\n      deploy-batch:\n        executor: aws-cli/default\n        steps:\n          - aws-cli/install\n          - run:\n              name: Update AWS Batch Job\n              command: |\n                aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties '{ \"image\": \"823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623\", \"vcpus\": 1, \"memory\": 512}'\n    ```\n    I. `sh-s3-upload` ì—ì„œëŠ” `aws-s3/copy` ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” S3ë²„í‚·ì— ì‚¬ìš©í•  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë¡œë“œ í•œë‹¤.  `checkout`ì—ì„œëŠ” í˜„ì¬ ìƒíƒœì˜ git repoë¥¼ cloneí•˜ê²Œ ëœë‹¤.  \n\n    II. `deploy-batch` ì—ì„œëŠ” `aws-cli/install` ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ì— ì‘ì„±í•œ Batch Job definitionì„ awsclië¡œ ì›í•˜ëŠ” ìƒˆë¡œìš´ imageë¡œ ì—…ë°ì´íŠ¸ í•˜ê²Œ ëœë‹¤.  \n\n## CircleCI ì‹¤í–‰\në¹Œë“œ ë° ë°°í¬ê³¼ì •ì„ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ë©´ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ë˜ë©´ CircleCIëŠ” í•´ë‹¹ ì €ì¥ì†Œì˜ `.circleci/config.yml` ì„ ê¸°ì¤€ìœ¼ë¡œ ë¹Œë“œ ë° ë°°í¬ë¥¼ ì‹œì‘í•˜ê²Œ ëœë‹¤.  \n\n## README.mdì— Build Status Badge ë‹¬ê¸°\n[https://circleci.com/docs/2.0/status-badges/](https://circleci.com/docs/2.0/status-badges/)  \n\n![badge](/img/circle-badge.png)\nìœ„ ë§í¬ì™€ ì„¤ì •ì„ ì°¸ê³ í•˜ì—¬ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ Build Statud Badgeë¥¼ ë‹¬ ìˆ˜ ìˆë‹¤.  \n\n![badge](/img/circle-badge-ss.png)\n\n## ì •ë¦¬\nì´ë²ˆì—ëŠ” CircleCIë¥¼ ê°€ì§€ê³  AWS Batch jobì„ êµ¬ì„±í•˜ëŠ” ë°ëª¨ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.  \n\nì–¼ë§ˆì „ì¸ê°€ì—ë„ [ì–´í˜•ë¶€í˜•](https://github.com/leoh0)ë‹˜ê»˜ì„œë„ ì–¸ê¸‰í•˜ì‹  ì„ ì–¸ì ì¸ êµ¬ì„± ê¸°ë°˜ì— ìµœëŒ€í•œ serverless í™˜ê²½ì—ì„œì˜ ë°°í¬ë¥¼ ì¶”êµ¬í•˜ê²Œ ë˜ë‹¤ ë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì€ `CI/CD Pipeline ì‹œë‚˜ë¦¬ì˜¤`ë¥¼ êµ¬ìƒí•˜ê²Œ ë˜ì—ˆë‹¤.  \n\n![cicd](/img/circlecicd.png)\n\nìƒˆë¡œìš´ ê¸°ëŠ¥ì˜ ë¸Œëœì¹˜(New Feature)ê°€ Gitì— pushë˜ë©´ ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ê°€ íŠ¸ë¦¬ê±°ë˜ì–´ ìë™ìœ¼ë¡œ ì§„í–‰ë˜ê³  ë™ì‹œì— ê°œë°œìê°€ PRì„ ì‘ì„±í•˜ë©´ ë™ë£Œ ë° ë‹´ë‹¹ ìƒê¸‰ìì—ê²Œ ì½”ë“œ ë¦¬ë·°ë¥¼ ë°›ê²Œ ëœë‹¤.  \n\në¦¬ë·°ê°€ í†µê³¼ë˜ê³  CircleCIì—ì„œ ë¹Œë“œê°€ ì„±ê³µí–ˆë‹¤ë©´ ìŠ¹ì¸ë‹¨ê³„ë¥¼ í†µí•´ Mergeë¥¼ í•˜ê³  CircleCI ê°€ í•œ ë²ˆ ë” ë¹Œë“œë¥¼ ì‹œì‘í•˜ê³  ë°°í¬ê¹Œì§€ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤.  \n\nECSë‚˜ Batchë¡œ ë°°í¬ëŠ” CircleCIë¥¼ í†µí•´ ì§ì ‘ ë°°í¬ë¥¼ í•˜ê³  EC2ë‚˜ EKSë¡œì˜ ë°°í¬ëŠ” Terraform ë° ArgoCDë¥¼ í†µí•´ ë°°í¬ë¥¼ ì§„í–‰í•˜ëŠ” ë°©ì‹ì´ë‹¤.  \n\në‹¤ìŒë²ˆ í¬ìŠ¤íŒ…ì—ëŠ” ìœ„ ê·¸ë¦¼ ê¸°ë°˜ìœ¼ë¡œ CircleCIì™€ ArgoCDë¥¼ í™œìš©í•˜ì—¬ EKSê¸°ë°˜ ë°°í¬ê³¼ì •ì„ ì •ë¦¬í•  ì˜ˆì •ì´ë‹¤.  \n\n[![ko-fi](https://www.ko-fi.com/img/githubbutton_sm.svg)](https://ko-fi.com/X8X1W6OZ)"
    },
    {
      "id": "devops/circleci/",
      "metadata": {
        "permalink": "/devops/circleci/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-06-18-circleci.md",
        "source": "@site/blog/2019-06-18-circleci.md",
        "title": "CircleCI - GitHub ì—°ë™ ë° EKS êµ¬ì„±í•˜ê¸°",
        "description": "CI/CDëŠ” ê°œë°œë‹¨ê³„ì—ì„œ ì§€ì†ì ì¸ í†µí•©, ë°°í¬ë¥¼ í†µí•´ íš¨ìœ¨ì„±ì„ ë†’ì—¬ì£¼ëŠ” ë„êµ¬ë¼ê³  ë§í• ìˆ˜ ìˆë‹¤.  íŠ¹íˆ GitOpsê°€ ì¤‘ìš”ì‹œ ë˜ëŠ” ìµœê·¼ íŠ¸ë Œë“œì—ì„œ Public Gitì„œë¹„ìŠ¤ì™€ í†µí•©ì€ í•„ìˆ˜ì ì¸ ìš”ì†Œì´ë‹¤.",
        "date": "2019-06-18T00:00:00.000Z",
        "formattedDate": "June 18, 2019",
        "tags": [
          {
            "label": "DevOps",
            "permalink": "/tags/dev-ops"
          },
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Pipeline",
            "permalink": "/tags/pipeline"
          },
          {
            "label": "CircleCI",
            "permalink": "/tags/circle-ci"
          },
          {
            "label": "GitHub",
            "permalink": "/tags/git-hub"
          },
          {
            "label": "GitOps",
            "permalink": "/tags/git-ops"
          },
          {
            "label": "EKS",
            "permalink": "/tags/eks"
          }
        ],
        "readingTime": 10.68,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "CircleCI - GitHub ì—°ë™ ë° EKS êµ¬ì„±í•˜ê¸°",
          "comments": true,
          "classes": "wide",
          "slug": "devops/circleci/",
          "date": "2019-06-18T00:00:00.000Z",
          "categories": [
            "DevOps"
          ],
          "tags": [
            "DevOps",
            "CI/CD",
            "Pipeline",
            "CircleCI",
            "GitHub",
            "GitOps",
            "EKS"
          ]
        },
        "prevItem": {
          "title": "CircleCIë¡œ AWS BATCH(ECS) CI/CD Pipeline êµ¬ì„±",
          "permalink": "/devops/circleci-ecs/"
        },
        "nextItem": {
          "title": "Yaml ì‘ì„± ê¸°ë³¸ Tip",
          "permalink": "/kubernetes/CKAD-1/"
        }
      },
      "content": "CI/CDëŠ” ê°œë°œë‹¨ê³„ì—ì„œ ì§€ì†ì ì¸ í†µí•©, ë°°í¬ë¥¼ í†µí•´ íš¨ìœ¨ì„±ì„ ë†’ì—¬ì£¼ëŠ” ë„êµ¬ë¼ê³  ë§í• ìˆ˜ ìˆë‹¤.  íŠ¹íˆ GitOpsê°€ ì¤‘ìš”ì‹œ ë˜ëŠ” ìµœê·¼ íŠ¸ë Œë“œì—ì„œ Public Gitì„œë¹„ìŠ¤ì™€ í†µí•©ì€ í•„ìˆ˜ì ì¸ ìš”ì†Œì´ë‹¤. \n\n[GitHub MarketPlace](https://github.com/marketplace)ì—ì„œ `CI` ë¼ê³  ê²€ìƒ‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ìˆ˜ ìˆë‹¤.  \n\n![github-ci](/img/github-ci.png)\n\nCircleCI, Travis CI, Google Cloud Build ë“± ìµœê·¼ íŠ¸ë Œë“œí•œ ë„êµ¬ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” `CircleCI`ë¥¼ `GitHub`ê³¼ ì—°ë™í•´ì„œ AWS ECR Push ë° EKSë¡œ ë°°í¬í•˜ëŠ” ê°„ë‹¨í•œ Pipelineì„ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì„ ì ì–´ë³´ê³ ì í•œë‹¤.  \n\n## CircleCI - GitHub Accout ì—°ë™\n\n[circleci.com](https://circleci.com)ì— ì ‘ì†í•˜ì—¬ Sign Upì„ ì§„í–‰í•˜ë©´ GitHubê³¼ BitBucket ê³„ì •ì„ ì—°ë™í•  ìˆ˜ ìˆëŠ”ë° ì¼ë°˜ì ì¸ GitHub 3rd Party OAuthì—°ë™ ì§„í–‰ì„ í•˜ê²Œëœë‹¤.  \n\n![init](/img/circleci-init.png)\n\nìœ„ ê·¸ë¦¼ì²˜ëŸ¼ ëª¨ë“  Repositoryê°€ í™•ì¸ë˜ê³  Followí•  Repositoryë¥¼ ì„ íƒí•˜ë©´ ì´ˆê¸° êµ¬ì„±ì´ ì™„ë£Œëœë‹¤.  \n\n![error](/img/init-error.png)\n\nì²« ì—°ë™ì´ ë˜ë©´ Buildë¥¼ ì§„í–‰í•˜ê²Œ ë˜ëŠ”ë° ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ errorë¥¼ ë³´ê²Œ ë˜ëŠ”ë° ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ circleciê°€ í•„ìš”ë¡œ í•˜ëŠ” ê¸°ë³¸ ì„¤ì •ê°’(.circleci/config.yaml)ì´ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ì´ë‹¤.  \n\n```sh\n#!/bin/sh -eo pipefail\n# No configuration was found in your project. Please refer to https://circleci.com/docs/2.0/ to get started with your configuration.\n# \n# -------\n# Warning: This configuration was auto-generated to show you the message above.\n# Don't rerun this job. Rerunning will have no effect.\nfalse\n```\n\nìœ„ì—ì„œ ë³´ì´ëŠ”ê²ƒ ì²˜ëŸ¼ configë¥¼ ì²´í¬í•˜ëŠ”ê²ƒë„ í•˜ë‚˜ì˜ ê°€ìƒë¨¸ì‹ (ì»¨í…Œì´ë„ˆ)ì´ ì§„í–‰í•˜ëŠ”ë° CircleCIì½˜ì†”ì—ì„œ `Spin up Environment` ë¡œê·¸ë¥¼ ë³´ë©´ Docker(18.09.6)ë¡œ aws Linuxê¸°ë°˜ìœ¼ë¡œ í™˜ê²½êµ¬ì„±ì„ í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.\n\n```sh\nBuild-agent version 1.0.11727-b0960fc9 (2019-05-23T02:12:54+0000)\nDocker Engine Version: 18.09.6\nKernel Version: Linux 9a20a41aeae4 4.15.0-1035-aws #37-Ubuntu SMP Mon Mar 18 16:15:14 UTC 2019 x86_64 Linux\nStarting container bash:4.4.19\n  using image bash@sha256:9f0a4aa3c9931bd5fdda51b1b2b74a0398a8eabeaf9519d807e010b9d9d41993\n...\n```\n## CircleCI Grossary\n\nì•„ë˜ ë§í¬ëŠ” CircleCIì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ë“¤ì„ ë”°ë¡œ ì •ë¦¬í•œ í˜ì´ì§€ì´ë‹¤.  ì£¼ë¡œ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ìš©ì–´ë“¤ì€ Dockerì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ê³¼ ê²¹ì¹˜ëŠ” ë¶€ë¶„ì´ ë§ë‹¤.   \n\n[https://circleci.com/docs/2.0/glossary/](https://circleci.com/docs/2.0/glossary/)\n\nìœ„ ë§í¬ ë‚´ìš©ì„ í™•ì¸í•˜ë©´ `Orbs`ë¼ëŠ” ìš©ì–´ê°€ ë‚˜ì˜¤ëŠ”ë° ì´ëŠ” ê³µìœ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ë¡œ Jenkinsì˜ Pluginê³¼ ìœ ì‚¬í•œ ê°œë…ì´ë¼ê³  ë³´ë©´ ëœë‹¤. CircleCIì—ì„œ ì œê³µí•˜ëŠ” ìì²´ íŒ¨í‚¤ì§€ ë¿ë§Œ ì•„ë‹ˆë¼ 3rd Party orbsë¥¼ ì œê³µí•˜ê³  ìˆë‹¤. \n\nMacOSì—ì„œëŠ” brewë¥¼ í†µí•´ clië¥¼ ì„¤ì¹˜í•˜ê³  orb ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ê±°ë‚˜ [https://circleci.com/orbs/registry/](https://circleci.com/orbs/registry/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n\n```sh\n$ brew install circleci\n$ circleci orb list\nOrbs found: 43. Showing only certified orbs.\nAdd --uncertified for a list of all orbs.\n\ncircleci/android (0.1.0)\ncircleci/artifactory (1.0.0)\ncircleci/aws-cli (0.1.13)\ncircleci/aws-code-deploy (0.0.9)\ncircleci/aws-ecr (6.1.0)\ncircleci/aws-ecs (0.0.8)\ncircleci/aws-eks (0.1.0)\ncircleci/aws-s3 (1.0.11)\n...\ncircleci/jira (1.0.5)\ncircleci/jq (1.9.0)\ncircleci/kubernetes (0.3.0)\ncircleci/lein-nvd (0.0.2)\ncircleci/maven (0.0.8)\ncircleci/node (1.0.1)\n...\ncircleci/slack (3.2.0)\ncircleci/twilio (0.0.1)\ncircleci/welcome-orb (0.3.1)\n\nIn order to see more details about each orb, type: `circleci orb info orb-namespace/orb-name`\n\nSearch, filter, and view sources for all Orbs online at https://circleci.com/orbs/registry/\n```\n\n## Circle Architecture\n\n![circle-arch](https://circleci.com/docs/assets/img/docs/arch.png)\n\nGitHub ë˜ëŠ” Bitbucketì—ì„œ ê´€ë¦¬í•˜ëŠ” Repositoryê°€ CircleCI í”„ë¡œì íŠ¸ë¡œ ìŠ¹ì¸ë˜ë©´ ìµœì´ˆì—ëŠ” ì»¨í…Œì´ë„ˆë‚˜ ê°€ìƒë¨¸ì‹ í™˜ê²½(2core 4GB)ì´ í”„ë¡œë¹„ì €ë‹ ë˜ê³  ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ê°€ ì§„í–‰ëœë‹¤.  \n\ní…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ í›„ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ì— ëŒ€í•œ Alertì„¤ì •(Email, Slack)ì´ ê°€ëŠ¥í•˜ê³  ê° ë‹¨ê³„(job, workflow)ì— ëŒ€í•œ ê²°ê³¼ëŠ” ê° ë‹¨ê³„ë³„ ì„¸ë¶€ ì •ë³´ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\në˜í•œ ë°°í¬ëŠ” AWS CodeDeploy, AWS ECS, AWS S3, AWS EKS, Google Kubernetes Engine (GKE) ë° Heroku ë“± ë‹¤ì–‘í•œ í™˜ê²½ì— ì½”ë“œë¥¼ ë°°í¬í•˜ë„ë¡ êµ¬ì„± í•  ìˆ˜ ìˆë‹¤. ì´ì™¸ì˜ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ë°°í¬ëŠ” SSHë¥¼ í†µí•´ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜ terraformê³¼ ê°™ì€ ë„êµ¬ë¥¼ ê°€ì§€ê³  í•´ë‹¹ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì˜ APIí†µí•´ ìë™í™”ê°€ ê°€ëŠ¥í•œ êµ¬ì¡°ë¡œ ë˜ì–´ìˆë‹¤.  \n\n## CircelCI AWS EKS\n\n[https://github.com/CircleCI-Public/circleci-demo-aws-eks](https://github.com/CircleCI-Public/circleci-demo-aws-eks)\n\nìœ„ demoëŠ” CircleCIë¥¼ ì´ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ workflow (ìƒì„¸ë‚´ìš© ì•„ë˜ config.yaml ì°¸ê³ )ë¥¼ ìˆ˜í–‰í•œë‹¤.  \n\n```yaml\nversion: 2.1\n\norbs:\n    aws-eks: circleci/aws-eks@0.1.0\n    aws-ecr: circleci/aws-ecr@3.1.0\n    kubernetes: circleci/kubernetes@0.3.0\n```\nê³µí†µì ìœ¼ë¡œ orbë¥¼ 3ê°€ì§€ë¥¼ ì¶”ê°€í•˜ì˜€ê¸° ë•Œë¬¸ì— ê°ë‹¨ê³„ë§ˆë‹¤ ê´€ë ¨ orbë¥¼ ì¶”ê°€í•˜ëŠ” ë‹¨ê³„ë¥¼ ê±°ì¹˜ê²Œ ëœë‹¤.\n\n1. í™˜ê²½ì„¤ì • ë° Docker Build ë° ECRë¡œ Push\n  ```yaml\n  workflows:\n    deployment:\n      jobs:\n        - aws-ecr/build_and_push_image:\n            name: build-and-push-image\n            account-url: AWS_ECR_URL\n            region: AWS_DEFAULT_REGION\n            repo: eks_orb_demo_app\n            dockerfile: ~/project/demo_app/Dockerfile\n            path: ~/project/demo_app\n            tag: ${CIRCLE_SHA1}\n            # repositoryê°€ ì—†ì„ ê²½ìš° ìƒì„±í•˜ëŠ” ì˜µì…˜\n            # create-repo: true\n  ```\n  * environment variables ì„¤ì • \n    * Project - BUILD SETTINGS - Environment Variables ì—ì„œ Key-Valueí˜•íƒœë¡œ ì…ë ¥  \n      * AWS_DEFAULT_REGION : `us-west-2`\n      * AWS_ECR_URL : `219547004475.dkr.ecr.us-west-2.amazonaws.com/eks_orb_demo_app`  \n   * github ì—°ë™ (ssh-key ì—°ë™ ë° repo clone)\n   * aws cli ì„¤ì¹˜ ë° AWS Access, Secret Keyì„¤ì •\n   * ECR Login\n   * Image Build ([https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile](https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile))\n  * Push Image to ECR\n\n1. EKSí´ëŸ¬ìŠ¤í„° ìƒì„± (No Scripts)\n  ```yaml\n  workflows:\n    deployment:\n      jobs:\n        - aws-eks/create-cluster:\n            cluster-name: eks-orb-demo-app-deployment\n            aws-region: $AWS_DEFAULT_REGION\n            requires:\n              - build-and-push-image\n  ```\n  * kops, kubectl, aws iam authenticator, aws cli ì„¤ì¹˜\n  * kubectl config ì„¤ì • (aws iam authenticator)\n  * eksctl ì„¤ì¹˜\n  * eksctlë¡œ í´ëŸ¬ìŠ¤í„° ìƒì„± ë° ê²€ì¦ (Cloudformation)\n    * variables ì‚¬ì „ ì„¤ì •ê°€ëŠ¥ ($AWS_DEFAULT_REGION)\n\n2. Demo Application ë°°í¬\n  ```yaml\n  jobs:\n    deploy-application:\n      executor: aws-eks/python3\n      parameters:\n      ...\n      steps:\n        - checkout\n        - run:\n            name: Create deployment manifest\n            command: |\n              BUILD_DATE=$(date '+%Y%m%d%H%M%S')\n              cat deployment/demo-app-deployment.yaml.template |\\\n                sed \"s|DOCKER_IMAGE_NAME|<< parameters.docker-image-name >>|\\\n                  g;s|BUILD_DATE_VALUE|$BUILD_DATE|g;s|VERSION_INFO_VALUE|\\\n                  << parameters.version-info >>|g\" > deployment/demo-app-deployment.yaml\n        - aws-eks/update-kubeconfig-with-authenticator:\n            cluster-name: << parameters.cluster-name >>\n            install-kubectl: true\n            aws-region: << parameters.aws-region >>\n        - kubernetes/create-or-update-resource:\n            resource-file-path: \"deployment/demo-app-deployment.yaml\"\n            get-rollout-status: true\n            resource-name: deployment/demoapp\n        - kubernetes/create-or-update-resource:\n            resource-file-path: \"deployment/demo-app-service.yaml\"\n  ...\n  workflows:\n    deployment:\n      jobs:\n        - deploy-application:\n          cluster-name: eks-orb-demo-app-deployment\n          aws-region: $AWS_DEFAULT_REGION\n          docker-image-name: \"${AWS_ECR_URL}/eks_orb_demo_app:${CIRCLE_SHA1}\"\n          version-info: \"${CIRCLE_SHA1}\"\n          requires:\n            - aws-eks/create-cluster\n  ...\n  ```\n  * deployment manifestìƒì„± (deployment template)\n  * kops, kubectl, aws iam authenticator, aws cli ì„¤ì¹˜ (orbì„¤ì •: aws-eks,kubernetes)\n  * kubectl config ì„¤ì • (aws iam authenticator)\n  * resource(deployment, service) ë°°í¬ (orbì„¤ì •: aws-eks,kubernetes)\n  * rollout ìˆ˜í–‰ (0->3)\n\n3. application test\n  ```yaml\n  workflows:\n    deployment:\n      jobs:\n        - test-application:\n          name: test-application\n          cluster-name: eks-orb-demo-app-deployment\n          aws-region: $AWS_DEFAULT_REGION\n          expected-version-info: \"${CIRCLE_SHA1}\"\n          requires:\n            - deploy-application\n  jobs:\n    test-application:\n      executor: aws-eks/python3\n      parameters:\n        ...\n      steps:\n        - aws-eks/update-kubeconfig-with-authenticator:\n            cluster-name: << parameters.cluster-name >>\n            install-kubectl: true\n            aws-region: << parameters.aws-region >>\n        - run:\n            name: Wait for service to be ready\n            command: |\n              kubectl get pods\n              kubectl get services\n              sleep 30\n              for attempt in {1..20}; do\n                EXTERNAL_IP=$(kubectl get service demoapp | awk '{print $4}' | tail -n1)\n                echo \"Checking external IP: ${EXTERNAL_IP}\"\n                if [ -n \"${EXTERNAL_IP}\" ] && [ -z $(echo \"${EXTERNAL_IP}\" | grep \"pending\") ]; then\n                  break\n                fi\n                echo \"Waiting for external IP to be ready: ${EXTERNAL_IP}\"\n                sleep 10\n              done\n              sleep 180\n              curl -s --retry 10 \"http://$EXTERNAL_IP\" | grep \"<< parameters.expected-version-info >>\"\n  ```\n  * kops, kubectl, aws iam authenticator, aws cli ì„¤ì¹˜ (orbì„¤ì •: aws-eks,kubernetes)\n  * kubectl config ì„¤ì • (aws iam authenticator)\n  * External IP ì²´í¬ ë° curl í…ŒìŠ¤íŠ¸\n\n4. Demo Application ì‚­ì œ\n  ```yaml\n  jobs:  \n    undeploy-application:\n      executor: aws-eks/python3\n      parameters:\n      ...\n      steps:\n        - aws-eks/update-kubeconfig-with-authenticator:\n            cluster-name: << parameters.cluster-name >>\n            install-kubectl: true\n            aws-region: << parameters.aws-region >>\n        - kubernetes/delete-resource:\n            resource-types: \"deployment,service\"\n            label-selector: \"app=demo\"\n            wait: true\n        - run:\n            name: Check on pod status\n            command: |\n              kubectl get pods\n  workflows:\n    deployment:\n      jobs:\n        - undeploy-application:\n          cluster-name: eks-orb-demo-app-deployment\n          aws-region: $AWS_DEFAULT_REGION\n          requires:\n            - test-application\n  ```\n  * kops, kubectl, aws iam authenticator, aws cli ì„¤ì¹˜ (orbì„¤ì •: aws-eks,kubernetes)\n  * kubectl config ì„¤ì • (aws iam authenticator)\n  * deployment ì‚­ì œ ë° ìƒíƒœ ì²´í¬\n\n5. EKSí´ëŸ¬ìŠ¤í„° ì‚­ì œ (No Scripts)\n  ```yaml\n  workflows:\n    deployment:\n      jobs:\n        - aws-eks/delete-cluster:\n          cluster-name: eks-orb-demo-app-deployment\n          aws-region: $AWS_DEFAULT_REGION\n          wait: true\n          requires:\n            - undeploy-application\n  ```\n  * kops, kubectl, aws iam authenticator, aws cli ì„¤ì¹˜ (orbì„¤ì •: aws-eks,kubernetes)\n  * kubectl config ì„¤ì • (aws iam authenticator)\n  * eksctl ì„¤ì¹˜\n  * eksctlë¡œ í´ëŸ¬ìŠ¤í„° ì‚­ì œ ë° ê²€ì¦ (Cloudformation)\n\nìƒì„¸ configëŠ” ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n[https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml](https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml)\n\n## pipeline ìˆ˜í–‰\n\nìœ„ Workflowë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´ ë§ˆì§€ë§‰ì— ì–´í”Œë¦¬ì¼€ì´ì…˜ê³¼ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ workflowëŠ” ì œì™¸í•˜ê³  ìˆ˜í–‰í•œë‹¤. í•´ë‹¹ configë¥¼ commití•˜ë©´ ë°”ë¡œ í•´ë‹¹ CIê°€ íŠ¸ë¦¬ê±° ë˜ì–´ ì‹œì‘ë˜ê²Œ ëœë‹¤.\n\n```yaml\n      # - undeploy-application:\n      #     cluster-name: eks-orb-demo-app-deployment\n      #     aws-region: $AWS_DEFAULT_REGION\n      #     requires:\n      #       - test-application\n      # - aws-eks/delete-cluster:\n      #     cluster-name: eks-orb-demo-app-deployment\n      #     aws-region: $AWS_DEFAULT_REGION\n      #     wait: true\n      #     requires:\n      #     - undeploy-application\n```\n\n![result](/img/workflow-result.png)\n\ní´ëŸ¬ìŠ¤í„° êµ¬ì„±í¬í•¨í•´ì„œ ì´ 20ë¶„ì •ë„ ì†Œìš”ë˜ì—ˆë‹¤. ì‹¤ì œ `eksctl`ë¡œ í”„ë¡œë¹„ì €ë‹í•˜ê²Œ ë˜ë©´ CloudFormationìœ¼ë¡œ ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì— ì•½ 15-20ë¶„ ì •ë„ ì†Œìš”ë˜ë‹ˆ ê°„ë‹¨í•œ ë¹Œë“œ,ë°°í¬,í…ŒìŠ¤íŠ¸ëŠ” 5ë¶„ì •ë„ ì†Œìš”ëœê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.  \n\nì‚­ì œëŠ” ì—­ìˆœìœ¼ë¡œ ì§„í–‰í•˜ê±°ë‚˜ ìœ„ì— ì£¼ì„ ì²˜ë¦¬ëœ ì˜ì—­ë§Œ ìˆ˜í–‰í•˜ë©´ ëœë‹¤.\n\n## ì •ë¦¬\nê°„ë‹¨í•˜ê²Œ CircleCIë¥¼ ê°€ì§€ê³  GitOpsì™€ CI/CDë¥¼ êµ¬ì„±í•˜ëŠ” ë°ëª¨ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.  \n\nCircleCIëŠ” Jenkinsì™€ ìœ ì‚¬í•˜ì§€ë§Œ Publicì„œë¹„ìŠ¤ì´ê³  Slaveê´€ë¦¬ì— ëŒ€í•´ì„œ ì˜ì¡´ì ì´ì§€ ì•Šê¸° ë•Œë¬¸ì— ê¸°ì¡´ì— Jenkinsë¥¼ ì‚¬ìš©í•œ ê²½í—˜ì´ ìˆë‹¤ë©´ ì•„ì£¼ ì‰½ê²Œ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.  \n\n[https://circleci.com/docs/2.0/migrating-from-jenkins](https://circleci.com/docs/2.0/migrating-from-jenkins)ë¥¼ ì°¸ê³ í•˜ë©´ Jenkinsì™€ ì°¨ì´ì ì„ ì•Œ ìˆ˜ ìˆëŠ”ë° ê°€ì¥ í° ì¥ì ì€ ë³‘ë ¬ë¡œ í…ŒìŠ¤íŠ¸ë‚˜ Jobì„ ìˆ˜í–‰í• ìˆ˜ ìˆë‹¤ëŠ” ì ê³¼ Lambdaì™€ ê°™ì€ ì„œë²„ë¦¬ìŠ¤ ì•±ì„ ë°°í¬í• ë•Œ ì •ë§ ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ìœ¼ë¡œ êµ¬ì„±í• ìˆ˜ ìˆë‹¤ëŠ” ì ì´ë‹¤.  \n\nì´ëŠ” Git Repositoryë¥¼ ì—°ë™í• ë•Œë„ Java Pluginì„ ì„¤ì¹˜í•´ì•¼í•˜ëŠ” ë²ˆê±°ë¡œì›€ì„ ëœ ìˆ˜ ìˆë‹¤. ê°€ì¥ ì¤‘ìš”í•œê±´ SaaSë¼ëŠ” ì¥ì ë„ ë¬´ì‹œí• ìˆ˜ ì—†ë‹¤. Travis ë¬´ë£Œ í”Œëœê³¼ ë¹„êµí•´ë„ ì‘ì€ í”„ë¡œì íŠ¸ì˜ ê²½ìš° ë³„ë„ì˜ Docker environment(2core, 4GB)ë¥¼ ì œê³µë°›ê¸° ë•Œë¬¸ì— ì§€ì—°ì—†ì´ ë°”ë¡œ ë¹Œë“œê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì ì´ë‹¤.  \n\në‹¤ìŒë²ˆ í¬ìŠ¤íŒ…ì—ëŠ” terraformì„ í†µí•´ ECRê³¼ ECSë¡œ ë°°í¬í•˜ëŠ” workflowë¥¼ ì‚´í´ë³´ë ¤ê³  í•œë‹¤."
    },
    {
      "id": "kubernetes/CKAD-1/",
      "metadata": {
        "permalink": "/kubernetes/CKAD-1/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-06-10-CKAD-1.md",
        "source": "@site/blog/2019-06-10-CKAD-1.md",
        "title": "Yaml ì‘ì„± ê¸°ë³¸ Tip",
        "description": "CKADê²€ì •ì‹œ YAML ì‘ì„± tip",
        "date": "2019-06-10T00:00:00.000Z",
        "formattedDate": "June 10, 2019",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "CKAD",
            "permalink": "/tags/ckad"
          },
          {
            "label": "Exam",
            "permalink": "/tags/exam"
          },
          {
            "label": "Tip",
            "permalink": "/tags/tip"
          }
        ],
        "readingTime": 1.1,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Yaml ì‘ì„± ê¸°ë³¸ Tip",
          "comments": true,
          "classes": "wide",
          "description": "CKADê²€ì •ì‹œ YAML ì‘ì„± tip",
          "slug": "kubernetes/CKAD-1/",
          "date": "2019-06-10T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "CKAD",
            "Exam",
            "Tip"
          ]
        },
        "prevItem": {
          "title": "CircleCI - GitHub ì—°ë™ ë° EKS êµ¬ì„±í•˜ê¸°",
          "permalink": "/devops/circleci/"
        },
        "nextItem": {
          "title": "Knative on EKS",
          "permalink": "/kubernetes/knative-on-aws/"
        }
      },
      "content": "ìµœê·¼ í¬ìŠ¤íŒ…ì„ í•  ì—¬ìœ ê°€ ë˜ì§€ ì•Šì•„ ì¼ë‹¨ í‹ˆí‹ˆíˆ ì¤€ë¹„ì¤‘ì¸ CKAD ì¤€ë¹„í•˜ëŠ” íŒì´ë‚˜ ì •ë³´ë“±ì„ ë¨¼ì € ì •ë¦¬í•˜ê³ ì í•œë‹¤.  \nê·¸ì¤‘ ê¸°ë³¸ì´ ë˜ëŠ” YAMLì„ ìµœì´ˆ ì‘ì„±í• ë•Œ íŒì„ ì •ë¦¬í•´ë´¤ë‹¤.  \n\n## Manifest YAMLì‘ì„± Tip\nCLIì•ˆì—ì„œ Manifest YAMLíŒŒì¼ì„ ì‘ì„±í•˜ëŠ”ê²ƒì€ ì‰½ì§€ ì•Šë‹¤. íŠ¹íˆ ì‹œí—˜ì¤‘ì— Copy/Pasteë¥¼ í•˜ëŠ”ê²ƒì€ ì–´ë µê³  ëŠë¦¬ê²Œ ì§„í–‰ë ìˆ˜ ìˆìœ¼ë¯€ë¡œ CLIì•ˆì—ì„œ í•´ê²°í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤.\n\n### kubectl run í™œìš©\n[https://kubernetes.io/docs/reference/kubectl/conventions/](https://kubernetes.io/docs/reference/kubectl/conventions/#generators)\n\nìœ„ ë§í¬ë¥¼ ì˜ ê¸°ì–µí•´ë†“ê³  ì‹¤ì œ ì‹œí—˜ì„ ë³¼ë•Œ templateì‘ì„±ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ Manifestë¥¼ í•´ë³´ëŠ”ê²ƒì´ ê°€ì¥ ì¢‹ë‹¤.\n\n#### Pod Manifest YAML\n```sh\n$ kubectl run --generator=run-pod/v1 nginx --image=nginx --dry-run -o yaml\n```\n\n#### Deployment YAML\n```sh\n$ kubectl run --generator=deployment/v1beta1 nginx --image=nginx --dry-run --replicas=4 -o yaml\n```\n#### YAMLë¡œ ì €ì¥\n```sh\n$ kubectl run --generator=deployment/v1beta1 nginx --image=nginx --dry-run --replicas=4 -o yaml > nginx-deployment.yaml\n```"
    },
    {
      "id": "kubernetes/knative-on-aws/",
      "metadata": {
        "permalink": "/kubernetes/knative-on-aws/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-05-14-knative-on-aws.md",
        "source": "@site/blog/2019-05-14-knative-on-aws.md",
        "title": "Knative on EKS",
        "description": "EKSì—ì„œë„ Knativeë¥¼ êµ¬ì„±í•´ë³´ì",
        "date": "2019-05-14T00:00:00.000Z",
        "formattedDate": "May 14, 2019",
        "tags": [
          {
            "label": "Knative",
            "permalink": "/tags/knative"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "FaaS",
            "permalink": "/tags/faa-s"
          },
          {
            "label": "AWS",
            "permalink": "/tags/aws"
          },
          {
            "label": "Lambda",
            "permalink": "/tags/lambda"
          },
          {
            "label": "Serverless",
            "permalink": "/tags/serverless"
          },
          {
            "label": "EKS",
            "permalink": "/tags/eks"
          }
        ],
        "readingTime": 11.905,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Knative on EKS",
          "comments": true,
          "classes": "wide",
          "description": "EKSì—ì„œë„ Knativeë¥¼ êµ¬ì„±í•´ë³´ì",
          "slug": "kubernetes/knative-on-aws/",
          "date": "2019-05-14T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Knative",
            "Kubernetes",
            "FaaS",
            "AWS",
            "Lambda",
            "Serverless",
            "EKS"
          ]
        },
        "prevItem": {
          "title": "Yaml ì‘ì„± ê¸°ë³¸ Tip",
          "permalink": "/kubernetes/CKAD-1/"
        },
        "nextItem": {
          "title": "eksworkshop",
          "permalink": "/kubernetes/eksworkshop/"
        }
      },
      "content": "ì´ë²ˆì—ëŠ” Knativeë¥¼ EKSì— êµ¬ì„±í•´ë³´ë ¤ê³  í•œë‹¤. 4ì›”ì€ ë°œí‘œ ë° ì—¬ëŸ¬ê°€ì§€ ì—…ë¬´ë¡œ ì¸í•´ì„œ í¬ìŠ¤íŒ…ì„ í•  ì‹œê°„ì´ ë¶€ì¡±í–ˆì§€ë§Œ 5ì›”ë¶€í„° ì¡°ê¸ˆì”© ì—¬ìœ ê°€ ìƒê²¨ì„œ ë” ë°”ë¹ ì§€ê¸°ì „ì— ì¢€ ì¨ë³´ë ¤ê³  í•œë‹¤. ì‚¬ì‹¤ [Facebook @ìµœìš©í˜¸](https://www.facebook.com/yongho1037)ë‹˜ê»˜ì„œ í•œë²ˆ í•´ë³´ëŠ”ê²ƒë„ ì¢‹ê² ë‹¤ê³  í•˜ì…”ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.  \n\n## Knative on EKS\n\nì œëª©ë§Œ ë³´ë©´ Lambdaë‚˜ ECS, Batch ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ë° ì™œ ì´ê±¸ ì¨ì•¼í•˜ì§€? ë¼ëŠ” ìƒê°ë¶€í„° í•˜ëŠ” ì‚¬ëŒë„ ìˆì„ê²ƒ ê°™ë‹¤. í•˜ì§€ë§Œ ì´ì „ í¬ìŠ¤íŒ…ë“¤ê³¼ ë°œí‘œì—ì„œë„ ì—¬ëŸ¬ë²ˆ ì´ì•¼ê¸° í•œê²ƒì²˜ëŸ¼ KnativeëŠ” ê°„ë‹¨í•˜ê²Œ ì„œë²„ë¦¬ìŠ¤ ì›Œí¬ë¡œë“œë¥¼ ë¹Œë“œ, ë°°í¬, ê´€ë¦¬í•˜ê¸° ìœ„í•œ Kubernetesê¸°ë°˜ FaaSí”Œë«í¼ì´ê³  í˜„ì¬ [CNCF Landscape](https://landscape.cncf.io/)ì—ì„œ ê°€ì¥ ë¹ ë¥¸ ì†ë„ë¡œ ê°œë°œë˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ ì¤‘ í•˜ë‚˜ì´ë‹¤.\n\n## EKS ë°°í¬\n\nì•ì„  [eksworkshop í¬ìŠ¤íŒ…](https://ddii.dev/kubernetes/eksworkshop/)ì—ì„œì²˜ëŸ¼ ê°„ë‹¨í•œ ë°°í¬ë¥¼ ìœ„í•´ `eksctl`ë¡œ 2-node í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•œë‹¤.  \nì‚¬ì „ ì¤€ë¹„ì‚¬í•­ì€ [ì´ì „ í¬ìŠ¤íŒ…](https://ddii.dev/kubernetes/eksworkshop/)ì´ë‚˜ [https://eksctl.io/](https://eksctl.io/)ì„ ì°¸ê³ í•˜ì.  \n\n```sh\n$ eksctl create cluster --name=eksworkshop-eksctl --nodes=2 --node-ami=auto\n```\n\nìƒì„±ëœ í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ í™•ì¸í•œë‹¤. \n\n```sh\n$ kubectl get nodes\nNAME                                                STATUS    ROLES     AGE       VERSION\nip-192-168-24-168.ap-northeast-2.compute.internal   Ready     <none>    2m        v1.11.9\nip-192-168-78-204.ap-northeast-2.compute.internal   Ready     <none>    2m        v1.11.9\n```\n\n## istio ì„¤ì¹˜\n\nKnativeëŠ” istio ì˜ì¡´ì„±ì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— Istioë¥¼ ë¨¼ì € ë°°í¬í•œë‹¤. ë¬¼ë¡  [ì´ì „ í¬ìŠ¤íŒ…](https://ddii.dev/kubernetes/knative-using-gloo/)ì—ì„œ ì„¤ëª…í•œê²ƒ ì²˜ëŸ¼ Glooë¥¼ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ ì´ë²ˆì—ëŠ” Istioë¥¼ ì„¤ì¹˜í•˜ì˜€ë‹¤.  \n\n```sh\n$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio-crds.yaml \n$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio.yaml\n```\n\në°°í¬ëœ Pods, Services, Replicasets ì„ í™•ì¸í•œë‹¤.\n\n```sh\n$ kubectl get pods -n istio-system\nNAME                                     READY     STATUS      RESTARTS   AGE\ncluster-local-gateway-65c8b667c8-269cf   1/1       Running     0          17m\nistio-citadel-76bd44d8f7-5cltj           1/1       Running     0          17m\nistio-cleanup-secrets-7jpth              0/1       Completed   0          17m\nistio-egressgateway-b9d56b4f8-pdjhs      1/1       Running     0          17m\nistio-galley-7db7db89db-5stkp            1/1       Running     0          17m\nistio-ingressgateway-f77fbc787-npw9d     1/1       Running     0          17m\nistio-pilot-69f975bf4f-4dq4d             2/2       Running     0          17m\nistio-pilot-69f975bf4f-q9g8g             2/2       Running     0          16m\nistio-pilot-69f975bf4f-tnm92             2/2       Running     0          16m\nistio-policy-8db48cbcd-dl2th             2/2       Running     0          17m\nistio-security-post-install-xv8z6        0/1       Completed   0          17m\nistio-sidecar-injector-cd54ffccd-kj2n6   1/1       Running     0          17m\nistio-telemetry-d78cd45db-8x2cw          2/2       Running     0          17m\n\n$ kubectl get svc -n istio-system\nNAME                     TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)                                                                                                                   AGE\ncluster-local-gateway    ClusterIP      10.100.97.146    <none>                                                                        80/TCP,443/TCP,31400/TCP,15011/TCP,8060/TCP,15030/TCP,15031/TCP                                                           17m\nistio-citadel            ClusterIP      10.100.147.235   <none>                                                                        8060/TCP,9093/TCP                                                                                                         17m\nistio-egressgateway      ClusterIP      10.100.25.44     <none>                                                                        80/TCP,443/TCP                                                                                                            17m\nistio-galley             ClusterIP      10.100.158.45    <none>                                                                        443/TCP,9093/TCP                                                                                                          17m\nistio-ingressgateway     LoadBalancer   10.100.62.157    a4e1d5201758f11e9b7f402c4d4b0376-510368564.ap-northeast-2.elb.amazonaws.com   80:31000/TCP,443:30753/TCP,31400:31922/TCP,15011:31331/TCP,8060:30389/TCP,853:30257/TCP,15030:30827/TCP,15031:30153/TCP   17m\nistio-pilot              ClusterIP      10.100.25.194    <none>                                                                        15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                                     17m\nistio-policy             ClusterIP      10.100.73.149    <none>                                                                        9091/TCP,15004/TCP,9093/TCP                                                                                               17m\nistio-sidecar-injector   ClusterIP      10.100.117.18    <none>                                                                        443/TCP                                                                                                                   17m\nistio-telemetry          ClusterIP      10.100.87.12     <none>                                                                        9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                                     17m\n\n$ kubectl get rs -n istio-system\nNAME                               DESIRED   CURRENT   READY     AGE\ncluster-local-gateway-65c8b667c8   1         1         1         17m\nistio-citadel-76bd44d8f7           1         1         1         17m\nistio-egressgateway-b9d56b4f8      1         1         1         17m\nistio-galley-7db7db89db            1         1         1         17m\nistio-ingressgateway-f77fbc787     1         1         1         17m\nistio-pilot-69f975bf4f             3         3         3         17m\nistio-policy-8db48cbcd             1         1         1         17m\nistio-sidecar-injector-cd54ffccd   1         1         1         17m\nistio-telemetry-d78cd45db          1         1         1         17m\n```\n\nIstio injectionì„ í•˜ê¸° ìœ„í•´ ë°°í¬í•  defaults namespace ì „ì²´ì— Labelingì„ í•œë‹¤.\n\n```sh\n$ kubectl label namespace default istio-injection=enabled\nnamespace/default labeled\n\n$ kubectl get namespaces --show-labels\nNAME           STATUS    AGE       LABELS\ndefault        Active    43m       istio-injection=enabled\nistio-system   Active    27m       istio-injection=disabled\nkube-public    Active    43m       <none>\nkube-system    Active    43m       <none>\n```\n\n## Knative ì„¤ì¹˜\n\nbuild, evening, serving ë° ëª¨ë‹ˆí„°ë§ ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•œë‹¤.\n\n```sh\nkubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/serving.yaml \\\n   -f https://github.com/knative/build/releases/download/v0.5.0/build.yaml \\\n   -f https://github.com/knative/eventing/releases/download/v0.5.0/release.yaml \\\n   -f https://github.com/knative/eventing-sources/releases/download/v0.5.0/eventing-sources.yaml \\\n   -f https://github.com/knative/serving/releases/download/v0.5.0/monitoring.yaml \\\n   -f https://raw.githubusercontent.com/knative/serving/v0.5.0/third_party/config/build/clusterrole.yaml\n```\n\nëª¨ë“  Knative namespaces ë° resourcesë¥¼ í™•ì¸í•œë‹¤.\n\n```sh\n$ kubectl get namespaces | grep knative\nknative-build        Active    8m\nknative-eventing     Active    8m\nknative-monitoring   Active    8m\nknative-serving      Active    8m\nknative-sources      Active    8m\n\n$ kubectl get pods -n knative-serving\nNAME                          READY     STATUS    RESTARTS   AGE\nactivator-664b5b9598-dsjvq    2/2       Running   0          10m\nautoscaler-64d5bd84b8-bqghq   2/2       Running   0          10m\ncontroller-658b9d5c6c-tnwvz   1/1       Running   0          10m\nwebhook-5dffbfbb8b-525vt      1/1       Running   0          10m\n\n$ kubectl get pods -n knative-build \nNAME                                READY     STATUS    RESTARTS   AGE\nbuild-controller-86f5b5b96d-zg8j2   1/1       Running   0          11m\nbuild-webhook-6fddd7c6df-68fkw      1/1       Running   0          11m\n\n$ kubectl get pods -n knative-eventing \nNAME                                            READY     STATUS    RESTARTS   AGE\neventing-controller-6fdccd8c95-bckws            1/1       Running   0          11m\nin-memory-channel-controller-6fddb6655f-vbc64   1/1       Running   0          11m\nin-memory-channel-dispatcher-7684cd7c7d-ftqhc   2/2       Running   2          11m\nwebhook-d496c66bd-688xz                         1/1       Running   0          11m\n```\n\n```sh\n$ kubectl get pods -n knative-monitoring \nNAME                                  READY     STATUS    RESTARTS   AGE\nelasticsearch-logging-0               1/1       Running   0          14m\nelasticsearch-logging-1               1/1       Running   0          12m\ngrafana-754bc795bb-wxwml              1/1       Running   0          14m\nkibana-logging-7f7b9698bc-rrnw6       1/1       Running   0          14m\nkube-state-metrics-5bccdf746f-fhv7t   4/4       Running   0          12m\nnode-exporter-w9jlq                   2/2       Running   0          14m\nnode-exporter-wgv2j                   2/2       Running   0          14m\nprometheus-system-0                   1/1       Running   0          14m\nprometheus-system-1                   1/1       Running   0          14m\n```\n\nëª¨ë‹ˆí„°ë§ ë¦¬ì†ŒìŠ¤ë„ í™•ì¸í•œë‹¤. ìœ„ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë³´ë©´ Fluentdê°€ ë°°í¬ë˜ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ DaemonSetìœ¼ë¡œ ë™ì‘í• ìˆ˜ ìˆë„ë¡ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•˜ë©´ DaemonSetì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n```sh\n$ kubectl label nodes --all beta.kubernetes.io/fluentd-ds-ready=\"true\"\n```\n\n## Buildì—ì„œ ì‚¬ìš©í•  Docker Credential ì„¤ì •\n\nì¼ë‹¨ Knative Buildë¥¼ ìˆ˜í–‰í• ë•Œ ì¼ë°˜ì ìœ¼ë¡œ Container Registryë¥¼ ë§ì´ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— Registry Credential ì„¤ì •ì„ í•´ì•¼í•œë‹¤.  \n\nECRì˜ ê²½ìš° [https://github.com/knative/build-templates](https://github.com/knative/build-templates)ì˜ ecr_helperë¥¼ ì‚¬ìš©í•˜ë©´ ì‰½ê²Œ ECR accountë¥¼ ì„¤ì •í•  ìˆ˜ ìˆì§€ë§Œ `Serving`ë‹¨ê³„ì—ì„œ 401ì—ëŸ¬ê°€ ë‚˜ëŠ” ì´ìœ ë¥¼ ì¡ì§€ ëª»í•´ì„œ ì¼ë‹¨ Dockerhubë¥¼ ê°€ì§€ê³  ì§„í–‰í•˜ì˜€ë‹¤.\n\nê°„ë‹¨í•œ ë°ëª¨ì½”ë“œëŠ” ì•„ë˜ repositoryì— ë¯¸ë¦¬ ì‘ì„±í•´ë†¨ë‹¤.  \n\n[https://github.com/ddiiwoong/hello-python.git](https://github.com/ddiiwoong/hello-python.git)\n\n`docker-secret.yaml` ì„ ë³´ë©´ dockerhub pushë¥¼ ìœ„í•´ basic-authë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ëŠ”ë° dockerhub id/password ë¥¼ base64ë¡œ encodingí•´ì„œ Secretìœ¼ë¡œ ì €ì¥í•œë‹¤.  \n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: basic-user-pass\n  annotations:\n    build.knative.dev/docker-0: https://index.docker.io/v1/\ntype: kubernetes.io/basic-auth\ndata:\n  # Use 'echo -n \"username\" | base64' to generate this string\n  username: BASE64_ENCODED_USERNAME\n  # Use 'echo -n \"password\" | base64' to generate this string\n  password: BASE64_ENCODED_PASSWORD\n```\n\nê·¸ë¦¬ê³  ServiceAccount `build-bot`ì„ ìƒì„±í•˜ê¸° ìœ„í•œ yaml (sa.yaml)ë¥¼ ì‘ì„±í•œë‹¤.  \n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: build-bot\nsecrets:\n  - name: basic-user-pass\n```\n\nìœ„ì—ì„œ ì‘ì„±í•œ Secret(basic-user-pass)ê³¼ ServiceAccount(build-bot)ë¥¼ ë°°í¬í•œë‹¤.  \n\n\n```sh\n$ kubectl apply -f docker-secret.yaml\nsecret \"basic-user-pass\" created\n$ kubectl apply -f sa.yaml\nserviceaccount \"build-bot\" created\n```\n\nì €ì¥ëœ Secret(basic-user-pass)ê³¼ ServiceAccount(build-bot)ë¥¼ í™•ì¸í•œë‹¤.\n\n```sh\n$ kubectl get secret\nNAME                        TYPE                                  DATA      AGE\nbasic-user-pass             kubernetes.io/basic-auth              2         2h\nbuild-bot-token-gfkg9       kubernetes.io/service-account-token   3         2h\nbuilder-token-kp7ww         kubernetes.io/service-account-token   3         10h\ndefault-token-9cpp5         kubernetes.io/service-account-token   3         10h\necr-creds                   kubernetes.io/basic-auth              2         10h\nistio.build-bot             istio.io/key-and-cert                 3         2h\nistio.builder               istio.io/key-and-cert                 3         10h\nistio.default               istio.io/key-and-cert                 3         10h\nistio.knative-serve         istio.io/key-and-cert                 3         2h\nknative-serve-token-9j82l   kubernetes.io/service-account-token   3         2h\n\n$ kubectl get sa\nNAME            SECRETS   AGE\nbuild-bot       2         2h\nbuilder         2         10h\ndefault         1         10h\nknative-serve   2         2h\n```\n\n## Python ì½”ë“œ ë° Dockerfile ì‘ì„±\n\nTARGET í™˜ê²½ë³€ìˆ˜ë¥¼ ë°›ì•„ì„œ Hello Worldì™€ ê°™ì´ ì¶œë ¥í•˜ëŠ” ê°„ë‹¨í•œ Flaskê¸°ë°˜ ì•±ì„ ì‘ì„±í•œë‹¤.  \n\nê°„ë‹¨í•œ ë°ëª¨ì½”ë“œëŠ” ì•„ë˜ repositoryì— ë¯¸ë¦¬ ì‘ì„±í•´ë†¨ë‹¤.  \n\n[https://github.com/ddiiwoong/hello-python.git](https://github.com/ddiiwoong/hello-python.git)\n\n```py\nimport os\n\nfrom flask import Flask\n\napp = Flask(__name__)\n\n@app.route('/')\ndef hello_world():\n    target = os.environ.get('TARGET', 'NOT SPECIFIED')\n    return 'Hello World: {}!\\n'.format(target)\n\nif __name__ == \"__main__\":\n    app.run(debug=True, host='0.0.0.0', port=int(os.environ.get('PORT', 8080)))\n```\n\nìœ„ ì•±(app.py)ì„ ë°°í¬í•˜ëŠ” Dockerfileì„ ì‘ì„±í•œë‹¤.\n\n```dockerfile\nFROM python:alpine\n\nENV APP_HOME /app\nCOPY . $APP_HOME\nWORKDIR $APP_HOME\n\nRUN pip install Flask\n\nENTRYPOINT [\"python\"]\nCMD [\"app.py\"]\n```\n\n## Knative Build \n\në¯¸ë¦¬ Dockerhubì—ì„œ `hello-python` repository(docker.io/ddiiwoong/hello-python)ë¥¼ ìƒì„±í•œë‹¤.  \nê·¸ë¦¬ê³  ìœ„ì—ì„œ ìƒì„±í•œ `build-bot` ê³„ì •ê³¼ image tag `hello-python`ì •ë³´ë¥¼ Build templateì— ì‘ì„±í•˜ì—¬ ë°°í¬í•œë‹¤.  \nì•„ë˜ Knative Build ê³¼ì •ì€ `kaniko executor`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ìˆ˜í–‰í•œë‹¤.  \n1. `spec.source` ì—ì„œ Source Clone (git)ë¥¼ ìˆ˜í–‰í•˜ê³  ì´í›„  \n2. `spec.steps` ì—ì„œ Docker Build, Tag, Registry Login, Pushë¥¼ ìˆ˜í–‰í•œë‹¤.  \n\n```yaml\napiVersion: build.knative.dev/v1alpha1\nkind: Build\nmetadata:\n  name: python-build\nspec:\n  serviceAccountName: build-bot\n  source:\n    git:\n      url: https://github.com/ddiiwoong/hello-python.git\n      revision: master\n  steps:\n  - name: build-and-push\n    image: gcr.io/kaniko-project/executor:v0.1.0\n    args:\n    - --dockerfile=/workspace/Dockerfile\n    - --destination=docker.io/ddiiwoong/hello-python:latest\n```\n\n`build`ë¥¼ ìˆ˜í–‰í•œë‹¤. \n\n```sh\n$ kubectl apply -f build.yaml\nbuild.build.knative.dev/python-build created\n\n$ kubectl get build\nNAME           SUCCEEDED   REASON    STARTTIME   COMPLETIONTIME\npython-build   True                  18m\n```\n\nì •ìƒì ìœ¼ë¡œ Buildê°€ ì™„ë£Œë˜ë©´ Dockerhubì— ì •ì˜í•œ TAG(ddiiwoong/hello-python)ë¡œ ì´ë¯¸ì§€ê°€ ë“±ë¡ëœê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n```sh\n$ docker pull ddiiwoong/hello-python\nUsing default tag: latest\nlatest: Pulling from ddiiwoong/hello-python\ne7c96db7181b: Pull complete\n799a5534f213: Pull complete\n913b50bbe755: Pull complete\n11154abc6081: Pull complete\nc805e63f69fe: Pull complete\n6eabcf0f7a50: Pull complete\n74101057f4ec: Pull complete\nDigest: sha256:51dc4a7ce38a5e7894adcfc00eaee6c5ea6aca1ef6c7521f9b7ea6382c013b9b\nStatus: Downloaded newer image for ddiiwoong/hello-python:latest\n```\n\n## Knative Serving ìœ¼ë¡œ ë°°í¬\n\n#### service.yaml\n```yaml\napiVersion: serving.knative.dev/v1alpha1\nkind: Service\nmetadata:\n  name: helloworld-python\n  namespace: default\nspec:\n  runLatest:\n    configuration:\n      revisionTemplate:\n        spec:\n          container:\n            image: ddiiwoong/hello-python:latest\n            env:\n            - name: TARGET\n              value: \"Python Sample v1 with Knative on EKS\"\n```\n\në¹Œë“œëœ image (ddiiwoong/hello-python:latest)ë¡œ Knative Serviceë¥¼ ìƒì„±í•œë‹¤.  \n\n```sh\n$ kubectl apply -f service.yaml\nservice.serving.knative.dev/helloworld-python created\n```\n\n`istio-system` Namespaceì— `istio-ingressgateway` Serviceë¥¼ í™•ì¸í•œë‹¤.  \n\n```sh\nkubectl get svc istio-ingressgateway --namespace istio-system\nNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP                                                                    PORT(S)                                                                                                                   AGE\nistio-ingressgateway   LoadBalancer   10.100.208.80   a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com   80:31581/TCP,443:31490/TCP,31400:30367/TCP,15011:32495/TCP,8060:31418/TCP,853:30310/TCP,15030:32405/TCP,15031:31410/TCP   13h\n```\n  \nALB: a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com  \n\nìœ„ì™€ ê°™ì´ AWS LoadBalancerë¡œ ë°°í¬ë©´ ALBê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë¯€ë¡œ ì¶”í›„ eksctlë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•˜ê¸° ì „ì— ë°˜ë“œì‹œ LoadBalancer í˜•íƒœë¡œ ë°°í¬ëœ ì„œë¹„ìŠ¤ë¥¼ ì‚­ì œí•˜ê³  ì§„í–‰í•´ì•¼ í•œë‹¤.  \n\nKnative Serviceë¥¼ í™•ì¸í•œë‹¤. \n```sh\n$ kubectl get ksvc\nNAME                DOMAIN                                  LATESTCREATED             LATESTREADY               READY     REASON\nhelloworld-python   helloworld-python.default.example.com   helloworld-python-4rw95   helloworld-python-4rw95   True\n```\n\nìœ„ì—ì„œ ì–»ì€ ë‘ê°€ì§€ ì •ë³´(LoadBalancer, Domain)ë¡œ ìƒì„±ëœ appì„ í…ŒìŠ¤íŠ¸í•œë‹¤.  \nKnativeëŠ” ë‚´ë¶€ì ìœ¼ë¡œ example.comì´ë¼ê³  í•˜ëŠ” ê¸°ë³¸ domainì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë‚´ë¶€ì ìœ¼ë¡œëŠ” `helloworld-python.default.example.com`ìœ¼ë¡œ curlì„ ì‹¤í–‰í•˜ê²Œ ëœë‹¤.  \n\n```sh\n$ curl -H \"Host:helloworld-python.default.example.com\" http://a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com\nHello World: Python Sample v1 with Knative on EKS!\n```\n\n`Cold Start`(default timeout 5ë¶„) ë•Œë¬¸ì— ì ì‹œ ì‘ë‹µì´ ëŠ¦ì–´ì§ˆ ìˆ˜ë„ ìˆì§€ë§Œ(2-5ì´ˆ) ì ì‹œ ê¸°ë‹¤ë¦¬ë©´ ìœ„ì²˜ëŸ¼ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n\n## ì •ë¦¬\n\nìœ„ì—ì„œë„ ì ê¹ ì–¸ê¸‰í–ˆì§€ë§Œ Lambdaë‚˜ ECS, Batch ì„œë¹„ìŠ¤ê°€ ìˆëŠ”ë° Knative on EKS ë¥¼ êµ¬ì§€ ì™œ í•˜ëŠëƒë¼ê³  ê¶ê¸ˆí•´í•˜ëŠ” ë¶„ë“¤ì´ ê³„ì‹¤ì§€ë„ ëª¨ë¥¸ë‹¤. í•˜ì§€ë§Œ ë‹¤ë“¤ ì•„ë˜ì™€ ê°™ì€ ê³ ë¯¼ì„ í•´ë´¤ì„ê±°ë¼ ìƒê°í•œë‹¤.  \n\nì»¨í…Œì´ë„ˆì™€ Kubernetesê°€ DevOpsë„êµ¬ë¡œì„œì˜ í‘œì¤€ì´ ë˜ì–´ê°€ëŠ” ì‹œëŒ€ì— Lambdaë¥¼ ì“¸ì§€ ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ì“¸ì§€ì— ëŒ€í•œ ê³ ë¯¼ì€ ê²°êµ­ ì´ì‹ì„±ê³¼ ë²¤ë” ì¢…ì†ì„±ì„ ì œê±°í•˜ê³  ìš´ì˜íš¨ìœ¨í™” ì¸¡ë©´ì—ì„œ ê·¸ ë‹µì„ ì°¾ì„ìˆ˜ ìˆì„ê²ƒ ê°™ë‹¤.  \n\ní˜„ì¬ ëª¸ë‹´ê³  ìˆëŠ” ìµœê·¼ í”„ë¡œì íŠ¸ì—ì„œ Lambda, ECS, Batch ë“±ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ë§ì•„ì¡ŒëŠ”ë° ì‹¤ì œ ì—”í„°í”„ë¼ì´ì¦ˆì—ì„œ ì •í•´ì§„ ìì›ë‚´ì—ì„œ ì •í•´ì§„ ì¼ì„ í• ë•ŒëŠ” ë§¤ë‹ˆì§€ë“œ ì„œë¹„ìŠ¤ê°€ ì í•©í•˜ë‹¤ê³  ìƒê°í•œë‹¤. í•˜ì§€ë§Œ On-Premise ë˜ëŠ” ê·¸ì— ì¤€í•˜ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ìš´ì˜í•˜ëŠ” ì¡°ì§ì—ì„œëŠ” Knativeë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ì„œë¹„ë¦¬ìŠ¤ ì›Œí¬ë¡œë“œë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì´ í–¥í›„ Hybrid ê´€ì ì—ì„œ í™•ì¥ì„±ê³¼ ë²¤ë” ì¢…ì†ì„±ì„ ì œê±°í•˜ëŠ”ë° í° ë„ì›€ì´ ë ê²ƒì´ë¼ ìƒê°í•œë‹¤.  \n\nì¡°ê¸ˆì”© Kubernetes ë° ìƒíƒœê³„ Learningì— ëŒ€í•œ í”¼ë¡œë„ê°€ ì¦ê°€í•˜ê³  ìˆê³  Hype Driven Development(ì„¤ë ˆë°œ ì£¼ë„ê°œë°œ)ê°€ ë˜ëŠ”ê²ƒ ê°™ì•„ì„œ ì•„ì‰¬ìš´ ë¶€ë¶„ì€ ìˆì§€ë§Œ í˜„ì¬ ê°€ì¥ í•«í•œ ê¸°ìˆ ì´ê³  ê´€ì‹¬ë„ê°€ ë†’ê¸° ë•Œë¬¸ì— ë°°ì›Œë‘ë©´ ì–¸ì  ê°€ëŠ” ì¨ë¨¹ê²Œ ë ê±°ë¼ í™•ì‹ í•œë‹¤.  \n\në‹¤ì‹œí•œë²ˆ Conference driven development(architecture)ê°€ ë˜ì§€ ì•Šë„ë¡ ìì¤‘í•˜ê³  Loudest Guyê°€ ë˜ì§€ ì•Šë„ë¡ ì¡°ì‹¬í•´ì•¼í•  ê²ƒ ê°™ë‹¤."
    },
    {
      "id": "kubernetes/eksworkshop/",
      "metadata": {
        "permalink": "/kubernetes/eksworkshop/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-03-29-eksworkshop.md",
        "source": "@site/blog/2019-03-29-eksworkshop.md",
        "title": "eksworkshop",
        "description": "eskworkshop íŠœí† ë¦¬ì–¼ì„ ì‹¤í–‰í•˜ê³  ê°„ë‹¨í•œ Microserviceì•±ì„ ë°°í¬í•´ë³´ì",
        "date": "2019-03-29T00:00:00.000Z",
        "formattedDate": "March 29, 2019",
        "tags": [
          {
            "label": "eks",
            "permalink": "/tags/eks"
          },
          {
            "label": "aws",
            "permalink": "/tags/aws"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "eskworkshop",
            "permalink": "/tags/eskworkshop"
          },
          {
            "label": "kubectl",
            "permalink": "/tags/kubectl"
          },
          {
            "label": "Managed Kubernetes",
            "permalink": "/tags/managed-kubernetes"
          }
        ],
        "readingTime": 14.23,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "eksworkshop",
          "comments": true,
          "classes": "wide",
          "description": "eskworkshop íŠœí† ë¦¬ì–¼ì„ ì‹¤í–‰í•˜ê³  ê°„ë‹¨í•œ Microserviceì•±ì„ ë°°í¬í•´ë³´ì",
          "slug": "kubernetes/eksworkshop/",
          "date": "2019-03-29T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "eks",
            "aws",
            "Kubernetes",
            "eskworkshop",
            "kubectl",
            "Managed Kubernetes"
          ]
        },
        "prevItem": {
          "title": "Knative on EKS",
          "permalink": "/kubernetes/knative-on-aws/"
        },
        "nextItem": {
          "title": "git-sync",
          "permalink": "/kubernetes/git-sync/"
        }
      },
      "content": "## Amazon EKS (Elastic Container Service for Kubernetes)\n\nKubernetes Managed Serviceì¸ Amazon EKSê°€ 2018ë…„ 7ì›” ì¶œì‹œë˜ê³  2019ë…„ 1ì›” ì •ì‹ìœ¼ë¡œ ì„œìš¸ë¦¬ì „ì— ì¶œì‹œë˜ì—ˆë‹¤. ê°œì¸ì ìœ¼ë¡œ ì™„ì „ê´€ë¦¬í˜• Kubernetes ì¶œì‹œê°€ ëŠ¦ì–´ì ¸ì„œ AWS í–‰ë³´ê°€ ë‹¤ì†Œ ëŠ¦ë‹¤ê³  ìƒê°ì€ í–ˆìœ¼ë‚˜ ALBì™€ VPCì—°ë™, ì—¬ëŸ¬ê°€ì§€ ê¸°ì¡´ OpenSourceì™€ì˜ ì—°ê²°ê³ ë¦¬ë¥¼ ë°°ì œí•˜ê³  ìì²´ Managedì„œë¹„ìŠ¤ì™€ ì—°ë™í• ê²ƒë“¤ì´ ë§ê¸° ë•Œë¬¸ì— ë‹¹ì—°íˆ íƒ€ì‚¬ì— ë¹„í•´ ëŠ¦ì–´ì§„ê±¸ë¡œ ë³´ì¸ë‹¤. ì–¸ì œë‚˜ ê·¸ë¬ì§€ë§Œ ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ë°›ì•„ë“¤ì´ëŠ” ëŠë‚Œì´ ì•„ë‹ˆë¼ ë­”ê°€ ì™„ì„±ëœ ì œí’ˆì„ ì“°ëŠ” ëŠë‚Œ(?)ì´ë‹¤. ë¬¼ë¡  ë¶ˆí¸í•œ ë¶€ë¶„ê³¼ ê°ìˆ˜í•´ì•¼í•  ë‚´ìš©ë“¤ì€ ì¡°ê¸ˆ ìˆì§€ë§Œ ê¸°ì¡´ AWS ì¶©ì„± Userì—ê²Œ í˜¸ì‘ì„ ì–»ì„ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ ì•„ë‹ê¹Œë¼ëŠ” ìƒê°ì„ í•´ë³´ë©´ì„œ í¬ìŠ¤íŒ…ì„ ì‹œì‘í•˜ë ¤ê³  í•œë‹¤.  \n\nì˜¤í”ˆì†ŒìŠ¤ê°€ ì•„ë‹Œ Managedì„œë¹„ìŠ¤ì— ëŒ€í•œ ë¦¬ë·°ëŠ” ì²˜ìŒì´ì§€ë§Œ 4ì›” 10ì¼ [AWSíŒêµì†Œëª¨ì„](https://www.meetup.com/ko-KR/awskrug/events/260024327/) ë°œí‘œë„ ìˆê³ , ì‹¤ì œ ê³ ë ¤ì¤‘ì¸ ì•„í‚¤í…ì²˜ì— í¬í•¨ì´ ë˜ì–´ì•¼ í•˜ëŠ” EKSì— ëŒ€í•´ì„œ ì‚´í´ë³´ê³  eskworkshop íŠœí† ë¦¬ì–¼ì„ ì‹¤í–‰í•´ë³´ë©´ì„œ ë‹¤ë¥¸ ê´€ë¦¬í˜• Kubernetes ì„œë¹„ìŠ¤ë“¤ì— ë¹„í•´ ì–´ë–¤ ì‚¬í•­ì„ ì¢€ë” ê³ ë¯¼í•´ì•¼ í•˜ëŠ”ì§€ ì •ë¦¬í•´ë³´ê³  ë„˜ì–´ê°€ë©´ ì¢‹ì„ë“¯ í•˜ë‹¤.\n\n## eksworkshop.com\n\n[https://eksworkshop.com/](https://eksworkshop.com/)  \nKuberneteë¥¼ ì²˜ìŒì ‘í•˜ëŠ” ìœ ì €ë¥¼ ìœ„í•œ ê¸°ë³¸ ê°œë…ê³¼ ì•„í‚¤í…ì²˜, ê·¸ë¦¬ê³  VPC, ALBë¥¼ í™œìš©í•˜ì—¬ EKSì— ëŒ€í•œ ì„¤ì¹˜, êµ¬ì„±, ë°ëª¨ì•± ë°°í¬ ë“±ì„ í•´ë³¼ìˆ˜ ìˆëŠ” íŠœí† ë¦¬ì–¼ ì‚¬ì´íŠ¸ì´ë‹¤.  \n\n[AWSKRUG](https://www.facebook.com/groups/awskrug/)ì—ì„œ í•œê¸€í™” ì‘ì—…ë„ ì§„í–‰ì¤‘ì´ë‹¤.  [í•œê¸€í™” ë§í¬](https://awskrug.github.io/eks-workshop/deploy/)\n\n## eksworkshop ë”°ë¼í•˜ê¸°ì „ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­\n\neksworkshopì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ workshopì´ë¼ëŠ” ì‹ ê·œ IAM ê³„ì •ì„ ìƒì„±í•˜ê³  Cloud9 Workspace ì™€ ëª‡ê°€ì§€ ì„¤ì •ë“¤ì„ ì§„í–‰í•˜ì§€ë§Œ [AWSíŒêµì†Œëª¨ì„](https://www.meetup.com/ko-KR/awskrug/events/260024327/)ì„ ìœ„í•´ ìµœëŒ€í•œ ë¹„ìš©ì´ ë“œëŠ” êµ¬ì„±ìš”ì†Œë¥¼ ë°°ì œí•˜ê³  ì‘ì„±í•˜ê³ ì í•œë‹¤.\n\n### AWS account\nFree TierëŠ” EKSë¥¼ ììœ ë¡­ê²Œ í™œìš©í• ìˆ˜ ì—†ë‹¤.  \nê´€ë ¨ issue - [https://github.com/aws/containers-roadmap/issues/78](https://github.com/aws/containers-roadmap/issues/78)  \n\nì‹¤ì œ ì‚¬ìš©ì¤‘ì¸ ê³„ì •ì´ë‚˜ Creditì´ í™•ë³´ëœ ê³„ì •ì´ í•„ìš”í•˜ë‹¤.  \n\n### IAM ì„¤ì • (JSON template)\nEKSworkshopì—ì„œëŠ” Full administrator ê³„ì •ì„ í•„ìš”ë¡œ í•˜ì§€ë§Œ eksctlë¡œ ë°°í¬ë¥¼ ì§„í–‰í•˜ë¯€ë¡œ ê·¸ ê¸°ì¤€ìœ¼ë¡œ IAMì„¤ì •ì„ ì§„í–‰í•œë‹¤.  \n\n[terraform eks iam ì„¤ì •](https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/examples/eks_test_fixture/README.md)ì„ ì°¸ê³ í•˜ë ¤ê³  í–ˆì§€ë§Œ eksctlê³¼ terraformê³¼ì˜ ì•½ê°„ ë‹¤ë¥¸ ë°©ì‹ì˜ ë°°í¬ë¡œ ì¸í•´ ì–´ì©”ìˆ˜ì—†ì´ EKS Full Accessê¶Œí•œì„ í• ë‹¹í•˜ì˜€ë‹¤.  \n(ë‹¤ë¥¸ ìœ ê²½í—˜ìì˜ ë„ì›€ì´ í•„ìš”í•œ ìƒí™© ã… ã… )\n\nìì„¸í•œ JSON ë‚´ìš©ì€ [ë§í¬](https://github.com/ddiiwoong/eksworkshop/blob/master/iam_for_eksworkshop.json)ë¥¼ ì°¸ê³ í•œë‹¤.  \n\n### kubectl, aws-iam-authenticator\n* kubectl : kubernetes CLI\n* aws-iam-authenticator : AWS IAM Authenticator CLI\n\n#### kubectl configë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ .kube directoryë¥¼ ìƒì„±\n\n```bash\n$ mkdir -p ~/.kube\n``` \n\n#### kubectl ì„¤ì¹˜ (linux)\n```bash\n$ sudo curl --silent --location -o /usr/local/bin/kubectl \"https://amazon-eks.s3-us-west-2.amazonaws.com/1.11.5/2018-12-06/bin/linux/amd64/kubectl\"\n$ sudo chmod +x /usr/local/bin/kubectl\n```\n\n#### kubectl ì„¤ì¹˜ (MacOS Homebrew)\nMacOSëŠ” brewë¡œ ì„¤ì¹˜í•˜ì˜€ë‹¤.  \n[https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos)\n```bash\n$ brew install kubernetes-cli\n```\n\n#### kubectl ì„¤ì¹˜ (windows PowerShell)\n[https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html)\n\n```\ncurl -o kubectl.exe https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/kubectl.exe\n```\n\n\n#### kubectl ì„¤ì¹˜ í™•ì¸\n\ní˜„ì¬ MacOSì—ì„œëŠ” 1.11.7 ë²„ì „ì´ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤. (ë‹¤ë¥¸ê²½ë¡œë¡œ ì„¤ì¹˜ë¨)\n```bash\n$ kubectl version --short --client\nClient Version: v1.11.7-dispatcher\n```\n\n#### aws-iam-authenticator ì„¤ì¹˜\nAmazon EKSëŠ” IAMì„ ì‚¬ìš©í•˜ì—¬ Kubernetesìš© AWS IAM Authenticatorë¥¼ í†µí•´ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì¸ì¦ì„ ì œê³µí•œë‹¤.  Go(ë²„ì „ 1.7ì´ìƒ)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì•„ë˜ì™€ ê°™ì´ ì§„í–‰í•˜ë©´ ëœë‹¤. \n```bash\n$ go get -u -v github.com/kubernetes-sigs/aws-iam-authenticator/cmd/aws-iam-authenticator\n$ sudo mv ~/go/bin/aws-iam-authenticator /usr/local/bin/aws-iam-authenticator\n```\n\në§Œì•½ Goì„¤ì¹˜ê°€ ì•ˆë˜ì–´ ìˆë‹¤ë©´ ë‹¤ìŒ ë§í¬ë¥¼ í†µí•´ ì„¤ì¹˜ ì§„í–‰í• ìˆ˜ ìˆë‹¤.  \n[https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html)\n\n#### aws-iam-authenticator binary ë‹¤ìš´ë¡œë“œ\n\nLinux: [https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator](https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator)  \nMacOS: [https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator](https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator)  \nWindows: [https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe](https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe)\n\n##### MacOSì˜ ê²½ìš° \n```bash\n$ curl -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator\n$ chmod +x ./aws-iam-authenticator\n$ cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$HOME/bin:$PATH\n```\n\n##### MacOS bash í™˜ê²½ë³€ìˆ˜ ì¶”ê°€\n```bash\n$ echo 'export PATH=$HOME/bin:$PATH' >> ~/.bash_profile\n```\n\n##### MacOS zsh í™˜ê²½ë³€ìˆ˜ ì¶”ê°€\n```bash\n$ echo 'export PATH=$HOME/bin:$PATH' >> ~/.zshrc\n```\n\n#### aws-iam-authenticator binary í™•ì¸\n```bash\n$ aws-iam-authenticator help\n```\n\n### eksctl\n\n![mascot](https://github.com/weaveworks/eksctl/blob/master/logo/eksctl.png?raw=true)\n\neksctlì€ weaveworksì—ì„œ contributeí•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ë¡œ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ëŠ” ê°„ë‹¨í•œ CLI ë„êµ¬ì´ë‹¤. Goë¡œ ì‘ì„±ë˜ì–´ ìˆê³  CloudFormationì„ ê¸°ë³¸ìœ¼ë¡œ ë™ì‘í•œë‹¤.  \n\n[https://eksctl.io/](https://eksctl.io/)  \n[https://github.com/weaveworks/eksctl](https://github.com/weaveworks/eksctl)\n\n#### eksctl binary ë‹¤ìš´ë¡œë“œ\n```bash\n$ curl --silent --location \"https://github.com/weaveworks/eksctl/releases/download/latest_release/eksctl_$(uname -s)_amd64.tar.gz\" | tar xz -C /tmp\n$ sudo mv -v /tmp/eksctl /usr/local/bin\n```\n\n#### MacOS Homebrew ì„¤ì¹˜\n```bash\n$ brew tap weaveworks/tap\n$ brew install weaveworks/tap/eksctl\n```\n\n#### Windows ì„¤ì¹˜ (PowerShell, chocolatey)\n```\nchocolatey install eksctl\n```\n\n#### eksctl ë™ì‘í™•ì¸\n```bash\n$ eksctl version\n```\n\n#### CLI API ìê²©ì¦ëª… êµ¬ì„±\n\nì‚¬ì „ì„¤ì •í•œ aws configureê°€ ìˆëŠ”ì§€ í™•ì¸. ê¸°ì¡´ Terraformì´ë‚˜ kops ì‚¬ìš©í•œì ì´ ìˆìœ¼ë©´ ê±´ë„ˆë›°ì–´ë„ ëœë‹¤.  \n```bash\n$ ls  ~/.aws\n```\nì—†ì„ê²½ìš° aws ìê²©ì¦ëª…ì„ ìƒì„±í•œë‹¤.\n\n#### ~/.aws/credentials\n```\n[default]\naws_access_key_id={EXAMPLE}\naws_secret_access_key={EXAMPLEKEY}\n```\n\n#### ~/.aws/config\n```\n[default]\nregion=ap-northeast-2\noutput=json\n```\n\n## EKS ë°°í¬\nkubectl, aws-iam-authenticator, eksctl, AWS ìê²©ì¦ëª… í™˜ê²½ê¹Œì§€ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ë°°í¬ê°€ ê°€ëŠ¥í•˜ë‹¤.  \n\n```bash\n$ eksctl create cluster --name=eksworkshop-eksctl --nodes=3 --node-ami=auto\n[â„¹]  using region ap-northeast-2\n[â„¹]  setting availability zones to [ap-northeast-2a ap-northeast-2c ap-northeast-2a]\n[â„¹]  subnets for ap-northeast-2a - public:192.168.0.0/19 private:192.168.96.0/19\n[â„¹]  subnets for ap-northeast-2c - public:192.168.32.0/19 private:192.168.128.0/19\n[â„¹]  subnets for ap-northeast-2a - public:192.168.64.0/19 private:192.168.160.0/19\n[â„¹]  nodegroup \"ng-cfb3cb01\" will use \"ami-0c7972077aa002104\" [AmazonLinux2/1.11]\n[â„¹]  creating EKS cluster \"eksworkshop-eksctl\" in \"ap-northeast-2\" region\n[â„¹]  will create 2 separate CloudFormation stacks for cluster itself and the initial nodegroup\n[â„¹]  if you encounter any issues, check CloudFormation console or try 'eksctl utils describe-stacks --region=ap-northeast-2 --name=eksworkshop-eksctl'\n[â„¹]  creating cluster stack \"eksctl-eksworkshop-eksctl-cluster\"\n[â„¹]  creating nodegroup stack \"eksctl-eksworkshop-eksctl-nodegroup-ng-cfb3cb01\"\n[â„¹]  --nodes-min=2 was set automatically\n[â„¹]  --nodes-max=2 was set automatically\n[âœ”]  all EKS cluster resource for \"eksworkshop-eksctl\" had been created\n[âœ”]  saved kubeconfig as \"/Users/ddii/.kube/config\"\n[â„¹]  nodegroup \"ng-cfb3cb01\" has 0 node(s)\n[â„¹]  waiting for at least 2 node(s) to become ready in \"ng-cfb3cb01\"\n[â„¹]  nodegroup \"ng-cfb3cb01\" has 2 node(s)\n[â„¹]  node \"ip-192-168-42-42.ap-northeast-2.compute.internal\" is ready\n[â„¹]  node \"ip-192-168-66-165.ap-northeast-2.compute.internal\" is ready\n[â„¹]  kubectl command should work with \"/Users/ddii/.kube/config\", try 'kubectl get nodes'\n[âœ”]  EKS cluster \"eksworkshop-eksctl\" in \"ap-northeast-2\" region is ready\n```\n\nì„œìš¸ë¦¬ì „(ap-northeast-2)ê¸°ì¤€ ì•½ 15-20ë¶„ì´ ì†Œìš”ë˜ë©° `eksctl` ê¸°ë³¸ ì„¤ì •ê°’ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.\n\n* í´ëŸ¬ìŠ¤í„°ëª…ì€ ìë™ìƒì„±, --name ì˜µì…˜ìœ¼ë¡œ ì§€ì •ê°€ëŠ¥ (eksworkshop-eksctl)\n* CloudFormation : eksctl-{$Cluster_Name}-cluster\n* m5.large * 2 instances ([EKS Instance Type](https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/amazon-eks-nodegroup.yaml) NodeInstanceType.AllowedValues ì°¸ê³ )\n* Default AMI : AWS EKS AMI (custom EKS AMI ê°€ëŠ¥ - Packerí™œìš©)\n* Default Region : us-west-2\n* dedicated VPC : 192.168.0.0/16 \n* kubernetes version : 1.11.x ([EKS Version](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/platform-versions.html) ì°¸ê³ )\n* StorageClass : gp2 ([AWS EBS](https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs) ì°¸ê³ )\n* CNI : [Amazon VPC](https://github.com/aws/amazon-vpc-cni-k8s)\n* Node Autoscaler : --node-min, --node-max Auto Scaling ì„¤ì •\n* ê¸°ë³¸ Pod ê°œìˆ˜ : [ì°¸ê³ ](https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/files/eni-max-pods.txt)\n* nodegroup : workerê°€ í¬í•¨ë˜ëŠ” group \n* kubeconfig : ~/.kube/config ë¡œ í†µí•©ë¨\n \n### Config File ì‚¬ìš©\n\n[https://github.com/weaveworks/eksctl/tree/master/examples](https://github.com/weaveworks/eksctl/tree/master/examples)ë¥¼ ì°¸ê³ í•˜ì—¬ `YAML`í˜•íƒœë¡œ ì‘ì„±í•˜ì—¬ ë°°í¬ê°€ëŠ¥í•˜ë‹¤. \n\n```bash\n$ eksctl create cluster -f example.yaml\n```\n\nê¸°ì¡´ì— ê´€ë¦¬í•˜ëŠ” VPC subnetì •ë³´ ë° AutoScaling, AZ(availabilityZones)ì„¤ì •, nodegroup ê´€ë¦¬, node Instanceì— preBootstrapCommandë“±ì„ ì•„ë˜ ì˜ˆì‹œì™€ ê°™ì´ ë¯¸ë¦¬ ì‘ì„±í•˜ë©´ GitOpsì¸¡ë©´ì—ì„œ í™œìš©ë„ê°€ ë”ìš± ë†’ì•„ì§ˆìˆ˜ ìˆë‹¤.\n\n#### 05-advanced-nodegroups.yaml\n```yaml\n# An advanced example of ClusterConfig object with customised nodegroups:\n--- \napiVersion: eksctl.io/v1alpha4\nkind: ClusterConfig\n\nmetadata:\n  name: cluster-5\n  region: eu-west-2\n\nnodeGroups:\n  - name: ng1-public\n    instanceType: m5.xlarge\n    minSize: 2\n    maxSize: 8\n    labels:\n      nodegroup-type: frontend-workloads\n    iam:\n      withAddonPolicies:\n        autoScaler: true\n\n  - name: ng2-private-a\n    instanceType: m5.large\n    desiredCapacity: 2\n    labels:\n      nodegroup-type: backend-cluster-addons\n    privateNetworking: true\n    preBootsrapCommand:\n      # allow docker registries to be deployed as cluster service \n      - 'echo {\\\"insecure-registries\\\": [\\\"172.20.0.0/16\\\",\\\"10.100.0.0/16\\\"]} > /etc/docker/daemon.json'\n      - \"systemctl restart docker\"\n\n  - name: ng3-private-b\n    instanceType: c3.8xlarge\n    desiredCapacity: 4\n    labels:\n      nodegroup-type: very-special-science-workloads\n    privateNetworking: true\n    availabilityZones: [\"eu-west-2a\"] # use single AZ to optimise data transfer between isntances\n    preBootstrapCommand:\n      # disable hyperthreading\n      - \"for n in $(cat /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | cut -s -d, -f2- | tr ',' '\\n' | sort -un); do echo 0 > /sys/devices/system/cpu/cpu${n}/online; done\"\n\n# cluster AZs must be set explicitly for single AZ nodegroup example to work\navailabilityZones: [\"eu-west-2a\", \"eu-west-2b\", \"eu-west-2c\"]\n```\n\n## Kubernetes ëŒ€ì‹œë³´ë“œ ë°°í¬\n\nKubernetes ê³µì‹ ëŒ€ì‹œë³´ë“œëŠ” ê¸°ë³¸ìœ¼ë¡œ ë°°í¬ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•´ì•¼í•œë‹¤. ì„¤ì¹˜ ë°©ë²•ì€ [ê³µì‹ ë¬¸ì„œ](https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/)ì—ì„œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.  \n\nìœ„ì—ì„œ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„°ì—ì„œ Kubernetes ëŒ€ì‹œë³´ë“œë¥¼ ë°°í¬í•œë‹¤.\n```bash\n$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml\n```\n\nì ‘ì†ì„ ìœ„í•´ kube-proxy ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ 8080í¬íŠ¸ë¡œ exposeë¥¼ ì§„í–‰í•œë‹¤. ëª¨ë“  ì¸í„°í˜ì´ìŠ¤ì—ì„œ í•„í„°ë§ì—†ì´ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë„ë¡ ì˜µì…˜ì„ ì§€ì •í•œë‹¤. \nì•„ë˜ ëª…ë ¹ì€ í„°ë¯¸ë„ì—ì„œ ë°±ê·¸ë¼ìš´ë“œë¡œ ê³„ì† ë™ì‘í•œë‹¤.  \n```bash\n$ kubectl proxy --port=8080 --address='0.0.0.0' --disable-filter=true &\nW0328 16:39:09.061754    9100 proxy.go:139] Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious\n```\n\nTOKENìœ¼ë¡œ ì ‘ì†í•˜ê¸° ìœ„í•´ aws-iam-authenticatorë¥¼ í†µí•´ í•´ë‹¹ í´ëŸ¬ìŠ¤í„° tokenì„ í™•ì¸í•œë‹¤.  \n```bash\n$ aws-iam-authenticator token -i eksworkshop-eksctl --token-only\nk8s-aws-v1.aHR0cHM6Ly9zdHMuYXAtbm9ydGhlYXN0LTIuYW1hem9uYXdzLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMS0wNi0xNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFKMjVNVjJSVVZQNlRWTURBJTJGMjAxOTAzMjglMkZhcC1ub3J0aGVhc3QtMiUyRnN0cyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMTkwMzI4VDA3NDEwNVomWC1BbXotRXhwaXJlcz0wJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TaWduYXR1cmU9Yjc0NzkzYzUwOTU5NDYwMzMxMjY2YjExYWY4ODBkM2Q2OWQ5MWRhYzFhZWY1NjZmZTAwNTNlNWY2MTM0NGFlZQ\n```\n\nê·¸ëƒ¥ localhost:8080 ìœ¼ë¡œë§Œ ì ‘ì†í•˜ë©´ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„° kube API listë¥¼ í™•ì¸ë˜ë¯€ë¡œ ì•„ë˜ ê²½ë¡œë¡œ ì ‘ì†í•œë‹¤.  \nìœ„ì—ì„œ ì¶œë ¥ëœ TOKENê°’ìœ¼ë¡œ ë¡œê·¸ì¸í•œë‹¤. Token ì„¸ì…˜ Timeoutì´ ìˆìœ¼ë‹ˆ ì„¸ì…˜ë§Œë£Œì‹œ `aws-iam-authenticator` ëª…ë ¹ì„ í†µí•´ ê°±ì‹ ê°’ì„ ì…ë ¥í•˜ë©´ ëœë‹¤.  \n```\nhttp://localhost:8080/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login\n```\n![dashboard](/img/k8s_dashboard.png)\n\n\n## Microservice app ë°°í¬\nê°€ì¥ ê¸°ë³¸ì ì¸ [Sock Shop](https://microservices-demo.github.io/)ì„ ë°°í¬í•˜ê¸° ìœ„í•´ Git Clone ìˆ˜í–‰\n```bash\n$ git clone https://github.com/microservices-demo/microservices-demo.git sockshop\n$ cd sockshop/deploy/kubernetes\n```\n\n`NodePort`ë¡œ ë˜ì–´ìˆëŠ” Front-End Serviceë¥¼ `LoadBalancer`ë¡œ ìˆ˜ì •í•œë‹¤.\n```bash\n$ sed -i 's/NodePort/LoadBalancer/g' complete-demo.yaml\n$ cat complete-demo.yaml | grep LoadBalancer\n type: LoadBalancer\n```\n\n\nnamespace ìƒì„± ë° sock-shop ë°°í¬\n```bash\n$ kubectl create namespace sock-shop\n$ kubectl apply -f complete-demo.yaml\n$ kubectl get all\n```\n\nì„œë¹„ìŠ¤ ì ‘ì†í™•ì¸ì„ ìœ„í•´ì„œëŠ” ALBë°°í¬ì‹œê°„(DNSì „íŒŒ)ì´ ì¼ì • ì†Œìš”ë˜ë¯€ë¡œ ì ì‹œí›„ ì ‘ì†ì„ ì‹œë„í•œë‹¤.\n```bash\n$ kubectl get svc\nNAME           TYPE           CLUSTER-IP       EXTERNAL-IP                                                                 PORT(S)        AGE\ncarts          ClusterIP      10.100.84.58     <none>                                                                      80/TCP         1h\ncarts-db       ClusterIP      10.100.227.156   <none>                                                                      27017/TCP      1h\ncatalogue      ClusterIP      10.100.206.52    <none>                                                                      80/TCP         1h\ncatalogue-db   ClusterIP      10.100.119.66    <none>                                                                      3306/TCP       1h\nfront-end      LoadBalancer   10.100.249.164   a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com   80:30001/TCP   1h\norders         ClusterIP      10.100.160.17    <none>                                                                      80/TCP         1h\norders-db      ClusterIP      10.100.70.203    <none>                                                                      27017/TCP      1h\npayment        ClusterIP      10.100.57.233    <none>                                                                      80/TCP         1h\nqueue-master   ClusterIP      10.100.146.109   <none>                                                                      80/TCP         1h\nrabbitmq       ClusterIP      10.100.32.115    <none>                                                                      5672/TCP       1h\nshipping       ClusterIP      10.100.180.174   <none>                                                                      80/TCP         1h\nuser           ClusterIP      10.100.211.41    <none>                                                                      80/TCP         1h\nuser-db        ClusterIP      10.100.87.142    <none>                                                                      27017/TCP      1h\n```\n  \n\në¸Œë¼ìš°ì €ì—ì„œ ALBì£¼ì†Œ `a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com` ë¡œ ì ‘ì†í•˜ì—¬ sock-shop Demo Webì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.  \n\n![sockshop](/img/sock-shop.png)\n\n\n## EKS í´ëŸ¬ìŠ¤í„° ë° ì‚­ì œ\n\nìœ„ì—ì„œ ì™¸ë¶€ì ‘ì†ì„ ìœ„í•´ LoadBalancerë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ìœ¼ë¯€ë¡œ EC2 - Load Balancerì„œ í”„ë¡œë¹„ì €ë‹ëœ ALBë¥¼ ì‚­ì œí•˜ê³  ì§„í–‰í•´ì•¼ í•œë‹¤.  \n\ní´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê³  EXTERNAL-IPê°’ê³¼ ì—°ê²°ëœ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì‚­ì œí•œë‹¤.  \n```bash\n$ kubectl get svc --all-namespaces\n$ kubectl delete svc front-end\n```\n\nALBì™€ VPC ì‚­ì œê°€ ì™„ë£Œëœê²ƒì„ í™•ì¸í•˜ê³  í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•˜ì.  \n\n```bash\n$ eksctl delete cluster --name=eksworkshop-eksctl\n[â„¹]  deleting EKS cluster \"eksworkshop-eksctl\"\n[â„¹]  will delete stack \"eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7\"\n[â„¹]  waiting for stack \"eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7\" to get deleted\n[â„¹]  will delete stack \"eksctl-eksworkshop-eksctl-cluster\"\n[âœ”]  kubeconfig has been updated\n[âœ”]  the following EKS cluster resource(s) for \"eksworkshop-eksctl\" will be deleted: cluster. If in doubt, check CloudFormation console\n```\n\n## ì •ë¦¬\nì„œìš¸ ë¦¬ì „(ap-northeast-2)ì— EKSê°€ ì˜¤í”ˆë˜ê³  Productioní™˜ê²½ì„ EKSë¡œ ë„˜ì–´ê°€ëŠ” ê¸°ì—…ë“¤ì´ ë§ì•„ì§€ê³  ìˆëŠ”ê±´ ì•„ì£¼ ê¸ì •ì ì¸ í˜„ìƒì´ë‹¤.  \në˜í•œ ì—„ì²­ë‚œ ì†ë„ì˜ ê¸°ìˆ ê°œë°œê³¼ ë‹¤ì–‘í•œ íˆ´ë“¤ë¡œ Kubernetes Clusterë¥¼ êµ¬ì„±í•˜ê±°ë‚˜ Microserviceí˜•íƒœì˜ Appì„ ë°°í¬í•˜ëŠ”ê²ƒì€ ì ì  ëŒ€ì¤‘í™” ë˜ì–´ê°€ê³  ìˆë‹¤.  \nì‹¤ì œ Productionì—ì„œ êµ¬í˜„ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ë³´ì•ˆ ë° ì„±ëŠ¥ì„ ë™ì‹œì— ê³ ë ¤í•œ ë„¤íŠ¸ì›Œí¬(CNI), Ingress ì„¤ì •ì´ë‚˜ ì „ì²´ í´ëŸ¬ìŠ¤í„° í¼í¬ë¨¼ìŠ¤ ì¸¡ë©´ì—ì„œì˜ íŒŒë¼ë¯¸í„° íŠœë‹ì´ ë”ìš± ë” ì¤‘ìš”í•´ì§€ê³  ê´€ë ¨ëœ DevOps(SRE) ì¸ë ¥ë“¤ì˜ ì¤‘ìš”ë„ê°€ ë†’ì•„ì§ˆê²ƒì€ ë¶„ëª…í•´ ë³´ì¸ë‹¤.  \n\nEKSë¥¼ ì˜¤í”ˆì†ŒìŠ¤ ì¸¡ë©´ì—ì„œ ê³ ë ¤í–ˆì„ë•Œì—ëŠ” ì˜ˆì „ì— í˜ì´ìŠ¤ë¶ì´ë‚˜ ë‹¤ë¥¸ê³³ì—ì„œ ì¢…ì¢… ì´ì•¼ê¸° í–ˆë˜ê²ƒì²˜ëŸ¼ AWS ê³ ìœ ì˜ Lock-in ì „ëµì„ ì—„ì²­ë‚˜ê²Œ ê³ ë¯¼í•˜ê³  ë°œí‘œí•œë“¯í•œ ìƒê°ì´ í•œ ëŠë‚Œì„ ì§€ìš¸ìˆ˜ëŠ” ì—†ëŠ”ê±´ ì‚¬ì‹¤ì´ì§€ë§Œ í›Œë¥­í•œ ì œí’ˆì¸ê±´ í™•ì‹¤í•˜ê³  ë‹¨ê¸°ê°„ì— ì„œë¹„ìŠ¤ ì„±ì¥ì†ë„ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ë¼ ìƒê°í•œë‹¤.  \n\në§ˆì§€ë§‰ìœ¼ë¡œ Managed Kubernetesì˜ ì„ íƒì€ ì—”ì§€ë‹ˆì–´ì˜ ëª«ìœ¼ë¡œ ë³´ê³  ê° ë²¤ë”ë³„ ë¹„êµí•œ ì•„ë˜ ë§í¬ë¥¼ ì°¸ì¡°í•´ì„œ ì„ ì • ê¸°ì¤€ì„ ì¡ìœ¼ë©´ ë”ìš± ì¢‹ì„ê²ƒ ê°™ë‹¤.  \n[https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0](https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0)"
    },
    {
      "id": "kubernetes/git-sync/",
      "metadata": {
        "permalink": "/kubernetes/git-sync/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-03-21-git-sync.md",
        "source": "@site/blog/2019-03-21-git-sync.md",
        "title": "git-sync",
        "description": "git-syncì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤.",
        "date": "2019-03-21T00:00:00.000Z",
        "formattedDate": "March 21, 2019",
        "tags": [
          {
            "label": "git-sync",
            "permalink": "/tags/git-sync"
          },
          {
            "label": "GitOps",
            "permalink": "/tags/git-ops"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "ssh git",
            "permalink": "/tags/ssh-git"
          },
          {
            "label": "sidecar",
            "permalink": "/tags/sidecar"
          },
          {
            "label": "sidecar pattern",
            "permalink": "/tags/sidecar-pattern"
          }
        ],
        "readingTime": 8.095,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "git-sync",
          "comments": true,
          "classes": "wide",
          "description": "git-syncì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤.",
          "slug": "kubernetes/git-sync/",
          "date": "2019-03-21T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "git-sync",
            "GitOps",
            "Kubernetes",
            "ssh git",
            "sidecar",
            "sidecar pattern"
          ]
        },
        "prevItem": {
          "title": "eksworkshop",
          "permalink": "/kubernetes/eksworkshop/"
        },
        "nextItem": {
          "title": "VScode Server",
          "permalink": "/tools/vscode-server/"
        }
      },
      "content": "git repoë¥¼ kubernetes volumeìœ¼ë¡œ êµ¬í˜„í• ìˆ˜ ìˆëŠ” sidecar pattern `git-sync` í”„ë¡œì íŠ¸ì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤.\n\n## git-sync\n\n[Kubernetes Github](https://github.com/kubernetes)ì— ë°©ë¬¸í•˜ë©´ ë‹¤ì–‘í•œ í”„ë¡œì íŠ¸ë“¤ì„ ë³¼ ìˆ˜ ìˆë‹¤.  \n[Kubernetes Project](https://github.com/kubernetes/kubernetes)ë¶€í„° minikube, kubeadm, kubectl, kubelet, dashboardë“± í•„ìˆ˜ì ìœ¼ë¡œ í•„ìš”í•˜ê±°ë‚˜ ë§ì´ ì‚¬ìš©ë˜ëŠ” í”„ë¡œì íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆëŠ”ë°,\nê¸°ì¡´ì— storage volume ìœ¼ë¡œ í™œìš©ë˜ë˜ [gitrepo](https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo)ê°€ `deprecated` ë˜ì–´ì„œ ë°©ë²•ì„ ì°¾ë‹¤ê°€ ìœ ì‚¬í•œ í”„ë¡œì íŠ¸ë¥¼ ê³µì‹ repoì—ì„œ ìš°ì—°íˆ ë°œê²¬í•˜ê²Œ ë˜ì—ˆë‹¤.  \n\n[git-sync](https://github.com/kubernetes/git-sync)ëŠ” sidecar ë°©ì‹ìœ¼ë¡œ git repositoryë¥¼ cloneí•˜ëŠ” í”„ë¡œì íŠ¸ì´ë‹¤.  \n\nìµœì´ˆ í•œë²ˆ cloneë„ ê°€ëŠ¥í•˜ê³  ì¼ì •í•œ ê°„ê²©ìœ¼ë¡œ ëŒì–´ì™€ì„œ ì‘ìš©í”„ë¡œê·¸ë¨ì— ì‚¬ìš©í•  ìˆ˜ ìˆê³  ì›í•˜ëŠ” branch, Tag ë˜ëŠ” íŠ¹ì • git hash ê¸°ë°˜ìœ¼ë¡œ pullingì´ ê°€ëŠ¥í•˜ë‹¤.  \n\nupstreamì˜ repositoryì—ì„œ ëŒ€ìƒì´ ë³€ê²½ë˜ì—ˆì„ë•Œ ë‹¤ì‹œ pullingí•˜ê³ , webhookê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ë¹„ë™ê¸°ì„±ìœ¼ë¡œ POST ìš”ì²­ì´ ìˆì„ë•Œë§Œ git-syncë¥¼ ìˆ˜í–‰í• ìˆ˜ ìˆê¸° ë•Œë¬¸ì— \nContinuous Deploymentë¥¼ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•˜ëŠ”ë° í™œìš©ë  ìˆ˜ ìˆë‹¤. \n\n## GitHub SSHì„¤ì •\n\ngit ë‚´ìš©ì„ pullingì„ í• ë•Œ https, ssh ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ”ë° GitHub ssh keyë¥¼ kubernetes clusterì˜ secretìœ¼ë¡œ ì‚¬ìš©ì„ í• ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ssh ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì‘ì„±í•˜ì˜€ë‹¤.  \n\nì•„ë˜ ëª¨ë“  ê³¼ì •ì€ MacOSì—ì„œ ì§„í–‰í•˜ì˜€ê³  ë‹¤ë¥¸ OSëŠ” ì•„ë˜ ë§í¬ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.  \n[https://help.github.com/en/articles/connecting-to-github-with-ssh](https://help.github.com/en/articles/connecting-to-github-with-ssh)\n\nì‚¬ìš©í•˜ê³ ì í•˜ëŠ” í„°ë¯¸ë„ì—ì„œ ë“±ë¡í‚¤ë¥¼ í™•ì¸í•˜ì.\n\n### ê¸°ì¡´ì— ë“±ë¡ëœ SSH key í™•ì¸\n```\n$ ls -al ~/.ssh\n```\n\n### ìƒˆë¡œìš´ SSH key ìƒì„±\n```\n$ ssh-keygen -t rsa -b 4096 -C \"ddiiwoong@gmail.com\"\n# Start the SSH key creation process\n> Enter file in which the key is (/Users/you/.ssh/id_rsa): [Hit enter]\n> Key has comment '/Users/you/.ssh/id_rsa'\n> Enter new passphrase (empty for no passphrase): [Type new passphrase]\n> Enter same passphrase again: [One more time for luck]\n> Your identification has been saved with the new passphrase.\n```\n\n### ssh agent ì‹¤í–‰ì¤‘ì¸ì§€ í™•ì¸\n```\neval â€œ$(ssh-agent -s)â€\n> Agent pid 59566\n```\n\n### ìƒì„±ëœ í‚¤ë¥¼ keychainì— ì €ì¥ ë° í™•ì¸\n```\n$ ssh-add -K ~/.ssh/id_rsa\n$ cat ~/.ssh/id_rsa.pub\n```\n\n### ë³µì‚¬ ë° githubì— ì¶”ê°€\n```\n$ pbcopy < ~/.ssh/id_rsa.pub\n```\nSetting - SSH and GPG keys - SSH keys - New SSH key  \n`Title`ì€ êµ¬ë¶„ìë¡œ ì…ë ¥í•˜ê³  GitHub passwordë¥¼ í•œë²ˆë” ì…ë ¥í•˜ê³  ì™„ë£Œí•œë‹¤.  \n\n### í„°ë¯¸ë„ì—ì„œ SSHì ‘ì† í™•ì¸\n```\n$ ssh -T git@github.com\nHi ddiiwoong! You've successfully authenticated, but GitHub does not provide shell access.\n```\n\n## git-syncë¥¼ ìœ„í•œ secret ë“±ë¡\n\n[https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md](https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md)\n\n### secret ìƒì„±\nìœ„ì—ì„œ ìƒì„±í•œ SSH keyë¥¼ Kubernetes Clusterì— Secret resourceë¡œ ì €ì¥ì„ í•œë‹¤.\n\n```\n$ ssh-keyscan github.com > /tmp/known_hosts\n# github.com:22 SSH-2.0-babeld-9d924d26\n# github.com:22 SSH-2.0-babeld-9d924d26\n# github.com:22 SSH-2.0-babeld-9d924d26\n```\n\nknown_hostsì™€ keyë¥¼ Secretìœ¼ë¡œ ì €ì¥í•œë‹¤.\n```\n$ kubectl create secret generic git-creds \\\n    --from-file=ssh=$HOME/.ssh/id_rsa \\\n    --from-file=known_hosts=/tmp/known_hosts\n\n$ kubectl get secret git-creds\nNAME        TYPE      DATA      AGE\ngit-creds   Opaque    2         1d\n```\n\n## sample ngnix ë°°í¬\n\nê¸°ë³¸ì ìœ¼ë¡œ `git-sync/cmd/git-sync/main.go` ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ë©´ ì—¬ëŸ¬ê°€ì§€ flagë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì˜µì…˜ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.\n* ssh : pulling ë°©ì‹ (default=false)\n* root : git cloneì´ ìˆ˜í–‰ë˜ëŠ” root directory (default=\"$HOME/git\")\n* repo : clone ëŒ€ìƒ Repository (default=\"\")\n* branch : branch (default=master)\n* rev : git revision (tag or hash) to check out\n* depth : commit depth (default=0)\n* dest : repository ë°°í¬ directory\n\nê¸°íƒ€ ì˜µì…˜ë“¤ì€ `git-sync/cmd/git-sync/main.go` ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë©° í•´ë‹¹ ì˜µì…˜ë“¤ì„ ë³€ìˆ˜ë¡œ ì²˜ë¦¬í•˜ì—¬ í™œìš©í•˜ë©´ ëœë‹¤.\n\n### git-sync-demo.yaml ì‘ì„±\n\n```\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: git-sync-demo\n  name: git-sync-demo\n  namespace: default\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: git-sync-demo\n  template:\n    metadata:\n      labels:\n        app: git-sync-demo\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14-alpine\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: git-sync-volume\n          mountPath: /usr/share/nginx\n      - name: git-sync\n        image: k8s.gcr.io/git-sync:v3.1.1\n        imagePullPolicy: Always\n        args:\n         - \"-ssh\"\n         - \"-repo=git@github.com:ddiiwoong/git-sync-demo.git\"\n         - \"-root=/usr/share/nginx\"\n         - \"-dest=html\"\n         - \"-branch=master\"\n         - \"-depth=1\"\n        volumeMounts:\n        - name: git-sync-volume\n          mountPath: /usr/share/nginx\n        - name: git-secret\n          mountPath: /etc/git-secret\n      volumes:\n      - name: git-sync-volume\n        emptyDir: {}\n      - name: git-secret\n        secret:\n          secretName: git-creds\n          defaultMode: 288 # = mode 0440\n      securityContext:\n        fsGroup: 65533 # to make SSH key readable\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: git-sync-demo\nspec:\n  type: NodePort\n  selector:\n    app: git-sync-demo\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n```\n### í™•ì¸ì‚¬í•­\nì¼ë‹¨ ngnixë¡œ 1.14-alpine Imageë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³  git-sync containerê°€ sidecarë¡œ ë“¤ì–´ê°€ë„ë¡ ì‘ì„±í•˜ì˜€ë‹¤.  \nì‹¤ì œ ë™ì‘í•˜ëŠ” ìˆœì„œëŒ€ë¡œ manifestë¥¼ ì•„ë˜ì„œë¶€í„° ì‚´í´ë³´ì.\n\n* git-sync-volumeì€ `emptyDir`, git-secretì€ `secret` volume ì„¤ì •\n  ```\n  ...\n      volumes:\n      - name: git-sync-volume\n        emptyDir: {}\n      - name: git-secret\n        secret:\n          secretName: git-creds\n          defaultMode: 288 # = mode 0440\n  ...\n  ```\n* sidecar container imageë¥¼ `k8s.gcr.io/git-sync:v3.1.1`ë¡œ ì„¤ì •\n* `git-sync-volume`, `git-sync-volume` volumeì„ `git-sync` sidecarì— ë§ˆìš´íŠ¸\n* ìœ„ì—ì„œ ì´ì•¼ê¸°í•œ `git-sync` flag, argsë¡œ ì„¤ì •\n  ```\n  ...\n      containers:\n      - name: git-sync\n        image: k8s.gcr.io/git-sync:v3.1.1\n        imagePullPolicy: Always\n        args:\n         - \"-ssh\"\n         - \"-repo=git@github.com:ddiiwoong/git-sync-demo.git\"\n         - \"-root=/usr/share/nginx\"\n         - \"-dest=html\"\n         - \"-branch=master\"\n         - \"-depth=1\"\n        volumeMounts:\n        - name: git-sync-volume\n          mountPath: /usr/share/nginx\n        - name: git-secret\n          mountPath: /etc/git-secret\n  ...\n  ```\n* nginx ê¸°ë³¸ ìœ„ì¹˜ê°€ `/usr/share/nginx` ì´ë¯€ë¡œ mount ìœ„ì¹˜ë¥¼ git-sync-volumeìœ¼ë¡œ ì„¤ì •\n  ```\n  ...\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14-alpine\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: git-sync-volume\n          mountPath: /usr/share/nginx\n  ...\n  ```\n\nìœ„ nginxë¥¼ ë°°í¬í•˜ê³  ì ‘ì†í•˜ë©´ `Hello git-sync demo v1.0`ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\nê²°êµ­ git repo code (static html page)ëŠ” `/usr/share/nginx/html` ìœ„ì¹˜ì— clone ë˜ëŠ”ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ \nì‹¤ì œ clone ìœ„ì¹˜ë¥¼ í™•ì¸í•´ë³´ë©´ symbolic linkë¡œ íŠ¹ì • revision dirë¥¼ ê°€ë¦¬í‚¤ê³  ìˆë‹¤.\n\n```\n$ kubectl exec -it git-sync-demo-665c9c9ddf-6nwc4 sh\nDefaulting container name to nginx.\nUse 'kubectl describe pod/git-sync-demo-665c9c9ddf-6nwc4 -n default' to see all of the containers in this pod.\n/ # cd /usr/share/nginx/\n/usr/share/nginx # ls -al\ntotal 16\ndrwxrwsrwx    4 root     nogroup       4096 Mar 21 06:54 .\ndrwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..\ndrwxr-sr-x    9 65533    nogroup       4096 Mar 21 06:54 .git\nlrwxrwxrwx    1 65533    nogroup         44 Mar 21 06:54 html -> rev-07aa36f719091d75b5665203fa5846a549e7d540\ndrwxr-sr-x    2 65533    nogroup       4096 Mar 21 06:54 rev-07aa36f719091d75b5665203fa5846a549e7d540\n/usr/share/nginx # cat ./html/index.html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>Hello git-sync demo</title>\n  </head>\n  <body>\n    <h1>Hello git-sync demo v1.0</h1>\n  </body>\n</html>\n```\n\ngithubì— ìˆëŠ” ìœ„ index.html ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  commitì„ í•˜ê²Œ ë˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ revision ì •ë³´ ë° ë‚´ìš©ì´ ë°”ë€ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.  \n\n```\n/usr/share/nginx # ls -al\ntotal 16\ndrwxrwsrwx    4 root     nogroup       4096 Mar 21 13:40 .\ndrwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..\ndrwxr-sr-x    9 65533    nogroup       4096 Mar 21 13:40 .git\nlrwxrwxrwx    1 65533    nogroup         44 Mar 21 13:40 html -> rev-b125908649135856d79c515c17decba68797a6cb\ndrwxr-sr-x    2 65533    nogroup       4096 Mar 21 13:40 rev-b125908649135856d79c515c17decba68797a6cb\n/usr/share/nginx # cat ./html/index.html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>Hello git-sync demo</title>\n  </head>\n  <body>\n    <h1>Hello git-sync demo v1.1</h1>\n  </body>\n</html>\n```\n\n## ì •ë¦¬\ngit-syncë¥¼ ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸í•´ë´¤ë‹¤.  \nê°„ë‹¨í•˜ê²Œ `sidecar` ë°©ì‹ì˜ clone toolë¡œì„œ `git-sync`ë¥¼ í™œìš©í•˜ë©´ ì—¬ëŸ¬ê°€ì§€ë¡œ ì¶©ë¶„íˆ í™œìš©ì´ ê°€ëŠ¥í•  ê²ƒì´ë‹¤.  \ní¬ìŠ¤íŒ…ì„ ì‘ì„±í•˜ë©´ì„œ ë– ì˜¤ë¥¸ í™œìš©ìš©ë„ë¥¼ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤. ì–´ì°Œë³´ë©´ sidecar patternì˜ í™œìš©ë°©ì•ˆì´ë¼ê³ ë„ ë³¼ìˆ˜ ìˆë‹¤.\n\n* CDNì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  gitì—ì„œ ì†Œê·œëª¨ë¡œ ì»¨í…ì¸ ë¥¼ ê°€ì ¸ì˜¬ë•Œ\n* DBMSê°€ í•„ìš”ì—†ì„ ì •ë„ì˜ ì ì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ë•Œ\n* jekyllì´ë‚˜ hugo ê°™ì€ ì •ì  ì‚¬ì´íŠ¸(ë¸”ë¡œê·¸)ì˜ sidecar íŒ¨í„´ (GitPageì²˜ëŸ¼ markdownì„ ì¶”ê°€í•˜ê³  git commití•˜ë©´ ë°”ë¡œ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë˜ëŠ” ë°©ì‹)\n* nginx, haproxy, apacheì™€ ê°™ì´ config ë³€ê²½ì´ í•„ìš”í• ë•Œ webhookë°©ì‹ìœ¼ë¡œ ì„¤ì •ì„ ë³€ê²½í•œí›„ podë¥¼ ì¬ê¸°ë™í•˜ëŠ” GitOps êµ¬í˜„"
    },
    {
      "id": "tools/vscode-server/",
      "metadata": {
        "permalink": "/tools/vscode-server/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-03-20-vscode-server.md",
        "source": "@site/blog/2019-03-20-vscode-server.md",
        "title": "VScode Server",
        "description": "code-serverë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ VScode ì„¤ì¹˜ì—†ì´ ì›ê²© í™˜ê²½ì—ì„œ ì‚¬ìš©í•´ë³´ì.",
        "date": "2019-03-20T00:00:00.000Z",
        "formattedDate": "March 20, 2019",
        "tags": [
          {
            "label": "vscode",
            "permalink": "/tags/vscode"
          },
          {
            "label": "code-server",
            "permalink": "/tags/code-server"
          },
          {
            "label": "kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "online coding",
            "permalink": "/tags/online-coding"
          },
          {
            "label": "GoormIDE",
            "permalink": "/tags/goorm-ide"
          },
          {
            "label": "Cloud9",
            "permalink": "/tags/cloud-9"
          }
        ],
        "readingTime": 5.13,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "VScode Server",
          "comments": true,
          "classes": "wide",
          "description": "code-serverë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ VScode ì„¤ì¹˜ì—†ì´ ì›ê²© í™˜ê²½ì—ì„œ ì‚¬ìš©í•´ë³´ì.",
          "slug": "tools/vscode-server/",
          "date": "2019-03-20T00:00:00.000Z",
          "categories": [
            "Tools"
          ],
          "tags": [
            "vscode",
            "code-server",
            "kubernetes",
            "online coding",
            "GoormIDE",
            "Cloud9"
          ]
        },
        "prevItem": {
          "title": "git-sync",
          "permalink": "/kubernetes/git-sync/"
        },
        "nextItem": {
          "title": "K3s on Raspberry Pi Cluster",
          "permalink": "/kubernetes/k3s-homelab/"
        }
      },
      "content": "IntelliJ IDEAë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ ê°œë°œì—…ë¬´ë¥¼ ê±°ì˜ ì†ë†“ë‹¤ì‹œí”¼ í•˜ë‹¤ë³´ë‹ˆ ë¼ì´ì„¼ìŠ¤ë¥¼ ì—°ì¥í•˜ì§€ ëª»í•˜ê²Œ ë˜ì—ˆê³  ì£¼ë¡œ Localì—ì„œ VScodeë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤. í˜„ì¬ ë¶€ì„œì™€ ì—…ë¬´ë„ ë°”ë€Œì—ˆê³  ì›Œë‚™ ê³ ê°€ë‹¤ë³´ë‹ˆ IDEë¥¼ ë¶€ì„œë¹„ë¡œ êµ¬ë§¤í•˜ë„ ì–´ë µë‹¤. ë­ ì–¼ë§ˆë‚˜ í•œë‹¤ê³  ë§í• ìˆ˜ë„ ìˆê² ì§€ë§Œ ì—…ë¬´íŠ¹ì„±ìƒ ê°œë°œíˆ´ì„ ì‚¬ë‹¬ë¼ê³  í• ìˆ˜ ì—†ê³  ìµœê·¼ í¬ë¡¬ë¶ì´ë‚˜ ì•„ì´íŒ¨ë“œ í”„ë¡œê°™ì€ íƒœë¸”ë¦¿ì„ ê°€ì§€ê³  ë‹¤ë‹ˆì‹œëŠ” ë¶„ë“¤ë„ ë§ê³  ë‹¨ìˆœ í•„ê¸°ë‚˜ ë©”ëª¨ê°€ ì•„ë‹Œ ì˜¨ë¼ì¸ í™˜ê²½ì—ì„œ ë¸”ë¡œê¹… í¬ìŠ¤íŒ… ì •ë„ëŠ” í• ìˆ˜ ìˆë‹¤ëŠ” ê°€ì •ìœ¼ë¡œ Web IDEë¥¼ êµ¬ì„±í•˜ëŠ” í¬ìŠ¤íŒ…ì„ ì‹œì‘í•´ë³¸ë‹¤. \n\n## Web IDE\nì´ë²ˆ í¬ìŠ¤íŒ…ì„ ì“°ê¸° ì‹œì‘í•˜ë©´ì„œ 2017ë…„ AWS re;inventì—ì„ ê°€ Cloud9 ì œí’ˆì´ ì¶œì‹œë˜ì–´ì„œ Lambdaì—ì„œ ì‚¬ìš©í–ˆë˜ ì¥ë©´ì´ ê°‘ìê¸° ë– ì˜¬ëë‹¤. Cloud 9ì€ [https://github.com/c9/core](https://github.com/c9/core)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ instanceë¥¼ ë„ëŠ”ê²ƒì„ ê¸°ë³¸ìœ¼ë¡œ í•œë‹¤. Lambdaì˜ ê¸°ë³¸ ì—ë””í„°ë„ ë‚˜ì˜ì§„ ì•Šì§€ë§Œ Cloud9ì—ì„œ ê°•ì¡°í•˜ëŠ” ë¶€ë¶„ì€ ì½”ë“œ í˜‘ì—…ì´ë‹¤. \n\n![cloud9](https://d1.awsstatic.com/product-marketing/Tulip/C9-Collab-Image@3x.e03a65d9488633c154358430540ab363dd1e8f45.png)\n\nAWSì—ì„œ ì„œë¹„ìŠ¤ë¡œ ì¶œì‹œë˜ê¸° ì´ì „ì—ë„ Dockerhubì—ì„œë„ ì¢…ì¢… í™•ì¸í• ìˆ˜ ìˆì—ˆì§€ë§Œ í˜„ì¬ëŠ” ì°¾ì•„ë³´ê¸° ì–´ë µë‹¤. \n\nêµ­ë‚´ì—ëŠ” Cloud í˜•íƒœë¡œ [GoormIDE](https://ide.goorm.io/) ì œí’ˆì´ ìˆë‹¤.  \nFree ì—ë””ì…˜ë„ ìˆìœ¼ë‹ˆ ë”°ë¡œ í™•ì¸í•´ë³´ë©´ ëœë‹¤. (ì‘ì›í•©ë‹ˆë‹¤!)\n\nì´ì™¸ì—ë„ [https://github.com/theia-ide/theia](https://github.com/theia-ide/theia), [https://github.com/codercom/code-server](https://github.com/codercom/code-server)ì™€ ê°™ì€ Webê¸°ë°˜ ì˜¤í”ˆì†ŒìŠ¤ê°€ ì¡´ì¬í•˜ê³  ë‘˜ë‹¤ ìƒìš©ì´ë‚˜ Betaí˜•íƒœë¡œ ì„œë¹„ìŠ¤ ì¤‘ì´ë‹¤. \n\n## code-server\n\n[code-server](https://github.com/codercom/code-server)ëŠ” ì›ê²©ì„œë²„ í˜•íƒœë¡œ ë™ì‘í•˜ëŠ” ë¸Œë¼ìš°ì € ê¸°ë°˜ [VSCode](https://github.com/Microsoft/vscode) IDEì´ë‹¤.\n\nê·¸ëŸ°ë° ì™œ êµ¬ì§€ VScode ì„¤ì¹˜í˜•ì„ ëƒ…ë‘ê³  Serverë¡œ êµ¬ë™í•˜ëŠëƒ? ì•„ë˜ì™€ ê°™ì´ ì„¤ëª…í•˜ê³  ìˆë‹¤.\n* Chromebook, Table(IPAD) ì—ì„œ Coding ê°€ëŠ¥\n* ì €ì‚¬ì–‘ Clientì—ì„œë„ Cloud ê¸°ë°˜ Serverì˜ ì´ì  ì‚¬ìš©ê°€ëŠ¥\n* Battery! (ì œì¼ ì¤‘ìš”í¬ì¸íŠ¸) \n\nêµ¬ë™ë°©ì‹ì€ ì—¬ëŸ¬ë°©ì‹ì´ ì¡´ì¬í•œë‹¤. \n* Hosted : [coder](https://coder.com/) - Enterprise \n* Docker\n    ```\n    $ docker run -t -p 127.0.0.1:8443:8443 -v \"${PWD}:/root/project\" codercom/code-server code-server --allow-http --no-auth\n    ```\n* Bianry\n    ```\n    $ code-server <initial directory to open>\n    ```\n\n## code-server kubernetesì— ë°°í¬\n\nê³µì‹ [Image](https://hub.docker.com/r/codercom/code-server)ì™€ [Dockerfile](https://github.com/codercom/code-server/blob/master/Dockerfile)ëŠ” í•´ë‹¹ ë§í¬ë¥¼ ì°¸ì¡°í•œë‹¤.\nì‚´ì§ ë³€ê²½í•´ì„œ ì¬ë¹Œë“œí•˜ë ¤ê³  í–ˆëŠ”ë° ë§¥ë¶ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œì§€ `yarn build`í• ë•Œ `Serve fails with Error Code 137` ê°€ ë°œìƒí•˜ì˜€ë‹¤. ì´ë¬¸ì œëŠ” ë‚˜ì¤‘ì— í•´ê²°í•˜ê¸°ë¡œ í•˜ê³  ì¼ë‹¨ ë°°í¬í•˜ì.  \n\në¡œì»¬ minikubeì—ì„œ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´  \n[https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml](https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml) ì—ì„œ ClusterIPë¥¼  NodePortë¡œ ìˆ˜ì •í•˜ê³  íŒ¨ìŠ¤ì›Œë“œë¥¼ ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì§€ ì•Šê³  ì‚¬ìš©í• ìˆ˜ ìˆë„ë¡ `1234`ë¡œ ì„¤ì •í•˜ê³  ë°°í¬í•œë‹¤. \n\n### deployment.yaml\n```\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: code-server\n---\napiVersion: v1\nkind: Service\nmetadata:\n name: code-server\n namespace: code-server\nspec:\n ports:\n - port: 8443\n   name: https\n   protocol: TCP\n selector:\n   app: code-server\n type: NodePort\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    app: code-server\n  name: code-server\n  namespace: code-server\nspec:\n  selector:\n    matchLabels:\n      app: code-server\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: code-server\n    spec:\n      containers:\n      - image: codercom/code-server\n        imagePullPolicy: Always\n        name: code-server\n        ports:\n        - containerPort: 8443\n          name: https\n        args:\n         - \"--password=1234\"\n```\n```\n$ kubectl create -f deployment.yaml\n```\n\nì´í›„ ì„œë¹„ìŠ¤ í™•ì¸ ë° minikube serviceë¡œ expose ì‹œí‚¨ë‹¤.\n\n```\n$ kubectl get svc\nNAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\ncode-server   NodePort   10.111.206.64   <none>        8443:32665/TCP   15m\n\n$ minikube service code-server\n\n$ minikube service list\n|-------------|---------------|-----------------------------|\n|  NAMESPACE  |     NAME      |             URL             |\n|-------------|---------------|-----------------------------|\n| code-server | code-server   | http://192.168.99.102:32665 |\n| default     | git-sync-demo | http://192.168.99.102:31595 |\n| default     | kubernetes    | No node port                |\n| kube-system | kube-dns      | No node port                |\n|-------------|---------------|-----------------------------|\n```\n\ní•´ë‹¹ URLë¡œ ì ‘ì†í•˜ì—¬ íŒ¨ìŠ¤ì›Œë“œ `1234`ë¥¼ ì…ë ¥í•˜ë©´ vscodeê°€ ì›ê²©ìœ¼ë¡œ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.\n![vscode](/img/vscode.png)\n\n## ì •ë¦¬\nì‹¤ì œ ì‚¬ìš©ì„ í•´ë³´ë©´ ì•„ì§ ë²„ê·¸ê°€ ë§ë‹¤. ì• ë“œì˜¨ì´ë‚˜ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ì‹œ ì œëŒ€ë¡œ ë™ì‘ì„ í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆì—ˆê³  \n[git-sync](https://github.com/kubernetes/git-sync) í”„ë¡œì íŠ¸ì™€ ì—°ë™ì„ í†µí•´ ì‹¤ì œ gitOPSë¥¼ êµ¬í˜„í•´ë³´ê³ ì í•˜ì˜€ìœ¼ë‚˜ ë°°í¬í›„ì— mountëœ repository volumeì— ë³€ê²½ì‚¬í•­ì´ ë°œìƒì‹œ ê°‘ìê¸° UIê°€ ë¨¹í†µì´ ë˜ëŠ” ê²½ìš°ê°€ ë°œìƒí•˜ê¸°ë„ í•˜ì˜€ë‹¤. Kubernetesí”Œë«í¼ì„ ê°œë°œìì—ê²Œ PaaSí˜•íƒœë¡œ ì œê³µí•˜ëŠ” ê²½ìš° webIDEì˜ ì¢‹ì€ ì˜µì…˜ì´ ë ìˆ˜ ìˆì„ê²ƒ ê°™ë‹¤."
    },
    {
      "id": "kubernetes/k3s-homelab/",
      "metadata": {
        "permalink": "/kubernetes/k3s-homelab/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-03-11-k3s-homelab.md",
        "source": "@site/blog/2019-03-11-k3s-homelab.md",
        "title": "K3s on Raspberry Pi Cluster",
        "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” k3së¥¼ ë¼ì¦ˆë² ë¦¬íŒŒì´ í´ëŸ¬ìŠ¤í„°ì— ì˜¬ë ¤ë³´ê³  í™œìš©ë°©ì•ˆì— ëŒ€í•´ì„œ ê³ ë¯¼í•´ë³¸ë‹¤",
        "date": "2019-03-11T00:00:00.000Z",
        "formattedDate": "March 11, 2019",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Rancher",
            "permalink": "/tags/rancher"
          },
          {
            "label": "K3s",
            "permalink": "/tags/k-3-s"
          },
          {
            "label": "Raspberry",
            "permalink": "/tags/raspberry"
          },
          {
            "label": "Homelab",
            "permalink": "/tags/homelab"
          }
        ],
        "readingTime": 12.09,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "K3s on Raspberry Pi Cluster",
          "comments": true,
          "classes": "wide",
          "description": "ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” k3së¥¼ ë¼ì¦ˆë² ë¦¬íŒŒì´ í´ëŸ¬ìŠ¤í„°ì— ì˜¬ë ¤ë³´ê³  í™œìš©ë°©ì•ˆì— ëŒ€í•´ì„œ ê³ ë¯¼í•´ë³¸ë‹¤",
          "slug": "kubernetes/k3s-homelab/",
          "date": "2019-03-11T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "Rancher",
            "K3s",
            "Raspberry",
            "Homelab"
          ]
        },
        "prevItem": {
          "title": "VScode Server",
          "permalink": "/tools/vscode-server/"
        },
        "nextItem": {
          "title": "Cloud-Native Microservices Demo Application with OpenCensus",
          "permalink": "/kubernetes/microservices-demo/"
        }
      },
      "content": "ì´ë²ˆì—ëŠ” ê²½ëŸ‰ Kubernetesë¼ê³  ì´ì•¼ê¸°í•˜ëŠ” [K3s](https://github.com/rancher/k3s)ë¥¼ Raspberry Pi í´ëŸ¬ìŠ¤í„°ìƒì— êµ¬ë™í•˜ë ¤ê³  í•œë‹¤. \nìˆœìˆ˜í•˜ê²Œ ê°œì¸ì˜ê²¬ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ê³  ì ˆëŒ€ ì œí’ˆì´ë‚˜ ë¶€í’ˆí™ë³´ë¥¼ í•˜ê³ ì í•˜ëŠ” ì˜ë„ëŠ” ì „í˜€ ì—†ë‹¤.\n\n## K3s?\n\n**K3s**ëŠ” Rancher Labì—ì„œ ìµœì†Œìì›ì„ ì‚¬ìš©í•˜ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ ìœ„í•œ ì†”ë£¨ì…˜ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆê³  2019ë…„ 3ì›” 12ì¼ í˜„ì¬ 0.2ë²„ì „ì´ ë¦´ë¦¬ì¦ˆëœ ìƒíƒœì´ë‹¤. ë°”ì´ë„ˆë¦¬ ì „ì²´ê°€ 40mbê°€ ë˜ì§€ ì•Šê³  ì„¤ì¹˜ê°€ ì‰½ë‹¤ëŠ” ì ì—ì„œ ìµœê·¼ íŠ¸ìœ„í„° ìƒì—ì„œ ì´ìŠˆê°€ ë˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ë¼ê³  í•  ìˆ˜ ìˆë‹¤. \n\nì£¼ë¡œ Edge, IoT ë“± ì €ì „ë ¥, ì €ì‚¬ì–‘ ê¸°ë°˜ ARMê³„ì—´ ì»´í“¨íŒ…ì— ìµœì í™” ë˜ì–´ ìˆê³  ì‹¤ì œ ì‹¤í—˜ì ì´ê¸´ í•˜ì§€ë§Œ ê°„ë‹¨í•œ ê¸°ëŠ¥ì´ë‚˜ baremetal ê¸°ë°˜ í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸ë¥¼ ì§‘ì—ì„œ í•´ë³´ê¸°ì—ëŠ” ë”± ì¢‹ì€ í”„ë¡œì íŠ¸ë¼ í•  ìˆ˜ ìˆë‹¤. ì´ë¯¸ vSphere, OpenStackê¸°ë°˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ëŠ” ì°¨ê³  ë„˜ì¹˜ê²Œ í•´ë´¤ì§€ë§Œ ì¼ë‹¨ ë¬¼ë¦¬ì ì¸ ì¼€ì´ìŠ¤ë¶€í„° ë³´ê³ ë‚˜ë©´ í•˜ë“œì›¨ì–´ë¥¼ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤ì—ê²ŒëŠ” ì•„ì£¼ ì¬ë¯¸ìˆëŠ” ì¥ë‚œê°ì´ ì•„ë‹ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤. \n\n[K3s Github](https://github.com/rancher/k3s) ìƒì„¸ ì„¤ëª…ì— ë³´ë©´ Cloud Provider, Storage Pluginì€ ì œê±°í•˜ì˜€ê³   default ì €ì¥ì†Œê°€ `etcd`ê°€ ì•„ë‹Œ `sqlite3`ìœ¼ë¡œ ë˜ì–´ìˆë‹¤ê³  í•œë‹¤. \n\n## ì‚¬ì „ ì¤€ë¹„ì‚¬í•­\n\n* ìµœì†Œ 2ê°œ ì´ìƒì˜ Raspberry Pi 2B/3B/3B+, 4ea  \nì˜¤í”ˆë§ˆì¼“ì—ì„œ í• ì¸ì¿ í° ì ìš©í•´ì„œ Raspberry Pi 3B+, 4eaë¥¼ `166,820ì›`(ëŒ€ë‹¹ 42,000ì›) ì •ë„ì— êµ¬ë§¤í•˜ì˜€ë‹¤.  \nìµœì €ê°€ ê²€ìƒ‰ìœ¼ë¡œ ëŒ€ë‹¹ 46,000ì› ì •ë„ í–ˆë˜ê²ƒ ê°™ë‹¤. \n\n* Stackable Case  \n[iUniker Raspberry Pi Cluster Case](https://www.amazon.com/gp/product/B07CTG5N3V/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1) ê°•ì¶”!! (ê°œì¸ì ìœ¼ë¡œ ì¿¨ëŸ¬ì™€ ë””ìì¸ì´ ë§˜ì— ë“¬)  \në°°ì†¡ë¹„í¬í•¨ 29.19ë‹¬ëŸ¬, ì•½ `33,000ì›`\n\n* micro SDHC 4ea  \n16GBë¡œë„ ì¶©ë¶„í•˜ì§€ë§Œ ì‚¼ì„±ì „ì micro SDHC CLASS10 UHS-I EVO (32GB), 4eaë¥¼ ì˜¤í”ˆë§ˆì¼“ì—ì„œ ì‚¬ê²Œë˜ë©´ ë°°ì†¡ë£Œ í¬í•¨í•´ì„œ 8,500ì› * 4ea = `34,000ì›`ì— êµ¬ë§¤ê°€ ê°€ëŠ¥í•˜ë‹¤. ì˜¤í”ˆë§ˆì¼“ì—ì„œëŠ” ê°œë‹¹ ë°°ì†¡ë£Œë¥¼ ë‚´ì•¼í•œë‹¤. í•˜ì§€ë§Œ ì¿ íŒ¡ì—ì„œëŠ” 2eaë¥¼ ë¡œì¼“ë°°ì†¡ìœ¼ë¡œ 15,380ì›ì— êµ¬ë§¤ê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ ì•½ `31,000ì›`ì— 4ê°œë¥¼ êµ¬ë§¤í• ìˆ˜ ìˆë‹¤. \n\n* ë©€í‹°ì¶©ì „ê¸°  \n1ë§Œì›ëŒ€ í›„ë°˜ì—ì„œ 2ë§Œì› ì´ˆë°˜ì´ë©´ 6í¬íŠ¸ ì¶©ì „ê¸°ë¥¼ êµ¬ë§¤í• ìˆ˜ ìˆëŠ”ë° êµ¬ë§¤í–ˆë˜ ê°€ì¥ í° ê¸°ì¤€ì€ Pi 4ëŒ€ë¥¼ ë™ì‹œì— 2.5A ì „ë¥˜ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ê³µê¸‰í•˜ë ¤ë©´ ìµœëŒ€ 10Aë¥¼ ì§€ì›í•˜ëŠ” ë©€í‹° ì¶©ì „ê¸°ë¥¼ ì‚¬ì•¼í–ˆì—ˆê³  4-5í¬íŠ¸ ì§œë¦¬ ì¶©ì „ê¸°ë“¤ì€ ëŒ€ë¶€ë¶„ ìµœëŒ€ ì „ë¥˜ê°€ 8Aë¡œ ì¶©ì¡±í•˜ì§€ ëª»í•´ 4í¬íŠ¸ë§Œ ì‚¬ìš©í•˜ë”ë¼ë„ ì•ˆì •ì ì¸ ì „ë¥˜ ê³µê¸‰ì„ ìœ„í•´ 6í¬íŠ¸ ì¶©ì „ê¸°ë¡œ ì„ íƒí•˜ì˜€ë‹¤.  \nì¿ íŒ¡ ë¡œì¼“ë°°ì†¡ - í¬*ì§€ ê°€ì •ìš© 6í¬íŠ¸ ê¸‰ì† ë©€í‹° ì¶©ì „ê¸°, `22,900ì›`\n\n* micro 5pin 20cm 2.4A ì§€ì› ì¼€ì´ë¸” 4ea  \nPi ê¶Œì¥ ì „ë¥˜ê°€ 2.5Aë¼ê³  í–ˆì§€ë§Œ 2.4A, 3A ì§œë¦¬ì¤‘ì— ì €ë ´í•œ 2.4A ì§€ì› ìˆì¼€ì´ë¸”ë¡œ êµ¬ë§¤í•˜ì˜€ë‹¤.  \nì˜¤í”ˆë§ˆì¼“ì—ì„œ ë°°ì†¡ë£Œ í¬í•¨, `7800ì›`\n\n* UTP Cat5e 30cm ì¼€ì´ë¸” 4ea  \nê·¸ëƒ¥ ì œì¼ì‹¼ê±¸ë¡œ ì˜¤í”ˆë§ˆì¼“ì—ì„œ ë°°ì†¡ë£Œ í¬í•¨ `4,100ì›`ì— êµ¬ë§¤í•˜ì˜€ë‹¤.\n\n* ê¸°ê°€ë¹„íŠ¸ ì§€ì›ë˜ëŠ” 5í¬íŠ¸ ì´ìƒ ìŠ¤ìœ„ì¹˜ í—ˆë¸Œ(ê³µìœ ê¸°)  \nì§‘ì— ìˆë˜ ê³µìœ ê¸° í™œìš© (iptime A1004) í•˜ì˜€ì§€ë§Œ ìµœì € 5í¬íŠ¸ ì´ìƒ ìŠ¤ìœ„ì¹˜ í—ˆë¸Œì¤‘ ì œì¼ ì‹¼ ëª¨ë¸ì€ `16,000ì›`ëŒ€ë¡œ ê°€ê²© í˜•ì„±ì¤‘ì´ë‹¤. \n\nì‹¤ì œ ìœ„ ìŠ¤í™ìœ¼ë¡œ ëŒ€ì¶© êµ¬ë§¤ë¥¼ ì§„í–‰í•˜ê²Œ ë˜ë©´ 18.4 + 3.3 + 3.1 + 2.3 + 0.8 + 0.4 + 1.6 = `29.9ë§Œì›` ì •ë„ ì†Œìš”ê°€ ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤. ì§‘ì— êµ´ëŸ¬ë‹¤ëŠ” ë¶€í’ˆì´ë‚˜ ì¶©ì „ê¸°, ì¼€ì´ë¸”, SDì¹´ë“œë“¤ì„ í™œìš©í•˜ë©´ `25ë§Œì›` ì´ë‚´ë¡œë„ ì¶©ë¶„íˆ ê°€ëŠ¥í•˜ë‹¤.\n\n## êµ¬ë§¤ ì œí’ˆ ì¡°ë¦½\nì¡°ë¦½ì€ ê·¸ë‹¤ì§€ ì–´ë µì§€ ì•Šì€ë° ì¼€ì´ìŠ¤ êµ¬ë§¤ì‹œ ì œê³µë˜ëŠ” ë°©ì—´íŒ(CPU, GPU, RAM)ì„ ê¼¼ê¼¼í•˜ê²Œ ë¶™ì´ê³  ì¿¨ëŸ¬ë¥¼ GPIOì— ì—°ê²°í•œë‹¤.  \nê·¸ë ‡ê²Œ ì–´ë ¤ìš´ ì ì€ ì—†ì§€ë§Œ ë³¸ì²´ë¥¼ ì¼€ì´ìŠ¤ì— ê³ ì •í• ë•Œ ë„ˆíŠ¸ê°€ ì‘ì•„ ì†ì´ í° ì‚¬ëŒì€ ì¡°ê¸ˆ í˜ë“¤ ìˆ˜ë„ ìˆì„ ê²ƒ ê°™ë‹¤. \n\nì¼€ì´ìŠ¤ì˜ CPU ì¿¨ëŸ¬ê°€ í™”ë£¡ì ì •ì´ë‹¤.\n\n![cases](/img/cases.jpg)  \n![heat](/img/heat.jpg)  \n![cooler](/img/cooler.jpg)\n![3stack](/img/3stack.jpg)\n![charger](/img/charger.jpg)\n![full](/img/fullstack.jpg)\n![complete](/img/complete.jpg)\n\n## OS ì„¤ì¹˜\n\nSDì¹´ë“œì— ì„¤ì¹˜ëŠ” MacOSìƒì—ì„œ ì§„í–‰í•˜ì˜€ë‹¤.\n\n[Raspbian Lite](https://www.raspberrypi.org/downloads/raspbian/)ë¥¼ ë‚´ë ¤ë°›ì•„ [Etcher](https://www.balena.io/etcher/)ë¥¼ ì‚¬ìš©í•˜ì—¬ OSë¥¼ ì„¤ì¹˜í•œë‹¤. \n\nìì„¸í•œ ì¶”ê°€ì ì¸ ì„¤ì¹˜ë°©ë²•ì€ ë‹¤ìŒ ë§í¬ë¥¼ í†µí•´ì„œë„ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.  \n[Installing operating system images](https://www.raspberrypi.org/documentation/installation/installing-images/README.md)  \n\n## í™˜ê²½ ì„¤ì •\nMacì—ì„œëŠ” `/Volumes/boot`ì— ë§ˆìš´íŠ¸ê°€ ëœë‹¤. OSë§ˆë‹¤ ë‹¤ë¥´ì§€ë§Œ Linuxì—ì„œëŠ” `/mnt/boot`, Windowsì—ì„œëŠ” `boot` ë¡œ ë§ˆìš´íŠ¸ê°€ ëœë‹¤.\n\nSSH Service ìë™ í™œì„±í™”ë¥¼ ìœ„í•´ ìœ„ OSë³„ mountëœ root ê²½ë¡œì— ssh ë¹ˆ íŒŒì¼ì„ ìƒì„±í•˜ê²Œ ë˜ë©´ rebootì´í›„ì— SSH ì ‘ì†ì´ ê°€ëŠ¥í•´ì§„ë‹¤.\n```\n$ sudo touch /Volumes/boot/ssh\n```\n\në˜í•œ container ì‚¬ìš©ì„ ìœ„í•´ rootê²½ë¡œì˜ `cmdline.txt` íŒŒì¼ ë§ˆì§€ë§‰ì— cgroup ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.  \n```\ncgroup_memory=1 cgroup_enable=memory\n```\n\nSDì¹´ë“œë¥¼ ë§Œë“¤ê³  ê°ê°ì˜ Piì— ì¥ì°©í›„ì— UTPì¼€ì´ë¸”ê³¼ ì „ì›ì„ ëª¨ë‘ ì—°ê²°í•œë‹¤.\në¶€íŒ…ì´ ì™„ë£Œë˜ë©´ default id/pass ì¸ `pi/raspberry`ë¡œ ë¡œê·¸ì¸ í•˜ê³  `sudo raspi-config` ë¥¼ í†µí•´ íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½, hostname ì„¤ì •, GPU memory split ì„¤ì • ë“±ì„ ì™„ë£Œí•˜ì.  \në‚˜ì¤‘ì—ëŠ” PXE booting ë° ansible ìë™í™”ë¡œ êµ¬í˜„í•˜ë©´ ë¬´ì¸í™˜ê²½ ì„¤ì¹˜ê°€ ê°€ëŠ¥í• ê²ƒ ê°™ë‹¤. (Edge Computing)\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Raspberry Pi Software Configuration Tool (raspi-config) â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                                                                  â”‚\nâ”‚        1 Change User Password Change password for the current user                               â”‚\nâ”‚        2 Network Options      Configure network settings                                         â”‚\nâ”‚        3 Boot Options         Configure options for start-up                                     â”‚\nâ”‚        4 Localisation Options Set up language and regional settings to match your location       â”‚\nâ”‚        5 Interfacing Options  Configure connections to peripherals                               â”‚\nâ”‚        6 Overclock            Configure overclocking for your Pi                                 â”‚\nâ”‚        7 Advanced Options     Configure advanced settings                                        â”‚\nâ”‚        8 Update               Update this tool to the latest version                             â”‚\nâ”‚        9 About raspi-config   Information about this configuration tool                          â”‚\nâ”‚                                                                                                  â”‚\nâ”‚                                                                                                  â”‚\nâ”‚                                                                                                  â”‚\nâ”‚                           <Select>                           <Finish>                            â”‚\nâ”‚                                                                                                  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n* 1 Change User Password\n* 2 Network Options - hostname\n    * k3s-master, k3s-slave-01, k3s-slave-02, k3s-slave-03\n* 4 Localisation Options - TimeZone\n    * Asia, Seoul\n* 7 Advanced Options - GPU Memory split \n    * 16mb\n\nëª¨ë‘ ì™„ë£Œê°€ ë˜ì—ˆìœ¼ë©´ pië“¤ì„ ì¬ê¸°ë™í•˜ì.\n```\n$ sudo reboot\n```\n\n## k3s í´ëŸ¬ìŠ¤í„° ìƒì„±\n\n### Server ê¸°ë™\n\narmhf(arm hard float) ì§€ì›ì´ ë˜ëŠ” ìµœì‹  ë¦´ë¦¬ì¦ˆ v0.2.0ë¥¼ ë‹¤ìš´ë°›ëŠ”ë‹¤.  \n```\n$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf && \\\n  chmod +x k3s && \\\n  sudo mv k3s /usr/local/bin/k3s\n```\n\nMaster node ê¸°ë™ (ë°±ê·¸ë¼ìš´ë“œ)\n```\n$ sudo k3s server &\n```\n\ní•´ë‹¹ nodeë¥¼ Control plane í˜•íƒœë¡œ ë¶„ë¦¬ì‹œì¼œ workloadì—ì„œ ì œì™¸í•˜ë ¤ë©´ `--disable-agent` ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤.\n```\n& k3s server --disable-agent\n```\n\nì •ìƒì ìœ¼ë¡œ k3s ê¸°ë™ì´ ì™„ë£Œë˜ë©´ `/etc/rancher/k3s/k3s.yaml`ì—ì„œ Kubeconfigë¥¼ í™•ì¸í• ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  node ìƒíƒœë„ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.\n```\n$ sudo k3s kubectl get nodes\nNAME          STATUS   ROLES    AGE   VERSION\nk3s-master    Ready    <none>   21h   v1.13.4-k3s.1\n```\n\n### node ì¶”ê°€\n\n`/var/lib/rancher/k3s/server/manifests` ì—ì„œ TOKENì„ í™•ì¸í•œë‹¤. \n\n```\n$ sudo cat /var/lib/rancher/k3s/server/node-token\nK100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a\n```\n\nworker nodeì— ì ‘ì†í•œë‹¤ìŒ ë™ì¼í•˜ê²Œ ìµœì‹  ë¦´ë¦¬ì¦ˆ v0.2.0ë¥¼ ë‹¤ìš´ë°›ëŠ”ë‹¤.  \n```\n$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf && \\\n  chmod +x k3s && \\\n  sudo mv k3s /usr/local/bin/k3s\n```\n\nìœ„ì—ì„œ ë‚˜ì˜¨ TOKENê°’ê³¼ Kube API Endpointì •ë³´ë¡œ nodeë“¤ì„ ì°¨ë¡€ë¡œ ì¶”ê°€ ì‹œí‚¤ë©´ ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œëœë‹¤. \n```\n$ export NODE_TOKEN=\"K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a\"\n$ export MASTER_IP=\"https://192.168.0.14:6443\"\n$ sudo k3s agent --server https://${MASTER_IP}:6443 --token ${NODE_TOKEN} &\n```\n\nì™„ì„±ëœ í´ëŸ¬ìŠ¤í„°ë¥¼ í™•ì¸í•œë‹¤. ì™¸ë¶€ ë¡œì»¬ì—ì„œ í™•ì¸í•˜ë ¤ë©´ `/etc/rancher/k3s/k3s.yaml` íŒŒì¼ì„ `~/.kube/config`ì— ì¶”ê°€í•˜ë©´ ëœë‹¤. í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ kubectl ëª…ë ¹ì€ k3s ë°”ì´ë„ˆë¦¬ ë‚´ë¶€ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ `sudo k3s kubectl` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì˜€ë‹¤.\n\n```\n$ sudo k3s kubectl get node -o wide\nNAME          STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME\nk3s-master    Ready    <none>   22h   v1.13.4-k3s.1   192.168.1.14   <none>        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown\nk3s-slave01   Ready    <none>   21h   v1.13.4-k3s.1   192.168.1.15   <none>        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown\nk3s-slave02   Ready    <none>   10h   v1.13.4-k3s.1   192.168.1.16   <none>        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown\nk3s-slave03   Ready    <none>   10h   v1.13.4-k3s.1   192.168.1.17   <none>        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown\n```\n\nnode ìƒì„¸ì •ë³´ë¥¼ ë³´ë©´ ê¸°ë³¸ì ìœ¼ë¡œ K8s `v1.13.4`, runtimeì€ `containerd`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.  \n\n```\n$ sudo k3s kubectl get svc --all-namespaces\nNAMESPACE     NAME         TYPE           CLUSTER-IP     EXTERNAL-IP                 PORT(S)                      AGE\ndefault       kubernetes   ClusterIP      10.43.0.1      <none>                      443/TCP                      21h\nkube-system   kube-dns     ClusterIP      10.43.0.10     <none>                      53/UDP,53/TCP,9153/TCP       21h\nkube-system   traefik      LoadBalancer   10.43.19.160   192.168.1.14,192.168.1.15   80:32304/TCP,443:31690/TCP   21h\n```\n\nRancherìª½ì—ì„œë„ ì˜¤ëŠ˜ë‚ ì§œ(3/12)ë¡œ F5ê°€ Nginxë¥¼ ì¸ìˆ˜í•˜ëŠ”ê²ƒì„ ì˜ˆê²¬í–ˆë˜ ê²ƒì¼ê¹Œ?  \nServiceë¥¼ í™•ì¸í•˜ë©´ traefikì´ ê¸°ë³¸ìœ¼ë¡œ ë˜ì–´ìˆë‹¤. ì•„ë˜ì²˜ëŸ¼ ê¸°ë³¸ì ìœ¼ë¡œ loadbalancerë¡œ í™œìš©ë˜ê³  ìˆëŠ” traefikì„ Helm Chart CRDë¥¼ í†µí•´ ë°°í¬ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë˜í•œ ì–¼ë§ˆì „ ì¡¸ì—…í•œ CoreDNSë„ ë³´ì¸ë‹¤.   \n\n```\n$ sudo k3s kubectl get pod --all-namespaces\nNAMESPACE     NAME                             READY   STATUS      RESTARTS   AGE\nkube-system   coredns-7748f7f6df-qflx9         1/1     Running     0          21h\nkube-system   helm-install-traefik-dqqg9       0/1     Completed   0          21h\nkube-system   svclb-traefik-598fd65c97-4xtkf   2/2     Running     0          21h\nkube-system   svclb-traefik-598fd65c97-vbsqv   2/2     Running     0          19h\nkube-system   traefik-6876857645-2sqg9         1/1     Running     0          21h\n\n$ sudo k3s kubectl get crd\nNAME                            CREATED AT\naddons.k3s.cattle.io            2019-03-11T16:46:22Z\nhelmcharts.k3s.cattle.io        2019-03-11T16:46:22Z\nlistenerconfigs.k3s.cattle.io   2019-03-11T16:46:22Z\n```\n\n## ì •ë¦¬\nì•„ì£¼ ì ì€ë¹„ìš©(?)ìœ¼ë¡œ ì·¨ë¯¸ì‚¼ì•„ k3s í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•´ë´¤ë‹¤.  \nì•„ì§ ARMê³„ì—´ì—ì„œ kubernetes workloadë¥¼ êµ¬ë™í•˜ëŠ” ê²ƒì€ ì‹œê¸°ìƒì¡°ì´ê¸´ í•˜ì§€ë§Œ ê¸°ì¡´ì— kubeadmì„ ê°€ì§€ê³  piì— ë°°í¬í•˜ëŠ”ê²ƒì— ë¹„í•˜ë©´ ì„¤ì¹˜ ë‚œì´ë„ë‚˜ ìì›ì‚¬ìš©ëŸ‰ ì¸¡ë©´ì—ì„œ ì¥ì ì´ ë§ì€ í”„ë¡œì íŠ¸ì´ë‹¤.  \ní•´ì™¸ ë¸”ë¡œê·¸ë‚˜ íŠ¸ìœ„í„°ë¥¼ ë³´ë©´ ìµœê·¼ `k3s`ì— ëŒ€í•œ ê´€ì‹¬ë„ê°€ ë†’ì•„ì§€ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° ë‹¨ìˆœíˆ ì·¨ë¯¸ìƒí™œë§Œì´ ì•„ë‹ˆë¼ IoT, Edgeì—ì„œì˜ Serverless Workload ìˆ˜í–‰ì´ë¼ë˜ì§€ ARM ê³„ì—´ ìµœì í™”ëœ ëª¨ìŠµë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ê°€ëŠ¥ì„±ì€ ë³´ì—¬ì¤€ê²ƒ ê°™ë‹¤.  \nRancher 2.0 ì´í›„ë¡œ Kubernetes ì—°ê´€ëœ ê´€ì‹¬ë„ê°€ ë–¨ì–´ì¡Œì—ˆëŠ”ë° ì—”ì§€ë‹ˆì–´ë“¤ì˜ ê´€ì‹¬ì„ ë„ëŠ”ë°ëŠ” ì„±ê³µí•œë“¯ í•˜ê³  AWSì˜ Greengrass, Firecrackerì™€ ë™ì¼ì„ ìƒì—ì„œ ë´ë„ ê²¬ì¤„ë§Œí•œ ê°€ì¹˜ê°€ ìˆë‹¤ê³  ìƒê°ëœë‹¤."
    },
    {
      "id": "kubernetes/microservices-demo/",
      "metadata": {
        "permalink": "/kubernetes/microservices-demo/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-03-07-microservices-demo.md",
        "source": "@site/blog/2019-03-07-microservices-demo.md",
        "title": "Cloud-Native Microservices Demo Application with OpenCensus",
        "description": "Hipster Shop: Cloud-Native Microservices Demo Application ë¥¼ ì‚´í´ë³´ê³  ì•ˆì— ë“¤ì–´ìˆëŠ” ì—¬ëŸ¬ê°€ì§€ ì˜¤í”ˆì†ŒìŠ¤ë“¤ì„ ì•Œì•„ë³¸ë‹¤",
        "date": "2019-03-07T00:00:00.000Z",
        "formattedDate": "March 7, 2019",
        "tags": [
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Istio",
            "permalink": "/tags/istio"
          },
          {
            "label": "Stackdriver",
            "permalink": "/tags/stackdriver"
          },
          {
            "label": "Prometheus",
            "permalink": "/tags/prometheus"
          },
          {
            "label": "gRPC",
            "permalink": "/tags/g-rpc"
          },
          {
            "label": "OpenCensus",
            "permalink": "/tags/open-census"
          },
          {
            "label": "skaffold",
            "permalink": "/tags/skaffold"
          }
        ],
        "readingTime": 13.585,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Cloud-Native Microservices Demo Application with OpenCensus",
          "comments": true,
          "classes": "wide",
          "description": "Hipster Shop: Cloud-Native Microservices Demo Application ë¥¼ ì‚´í´ë³´ê³  ì•ˆì— ë“¤ì–´ìˆëŠ” ì—¬ëŸ¬ê°€ì§€ ì˜¤í”ˆì†ŒìŠ¤ë“¤ì„ ì•Œì•„ë³¸ë‹¤",
          "slug": "kubernetes/microservices-demo/",
          "date": "2019-03-07T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Kubernetes",
            "Istio",
            "Stackdriver",
            "Prometheus",
            "gRPC",
            "OpenCensus",
            "skaffold"
          ]
        },
        "prevItem": {
          "title": "K3s on Raspberry Pi Cluster",
          "permalink": "/kubernetes/k3s-homelab/"
        },
        "nextItem": {
          "title": "Knative with Gloo",
          "permalink": "/kubernetes/knative-using-gloo/"
        }
      },
      "content": "[https://github.com/GoogleCloudPlatform/microservices-demo](https://github.com/GoogleCloudPlatform/microservices-demo)ì—ì„œ ì†Œê°œëœ Demo Applicationì¸ `Hipster Shop`ì„ Kubernetes ê¸°ë°˜ìœ¼ë¡œ ë°°í¬í•˜ê³  ê´€ë ¨ ì˜¤í”ˆì†ŒìŠ¤ë“¤ì„ ë” ì•Œì•„ë³´ê³ ì í•œë‹¤.\n\nìœ„ ë§í¬ì— ê°€ì„œ ë³´ë©´ ì•Œìˆ˜ ìˆì§€ë§Œ `Hipster Shop` ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ 10ê°œì˜ Microserviceë¡œ êµ¬ì„±ë˜ì–´ ìˆê³  ìƒí’ˆì„ ê²€ìƒ‰ ë° êµ¬ë§¤í•  ìˆ˜ìˆëŠ” ì›¹ ê¸°ë°˜ ì´ì»¤ë¨¸ìŠ¤ Applicationìœ¼ë¡œ êµ¬ì„± ë˜ì–´ìˆë‹¤.\n\n![arch](https://github.com/GoogleCloudPlatform/microservices-demo/raw/master/docs/img/architecture-diagram.png)\n\nê°ê°ì˜ ì„œë¹„ìŠ¤ëŠ” **gRPC** ë¡œ í†µì‹ í•˜ê³  ì™¸ë¶€ ì‚¬ìš©ìë§Œ HTTPë¡œ ì ‘ê·¼í•œë‹¤. ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì–¸ì–´(Go, C#, Node.js, Python, Java)ë¡œ êµ¬ì„±ë˜ì–´ ìˆê³  ëŒ€ë¶€ë¶„ì˜ Microserviceë“¤ì€ `Istio` service mesh í˜•íƒœë¡œ êµ¬ì„±í• ìˆ˜ ìˆë„ë¡ ë˜ì–´ìˆë‹¤. `Skaffold`ë¥¼ í†µí•´ ë°°í¬í•˜ê³  `OpenCensus`ë¼ê³  í•˜ëŠ” gRPC/HTTPê¸°ë°˜ Tracing toolì„ í™œìš©í•˜ì—¬ Google `Stackdriver`ë¡œ ë³´ë‚´ë„ë¡ ë˜ì–´ìˆì§€ë§Œ  Prometheusì— í†µí•©í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì‘ì„±í•˜ê¸° ìœ„í•´ì„œ Prometheus ê¸°ë°˜ìœ¼ë¡œ Metricì„ ìˆ˜ì§‘í•˜ëŠ” Forkëœ ë°ëª¨ Applicationì„ ê²€ìƒ‰ì„ í†µí•´ ì°¾ì„ìˆ˜ ìˆì—ˆë‹¤.  \n[https://github.com/census-ecosystem/opencensus-microservices-demo](https://github.com/census-ecosystem/opencensus-microservices-demo)  \n\n## OpenCensus\n\n[OpenCensus(OC)](https://opencensus.io/)ëŠ” Microservice ë° Monolith ì„œë¹„ìŠ¤ë¥¼ Tracing ë° Metric Monitoring í•  ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µí•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ì´ë‹¤.\n\nì•„ë˜ì™€ ê°™ì´ ë‹¤ì–‘í•œ ì–¸ì–´ë¥¼ ì§€ì› í•œë‹¤.\n* Java , Go, Python, C++, Nodejs, Erlang, Ruby, PHP, C#\n\në˜í•œ ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ Prometheus, Stackdriver Tracing and Monitoring, DataDog, Graphite, Zipkin, Jaeger, Azure Insights ë“± ê³¼ ê°™ì€ ë°±ì—”ë“œ Applicationìœ¼ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê°œë°œì, ìš´ì˜ì ì¸¡ë©´ì—ì„œ ì¢‹ì€ ì„ íƒì‚¬í•­ì´ ë  ìˆ˜ ìˆë‹¤.  \n\nMicroserviceì™€ ê°™ì€ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ê°œë°œì/ìš´ì˜ì ê´€ì ì˜ ê°€ì¥ ì¤‘ìš”í•œ ë¯¸ì…˜ì€ ê°ê°ì˜ ìˆ˜í–‰ë˜ëŠ” ì„œë¹„ìŠ¤ë“¤ì˜ ì‹¤í–‰ ì‹œê°„ì„ í™•ì¸í•˜ê³  ìƒí˜¸ APIê°„ í†µì‹ ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ëŠ”ì§€ë¥¼ í™•ì¸í•˜ê³  Span(ì•„ë˜ ê·¸ë¦¼ì°¸ì¡°)ì—ì„œ ê°€ì¥ ì§€ì—°ì´ ë°œìƒí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ë¹¨ë¦¬ ì°¾ì•„ë‚´ í™•ì¸í•˜ê³  ì¡°ì¹˜í•˜ëŠ” ê²ƒì´ë¼ í•  ìˆ˜ ìˆë‹¤.\n\n![span](https://www.jaegertracing.io/img/spans-traces.png)\n\nOpenCensusëŠ” ì£¼ë¡œ ë‘ê°€ì§€ ê¸°ëŠ¥ìœ¼ë¡œ í™œìš©ëœë‹¤.  \nì²«ë²ˆì§¸ëŠ” Metric ìˆ˜ì§‘ì´ê³  ë‘ë²ˆì§¸ëŠ” Tracing ê¸°ëŠ¥ì´ë‹¤.  \nLogê°™ì€ ê²½ìš° í˜„ì¬ ë¯¸ì§€ì›ì´ì§€ë§Œ ë‹¤ìŒ ë©”ì´ì € ë¦´ë¦¬ì¦ˆì— ì¶”ê°€ë  ì˜ˆì •ì´ë¼ê³  í•˜ë‹ˆ ì¡°ê¸ˆë” ì§€ì¼œë³´ë©´ ì¢‹ì„ê²ƒ ê°™ë‹¤.\n\n* Metrics\n  * ë°ì´í„°ë² ì´ìŠ¤ ë° APIì˜ ì‘ë‹µì‹œê°„, ìš”ì²­ content length, open file descriptor ìˆ˜ì™€ ê°™ì´ ì¶”ì í•˜ê³ ìí•˜ëŠ” ì •ëŸ‰ ë°ì´í„°ë¥¼ ë§í•œë‹¤. Metric ì„ ì‹œê°í™”í•´ì„œ ë³´ë©´ ì‘ìš© í”„ë¡œê·¸ë¨ ë° ì„œë¹„ìŠ¤ì˜ ì„±ëŠ¥ê³¼ í’ˆì§ˆì„ ì¸¡ì •í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´ ìš”ì²­ ì‘ë‹µì‹œê°„ì˜ í‰ê· ê°’ì´ë‚˜ cache hit/miss ìˆ˜ì™€ ê°™ì€ ê²ƒë“¤ì´ ë  ìˆ˜ ìˆë‹¤. \n\n* Traces\n  * ì„œë¹„ìŠ¤ ìš”ì²­ì— ëŒ€í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë˜ëŠ” ì„œë¹„ìŠ¤ êµ¬ì¡°ë¥¼ í™•ì¸í• ìˆ˜ ìˆê³  ëª¨ë“  ì„œë¹„ìŠ¤ ê°„ ë°ì´í„° íë¦„ì„ ì‹œê°í™”í•˜ì—¬ ì•„í‚¤í…ì²˜ìƒì˜ ë³‘ëª© í˜„ìƒì„ íŒŒì•…í•˜ëŠ” ë° ë„ì›€ì´ ëœë‹¤.\n\n## Hipster Shop Demo\n\nìœ„ì—ì„œ ì–¸ê¸‰í–ˆë˜ ë‚´ìš©ì²˜ëŸ¼ GCPì—ì„œ ì‘ì„±í•œ [Hipster Shop Demo](https://github.com/GoogleCloudPlatform/microservices-demo)ëŠ” minikube ë° GCP ë°ëª¨ë¡œ ë˜ì–´ìˆê³  ì½”ë“œì•ˆì— ê¸°ë³¸ Metric ì„¤ì •ì´ Stackdriverìœ¼ë¡œ ë˜ì–´ìˆì–´ Prometheus Exporter ì ìš©ì„ í•˜ë ¤ë©´ ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— Prometheusê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ëœ [Forked Repo](https://github.com/census-ecosystem/opencensus-microservices-demo)ë¥¼ ì‚´í´ë³´ê¸°ë¡œ í•˜ì˜€ë‹¤.\n\n\n### Requirement\ní˜„ì¬ ê°€ì§€ê³  ìˆëŠ” MacOS í™˜ê²½ì—ì„œ êµ¬ë™í•˜ì˜€ë‹¤. ìµœì†Œ ìŠ¤í™ì€ ë”°ë¡œ ê¸°ì¬í•˜ì§€ ì•Šì•˜ìœ¼ë‚˜ K8s 1.11 ì´ìƒì„ ê¶Œì¥í•œë‹¤.\n* kubectl : v1.10.7\n* Minikube : v0.34.1\n* Kubernetes : v1.13.3\n* [skaffold](https://github.com/GoogleContainerTools/skaffold/#installation) : v0.24\n\n### minikube ê¸°ë™\nìµœì†Œ 3 CPU, 6Gb Memoryê°€ í•„ìš”í•˜ë‹¤. ê·¸ëƒ¥ minikubeë¥¼ êµ¬ë™ì‹œê¸°ë©´ 4 CPU, 8Gb ë¡œ êµ¬ë™ì´ ë˜ê¸° ë•Œë¬¸ì— ë³„ë‹¤ë¥¸ ì˜µì…˜ ì—†ì´ defaultë¡œ êµ¬ë™í•˜ë©´ ëœë‹¤. \n```bash\n$ minikube start\n$ kubectl get nodes\nNAME       STATUS    ROLES     AGE       VERSION\nminikube   Ready     master    6h        v1.13.3\n```\n\n### Repository Clone\n```bash\n$ git clone https://github.com/census-ecosystem/opencensus-microservices-demo.git\n$ cd opencensus-microservices-demo\n```\n\në‚´ë¶€ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ë©´ ê¸°ë³¸ì ìœ¼ë¡œ [skaffold](https://github.com/GoogleContainerTools/skaffold)ë¥¼ í™œìš©í•˜ì—¬ ë°°í¬ë¥¼ ì§„í–‰ì„ í•˜ëŠ” ê²ƒì„ ì•Œìˆ˜ìˆë‹¤.  \n`skaffold`ëŠ” ë¡œì»¬ì—ì„œ Kubernetes ê¸°ë°˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œê³¼ ë°°í¬(CD)ë¥¼ ë¹ ë¥´ê²Œ ë„ì™€ì£¼ëŠ” CLI toolì´ë‹¤. ì†ŒìŠ¤ì½”ë“œì˜ ë³€í™”ë¥¼ ê°ì§€í•˜ì—¬ build, registry push/tagging, deployê¹Œì§€ ìë™ìœ¼ë¡œ í•  ìˆ˜ ìˆëŠ” ë¡œì»¬ ê¸°ë°˜ ë„êµ¬ì´ë‹¤.\n\n`skaffold dev`ëŠ” ë¡œì»¬ í™˜ê²½ì˜ ë°˜ë³µì ì¸ ê°œë°œì— í™œìš©í•˜ê³  ì‹¤ì œ ë°°í¬ëŠ” CI Processì—ì„œ `skaffold run`ì„ í†µí•´ ë°°í¬ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤.  \n\n![skaffold demo](https://github.com/GoogleContainerTools/skaffold/raw/master/docs/static/img/intro.gif)\n\nKubernetes ë°°í¬íˆ´ì— ëŒ€í•´ ë¹„êµí•œ ê¸€ì€ [ë¸”ë¡œê·¸ ë§í¬](https://blog.hasura.io/draft-vs-gitkube-vs-helm-vs-ksonnet-vs-metaparticle-vs-skaffold-f5aa9561f948/)ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\nì•„ë˜ì—ì„œëŠ” `skaffold`ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë¯¸ë¤„ë‘ê³  ë°°í¬í•˜ëŠ” ë„êµ¬ë¡œì„œë§Œ ì„¤ëª…í•œë‹¤.  \n\nê¸°ë³¸ì ìœ¼ë¡œ êµ¬ì„±ì„ í•˜ê³ ì í•˜ëŠ” ë‚´ìš©ì€ helmì²˜ëŸ¼ template íŒŒì¼ì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° í”„ë¡œì íŠ¸ rootì— `skaffold.yaml` ì— buildë¥¼ ìœ„í•œ image name, tag, src ìœ„ì¹˜ë“± ê¸°ë³¸ì ì¸ ë‚´ìš©ì„ ê¸°ì¬í•œë‹¤. íŒŒì¼ë‚´ìš©ì„ ì‚´í´ë³´ë©´ buildì— ê´€ë ¨ëœ ë‚´ìš©ë“¤ì„ ì‘ì„±í•˜ê³  deployí•  manifestsì˜ ìœ„ì¹˜ê¹Œì§€ ì§€ì •í•˜ë„ë¡ ë˜ì–´ìˆë‹¤. ë¡œì»¬í™˜ê²½ì—ì„œ í™•ì¸ì„ ìœ„í•´ grafana, prometheus, jaegerê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```yaml\napiVersion: skaffold/v1alpha2\nkind: Config\nbuild:\n  tagPolicy:\n    gitCommit: {}\n  artifacts:\n  - imageName: gcr.io/opencensus-microservices-demo/emailservice\n    workspace: src/emailservice\n  - imageName: gcr.io/opencensus-microservices-demo/productcatalogservice\n    workspace: src/productcatalogservice\n  - imageName: gcr.io/opencensus-microservices-demo/recommendationservice\n    workspace: src/recommendationservice\n  - imageName: gcr.io/opencensus-microservices-demo/shippingservice\n    workspace: src/shippingservice\n  - imageName: gcr.io/opencensus-microservices-demo/checkoutservice\n    workspace: src/checkoutservice\n  - imageName: gcr.io/opencensus-microservices-demo/paymentservice\n    workspace: src/paymentservice\n  - imageName: gcr.io/opencensus-microservices-demo/currencyservice\n    workspace: src/currencyservice\n  - imageName: gcr.io/opencensus-microservices-demo/cartservice\n    workspace: src/cartservice\n  - imageName: gcr.io/opencensus-microservices-demo/frontend\n    workspace: src/frontend\n  - imageName: gcr.io/opencensus-microservices-demo/loadgenerator\n    workspace: src/loadgenerator\n  - imageName: gcr.io/opencensus-microservices-demo/adservice\n    workspace: src/adservice\n  - imageName: gcr.io/opencensus-microservices-demo/grafana\n    workspace: src/grafana\n  - imageName: gcr.io/opencensus-microservices-demo/prometheus\n    workspace: src/prometheus\n  - imageName: gcr.io/opencensus-microservices-demo/jaeger\n    workspace: src/jaeger\ndeploy:\n  kubectl:\n    manifests:\n    - ./kubernetes-manifests/**.yaml\n```\n\nGoë¡œ ì‘ì„±ëœ Frontend microserviceì„ ì‚´í´ë³´ì. [**./src/frontend/main.go**]\n\n### library ì¶”ê°€ ë° http handler ì´ˆê¸°í™”\n\nGoê¸°ë°˜ exporter íŒ¨í‚¤ì§€(jaeger,prometheus)ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ import í•˜ê³  http handlerë¥¼ ìœ„í•œ [ochttp íŒ¨í‚¤ì§€](https://godoc.org/go.opencensus.io/plugin/ochttp)ë¥¼ ì¶”ê°€í•˜ì˜€ë‹¤. \n```go\nimport (\n...\n        \"go.opencensus.io/exporter/jaeger\"\n        \"go.opencensus.io/exporter/prometheus\"\n        \"go.opencensus.io/plugin/ochttp\"\n        \"go.opencensus.io/plugin/ochttp/propagation/b3\"\n...\n)\nfunc main() {\n...\n        var handler http.Handler = r\n        handler = &logHandler{log: log, next: handler}\n        handler = ensureSessionID(handler)      \n        // add opencensus instrumentation\n        handler = &ochttp.Handler{ \n                Handler:     handler,\n                Propagation: &b3.HTTPFormat{}}\n        log.Infof(\"starting server on \" + addr + \":\" + srvPort)\n        log.Fatal(http.ListenAndServe(addr+\":\"+srvPort, handler))\n}\n```\n\n### exporter ë“±ë¡(Jaeger Tracing ë° Prometheus exporter)\n\nì˜ˆì‹œì²˜ëŸ¼ ê°ê°ì˜ ì„œë¹„ìŠ¤ì— jaegerì™€ prometheus exporter Endpointë¥¼ ì‰½ê²Œ ë“±ë¡í• ìˆ˜ ìˆë‹¤.  \në˜í•œ initTracing() ì—ì„œëŠ” ë°ëª¨ë¥¼ ìœ„í•´ trace.AlwaysSample()ì„ ì‚¬ìš©í•˜ì˜€ë‹¤. ì‹¤ì œ ìš´ì˜í™˜ê²½ì—ì„œëŠ” [ë‹¤ìŒ ë§í¬](https://github.com/census-instrumentation/opencensus-specs/blob/master/trace/Sampling.md)ë¥¼ ì°¸ê³ í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œê³ í•˜ê³  ìˆë‹¤. \n\n```go\n...\nfunc initJaegerTracing(log logrus.FieldLogger) {\n        // Register the Jaeger exporter to be able to retrieve\n        // the collected spans.\n        exporter, err := jaeger.NewExporter(jaeger.Options{\n                Endpoint: \"http://jaeger:14268\",\n                Process: jaeger.Process{\n                        ServiceName: \"frontend\",\n                },\n        })\n        if err != nil {\n                log.Fatal(err)\n        }\n        trace.RegisterExporter(exporter)\n}\n\nfunc initTracing(log logrus.FieldLogger) {\n        // This is a demo app with low QPS. trace.AlwaysSample() is used here\n        // to make sure traces are available for observation and analysis.\n        // In a production environment or high QPS setup please use\n        // trace.ProbabilitySampler set at the desired probability.\n        trace.ApplyConfig(trace.Config{\n                DefaultSampler: trace.AlwaysSample(),\n        })\n        initJaegerTracing(log)\n}\n\nfunc initPrometheusStatsExporter(log logrus.FieldLogger) *prometheus.Exporter {\n\texporter, err := prometheus.NewExporter(prometheus.Options{})\n\n\tif err != nil {\n\t\tlog.Fatal(\"error registering prometheus exporter\")\n\t\treturn nil\n\t}\n\n\tview.RegisterExporter(exporter)\n\treturn exporter\n}\nfunc startPrometheusExporter(log logrus.FieldLogger, exporter *prometheus.Exporter) {\n\taddr := \":9090\"\n\tlog.Infof(\"starting prometheus server at %s\", addr)\n\thttp.Handle(\"/metrics\", exporter)\n\tlog.Fatal(http.ListenAndServe(addr, nil))\n}\n...\n```\n\n### Demo Application ë°°í¬\n\nminikubeì— Hipster Shop Demoë¥¼ ë°°í¬í•œë‹¤. ë‹¨ìˆœí•˜ê²Œ `skaffold run` ëª…ë ¹ìœ¼ë¡œ ì§„í–‰í•˜ë©´ ëœë‹¤.\n\n```\n$ skaffold run\n```\n\ní˜„ì¬ ì‚¬ìš©ì¤‘ì¸ 2018 Macbook Pro(3.1 GHz Intel Core i7, 16GB) ìƒì˜ Dockerê¸°ë°˜ minikube í™˜ê²½ìœ¼ë¡œë„ ë°°í¬ë¥¼ í•˜ì˜€ëŠ”ë° ì‹œê°„ì´ ê½¤ ì†Œìš”ë˜ì—ˆë‹¤.(20ë¶„ì´ìƒ)  \nì½”ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì •í•˜ê³  ë¹Œë“œ, ë°°í¬ë˜ëŠ” ê²ƒì€ `skaffold dev` ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì§„í–‰ë˜ëŠ” ê³¼ì •ì„ ë³´ë©´ [draft.sh](https://draft.sh/) í”„ë¡œì íŠ¸ì™€ë„ ê½¤ ìœ ì‚¬í•˜ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.  \n\nì—ëŸ¬ì—†ì´ runì´ ì‹¤í–‰ë˜ê³  ë‚œí›„ minikubeì— ë°°í¬ëœ podì™€ serviceë¥¼ í™•ì¸í•œë‹¤. ì¤‘ê°„ì— loadgeneratorê°€ initì¸ ì´ìœ ëŠ” minikube ìì›ì´ ë¶€ì¡±í•´ì„œ ë°œìƒí•˜ëŠ” í˜„ìƒì´ë‹¤.\n\n```bash\n$ kubectl get pod\nNAME                                     READY     STATUS     RESTARTS   AGE\nadservice-7c7d687dcb-xzr4m               1/1       Running    1          4h\ncartservice-f54bcb9ff-tcfgn              1/1       Running    4          4h\ncheckoutservice-576446687b-95bwj         1/1       Running    1          4h\ncurrencyservice-5bd99bf97d-28mtz         1/1       Running    1          4h\nemailservice-6cb587798d-wwzdh            1/1       Running    1          4h\nfrontend-6bf9796f7b-ch9pl                1/1       Running    4          4h\ngrafana-6678c5c5d9-2qx75                 1/1       Running    1          4h\njaeger-5b66bdf7f7-csdzx                  1/1       Running    2          4h\nloadgenerator-7c4f446774-68djg           0/1       Init:0/1   1          4h\npaymentservice-fc4c8589-wrfg7            1/1       Running    1          4h\nproductcatalogservice-84878c8b9c-jhgnw   1/1       Running    1          4h\nprometheus-58d98b7578-87td6              1/1       Running    1          4h\nrecommendationservice-8564f9d894-smlpf   1/1       Running    1          4h\nredis-cart-798bc66d58-xn6ff              1/1       Running    1          4h\nshippingservice-789656f6bc-rgzrp         1/1       Running    1          4h\n\n$ kubectl get svc\nNAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                            AGE\nadservice               ClusterIP      10.107.196.115   <none>        9555/TCP,9090/TCP                                                  4h\ncartservice             ClusterIP      10.98.151.164    <none>        7070/TCP                                                           4h\ncheckoutservice         ClusterIP      10.97.9.197      <none>        5050/TCP                                                           4h\ncurrencyservice         ClusterIP      10.103.112.225   <none>        7000/TCP                                                           4h\nemailservice            ClusterIP      10.97.184.174    <none>        5000/TCP                                                           4h\nfrontend                ClusterIP      10.103.40.138    <none>        80/TCP,9090/TCP                                                    4h\nfrontend-external       LoadBalancer   10.108.170.241   <pending>     80:31944/TCP                                                       4h\ngrafana                 ClusterIP      10.104.141.254   <none>        3000/TCP                                                           4h\ngrafana-external        LoadBalancer   10.102.166.138   <pending>     3000:30459/TCP                                                     4h\njaeger                  ClusterIP      10.98.71.173     <none>        9411/TCP,5775/UDP,6831/UDP,6832/UDP,5778/TCP,16686/TCP,14268/TCP   4h\njaeger-external         LoadBalancer   10.96.164.126    <pending>     16686:32362/TCP                                                    4h\nkubernetes              ClusterIP      10.96.0.1        <none>        443/TCP                                                            6h\npaymentservice          ClusterIP      10.109.31.241    <none>        50051/TCP                                                          4h\nproductcatalogservice   ClusterIP      10.101.124.106   <none>        3550/TCP                                                           4h\nprometheus              ClusterIP      10.103.107.213   <none>        9090/TCP                                                           4h\nrecommendationservice   ClusterIP      10.104.225.28    <none>        8080/TCP                                                           4h\nredis-cart              ClusterIP      10.101.24.157    <none>        6379/TCP                                                           4h\nshippingservice         ClusterIP      10.104.224.18    <none>        50051/TCP                                                          4h\n```\n\n### ì„œë¹„ìŠ¤ ì ‘ì† ë° Metric/Tracing í™•ì¸\në¡œì»¬ minikubeí™˜ê²½ì´ê¸° ë•Œë¬¸ì— external serviceê°€ pendingì´ë¯€ë¡œ serviceë¥¼ minikube NAT IPë¡œ expose ì‹œí‚¨ë‹¤.\n\n```bash\n$ minikube service frontend-external\n$ minikube service grafana-external\n$ minikube service jaeger-external\n$ minikube service list\n|-------------|-----------------------|-----------------------------|\n|  NAMESPACE  |         NAME          |             URL             |\n|-------------|-----------------------|-----------------------------|\n| default     | adservice             | No node port                |\n| default     | cartservice           | No node port                |\n| default     | checkoutservice       | No node port                |\n| default     | currencyservice       | No node port                |\n| default     | emailservice          | No node port                |\n| default     | frontend              | No node port                |\n| default     | frontend-external     | http://192.168.99.101:31944 |\n| default     | grafana               | No node port                |\n| default     | grafana-external      | http://192.168.99.101:30459 |\n| default     | jaeger                | No node port                |\n| default     | jaeger-external       | http://192.168.99.101:32362 |\n| default     | kubernetes            | No node port                |\n| default     | paymentservice        | No node port                |\n| default     | productcatalogservice | No node port                |\n| default     | prometheus            | No node port                |\n| default     | recommendationservice | No node port                |\n| default     | redis-cart            | No node port                |\n| default     | shippingservice       | No node port                |\n| kube-system | kube-dns              | No node port                |\n|-------------|-----------------------|-----------------------------|\n```\n\n3ê°œì˜ ì„œë¹„ìŠ¤ë¡œ ê°ê° ì ‘ì†ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.\nGrafana ëŒ€ì‹œë³´ë“œë¡œ ë“¤ì–´ê°€ë©´ í˜„ì¬ ìˆ˜ì§‘ë˜ëŠ” prometheus source(http://prometheus:9090)ë¥¼ í†µí•´ OpenCensusê¸°ë°˜ Application Metricì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n![hipster_grafana](/img/hipster_grafana.png)\n\nê·¸ë¦¼ì—ì„œ ë³´ë©´ ì „ì²´ ì„œë¹„ìŠ¤ ì‘ë‹µì— ëŒ€í•œ 99% ë°±ë¶„ìœ„ ì§€ì—°ì‹œê°„ì´ 944ms ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\në˜í•œ Jaegerë¥¼ í†µí•´ DAG(Directed acyclic graph) ë° ì„œë¹„ìŠ¤ê°„ Tracing ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n![DAG](/img/dag.png)\n\n![tracing](/img/tracing.png)\n\n## ì •ë¦¬\nOpenCensus ê¸°ë°˜ìœ¼ë¡œ ê°œë°œìê°€ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  Microserviceë¥¼ minikubeì—ì„œ ë°°í¬í•˜ê³  Prometheus, Jaeger Exporter ì—°ë™ì„ í†µí•´ ì‹œìŠ¤í…œë¿ë§Œì´ ì•„ë‹Œ Applicationê¸°ë°˜ Metrics/Statsì„ ìˆ˜ì§‘í•˜ê³  ê°œë°œìê°€ ì‘ì„±í•œ ì½”ë“œë¥¼ ì§ì ‘ Tracingí•˜ëŠ” ê°„ë‹¨í•œ ë°ëª¨ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. (Istioë¥¼ í¬í•¨í•´ì„œ Publicí™˜ê²½ì— ë°°í¬í•´ë´ë„ ì¢‹ì€ ê³µë¶€ê°€ ë  ê²ƒ ê°™ë‹¤)  \n\ní–¥í›„ [OpenMetric](https://openmetrics.io/)ê³¼ [Opencensus](https://opencensus.io/)ê°€ ì‹¤ì œ ê°œë°œì ê¸°ë°˜ìœ¼ë¡œ í™œì„±í™”ë˜ê³  ì ìš©ì´ ëœë‹¤ë©´ Telemetric ì¸¡ë©´ì—ì„œ ë§ì€ Use-Caseê°€ ë„ì¶œë  ìˆ˜ ìˆì„ê²ƒ ê°™ë‹¤.  \n\nìœ„ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ Prometheusê¸°ë°˜ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ìš´ì˜í•˜ê³  ìˆëŠ” íŒ€ì˜ ê²½ìš° ê°œë°œìì˜ ì‘ì„± ì½”ë“œë¥¼ ìµœì†Œí™”í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œì„œ ì¶©ë¶„íˆ í™œìš©ë  ìˆ˜ ìˆì–´ ë³´ì¸ë‹¤.  \n\nê¼­ Cloud Native ê¸°ë°˜ Web ê°œë°œì´ ì•„ë‹ˆë”ë¼ë„ ê¸°ì¡´ ê³µì¥, ê¸ˆìœµ, ë³‘ì› ë“± ì˜ IoTë‚˜ ì„¼ì„œ/ì„¤ë¹„ë¥¼ ìœ„í•œ ë¹„ì¦ˆë‹ˆìŠ¤ì—ë„ Backendë¡œì„œ í™•ì¥ì„±ìˆëŠ” ë„êµ¬ë¡œì„œ í™œìš©ì´ ë  ìˆ˜ ìˆì„ê²ƒ ê°™ë‹¤."
    },
    {
      "id": "kubernetes/knative-using-gloo/",
      "metadata": {
        "permalink": "/kubernetes/knative-using-gloo/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-02-28-knative-using-gloo.md",
        "source": "@site/blog/2019-02-28-knative-using-gloo.md",
        "title": "Knative with Gloo",
        "description": "Istioì— ì¢…ì†ë˜ì–´ìˆëŠ” Knativeê°€ ì•„ë‹Œ ê²½ëŸ‰í™”ëœ Ingress ì˜¤í”ˆì†ŒìŠ¤ Glooë¥¼ í™œìš©í•œ Knative ì„¤ì¹˜ ë° í™œìš©",
        "date": "2019-02-28T00:00:00.000Z",
        "formattedDate": "February 28, 2019",
        "tags": [
          {
            "label": "Knative",
            "permalink": "/tags/knative"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "FaaS",
            "permalink": "/tags/faa-s"
          },
          {
            "label": "Serverless",
            "permalink": "/tags/serverless"
          },
          {
            "label": "CRDs",
            "permalink": "/tags/cr-ds"
          },
          {
            "label": "CloudEvents",
            "permalink": "/tags/cloud-events"
          },
          {
            "label": "Mesh",
            "permalink": "/tags/mesh"
          },
          {
            "label": "Gloo",
            "permalink": "/tags/gloo"
          }
        ],
        "readingTime": 8.575,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Knative with Gloo",
          "comments": true,
          "classes": "wide",
          "description": "Istioì— ì¢…ì†ë˜ì–´ìˆëŠ” Knativeê°€ ì•„ë‹Œ ê²½ëŸ‰í™”ëœ Ingress ì˜¤í”ˆì†ŒìŠ¤ Glooë¥¼ í™œìš©í•œ Knative ì„¤ì¹˜ ë° í™œìš©",
          "slug": "kubernetes/knative-using-gloo/",
          "date": "2019-02-28T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Knative",
            "Kubernetes",
            "FaaS",
            "Serverless",
            "CRDs",
            "CloudEvents",
            "Mesh",
            "Gloo"
          ]
        },
        "prevItem": {
          "title": "Cloud-Native Microservices Demo Application with OpenCensus",
          "permalink": "/kubernetes/microservices-demo/"
        },
        "nextItem": {
          "title": "Knative CLI - knctl",
          "permalink": "/kubernetes/knative-knctl/"
        }
      },
      "content": "## Knative Routing\nKnativeëŠ” ì•ì—ì„œë„ ëª‡ë²ˆ ì–¸ê¸‰í•˜ì˜€ì§€ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ `Routing`ì„ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ì— ë…¸ì¶œí•  ì„œë¹„ìŠ¤ë“¤ì— ëŒ€í•œ HTTP Endpointë¥¼ ì œê³µí•œë‹¤. ì–´ë–»ê²Œ ë³´ë©´ ê¸°ë³¸ì ìœ¼ë¡œ API Gateway ì—­í• ì„ í•˜ê¸°ë„ í•˜ê³  Ingress ì—­í• ì„ í•˜ê¸°ë„ í•œë‹¤. ë³´í†µ Service meshì¸ `Istio`ë¥¼ ì‚¬ìš©í•˜ì—¬ ingressë¥¼ êµ¬í˜„í•˜ëŠ”ê²ƒì´ ë‹¹ì—°í•˜ë‹¤ê³  ìƒê°í•˜ê¸°ë„ í•˜ì§€ë§Œ Istioì˜ ëª¨ë“  ê¸°ëŠ¥ì´ Knativeì— í•„ìš”í•˜ì§€ëŠ” ì•Šê³  ì„¤ì¹˜ë˜ëŠ”ê²ƒ ìì²´ê°€ ë¦¬ì†ŒìŠ¤ ì†Œëª¨ê°€ ê½¤ ëœë‹¤ëŠ”ê²ƒì€ ì„¤ì¹˜ í•´ë³¸ì‚¬ëŒì€ ì•Œê³  ìˆì„ê²ƒì´ë‹¤. \n\n## Service \n### Kubernetes\n![ingress](https://www.nginx.com/wp-content/uploads/2017/09/NGINX-Plus-Features-Kubernetes-Ingress-Controller-644x372@2x.png)  \nì´ë¯¸ì§€ì¶œì²˜ : https://www.nginx.com/blog/announcing-nginx-ingress-controller-for-kubernetes-release-1-3-0/\n\n\nKubernetesì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì ‘ì†ì„ êµ¬í˜„í•˜ê²Œ ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ Podì™€ Serviceë¥¼ ìƒì„±í•˜ê³  Ingressë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤.\n\n### Knative\n![Serving](https://i1.wp.com/blog.openshift.com/wp-content/uploads/intro.png?w=499&ssl=1)  \nì´ë¯¸ì§€ì¶œì²˜ : https://blog.openshift.com/knative-serving-your-serverless-services/\n\n\nKnativeì—ì„œëŠ” ì•ì„  Knative ê´€ë ¨ í¬ìŠ¤íŒ…ì—ì„œë„ ì„¤ëª…í–ˆë“¯ì´ `Automatic scaling up and down to zero` íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆê¸°ì— Podê°€ ìµœì´ˆ ì‹¤í–‰ë˜ì–´ìˆì§€ ì•Šì€ ìƒíƒœì—ì„œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì˜¤ê²Œ ë˜ë©´ [Knative Serving Activator](https://github.com/knative/serving/blob/master/docs/scaling/DEVELOPMENT.md)ì— ì˜í•´ì„œ Podê°€ ì—†ëŠ” Revisionì„ í™•ì¸í•˜ê³  Cold Start í˜•íƒœë¡œ í”„ë¡œë¹„ì €ë‹í•˜ê²Œ ëœë‹¤. ë‚˜ëŠ” ì´ê²Œ ì§„ì •í•œ ì„œë²„ë¦¬ìŠ¤ë¼ê³  ìƒê°í•˜ì§€ë§Œ ì£¼ë³€ì— ë°˜ë°•í•˜ì‹œëŠ” ë¶„ë“¤ë„ ê°„í˜¹ ìˆë‹¤.\n\nì´í›„ Podê°€ Warm ìƒíƒœê°€ ë˜ê³  ë‚˜ë©´ Istio Route(Ingress Gateway)ë¥¼ í†µí•´ íŠ¸ë˜í”½ì´ Podë¡œ ì „ë‹¬ë˜ì–´ í†µì‹ ì´ ì´ë¤„ì§€ê²Œ ëœë‹¤.\n\ní˜„ì¬ KnativeëŠ” í˜„ì¬ Ingress Gateway ì˜ì¡´ì„±ì„ ê°€ì§€ê³  ìˆê³  Envoyê¸°ë°˜ Service Meshì¸ `Istio`, Envoyê¸°ë°˜ API Gatewayì¸ `Gloo` ë‘ê°€ì§€ ì˜µì…˜ìœ¼ë¡œ Ingress êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤.\n\n\n## Istio \nKnativeëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Ingress Gatewayê¸°ëŠ¥ì„ íƒ‘ì¬í•˜ê³  ìˆëŠ”ë° ì´ëŠ” Istioì˜ ê¸°ëŠ¥ì¤‘ í•˜ë‚˜ë‹¤.  \nIstioëŠ” ë‹¤ìŒê³¼ ê°™ì€ Core Featureë¥¼ ê°€ì§„ë‹¤. ìƒì„¸í•œ ë‚´ìš©ì€ [https://istio.io/docs/concepts/what-is-istio/](https://istio.io/docs/concepts/what-is-istio/) ì—ì„œ í™•ì¸í•˜ë©´ ëœë‹¤.\n\n* Traffic management\n* Security\n* Policies and Telemetry\n* Performance and Scalability\n\nIstioëŠ” 48ê°œì˜ `CRDs`(CustomResourceDefinition objects)ë¥¼ ê°€ì§€ê³  ìˆëŠ”ë° ì´ì¤‘ Knative Servingì—ì„œ ì‚¬ìš©í•˜ëŠ”ê±´ `VirtualService` ë‹¨ í•˜ë‚˜ë‹¤.\n\n## Gloo\n[Gloo](https://gloo.solo.io/)ëŠ” Kubernetes-native ingress controllerì´ì [Next Generation API Gateway](https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600) ë¥¼ ìœ„í•´ ì‹œì‘ëœ í”„ë¡œì íŠ¸ì´ë‹¤. ì‹¤ì œ Redhatì—ì„œ Openshiftê¸°ë°˜ Microservice ë° Istio ê°œë°œì—…ë¬´ë¥¼ í•˜ë‹¤ê°€ ìµœê·¼ì— solo.ioì˜ CTOë¡œ ì´ì§í•œ [Christian Posta](https://blog.christianposta.com/)ê°€ ë°€ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì´ê¸°ë„ í•˜ë‹¤. \n\n\n![gloo](https://cdn-images-1.medium.com/max/1600/0*Z0Jb5DJFOyeY91sN.)\n\n\n`Gloo`ëŠ” Envoy Proxy ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©° \nê¸°ì¡´ Legacyë¶€í„° Containerì„œë¹„ìŠ¤, FaaS(AWS Lambda, Azure Functions, GCP Functions)ì˜ì—­ì˜ Applicationë“¤ì„ REST, gRPC, SOAP, Web Sockerê¸°ë°˜ìœ¼ë¡œ Aggregate í•´ì„œ Function ê¸°ë°˜ ì¶”ìƒí™”ë¥¼ êµ¬í˜„í•´ ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ë¼ ì •ì˜ í•  ìˆ˜ ìˆë‹¤. \n\nIstioì˜ Ingressê¸°ëŠ¥ì™¸ì˜ ì—¬ëŸ¬ê°€ì§€ ë¶€ê°€ ê¸°ëŠ¥(Telemetry, Security, Policy Enforcement)ë“¤ì€ Knativeì—ì„œëŠ” í•„ìš”ë¡œ í•˜ì§€ ì•ŠëŠ”ë‹¤. \n\nKnative API Gateway ë¡œì„œ Istioê°€ ì•„ë‹Œ Glooê°€ ì¡°ê¸ˆë” ê²½ëŸ‰í™”ëœ ëŒ€ì•ˆìœ¼ë¡œ ê²°ì •ë˜ì—ˆê³  Glooë¥¼ í†µí•´ Knative ì„¤ì¹˜ê°€ ê°€ëŠ¥í•˜ê²Œ ë˜ì—ˆë‹¤. ë‹¨, Knative Eventing ì»´í¬ë„ŒíŠ¸ëŠ” í˜„ì¬ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤. \n\n## Install Knative with Gloo\n\nì°¸ê³ : [Install with Gloo](https://github.com/knative/docs/blob/master/install/Knative-with-Gloo.md)\n\nê°„ë‹¨í•˜ê²Œ glooì™€ Knative ì„¤ì¹˜ë¥¼ í•´ë³´ì.\n\n### Requirements\n* Kubernetes cluster v1.11 or newer \n* Enable [MutatingAdmissionWebhook admission controller](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#how-do-i-turn-on-an-admission-controller)\n* kubectl v1.10 or newer\n* Bash in Mac or Linux\n\n### Install Glooctl\n\ngloo CLI (glooctl) Download  \n[https://github.com/solo-io/gloo/releases](https://github.com/solo-io/gloo/releases)\n\në˜ëŠ” ì§ì ‘ Download\n```\n$ curl -sL https://run.solo.io/gloo/install | sh\nAttempting to download glooctl version v0.8.1\nDownloading glooctl-darwin-amd64...\nDownload complete!, validating checksum...\nChecksum valid.\nGloo was successfully installed ğŸ‰\n\nAdd the gloo CLI to your path with:\n  export PATH=$HOME/.gloo/bin:$PATH\n\nNow run:\n  glooctl install gateway     # install gloo's function gateway functionality into the 'gloo-system' namespace\n  glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system\n  glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress\nPlease see visit the Gloo Installation guides for more:  https://gloo.solo.io/installation/\n```\n\nPATH ë“±ë¡\n```\n$ export PATH=$HOME/.gloo/bin:$PATH\n```\n\ngloo CLI í™•ì¸\n```\n$ glooctl --version\nglooctl version 0.8.1\n```\n\nGCP ë¬´ë£Œí”Œëœìœ¼ë¡œ 3-node í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•œë‹¤.\n```\n$ gcloud container clusters create gloo \\\n  --region=asia-east1-a \\\n  --cluster-version=latest \\\n  --machine-type=n1-standard-2 \\\n  --enable-autorepair \\\n  --num-nodes=3\n```\n\ncluster ìƒì„±ëœê²ƒì„ í™•ì¸í•˜ê³  cluster-admin ê¶Œí•œì„ í• ë‹¹í•œë‹¤.\n```\n$ kubectl get nodes\nNAME                                  STATUS    ROLES     AGE       VERSION\ngke-gloo-default-pool-f6bcc479-f8v9   Ready     <none>    9m        v1.11.7-gke.6\ngke-gloo-default-pool-f6bcc479-fl78   Ready     <none>    9m        v1.11.7-gke.6\ngke-gloo-default-pool-f6bcc479-gfgw   Ready     <none>    9m        v1.11.7-gke.6\n\n$ kubectl create clusterrolebinding cluster-admin-binding \\\n>   --clusterrole=cluster-admin \\\n>   --user=$(gcloud config get-value core/account)\nYour active configuration is: [cloudshell-25974]\nclusterrolebinding.rbac.authorization.k8s.io \"cluster-admin-binding\" created\n```\n\nGlooì™€ Knative ì„¤ì¹˜ë¥¼ í•œë‹¤. ë¯¸ë¦¬ `glooctl install knative --dry-run` ìœ¼ë¡œ ì „ì²´ manifestë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n$ glooctl install knative\n```\n\nìœ„ì—ì„œ ì„¤ì¹˜ ê³¼ì •ì€ ìƒëµí–ˆì§€ë§Œ Istioì— ë¹„í•´ CRD ê°œìˆ˜ê°€ ì ì€ ê²ƒì„ ì•Œìˆ˜ìˆë‹¤. ë˜í•œ ì„¤ì¹˜ëœ ì»´í¬ë„ŒíŠ¸ ì—­ì‹œ Istioì— ë¹„í•´ì„œ ê°„ì†Œí™”ëœ ê²ƒì„ ì•Œìˆ˜ ìˆë‹¤. \n```\n$ kubectl get pods --namespace gloo-system                                                                                         \nNAME                                   READY     STATUS    RESTARTS   AGE\nclusteringress-proxy-59fd6fb56-dmwwm   1/1       Running   0          7m\ndiscovery-779884d4cc-xlql2             1/1       Running   6          7m\ngloo-844fc79445-f4zvg                  1/1       Running   6          7m\ningress-7d75c99874-s4m76               1/1       Running   6          7m\n\n$ kubectl get pods --namespace knative-serving\nNAME                          READY     STATUS    RESTARTS   AGE\nactivator-746f6bb684-49tfh    1/1       Running   0          12m\nautoscaler-955f679cd-tx5vw    1/1       Running   0          12m\ncontroller-7fc84c6584-jbn69   1/1       Running   0          12m\nwebhook-7797ffb6bf-6pgsw      1/1       Running   0          12m\n```\n\nì´ì „ í¬ìŠ¤íŒ…ì—ì„œë„ ì‚¬ìš©í–ˆë˜ `gcr.io/knative-sample/helloworld-go` ì´ë¯¸ì§€ë¥¼ í™œìš©í•˜ì—¬ ìƒ˜í”Œì•± Knative Serviceë¥¼ ë§Œë“ ë‹¤.\n\n#### service.yaml\n```\n$ vi service.yaml\n\napiVersion: serving.knative.dev/v1alpha1\nkind: Service\nmetadata:\n  name: helloworld-go\n  namespace: default\nspec:\n  runLatest:\n    configuration:\n      revisionTemplate:\n        spec:\n          container:\n            image: gcr.io/knative-sample/helloworld-go\n            env:\n              - name: TARGET\n                value: \"Go Sample v1\"\n```\n\n```\n$ kubectl apply --filename service.yaml\nservice.serving.knative.dev \"helloworld-go\" created\n```\n\nì•ì—ì„œë„ ì„¤ëª…í–ˆì§€ë§Œ `Automatic scaling up and down to zero` ìœ¼ë¡œ Cold Startê°€ ë˜ê³  ì ì‹œí›„ì— ì•„ë˜ì™€ ê°™ì´ Knative Serviceë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n$ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.domain]($ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.d\nomain\nNAME            DOMAIN\nhelloworld-go   helloworld-go.default.example.com\n```\n\nGloo Ingressë¥¼ í™•ì¸í•œë‹¤. GKEì—ì„œ ì„¤ì¹˜í–ˆê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ LoadBalancerê°€ ì—°ë™ë˜ì–´ ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n$ kubectl get svc -n gloo-system\nNAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE\nclusteringress-proxy   LoadBalancer   10.3.244.54    34.**.**.54   80:30978/TCP,443:32448/TCP   39m\ngloo                   ClusterIP      10.3.243.231   <none>        9977/TCP                     39m\n\n$ glooctl proxy url --name clusteringress-proxy\nhttp://34.**.**.54:80\n```\n\nìœ„ì—ì„œ ì–»ì€ ë‘ê°€ì§€ ì •ë³´ë¡œ ìƒì„±ëœ appì„ í…ŒìŠ¤íŠ¸í•œë‹¤. Cold Start(default timeout 5ë¶„) ë•Œë¬¸ì— ì‘ë‹µì´ ëŠ¦ì–´ì§ˆ ìˆ˜ë„ ìˆì§€ë§Œ ì ì‹œ ê¸°ë‹¤ë¦¬ë©´ ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ curl -H \"Host: helloworld-go.default.example.com\" http://34.**.**.54:80\nHello Go Sample v1!\n```\n\në¬¼ë¡  `Revision`ì´ë‚˜ `Route`ë¥¼ í™œìš©í•˜ì—¬ Knativeì˜ ê¸°ëŠ¥ì— ëŒ€í•´ì„œë„ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.\n\n## ì •ë¦¬\nGlooëŠ” Knative ClusterIngress CRDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” Istioì˜ ëŒ€ì•ˆìœ¼ë¡œì„œ ê°€ëŠ¥ì„±ì„ ë³´ì—¬ì£¼ê³  ìˆë‹¤. ì´ì™¸ì—ë„ The Service Mesh Orchestration Platform `SuperGloo`, Debugger for microservices `Squash` ë“± ë‹¤ì–‘í•œ Mesh Layerê¸°ë°˜ì˜ ì˜¤í”ˆì†ŒìŠ¤ë“¤ì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. ë˜ë‹¤ë¥¸ ìŠ¤ì³ì§€ë‚˜ê°ˆìˆ˜ë„ ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ì¼ìˆ˜ë„ ìˆê² ì§€ë§Œ í˜„ì¬ ê°œë°œë˜ëŠ” ë¡œë“œë§µ(https://www.solo.io/)ì„ ë³´ë©´ Knativeê°€ ê³ ë„í™”ë˜ëŠ” ì—¬ì •ì— ê°™ì´ ê°€ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\nnext-generation API Gatewayë¡œì„œ ë‹¤ì–‘í•œ í”„ë¡œí† ì½œì„ ì§€ì›í•˜ê¸° ë•Œë¬¸ì— (HTTP1, HTTP2, gRPC, REST/OpenAPISpec, SOAP, WebSockets, Lambda/Cloud Functions) ë”ìš±ë” Microservices ë° Serverless Workloadë¥¼ ìˆ˜í–‰í•˜ê¸°ì— ë”ìš± ì í•©í•œ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë³´ì¸ë‹¤. \n\n## ë‹¤ìŒ ì£¼ì œ\ní˜„ì¬ í•´ë³´ê³  ì‹¶ì€ê²ƒì€ ë² ì–´ë©”íƒˆ Kubernetes Clusterê¸°ë°˜ BGPë¡œ ë™ì‘í•˜ëŠ” [MetalLB](https://metallb.universe.tf/)ë‚˜ [Cillium on AWS](https://cilium.io/try-eks/) ì¸ë° ì‹œê°„ë‚˜ëŠ” ëŒ€ë¡œ í…ŒìŠ¤íŠ¸ í•´ë´ì•¼ ê² ë‹¤."
    },
    {
      "id": "kubernetes/knative-knctl/",
      "metadata": {
        "permalink": "/kubernetes/knative-knctl/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-02-18-knative-knctl.md",
        "source": "@site/blog/2019-02-18-knative-knctl.md",
        "title": "Knative CLI - knctl",
        "description": "Knative CLI tool knctlì— ëŒ€í•´ ì•Œì•„ë³´ì",
        "date": "2019-02-18T00:00:00.000Z",
        "formattedDate": "February 18, 2019",
        "tags": [
          {
            "label": "Knative",
            "permalink": "/tags/knative"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "FaaS",
            "permalink": "/tags/faa-s"
          },
          {
            "label": "Serverless",
            "permalink": "/tags/serverless"
          },
          {
            "label": "CRDs",
            "permalink": "/tags/cr-ds"
          },
          {
            "label": "CloudEvents",
            "permalink": "/tags/cloud-events"
          },
          {
            "label": "Mesh",
            "permalink": "/tags/mesh"
          },
          {
            "label": "knctl",
            "permalink": "/tags/knctl"
          }
        ],
        "readingTime": 14.54,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Knative CLI - knctl",
          "comments": true,
          "classes": "wide",
          "description": "Knative CLI tool knctlì— ëŒ€í•´ ì•Œì•„ë³´ì",
          "slug": "kubernetes/knative-knctl/",
          "date": "2019-02-18T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Knative",
            "Kubernetes",
            "FaaS",
            "Serverless",
            "CRDs",
            "CloudEvents",
            "Mesh",
            "knctl"
          ]
        },
        "prevItem": {
          "title": "Knative with Gloo",
          "permalink": "/kubernetes/knative-using-gloo/"
        },
        "nextItem": {
          "title": "Hybrid Cloud",
          "permalink": "/cloud/Hybrid/"
        }
      },
      "content": "## knctl\n`knctl` ì€ Knative CLI íˆ´ë¡œ ê°„ë‹¨í•˜ê²Œ knative clusterë¥¼ ë§Œë“¤ê³  Knativeë¥¼ ì¶”ìƒí™”í•´ì„œ ì•±ê¹Œì§€ ë°°í¬í•  ìˆ˜ ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ì´ë‹¤. \n\n#### ì°¸ê³ \n* https://github.com/cppforlife/knctl  \n* https://developer.ibm.com/blogs/2018/11/12/knctl-a-simpler-way-to-work-with-knative/  \n* https://starkandwayne.com/blog/public-traffic-into-knative-on-gke/\n\n### Knative ë‹¤ì‹œ ì‚´í´ë³´ê¸°\n\n[ì•ì„  í¬ìŠ¤íŒ…ì—ì„œë„ ì´ì•¼ê¸°](https://ddii.dev/kubernetes/knative/) í–ˆì§€ë§Œ ê¸°ì¡´ FaaS(AWS Lambda, Google Cloud Funtions, Azure Function) ê³¼ëŠ” ë‹¤ë¥¸ Serverless ê°œë…ìœ¼ë¡œ ë°›ì•„ë“¤ì–´ì•¼ í•œë‹¤.\n\në‹¤ì‹œ í•œë²ˆ íŠ¹ì§•ì„ ë‚˜ì—´í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.\n\n- Serverless Containerì˜ ì‹ ì†í•œ ë°°ì¹˜ \n- Automatic scaling up and down to zero\n- Istioë¥¼ ë°±ì—”ë“œë¡œ í™œìš©í•˜ì—¬ Routing êµ¬í˜„\n- ë°°í¬ ëœ ì½”ë“œ ë° configì˜ íŠ¹ì • ì‹œì  ìŠ¤ëƒ… ìƒ·\n\nê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì€ CRDs(Custom Resource Definitions)ë¡œ êµ¬ì„±ëœ ì˜¤ë¸Œì íŠ¸ë“¤ë¡œ ì •ì˜ëœë‹¤.\n\n- `Route`ëŠ” ì‚¬ìš©ì ì„œë¹„ìŠ¤ì— ëŒ€í•œ HTTP endpointì™€ Routingì„ ì œê³µí•œë‹¤.\n- `Revisions`ì€ code(function)ì™€ configë¡œ êµ¬ì„±ëœ ë¶ˆë³€ì˜ ìŠ¤ëƒ…ìƒ·. Routeë¥¼ í†µí•´ endpointë¥¼ í• ë‹¹ë°›ì§€ ëª»í•œ Revisionì€ ìë™ìœ¼ë¡œ kubernetes resourceì—ì„œ ì‚­ì œë¨\n- `Configuration`ì€ ìš”êµ¬ë˜ëŠ” Revision ìµœì‹  ìƒíƒœë¥¼ ê¸°ë¡í•˜ê³  ìƒì„±í•˜ê³  ì¶”ì í• ìˆ˜ ìˆìŒ. ì†ŒìŠ¤ íŒ¨í‚¤ì§€(git repoë‚˜ archive)ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ë‚´ìš©ì´ë‚˜ ë©”íƒ€ë°ì´í„°ë“±ì„ í¬í•¨ì‹œí‚¬ìˆ˜ ìˆìŒ. \n- `Service`ëŠ” `Routes`ì™€ `Configurations` ë¦¬ì†ŒìŠ¤ì˜ ì¶”ìƒí™”ëœ ì§‘í•©ì²´. ëª¨ë“  ì›Œí¬ë¡œë“œì˜ lifecycleì„ ê´€ë¦¬í•¨. íŠ¸ë˜í”½ì„ í•­ìƒ ìµœì‹ ì˜ Revisionìœ¼ë¡œ routeë˜ë„ë¡ ì •ì˜í• ìˆ˜ ìˆìŒ\n\ní•˜ë‚˜ì”© ì¡°ê¸ˆ ìì„¸íˆ ì´ì•¼ê¸° í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ì •ë¦¬ í• ìˆ˜ ìˆë‹¤.\n\n### Route\n**Route**ëŠ” ì‚¬ìš©ì ì„œë¹„ìŠ¤(Codeì™€ Configurationì˜ Revisionì •ë³´)ì˜ ë„¤íŠ¸ì›Œí¬ Endpointë¥¼ ì œê³µí•œë‹¤. kubernetes namespaceëŠ” ì—¬ëŸ¬ê°œì˜ `Route`ë¥¼ ê°€ì§ˆìˆ˜ ìˆë‹¤. `Route`ëŠ” í•˜ë‚˜ ì´ìƒì˜ `Revisions`ì„ ê°€ì§€ë©´ì„œ ìˆ˜ëª…ì´ ê¸¸ê³  ì•ˆì •ì ì¸ HTTP Endpointë¥¼ ì œê³µí•œë‹¤. ê¸°ë³¸êµ¬ì„±ì€ `Route` ê°ì²´ê°€ `Configuration`ì— ì˜í•´ ìƒì„±ëœ ìµœì‹ ì˜ Revisionìœ¼ë¡œ íŠ¸ë˜í”½ì„ ìë™ìœ¼ë¡œ ì§€ì •í•œë‹¤. ì¡°ê¸ˆë” ë³µì¡í•œ ê²½ìš°ë¡œëŠ” istioì˜ ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ íŠ¸ë˜í”½ì„ ë°±ë¶„ìœ¨ ê¸°ì¤€ìœ¼ë¡œ `Route`ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤. \n\n### Revision\n**Revision**ì€ Codeì™€ Configurationì˜ ë¶ˆë³€ì˜ ìŠ¤ëƒ…ìƒ·ì´ë‹¤. í•˜ë‚˜ì˜ `Revision`ì€ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì°¸ì¡°í•˜ê³  ì„ íƒì ìœ¼ë¡œ `Build`ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤. `Revision`ì€ **Configuration**ì´ ì—…ë°ì´íŠ¸ ì‹œ ìƒì„±ëœë‹¤.  \n`Route`ë¥¼ í†µí•´ httpì£¼ì†Œ ì§€ì •ì´ ë¶ˆê°€ëŠ¥í•œ `Revision`ì€ íê¸° ë˜ê³  ê´€ë ¨ëœ kubernetes ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œê°€ ëœë‹¤. ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ `Configuration`ì´ ìƒì„±í•œ `Revision` íˆìŠ¤í† ë¦¬ê°€ ì œê³µë˜ê³  ì‚¬ìš©ìëŠ” ì´ì „ `Revision`ë¡œ ì‰½ê²Œ ë¡¤ë°± í•  ìˆ˜ ìˆë‹¤.  \n\n### Configuration\n`Configuration`ì€ ìµœì‹ ì˜ `Revision`ìƒíƒœë¥¼ ì„¤ëª…í•˜ê³ , ìƒì„±í•˜ê³ , ì›í•˜ëŠ” ìƒíƒœê°€ ê°±ì‹ ë ë•Œ `Revision`ì˜ ìƒíƒœë¥¼ ì¶”ì í•œë‹¤. `Configuration`ì€ `Build`ë¥¼ ì°¸ì¡°í•˜ì—¬ ì†ŒìŠ¤(git repo ë˜ëŠ” archive)ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ê°€ì´ë“œê°€ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ ë‹¨ìˆœíˆ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë° ìˆ˜ì •ì—ì„œ í•„ìš”í•œ ë©”íƒ€ ë°ì´í„° ë§Œ ì°¸ì¡° í•  ìˆ˜ ìˆë‹¤. \n\n### Product Integration\n\n2019ë…„ 2ì›” í˜„ì¬ 0.3ì´ ë¦´ë¦¬ìŠ¤ë˜ê³  ìˆê³  ë²Œì¨ ì—¬ëŸ¬ ì œí’ˆì— í†µí•©ì´ ë˜ê³  ìˆë‹¤. \n\nìµœê·¼ IBMthink 2019ì—ì„œ Managed Knative (Experimental)ë¥¼ ë‚´ë†“ê¸°ë„ í•˜ì˜€ë‹¤.  \nhttps://www.ibm.com/blogs/bluemix/2019/02/announcing-managed-knative-on-ibm-cloud-kubernetes-service-experimental/ \n\nIstioë¥¼ í¬í•¨í•œ Knative ë§ˆì €ë„ í’ˆëŠ” ëª¨ìŠµìœ¼ë¡œ managed kubernetes ì˜ì—­ì—ì„œ ê¸€ë¡œë²Œ í”Œë ˆì´ì–´ë“¤ ëª¨ë‘ ì„œë¡œ ì¹˜ê³ ë‚˜ê°€ëŠ” ëª¨ìŠµë“¤ì„ ë³¼ìˆ˜ ìˆë‹¤. \n\nì‘ë…„ 11ì›”ì—ëŠ” Gitlab ì œí’ˆì•ˆì— serverlessë¼ëŠ” extensioní˜•íƒœì˜ ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ ë˜ê¸°ë„ í•˜ì˜€ê³ ,  \nhttps://about.gitlab.com/press/releases/2018-12-11-gitlab-and-triggermesh-announce-gitlab-serverless.html\n\ntriggermesh ë¼ëŠ” ê³³ì—ì„œëŠ” serverless management platformì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ knative ê¸°ë°˜ ë©€í‹° ì„œë²„ë¦¬ìŠ¤ í”Œë«í¼ì„ ì¶œì‹œí•˜ê¸°ë„ í•˜ì˜€ë‹¤.  \nhttps://triggermesh.com/serverless_management_platform/\n\nPivotal Function Service (PFS), Google GKE SERVERLESS ADD-ON ë“±ì€ ì•„ì§ early access ì‹ ì²­ë§Œ ë°›ê³  ìˆëŠ” ìƒíƒœì´ë‹¤.\n\nì˜¤ëŠ˜ì€ ê°„ë‹¨í•˜ê²Œ ë°°í¬í• ìˆ˜ ìˆëŠ” íˆ´ knctlê³¼ ê´€ë ¨ use-caseë¥¼ ì†Œê°œí•˜ê³ ì í•œë‹¤.\n\n### Kubernetes Cluster ìƒì„±\n\nì¼ë‹¨ GKE Free tierì—ì„œ Clusterë¥¼ í•˜ë‚˜ ìƒì„±í•˜ì.\n\n```\ngcloud container clusters create knative \\\n  --region=asia-east1-a \\\n  --cluster-version=latest \\\n  --machine-type=n1-standard-2 \\\n  --enable-autoscaling --min-nodes=1 --max-nodes=5 \\\n  --enable-autorepair \\\n  --scopes=service-control,service-management,compute-rw,storage-ro,cloud-platform,logging-write,monitoring-write,pubsub,datastore \\  \n  --num-nodes=3\n```\n\ncluster ìƒì„±ëœê²ƒì„ í™•ì¸í•˜ê³  cluster-admin ê¶Œí•œì„ í• ë‹¹í•œë‹¤. \n```\n$ kubectl get nodes\nNAME                                     STATUS    ROLES     AGE       VERSION\ngke-knative-default-pool-d1a39347-5m5t   Ready     <none>    1m        v1.11.7-gke.4\ngke-knative-default-pool-d1a39347-l6zh   Ready     <none>    1m        v1.11.7-gke.4\ngke-knative-default-pool-d1a39347-qv5r   Ready     <none>    1m        v1.11.7-gke.4\n\n$ kubectl create clusterrolebinding cluster-admin-binding \\\n  --clusterrole=cluster-admin \\\n  --user=$(gcloud config get-value core/account)\nYour active configuration is: [cloudshell-4728]\nclusterrolebinding.rbac.authorization.k8s.io \"cluster-admin-binding\" created\n```\n\n## knctl ì„¤ì¹˜\n\nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” Mac OS ì„¤ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ë‹¤.\n\n#### homebrew ì„¤ì¹˜\n```\nbrew install starkandwayne/kubernetes/knctl\n```\n\n#### binary\nhttps://github.com/cppforlife/knctl/releases \n```\n$ wget https://github.com/cppforlife/knctl/releases/download/v0.1.0/knctl-darwin-amd64\n$ mv knctl-* /usr/local/bin/knctl\n$ chmod +x /usr/local/bin/knctl\n```\n\n## knctl ë¡œ Knative ë°°í¬\n\nì„¤ì¹˜í•œ knctlë¡œ Knative ë°°í¬ë¥¼ ì§„í–‰í•œë‹¤. ì„¤ì¹˜ë˜ëŠ” ë‚´ìš©ì„ ì§€ì¼œë³´ê³  ìˆìœ¼ë©´ `istio`ë¥¼ ë¨¼ì € ë°°í¬í•˜ê³  ê·¸ë‹¤ìŒì— `Knative`ë¥¼ ì„¤ì¹˜í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë°°í¬ë˜ëŠ” ëª¨ë“ˆë“¤ì˜ ìƒíƒœë¥¼ í•˜ë‚˜í•˜ë‚˜ ì²´í¬í•´ì„œ ë°°í¬í•˜ê¸° ë•Œë¬¸ì— ì„¤ì¹˜ìƒì— ê³¼ì •ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\n$ knctl install --exclude-monitoring\n```\n\ní…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ namespace `hello-test`ë¥¼ ìƒì„±í•œë‹¤.\n```\n$ kubectl create namespace hello-test\nnamespace \"hello-test\" created\n```\n\nknctl deploy ëª…ë ¹ìœ¼ë¡œ ìµœì´ˆ revisionì„ ë°°í¬í•œë‹¤.  \nì•„ë˜ ê²°ê³¼ë¥¼ ë³´ë©´ hello-00001 ì´ë¼ê³  í•˜ëŠ” ìµœì´ˆì˜ revisionì„ ì‘ì„±í•˜ê¸° ë•Œë¬¸ì— `latest` tagë¥¼ ë‹¬ê³  ë°°í¬ë¥¼ í•˜ê²Œ ëœë‹¤. \n```\n$ knctl deploy \\\n      --namespace hello-test \\\n      --service hello \\\n      --image gcr.io/knative-samples/helloworld-go \\\n      --env TARGET=Rev1\n\nName  hello\n\nWaiting for new revision to be created...\n\nTagging new revision 'hello-00001' as 'latest'\n\nTagging new revision 'hello-00001' as 'previous'\n\nAnnotating new revision 'hello-00001'\n\nWaiting for new revision 'hello-00001' to be ready for up to 5m0s (logs below)...\n\nhello-00001 > hello-00001-deployment-5cdbfc9bc9-hks6t | 2019/02/17 22:27:50 Hello world sample started.\n\nRevision 'hello-00001' became ready\n\nContinuing to watch logs for 5s before exiting\n\nSucceeded\n```\n\n```\nkubectl get svc knative-ingressgateway -n istio-system\nNAME                     TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                                                                                                   AGE\nknative-ingressgateway   LoadBalancer   10.63.253.209   34.***.***.248   80:32380/TCP,443:32390/TCP,31400:32400/TCP,15011:30082/TCP,8060:31125/TCP,853:32009/TCP,15030:31102/TCP,15031:31631/TCP   6h\n```\n\nìœ„ì²˜ëŸ¼ Knativeê°€ í”„ë¡œë¹„ì €ë‹ ë˜ë©´ì„œ ingress-gatewayê°€ í•˜ë‚˜ ìƒì„±ì´ ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆê³  knctlë¡œë„ ingressë¥¼ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.\n```\n$ knctl ingress list\nIngresses\n\nName                    Addresses     Ports  Age\nknative-ingressgateway  34.***.***.248  80     6h\n                                        443\n                                        31400\n                                        15011\n                                        8060\n                                        853\n                                        15030\n                                        15031\n\n1 ingresses\n\nSucceeded\n```\n\n## Knative custom domain ì—°ê²°\n\nDomainì´ ë³„ë„ë¡œ ì—†ê¸° ë•Œë¬¸ì— KnativeëŠ” ë‚´ë¶€ì ìœ¼ë¡œ example.comì´ë¼ê³  í•˜ëŠ” ê¸°ë³¸ domainì„ ì‚¬ìš©í•œë‹¤. ê·¸ë˜ì„œ ì‹¤ì œ `knctl curl` ëª…ë ¹ì€ ë‚´ë¶€ì ìœ¼ë¡œ `hello.hello-test.example.com`ìœ¼ë¡œ curlì„ ì‹¤í–‰í•˜ê²Œ ë˜ê³  í•´ë‹¹ ê²°ê³¼ë¥¼ ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```\n$ knctl curl --service hello -n hello-test\nRunning: curl '-sS' '-H' 'Host: hello.hello-test.example.com' 'http://34.***.***.248:80'\n\nHello Rev1!\n\nSucceeded\n```\n\nkubernetes nodeê°€ 3ê°œì´ë¯€ë¡œ 3ê°œì˜ podê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì¼ì •ì‹œê°„(default:5ë¶„)ì´ ì§€ë‚˜ë©´ `zero to scale` ê´€ì ì—ì„œ podê°€ ì¢…ë£Œë˜ë¯€ë¡œ ë‹¤ì‹œ í™•ì¸í• ë•ŒëŠ” ë‹¤ì‹œ curl ëª…ë ¹ì„ ë‚ ë¦¬ê²Œ ë˜ë©´ ë‹¤ì‹œ podê°€ ì˜¬ë¼ì˜¤ê²Œ ëœë‹¤. í•´ë‹¹ ê°œë…ì€ FaaSë˜ëŠ” AWS Lambdaì—ì„œ Cold-Startì™€ ë™ì¼í•œ ê²ƒì´ë¼ ë³¼ ìˆ˜ ìˆë‹¤.  \n\nAWS Cold Start ì°¸ê³  : https://novemberde.github.io/aws/2018/02/02/Lambda_coldStart.html\n```\n$ kubectl get po\nNAME                                      READY     STATUS    RESTARTS   AGE\nhello-00001-deployment-5cdbfc9bc9-hks6t   3/3       Running   0          4m\n```\n\nê°€ì§€ê³  ìˆëŠ” ë„ë©”ì¸ì´ ìˆë‹¤ë©´ ìœ„ì—ì„œ ë‚˜ì˜¨ `34.***.***.248` IPë¥¼ domainì— ë§¤í•‘í•´ë³´ì.\nì•„ë˜ì—ì„œëŠ” ê¸°ì¡´ ë³´ìœ ì¤‘ì¸ skcloud.io ë„ë©”ì¸ì„ ì—°ê²°í•˜ì˜€ë‹¤.\n```\n$ dig knative.skcloud.io\n;; ANSWER SECTION:\nknative.skcloud.io.     603     IN      A       34.***.***.248\n```\n\nknctl domainì„ ì´ìš©í•˜ì—¬ default domainì„ `knative.skcloud.io`ë¡œ ë³€ê²½í•œë‹¤.\n```\n$ knctl domain create -d knative.skcloud.io --default\nSucceeded\n```\n\nknctl routes ëª…ë ¹ìœ¼ë¡œ í•´ë‹¹ hello-test appì˜ Endpoint ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ knctl routes list -n hello-test\nRoutes in namespace 'hello-test'\n\nName   Domain                               Traffic        Annotations  Conditions  Age\nhello  hello.hello-test.knative.skcloud.io  100% -> hello  -            3 OK / 3    1h\n\n1 routes\n\nSucceeded\n```\n\n5ë¶„ì´ìƒ ê¸°ë‹¤ë ¸ë‹¤ê°€ curlë¡œ í™•ì¸í•˜ë©´ Cold-Start ë˜ëŠ” ì‹œê°„(ëª‡ì´ˆ) ì§€ì—°ì´ ë°œìƒí•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\nì´í›„ì—ëŠ” ë°”ë¡œ ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n$ curl http://hello.hello-test.knative.skcloud.io/\nHello Rev1!\n```\n\n## revision ì¶”ê°€\n\nì´ë²ˆì—ëŠ” revisionì„ ì¶”ê°€í•´ë³´ì. TARGET environment ë³€ìˆ˜ë¥¼ `Rev2`ë¡œ ìˆ˜ì •í•˜ê³  ë°°í¬ë¥¼ í•œë‹¤.\nê¸°ì¡´ hello-00002 revisionì´ ìµœì‹  revisionìœ¼ë¡œ ê°±ì‹ ë˜ì–´ ë°°í¬ê°€ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ knctl deploy --service hello \\\n    --image gcr.io/knative-samples/helloworld-go \\\n    --env TARGET=Rev2\nName  hello\n\nWaiting for new revision (after revision 'hello-00001') to be created...\n\nTagging new revision 'hello-00002' as 'latest'\n\nTagging older revision 'hello-00001' as 'previous'\n\nAnnotating new revision 'hello-00002'\n\nWaiting for new revision 'hello-00002' to be ready for up to 5m0s (logs below)...\n\nhello-00002 > hello-00002-deployment-6cf86bbfc7-sblz9 | 2019/02/17 23:25:43 Hello world sample started.\n\nRevision 'hello-00002' became ready\n\nContinuing to watch logs for 5s before exiting\n\nSucceeded\n```\n\nì‹ ê·œ `revision` ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ ëª‡ì´ˆê°„ì˜ Cold-Start delayê°€ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤. \n```\n$ curl http://hello.hello-test.knative.skcloud.io/\nHello Rev2!\n\n$ knctl curl --service hello\nRunning: curl '-sS' '-H' 'Host: hello.hello-test.knative.skcloud.io' 'http://34.***.***.248:80'\n\nHello Rev2!\n\nSucceeded\n```\n\nrevision listë¥¼ í™•ì¸í•´ë³´ë©´ í˜„ì¬ latest, previous TAGì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ knctl revision list --service hello\nRevisions for service 'hello'\n\nName         Tags      Annotations  Conditions  Age  Traffic\nhello-00002  latest    -            1 OK / 4    14m  100% -> hello.hello-test.knative.skcloud.io\nhello-00001  previous  -            1 OK / 4    4h   -\n\n2 revisions\n\nSucceeded\n```\n\n## Blue/Green ë°°í¬\n\nBlue/Green DeployëŠ” knctl rollout ëª…ë ¹ìœ¼ë¡œ ìˆ˜í–‰í• ìˆ˜ ìˆë‹¤.  \nrollout í• ë•Œ `--managed-route=false` ì˜µì…˜ì„ ì¤˜ì•¼ íŠ¹ì • ë¹„ìœ¨ë¡œ routingì´ ê°€ëŠ¥í•˜ë‹¤.  \nì•„ë˜ ì˜ˆì‹œëŠ” TARGET environment ë³€ìˆ˜ë¥¼ `blue`, `green`ìœ¼ë¡œ ë°”ê¿”ê°€ë©´ì„œ ë°°í¬ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.\n```\n$ knctl deploy --service hello \\\n    --image gcr.io/knative-samples/helloworld-go \\\n    --env TARGET=blue \\\n    --managed-route=false\nName  hello\n\nWaiting for new revision (after revision 'hello-00002') to be created...\n\nTagging new revision 'hello-00003' as 'latest'\n\nTagging older revision 'hello-00002' as 'previous'\n\nAnnotating new revision 'hello-00003'\n\nWaiting for new revision 'hello-00003' to be ready for up to 5m0s (logs below)...\n\nRevision 'hello-00003' became ready\n\nContinuing to watch logs for 5s before exiting\n\nhello-00003 > hello-00003-deployment-99478dcc5-jf267 | 2019/02/17 23:48:20 Hello world sample started.\n\nSucceeded\n```\n\nrevision listë¥¼ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ `latest`ë¡œ Traffic ì „ì²´ê°€ routing ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ knctl revision list --service hello\nRevisions for service 'hello'\n\nName         Tags      Annotations  Conditions  Age  Traffic\nhello-00005  latest    -            4 OK / 4    44s  100% -> hello.hello-test.knative.skcloud.io\nhello-00004  previous  -            4 OK / 4    2m   -\nhello-00003  -         -            1 OK / 4    5m   -\nhello-00002  -         -            1 OK / 4    28m  -\nhello-00001  -         -            1 OK / 4    4h   -\n\n5 revisions\n\nSucceeded\n```\n\nì´í›„ì— rolloutì„ í†µí•´ previousë¡œ 90%, latestë¡œ 10%ë¡œ ë³€ê²½ì„ í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜ì´ ë˜ê³  ì‹¤ì œ íŠ¸ë˜í”½ë„ ë¶„ì‚°ë˜ì–´ ë“¤ì–´ì˜¨ë‹¤. %ê°€ ë‚®ì€ ìª½ìœ¼ë¡œ routingì´ ë  ê²½ìš° Cold-Startê°€ ë°œìƒí•˜ê²Œ ë˜ë©´ delayëŠ” ë°œìƒí•˜ê²Œ ëœë‹¤.\n```\n$ knctl rollout --route hello -p hello:latest=10% -p hello:previous=90%\nSucceeded\n\n$ knctl revision list\nRevisions\n\nService  Name         Tags      Annotations  Conditions  Age  Traffic\nhello    hello-00005  latest    -            2 OK / 4    1h   10% -> hello.hello-test.knative.skcloud.io\n~        hello-00004  previous  -            2 OK / 4    1h   90% -> hello.hello-test.knative.skcloud.io\n~        hello-00003  -         -            1 OK / 4    1h   -\n~        hello-00002  -         -            1 OK / 4    1h   -\n~        hello-00001  -         -            1 OK / 4    5h   -\n\n5 revisions\n\nSucceeded\n```\n\nê°„ë‹¨í•˜ê²Œ curl ë°˜ë³µë¬¸ì„ ì‘ì„±í•˜ì—¬ ëŒë ¤ë³´ì. \n```\n#!/bin/sh\nwhile true\ndo\ncurl -sS --max-time 3 http://hello.hello-test.knative.skcloud.io/\ndone\n```\n\nê°„ë‹¨í•˜ê²Œ ìœ„ shì„ ëŒë¦¬ë©´ ì•„ë˜ì™€ ê°™ì´ Cold-Start delayê°€ ë°œìƒí• ë•Œ time outì´ ë°œìƒí•˜ê³  ì´í›„ green revisionìœ¼ë¡œ ì ‘ì†ì´ ë˜ëŠ”ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. \n```\n$ ./test.sh\ncurl: (28) Operation timed out after 3002 milliseconds with 0 bytes received\nHello blue!\nHello blue!\nHello blue!\nHello blue!\nHello blue!\ncurl: (28) Operation timed out after 3003 milliseconds with 0 bytes received\nHello blue!\nHello blue!\nHello blue!\nHello blue!\nHello blue!\nHello blue!\nHello green!\nHello blue!\nHello blue!\nHello blue!\n```\n\n## ì •ë¦¬\nì§€ê¸ˆê¹Œì§€ `knctl`ì„ ì‚¬ìš©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ knativeë¥¼ ë°°í¬í•˜ê³  custom domainì„ ì—°ê²°í•˜ì—¬ blue-green ë°°í¬ê¹Œì§€ í•´ë´¤ë‹¤. \nì´ì™¸ì—ë„ Knative Buildë¥¼ í™œìš©í•˜ì—¬ Docker image ì‘ì—…ì„ í•˜ê±°ë‚˜ ì„œë¹„ìŠ¤ ì¹´íƒˆë¡œê·¸ ë“±ì„ ì—°ë™í•˜ì—¬ ì™¸ë¶€ DBaaSë¥¼ ì—°ë™í•˜ëŠ” use-caseë“±ì„ ì°¾ì•„ë³¼ìˆ˜ ìˆë‹¤.\n\nì•„ì§ ì´ˆê¸° ë‹¨ê³„ì´ì§€ë§Œ KnativeëŠ” istioì™€ í•¨ê»˜ IBM, Google, Pivotalë“± global playerë“¤ì˜ ì°¨ì„¸ëŒ€ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë¶€ìƒí•˜ê³  ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.  \n\n`Zero to scale` ì´ë¼ëŠ” ìŠ¬ë¡œê±´ì•„ë˜ Serverless, FaaS ì‚¬ìƒì„ ê¸°ë°˜ìœ¼ë¡œ build, serving, event, routingì´ë¼ê³  í•˜ëŠ” Cloud Computing ì¶”ìƒí™”ì˜ ëíŒìœ¼ë¡œ ì§„í™”í•˜ê³  ìˆë‹¤. ì•ìœ¼ë¡œ ì–´ë–¤ ëª¨ìŠµìœ¼ë¡œ ì§„í™”ë ì§€ ê¶ê¸ˆí•˜ê³  ë‹¤ìŒë²ˆì—ëŠ” MQë‚˜ Pub/subë¥¼ ì—°ë™í•˜ê±°ë‚˜ ë©€í‹° í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ë™ì‘í•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì£¼ëŠ” ê²ƒë„ ì¢‹ì„ê²ƒ ê°™ë‹¤. í¬ë§ì‚¬í•­ì´ì§€ë§Œ ì˜¬í•´ OpenInfraDayë‚˜ Kubernetes Day Korea í–‰ì‚¬ì—ì„œ Hands-onì„ ì§„í–‰í•´ë³´ëŠ”ê²ƒë„ ì¢‹ì§€ ì•Šì„ê¹Œ?"
    },
    {
      "id": "cloud/Hybrid/",
      "metadata": {
        "permalink": "/cloud/Hybrid/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-02-10-Hybrid.md",
        "source": "@site/blog/2019-02-10-Hybrid.md",
        "title": "Hybrid Cloud",
        "description": "Hybrid Cloud",
        "date": "2019-02-10T00:00:00.000Z",
        "formattedDate": "February 10, 2019",
        "tags": [
          {
            "label": "Hybrid",
            "permalink": "/tags/hybrid"
          },
          {
            "label": "Multi",
            "permalink": "/tags/multi"
          },
          {
            "label": "Outpost",
            "permalink": "/tags/outpost"
          },
          {
            "label": "VMware",
            "permalink": "/tags/v-mware"
          }
        ],
        "readingTime": 9.375,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Hybrid Cloud",
          "comments": true,
          "classes": "wide",
          "description": "Hybrid Cloud",
          "slug": "cloud/Hybrid/",
          "date": "2019-02-10T00:00:00.000Z",
          "categories": [
            "Cloud"
          ],
          "tags": [
            "Hybrid",
            "Multi",
            "Outpost",
            "VMware"
          ]
        },
        "prevItem": {
          "title": "Knative CLI - knctl",
          "permalink": "/kubernetes/knative-knctl/"
        },
        "nextItem": {
          "title": "SRE (Site Reliablity Engineering)",
          "permalink": "/job/SRE/"
        }
      },
      "content": "ì˜¤ëŠ˜ë„ ê¸°ìˆ ì ì¸ ì´ì•¼ê¸°ë³´ë‹¤ëŠ” í™”ë‘ê°€ ë˜ê³  ìˆëŠ” í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ ì´ì•¼ê¸°ë¥¼ í•´ë³´ê³ ì í•œë‹¤.\n\nì—…ê³„ ì‚¬ëŒë“¤ë„ í•˜ì´ë¸Œë¦¬ë“œ, ì—£ì§€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ë¥¼ ê¸ì •ì ì¸ ì‹œê°ìœ¼ë¡œ ë³´ê³ ìˆì§€ë§Œ ì„±ìˆ™ë„ ì¸¡ë©´ì—ì„œ ë¬¸ì œê°€ ìˆì–´ ë„ì…ì„ êº¼ë ¤ì™”ë˜ê²Œ ì‚¬ì‹¤ì´ë‹¤. ìµœê·¼ ë™í–¥ì„ ë´¤ì„ë•Œ í¼ë¸”ë¦­ í´ë¼ìš°ë“œ ê³µê¸‰ì‚¬ì—ì„œë„ í”„ë¼ì´ë¹— í´ë¼ìš°ë“œë¥¼ í¬ì„­í•´ì•¼í•  ëŒ€ìƒìœ¼ë¡œ ì¸ì •í•˜ê³  ê³µê²©ì ìœ¼ë¡œ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ ì†”ë£¨ì…˜ì„ ê°œë°œí•˜ì—¬ ì œê³µí•˜ë ¤ê³  í•˜ëŠ” ì›€ì§ì„ì„ ë³´ì´ê³  ìˆë‹¤.\n\nì—”í„°í”„ë¼ì´ì¦ˆì—ì„œëŠ” ì…ì¥ì—ì„œëŠ” Scale, DRì¸¡ë©´ì—ì„œ On-Prem ì—ì„œ í¼ë¸”ë¦­ìœ¼ë¡œ í™•ì¥ì„ ë„ëª¨í•˜ê³  ìˆê³  ê¸€ë¡œë²Œí”Œë ˆì´ì–´ ì…ì¥ì—ì„œëŠ” í¼ë¸”ë¦­ì—ì„œ On-Premìœ¼ë¡œ ì „ì´í•˜ëŠ” ëª¨ìŠµìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ë¥¼ ì§„í–‰í•˜ê³  ìˆë‹¤. í•˜ì§€ë§Œ êµ¬ê¸€ì€ íŠ¹ë³„í•˜ê²Œ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰ì¤‘ì´ë‹¤. ëˆ„ê°€ ëê¹Œì§€ ì‚´ì•„ë‚¨ì•„ ìŠ¹ìê°€ ë ì§€ ì•„ë¬´ë„ ëª¨ë¥¸ë‹¤. \n\nì•ìœ¼ë¡œ ì—´ë¦´ ì‹œì¥ì€ í™•ì‹¤í•˜ê³  ê¼­ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì€ ì•Œì§€ë§Œ ê¸°ìˆ ì˜ ì„±ìˆ™ë„ê°€ ë†’ì§€ ì•Šê³  ë„˜ì–´ì•¼í•  í—ˆë“¤ì´ ë§ë‹¤. ì•„ì§ê¹Œì§€ ì—°ê³„ ê¸°ìˆ ì´ë‚˜ ìƒíƒœê³„ê°€ ë¹„ì–´ ìˆëŠ” ë¶€ë¶„ë“¤ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— ì˜¬í•´ ë§ì¯¤ ë˜ë©´ ì—¬ëŸ¬ ìƒí’ˆë“¤ì´ ì¶œì‹œë˜ë©´ì„œ ì •ë¦¬ ë˜ì§€ ì•Šì„ê¹Œ ì‹¶ë‹¤. \n\nhttps://wikibon.com/aws-outposts-enables-hybrid-cloud/\n\nìœ„ í¬ìŠ¤íŒ…ì—ì„œë„ 2ê°€ì§€ ì˜ë¬¸ì ì„ ì œê¸°í•œë‹¤.\n\n* Will a data egress charge be applied to data resident on the disks to other on-premise workloads?  \n`ì˜ˆì‹œ) S3 â†’ Outpost egress íŠ¸ë˜í”½(private n/w ì´ê¸´ í•˜ì§€ë§Œ awsê°€ ëˆì„ ì•ˆ ë°›ì„ê²ƒì¸ê°€?, ê²°êµ­ direct-linkëŠ” í•„ìˆ˜ì¸ê±´ì§€?)`\n\n* Is the data on site under the legal control of AWS or the customer?  \n`ë°ì´í„°ì˜ ì†Œìœ ê¶Œ ë¬¸ì œ(ì´ê²Œ ì‹¬ê°í•œ ë¬¸ì œê°€ ë ìˆ˜ ìˆë‹¤)`\n\nê·¸ë˜ì„œ AWSê°€ ì‘ë…„ì— ë‚´ë†“ì€ Outpostì˜ ì²«ê·¸ë¦¼ì€ [VMware on AWS](https://aws.amazon.com/ko/outposts/features/)ë¡œ ì‘ë…„ reinventì´í›„ ë§ì€ ê´€ì‹¬ì„ ë°›ì•˜ë˜ í”„ë¡œì íŠ¸ì´ë‹¤. \n\nì´ì™¸ì—ë„ ë©”ì´ì € ì‚¬ë“¤ë„ [Azure Stack](https://azure.microsoft.com/ko-kr/overview/azure-stack/), [VMware on IBM Cloud](https://www.ibm.com/kr-ko/cloud/vmware), [VMware on Ncloud](https://www.ncloud.com/product/hybridPrivateCloud/vmwareOnNcloud)ì™€ ê°™ì€ í•˜ì´ë¸Œë¦¬ë“œ ì„œë¹„ìŠ¤ë¥¼ ë‚´ë†“ê³  ìˆë‹¤. \n\n### Productë³„ ê¸°ë³¸ ì „ëµ\n#### Azure Stack\n* í˜¸í™˜ì„± ì¸ì¦ë°›ì€ ì„œë²„ë¥¼ On-premì— êµ¬ë§¤/ì„¤ì¹˜í•˜ê³  Azure UI ë° APIì™€ ë™ì¼í•œ UI/UXë¡œ private cloud ì‚¬ìš©\n\n#### AWS Outpost\n* ê³ ê° On-premì— EC2 cloud instances ì œê³µ (ì „ìš© HPC í•˜ë“œì›¨ì–´ - EC2 Nitro Platform)\n\n#### AWS Outpost(VMware based)\n* baremetal ì „ìš© í”Œë«í¼ìœ¼ë¡œ VMware - software, AWS - hardware ì— ì§‘ì¤‘\n\n#### Google Cloud\n* K8s On-premì „ëµì„ ê¸°ë³¸ìœ¼ë¡œ Ciscoì™€ í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ (based on Istio)\n\n#### IBM Cloud\n* êµ¬ê¸€ê³¼ ìœ ì‚¬í•˜ê²Œ Istioë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ì—¬ ë©€í‹°, í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ ì œí’ˆ ì¶œì‹œ\n* IKS on Vmware on IBM Cloud Baremetal ì™€ ê°™ì€ ìƒí’ˆë„ ì¶œì‹œ\n\n\nëŒ€ë¶€ë¶„ VMware í˜‘ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ ì „ëµì„ ì „ê°œí•˜ê³  ìˆê³  ë‚´ë©´ì„ ë“¤ì—¬ë‹¤ë³´ë©´ ë¬¼ë¦¬ì ìœ¼ë¡œ ë‹¤ë¥¸ê³³ì— ìˆëŠ” Overlay ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•œ í•´ê²°ì´ ê°€ì¥ ë¬¸ì œì´ê¸° ë•Œë¬¸ì— Direct-linkë‚˜ VPNì„ í†µí•´ ì—°ê²°í•˜ëŠ”ê²ƒë„ ê²°êµ­ í´ë¼ìš°ë“œ ì‚¬ì—…ìê°€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ë¹„ìš©ì„ ê°€ì ¸ê°€ì§€ ìœ„í•œ ì „ëµìœ¼ë¡œì„œ ë³´ì¸ë‹¤. \n\nì‹¤ì œ í¼ë¸”ë¦­ í´ë¼ìš°ë“œ ë²¤ë”ì˜ Cash CowëŠ” Compute ìì›ë³´ë‹¤ëŠ” ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ê³¼ Blob Storage, APIê³¼ê¸ˆ ë“± ì— ëŒ€í•œ ë§¤ì¶œì´ í° ë¹„ì¤‘ì„ ì°¨ì§€í•œë‹¤ê³  ë´ì•¼ í•œë‹¤. í˜¹ìëŠ” ê¸€ë¡œë²Œ ë„¤íŠ¸ì›Œí¬ ì „ìš©ì„ ì— ëŒ€í•œ íˆ¬ìë‚˜ ê³ ì„±ëŠ¥ HPCë„ì… íˆ¬ì ë¹„ìš©ì— ëŒ€í•œ ë§ë“¤ì„ í•˜ì§€ë§Œ IBMê°™ì€ ê²½ìš° ê¸€ë¡œë²Œ ë„¤íŠ¸ì›Œí¬ ë¬´ë£Œ ì •ì±…ì„ í†µí•´ Market Shareë¥¼ íšë“í•˜ê³ ì í•˜ëŠ” ë¶€ë¶„ë“¤ì„ ë³´ë©´ ë„¤íŠ¸ì›Œí¬ê°€ ê°€ì¥ í•µì‹¬ì´ ì•„ë‹ê¹Œ ì‹¶ë‹¤.  \n\ní´ë¼ìš°ë“œë¥¼ ì´ì•¼ê¸° í• ë•Œ ê¸°ìˆ  ì„±ìˆ™ë„ë¥¼ ë³´ë©´ Compute > Storage > Network ìˆœìœ¼ë¡œ ì „ì´ê°€ ë˜ëŠ”ë° OpenStackì´ë‚˜ Kubernetes í”„ë¡œì íŠ¸ì™€ ê°™ì€ ì˜¤í”ˆì†ŒìŠ¤ë‚˜ VMware NSX í”Œë«í¼ë§Œ ë´ë„ ì •ë§ ë„¤íŠ¸ì›Œí¬ê°€ ì¤‘ìš”í•œ ì˜ì—­ì´ ë˜ê³  ìˆìŒì„ ì•Œìˆ˜ ìˆë‹¤. \n\nê²°êµ­ í•µì‹¬ì ìœ¼ë¡œ ë´ì•¼í•˜ëŠ” ë¶€ë¶„ì€ ë„¤íŠ¸ì›Œí¬ë‹¤. ë„¤íŠ¸ì›Œí¬ ë¶€ë¶„ì—ì„œ ì•„ì£¼ ê°•ë ¥í•œ ì†”ë£¨ì…˜ì´ ë‚˜ì™€ì•¼ í•œë‹¤. ê²°êµ­ íšŒì„  ë¹„ìš©ì´ ë¬¸ì œê³  ìµœê·¼ ë„·í”Œë¦­ìŠ¤ì™€ SKBì˜ ì†ë„ ë¶„ìŸë§Œ ë´ë„ ê²°êµ­ ê°•ìì˜ ë…¼ë¦¬ë¡œ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ í•´ê²°ë˜ëŠ” ì‹œëŒ€ê°€ ì˜¨ ê²ƒì´ë‹¤.\n\n### ì •ë¦¬\n\në‚´ê°€ ìƒê°í•œ ì„œë¹„ìŠ¤ ì‚¬ìš©ì ì¸¡ë©´ì—ì„œ ìš°ë¦¬ê°€ ê³ ë ¤í•´ì•¼í•  í´ë¼ìš°ë“œ ì˜µì…˜ë“¤ì„ ì •ë¦¬í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.\n\n* ë©€í‹° í´ë¼ìš°ë“œ : í¼ë¸”ë¦­ í´ë¼ìš°ë“œ to í¼ë¸”ë¦­ í´ë¼ìš°ë“œ ìš´ì˜ ì†”ë£¨ì…˜ìœ¼ë¡œ í”„ë¼ì´ë¹— í´ë¼ìš°ë“œ ì˜ì—­ì—ëŠ” ê±°ì˜ ê´€ì—¬ë¥¼ ì•ˆí•˜ë©°, ì†”ë£¨ì…˜ì— ë”°ë¼ ì¼ë¶€ ê°€ìƒí™”ëœ Computing ìì›ê¹Œì§€ ëª¨ë‹ˆí„°ë§ ì§€ì›í•˜ê¸°ë„ í•¨. ë©€í‹° í´ë¼ìš°ë“œ ìš´ì˜ í”Œë«í¼ì€ ì£¼ë¡œ í´ë¼ìš°ë“œ Brokerage Service í˜•íƒœë¡œ ì œê³µë˜ì–´ì•¼ í•˜ë¯€ë¡œ MSPì—­í• ì´ ì¤‘ìš”í•´ì§ˆ ê²ƒ ê°™ë‹¤. ë©”ê°€ì¡´, ë² ìŠ¤í•€ê¸€ë¡œë²Œê³¼ ê°™ì€ê³³ ë¿ì•„ë‹ˆë¼ ìì²´ì ì¸ í´ë¼ìš°ë“œë¥¼ ìš´ì˜í•˜ëŠ” ëŒ€í˜• SIíšŒì‚¬ë¥¼ í¬í•¨í•œ ê¸°ì¡´ IaaS ìš´ì˜ì¡°ì§ì˜ ë³€í™”ë“¤ë„ ëˆˆì—¬ê²¨ ë´ì•¼í• ê²ƒ ê°™ë‹¤. ë§ˆì§„ìœ¨ì´ ë‚®ì€ ë ˆë“œì˜¤ì…˜ ì‹¸ì›€ì—ì„œ ëˆ„ê°€ ì´ê¸°ëŠëƒê°€ ì¤‘ìš”í•˜ê¸° ë³´ë‹¤ëŠ” ë¯¸ë˜ë¥¼ ë³´ê³  íˆ¬ìí•˜ëŠ” ìì„¸ê°€ í•„ìš”í•˜ë‹¤ê³  ë³¸ë‹¤. \n\n* í”„ë¼ì´ë¹— í´ë¼ìš°ë“œ : í”„ë¼ì´ë¹— í´ë¼ìš°ë“œ ì „ìš© ì†”ë£¨ì…˜ìœ¼ë¡œ ë²¤ë” ë˜ëŠ” íŠ¹ì • IaaS ì„œë¹„ìŠ¤ì— ìµœì í™”ëœ ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ VMware, OpenShift, OpenStack Managed ì„œë¹„ìŠ¤ë“± ê¸°ì¡´ ì œí’ˆì—ì„œì˜ ì—°ì¥ì„ ì—ì„œ ì–¼ë§ˆë‚˜ ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ì´í•´í•˜ê³  í”„ë¡œë•ì…˜ì— ì ìš©í• ìˆ˜ ìˆëŠ” ì—­ëŸ‰ì„ ê¸°ë¥´ëŠ”ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. \n\n* í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ : í¼ë¸”ë¦­ í´ë¼ìš°ë“œ to í”„ë¼ì´ë¹— í´ë¼ìš°ë“œ ìš´ì˜ ì†”ë£¨ì…˜ìœ¼ë¡œ í”„ë¼ì´ë¹— í´ë¼ìš°ë“œì˜ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ê¹Œì§€ ê´€ì—¬ë¥¼ í•˜ë©°, í¼ë¸”ë¦­ í´ë¼ìš°ë“œ ì˜ì—­ì€ ì¼ë°˜ì ìœ¼ë¡œ IaaS ì˜ì—­ê³¼ ì¼ë¶€ PaaS / ì»¨í…Œì´ë„ˆê¹Œì§€ êµ¬ì„±, ëª¨ë‹ˆí„°ë§ ì§€ì›í•´ì•¼ í•˜ê³  ì´ë¥¼ ìœ„í•œ 3rd Party ì†”ë£¨ì…˜ë“¤ì´ ë“±ì¥í•˜ê³  ìˆê³  ì ì°¨ ì˜ì—­ì„ í™•ëŒ€í• ê²ƒì´ë‹¤. ì´ì— ìˆì–´ ì»¨í…Œì´ë„ˆ í”Œë«í¼ì„ ë„ì…í•˜ëŠ”ê²ƒì´ ê°€ì¥ ê¸€ë¡œë²Œ í”Œë ˆì´ì–´ì™€ ê²©ì°¨ë¥¼ ì¤„ì´ëŠ”ë° íš¨ê³¼ì ì¸ ë„êµ¬ë¼ ìƒê°í•œë‹¤. ê²°êµ­ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ êµ¬í˜„ì€ ê¸°ì¡´ Publicê³¼ Local Cloudê°„ ë„¤íŠ¸ì›Œí¬ ì—°ê³„ê°€ ì¤‘ìš”í•œ í¬ì¸íŠ¸ì´ë‹¤.\n\n* ê°„ë‹¨íˆ êµ¬í˜„í•´ ë³¼ìˆ˜ ìˆëŠ” General Hybrid Kubernetes Architectureë¥¼ ê°„ë‹¨íˆ ê·¸ë ¤ë´¤ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ StrongSwan VPNì„ ê°€ì§€ê³  CI/CDë¥¼ ê³ ë ¤í•œ DevOpsê´€ì ì—ì„œì˜ êµ¬ì„±ë„ì´ë‹¤.\n![hybrid-cloud](/img/hybrid-cloud.png)\n\nìœ„ì— ë‚´ìš©ê³¼ í•¨ê»˜ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œë¥¼ ê³ ë ¤í• ë•Œ `ë°ì´í„° ì†Œìœ ê¶Œ ì¸¡ë©´ì—ì„œì˜ ê±°ë²„ë„ŒìŠ¤` ì™€ `overlay ë„¤íŠ¸ì›Œí¬`ì— ëŒ€í•œ ê³ ë¯¼ì´ ë™í–‰ë˜ì—ˆì„ë•Œ ì„±ê³µì ì¸ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œë¥¼ êµ¬ì¶•í• ìˆ˜ ìˆë‹¤ë¼ëŠ” ë‚˜ í˜¼ìë§Œì˜ ìƒê°ì„ ì •ë¦¬í•´ë´¤ë‹¤."
    },
    {
      "id": "job/SRE/",
      "metadata": {
        "permalink": "/job/SRE/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-01-30-SRE.md",
        "source": "@site/blog/2019-01-30-SRE.md",
        "title": "SRE (Site Reliablity Engineering)",
        "description": "SRE ì†Œê°œ",
        "date": "2019-01-30T00:00:00.000Z",
        "formattedDate": "January 30, 2019",
        "tags": [
          {
            "label": "SRE",
            "permalink": "/tags/sre"
          },
          {
            "label": "DevOps",
            "permalink": "/tags/dev-ops"
          }
        ],
        "readingTime": 12.76,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "SRE (Site Reliablity Engineering)",
          "comments": true,
          "classes": "wide",
          "description": "SRE ì†Œê°œ",
          "slug": "job/SRE/",
          "date": "2019-01-30T00:00:00.000Z",
          "categories": [
            "Job"
          ],
          "tags": [
            "SRE",
            "DevOps"
          ]
        },
        "prevItem": {
          "title": "Hybrid Cloud",
          "permalink": "/cloud/Hybrid/"
        },
        "nextItem": {
          "title": "2018 Retrospective",
          "permalink": "/retrospective/newyear-plan/"
        }
      },
      "content": "ê·¸ë™ì•ˆ DevOps ë‹´ë‹¹ìë¼ê³  ë¶€ë¥´ì§–ë˜ ì‚¬ëŒë“¤ì˜ Roleì´ ì¸í”„ë¼ ë‹´ë‹¹ìì¸ì§€ í”Œë«í¼ ë‹´ë‹¹ìì¸ì§€ ì•„ë‹ˆë©´ ê°œë°œí•˜ëŠ” ìš´ì˜ìì¸ì§€ í—·ê°ˆë¦´ë•Œê°€ ë§ì•˜ë‹¤.\n\nê°‘ìê¸° êµ­ë‚´ì—ì„œë„ SRE ì±„ìš© ê³µê³ ê°€ ë§ì•„ì§€ëŠ”ê²ƒì„ ë³´ë©´ì„œ ë‚´ ìì‹ ë„ í•œë²ˆ ì •ë¦¬ë¥¼ í•˜ê³  ê°€ì•¼í• ê²ƒ ê°™ì€ ìƒê°ì´ ë“¤ì—ˆë‹¤.\n\nhttps://docs.microsoft.com/ko-kr/learn/modules/intro-to-site-reliability-engineering/\n\nê°œë…ì •ë¦¬ ì¸¡ë©´ì—ì„œ ìœ„ MS Azureì˜ ì˜¨ë¼ì¸ êµìœ¡ë‚´ìš©ì„ ì •ë¦¬í•´ë´¤ë‹¤.\n\n## SRE\n\nSRE(ì‚¬ì´íŠ¸ ì•ˆì •ì„± ì—”ì§€ë‹ˆì–´ë§)ë€ ì¡°ì§ì´ í•´ë‹¹ ì‹œìŠ¤í…œ, ì„œë¹„ìŠ¤ ë° ì œí’ˆì—ì„œ ì ì ˆí•œ ìˆ˜ì¤€ì˜ ì•ˆì •ì„±ì„ ë‹¬ì„±í•˜ë„ë¡ ì§€ì›í•˜ëŠ” ì—”ì§€ë‹ˆì–´ë§ ë¶„ì•¼ì´ë‹¤. \n\nì¶œì²˜ : https://landing.google.com/sre/sre-book/chapters/introduction/\n\nê¸°ë³¸ì ìœ¼ë¡œ ìš´ì˜ê²½í—˜ì´ ìˆëŠ” sysadmin, ITì „ë¬¸ê°€, DevOpsì‹¤í–‰ ë‹´ë‹¹ì ë“±ì´ ëŒ€ìƒì´ ë  ìˆ˜ ìˆë‹¤.\n\n\n### ì ì ˆí•œ ìˆ˜ì¤€ì˜ ì•ˆì •ì„±\nê°€ì¥ í•µì‹¬ì´ ë˜ëŠ” ë‹¨ì–´ëŠ” `ì•ˆì •ì„±`ì´ë‹¤. ì¡°ì§ì—ì„œ ë§Œë“  ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•ˆì •ì„±ì´ ë¶€ì¡±í•˜ì—¬ ì‘ë™í•˜ì§€ ì•Šê±°ë‚˜ ë¶ˆì•ˆì •í•œ ê²½ìš° ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ì— í”¼í•´ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤ëŠ”ê±´ ëˆ„êµ¬ë‚˜ ì•Œê³  ìˆëŠ” ë‹¹ì—°í•œ ì´ì•¼ê¸°ì´ì§€ë§Œ 100%ì˜ ì•ˆì •ì ì¸ ì‹œìŠ¤í…œì€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì ì ˆí•œ ìˆ˜ì¤€(ì •ëŸ‰ì ìœ¼ë¡œ ì¸¡ì •í•˜ê¸´ ì–´ë µì§€ë§Œ ì´í•´ê´€ê³„ìë“¤ì´ ë‚©ë“¤í• ë§Œí•œ ìˆ˜ì¤€)ì˜ ì•ˆì •ì„±ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•œ ì¼ë ¨ì˜ ì‘ì—…ë“¤ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ SREì˜ ê¸°ë³¸ ì†ì„±ì´ë¼ê³  ë³¼ìˆ˜ ìˆë‹¤. \n\nSREëŠ” Googleì—ì„œ 2003ë…„ë¶€í„° 7ëª…ì˜ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë¡œ êµ¬ì„±ëœ íŒ€ì—ì„œ ì‹œì‘ëœ ì´í›„ (ìì„¸í•œ ë‚´ìš©ì€ ìœ„ ë§í¬ ebook ì°¸ì¡°) Google ì‚¬ë‚´ì— ë„ë¦¬ í™•ì‚°ë˜ê³  ë‚´ë¶€ì ì¸ ë¬¸í™”ë¡œ ì¡°ì„±ë˜ëŠ” ì¤‘ì— ë°–ì—ì„œëŠ” DevOpsë¼ê³  í•˜ëŠ” ë¬¸í™”ê°€ ë™ì‹œì— í™•ì‚°ë˜ì—ˆë‹¤ í•œë‹¤. ê²°êµ­ ë™ì¼í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì¸¡ë©´ì—ì„œ ë‘ê°œì˜ ë°©ë²•ë¡ ì€ ë‹¤ë¥´ë‹¤ê³  ë´ì•¼í•œë‹¤. \n\n\n### ì°¨ì´ì \n* SRE - ì•ˆì •ì„±ì„ ìœ„í•œ ì—”ì§€ë‹ˆì–´ë§, DevOps - ê°œë°œê³¼ ìš´ì˜ì¡°ì§ ê°ê°ì˜ ì‚¬ì¼ë¡œë¥¼ í•´ì²´í•˜ê¸° ìœ„í•œ ë¬¸í™”ì ì¸ ì›€ì§ì„\n* SRE - ì €ëŠ” SRE ì…ë‹ˆë‹¤, DevOps - ì €ëŠ” DevOpsë¥¼ í•˜ëŠ” ìš´ì˜ì ë˜ëŠ” ê°œë°œì ì…ë‹ˆë‹¤.\n* SRE - ê·œë²”ìœ¼ë¡œ ì¸ì‹, DevOps - ë¬¸í™”ë¡œ ì¸ì‹\n  \n### ê³µí†µì \n* ëª¨ë‹ˆí„°ë§/ì‹ë³„ ê°€ëŠ¥, ìë™í™”\n\n\n## ì£¼ìš” SREì›ì¹™ : ì„ ìˆœí™˜\nìƒˆë¡œìš´ ì„œë¹„ìŠ¤ì˜ ìƒíƒœì˜ ì§€í‘œëŠ” ì–´ë–»ê²Œ ì •ì˜í• ê¹Œ? ë³´í†µì€ ë¬´ì—‡ì„ `SLI(ì„œë¹„ìŠ¤ ìˆ˜ì¤€ ì§€í‘œ)`ë¡œ ì‚¬ìš©í• ì§€ë¥¼ ì •í•˜ëŠ”ê²ƒìœ¼ë¡œ ë³¸ë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì„±ê³µ ë° ì‹¤íŒ¨ ì¸¡ì •ê°’(200 OK,500 Error), ì‘ë‹µì‹œê°„(ms), ì²˜ë¦¬ëŸ‰ ë“±ì˜ ì¡°í•©ìœ¼ë¡œ ê²°ì •ë  ìˆ˜ ìˆë‹¤. ë³´í†µ  ì¹´ë‚˜ë¦¬ì•„ ë¶„ì„ì„ í†µí•´ Scoringì„ í•œ `SLI`ë¥¼ 200 OKì™€ 500 ë˜ëŠ” ì—ëŸ¬ì½”ë“œì˜ ë¹„ìœ¨ë¡œ ê²°ì •í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.\n\nì„œë¹„ìŠ¤ ìƒíƒœë¥¼ ì‹ë³„í•˜ëŠ” ì§€í‘œë¥¼ ì •í•˜ê³  ë‚˜ë©´ ê³ ê°ì´ë‚˜ ìš°ë¦¬ê°€ ì›í•˜ëŠ” ì•ˆì •ì„± ìˆ˜ì¤€ì„ ê²°ì •í•´ì•¼ í•œë‹¤. ê°œë°œíŒ€ê³¼ ìš´ì˜íŒ€ì´ ê°™ì´ ë§Œë“  ì›í•˜ëŠ” ì•ˆì „ì„± ìˆ˜ì¤€ì„ `SLO(ì„œë¹„ìŠ¤ ìˆ˜ì¤€ ëª©í‘œ)`ë¼ê³  ë§í•˜ë©´ ëœë‹¤. \n\n`SLO`ëŠ” Prometheusë‚˜ Datadogê³¼ ê°™ì€ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ ì •í™•í•˜ê²Œ ì¸¡ì •í•˜ê³  í‘œì‹œí•´ì•¼ í•œë‹¤. ì„œë¹„ìŠ¤ì˜ ì•ˆì •ì„±ì— ëŒ€í•´ì„œ ëª…í™•í•˜ê²Œ ì´í•´í• ìˆ˜ ìˆëŠ” ëª©í‘œì´ê¸°ë„ í•˜ë‹¤. ë°˜ë“œì‹œ `SLO`ë¥¼ ë§Œì¡±í•˜ëŠ”ì§€ ëª»í•˜ëŠ”ì§€ ëª…í™•í•œ ì¸¡ì •ê°’ìœ¼ë¡œ ë°ì´í„°ê°€ ì¡´ì¬í•´ì•¼ í•˜ê³  `SLO`ë¥¼ ì¶©ì¡±í•˜ì§€ ëª»í•˜ë©´ ë¬¸ì œê°€ ìˆëŠ”ê²ƒìœ¼ë¡œ íŒë‹¨í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•œë‹¤. \n\n### ì˜¤ë¥˜ ì˜ˆì‚°\nì˜¤ë¥˜ ì˜ˆì‚°ì´ë¼ëŠ” ë§ì„ ëª…í™•íˆ ì´í•´í•˜ë ¤ë©´ í”íˆ ê³ ê°ê³¼ ì²´ê²°í•˜ëŠ” ê³„ì•½ì„œ ìƒì˜ ëª…ì‹œëœ ì„œë¹„ìŠ¤ ê°€ë™ìœ¨(SLA)ì„ ìƒê°í•˜ë©´ ë  ê²ƒ ê°™ë‹¤. ë³´í†µ 99.9% ì˜ `SLO`ë¥¼ ì •í•œë‹¤ê³  í•œë‹¤ë©´ 1ë…„ì— 8ì‹œê°„ 45ë¶„ 57ì´ˆì˜ ì„œë¹„ìŠ¤ ë‹¤ìš´íƒ€ì„ì„ í—ˆìš©í•˜ëŠ” ê²ƒì´ë‹¤. ì˜¤ë¥˜ ì˜ˆì‚°ì€ ì„œë¹„ìŠ¤ì˜ ì™„ë²½í•œ ì•ˆì •ì„±ê³¼ ì›í•˜ëŠ” ì•ˆì •ì„±ì˜ ì°¨ì´(100%-99.9%=0.01%)ë¥¼ ë§í•œë‹¤. 0.01%ë¡œ ì¦‰ 8ì‹œê°„ì •ë„ì˜ ì˜¤ë¥˜ ì˜ˆì‚°ì„ ê°€ì§€ëŠ” ê²ƒì€ ê·¸ ì‹œê°„ì„ ëª¨ë‘ ì‚¬ìš©í•  ë•Œê¹Œì§€ ì¶”ê°€ ë¦´ë¦¬ìŠ¤ë‚˜ íŒ¨ì¹˜ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤ëŠ” ì´ì•¼ê¸°ì™€ ê°™ë‹¤. ì–´ë–¤ íŒ€ì€ í•´ë‹¹ ì˜ˆì‚°ì„ ì‹ ê·œ ê¸°ëŠ¥ì„ ë¦´ë¦¬ìŠ¤í•˜ëŠ”ë° ì‚¬ìš©í•˜ê¸°ë„ í•˜ê³  ì¥ì• ê°€ ë°œìƒí–ˆì„ë•Œ ë¬¸ì œì˜ ì›ì¸ì„ ë°œê²¬í•˜ê³  ê°œì„ í•˜ëŠ”ë° ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤. \n\nì¼ë°˜ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì˜¤ë¥˜ ì˜ˆì‚°ì´ ëª¨ë‘ ì‚¬ìš©ë˜ë©´ ì„œë¹„ìŠ¤ê°€ ì›í•˜ëŠ” ì•ˆì •ì„± ìˆ˜ì¤€ìœ¼ë¡œ ëŒì•„ê°ˆë•Œ ê¹Œì§€ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ ì¶”ê°€ì ì¸ ë¦´ë¦¬ìŠ¤ë¥¼ ë³´ë¥˜í•˜ëŠ”ê²Œ ì¼ë°˜ì ì´ê¸´ í•˜ì§€ë§Œ íŠ¹ì •ê¸°ê°„(ì›” ë˜ëŠ” ë¶„ê¸° ë˜ëŠ” ì—°ê°„) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë˜ê¸° ë•Œë¬¸ì— ì„œë¹„ìŠ¤ ì•ˆì •ì„±ì´ ì •ìƒ ìƒíƒœë¼ë©´ ì˜¤ë¥˜ ì˜ˆì‚°ì€ ë‹¤ì‹œ ì£¼ì–´ì§€ê²Œ ë˜ë¯€ë¡œ `ì„ ìˆœí™˜` êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.\n\n### ë¹„ë‚œ ì—†ëŠ” ì¥ì•  íšŒê³ \nì¼ë°˜ì ìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ì— í¬ë¦¬í‹°ì»¬í•œ ì¥ì• ê°€ ë°œìƒí–ˆì„ë•Œ ì‚¬í›„ ë¶„ì„(íšŒê³ )ì„ í•˜ê²Œ ë˜ëŠ”ë° ì´ë•ŒëŠ” `ë¹„ë‚œ ì—†ëŠ”` ë¶„ì„ì„ í•´ì•¼í•œë‹¤. ì˜¤ë˜ì „ ê¸°ì–µì´ì§€ë§Œ ì˜ˆì „ ì§ì¥ íŠ¹ì •íŒ€ì—ì„œëŠ” ì¥ì• ê°€ ë°œìƒí•˜ë©´ ìœ ê´€ìë“¤ì´ ëª¨ë‘ ì—”ì§€ë‹ˆì–´ ì±…ìƒ ë’¤ì— ì„œì„œ ëª¨ë“  í™”ì‚´ê³¼ ëˆˆì´ì„ ì£¼ê¸° ë•Œë¬¸ì— ë„ì €íˆ ì¼ì„ í•  ìˆ˜ ì—†ê²Œ ë§Œë“  ê²½ìš°ê°€ ë§ì•˜ì—ˆë‹¤. \n\níŠ¹ì • ìš´ì˜ìì˜ ì‘ì—… ì‹¤ìˆ˜ë¡œ ì¸í•´ ì¥ì• ê°€ ë°œìƒí–ˆë‹¤ í•˜ë”ë¼ë„ í•´ë‹¹ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê²Œ ëœ í”„ë¡œì„¸ìŠ¤ë‚˜ ê¸°ìˆ ê¸°ë°˜ì— ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ëŠ”ë° ì¤‘ì ì„ ë‘ì–´ì•¼ í• ê²ƒì´ë‹¤.\n\nì‹œìŠ¤í…œì˜ ì•ˆì •ì„±ì„ ì €í•˜ì‹œí‚¤ê³  ì„œë¹„ìŠ¤ë¥¼ ì¤‘ë‹¨ì‹œí‚¨ ì‘ì—…(ë¦´ë¦¬ìŠ¤, íŒ¨ì¹˜ ë“±)ì„ ì‚¬ìœ ë¡œ ê°œì¸ì—ê²Œ í˜ë„í‹°ë¥¼ ì£¼ê±°ë‚˜ ê³ ê³¼ì— ë°˜ì˜í•˜ëŠ” ë°©ë²•ì€ ì¥ì• ë¡œ ë¶€í„° êµí›ˆì„ ì–»ì„ìˆ˜ê°€ ì—†ê³  í•´ë‹¹ ë‹´ë‹¹ìì˜ ì¶©ì„±ë„ë‚˜ ìƒì‚°ì„± ì €í•˜ë¥¼ ìœ ë°œí•˜ëŠ” ì•ˆì¢‹ì€ ì¥ì¹˜ê°€ ë  ìˆ˜ ìˆë‹¤. ë‚´ ê²½í—˜ì´ê¸°ë„ í•˜ì§€ë§Œ í•œë™ì•ˆ ë‘ë ¤ì›Œì„œ ì•„ë¬´ ë³€ê²½ë„ í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ì¢…ì¢… ìˆì—ˆë‹¤. \n\níšŒì‚¬ë‚˜ ì¡°ì§, íŒ€ì€ ì‹œìŠ¤í…œ ì¤‘ë‹¨ìœ¼ë¡œë¶€í„° êµí›ˆì„ ì–»ê³  ì§€ì†ì ìœ¼ë¡œ ì‹œìŠ¤í…œì„ ê°œì„ í• ìˆ˜ ìˆë‹¤. ì ì ˆí•œ ë¶„ì„ì„ í†µí•´ í›„ì†ì¡°ì¹˜ë¥¼ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ ì‹¤íŒ¨ë¥¼ ìˆ˜ìš©í•˜ëŠ” ê²ƒì´ SREì˜ í•µì‹¬ ì›ì¹™ì´ë‹¤. ì´ëŸ¬í•œ ë‚´ìš©ì„ ëª¨ë‘ì—ê²Œ ê³µìœ í•˜ê³  íƒ€ ì¡°ì§ì´ë‚˜ íŒ€ì—ê²Œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ì„ ìˆœí™˜ êµ¬ì¡°ë¥¼ ë§Œë“œëŠ”ê²ƒ ë˜í•œ SREì˜ ê¸°ë³¸ ì›ì¹™ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.\n\n## ì£¼ìš” SREì›ì¹™ : ì‚¬ëŒì¸¡ë©´\n### Toil(ìˆ˜ê³ ìŠ¤ëŸ° ì¼, ë²ˆê±°ë¡œìš´ ì‘ì—…)\ní•­ìƒ SREì—ì„œëŠ” Toilì— ì´ˆì ì„ ë§ì¶°ì•¼ í•œë‹¤. Toilì€ ì‚¬ëŒì´ ìˆ˜í–‰í•˜ëŠ” ìš´ì˜ ì‘ì—… ì¤‘ íŠ¹ì •í•œ íŒ¨í„´ì´ë‚˜ íŠ¹ì„±ì´ ìˆëŠ” ì‘ì—…ì„ ë§í•œë‹¤. ì¢…ì¢… ë°˜ë³µì ì´ê³  ìë™í™” ë  ìˆ˜ ìˆëŠ” ì‘ì—…ì¼ì§€ë¼ë„ ëŒ€ë¶€ë¶„ ìˆ˜ë™ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬ë¥¼ í•œë‹¤. ì„œë¹„ìŠ¤ì˜ ê·œëª¨ê°€ ì»¤ì§€ê±°ë‚˜ ê³ ê°ì´ ë§ì•„ì§€ê²Œ ë˜ë©´ ë³´í†µ ìš°ë¦¬ê°€ ì´ì•¼ê¸° í•˜ëŠ” í‹°ì¼“(ë˜ëŠ” SR)ì˜ ìˆ˜ê°€ ë§ì•„ì§€ê³  ê³µìˆ˜ê°€ ë§ì´ í•„ìš”í•˜ê²Œ ëœë‹¤. \n\në°°í¬ë•Œë§ˆë‹¤ Configë¥¼ ì ìš©í•˜ê±°ë‚˜ ê³„ì • ë“±ë¡, ë³¼ë¥¨ì´ë‚˜ ë””ìŠ¤í¬ í”„ë¡œë¹„ì €ë‹ ë“± ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼í•˜ëŠ” ëª¨ë“  ì‘ì—…ì´ ìš´ì˜ìì—ê²ŒëŠ” ë¶€í•˜ë¡œ ë‹¤ê°€ì˜¬ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ë°˜ë³µì ì¸ ì‘ì—…ì„ í‹°ì¼“ì‹œìŠ¤í…œì„ í†µí•´ ì²˜ë¦¬ë¥¼ í•˜ê²Œ ë˜ë©´ í‹°ì¼“ ìƒì„±, ì‘ì—…ê³„íšì„œ ì‘ì„±, ê²€í† , ìŠ¹ì¸ ë‹¨ê³„ë¥¼ ê·¸ë•Œ ë§ˆë‹¤ í•´ì•¼í•˜ëŠ” ì•„ì£¼ ë²ˆê±°ë¡œìš´ ì‘ì—…(Toil)ì„ í•´ì•¼í•œë‹¤.\n\nSREëŠ” ìµœëŒ€í•œ ì´ëŸ¬í•œ ë°˜ë³µì ì´ê³  ë²ˆê±°ë¡œìš´ ì‘ì—…ì„ ì œê±°í•˜ê¸° ìœ„í•´ ë…¸ë ¥í•´ì•¼í•˜ê³  ìë™í™”ì™€ Self-Serviceë¡œ ê°œë°œìê°€ í¸í•˜ê²Œ ì§ì ‘ ì‚¬ìš©í• ìˆ˜ ìˆë„ë¡ í™˜ê²½ì„ ì œê³µí•´ ì£¼ì–´ì•¼ í•œë‹¤. ì´ëŸ¬í•œ ìš”ì²­ì´ë‚˜ í‹°ì¼“ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©´ ì¡°ê¸ˆ ë” ìƒì‚°ì ì¸ ì¼ì„ ìˆ˜í–‰í• ìˆ˜ ìˆë‹¤. \n\nìœ„ì—ì„œ ì´ì•¼ê¸°í•œ ì ì ˆí•œ ì•ˆì •ì„±ê³¼ ë¹„ìŠ·í•œ ë§¥ë½ìœ¼ë¡œ ìƒê°í•˜ë©´ ë  ê²ƒ ê°™ë‹¤. ë²ˆê±°ë¡œìš´ ì‘ì—…ì„ ì—†ì• ëŠ”ê²ƒì´ ë‹¤ë¥¸ ì¤‘ìš”í•œ ì‘ì—…ë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë–¨ì–´ì§€ê¸°ë„ í•˜ì§€ë§Œ ì„œë¹„ìŠ¤ ìƒì—ì„œ Toilì„ ì œê±°í•˜ëŠ”ê²ƒë„ SREì˜ ì£¼ëœ ì—…ë¬´ì´ë‹¤.\n\n## ìš´ì˜ì‘ì—…ì˜ ë¹„ìœ¨\nToilì„ ì œê±°í•˜ê±°ë‚˜ ì„œë¹„ìŠ¤/ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ê°œì„ í•˜ê¸° ìœ„í•´ SREëŠ” ì¥ì• ë¥¼ í•´ê²°í•˜ê³  í‹°ì¼“ì„ ì²˜ë¦¬í•˜ëŠ” ì‹œê°„ ë¹„ì¤‘ì„ 50%ë¥¼ ë„˜ê²¨ì„œëŠ” ì•ˆëœë‹¤. í‹°ì¼“ì´ í•„ìš”í•˜ì§€ ì•Šë„ë¡ ê°œë°œì Self-Serviceë¥¼ êµ¬ì„±/ì œê³µí•˜ê³  íš¨ìœ¨ì„±ì„ ì¦ëŒ€ì‹œí‚¤ê¸° ìœ„í•´ì„œ IaCë“±(Shell, Ansible, Terraform)ê³¼ ê°™ì´ ìë™í™”ë¥¼ ìœ„í•œ ì½”ë“œë¥¼ ë§Œë“œëŠ”ë°ì—ë„ ì§‘ì¤‘ì„ í•´ì•¼í•œë‹¤.\n\n## ì •ë¦¬\nì§€ê¸ˆê¹Œì§€ SREì— ëŒ€í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì†Œê°œí•˜ê³  ì´í•´í•˜ëŠ” ì¸¡ë©´ì—ì„œ ì •ë¦¬í•´ ë´¤ë‹¤. \n\n[Service Reliability Hierarchy](https://landing.google.com/sre/sre-book/chapters/part3/)\n\n\n![hierarchy](https://lh3.googleusercontent.com/3gX2qgys2I-9HnEIvXUA10ed3AILvg5MclnKWBquEkJKP3g5_kD6WR7Ptwp3TwAGla1DuSmHv64MdTtACNLlArFVq7BwbTrTVhigsA=s0)\n\nê·¸ë¦¼ê³¼ ê°™ì´ ì„œë¹„ìŠ¤ ì•ˆì •ì„± ê³„ì¸µ êµ¬ì¡°ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§ í•˜ëŠ” ì‹œìŠ¤í…œì„ ê°–ì¶”ì–´ì•¼ í•œë‹¤ê³  ë§í•œë‹¤. ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ì¤€ë¹„ê°€ ë˜ë©´ ì„œë¹„ìŠ¤ì— ëŒ€í•œ SLI, SLOë¥¼ ë§Œë“¤ê³  ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì—ì„œ êµ¬í˜„í•˜ëŠ”ê²ƒì´ ì²«ë²ˆì§¸ SREë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì´ë¼ê³  í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.\n\n## ì°¸ê³  ì„œì \n* [Site Reliability Engineering: How Google Runs Production Systems(â€œThe SRE Bookâ€)](http://shop.oreilly.com/product/0636920041528.do)\n* [The Site Reliability Workbook: Practical Ways to Implement SRE(â€œThe SRE Workbookâ€)](http://landing.google.com/sre/workbook/toc/)\n* [Seeking SRE: Conversations About Running Production Systems at Scale](http://shop.oreilly.com/product/0636920063964.do)"
    },
    {
      "id": "retrospective/newyear-plan/",
      "metadata": {
        "permalink": "/retrospective/newyear-plan/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2019-01-03-newyear-plan.md",
        "source": "@site/blog/2019-01-03-newyear-plan.md",
        "title": "2018 Retrospective",
        "description": "18ë…„ë„ë¥¼ ëŒì•„ë³´ë©°...",
        "date": "2019-01-03T00:00:00.000Z",
        "formattedDate": "January 3, 2019",
        "tags": [
          {
            "label": "Retrospective",
            "permalink": "/tags/retrospective"
          },
          {
            "label": "2018",
            "permalink": "/tags/2018"
          },
          {
            "label": "Planning",
            "permalink": "/tags/planning"
          },
          {
            "label": "Change",
            "permalink": "/tags/change"
          }
        ],
        "readingTime": 5.32,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "2018 Retrospective",
          "comments": true,
          "classes": "wide",
          "description": "18ë…„ë„ë¥¼ ëŒì•„ë³´ë©°...",
          "slug": "retrospective/newyear-plan/",
          "date": "2019-01-03T00:00:00.000Z",
          "categories": [
            "Retrospective"
          ],
          "tags": [
            "Retrospective",
            "2018",
            "Planning",
            "Change"
          ]
        },
        "prevItem": {
          "title": "SRE (Site Reliablity Engineering)",
          "permalink": "/job/SRE/"
        },
        "nextItem": {
          "title": "Cloud Enginner",
          "permalink": "/cloud/cloud/"
        }
      },
      "content": "í•œí•´ê°€ ë˜ í›… ê°€ë²„ë ¸ë‹¤. 18ë…„ë„ Retrospective ì‹œì‘í•œë‹¤.\n\n* Work\n  * 17ë…„ê¹Œì§€ íŒ€ ë§‰ë‚´ì˜€ì§€ë§Œ ìƒˆë¡œìš´ ë¶€ì„œë¡œ ì´ë™í•˜ì—¬ ì„œë¹„ìŠ¤ê°œë°œ íŒŒíŠ¸ì¥ì„ ë§ê²Œ ë˜ì—ˆìŒ. 17ë…„ë„ì— ê°œë°œì´ë¼ê³ ëŠ” pythonë¥¼ ì‚¬ìš©í•˜ì—¬ vmware vmì„ openstack instanceë¡œ migrationí•˜ëŠ” í”„ë¡œì íŠ¸ ë° kubernetes ê¸°ë°˜ tensorflow í”Œë«í¼ì„ ê°œë°œí•˜ëŠ” ì´ˆë³´ê°œë°œì ìˆ˜ì¤€ì´ì˜€ë˜ ë‚´ê°€ ì¸í”„ë¼ì™€ í´ë¼ìš°ë“œ í”Œë«í¼(openstack, vsphere, kubernetes) ê²½ë ¥ì´ ì¸ì •ë˜ì–´ ì„œë¹„ìŠ¤ ê°œë°œ íŒŒíŠ¸ë¥¼ ë§¡ê²Œ ë˜ì—ˆë‹¤. ì¸ìƒì—ì„œ ê°€ì¥ í° ë³€í˜ì¤‘ í•˜ë‚˜ì˜€ë‹¤ê³  ìƒê°í•˜ê³  í•­ìƒ ê°ì‚¬í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ì¼ì„ í•˜ê³  ìˆë‹¤.  \n    \n  * CNCF OpenSourceë“¤ì„ í™œìš©í•˜ì—¬ FaaS(Function as a Service), IaC(Infra as Code) í”Œë«í¼ ê°œë°œì„ ì§„í–‰í•˜ì˜€ë‹¤. ì„œë¹„ìŠ¤ ê¸°íš ë° ë‘ê°œ í”„ë¡œì íŠ¸ì˜ Scrum Master ì—­í• ì„ ìˆ˜í–‰í•˜ì˜€ê³  ë©”ì¸ ì—…ë¬´ëŠ” SREì—­í• ë¡œ Kubernetes ì„¤ê³„ êµ¬ì¶•, í´ëŸ¬ìŠ¤í„° ë° ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬, LB, ì¸ì¦ì„œ ë“± í´ë¼ìš°ë“œ ì¸í”„ë¼ ìì›ê´€ë¦¬ ì •ë„ì˜€ë˜ê²ƒ ê°™ë‹¤. \n\n* Tech.\n  * Public Cloud : AWS, DigitalOcean, IBM Cloud, GCP, Azure, nCloud\n  * Provisioning : Harbor, Ansible, Portus, Clair, Kubicorn, Terraform, Vault\n  * Runtime : Rook, Minio, OpenEBS, Calico, REX-ray, WeaveNet, Cilium\n  * Orchestration : Kubernetes, Envoy, etcd, gRPC, Kong, HAProxy, Istio, Kong, NGINX, Traefik\n  * App : NATS, Helm, Kafka, Docker-compose, Draft, Gitlab, minikube, Operator, Jenkins, JenkisX, Packer, RabbitMQ, Spinnaker\n  * Serverless : Dispatch, Fission, Knative, Nuclio, OpenWhisk, OpenFaas\n  * Monitoring, Logging : Prometheus, Fluentd, Elastic, Grafana, influx, WeaveScope\n  * ê¸°íƒ€ : Cert-Manager, Dex, Agones\n\n* Speak\n  ì“°ë‹¤ë³´ë‹ˆ ì‚¬ë‚´ì™¸ ë°œí‘œë¥¼ 10ë²ˆì„ ë„˜ê²Œ í•œê±° ê°™ë‹¤.\n  * 4ì›” ì‚¬ë‚´ Cloud Tech : ì»¨í…Œì´ë„ˆ ê¸°ë°˜ SaaS ê°œë°œì„ ìœ„í•œ ê³ ë ¤ì‚¬í•­\n  * 5ì›” ì‚¬ë‚´ DT ì†”ë£¨ì…˜ í–‰ì‚¬, í´ë¼ìš°ë“œì‚¬ì—…ë¶€ ì„¸ì…˜ : Advanced Cloud (Road to Serverless)\n  * 5ì›” ì‚¬ë‚´ í†µì‹ ì‚¬ì—…ë¶€ë¬¸ Techì„¸ì…˜ : Road to Serverless (Functions as Applications)\n  * 6ì›” Open Infra Days Korea 2018 : [Provisioning Dedicated Game Server on Kubernetes Cluster](https://www.slideshare.net/JinwoongKim8/provisioning-dedicated-game-server-on-kubernetes-cluster)\n  * 8ì›” SK DNA 2018 : [Cloud Z ì˜ ì˜¤í”ˆì†ŒìŠ¤ ì„œë¹„ìŠ¤ ì†Œê°œ ë° Serverlessë¡œ ê²Œì„ ê°œë°œí•˜ê¸°](https://www.slideshare.net/JinwoongKim8/cloud-z-serverless-118143924)\n  * 10ì›” DT Labs Meetup : [Continuous Delivery with Spinnaker on K8s(kubernetes) Cluster](https://www.slideshare.net/JinwoongKim8/continuous-delivery-with-spinnaker-on-k8skubernetes-cluster-118140930)\n  * 10ì›” NCsoft IO : [Cloud Native ì˜¤í”ˆì†ŒìŠ¤ ì„œë¹„ìŠ¤ ì†Œê°œ ë° Serverlessë¡œ ì‹¤ì œ ê²Œì„ ê°œë°œí•˜ê¸°](https://www.slideshare.net/JinwoongKim8/cloud-native-serverless/JinwoongKim8/cloud-native-serverless)\n  * 11ì›” IBM Developer Day : [Continuous Delivery using Spinnaker on Kubernetes Multi Cluster](http://public.dhe.ibm.com/software/kr/TrackB/B3.pdf)\n  * 11ì›” \"Kubernetes Meetup\" 1Day : [Spinnaker on Kubernetes](https://www.slideshare.net/JinwoongKim8/spinnaker-on-kubernetes-123752186)\n\n\nì“°ê³ ë‚˜ì„œ ë³´ë‹ˆ 2018ë…„ë„ íšŒê³ ë¼ê¸° ë³´ë‹¤ ê±°ì˜ ê°œë°œì— í•„ìš”í•œ ì¡ì¼(DevOpsë¼ê³  ë‘ë‘”í•˜ë©´ì„œ)ê³¼ ë°œí‘œë§Œ í•œê±° ê°™ë„¤...\n19ë…„ë„ ë¶€í„°ëŠ” ë‹¤ë¥¸ì—…ë¬´ë¥¼ í•˜ê²Œ ë ê±° ê°™ì€ë° ì´ˆì‹¬ì„ ìƒì§€ ë§ì•„ì•¼ í•˜ê² ë‹¤.\n\nìµœê·¼ í™”ë‘ê°€ ë˜ì—ˆë˜ `ë…¸ë ¥ì¤‘ë…` ì´ì˜€ë˜ê²ƒ ê°™ì€ 18ë…„ì€ í„¸ì–´ë²„ë¦¬ê³ \në‚´ê°€ ì§„ì§œë¡œ ì¢‹ì•„í•˜ê³  í•˜ê³  ì‹¶ì€ ê³µë¶€ì™€ ì—…ë¬´, ê·¸ë¦¬ê³  ê°€ì¡±ì„ ìœ„í•´ì„œ ë¡œë“œë°¸ëŸ°ì‹± í•˜ë©´ì„œ ì§€ë‚´ì•¼ í•˜ê² ë‹¤. \n\n2006ë…„ì— ì“´ ë¯¸ë˜ì˜ ë‚´ ëª¨ìŠµê³¼ ì–´ëŠì •ë„ ì¼ì¹˜í•˜ëŠ”ê±° ê°™ì§€ë§Œ ëª©í‘œë¥¼ ì¢€ë” ë†’ì´ ì¡ì•„ì•¼í• ë“¯ í•˜ë‹¤.\n\në²ˆì—­ì— ì°¸ì—¬í•˜ê±°ë‚˜ ì±…ì„ ì¨ë³¸ë‹¤ë˜ì§€ ì»¤ë®¤ë‹ˆí‹° í™œë™ì„ ì¢€ë” ì ê·¹ì ìœ¼ë¡œ í•´ë³´ê³ \níšŒì‚¬ì—ì„œ ì‹œí‚¤ëŠ” ë°‹ì—…ì´ ì•„ë‹Œ ìë°œì ìœ¼ë¡œ ì°¸ì—¬í•˜ëŠ” ì™¸ë¶€ ê°•ì—°ì´ë‚˜ ë°‹ì—…ì„ ìœ„ì£¼ë¡œ í•´ë´ì•¼ê² ë‹¤. \n\në˜í•œ ì ì  ê°œë°œì˜ì—­ê³¼ ë©€ì–´ì§€ëŠ”ê±° ê°™ì€ ë‚´ëª¨ìŠµì´ ë‚˜ì´ê°€ ë“¤ë©´ì„œ ë” ì‹¬í™”ë ê±° ê°™ì•„ì„œ ì§€ì¸ë“¤ê³¼ ë³„ë„ì˜ ê°œë°œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•´ë³´ë ¤ê³  í•œë‹¤.\n\në‚´ 13ë…„ê°„ ì§ì¥ ìƒí™œì¤‘ ê°€ì¥ ë°”ì˜ê³  ë‹¤ì´ë‚´ë¯¹í•˜ë©´ì„œ ë°”ë¹´ë˜ í•œí•´ì´ì ë§ì€ ê²½í—˜ê³¼ ê³µë¶€ê°€ ë˜ì—ˆë˜ ì¼ë…„ì´ì˜€ë˜ê²ƒ ê°™ë‹¤.\n\në‚˜ë¥¼ ë•¡ê²¨ì£¼ì…¨ë˜ `June`, í•­ìƒ ë¶„ìœ„ê¸°ë¥¼ ë¦¬ë“œí–ˆë˜ `Joonbum`, ì–¸ì œë‚˜ ì—´ì •ê°€ë“í•˜ê³  ìµœê³ ì˜ DevOps í”Œë ˆì´ì–´ `Jeongho`, ë“ ë“ í•œ Backender `Donghun`, Excellent/Free/Kind(a.k.a EFK)í•œ `Minyoung`, ë‚´ê°€ ì¸ì •í•˜ëŠ” Frontier `Sanghun`, Best Rookie `Minsoo`, sorry because the hy `HyunSang`, Moontoring `Jinsoo`, Forever Mentor `Jaemoon`, Guru of CNI `Youngchae` ëª¨ë‘ì—ê²Œ ê°ì‚¬ì˜ ë§ì”€ì„ ì „í•˜ê³  ì‹¶ë‹¤. (ë¬´ìŠ¨ ìˆ˜ìƒì†Œê°ë„ ì•„ë‹ˆê³  ã…‹ã…‹)\n\n19ë…„ì—ë„ ë‚¨ë“¤ì—ê²Œ ì¡´ê²½ì„ ë°›ëŠ” ì‚¬ëŒë³´ë‹¤ëŠ” ë¬´ìŠ¨ì¼ì„ í•˜ë“ ì§€ ëŒ€ì¤‘ì—ê²Œ ìš•ë¨¹ì§€ ì•Šê³  í•„ìš”í• ë•Œ ë„ì›€ì„ ìš”ì²­ì„ í• ìˆ˜ ìˆëŠ” ê·¸ëŸ° í¸í•œ ì‚¬ëŒì´ ë˜ì–´ì•¼ ê² ë‹¤."
    },
    {
      "id": "cloud/cloud/",
      "metadata": {
        "permalink": "/cloud/cloud/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-12-25-cloud.md",
        "source": "@site/blog/2018-12-25-cloud.md",
        "title": "Cloud Enginner",
        "description": "Cloud Enginner",
        "date": "2018-12-25T00:00:00.000Z",
        "formattedDate": "December 25, 2018",
        "tags": [
          {
            "label": "Cloud",
            "permalink": "/tags/cloud"
          },
          {
            "label": "Enginner",
            "permalink": "/tags/enginner"
          }
        ],
        "readingTime": 4.055,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Cloud Enginner",
          "comments": true,
          "classes": "wide",
          "description": "Cloud Enginner",
          "slug": "cloud/cloud/",
          "date": "2018-12-25T00:00:00.000Z",
          "categories": [
            "Cloud"
          ],
          "tags": [
            "Cloud",
            "Enginner"
          ]
        },
        "prevItem": {
          "title": "2018 Retrospective",
          "permalink": "/retrospective/newyear-plan/"
        },
        "nextItem": {
          "title": "Spinnaker on Kubernetes #3 (Kayenta)",
          "permalink": "/kubernetes/spinnaker-advanced-3/"
        }
      },
      "content": "ì˜¤ëŠ˜ì€ ì“¸ë°ì—†ëŠ” ì´ì•¼ê¸°ë¥¼ ì£¼ì €ë¦¬ ì ì–´ë³¸ë‹¤. \n\ní˜ì¹œí•œë¶„ì´ ë§ì”€í•˜ì‹  êµ¬ì ˆì´ ë– ì˜¤ë¥¸ë‹¤.\n`\"ì—”ì§€ë‹ˆì–´ë¼ê³  í•´ì„œ ì •ì¹˜ë ¥ì´ í•„ìš”ì—†ëŠ”ê²ƒì´ ì•„ë‹ˆë‹¤. ì˜¤íˆë ¤ í˜ì‹ ì ì¸ ê¸°ìˆ ì€ ì •ì¹˜ë ¥, ê¶Œë ¥ì´ ì—†ìœ¼ë©´ ì ìš©ë  ìˆ˜ ì—†ë‹¤\"` - ì œí”„ë¦¬ í˜í¼êµìˆ˜ì˜ \"ê¶Œë ¥ì˜ ê¸°ìˆ \"\n\në‚˜ì´ 40ì„ ë„˜ê¸´ ì—”ì§€ë‹ˆì–´ë¡œì„œ ë‚˜ëŠ” ì–´ë–¤ ìœ„ì¹˜ì¸ê°€?\n\nCloud ê´€ë ¨ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ë¥¼ ì§„í–‰í•˜ë©´ì„œ í˜„ ì§ì¥ì—ì„œ 2ë…„ì„ ë³´ëƒˆë‹¤.\në³´ëŒë„ ìˆì—ˆê³  ì‹¤íŒ¨ë„ ìˆì—ˆë‹¤.  \nì˜¬í•´ëŠ” ê¸°íší•œ ì˜¤í”ˆì†ŒìŠ¤ ê¸°ë°˜ í”„ë¡œì íŠ¸ë¡œ ì—¬ëŸ¬ì‚¬ëŒì˜ í˜ì„ í•©ì³ì„œ ì„œë¹„ìŠ¤ë¥¼ ëŸ°ì¹­í•˜ê¸°ë„ í•˜ì˜€ì§€ë§Œ ëª‡ë…„ê°„ ê¸€ë¡œë²Œ í”Œë ˆì´ì–´ë“¤ì„ ë³´ë©´ì„œ ëŠë‚€ì ì€  \n\níšŒì‚¬ê°€ ê¸€ë¡œë²Œ í”Œë ˆì´ì–´ê°€ ë˜ê¸°ìœ„í•´ ë…¸ë ¥í•˜ëŠ” ë°©ë²•ì€ ë‹¤ì–‘í•˜ì§€ë§Œ  \nê²°êµ­ ì´ìœ¤ì„ ëª©ì ìœ¼ë¡œ íšŒì‚¬ì—ì„œ í—ˆìš©í•˜ê³  íˆ¬ìí•˜ëŠ”ê²ƒì´ê³   \nê·¸ê±¸ë¡œ ëˆì„ ëª»ë²Œë©´ ë°”ë¡œ ì³ë‚¼ìˆ˜ ìˆë‹¤ëŠ” ê²½ì˜ì¸µì˜ ìƒê°ì€ ë³€í•¨ì´ ì—†ì„ê²ƒì´ë‹¤. \n\nì´ëŸ° ë§ˆìŒê°€ì§ì„ ë³€í™”ì‹œí‚¤ì§€ ì•ŠëŠ”ë‹¤ë©´ í›Œë¥­í•œ í”„ë¡œì íŠ¸ë¼ë„ ì„±ê³µì´ë“  ì‹¤íŒ¨ë“  ëê¹Œì§€ ê°€ëŠ”ê²ƒì€ ì–´ë µë‹¤ê³  ìƒê°í•œë‹¤. \n\nì²˜ìŒ í´ë¼ìš°ë“œ ê´€ë ¨ ì—…ë¬´ë¥¼ ì‹œì‘í• ë•Œë¥¼ ìƒê°í•´ë³¸ë‹¤.\n\n* 2010ë…„  \níŒ€ì¥: ë„ˆ í´ë¼ìš°ë“œ í• ë˜?  \në‚˜ : ë¬´ìŠ¨ì¼í•˜ëŠ”ë°ìš”?  \níŒ€ì¥: ê°€ìƒí™” í”„ë¡œì íŠ¸í•˜ëŠ”ë° ê°™ì´ í•œë²ˆ ë¹„ì¦ˆë‹ˆìŠ¤ ë§Œë“¤ì–´ë³´ì, ë„ˆê°€ í•˜ê³  ì‹¶ì€ëŒ€ë¡œ ê¸°íší•˜ê³  í•´ë´~  \në‚˜ : ë„¤^^ ì—´ì‹¬íˆ í•˜ê² ìŠµë‹ˆë‹¤.  \n\n* `ê°œì¸ ì„±ê³¼ ë° íŒ€ì˜ ëª©í‘œëŠ” ì–´ëŠì •ë„ ë‹¬ì„±í•˜ì˜€ìœ¼ë‚˜ ROI ë‹¬ì„±ì€ ì‰½ì§€ ì•Šì•˜ìŒ`\n\n* 2016ë…„  \níŒ€ì¥: ë„ˆ ì£¼ê°„ë³´ê³  ë˜‘ë°”ë¡œ ì•ˆí•´?, ì§€ë‚œë²ˆ ì¥ì• ë³´ê³ ëŠ” ì–´ë–»ê²Œ ëœê±°ì•¼?  \në‚˜: ã… ã…   \níŒ€ì¥: ìš°ë¦¬ íŒ€ ìˆ˜ì¹˜ê°€ ì´ê²Œ ë­ëƒ... ì¢€ ì˜ì¢€ í•´ë´  \në‚˜: ã… ã…   \n  \n* `ê²°êµ­ í‡´ì‚¬`\n  \n* 2017ë…„  \níŒ€ì¥: í•˜ê³  ì‹¶ì€ëŒ€ë¡œ í•´ë´\në‚˜: ì§„ì§œìš”? ëšë”±ëšë”±  \níšŒì‚¬: ìˆ˜ìµëª¨ë¸ì´ ë­ì§€?  \në‚˜: ...  \n\n* `ì¶œì‹œí•˜ê¸°ë„ ì „ì— ì„œë¹„ìŠ¤ ì¢…ë£Œ`\n\n* 2018ë…„  \níŒ€ì¥: í•˜ê³  ì‹¶ì€ê±° í•´ë´ìš”. ëŒ€ì‹  ëˆë²Œì–´ì™€ì•¼í•´  \në‚˜: ì§„ì§œìš”? ëšë”±ëšë”±  \níšŒì‚¬: í  ì¢€ ë¶€ì¡±í•˜ì§€ë§Œ ì•ìœ¼ë¡œ ì¢€ë” ì˜í•´ì£¼ì„¸ìš”. ë ˆí¼ëŸ°ìŠ¤ í™•ë³´ì— í˜ì¨ì£¼ì„¸ìš”.  \në‚˜: ì„œë¹„ìŠ¤ ê¸°íšìê°€ í•„ìš”í•©ë‹ˆë‹¤.  \níšŒì‚¬: ... ë³¸ì¸ì´ í•´ì•¼í•˜ëŠ”ê±° ì•„ë‹Œê°€ìš”?  \në‚˜: ...  \n  \n* `ê¸°íšì„ í•´ì•¼í•˜ë‚˜ ì•„ì§ ê¸°ìˆ ë ¥ë„ ë¶€ì¡±í•œë°...`  \n\në²Œì¨ ì§ì¥ìƒí™œ 13ë…„ì°¨ì— ë§ˆí”ì‚´ì´ ë„˜ì–´ê°€ê³  ìˆë‹¤. \n\nì—”ì§€ë‹ˆì–´ë¡œ ì‚´ì•„ì˜¨ë‚ ë³´ë‹¤ ì‚´ì•„ê°€ì•¼í• ë‚ ì´ ì ê²Œ ë‚¨ì•˜ê³  ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ë‹¤ëŠ” ìƒê°ì´ ë“œëŠ” ìš°ìš¸í•œ í•˜ë£¨ë‹¤. \n10ë…„ê°„ ê³µë¶€í•´ì™”ë˜ ê²ƒë“¤ë³´ë‹¤ 2ë…„ë™ì•ˆ ê³µë¶€í•œê²Œ ë” íŒŒê²©ì ì´ê³  ë‹¤ì–‘í•˜ê³  ë³µì¡í–ˆë‹¤.\n\nì—¬ëŸ¬ëª¨ë¡œ ì•„ì‰¬ìš´ í•œí•´ì˜€ë‹¤...\n\nì•ìœ¼ë¡œ ë‚´ê°€ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ê¸°ìˆ ë ¥ìœ¼ë¡œ ë©”ê¿€ê²ƒì´ëƒ? í˜‘ìƒê³¼ ì •ì¹˜ë ¥ìœ¼ë¡œ ë©”ê¿€ê²ƒì´ëƒ?\n\nì ì´ ì•ˆì˜¤ëŠ” 12ì›”ì´ë‹¤."
    },
    {
      "id": "kubernetes/spinnaker-advanced-3/",
      "metadata": {
        "permalink": "/kubernetes/spinnaker-advanced-3/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-12-04-spinnaker-advanced-3.md",
        "source": "@site/blog/2018-12-04-spinnaker-advanced-3.md",
        "title": "Spinnaker on Kubernetes #3 (Kayenta)",
        "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #3 (Kayenta)",
        "date": "2018-12-04T00:00:00.000Z",
        "formattedDate": "December 4, 2018",
        "tags": [
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Spinnaker",
            "permalink": "/tags/spinnaker"
          },
          {
            "label": "Continuous Delivery",
            "permalink": "/tags/continuous-delivery"
          },
          {
            "label": "Continuous Deployment",
            "permalink": "/tags/continuous-deployment"
          },
          {
            "label": "Pipeline",
            "permalink": "/tags/pipeline"
          },
          {
            "label": "Canary",
            "permalink": "/tags/canary"
          },
          {
            "label": "Canary analysis",
            "permalink": "/tags/canary-analysis"
          },
          {
            "label": "Kayenta",
            "permalink": "/tags/kayenta"
          },
          {
            "label": "Automated Canary Service",
            "permalink": "/tags/automated-canary-service"
          }
        ],
        "readingTime": 14.66,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Spinnaker on Kubernetes #3 (Kayenta)",
          "comments": true,
          "classes": "wide",
          "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #3 (Kayenta)",
          "slug": "kubernetes/spinnaker-advanced-3/",
          "date": "2018-12-04T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "CI/CD",
            "Kubernetes",
            "Spinnaker",
            "Continuous Delivery",
            "Continuous Deployment",
            "Pipeline",
            "Canary",
            "Canary analysis",
            "Kayenta",
            "Automated Canary Service"
          ]
        },
        "prevItem": {
          "title": "Cloud Enginner",
          "permalink": "/cloud/cloud/"
        },
        "nextItem": {
          "title": "Spinnaker on Kubernetes #2",
          "permalink": "/kubernetes/spinnaker-advanced-2/"
        }
      },
      "content": "3ë²ˆì§¸ í¬ìŠ¤íŒ…ì´ë‹¤.\n\n11/23 \"Kubernetes Meetup\" 1Dayì—ì„œ ë°œí‘œí•œ ì´ì•¼ê¸° ì—°ì¥ì„ ìœ¼ë¡œ ì‘ì„±í•œë‹¤.\n\nê³ ê°ì—ê²Œ ì˜¤í¼ë§ì„ ìœ„í•´ ì¤€ë¹„í•œ ë‚´ìš©ê³¼ Kubernetes monitoringê³¼ ì—°ê³„í•œ ë‚´ìš©ì— ëŒ€í•´ì„œ ì ì–´ë³´ë ¤ê³  í•œë‹¤.\nìµœê·¼ ë°œí‘œë¥¼ ë‹¤ë‹ˆë©´ì„œ ë§ì´ ë°›ëŠ” ì§ˆë¬¸ì´ ì‹¤ì œ ì‚¬ìš©í• ë§Œ í•œê°€?ë¼ëŠ” ì§ˆë¬¸ê³¼ ì–´ë–»ê²Œ í™œìš©í•´ì•¼ í•˜ëŠ”ì§€ì— ëŒ€í•œ ì§ˆë¬¸ë“¤ì„ ë§ì´ ë°›ëŠ”ë‹¤.\nì˜¤ëŠ˜ ìµœê·¼ Spinnaker Summit 2018ì—ì„œ ì¤‘ìš”í•˜ê²Œ ë‹¤ë¤˜ë˜ Kayenta í”„ë¡œì íŠ¸ë¥¼ ê°€ì§€ê³  ì´ì•¼ê¸° í•´ë³´ë ¤ê³  í•œë‹¤. \n\n## Kayenta\n\nKayentaëŠ” ìë™ Canary ë¶„ì„ ì˜¤í”ˆì†ŒìŠ¤(Automated Canary Service(ACA))ë¡œ Spinnakerì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì¤‘ í•˜ë‚˜ë¡œ ë™ì‘í•œë‹¤.  \nAutomated Canary Deploymentsì— ì‚¬ìš©ë˜ê³  ìì„¸í•œ ë‚´ìš©ì€ [canary documentation](https://www.spinnaker.io/guides/user/canary/stage/)ì„ í™•ì¸í•˜ë©´ ëœë‹¤.  \n\n\nìƒˆ ì¢…ë¥˜ì˜ í•˜ë‚˜ì¸ CanaryëŠ” 1ì°¨ ì„¸ê³„ëŒ€ì „ì¤‘ì— ì¸ê°„ì´ í•´ë¥¼ ì…ê¸° ì „ì— ë…ì„±ê°€ìŠ¤ë¥¼ íƒì§€í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë˜ì—ˆë‹¤ê³  í•œë‹¤.\nDevOpsì—ì„œëŠ” CD(Continuous Deployment) í”„ë¡œì„¸ìŠ¤ì˜ ì¼ë¶€ë¡œ ì‚¬ìš©ë˜ë©° Canary ë¦´ë¦¬ì¦ˆëŠ” ìƒˆë¡œìš´ ë²„ì „ì˜ Softwareë¥¼ Productionì— ë°°í¬í•˜ëŠ” ìœ„í—˜ì„ ì¤„ì—¬ì£¼ëŠ” ê¸°ìˆ ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.\n\nCanary ì‹ ê·œ ë²„ì „ì˜ Softwareë¥¼ ì•ˆì •ì ì¸ ê¸°ì¡´ ë²„ì „ê³¼ í•¨ê»˜ ë°°í¬í•˜ê³  íŠ¹ì •ì‚¬ìš©ìë‚˜ ì¼ë¶€ ëŒ€ìƒì—ê²Œ íŠ¸ë˜í”½ ì¼ë¶€ë¥¼ í˜ë ¤ ê¸°ì¡´ ì‚¬ìš©ìì—ê²Œ ì˜í–¥ì„ ìµœì†Œí•˜í•˜ê³  ìƒˆë¡œìš´ ë²„ì „ì˜ ë¬¸ì œë¥¼ ì‹ ì†í•˜ê²Œ ë°œê²¬í•˜ê³  ì´ì „ì˜ ì•ˆì •ëœ ë²„ì „ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë‹¤ì‹œ ë¼ìš°íŒ…ì‹œí‚¤ëŠ”ê²ƒì´ ì£¼ìš” ê¸°ëŠ¥ì´ë¼ê³  ë³´ë©´ ëœë‹¤.  \n\në³´í†µ í’ˆì§ˆ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ í˜„ì¬ ìš´ì˜ ë²„ì „ê³¼ ì‹ ê·œ ë²„ì „ì˜ ì£¼ìš”í•œ ì§€í‘œ(ì£¼ë¡œ Prometheus Metric)ë¥¼ ë¹„êµí•˜ì—¬ í‰ê°€ë¥¼ ì§„í–‰í•˜ëŠ”ë° ì´ë¥¼ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë‚˜ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ëŒ€ì²´í•˜ì—¬ ì‚¬ìš©í•´ì„œëŠ” ì ˆëŒ€ ì•ˆëœë‹¤.  \nìœ„ì—ì„œ ì–¸ê¸‰í•˜ì˜€ë“¯ì´ ì˜ˆê¸°ì¹˜ ì•Šì€ ìœ„í—˜ì„ ìµœì†Œí™” í•˜ê±°ë‚˜ ë¬¸ì œë¥¼ ì‹ ì†í•˜ê²Œ ë°œê²¬í•˜ëŠ” ê²ƒì„ ì£¼ ëª©ì ìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.\n\nSpinnakerì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 3ê°€ì§€ Cluster(Logical Application Group)ë¥¼ ì‚¬ìš©í•œë‹¤.\n\n* Production Cluster - í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ ìš´ì˜ ë²„ì „ìœ¼ë¡œ ReplicaëŠ” ì„ì˜ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. \n* Baseline Cluster - Production Clusterì™€ ë™ì¼í•œ ë²„ì „ìœ¼ë¡œ ì‹¤í–‰ë¨\n* Canary Cluster - ë³€ê²½ëœ ì‹ ê·œ ë²„ì „ì˜ Softwareë¡œ ì‹¤í–‰ë¨\n\nê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•  ê²½ìš°ì—ëŠ” ë¡œê·¸ì™€ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì„ ë¶„ì„í•˜ê³  ê°ê´€ì ì¸ ì§€í‘œë¡œ í‰ê°€ë¥¼ ì§„í–‰í•˜ëŠ”ê²Œ ê¸°ë³¸ì´ë‹¤.\ní•˜ì§€ë§Œ ì§ì ‘ ì‚¬ëŒì´ í•˜ëŠ” ì¼ì´ë¼ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ë³´ë‹¤ ë³´ë©´ í¸ê²¬ê³¼ ì°©ì˜¤ê°€ ë°œìƒí•  ìˆ˜ ë°–ì— ì—†ë‹¤.\n\nê·¸ë˜ì„œ NetflixëŠ” ACA(Automated Canary Service)ë¼ê³  í•˜ëŠ” ìë™í™”ëœ ì ‘ê·¼ ë°©ì‹ì„ í†µí•´ ì¹´ë‚˜ë¦¬ ë¶„ì„ì„ ì§„í–‰í•˜ê³  ìˆë‹¤.\nìˆ˜ë™ìœ¼ë¡œ ê³„ì‚°ëœ ì—¬ëŸ¬ê°€ì§€ ì§€í‘œë¥¼ ê°€ì¤‘ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì ìˆ˜ë¥¼ ë‚´ë¦¬ê³  ì›í•˜ëŠ” ì ìˆ˜ì— ë„ë‹¬í•˜ë©´ ë°°í¬í•˜ëŠ” ìë™í™”ëœ ë°©ì‹ì´ë‹¤.\n\n## Requirements\n* spinnaker cluster - 1.8+ (1.9.3 ì´ìƒ ì¶”ì²œ)\n* halyard - 1.0+\n* kubernetes cluster - 1.9+\n* metric services - datadog, prometheus, stackdriver, signalfx\n* persistent storage - S3(or compatible S3), minio, GCS\n\n## Kayenta Service ì¶”ê°€í•˜ê¸°\nì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì•„ë˜ í™˜ê²½ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ë‹¤.\n* spinnaker cluster - 1.10.5\n* halyard - 1.11\n* kubernetes cluster - 1.9.7\n* metric services - prometheus\n* persistent storage - compatible S3(IBM Object Storage)\n\nì¼ë‹¨ ê¸°ì¡´ halyard configë¥¼ ë°±ì—…í•˜ì. \n```\n$ hal backup create\n+ Create backup\n  Success\n+ Successfully created a backup at location:\n/Users/ddii/halbackup-Wed_Nov_28_13-35-31_KST_2018.tar\n```\n\në‚˜ì¤‘ì— ë³µêµ¬ëŠ” ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ëœë‹¤. \n```\n$ hal backup restore --backup-path <backup-name>.tar\n```\n\nê¸°ì¡´ halyard configë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ canary.enabled=false ë¡œ ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸ í• ìˆ˜ ìˆë‹¤.\n```\ncurrentDeployment: default\ndeploymentConfigurations:\n- name: default\n  canary\n    enabled: false\n```\n\ncanary analysisì„ í™œì„±í™” í•œë‹¤.\n\n```\n$ hal config canary enable\n```\n\nê·¸ë¦¬ê³  default judgement algorithmì€ `NetflixACAJudge-v1.0` ë¡œ ë˜ì–´ìˆë‹¤ ë‹¤ë¥¸ ê±¸ ì´ìš©í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í• ìˆ˜ ìˆë‹¤. \n```\n$ hal config canary edit --default-judge CUSTOM_JUDGE\n```\n\në©”íŠ¸ë¦­ ì†ŒìŠ¤ë¡œ prometheusë¥¼ ì„¤ì •í•œë‹¤. ë¬¼ë¡  ê¸°ì¡´ì— ì‚¬ìš©ì¤‘ì¸ prometheus endpoint urlì´ í•„ìš”í•˜ë‹¤.\n```\nhal config canary prometheus enable\nhal config canary prometheus account add my-prometheus --base-url http://YOUR_PROMETHEUS_SERVER:PORT\n```\n\nì—¬ê¸°ì„œëŠ” IBM Cloud Object Storage(S3 Compatible)ì„ ì‚¬ìš©í•˜ì˜€ì§€ë§Œ awsë¡œ ì„¤ì •í•œë‹¤.\n```\n$ hal config canary aws enable\n$ hal config canary aws account add my-s3 --bucket spin-bucket --endpoint \\\n    s3.seo-ap-geo.objectstorage.service.networklayer.com --access-key-id ACCESS_ID \\\n    --secret-access-key\n$ hal config canary aws edit --s3-enabled=true\n```\n\nì—¬ëŸ¬ê°œì˜ ë©”íŠ¸ë¦­ì„ ë™ì‹œì— ì„¤ì • ë° ìˆ˜ì§‘ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ê·¸ì¤‘ prometheus ë° ê´€ë ¨ accountë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•œë‹¤.\n```\n$ hal config canary edit --default-metrics-store prometheus\n$ hal config canary edit --default-metrics-account my-prometheus\n$ hal config canary edit --default-storage-account my-s3\n```\n\nëª¨ë“  spinnaker clusterê°€ ì¤€ë¹„ëœ ìƒíƒœì˜ ì»¨í”¼ê·¸ëŠ” ì•„ë˜ì™€ ê°™ë‹¤. \n```\ncurrentDeployment: default\ndeploymentConfigurations:\n- name: default\n  canary:\n    enabled: true\n    serviceIntegrations:\n    - name: google\n      enabled: false\n      accounts: []\n      gcsEnabled: false\n      stackdriverEnabled: false\n    - name: prometheus\n      enabled: true\n      accounts:\n      - name: my-prometheus\n        endpoint:\n          baseUrl: http://YOUR_PROMETHEUS_SERVER:PORT\n        supportedTypes:\n        - METRICS_STORE\n    - name: datadog\n      enabled: false\n      accounts: []\n    - name: aws\n      enabled: true\n      accounts:\n      - name: my-s3\n        bucket: spin-bucket\n        rootFolder: kayenta\n        endpoint: s3.seo-ap-geo.objectstorage.service.networklayer.com\n        accessKeyId: ACCESS_ID\n        secretAccessKey: ACCESS_KEY\n        supportedTypes:\n        - OBJECT_STORE\n        - CONFIGURATION_STORE\n      s3Enabled: true\n    reduxLoggerEnabled: true\n    defaultMetricsAccount: my-prometheus\n    defaultStorageAccount: my-s3\n    defaultJudge: NetflixACAJudge-v1.0\n    defaultMetricsStore: prometheus\n    stagesEnabled: true\n    templatesEnabled: true\n    showAllConfigsEnabled: true\n```\n\nSpinnaker Clusterë¥¼ ì¬ë°°í¬í•˜ê²Œ ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ spin-kayenta deploymentsê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ hal deploy apply\n\n$ kubectl get pod\nNAME                                READY     STATUS    RESTARTS   AGE\nspin-clouddriver-555cfc9765-kvnl8   1/1       Running   0          6d\nspin-deck-85845b5b48-49ncm          1/1       Running   0          6d\nspin-echo-5f9dd4d8ff-mvt7g          1/1       Running   0          6d\nspin-fiat-5b945645d8-s2qcq          1/1       Running   0          6d\nspin-front50-5c57fcf587-tqz28       1/1       Running   0          6d\nspin-gate-57576b8c45-w5v6r          1/1       Running   0          6d\nspin-kayenta-6dcd7767d6-rgb9w       1/1       Running   0          6d\nspin-orca-788df6b9cc-tk6lk          1/1       Running   0          6d\nspin-redis-6c87c456fc-6qbl2         1/1       Running   0          6d\nspin-rosco-f6f845d49-btjnd          1/1       Running   0          6d\n```\n\nì´í›„ Dashboardì— ì ‘ì†í•˜ê³  applicationì¤‘ í•˜ë‚˜ì˜ Configì— ë“¤ì–´ê°€ë©´ Featuresì— Canaryë©”ë‰´ê°€ ìƒê¸´ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì‚¬ìš©ì„¤ì •í•˜ê³  ìºì‹±í•˜ëŠ”ë° ì‹œê°„ì´ ë‹¤ì†Œ í•„ìš”í•˜ê³  Tasks ë©”ë‰´ì—ì„œ í•´ë‹¹ jobì— ëŒ€í•œ ë‚´ìš©ì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. \n\n![canary](/img/canary_config.png)\n\nì´í›„ application delivery ë©”ë‰´ë¥¼ ë³´ë©´ pipelines, canary configs, canary reportsë¼ëŠ” ë©”ë‰´ê°€ ìƒê¸°ê²Œ ëœë‹¤. \n\n![delivery](/img/delivery.png)\n\n## simple deploy pipeline ì¶”ê°€\n\n<https://cloud.google.com/solutions/automated-canary-analysis-kubernetes-engine-spinnaker> ê°€ì´ë“œ ì²˜ëŸ¼ êµ¬ì„±í•´ë´ë„ ë˜ë‚˜ `stackdriver`ë¥¼ ì¨ì•¼í•˜ê³  `prometheus metric`ì„ í™œìš©í•œ ê°€ì´ë“œê°€ í•„ìš”í•´ì„œ ì ì–´ë³´ê³ ì í•œë‹¤.\n\nìƒˆë¡œ íŒŒì´í”„ë¼ì¸ì„ ì¶”ê°€í•œ ë‹¤ìŒ \n\n![newpipe](/img/newpipe.png)\n\nPipeline Actions - Edit Pipeline JSON ì—ì„œ \n<https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/simple-deploy.json> ì„ ì¶”ê°€í•´ì¤€ë‹¤.  \n\ní•´ë‹¹ json pipelineì„ ì¶”ê°€í•˜ê³  ë‚˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. \n![pipe1](/img/samplepipe1.png)\n![pipe2](/img/samplepipe2.png)\n\në°˜ë“œì‹œ Deploy Config, Deploy Stageì—ì„œ ë°°í¬í•  Account ì§€ì •ì„ í•´ì•¼í•œë‹¤. \n\n`sampleapp image - ddiiwoong/canary-demo-spinnaker:latest`\n\ní•´ë‹¹ pipelineë‚´ì˜ sampleappì€ python flask ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ê°„ë‹¨íˆ internal 500 errorë¥¼ ì›í•˜ëŠ” ë¹„ìœ¨ì„ configmap ë³€ìˆ˜ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤. [prometheus python client](https://github.com/prometheus/client_python#counter)ë¥¼ ì‚¬ìš©í•˜ì—¬ Gauge, Counter, Metric ì„œë²„ë¥¼ ê°„ë‹¨í•˜ê²Œ êµ¬ì„±ì„ í•´ë³´ì•˜ë‹¤. ê·¸ë¦¬ê³  ì½”ë“œë‚´ì—ì„œ 500 error rateë¥¼ êµ¬í•œ ì´ìœ ëŠ” 18ë…„ 11ì›” ê¸°ì¤€ spinnaker kayenta ë²„ì „ì—ì„œëŠ” PromQL(rate,irateì™€ ê°™ì€ í•¨ìˆ˜) ì§€ì›ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤. ê°œë°œì¤‘ì¸ ì½”ë“œì— í¬í•¨ì´ ëœê²ƒì„ í™•ì¸í•˜ì˜€ê³  12ì›” kubeconë•Œ ì •ì‹ ë¦´ë¦¬ì¦ˆì— í¬í•¨ë ê±°ë¼ ìƒê°í•œë‹¤. \n\n```\n#!/usr/bin/env python\n\nfrom random import randrange\nfrom flask import Flask\nfrom prometheus_client import start_http_server, Gauge, Counter\nimport os\n\napp = Flask('kayenta-tester')\nc = Counter('requests', 'Number of requests served, by http code', ['http_code'])\ng = Gauge('rate_requests', 'Rate of success requests')\n\nresponce_500 = 0\nresponce_200 = 0\nrate_responce = 0\n\n@app.route('/')\ndef hello():\n    global responce_500\n    global responce_200\n    global rate_responce\n    if randrange(1, 100) > int(os.environ['SUCCESS_RATE']):\n        c.labels(http_code='500').inc()\n        responce_500 = responce_500 + 1\n        rate_responce = responce_500 / (responce_500+responce_200) * 100\n        g.set(rate_responce)\n        return \"Internal Server Error\\n\", 500\n    else:\n        c.labels(http_code = '200').inc()\n        responce_200 = responce_200 + 1\n        rate_responce = responce_500 / (responce_500+responce_200) * 100\n        g.set(rate_responce)\n        return \"Hello World!\\n\"\n\nstart_http_server(8000)\napp.run(host = '0.0.0.0', port = 8080)\n\n```\n\ní•´ë‹¹ì•±ì„ Start Manual Execuctionì„ í†µí•´ ë°°í¬í•œë‹¤. Comfirm Executionì°½ì—ì„œ SUCCESS_RATEë¥¼ ì›í•˜ëŠ” ê°’(ì˜ˆ:70%)ìœ¼ë¡œ ì„ íƒí•˜ê³  ë°°í¬ë¥¼ í•˜ê³  ë‚˜ë©´ Infrastructure - Clusters ë©”ë‰´ì—ì„œ í•´ë‹¹ ìƒ˜í”Œì•±ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n![manaul deploy](/img/manual.png)\n![success rate](/img/successrate.png)\n![manaul deploy2](/img/manual2.png)\n\nì‹¤ì œ í•´ë‹¹ ì„œë¹„ìŠ¤ë¥¼ ì ‘ì†í•´ë³´ë©´ ìœ„ì— ì„¤ì •í•œ SUCCESS_RATE ë¹„ìœ¨ë¡œ 200í™”ë©´ê³¼ 500ì—ëŸ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n![flaskweb](/img/flaskweb.png)\n![flaskweb2](/img/flaskweb2.png)\n\ní•´ë‹¹ ë©”íŠ¸ë¦­ì˜ í†µê³„ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ curlì„ ë°˜ë³µì ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” injection container ë¥¼ ì‹¤í–‰í•œë‹¤.\n\n```\nkubectl -n default run injector --image=alpine -- \\\n    /bin/sh -c \"apk add --no-cache --yes curl; \\\n    while true; do curl -sS --max-time 3 \\\n    http://sampleapp:8080/; done\"\n```\n\n5ë¶„ì •ë„ í›„ì— Prometheusë¡œ ì ‘ì†í•˜ì—¬ ì½”ë“œë‚´ ì‘ì„±í•œ rate_requests ë©”íŠ¸ë¦­ì„ í™•ì¸í•´ë³¸ë‹¤.  \nPromQLì€ ì•„ë˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì˜€ë‹¤.  \n```\nrate_requests{app=\"sampleapp\",version=\"prod\"}\n```\n\nì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ 4ê°œì˜ podì—ì„œ 70% ì •ë„ 200 OK, 30% ì •ë„ 500 Errorê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n![500rate](/img/500rate.png)\n\nì´ ë©”íŠ¸ë¦­ì„ Spinnaker ì—ì„œ í™•ì¸í•˜ê¸° ìœ„í•´ Canary Pipelineì„ ë§Œë“¤ì.\n\n<https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/automated-canary.json>ë¥¼ JSONìœ¼ë¡œ Pipelineì„ ìƒì„±í•œë‹¤. \n\n![canary_auto](/img/canary_auto.png)\n\nStageë³„ë¡œ ì‚´í´ ë³´ê¸°ì „ì— \n\n* Prerequisite  \n  Canary Config êµ¬ì„±ì´ ë¨¼ì € í•„ìš”í•˜ë‹¤. Delivery - Canary Configs ë©”ë‰´ì—ì„œ ì‹ ê·œ ì»¨í”¼ê·¸ë¥¼ ì‘ì„±í•œë‹¤. \n     - Configuration Name - `kayenta-test`\n     - Filter Templates ë©”ë‰´ë¥¼ ë¨¼ì € ìƒì„±í•œë‹¤. Canary, Baselineêµ¬ë¶„ì„ ìœ„í•´ version ì •ë³´ë¥¼ ì„ íƒí•˜ì˜€ë‹¤. \n     - Metrics - Add Metric ì€ ë¶„ì„ì„ ìœ„í•œ Prometheus Metricì„ ì„¤ì •í•˜ëŠ” ë‹¨ê³„ë¡œ `error_rate`ê°€ ì¦ê°€(increase)í•˜ë©´ Pipelineì„ ì¤‘ë‹¨ì‹œí‚¤ê³  Metricì€ ì•ì—ì„œ í™•ì¸í•œ `rate_requests`ë¥¼ ì§€ì •í•œë‹¤. Filter Templateì€ ìœ„ì—ì„œ ì§€ì •í•œ versionì„ ì„ íƒí•œë‹¤. ![metric config](/img/metric_config.png)\n     - SCORING - ì–´ì§œí”¼ ì˜ˆì œëŠ” í•œê°€ì§€ Metricë¶„ì„ìœ¼ë¡œ 0ì  ì•„ë‹ˆë©´ 100ì ìœ¼ë¡œ ë‚˜ì˜¬ê²ƒì´ë¯€ë¡œ Maginal 75, Pass 95ë¥¼ ì„¤ì •í•œë‹¤.\n\n1. 1st Stage\n    * Configuration - Pipeline ì‹¤í–‰ì‹œ ì´ˆê¸° ì…ë ¥ê°’(0-100, 10ë‹¨ìœ„)ìœ¼ë¡œ ì„¤ì •ê°€ëŠ¥í•œ successRate ë¼ëŠ” Parameterë¥¼ ì„¤ì •í•œë‹¤. \n2. 2nd Stage\n    * Find Baseline - ìœ„ì—ì„œ ì‘ì„±í•œ ê¸°ë³¸ Deploy Pipelineì´ ì„ íƒë˜ì—ˆëŠ”ì§€ì™€ í™•ì¸í•œë‹¤.\n    * Deploy Canary Config - ì•ì—ì„œ ì„ íƒí•œ ìƒˆë¡œìš´ Parameter(successRate)ë¥¼ ì‹ ê·œ ë°°í¬í•  Canary Pod ConfigMapìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ë‹¨ê³„ì´ë‹¤.\n3. 3rd Stage\n    * Deploy Canary - yaml manifestë¡œ Canary ë²„ì „ì„ ë°°í¬í•œë‹¤. ReplicasëŠ” 1ë¡œ ì„¤ì •í•˜ì˜€ê³  ë°°í¬ë  Account(K8s Cluster)ë¥¼ ì§€ì •í•œë‹¤. \n    * Deploy Baseline - yaml manifestë¡œ Baseline ë²„ì „ì„ ë°°í¬í•œë‹¤. ìœ„ì™€ ë™ì¼í•˜ê²Œ ReplicasëŠ” 1ë¡œ ì„¤ì •í•˜ì˜€ê³  ë°°í¬ë  Account(K8s Cluster)ë¥¼ ì§€ì •í•œë‹¤. \n4. 4th Stage\n    * Canary Analysis - ì¤‘ìš”í•œ Canary ë¶„ì„ ë‹¨ê³„ë¡œ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •ì„ í™•ì¸í•œë‹¤. Prerequisiteì—ì„œ ì„¤ì •í•œ Config(`kayenta-test`)ë¥¼ ì„ íƒí•˜ê³  ì§§ì€ ë¶„ì„ì„ ìœ„í•´ 1ë¶„(60ì´ˆ) ê°„ê²©ìœ¼ë¡œ 3ë²ˆ ìˆ˜í–‰ì„ í•˜ë„ë¡ í•œë‹¤.   Filter Templateì—ì„œ ì§€ì •í•œ version(`version=\"${scope}\"`) ë¶„ì„ì„ ìœ„í•´ Baseline, Canary ì„¤ì •ì„ í•˜ê³  Locationì€ Namespacesë¡œ ìƒê°í•˜ë©´ ëœë‹¤. ![aca config](/img/aca_config.png)\n5. 5th Stage\n    * Deploy to Production - Canary ë¶„ì„ì´ í†µê³¼í•˜ì˜€ì„ ê²½ìš° ìš´ì˜ì— ë°°í¬\n    * Delete Canary, Delete Baseline - ì„±ê³µì´ë˜ ì‹¤íŒ¨ì´ë˜ Canary, Baseline ë°°í¬ë³¸ì„ ì‚­ì œ \n6. 6th Stage\n    * Successful deployment - Canary ë¶„ì„ì´ í†µê³¼í•˜ì˜€ì„ ê²½ìš° ìµœì¢… ì™„ë£Œ í‘œê¸°í•˜ëŠ” ë‹¨ê³„\n\nì„¤ì •ì´ ë§ˆë¬´ë¦¬ê°€ ë˜ë©´ ì €ì¥ì„ í•˜ê³  Canary ë¶„ì„ì— ë“¤ì–´ê°„ë‹¤. \nìµœì´ˆì— `successRate`ì„ 70ìœ¼ë¡œ ë°°í¬í–ˆë‹¤ë©´ ê·¸ ì´í•˜ë¡œ ì„¤ì •í–ˆì„ ê²½ìš°ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ Score 0ì ìœ¼ë¡œ ë°°í¬ê°€ ì‹¤íŒ¨í•˜ê³  Pipelineì´ ì¢…ë£Œëœë‹¤.   \n\n![fail](/img/canary_fail.png)  \n\n70 ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ê²Œ ë˜ë©´ Score 100ì ìœ¼ë¡œ ì •ìƒ ë°°í¬ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n![success](/img/canary_success.png)  \n\n\n## ì •ë¦¬\nê°„ë‹¨í•˜ê²Œ Spinnaker ì™€ Prometheus Metricì„ í™œìš©í•˜ì—¬ Kayenta ê¸°ë°˜ Canary ë°°í¬ë¥¼ í•´ë´¤ë‹¤. í˜„ì¬ Spinnaker 1.10ì—ì„œ istioê°€ ì§€ì›ëœë‹¤ê³  í•˜ë‹ˆ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ê³  istio ê¸°ë°˜ canary ë°°í¬ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ë” ì—°êµ¬í•´ë´ì•¼ í•  ê²ƒ ê°™ë‹¤.  \n\nì˜¬í•´ AWS re:invent ëë‚˜ê³  ì‘ë…„ë³´ë‹¤ í° í˜„ìíƒ€ì„ì´ ì™”ë‹¤. ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë¨¹ê³ ì‚¬ëŠ” ì‚¬ëŒë“¤ì˜ ê¸°ë¶„ì€ ë‹¤ ë¹„ìŠ·í• ê±° ê°™ë‹¤ê³  ìƒê°ì´ ë“ ë‹¤. 12ì›” 11ì¼ ë¶€í„° Kubeconì´ ì—´ë¦°ë‹¤ê³  í•˜ë‹ˆ Kubernetes ê´€ë ¨í•œ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ì™€ ê¸°ëŠ¥ë“¤ì— ì§‘ì¤‘í•´ì„œ ë‚¨ë“¤ë³´ë‹¤ í•œë°œ ë‚˜ì•„ê°€ì•¼í•˜ì§€ ì•Šì„ê¹Œ? ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë¨¹ê³ ì‚¬ì‹œëŠ” ë¶„ë“¤ ë‹¤ë“¤ í˜ëƒˆìœ¼ë©´ ì¢‹ê² ë‹¤."
    },
    {
      "id": "kubernetes/spinnaker-advanced-2/",
      "metadata": {
        "permalink": "/kubernetes/spinnaker-advanced-2/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-09-27-spinnaker-advanced-2.md",
        "source": "@site/blog/2018-09-27-spinnaker-advanced-2.md",
        "title": "Spinnaker on Kubernetes #2",
        "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #2",
        "date": "2018-09-27T00:00:00.000Z",
        "formattedDate": "September 27, 2018",
        "tags": [
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Spinnaker",
            "permalink": "/tags/spinnaker"
          },
          {
            "label": "Continuous Delivery",
            "permalink": "/tags/continuous-delivery"
          },
          {
            "label": "Continuous Deployment",
            "permalink": "/tags/continuous-deployment"
          },
          {
            "label": "Pipeline",
            "permalink": "/tags/pipeline"
          }
        ],
        "readingTime": 7.61,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Spinnaker on Kubernetes #2",
          "comments": true,
          "classes": "wide",
          "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #2",
          "slug": "kubernetes/spinnaker-advanced-2/",
          "date": "2018-09-27T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "CI/CD",
            "Kubernetes",
            "Spinnaker",
            "Continuous Delivery",
            "Continuous Deployment",
            "Pipeline"
          ]
        },
        "prevItem": {
          "title": "Spinnaker on Kubernetes #3 (Kayenta)",
          "permalink": "/kubernetes/spinnaker-advanced-3/"
        },
        "nextItem": {
          "title": "knative",
          "permalink": "/kubernetes/knative/"
        }
      },
      "content": "ì´ì „ í¬ìŠ¤íŒ… [Spinnaker on Kubernetes #1](https://ddii.dev/kubernetes/spinnaker-advanced-1/)ì—ì„œ ê²€í† í• ë•ŒëŠ” ë§ì´ ê°œë…ì„ ì´í•´í•˜ê¸° ì–´ë ¤ì› ë˜ê²ƒ ê°™ì§€ë§Œ ì–´ëŠì •ë„ ì‹œê°„ì´ ì§€ë‚¬ê³  ë˜ ëª‡ì¼ í›„ì— ë°œí‘œë„ ìˆì–´ì„œ ë‹¤ë¥¸ ì´ì•¼ê¸°ë¥¼ í•´ë³´ê³ ì í•œë‹¤.  \n\nì§€ë‚œ í¬ìŠ¤íŒ…ì— ëŒ€ì¶© ì§‘ê³  ë„˜ì–´ê°„ ìš©ì–´ë“¤ì— ëŒ€í•œ ì •ë¦¬ë¥¼ ë‹¤ì‹œ í•˜ê³  ê¸°ë³¸ì ì¸ ì‚¬ìƒë“¤ì„ ì •ë¦¬í•´ë³´ê³ ì í•œë‹¤. í—ˆì ‘í•œ í”Œë«í¼ ì—”ì§€ë‹ˆì–´ ìƒê°ì´ë‹ˆ ì–¸ì œë“  ë‹¤ë¥¸ ì˜ê²¬ì„ í™˜ì˜í•˜ëŠ” ë°”ì´ë‹¤. \n\n## What is spinnaker? (+History)\nìµœê·¼ íŠ¸ë Œë“œì¸ ë©€í‹° í´ë¼ìš°ë“œë¥¼ ì§€í–¥í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì´ë‹¤.  \n2014ë…„ Netflixì˜ Asgardë¡œ ì‹œì‘ë˜ì–´ 2015ë…„ì— ì˜¤í”ˆì†ŒìŠ¤í™” ë˜ì—ˆë‹¤.  \në¹ ë¥¸ ì†ë„ì™€ ì‹ ë¢°ë„ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ë¦´ë¦¬ì¦ˆë¥¼ ìœ„í•´ ë§Œë“¤ì–´ì¡Œìœ¼ë©° ëŒ€ë¶€ë¶„ì˜ ë©”ì´ì € í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë”ë“¤ì„ ì§€ì›í•œë‹¤.(AWS,GCP,Azure,openstack..)  \ní˜„ì¬ Netflix, Google, MS, Veritasë“±ì´ Contributionì„ í•˜ê³  ìˆë‹¤.\n\n## ì™œ Spinnakerë¥¼ ì¨ì•¼í•˜ì§€?\nì—¬ëŸ¬ê°€ì§€ ì´ìœ ê°€ ìˆê² ì§€ë§Œ\n* Multi-Cloudìš© Continuous Delivery/Deployment Platform ìœ¼ë¡œ ëŒ€ì²´ê°€ ê°€ëŠ¥\n* ë‹¤ì–‘í•œ pipeline í˜•íƒœë¡œ ë°°í¬ê°€ ê°€ëŠ¥í•˜ê³  Rollbackì´ ì‰¬ì›€\n* ë¹ ë¥¸ ë°°í¬ê°€ ê°€ëŠ¥í•˜ê³  ì—¬ëŸ¬ë²ˆ ë°°í¬ê°€ ìš©ì´í•¨\n* ìœ ì—°í•œ pipeline management systemì„ ê°€ì§€ê³  ìˆìŒ\n* ë‹¤ì–‘í•œ ë°°í¬ì „ëµì„ ê°€ì§„ë‹¤(Blue-Green, Rolling Red/Black, Canary)\n* community í™œë™ í™œë°œ (github, slack) - ë‹µì€ ì˜ ì•ˆí•´ì¤Œ ã… ã… \n* VMê³¼ Container ë™ì‹œì— í†µí•©ê´€ë¦¬ ê°€ëŠ¥\n* CIí†µí•© ìš©ì´(Jenkins)\n* CLIë¥¼ í†µí•œ ì„¤ì¹˜ ë° ê´€ë¦¬(halyard)\n* VM, Helm Packaging ê°€ëŠ¥\n* RBAC ì§€ì›\n* Notification - Email, Slack, Hipchatë“±\n* Safe Deployment - Judgement (ìŠ¹ì¸ê¸°ëŠ¥)\n* Chaos Monkey Built-in\n\nì´ì •ë„ë©´ ë¬´ì¡°ê±´ ì¨ì•¼í•˜ì§€ ì•Šì„ê¹Œ?\n\n## Jenkins vs Spinnaker\n\n|Jenkins|Spinnaker|\n|:----------:|:----------:|\n|ê°•ë ¥í•œ ë¹Œë“œì„œë²„|\tí´ë¼ìš°ë“œ ìì›ì˜ 1ì°¨ ì—°ë™|\n|ì™„ì „í•œ deployment toolì´ ì•„ë‹˜|vm & deployments ì•ˆì— ë¹Œë“œë˜ì–´ ìˆìŒ|\n|ìŠ¤í¬ë¦½íŒ…ì´ ë§ì´ í•„ìš”í•¨|ë³„ë„ì˜ ìŠ¤í¬ë¦½íŒ…ì´ ë§ì´ í•„ìš”ì—†ìŒ|\n|ê¸°ëŠ¥ë“¤ì´ ëª¨ë‘ í”ŒëŸ¬ê·¸ì¸ í˜•íƒœ|CI toolì´ ì•„ë‹˜(CI toolsì´ ë°±ì—”ë“œë¡œ)|\n\n## Kubernetes vs Spinnaker\n\n|Kubernetes|Spinnaker|\n|:----------:|:----------:|\n|ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ì œí•œ|ì •ì˜í•œ í¼ì„¼íŠ¸ë¡œ rollout|\n|slow rollout|ê° ë‹¨ê³„ë³„ ê²€ì¦ ê°€ëŠ¥|\n|High rollback cost|Fast rollbacks|\n|Linear rollouts|resource ì‚¬ìš©ëŸ‰ì´ í¼|\n|ê²€ì¦ë‹¨ê³„ê°€ ì—†ìŒ||\n\n## Deploy Pipeline\n\nSpinnakerë¥¼ ì‚¬ìš©í• ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì€ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ êµ¬ì„±í•œë‹¤.  \nìˆ˜ë™ìœ¼ë¡œ UIë‚˜ APIë¡œ íŠ¸ë¦¬ê±°ë§í• ìˆ˜ ìˆê³ , ìë™ìœ¼ë¡œ Jenkins ë“±ê³¼ íŠ¸ë¦¬ê±° ì—°ë™í•˜ì—¬ ë¹Œë“œì™„ë£Œì‹œ ë°°í¬ë˜ë„ë¡ í• ìˆ˜ ìˆë‹¤.\n\n![spinnaker-pipeline](/img/spinnaker-pipeline.png)\n\n## Deployment Strategies\nSpinnakerì—ì„œì˜ ë°°í¬ì „ëµì€ ë‹¤ìŒê³¼ ê°™ì´ ì œê³µëœë‹¤.\n\n![deployment-strategies](https://www.spinnaker.io/concepts/deployment-strategies.png)\n\n### Red / Black (same as Blue / Green)\n* ë™ì¼í•œ ì–‘ì˜ instanceë¡œ ì´ë£¨ì–´ì§„ ìƒˆë¡œìš´ Server Groupì„ ìƒì„±í•œë‹¤\n* ì‹ ê·œ Server Groupì´ ì •ìƒìƒíƒœê°€ ë˜ë©´ LBëŠ” ì‹ ê·œ Server Groupì— íŠ¸ë˜í”½ì„ ë¶„ì‚°í•œë‹¤. \n  \n### Rolling red/black\n* ì´ì „ê³¼ ë™ì¼í•˜ì§€ë§Œ ì¸ìŠ¤í„´ìŠ¤ë³„ ë˜ëŠ” ê·¸ë£¹ë³„ë¡œ rolling\n  \n### Canary\n* ê°€ì¥ ì‘ì€ ê°œìˆ˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ êµì²´ì‹œí‚¤ê³ \n* ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë¶„ì‚°ì‹œí‚¨ë‹¤ (1~5í”„ë¡œ)\n* ìƒˆë¡œìš´ ë²„ì „ì— ì´ìŠˆê°€ ì—†ì„ë•Œê¹Œì§€ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê³ \n* íŠ¹ì •ì‹œê°„ê¹Œì§€ ì´ìŠˆê°€ ì—†ìœ¼ë©´ ë°°í¬ë¥¼ ëŠ˜ë ¤ê°„ë‹¤. \n\n## ìš©ì–´ì •ë¦¬ 2íƒ„\n\nì´ì „ [post](https://ddiiwoong.github.io/2018/spinnaker-advanced-1/)ì—ì„œ ì •ë¦¬í•œê±¸ ë‹¤ì‹œ ë³µê¸°í•˜ê³  ì¶”ê°€ì ì¸ ë‚´ìš©ì„ë“¤ ì ì–´ë´¤ë‹¤.\n\nì‚¬ìš©í•˜ë©´ì„œ í˜¼ëˆì´ ë§ì´ ìƒê¸°ëŠ” ë¶€ë¶„ì´ë‹¤ ì´ê²Œ GCEë‚˜ EC2ë¥¼ ì“°ë©´ ìš©ì–´ ë§¤ì¹­ì´ ì‰¬ìš´ë° k8së¥¼ ìœ„í•œ ë³„ë„ì˜ ë©”ë‰´ê°€ ì•„ë‹Œ ê¸°ëŠ¥ì„ í†µí•©í•˜ë‹¤ë³´ë‹ˆ ìš©ì–´ê°€ ì¡°ê¸ˆ í˜¼ë™ìŠ¤ëŸ½ê²Œ êµ¬ì„±ì´ ë˜ì—ˆë‹¤.  \níŠ¹íˆ Load Balancer ë¶€ë¶„ì€ Serviceë¡œ ë§¤í•‘ë˜ê³  í¼ë¸”ë¦­ k8sì—ì„œ ì œê³µí•˜ëŠ” Type LoadBalancerëŠ” ë¯¸ì§€ì›í•œë‹¤.  \nê·¸ë¦¬ê³  ëª¨ë“  Resourceë“¤ì€ Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)ì„ ì§€ì›í•˜ë©° Versioningì´ ì§€ì›ëœë‹¤.  Versioningì€ [ì—¬ê¸°](https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy)ì— ì„¤ëª…ëœ ëŒ€ë¡œ ```strategy.spinnaker.io/versioned``` annotationì„ í†µí•´ manifestë³„ë¡œ ì¬ì •ì˜ê°€ ê°€ëŠ¥í•˜ë‹¤.\n\n| Spinnaker | Kubernetes | ë¹„ê³  |\n|:----------:|:----------:|:-----------:|\n| Server Group | [Workloads](https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads) | [CRDì˜ ê²½ìš° ë³„ë„ Build](https://www.spinnaker.io/guides/developer/crd-extensions/) |\n| Clusters | Logical Server Group\t |  |\n| Load Balancer | Services | LoadBalancer(k8s) ë¯¸ì§€ì› |\n| Firewall | NetworkPolicies |  |\n\n### Application Management\nSpinnakerì—ì„œ Application ì´ë€ ë°°í¬í•˜ë ¤ëŠ” ì„œë¹„ìŠ¤ë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ë¼ ìƒê°í•˜ë©´ ëœë‹¤.  \n* pipeline\n* Clusters, Server Groupì˜ ì§‘í•©ì´ë©°, firewallê³¼ loadbalancerë¥¼ í¬í•¨í•œë‹¤.\n* Canary Config\n\n### Cluster\nKubernetesì˜ Clusterê°€ ì•„ë‹ˆë¼ Spinnakerì—ì„œ Server Groupì˜ ë…¼ë¦¬ì ì¸ ê·¸ë£¹\n\n### Server Group\nê¸°ë³¸ìì›ì¸ ì„œë²„ê·¸ë£¹ì€ ë°°í¬í• ìˆ˜ ìˆëŠ” artifacts(vm image, docker image, source)ì™€ ì¸ìŠ¤í„´ìŠ¤(pod) ìˆ˜, Auto-Scaling, metadata ë“± ê¸°ë³¸ êµ¬ì„±ë“±ì„ ê°€ì§€ê³  ìˆë‹¤.  \nì„œë²„ê·¸ë£¹ì€ LoadBalacerë‚˜ Firewall ë„ ì„ íƒì ìœ¼ë¡œ ì—°ê²°ë˜ê³ , vmì´ë‚˜ pod í˜•íƒœë¡œ ë°°í¬ëœ applicationì˜ ì§‘í•©ì²´ë¼ ë³¼ìˆ˜ ìˆë‹¤.\n\n### Cloud Provider\n* IaaS - AWS, GCP, Azure, Oracle, Openstack\n* PaaS -  Google App Engine\n* Orchestrator - K8s, DC/OS\n* Docker v2 Registry\n\n### Account\nCloud Providerì— ì¸ì¦í•˜ê¸° ìœ„í•œ Spinnakerì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” Account Name\n\n### Pipeline\nPipelineì€ ì£¼ìš” ë°°í¬ ê´€ë¦¬ë„êµ¬ë¡œ ì‚¬ìš©ëœë‹¤. \nStageë¼ê³ í•˜ëŠ” ì¼ë ¨ì˜ Actionìœ¼ë¡œ êµ¬ì„±ë˜ë©° íŒŒì´í”„ë¼ì¸ì„ ë”°ë¼ Stageê°„ ë§¤ê°œë³€ìˆ˜ ì „ë‹¬ì´ ê°€ëŠ¥í•˜ë‹¤.  \nìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•˜ê±°ë‚˜, Jenkins ì‘ì—…ì™„ë£Œ, Docker Registry ì‹ ê·œ Docker ì´ë¯¸ì§€, Cronì¼ì • ë˜ëŠ” ë‹¤ë¥¸ Stageì™€ ê°™ì€ ì´ë²¤íŠ¸ì— ì˜í•´ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë§ë˜ë„ë¡ êµ¬ì„±í• ìˆ˜ ìˆë‹¤.  \nPipeline ì‹¤í–‰ì¤‘ì—(ì‹œì‘/ì™„ë£Œ/ì‹¤íŒ¨) mail, slack, hipchat(ì‚¬ë¼ì§)ì„ í†µí•´ Alertê°€ ê°€ëŠ¥í•˜ë‹¤.\n\n![pipeline](https://www.spinnaker.io/concepts/pipelines.png)\n\n### Stage (atomic building block)\nPipelineì´ ìˆ˜í–‰í•  ë™ì‘ì„ ë§í•œë‹¤.  \nDeploy, Resize, Disable, Manual Judgement ë“±ì„ ìˆ˜í–‰í• ìˆ˜ ìˆë‹¤.\n\n![stage](https://www.spinnaker.io/concepts/pipelines/pipeline-tasks.png)\n\n* Stage - Multiple steps\n* Step - ì§„í–‰ë˜ê¸°ì „ì— êµì •/í´ë§ì´ í•„ìš”í•œ tasks\n* Task - íŠ¹ì • Cloud Platformìœ¼ë¡œ ë™ì‹œì— ì—¬ëŸ¬ APIí˜¸ì¶œ\n* Operation - ë‹¨ìœ„ API\n\n## ì •ë¦¬\n\nìš©ì–´ë‚˜ ê°œë…ì€ ì–´ëŠì •ë„ ì •ë¦¬ëœë“¯ í•˜ê³  ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì‹¤ì œ multi cluster í™˜ê²½ì—ì„œ deployí•˜ê³  pipelineì„ ì‚¬ìš©í•˜ëŠ” ë‚´ìš©ì„ ì ì–´ë³¼ ì˜ˆì •ì´ë‹¤."
    },
    {
      "id": "kubernetes/knative/",
      "metadata": {
        "permalink": "/kubernetes/knative/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-08-01-knative.md",
        "source": "@site/blog/2018-08-01-knative.md",
        "title": "knative",
        "description": "knative ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
        "date": "2018-08-01T00:00:00.000Z",
        "formattedDate": "August 1, 2018",
        "tags": [
          {
            "label": "Knative",
            "permalink": "/tags/knative"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "FaaS",
            "permalink": "/tags/faa-s"
          },
          {
            "label": "Serverless",
            "permalink": "/tags/serverless"
          },
          {
            "label": "CRDs",
            "permalink": "/tags/cr-ds"
          },
          {
            "label": "CloudEvents",
            "permalink": "/tags/cloud-events"
          },
          {
            "label": "Mesh",
            "permalink": "/tags/mesh"
          }
        ],
        "readingTime": 8.77,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "knative",
          "comments": true,
          "classes": "wide",
          "description": "knative ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
          "slug": "kubernetes/knative/",
          "date": "2018-08-01T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Knative",
            "Kubernetes",
            "FaaS",
            "Serverless",
            "CRDs",
            "CloudEvents",
            "Mesh"
          ]
        },
        "prevItem": {
          "title": "Spinnaker on Kubernetes #2",
          "permalink": "/kubernetes/spinnaker-advanced-2/"
        },
        "nextItem": {
          "title": "Dex",
          "permalink": "/kubernetes/dex/"
        }
      },
      "content": "## Knative\n\në¯¸ì¹œë†ˆë“¤ ëª¨ì—¬ì„œ ë¯¸ì¹œê²ƒì„ ë§Œë“¤ì—ˆêµ°.. ã…ã… \nì˜ˆìƒí–ˆë˜ ë‚´ìš©ë“¤ì„ í˜„ì‹¤ë¡œ ë§Œë“œëŠ” í´ë¼ìŠ¤\n\nKubernetes ê´€ë ¨ ë¹„ì§€ë‹ˆìŠ¤ë¥¼ í•˜ê³  ìˆëŠ” ì…ì¥ì—ì„œ ë´ë„ ë†€ë„ì¼ì´ì§€ë§Œ\nì¸í”„ë¼ ì˜ì—­ë¶€í„° ê°œë°œì ì˜ì—­ê¹Œì§€ ëª¨ë‘ë¥¼ ì¶”ìƒí™”ì‹œí‚¤ëŠ” í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œì˜ í˜ì´ë€ ì°¸ ëŒ€ë‹¨í•˜ë‹¤.\n\nì˜¤ëŠ˜ì€ knativeì—ì„œ ì£¼ìš”ê¸°ëŠ¥ë“¤ì„ ë‘˜ëŸ¬ë³´ê³ ì í•œë‹¤.\n\nê°œì¸ì ì¸ ìƒê°ì€ Kubernetes ì§„ì˜ì´ë¼ê³  í•´ì•¼í•˜ë‚˜ CNCF ì§„ì˜ì´ë¼ê³  í•´ì•¼í•˜ë‚˜..\nê·¸ë™ì•ˆ ë…¸ë˜ë¥¼ ë¶€ë¥´ê³  ì£¼ëª©í–ˆë˜ CRDs, Operators, Serverless Workload, CloudEvents, Mesh Layer ê°œë…ê³¼ ì˜ì—­ì„ í¡ìˆ˜í•´ì„œ ê·¸ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥ì‹œí‚¤ê³  ìˆë‹¤. \n\n```\nkubectl apply -f https://storage.googleapis.com/knative-releases/serving/latest/release.yaml\n```\n\nìœ„ ì½”ë“œ ë‚´ìš©ì„ ìƒì„¸í•˜ê²Œ ë³´ê³ ìˆì§€ë§Œ ë‹´ì€ê²ƒë“¤ì´ ì •ë§ ë§ë‹¤. ê·¸ë˜ë„ ë‹¤ ì´í•´í•˜ë ¤ë©´ í•˜ë‚˜í•˜ë‚˜ ì±™ê²¨ë´ì•¼ í•œë‹¤.\n\nì˜¤ëŠ˜ì€ ì¼ë‹¨ ì½”ì–´ ê¸°ëŠ¥ë§Œ ì‚´í´ë³¸ë‹¤.\n\n## Build\n\n`build`ëŠ” Knativeì˜ ì£¼ìš” `custom resource`ì´ê³  ì´ë¥¼ ì´ìš©í•˜ì—¬ fetch, build, packageë¥¼ ìˆ˜í–‰í•œë‹¤. repoì˜ ì†ŒìŠ¤ë¥¼ ë¹Œë“œí•˜ê³  ì»¨í…Œì´ë„ˆë¡œ ì´ë¯¸ì§€ë¡œ ë§Œë“¤ê³  ê·¸ë‹¤ìŒì— Knative `Serving`ìœ¼ë¡œ ë³´ë‚¸ë‹¤ê³  í•œë‹¤. \n\n\n### Build ìš©ì–´\n- `Build`ëŠ” ì—¬ëŸ¬ `steps`ì„ í¬í•¨í•˜ê³  `Builder`ë¡œ êµ¬ì²´í™”ëœë‹¤\n- `Builder`ëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ìœ í˜•\n- `Build`ë‚´ `steps`ì€ repositoryì— pushë¥¼ í•  ìˆ˜ ìˆìŒ\n- `BuildTemplate` ëŠ” ì¬í™œìš©ê°€ëŠ¥í•œ í…œí”Œë¦¿\n- `Build`ë‚´ `source`ëŠ” kubernetes Volumeìœ¼ë¡œ mountë˜ëŠ” ë°ì´í„°ë¥¼ ì •ì˜í• ìˆ˜ ìˆê³  git, Google Cloud Storage, ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì§€ì›í•¨.\n- kubernetes Secretì„ ì‚¬ìš©í•˜ì—¬ `ServiceAccount`ë¡œ ì¸ì¦í•¨\n\n## Serving\n\nKnative `Serving`ì€ Kubernetesì™€ Istioë¥¼ ê¸°ë°˜ìœ¼ë¡œ Serverless Workloadê°€ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‘ë™í•˜ëŠ” ë°©ì‹ì„ ì •ì˜í•˜ê³  ì œì–´í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤ê³  í•˜ì§€ë§Œ ì—„ì—°íˆ Public FaaS(AWS Lambdaë“±)ì™€ëŠ” êµ¬ë³„ë˜ì–´ì•¼ í•œë‹¤ê³  ìƒê°í•œë‹¤.\n\nServerless ë¼ê³  í•˜ëŠ” ìš©ì–´ë¥¼ ì‰½ê²Œ ìƒê°í•˜ëŠ” ì‚¬ëŒë“¤ì´ ë§ì€ë° ê²°êµ­ ë‚˜ì¤‘ì—ëŠ” ê°„ë‹¨í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤ì€ ë‹¤ Serverless ìŠ¤íƒ€ì¼ë¡œ ì „í™˜ë ê²ƒì´ë¼ëŠ” ì‚¬ìƒì„ ì„œë¹„ìŠ¤ë‚˜ í”Œë«í¼ì— ë„£ê³  ìˆëŠ” ì¶”ì„¸ë‹¤. \n\nCNCF ì§„í˜•ì˜ Cloud Eventë¼ê³  í•˜ëŠ” ì´ë²¤íŠ¸ ê·¸ë¦¬ë“œë°©ì‹ì˜ í‘œì¤€í™”ë¥¼ ë”°ë¼ ê°€ëŠ”ê²ƒì¸ì§€ ì•„ë‹ˆë©´ ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ì„ ì •ì˜í•˜ë ¤ê³  í•˜ëŠ”ê²ƒì¸ì§€ëŠ” ê·¸ë“¤ì˜ í–¥í›„ Cloud Native ë¡œë“œë§µì— ë‹¬ë ¤ìˆë‹¤ í•´ë„ ë¬´ë°©í• ê²ƒ ê°™ë‹¤. \n\n- Serverless Containerì˜ ì‹ ì†í•œ ë°°ì¹˜ê°€ ê°€ëŠ¥\n- Automatic scaling up and down to zero\n- Istio Component\n- ë°°í¬ ëœ ì½”ë“œ ë° configì˜ íŠ¹ì • ì‹œì  ìŠ¤ëƒ… ìƒ·\n\n### `Serving` Resources\nCRDsë¡œ ì •ì˜í•œ Objects ì§‘í•©ì²´, ì´ëŸ¬í•œ Objectë“¤ì€ Serverless ì›Œí¬ë¡œë“œ í˜•íƒœë¡œ ì •ì˜ë˜ê³  ì‚¬ìš©ëœë‹¤. \nê°€ì¥ ì¸ìƒê¹Šê³  ì¤‘ìš”í•œ ë¬¸êµ¬ëŠ” `Request-driven compute that can scale to zero` ì¸ ê²ƒ ê°™ë‹¤.\n\ní•œë™ì•ˆ ìœ í–‰í–ˆë˜ OpenPaaS, CFê¸°ë°˜ì˜ PaaS í”Œë«í¼ì„ ë›°ì–´ë„˜ëŠ” êµ¬ì¶•í˜• ê·¸ê²ƒë„ ìŠ¤í”„ë§ë¶€íŠ¸ ì˜ì—­ê¹Œì§€ë„ kubernetes ê¸°ë°˜ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì„œë²„ë¦¬ìŠ¤ë¡œ ê°„ë‹¤ëŠ” ì´ì•¼ê¸°...\n\nì´ë¯¸ í¼ë¸”ë¦­ìœ¼ë¡œëŠ” [GA](https://cloud.spring.io/spring-cloud-function/)ë„ ë˜ì—ˆë‹¤.\n\nìš°ë¦¬ íŒ€ì›ë“¤ê³¼ í•¨ê»˜ ì—´ì‹¬íˆ vmware dispatch frameworkìœ¼ë¡œ ê°œë°œí•˜ê³  ìˆì§€ë§Œ ê²°êµ­ pivotalê³¼ vmwareëŠ” ê±°ì˜ í•œëª¸ì´ê¸°ì— ë”ìš± ë” ë³€í™”ê°€ í•„ìš”í•œ ìˆœê°„ì´ë‹¤.\n\n![serving](https://github.com/knative/serving/raw/master/docs/spec/img/object_model.png)\n\n- `Route`ëŠ” ì‚¬ìš©ì ì„œë¹„ìŠ¤ì— ëŒ€í•œ HTTP endpointë¥¼ ì œê³µ.\n- `Revisions`ì€ code(function)ì™€ configë¡œ êµ¬ì„±ëœ ë¶ˆë³€ì˜ ìŠ¤ëƒ…ìƒ·. Routeë¥¼ í†µí•´ endpointë¥¼ í• ë‹¹ë°›ì§€ ëª»í•œ Revisionì€ ìë™ìœ¼ë¡œ kubernetes resourceì—ì„œ ì‚­ì œë¨\n- `Configuration`ì€ ìš”êµ¬ë˜ëŠ” Revision ìµœì‹  ìƒíƒœë¥¼ ê¸°ë¡í•˜ê³  ìƒì„±í•˜ê³  ì¶”ì í• ìˆ˜ ìˆìŒ. ì†ŒìŠ¤ íŒ¨í‚¤ì§€(git repoë‚˜ archive)ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ë‚´ìš©ì´ë‚˜ ë©”íƒ€ë°ì´í„°ë“±ì„ í¬í•¨ì‹œí‚¬ìˆ˜ ìˆìŒ. \n- `Service`ëŠ” `Routes`ì™€ `Configurations` ë¦¬ì†ŒìŠ¤ì˜ ì¶”ìƒí™”ëœ ì§‘í•©ì²´. ëª¨ë“  ì›Œí¬ë¡œë“œì˜ lifecycleì„ ê´€ë¦¬í•¨. íŠ¸ë˜í”½ì„ í•­ìƒ ìµœì‹ ì˜ revisionìœ¼ë¡œ routeë˜ë„ë¡ ì •ì˜í• ìˆ˜ ìˆìŒ\n\n\n\n## Events\n\nCNCFì˜ [CloudEvent Spec.](https://www.cncf.io/events/) ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ produce/comsume í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤. í”ŒëŸ¬ê·¸ì¸ í˜•íƒœë¡œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í• ìˆ˜ ìˆê³  ë‹¤ì–‘í•œ pub/sub ìŠ¤íƒ€ì¼ì˜ broker serviceë¥¼ í†µí•´ ì œê³µë ìˆ˜ ìˆë‹¤. \n\nAzureëŠ” ì´ë¯¸ [EventGridì„œë¹„ìŠ¤](https://azure.microsoft.com/ko-kr/services/event-grid/)ë¥¼ GAë¥¼ í•œ ìƒí™©ì´ê³  [Pivotal](https://pivotal.io/kr/knative) ì§„ì˜ë„ Serverless WorkloadëŠ” `Knative`ê¸°ë°˜ìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤ê³  í–ˆìœ¼ë‹ˆ [Dispatch](https://github.com/vmware/dispatch) ë„ ê²°êµ­ ë”°ë¼ê°€ì§€ ì•Šì„ê¹Œ ìƒê°í•´ë³¸ë‹¤. \n\n![eventing_concept](https://github.com/knative/docs/raw/master/eventing/concepts.png)\n\n### Bus\nKafkaë‚˜ Natsì™€ ê°™ì€ ë©”ì‹œì§€ Busë¥¼ í†µí•´ K8sê¸°ë°˜ì˜ pub/subì„ ì œê³µí•˜ëŠ” ê°œë…. ì´ë²¤íŠ¸ëŠ” Channelì— ì˜í•´ ê²Œì‹œë˜ê³  ê´€ì‹¬ìˆëŠ” ì‚¬ëŒì—ê²Œ ë¼ìš°íŒ…ë¨.\n\n- Channel : ì—¬ê¸°ì„œ ì´ì•¼ê¸° í•˜ëŠ” ì±„ë„ì€ íŠ¹ì • busì— ì‚¬ìš©ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë°›ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ì—”ë“œí¬ì¸íŠ¸\n- Subscription : Channelì—ì„œ ìˆ˜ì‹ í•œ ì´ë²¤íŠ¸ë¥¼ ê´€ì‹¬ìˆëŠ” target, DNSì´ë¦„ìœ¼ë¡œ í‘œí˜„ë˜ëŠ” ì´ë²¤íŠ¸ì— ì—°ê²°í•¨\n- Bus : (kafka topicì— ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ëŠ”ê²ƒ ì²˜ëŸ¼) íŠ¹ì • ì§€ì†ì„± ì „ëµì„ ì‚¬ìš©í•˜ì—¬ Channelê³¼ Subscriptionì„ êµ¬í˜„í•˜ëŠ”ë° í•„ìš”í•œ ì ìš© ê³„ì¸µì„ ì •ì˜í•¨\n\n\ní˜„ì¬ 3ê°€ì§€ì˜ Busê°€ ì œê³µë¨ ([Kafka](https://github.com/knative/eventing/tree/master/pkg/buses/kafka), [Stub](https://github.com/knative/eventing/tree/master/pkg/buses/stub), [GCP PubSub](https://github.com/knative/eventing/tree/master/pkg/buses/gcppubsub))\n\n\n### Sources\n\nSourceëŠ” K8s ì™¸ë¶€ì˜ ë°ì´í„° ì†ŒìŠ¤ë¥¼ í”„ë¡œë¹„ì €ë‹í•˜ê³  ì´ë¥¼ í´ëŸ¬ìŠ¤í„°ë¡œ ë¼ìš°íŒ…í•˜ê¸° ìœ„í•œ ì¶”ìƒí™” ë ˆì´ì–´ë¥¼ ì œê³µí•¨. ì•„ë˜ì™€ ê°™ì€ ì†ŒìŠ¤ë“¤ì„ ì œê³µí•˜ê³  ìˆìŒ\n\n- Feed : EventTypeê³¼ Action (CloudEvents í˜¸í™˜ HTTP endpoint)ê°„ì˜ ì—°ê²°ì„ ì •ì˜í•˜ëŠ” ê¸°ë³¸ ê°ì²´\n- EventType and ClusterEventType : EventSourceì—ì„œ ë¶„ë¦¬ë˜ëŠ” ê³µí†µìŠ¤í‚¤ë§ˆë¡œ íŠ¹ì • ì´ë²¤íŠ¸ì˜ ì§‘í•©, EventTypeì€ Namespace ë²”ìœ„ë‚´ì—ì„œ ì‚¬ìš©ë˜ê³  ClusterEventTypeì€ ëª¨ë“  Namespaceì—ì„œ ì‚¬ìš©ë ìˆ˜ ìˆë„ë¡ ê´€ë¦¬ìì— ì˜í•´ ì„¤ì¹˜ë¨\n- EventSource and ClusterEventSource : í•˜ë‚˜ ì´ìƒì˜ EventTypesë¥¼ ìƒì„± í•  ìˆ˜ìˆëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œì„ ê¸°ìˆ í•¨\n\ní˜„ì¬ 3ê°€ì§€ Sourcesë¥¼ ì œê³µí•¨\n- K8sevents : [Kubernetes Events](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#event-v1-core)ë¥¼ ìˆ˜ì§‘í•˜ê³  CloudEvents íƒ€ì…ìœ¼ë¡œ í‘œì‹œí•¨\n- Github : PR(pull request) notificationì„ ìˆ˜ì§‘í•˜ê³  CloudEvents íƒ€ì…ìœ¼ë¡œ í‘œì‹œí•¨\n- GCP PubSub : GCP PubSub topicìœ¼ë¡œ publishëœ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘í•˜ê³  CloudEvents íƒ€ì…ìœ¼ë¡œ í‘œì‹œí•¨\n\n### Flows\n\në§ˆì§€ë§‰ìœ¼ë¡œ Sourceì—ì„œ Endpointê¹Œì§€ ë¬¶ì–´ì£¼ëŠ” Flowë¼ê³  ë¶€ë¥´ëŠ” ë†’ì€ ìˆ˜ì¤€ì˜ ì¶”ìƒí™”ê°€ ìˆë‹¤.\nSpecìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ë¼ìš°íŒ…ëœ Channelê³¼ Busë¥¼ ê¸°ì¬í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.\nFlowëŠ” Eventingì—ì„œ ìµœìƒìœ„ ê°œë…ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì„ íƒí• ìˆ˜ ìˆê³ , ì™¸ë¶€ Source ì´ë²¤íŠ¸ì—ì„œ ëª©ì ì§€ê¹Œì§€ ì›í•˜ëŠ” ê²½ë¡œë¥¼ ê¸°ìˆ í• ìˆ˜ ìˆë‹¤.\n\n# ì •ë¦¬\nì›Œë‚™ ë°©ëŒ€í•œ ì–‘ì„ ê°€ì§€ê³  ìˆê³  ì´í•´í•˜ë ¤ê³  ë…¸ë ¥í•˜ë©´ì„œ ì ë‹¤ë³´ë‹ˆ ë²ˆì—­ìœ„ì£¼ë¡œ ë˜ì–´ë²„ë ¸ë‹¤. \nì›ë˜ ë‹¤ìŒë²ˆì— Nats Streamingì„ ë‹¤ë£° ì˜ˆì •ì´ì˜€ìœ¼ë‚˜, \në‹¹ë¶„ê°„ì€ knative êµ¬ì„±ìš”ì†Œë¥¼ ì´í•´í•˜ê³  ì ìš©í•˜ëŠ” ìœ„ì£¼ë¡œ í¬ìŠ¤íŒ…ì„ í•  ì˜ˆì •ì´ë‹¤. ì•„ë§ˆë„ ëª¨ë“ˆë³„(Serving, Building, Eventing) ì‹œë¦¬ì¦ˆê°€ ë  ë“¯ í•˜ë‹¤."
    },
    {
      "id": "kubernetes/dex/",
      "metadata": {
        "permalink": "/kubernetes/dex/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-26-dex.md",
        "source": "@site/blog/2018-07-26-dex.md",
        "title": "Dex",
        "description": "Dex ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
        "date": "2018-07-26T00:00:00.000Z",
        "formattedDate": "July 26, 2018",
        "tags": [
          {
            "label": "dex",
            "permalink": "/tags/dex"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "identity service",
            "permalink": "/tags/identity-service"
          },
          {
            "label": "OIDC",
            "permalink": "/tags/oidc"
          },
          {
            "label": "connectors",
            "permalink": "/tags/connectors"
          }
        ],
        "readingTime": 9.39,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Dex",
          "comments": true,
          "classes": "wide",
          "description": "Dex ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
          "slug": "kubernetes/dex/",
          "date": "2018-07-26T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "dex",
            "Kubernetes",
            "identity service",
            "OIDC",
            "connectors"
          ]
        },
        "prevItem": {
          "title": "knative",
          "permalink": "/kubernetes/knative/"
        },
        "nextItem": {
          "title": "Cert-manager",
          "permalink": "/kubernetes/cert-manager/"
        }
      },
      "content": "## Dex - A federated OpenID Connect provider\n----\n### dexëŠ” ê¸°ë³¸ì ìœ¼ë¡œ OpenID Connectë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¸ì¦ì„ í•˜ê²Œ í•´ì£¼ëŠ” identity ì„œë¹„ìŠ¤ë‹¤.  \nhttps://github.com/coreos/dex\n\n\nDexëŠ” \"connectors\"ë¥¼ í†µí•´ ë‹¤ë¥¸ identity providerì˜ í¬í„¸(ê²Œì´íŠ¸ì›¨ì´, ì¤‘ê³„ì) ì—­í• ì„ í•œë‹¤. ì´ë¥¼ í†µí•´ LDAP, SAMLë˜ëŠ” GitHub, Google, AD(Active Directory)ì™€ ê°™ì€ ê¸°ì¡´ ì¸ì¦ì„ dexì—ê²Œ ìœ„ì„í•  ìˆ˜ ìˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” ì¼ë‹¨ ì¸ì¦ ë¡œì§ì„ ì‘ì„±í•˜ì—¬ dexì™€ í†µì‹ í•˜ë©´ dexëŠ” ì£¼ì–´ì§„ ë°±ì—”ë“œ(ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ kubernetes í´ëŸ¬ìŠ¤í„°)ì— ëŒ€í•œ í”„ë¡œí† ì½œì„ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤. \n\ní•˜ì§€ë§Œ í–¥í›„ Cloud Native ì¸ì¦ ì¹´íƒˆë¡œê·¸ ì¤‘ í•˜ë‚˜ë¡œì„œ ìƒê°í•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ì´ë‹¤ ë³´ë‹ˆ í…ŒìŠ¤íŠ¸ëŠ” ì§„í–‰í•´ë´ì•¼ í•  ê²ƒ ê°™ë‹¤.\n\n### OpenID Connect\n\nê¸°ë³¸ì ìœ¼ë¡œ DexëŠ” OIDC(OpenID Connect)ë¥¼ ì‚¬ìš©í•œë‹¤.  \nê·¸ëŸ¬ë¯€ë¡œ [kubernetes í´ëŸ¬ìŠ¤í„° ì‚¬ìš©ì ì¸ì¦ìš©ë„](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#using-kubectl)ë¡œ Dexë¥¼ ë¶™ì¼ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.  \në˜í•œ ìœ„ì—ì„œ ë§í•œê²ƒê³¼ ê°™ì´ ë‹¤ë¥¸ identity providerë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ ì¸ì¦í•˜ëŠ”ë° ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ [connectors](https://github.com/coreos/dex#connectors)ë¥¼ ì‚¬ìš©í•œë‹¤. \n\n![dex_image](/img/dex-flow.png)\n\nìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ \"connectors\"ëŠ” ë‹¤ë¥¸ identity providerë¥¼ í†µí•´ ì‚¬ìš©ìë¥¼ ì¸ì¦í•˜ê¸° ìœ„í•´ dexì—ì„œ ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ ë„êµ¬ë‹¤. ê²°êµ­ DexëŠ” ê¸°ì¡´ì— í™œìš©í•˜ë˜ GitHub, LinkedIn ë° Microsoft ADì™€ ê°™ì€ ë²¤ë” í”Œë«í¼ì´ë‚˜ LDAP ë° SAMLê³¼ ê°™ì€ ê¸°ì¡´ í”„ë¡œí† ì½œ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ kubernetes í´ëŸ¬ìŠ¤í„° ì‚¬ìš©ì ì¸ì¦ì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤. í° íšŒì‚¬??ë“¤ì€ OpenLDAPì´ë‚˜ Microsoft Active Directoryì™€ ê°™ì€ ì‚¬ë‚´ ë””ë ‰í† ë¦¬ ì„œë¹„ìŠ¤ë¥¼ ìš´ìš©í•˜ê±°ë‚˜ ë‚´ê°€ ìˆëŠ” ì‘ì€ ê·œëª¨ì˜ íŒ€ë“¤ì€ ëŒ€ë¶€ë¶„ Githubì´ë‚˜ Google ê³„ì •ì€ ê°€ì§€ê³  ìˆì„ ê²ƒì´ê¸° ë•Œë¬¸ì— Dexì™€ ê°™ì€ ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ê¸°ì¡´ identity provider ì™€ kubernetesë¥¼ ì‰½ê²Œ í†µí•©í•  ìˆ˜ ìˆë‹¤ê³  ë³¸ë‹¤.\n\n![dex_kube](/img/dex_architect.png)\n\n### Kubernetes OIDC\n\nì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ Identity Provider ìœ„ì¹˜ì— Dexë¥¼ êµ¬ì„±í•˜ë©´ ëœë‹¤.\n\n![kube_openid](https://d33wubrfki0l68.cloudfront.net/d65bee40cabcf886c89d1015334555540d38f12e/c6a46/img/docs/admin/k8s_oidc_login.svg)\n\npublic managed kubernetes í™˜ê²½ì—ì„œëŠ” í˜„ì‹¤ì ìœ¼ë¡œ kubeapi-serverë¥¼ ì»¨íŠ¸ë¡¤í•˜ê¸° ì–´ë µê¸° ë•Œë¬¸ì— ì¼ë‹¨ Native í´ëŸ¬ìŠ¤í„°ì— êµ¬ì„±ì„ í•˜ë„ë¡ í•œë‹¤.\n\n### Github ì—°ë™í•˜ê¸°\ní…ŒìŠ¤íŠ¸ë¡œ Githubì„ ì—°ë™í•´ë³´ì. ì¼ë‹¨ ì•„ë˜ì™€ ê°™ì´ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ í•˜ë‚˜ë§Œë“ ë‹¤.  \nì•„ë˜ì—ì„œ DNS.1 ë¶€ë¶„ì€ /etc/hostsë¡œ í…ŒìŠ¤íŠ¸ë¡œ ë“±ë¡í•  ë„ë©”ì¸ìœ¼ë¡œ ê°€ìƒìœ¼ë¡œ ë§Œë“¤ì—ˆë‹¤. (generator.sh)\n\n```\n#!/bin/bash\n\nmkdir -p ssl\n\ncat << EOF > ssl/req.cnf\n[req]\nreq_extensions = v3_req\ndistinguished_name = req_distinguished_name\n[req_distinguished_name]\n[ v3_req ]\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n[alt_names]\nDNS.1 = dex.newtech.academy\nEOF\n\nopenssl genrsa -out ssl/ca-key.pem 2048\nopenssl req -x509 -new -nodes -key ssl/ca-key.pem -days 10 -out ssl/ca.pem -subj \"/CN=kube-ca\"\n\nopenssl genrsa -out ssl/key.pem 2048\nopenssl req -new -key ssl/key.pem -out ssl/csr.pem -subj \"/CN=kube-ca\" -config ssl/req.cnf\nopenssl x509 -req -in ssl/csr.pem -CA ssl/ca.pem -CAkey ssl/ca-key.pem -CAcreateserial -out ssl/cert.pem -days 10 -extensions v3_req -extfile ssl/req.cnf\n```\n\nNamespaceë„ í•˜ë‚˜ ë§Œë“¤ì. (dex-ns.yaml)\n\n```\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: dex\n```\n\n\nkubernetest í´ëŸ¬ìŠ¤í„°ìš© ì¸ì¦ì„œë¥¼ ìƒì„±í•œë‹¤.\n```\n$ ./generator.sh\n$ kubectl create -f dex-ns.yaml\n$ kubectl create secret tls dex.newtech.academy.tls -n dex --cert=ssl/cert.pem --key=ssl/key.pem\n$ mkdir pki\n$ cp ssl/ca.pem pki/openid-ca.pem\n```\n\nGithubì— ê°€ì„œ ì•„ë˜ì™€ ê°™ì´ Org OAuth App.ì„ ì‹ ê·œë¡œ ìƒì„±í•œë‹¤.  \n\n![github](/img/dex_github.png)\n\në§Œë“  ìœ„ ì•±ì •ë³´ë¡œ Github-Client Secretì„ ë§Œë“ ë‹¤.\n\n```\n$ export GITHUB_CLIENT_ID=<Client ID>\n$ export GITHUB_CLIENT_SECRET=<Client Secret>\n\n$ kubectl create secret \\\n    generic github-client \\\n    -n dex \\\n    --from-literal=client-id=$GITHUB_CLIENT_ID \\\n    --from-literal=client-secret=$GITHUB_CLIENT_SECRET\n\n$ kubectl get secret\nNAME                  TYPE                                  DATA      AGE\ndefault-token-f29fb   kubernetes.io/service-account-token   3         27m\ndex.newtech.academy.tls    kubernetes.io/tls                     2         27m\ngithub-client         Opaque                                2         6s\n\n$ kubectl get secret github-client -o yaml\napiVersion: v1\ndata:\n  client-id: xxxxx\n  client-secret: xxxxxxx\nkind: Secret\nmetadata:\n  creationTimestamp: 2018-07-24T15:14:29Z\n  name: github-client\n  namespace: dex\n  resourceVersion: \"7044721\"\n  selfLink: /api/v1/namespaces/dex/secrets/github-client\n  uid: 42dfa0e9-8f54-11e8-8d6d-2aaad36eb114\ntype: Opaque\n```\nìœ„ì—ì„œ ì´ì•¼ê¸° í–ˆì§€ë§Œ ì—¬ê¸°ê¹Œì§€ ì•„ë¬´ìƒê°ì—†ì´ í¼ë¸”ë¦­ì—ì„œ êµ¬ì„±í•˜ë‹¤ê°€ ìƒê°í•´ë³´ë‹ˆ kube-apiserverë¥¼ ë³€ê²½í•˜ë ¤ë©´ ì§ì ‘ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¨ì•¼í•œë‹¤ëŠ” ì´ëŸ° ë°”ë³´ê°™ì€ ì‹¤ìˆ˜ë¥¼ ë˜ ì €ì§€ë¥´ê³  ë§ì•˜ë‹¤. ê·¸ë˜ì„œ ë‹¤ì‹œ VMì— ì¬êµ¬ì„±ì„ ã…œã…œ\n\nê·¸ë¦¬ê³  kube-apiserver manifest íŒŒì¼ì— ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•œë‹¤.  \n/etc/kubernetes/manifests/kube-apiserver.manifest\n\n```\n    - --oidc-issuer-url=https://dex.newtech.academy:32000\n    - --oidc-client-id=example-app\n    - --oidc-ca-file=/pki/openid-ca.pem\n    - --oidc-username-claim=email\n    - --oidc-groups-claim=groups\n```\n\nê·¸ë¦¬ê³  kubelet ì¬ì‹œì‘ì„ í•œë‹¤. \n```\n$ systemctl restart kubelet\n```\n\ní…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ dex sample appì„ ë¹Œë“œí•˜ê³  ë§Œë“  ì¸ì¦ì„œì™€ í•¨ê»˜ ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ ìƒ˜í”Œí˜ì´ì§€ë¥¼ ë³¼ìˆ˜ ìˆë‹¤. \n```\n$ sudo apt-get install make golang-1.9\n$ git clone https://github.com/coreos/dex.git\n$ cd dex\n$ git checkout v2.10.0\n$ export PATH=$PATH:/usr/lib/go-1.9/bin\n$ go get github.com/coreos/dex\n$ make bin/example-app\n$ export MY_IP=$(curl -s ifconfig.co)\n$ ./bin/example-app --issuer https://dex.newtech.academy:32000 --issuer-root-ca /pki/openid-ca.pem --listen http://${MY_IP}:5555 --redirect-uri http://${MY_IP}:5555/callback\n2018/07/25 14:37:52 listening on http://169.56.94.55:5555\n```\n![dex_sample](/img/dex_sample.png)\n\nê·¸ë¦¬ê³  ë¡œê·¸ì¸ì„ í•˜ê²Œ ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ Github ì¸ì¦ì„ í†µí•´ kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‚¬ìš©í•˜ë ¤ê³  í•˜ëŠ” Tokenì„ íšë“í•  ìˆ˜ ìˆë‹¤.\n\n![kube_dex](/img/kube_dex.png)\n\n\n\n![dex_token](/img/dex_token.png)\n\n\në‹¤ìŒìœ¼ë¡œ ìœ„ì—ì„œ ë§Œë“  tokenì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ Role, RoleBindingê³¼ ì‹¤ì œ ë¡œê·¸ì¸í•  github ê³„ì •ì„ Userë¡œ ì‚¬ìš©í•˜ë„ë¡ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•œë‹¤.\n\n```\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: Role\nmetadata:\n  name: exampleUser\n  namespace: default\nrules:\n- apiGroups: [\"\"] # \"\" indicates the core API group\n  resources: [\"pods\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\n  name: exampleUser\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: exampleUser\nsubjects:\n- kind: User\n  name: ddiiwoong@gmail.com\n  namespace: default\n```\n\nê³„ì •ìƒì„±ì„ í•˜ê³  ìœ„ì—ì„œ ë§Œë“  tokenì„ ê°€ì§€ê³  developer ì‚¬ìš©ìë¥¼ ì„¤ì •í•˜ê³  contextì„¤ì •ë¡œ dev-defaultë¡œ ìƒì„±í•œë‹¤.\n\n```\n$ kubectl create -f user.yaml\nrole.rbac.authorization.k8s.io \"exampleUser\" created\nrolebinding.rbac.authorization.k8s.io \"exampleUser\" created\n\n$ export TOKEN=<dex_sample_app_token>\n\n$ kubectl config set-credentials developer --auth-provider=oidc --auth-provider-arg=idp-issuer-url=https://dex.newtech.academy:32000 --auth-provider-arg=client-id=example-app --auth-provider-arg=idp-certificate-authority=/pki/openid-ca.pem  --auth-provider-arg=id-token=${TOKEN}\nUser \"developer\" set.\n\n$ kubectl config set-context dev-default --cluster=kubernetes --namespace=default --user=developer\nContext \"dev-default\" created.\n```\n\nìœ„ì²˜ëŸ¼ ë§Œë“¤ê³  ë‚˜ë©´ í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ contextë“¤ì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. í™•ì¸í›„ì— contextë¥¼ dev-defaultë¡œ ë°”ê¿”ë³´ì.  \nìƒˆë¡œìš´ contextë¥¼ í™•ì¸í• ìˆ˜ ìˆë‹¤. \n\n```\n$ kubectl config get-contexts\nCURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE\n*         admin-cluster.local   cluster.local   admin-cluster.local   \n          dev-default           kubernetes      developer             default\n\n$ kubectl config use-context dev-default\nSwitched to context \"dev-default\".\n\n$ kubectl config get-contexts\nCURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE\n          admin-cluster.local   cluster.local   admin-cluster.local   \n*         dev-default           kubernetes      developer             default\n\n$ kubectl get pod --all-namespaces\nNAMESPACE     NAME                                    READY     STATUS    RESTARTS   AGE\ndex           dex-64c4fb5b44-42d44                    1/1       Running   0          1h\ndex           dex-64c4fb5b44-r9p9d                    1/1       Running   0          1h\ndex           dex-64c4fb5b44-w5s2m                    1/1       Running   0          1h\nkube-system   calico-node-2bqll                       1/1       Running   0          13h\nkube-system   calico-node-cljb2                       1/1       Running   0          13h\nkube-system   calico-node-svh5n                       1/1       Running   0          13h\nkube-system   kube-apiserver-node1                    1/1       Running   0          1h\nkube-system   kube-controller-manager-node1           1/1       Running   2          13h\nkube-system   kube-dns-7bd4d5fbb6-7bb2j               3/3       Running   0          13h\nkube-system   kube-dns-7bd4d5fbb6-g8lz8               3/3       Running   0          13h\nkube-system   kube-proxy-node1                        1/1       Running   0          13h\nkube-system   kube-proxy-node2                        1/1       Running   0          13h\nkube-system   kube-proxy-node3                        1/1       Running   0          13h\nkube-system   kube-scheduler-node1                    1/1       Running   2          13h\nkube-system   kubedns-autoscaler-679b8b455-qxlvw      1/1       Running   0          13h\nkube-system   kubernetes-dashboard-55fdfd74b4-mbkm8   1/1       Running   0          13h\nkube-system   nginx-proxy-node2                       1/1       Running   0          13h\nkube-system   nginx-proxy-node3                       1/1       Running   0          13h\nkube-system   tiller-deploy-5c688d5f9b-52tls          1/1       Running   0          13h\n```\n\n### ì •ë¦¬\nì²˜ìŒì—ë„ ì–¸ê¸‰í–ˆë“¯ì´ kubernetes ì¸ì¦ì„ ìœ„í•´ ë¬´ê±°ìš´ keycloakì„ ì‚¬ìš©ì„ í•˜ëŠ” ê²½ìš°ë“¤ì´ ë§ì€ë° ê°„ë‹¨í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” dexë¥¼ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ê°€ì§€ identity providerì˜ connector ì—­í• ë¡œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë¬´ë‚œí•œê²ƒ ê°™ë‹¤.  \nê²°êµ­ Dexë¥¼ ì´ìš©í•˜ë©´ GitHubë¥¼ ë¹„ë¡¯í•´ ë‹¤ì–‘í•œ OpenID, OAuth 2.0 ì¸ì¦ ì„œë¹„ìŠ¤ì™€ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì—®ê¸° ì‰¬ìš¸ìˆ˜ ìˆë‹¤.  \në‹¨, ìµœê·¼ commitì´ 3-4ë‹¬ì „ì´ë¼ëŠ”ê²ƒê³¼ ì²˜ìŒ stable helmì— ë“±ë¡ëœ í›„ ì—…ë°ì´íŠ¸ê°€ ì—†ì—ˆë‹¤ëŠ” ì ì´ ê±±ì •ë˜ëŠ” ë¶€ë¶„ì´ê¸´ í•˜ë‹¤. (ë¬˜í•˜ê²Œ Redhatê³¼ í•©ë³‘ ì¼ì •ì´ ì˜¤ë²„ë© ë˜ê¸´í•œë‹¤...)\n\n\nê±°ì˜ 2ì£¼ë§Œì— í¬ìŠ¤íŒ…ì¸ë° '18 Google Next í‚¤ë…¸íŠ¸ì—ì„œ [knative](https://github.com/knative/)ë¼ëŠ” í˜„ì¬ ê°œë°œì¤‘ì¸ í”„ë¡œì íŠ¸ì™€ ìœ ì‚¬í•œ ì˜¤í”ˆì†ŒìŠ¤ê°€ ê³µê°œë˜ì—ˆë‹¤. ë‹¤ìŒë²ˆì—” knativeë„ í•œë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´ì•¼ í• ë“¯ í•˜ë‹¤. \n\ní¼ë¸”ë¦­ê³¼ í”„ë¼ì´ë¹— í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ê³ ë¯¼ì´ ìƒê¸°ê¸° ì‹œì‘í•œë‹¤. ë‹¤ì‹œê¸ˆ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì— ì§‘ì¤‘í•˜ê¸° ìœ„í•´ í”„ë¼ì´ë¹—ìœ¼ë¡œ ëŒì•„ê°€ì•¼ í•˜ë‚˜ë¼ëŠ” ê³ ë¯¼ì—ë„ ë¹ ì ¸ìˆëŠ” ìƒíƒœì—ì„œ knative, GKE on Premise ê°™ì€ ì—”í„°í”„ë¼ì´ì¦ˆì—ì„œ í”„ë¼ì´ë¹— êµ¬ì¶•ì„ ìœ„í•œ ê²ƒë“¤ë„ ë‚˜ì˜¤ê³  ìˆì–´ì„œ ë”ë”ìš± ê³ ë¯¼ì— ë¹ ì§„ ìš”ì¦˜ì´ë‹¤..."
    },
    {
      "id": "kubernetes/cert-manager/",
      "metadata": {
        "permalink": "/kubernetes/cert-manager/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-13-cert-manager.md",
        "source": "@site/blog/2018-07-13-cert-manager.md",
        "title": "Cert-manager",
        "description": "Cert-managerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
        "date": "2018-07-13T00:00:00.000Z",
        "formattedDate": "July 13, 2018",
        "tags": [
          {
            "label": "Cert-manager",
            "permalink": "/tags/cert-manager"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "TLS",
            "permalink": "/tags/tls"
          },
          {
            "label": "Manage TLS Certificates",
            "permalink": "/tags/manage-tls-certificates"
          },
          {
            "label": "Security",
            "permalink": "/tags/security"
          },
          {
            "label": "HTTPS",
            "permalink": "/tags/https"
          }
        ],
        "readingTime": 8.14,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Cert-manager",
          "comments": true,
          "classes": "wide",
          "description": "Cert-managerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
          "slug": "kubernetes/cert-manager/",
          "date": "2018-07-13T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Cert-manager",
            "Kubernetes",
            "TLS",
            "Manage TLS Certificates",
            "Security",
            "HTTPS"
          ]
        },
        "prevItem": {
          "title": "Dex",
          "permalink": "/kubernetes/dex/"
        },
        "nextItem": {
          "title": "Operators & CRDs(CustomResourceDefinitions) on Kubernetes",
          "permalink": "/kubernetes/operator/"
        }
      },
      "content": "## TLS ì¸ì¦ì„œ\n\nì œí•œëœ ì˜ˆì‚°ê³¼ ì‹œê°„, ì¸ë ¥ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ë‹¤ ë³´ë‹ˆ ì–´ë ¤ìš´ ì ë“¤ì´ ì°¸ ë§ë‹¤. íŠ¹íˆë‚˜ TLS ì¸ì¦ì„œ ê°™ì€ ê²½ìš° ê´€ë¦¬í•˜ëŠ”ê²ƒì´ ì€ê·¼íˆ ê·€ì°®ë‹¤. ì¸ì¦ì„œ ë§Œë£Œì¼ ê´€ë¦¬í•˜ëŠ”ê²ƒ ë¶€í„° ì–´ëŠ í˜ì´ì§€ê¹Œì§€ë¥¼ í‰ë¬¸ìœ¼ë¡œë§Œ ë‘ì–´ì•¼ í•˜ëŠ”ì§€ë„... ê·¸ëŸ°ë° ë°”ë³´ê°™ì€ ì´ìŠˆë¥¼ ì €ì§€ë¥´ê³  ë§ì•˜ë‹¤. ë„ë©”ì¸ì„ ì‹ ì²­í•˜ê³  fanout, Name based virtual hosting ë°©ì‹ì¤‘ì— ê³ ë¯¼í•˜ë‹¤ê°€ ì„¤ê³„ë¥¼ virtual hostë¡œ í•˜ì˜€ë‹¤.  \n\nê·¸ëŸ°ë° ë¬¸ì œëŠ” ì–´ì´ì—†ëŠ”ê³³ì—ì„œ ë‚˜ì™”ë‹¤. *.xxxxx.io ë¼ê³  wildcard SSL ì¸ì¦ì„œë¥¼ ì‹ ì²­í•˜ì˜€ëŠ”ë° virtual hostë°©ì‹ìœ¼ë¡œ 2ì°¨ subdomin (ì˜ˆ, api.stg.xxxxx.io)ìœ¼ë¡œ ingressë¥¼ ë§ˆêµ¬ì¡ì´ë¡œ ìƒì„±í•˜ê³  ì¸ì¦ì„œë¥¼ ì ìš©ì„ í–ˆë‹¤. í•˜ì§€ë§Œ ì¸ì¦ì„œ ì˜¤ë¥˜ ã…‹ã…‹\n\nì¸í„°ë„· ë¹„ì§€ë‹ˆìŠ¤ë¥¼ ê±°ì˜ í•´ë³´ì§€ ì•Šì•„ì„œ ì¸ì§€, ì´ëŸ° ê¸°ë³¸ì ì¸ ë‚´ìš©ë„ ê°„ê³¼í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ êµ¬ìƒí•œ ë‚´ê°€ ëª¨ë“ ê±¸ ì±…ì„ì ¸ì•¼í•˜ëŠ” ìƒí™©ì´ ì™€ë²„ë ¸ë‹¤. \n\nì„¤ê³„ë¥¼ ì´ìƒí•˜ê²Œ í•´ì„œ wildcard ë„ë©”ì¸ì„ ëª‡ì‹­ê°œë¥¼ ì‹ ê·œë¡œ ê³„ì•½í•´ì•¼í•˜ëŠ” ì“¸ë°ì—†ëŠ” ë¹„ìš©ì„ ë“¤ì–´ì•¼í•˜ëŠ” ì²˜ì§€ê°€ ë˜ì—ˆë‹¤. í•˜ì§€ë§Œ ê·¸ëƒ¥ ì£½ìœ¼ë€ ë²•ì€ ì—†ëŠ”ê²Œ ì‚¬ëŒì‚¬ëŠ” ì„¸ìƒì´ê³  ì´ëŸ° ê³ ë¯¼ë“¤ì„ ë¶„ëª… ë‹¤ë¥¸ì‚¬ëŒë“¤ë„ í–ˆì„ê±°ì•¼ë¼ê³  ìƒê°í•˜ë©´ì„œ ë– ì˜¤ë¥¸ê²Œ let's encrypt ì˜€ê³  ì°¾ì•„ë³´ë‹ˆ ì´ê±¸ ë˜ kubernetesì—ì„œ ë°œê¸‰ë¶€í„° ê°±ì‹ ê¹Œì§€ í•´ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ì°¾ì•„ ì ìš©ê¹Œì§€ í•˜ê³  ì´ë ‡ê²Œ í¬ìŠ¤íŒ…ì„ í•œë‹¤. \n\n\n### Cert-manager\n\nì¸ì¦ì„œ ì—†ì´ êµ¬ì„±í• ìˆ˜ë„ ìˆì§€ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ kubernetes ëŠ” secretê³¼ ingressì˜ ê°„ë‹¨í•œ ì„¤ì •ë§Œìœ¼ë¡œ TLSë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.  \n\n\n* Cert-manager : K8s í´ëŸ¬ìŠ¤í„°ë‚´ì—ì„œ TLSì¸ì¦ì„œë¥¼ ìë™ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹ ë° ê´€ë¦¬í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤\n* Letâ€™s Encrypt :  ììœ¨ì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê°œë°©ëœ CA(Certificate authority-ì¸ì¦ê¸°ê´€)ìœ¼ë¡œ ê³µê³µì„±(ê³µê³µì˜ ì´ìµ)ì„ ìœ„í•´ì„œ ìš´ì˜ë˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤\n\n\n\n[Cert-manager](http://docs.cert-manager.io/en/latest/)ëŠ” AWSì˜ Certificate Managerì™€ ìœ ì‚¬í•˜ê²Œ ì¸ì¦ì„œë¥¼ ë°œê¸‰í•˜ê³  ì„¤ì •í• ìˆ˜ ìˆë‹¤. 3ê°œì›” ìœ íš¨ê¸°ê°„ì„ ê°€ì§€ëŠ” [let's encrypt](https://letsencrypt.org/)ë¥¼ ì‚¬ìš©í•˜ê¸°ì— ì¸ì¦ì„œ ë§Œë£Œì‹œ ë¬¸ì œê°€ ë ê±°ë¼ ìƒê°í–ˆì§€ë§Œ ì´ê²ƒë„ ìë™ìœ¼ë¡œ ê°±ì‹ ì„ í•´ì£¼ëŠ” ê´€ë¦¬ app.ì„ ê°™ì´ ë°°í¬í•˜ê¸° ë•Œë¬¸ì— ì¸ì¦ì„œ ê´€ë¦¬ì— ëŒ€í•œ ë¶€ë‹´ì„ ëœìˆ˜ ìˆë‹¤.  \n\nê¸°ë³¸ì ìœ¼ë¡œ Cert-managerëŠ” [let's encrypt](https://letsencrypt.org/), [Vault](https://www.vaultproject.io/) ê°™ì€ ê²ƒì„ë“¤ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œ ë°œê¸‰ì„ í•  ìˆ˜ ìˆë‹¤. ì¸ì¦ì„œ ë°œê¸‰í›„ì—ë„ ë§Œë£Œê°€ ë˜ê¸° ì „ì— ë°”ë¡œ ê°±ì‹ ì„ ìë™ìœ¼ë¡œ í•œë‹¤. \n\n\n### êµ¬ì„±\n![certmanager](http://docs.cert-manager.io/en/latest/_images/high-level-overview.png)\n\n### ì‚¬ì „ì¤€ë¹„ì‚¬í•­\n* [helm](https://docs.helm.sh/using_helm/#installing-helm-client)\n* k8s cluster (1.7+) - CRD ì‚¬ìš©ì´ ê°€ëŠ¥í•´ì•¼í•¨\n\n### ì„¤ì¹˜\n```\n$ helm install --name cert-manager --version v0.3.1 \\\n    --namespace kube-system stable/cert-manager\n\n$ helm status cert-manager\nLAST DEPLOYED: Fri Jun 15 10:02:45 2018\nNAMESPACE: kube-system\nSTATUS: DEPLOYED\n\nRESOURCES:\n==> v1/Pod(related)\nNAME                                        READY  STATUS   RESTARTS  AGE\ncert-manager-cert-manager-5f76b676b4-5tdh8  1/1    Running  0         2d\n\n==> v1/ServiceAccount\nNAME                       SECRETS  AGE\ncert-manager-cert-manager  1        28d\n\n==> v1beta1/CustomResourceDefinition\nNAME                               AGE\ncertificates.certmanager.k8s.io    28d\nclusterissuers.certmanager.k8s.io  28d\nissuers.certmanager.k8s.io         28d\n\n==> v1beta1/ClusterRole\ncert-manager-cert-manager  28d\n\n==> v1beta1/ClusterRoleBinding\nNAME                       AGE\ncert-manager-cert-manager  28d\n\n==> v1beta1/Deployment\nNAME                       DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE\ncert-manager-cert-manager  1        1        1           1          28d\n\n\nNOTES:\ncert-manager has been deployed successfully!\n\nIn order to begin issuing certificates, you will need to set up a ClusterIssuer\nor Issuer resource (for example, by creating a 'letsencrypt-staging' issuer).\n\nMore information on the different types of issuers and how to configure them\ncan be found in our documentation:\n\nhttps://cert-manager.readthedocs.io/en/latest/reference/issuers.html\n\nFor information on how to configure cert-manager to automatically provision\nCertificates for Ingress resources, take a look at the `ingress-shim`\ndocumentation:\n\nhttps://cert-manager.readthedocs.io/en/latest/reference/ingress-shim.html\n```\n\n### ì¸ì¦ì„œ ì„¤ì • ë° ë°°í¬\n\nì¸ì¦ì„œ ë“±ë¡ ë° ë§Œë£Œì‹œ notië¥¼ ë°›ê¸° ìœ„í•œ ë³€ìˆ˜ ì„¤ì •ì„ í•œë‹¤.\n```\n$ export EMAIL=zaction@sk.com\n```\nê·¸ë¦¬ê³  issuer manifestë¥¼ ë°°í¬í•œë‹¤.  \n(letsencrypt-issuer.yaml)\n```\n# Copyright 2018 Google Inc.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     https://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\napiVersion: certmanager.k8s.io/v1alpha1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\nspec:\n  acme:\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    email: ''\n    privateKeySecretRef:\n      name: letsencrypt-staging\n    http01: {}\n---\napiVersion: certmanager.k8s.io/v1alpha1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    email: ''\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    http01: {}\n```\n\në‘ê°œì˜ endpointë¥¼ ìƒì„±í•œë‹¤. (Staging, Prod)\n\n```\n$ sed -e \"s/email: ''/email: $EMAIL/g\" letsencrypt-issuer.yaml | \\\n    kubectl apply -f-\nclusterissuer \"letsencrypt-staging\" created\nclusterissuer \"letsencrypt-prod\" created\n```\n\nWeb Appì„ HTTP Ingress í˜•íƒœë¡œ ë°°í¬í•œë‹¤. TLSë°œê¸‰ì „ì— ë¯¸ë¦¬ HTTP(80) Ingressë¥¼ ë°°í¬í•´ì•¼ í•œë‹¤. ì´í›„ Let's encrypt TLSë°°í¬ í›„ TLS specì„ ì¶”ê°€í•˜ê³  ì¬ë°°í¬ë¥¼ í•´ì•¼í•œë‹¤. \n\n```\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: auth-ingress\nspec:\n  rules:\n  - host: auth.dev.action.cloudz.co.kr\n    http:\n      paths:\n      - backend:\n          serviceName: faas-auth-service\n          servicePort: 8081\n        path: /\n``` \n\n### TLS ì¸ì¦ì„œ ë°œê¸‰\nì¸ì¦ì„œë¥¼ ë°œê¸‰í• ë•ŒëŠ” ìœ„ì—ì„œ ë§Œë“  Ingressë¡œ ìƒì„±í•˜ê³ namespaceë³„ ìƒì„±ì´ í•„ìš”í•˜ë‹¤.\n\n```\napiVersion: certmanager.k8s.io/v1alpha1\nkind: Certificate\nmetadata:\n  name: auth-dev-tls\n  namespace: auth #### namespaceë³„ ìƒì„±\nspec:\n  secretName: auth-dev-tls\n  issuerRef:\n    name: letsencrypt-prod\n    kind: ClusterIssuer\n  commonName: auth.dev.action.cloudz.co.kr\n  dnsNames:\n  - auth.dev.action.cloudz.co.kr\n  acme:\n    config:\n    - http01:\n        ingress: auth-ingress ### ê¸°ì¡´ì— ë§Œë“  HTTP ingress ëª…\n      domains:\n      - auth.dev.action.cloudz.co.kr\n```\n\n```\n$ kubectl apply -f auth-dev-tls.yaml\ncertificate \"auth-dev-tls\" created\n```\n\nì´í›„ TLS ìƒì„± ìƒíƒœë¥¼ í™•ì¸í•œë‹¤. ì´\u0010ë•Œ Messageì—ì„œ ```Normal   CeritifcateIssued     Certificated issued successfully``` ë¬¸êµ¬ê°€ í™•ì¸ë˜ë©´ ì¸ì¦ì„œ ë°œê¸‰ì´ ì •ìƒì ìœ¼ë¡œ ë˜ì—ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.  \nì´ë•Œ ë°œê¸‰ë˜ëŠ” ì‹œê°„ì´ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì— ë”°ë¼ 1~5ë¶„ì •ë„ ì†Œìš”ë ë•Œë¡œ ìˆëŠ”ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. \n``` \n$ kubectl describe -f auth-dev-tls.yaml\n...\nType     Reason                Message\n----     ------                -------\nWarning  ErrorCheckCertificate Error checking existing TLS certificate: secret \"auth-dev-tls\" not found\nNormal   PrepareCertificate    Preparing certificate with issuer\nNormal   PresentChallenge      Presenting http-01 challenge for domain foo.kubernetes.tips\nNormal   SelfCheck             Performing self-check for domain auth.dev.action.cloudz.co.kr\nNormal   ObtainAuthorization   Obtained authorization for domain auth.dev.action.cloudz.co.kr\nNormal   IssueCertificate      Issuing certificate...\nNormal   CeritifcateIssued     Certificated issued successfully\n```\n\nsecretì´ ìƒì„±ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n\n```\n$ kubectl get secret | grep tls\nauth-dev-tls                 kubernetes.io/tls                     2         3h\n```\n\nì´í›„ ìœ„ì—ì„œ ë§Œë“  Ingressì— TLSë¥¼ ì ìš©í•œë‹¤.\n```\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: auth-ingress\n  annotations:\n      ingress.bluemix.net/hsts: enabled=true maxAge=<31536000> includeSubdomains=true\n      ingress.bluemix.net/redirect-to-https: \"True\"\nspec:\n  rules:\n  - host: auth.dev.action.cloudz.co.kr\n    http:\n      paths:\n      - backend:\n          serviceName: faas-auth-service\n          servicePort: 8081\n        path: /\n  tls:\n  - hosts:\n    - auth.dev.action.cloudz.co.kr\n    secretName: auth-dev-tls\n```\n\nìœ„ ì„¤ì •ì„ ì ìš©í•˜ê³  ìƒíƒœë¥¼ í™•ì¸í•œë‹¤.\n```\n$ kubectl apply -f auth-tls-ingress.yaml\n\n$ kubectl get ing\nNAME           HOSTS                          ADDRESS         PORTS     AGE\nauth-ingress   auth.dev.action.cloudz.co.kr   10.1.1.182   80, 443   14h\n```\n\n![cert-tls](/img/cert-tls.png)\n\n## ì •ë¦¬\nì„¤ê³„ì˜ ì‹¤ìˆ˜ë¡œ ì‹œì‘ë˜ì—ˆì§€ë§Œ ì •ë¦¬í•˜ë‹¤ë³´ë‹ˆ ì¸ì¦ì„œ ê°±ì‹ ì´ ìë™ì„ ëœë‹¤ëŠ” ì ê³¼ ë˜í•œ Kubernetesí™˜ê²½ì—ì„œ TLSê´€ë¦¬ê°€ ê°„í¸í•˜ë‹¤ëŠ”ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤. ì¸ì¦ì„œ ë¹„ìš©ì„ ì•„ë‚€ê²ƒë„ í•˜ë‚˜ì˜ ì„±ê³¼ì´ê¸°ë„ í•˜ë‹¤. ì¸ì¦ì„œëŠ” ì¨ì•¼í•˜ê² ê³  ì •ë§ ë§ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤ì„ ìƒì„±/ì‚­ì œë¥¼ ìƒì‹œ í•´ì•¼í•˜ëŠ” í™˜ê²½ì´ë¼ë©´ í•œë²ˆ ì ìš©í•´ë³¼ë§Œí•œ ê°€ì¹˜ê°€ ìˆëŠ”ê²ƒ ê°™ë‹¤."
    },
    {
      "id": "kubernetes/operator/",
      "metadata": {
        "permalink": "/kubernetes/operator/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-09-operator.md",
        "source": "@site/blog/2018-07-09-operator.md",
        "title": "Operators & CRDs(CustomResourceDefinitions) on Kubernetes",
        "description": "Operators, CRD(Custom Resource Definitions)ì— ëŒ€í•´ì„œ ì•Œ ìˆ˜ ìˆë‹¤.",
        "date": "2018-07-09T00:00:00.000Z",
        "formattedDate": "July 9, 2018",
        "tags": [
          {
            "label": "Operators",
            "permalink": "/tags/operators"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "CRDs",
            "permalink": "/tags/cr-ds"
          },
          {
            "label": "CustomResourceDefinitions",
            "permalink": "/tags/custom-resource-definitions"
          }
        ],
        "readingTime": 10.355,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Operators & CRDs(CustomResourceDefinitions) on Kubernetes",
          "comments": true,
          "classes": "wide",
          "description": "Operators, CRD(Custom Resource Definitions)ì— ëŒ€í•´ì„œ ì•Œ ìˆ˜ ìˆë‹¤.",
          "slug": "kubernetes/operator/",
          "date": "2018-07-09T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Operators",
            "Kubernetes",
            "CRDs",
            "CustomResourceDefinitions"
          ]
        },
        "prevItem": {
          "title": "Cert-manager",
          "permalink": "/kubernetes/cert-manager/"
        },
        "nextItem": {
          "title": "Cilium",
          "permalink": "/kubernetes/cilium-1/"
        }
      },
      "content": "## Operators in Kubernetes\n### Operators ë€?\n\nì •ì˜([Definition](https://coreos.com/operators/)) : Kubernetes Application ì„ íŒ¨í‚¤ì§•, ë°°í¬, ê´€ë¦¬í•˜ëŠ” ë°©ë²•. Helmê³¼ëŠ” ì¡°ê¸ˆ ë‹¬ë¼ ë”°ë¡œ ì´ì•¼ê¸° í•´ë³´ê³ ì í•œë‹¤.\n\nê¸°ë³¸ì ìœ¼ë¡œ Kubernetest Applicationì€ kubernetesì— ì˜í•´ ë°°í¬ë˜ê³  kubectê³¼ kube-APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬í•œë‹¤.\n\nê²°ë¡ ì ìœ¼ë¡œ ë§í•˜ë©´ Kubernetesì— ë‚´ê°€ ë§Œë“  applicationì„ ì„œë¹„ìŠ¤í•˜ê³  ê´€ë¦¬í•˜ë ¤ë©´ ê²°êµ­ Kubernetesì˜ APIë“¤ì„ ëª¨ë‘ ì´í•´í•˜ê³  ì‚¬ìš©í• ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ì¼ë°˜ì ì¸ ê°œë°œìì—ê²Œ ì§„ì…ì¥ë²½ì´ ì–´ëŠì •ë„ ìˆë‹¤ê³  ë³´ì—¬ì§€ë©° ì´ë¥¼ ëª¨ë‘ ì´í•´ì‹œí‚¤ëŠ”ê²ƒë„ ì¡°ì§ì ì¸ ì¸¡ë©´ì—ì„œëŠ” ë‚­ë¹„ì¼ìˆ˜ ë„ ìˆë‹¤. ê·¸ë˜ì„œ Helmë“±ì„ í†µí•œ applicationë°°í¬ ì „ëµì„ ì„¸ìš°ê¸°ë„ í•˜ì§€ë§Œ ì´ê²ƒë„ í•œê³„ê°€ ìˆì„ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ OperatorëŠ” Kubernetesìƒì—ì„œ applicationì„ ê´€ë¦¬í•˜ëŠ” ëŸ°íƒ€ì„ì´ë¼ê³  ìƒê°í•˜ëŠ”ê²Œ ë§ëŠ”ê²ƒ ê°™ë‹¤.\n\n![etcd](https://coreos.com/sites/default/files/inline-images/Overview-etcd_0.png)\n\n## Operators\n\nOperatorsëŠ” applicationë§ˆë‹¤ ìš´ì˜ì •ë³´ë¥¼ ë„£ì„ìˆ˜ ìˆë‹¤.\n\nKubernetes ì— ë°°í¬ëœ ì‘ìš©í”„ë¡œê·¸ë¨ì˜ ëª¨ë“  íŠ¹ì„±ì„ ì•Œ í•„ìš”ê°€ ì—†ê³  ì´ë¥¼ í†µí•´ ì‚¬ìš©ìëŠ” ë§¤ë‹ˆì§€ë“œ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ê²½í—˜(ê¸°ì¡´ IaaS/PaaSê´€ë¦¬ì™€ ìœ ì‚¬)ê³¼ ìœ ì‚¬í•˜ê²Œ ìš´ì˜ì´ ê°€ëŠ¥í•˜ë‹¤.  \n\nOperatorê°€ ë°°í¬ë˜ë©´ Kubernetes APIí™•ì¥ ê°œë…ì¸ CRDs(Custom\nResource Definitions)ì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬í• ìˆ˜ ìˆë‹¤.\nKubernetesì— Stateful ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•˜ëŠ” ë‹¨ìˆœí•˜ê³  ì¢‹ì€ ë°©ë²•ì´ ë ìˆ˜ ìˆë‹¤.  \n\nì˜ˆë¥¼ ë“¤ë©´, Postgres í´ëŸ¬ìŠ¤í„°, Prometheus í´ëŸ¬ìŠ¤í„°, Etcd í´ëŸ¬ìŠ¤í„° ê°™ì´ ìš´ì˜ì¸¡ë©´ì˜ applicationë“¤ì„ ìœ ì§€, ìš´ì˜í•˜ëŠ”ë° ì“°ì¼ìˆ˜ ìˆë‹¤. (ìì„¸í•œê±´ ë’¤ìª½ ì˜ˆì‹œë¡œ ì„¤ëª…í•˜ê² ë‹¤)\n\nê·¸ëŸ¬ë©´ ë¨¼ì € CRDs(Custom Resource Definitions)ì— ëŒ€í•´ì„œ ë¨¼ì € ì•Œì•„ë³¸ë‹¤. CRDsì— ëŒ€í•´ì„œëŠ” ë³„ë„ë¡œ ì •ë¦¬í•˜ë ¤ í•˜ë‹¤ê°€ ë‚´ìš©ì´ ë§ì´ ì•Šì•„ í•µì‹¬ì ì¸ ë‚´ìš©ë§Œ ê°™ì´ ì ì–´ë³¸ë‹¤.\n\n* Custom Resource Definitions(a.k.a CRDs)\n* k8s Objectë¥¼ í™•ì¥í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•\n* CRDsëŠ” Kubernetesì˜ í™•ì¥ ê¸°ëŠ¥\n* Kubernetes ì‚¬ìš©ìê°€ í´ëŸ¬ìŠ¤í„°ë‚´ì—ì„œ ì§ì ‘ custom Objectë¥¼ yamlí˜•íƒœë¡œ ìƒì„±, ìˆ˜ì •, ì‚­ì œ, ì‚¬ìš©í• ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê¸°ëŠ¥  \n  * K8s database(etcd)ì™€ APIë¥¼ ê·¸ëŒ€ë¡œ í™œìš©í•  ìˆ˜ ìˆìŒ)\n  * CRUD ê°€ëŠ¥ (Create, Read, Update, Delete)\n* ëª¨ë“  í´ëŸ¬ìŠ¤í„°ì— ë™ì ìœ¼ë¡œ resource ë“±ë¡/ì‚­ì œ ê°€ëŠ¥\n* OperatorsëŠ” CRDsë¥¼ í¬í•¨í•˜ê³  ìˆìŒ\n  * Operatorë¥¼ ì¶”ê°€í•˜ë©´ CRDsê°€ ë“±ë¡ë¨\n* Resource ë‹¹ í•˜ë‚˜ì˜ API ë²„ì „ë§Œ ì§€ì›(~1.10ë²„ì „, 1.11ë²„ì „ ì´í›„ ê°œìˆ˜ ì œí•œ ì—†ì–´ì§)\n* 1.8+ ì´í›„ë¶€í„° JSON ìŠ¤í‚¤ë§ˆ ìœ íš¨ì„± ê²€ì¦ ê°€ëŠ¥\n** *ì£¼ì˜ì‚¬í•­ : etcdê°€ ë³„ë„ ë¶„ë¦¬ëœ managedì„œë¹„ìŠ¤ë‚˜ etcd ì¸ìŠ¤í„´ìŠ¤ê°€ ë¶„ë¦¬ëœ í™˜ê²½ì—ì„œ ì‚¬ìš©ê¶Œê³ **\n\n### ì£¼ìš” í™œìš©ìš©ë„\n* Operators\n* Application ì •ë³´ ì €ì¥\n* RouteRule on istio\n* GameServer on Agones\n\n## CRDs ê´€ë ¨ ë°œí‘œìë£Œ\nhttps://ddiiwoong.github.io/2018/openinfraday18/\n\n### Operators example\n[etcd](https://coreos.com/operators/etcd/docs/latest), [Rook](https://github.com/rook/rook), [Prometheus](https://coreos.com/operators/prometheus/docs/latest), [Vault](https://www.vaultproject.io/), [MySQL](https://github.com/oracle/mysql-operator), [Postgres](https://github.com/CrunchyData/postgres-operator), [Redis](https://github.com/spotahome/redis-operator), [kafka-ë¹„ê³µì‹](https://github.com/nbogojevic/kafka-operator) ë“± Operatorë¡œ ë°°í¬ë ìˆ˜ ìˆëŠ” ì˜ˆì‹œë“¤ì€ í•´ë‹¹ ë§í¬ë¥¼ ë³´ë©´ ìì„¸íˆ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (ì˜¤ë¼í´ì´ ê³µê²©ì ìœ¼ë¡œ K8së¹„ì§€ë‹ˆìŠ¤ë¡œ ë›°ì–´ë“œëŠ”ë“¯í•œ ê·¸ë¦¼ì´ë‹¤â€¦)  \n\nì£¼ë¡œ ì €ì¥ì†Œë‚˜ í‚¤-ë°¸ë¥˜ ìŠ¤í† ì–´, RDBë“±ì˜ ìš´ì˜ì•ˆì •ì„±ì„ ìœ„í•œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ ìœ„í•œê²ƒë“¤ì´ ëŒ€ë¶€ë¶„ì´ë©° ì ì  ë„ì…ì„ í•´ë‚˜ê°€ëŠ” ì¶”ì„¸ì´ê¸´ê²ƒ ê°™ê¸´ í•˜ë‹¤. ì´ë²ˆì— ì§„í–‰í•´ë³´ê³ ì í•˜ëŠ”ê±´ ë¶„ì‚° í‚¤-ë°¸ë¥˜ ìŠ¤í† ì–´ì´ì kubernetesì˜ ë©”ì¸ì €ì¥ì†Œë¡œ ì“°ì´ëŠ” etcd ì´ë‹¤.\n\nê¸°ë³¸ì ìœ¼ë¡œ etcd cluster objectsëŠ” CRDsë¡œ ìƒì„±í•œë‹¤. Kubernetes ê¸°ë³¸ resourceê°€ ì•„ë‹Œ CRDs ì´ê¸° ë•Œë¬¸ì— ì•ˆì •ì„± ì¸¡ë©´ì—ì„œ ë¶ˆì•ˆí•˜ë‹¤ê³  ìƒê°í• ìˆ˜ë„ ìˆë‹¤. í•˜ì§€ë§Œ [User Aggregated API Servers](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/aggregated-api-servers.md) ë¥¼ ì ìš©í•˜ì—¬ ì•ˆì •ì„±, ìœ íš¨ì„± ê²€ì‚¬ ë° ë²„ì „ ê´€ë¦¬ê°€ ê°œì„ ë˜ì—ˆë‹¤ê³  í•œë‹¤. Aggregated APIë¥¼ ì‚¬ìš©í•˜ë©´ ì‚¬ìš©ìì—ê²Œ ìµœì†Œí•œì˜ ì˜í–¥ì„ ì£¼ë©´ì„œ Kubernetes objectsê°€ ìƒì„±ë˜ê±°ë‚˜ ì‚¬ìš©ìê°€ etcd operatorë¥¼ ë°°í¬,ê´€ë¦¬í• ìˆ˜ ìˆë‹¤. (ë§ì´ ê¸¸ì–´ì„œ ê·¸ë ‡ì§€ ê·¸ëƒ¥ etcd í´ëŸ¬ìŠ¤í„° êµ¬ì„±)\n\ní˜„ì¬ í”„ë¡œì íŠ¸ëŠ” ë² íƒ€ë¡œ 0.9.2ê¹Œì§€ ë‚˜ì™€ ìˆìœ¼ë©° RedHatì´ CoreOSë¥¼ í•©ë³‘í•˜ëŠ” ë°”ëŒì— ë¬¸ì„œë“¤ì´ ì—…ë°ì´íŠ¸ê°€ ëŠ¦ì–´ì§€ëŠ”ê²ƒ ê°™ê¸´í•˜ì§€ë§Œ ì¡°ë§Œê°„ì— 1.0ì´ ë‚˜ì˜¬ê²ƒ ê°™ê¸´ í•˜ë‹¤.\n\n### [etcd-operator](https://github.com/coreos/etcd-operator/#overview)\netcd operatorëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ í•œë‹¤.\n\n* Create and Destroy\n* Resize\n* Failover\n* Rolling upgrade\n* Backup and Restore\n\n#### Requirements\n* Kubernetes 1.8+\n* etcd 3.2.13+\n\n### Installation guide\nì„¤ì¹˜ëŠ” ë‹¨ìˆœí•˜ë‹¤. ë¨¼ì € RBACì„¤ì •ì„ í•œë‹¤.\n```\n$ git clone https://github.com/coreos/etcd-operator.git\n$ cd etcd-operator\n$ example/rbac/create_role.sh\n```\nê·¸ë¦¬ê³  etcd-operator ë°°í¬\n\n```\n$ kubectl create -f example/deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: etcd-operator\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        name: etcd-operator\n    spec:\n      containers:\n      - name: etcd-operator\n        image: quay.io/coreos/etcd-operator:v0.9.2\n        command:\n        - etcd-operator\n        # Uncomment to act for resources in all namespaces. More information in doc/clusterwide.md\n        #- -cluster-wide\n        env:\n        - name: MY_POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        - name: MY_POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n```\ndeployment.yaml ë‚´ìš©ì„ ë³´ë©´ CustomResourceDefinitionì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.\netcd-operatorê°€ ìë™ìœ¼ë¡œ CRDë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ CRDë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl get customresourcedefinitions\nNAME                                    KIND\netcdclusters.etcd.database.coreos.com   CustomResourceDefinition.v1beta1.apiextensions.k8s.io\n```\n\n### etcd cluster create/resize/failover/upgrade\noperatorë¥¼ ì´ìš©í•˜ì—¬ etc clusterë¥¼ êµ¬ì„±í•œë‹¤. operatorë¥¼ í†µí•œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ë‚´ìš©ì„ í™•ì¸í•˜ë©´ ì•„ì£¼ ë‹¨ìˆœí•˜ë‹¤. ë²„ì „ê³¼ ì‚¬ì´ì¦ˆë¿ì´ë‹¤.\n```\n$ cat example/example-etcd-cluster.yaml\napiVersion: \"etcd.database.coreos.com/v1beta2\"\nkind: \"EtcdCluster\"\nmetadata:\n  name: \"example-etcd-cluster\"\n  ## Adding this annotation make this cluster managed by clusterwide operators\n  ## namespaced operators ignore it\n  # annotations:\n  #   etcd.database.coreos.com/scope: clusterwide\nspec:\n  size: 3\n  version: \"3.2.13\"\n$ kubectl create -f example/example-etcd-cluster.yaml\netcdcluster.etcd.database.coreos.com/example-etcd-cluster created\n```\n\nìˆœì°¨ì ìœ¼ë¡œ etcd clusterê°€ êµ¬ì„±ë˜ëŠ”ê²ƒì„ ë³¼ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl get pods\nNAME                              READY     STATUS    RESTARTS   AGE\netcd-operator-69b559656f-wrhxz    1/1       Running   0          3h\nexample-etcd-cluster-2kd4t667j5   1/1       Running   0          1m\nexample-etcd-cluster-k4lxm96v7h   1/1       Running   0          1m\nexample-etcd-cluster-lm7mkhvldw   1/1       Running   0          1m\n```\n\nì´ë²ˆì—ëŠ” scale-out í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.  \nexample/example-etcd-cluster.yaml ë‚´ìš©ì—ì„œ ```size: 3``` ì„ ```size: 5``` ë¡œ ë³€ê²½í•˜ê³  ë‹¤ì‹œ ì ìš©í•˜ë©´ 2 nodeê°€ ì¶”ê°€ë¡œ ìƒì„±ëœë‹¤.\n\n```\n$ kubectl apply -f example/example-etcd-cluster.yaml\n$ kubectl get pods\nNAME                              READY     STATUS    RESTARTS   AGE\netcd-operator-69b559656f-wrhxz    1/1       Running   0          3h\nexample-etcd-cluster-2kd4t667j5   1/1       Running   0          9m\nexample-etcd-cluster-2pwm84lrf4   1/1       Running   0          34s\nexample-etcd-cluster-97qk6gs4sp   1/1       Running   0          50s\nexample-etcd-cluster-k4lxm96v7h   1/1       Running   0          9m\nexample-etcd-cluster-lm7mkhvldw   1/1       Running   0          8m\n```\n\në°˜ëŒ€ë¡œ ì¤„ì´ëŠ”ê²ƒë„ ë™ì¼í•˜ë‹¤.\n\nfailover í…ŒìŠ¤íŠ¸ì˜ ê²½ìš°ì—ë„ ê·¸ëƒ¥ podë¥¼ ì‚­ì œí•˜ê±°ë‚˜ workerë¥¼ ë‚ ë¦¬ëŠ”ê²ƒìœ¼ë¡œë„ ë™ì¼í•˜ê²Œ specì„ ìœ ì§€í•˜ëŠ” kubernetes resource íŠ¹ì„±ìœ¼ë¡œ ì¸í•´ ë°”ë¡œ ìƒì„±ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.\n\nì´ë²ˆì—ëŠ” operatorë§Œ ë‚ ë ¤ë³´ê² ë‹¤. ì•„ë˜ì²˜ëŸ¼ operator deploymentë§Œ ì‚­ì œë¥¼ í•´ë„ podsëŠ” ë‚¨ì•„ìˆëŠ”ê²ƒì„ ë³¼ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl delete -f example/deployment.yaml\ndeployment \"etcd-operator\" deleted\ndeployment.extensions \"etcd-operator\" deleted\n$ kubectl get pod\nNAME                              READY     STATUS    RESTARTS   AGE\nexample-etcd-cluster-2kd4t667j5   1/1       Running   0          14m\nexample-etcd-cluster-2pwm84lrf4   1/1       Running   0          5m\nexample-etcd-cluster-97qk6gs4sp   1/1       Running   0          5m\nexample-etcd-cluster-k4lxm96v7h   1/1       Running   0          14m\nexample-etcd-cluster-lm7mkhvldw   1/1       Running   0          13m\n```\n\netcd pod í•˜ë‚˜ë¥¼ ë‚ ë ¤ë³¸ë‹¤. 4ê°œ podë§Œ ë‚¨ì€ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl delete pod example-etcd-cluster-2kd4t667j5 --now\npod \"example-etcd-cluster-2kd4t667j5\" deleted\n$ kubectl get pod\nNAME                              READY     STATUS    RESTARTS   AGE\nexample-etcd-cluster-2pwm84lrf4   1/1       Running   0          9m\nexample-etcd-cluster-97qk6gs4sp   1/1       Running   0          9m\nexample-etcd-cluster-k4lxm96v7h   1/1       Running   0          18m\nexample-etcd-cluster-lm7mkhvldw   1/1       Running   0          17m\n```\n\në‹¤ì‹œí•œë²ˆ operatorë¥¼ ë°°í¬í•˜ê²Œ ë˜ë©´ ì ì‹œí›„ì— 5ê°œë¡œ ë‹¤ì‹œ podê°€ ë³µì›ëœê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl create -f example/deployment.yaml\ndeployment.extensions/etcd-operator created\n$ kubectl get pod\nNAME                              READY     STATUS    RESTARTS   AGE\netcd-operator-69b559656f-8ks8m    1/1       Running   0          44s\nexample-etcd-cluster-2pwm84lrf4   1/1       Running   0          11m\nexample-etcd-cluster-97qk6gs4sp   1/1       Running   0          11m\nexample-etcd-cluster-k4lxm96v7h   1/1       Running   0          20m\nexample-etcd-cluster-kskgvlbsm9   1/1       Running   0          10s\nexample-etcd-cluster-lm7mkhvldw   1/1       Running   0          19m\n```\n\nì—…ê·¸ë ˆì´ë“œì˜ ê²½ìš°ë„ ë‹¤ë¥¸ resourceì™€ ë™ì¼í•˜ê²Œ version ë¶€ë¶„ì„ ë³€ê²½í•˜ì—¬ rolloutì´ ê°€ëŠ¥í•˜ë‹¤.\n\n## ì •ë¦¬\në‹¤ìŒ ì†ŒìŠ¤ë¥¼ í†µí•´ ì§ì ‘ operatorë¥¼ ê°œë°œì´ ê°€ëŠ¥í•˜ë‹¤.  \n(Source: https://coreos.com/operators/)\n\nOperator SDKë¥¼ ì‚¬ìš©í•˜ë©´ Kubernetes API ìƒì„¸ìŠ¤í™ì„ ë°°ìš°ì§€ ì•Šê³ ë„ ì‰½ê²Œ operator ë¹Œë“œê°€ ê°€ëŠ¥í•˜ë‹¤.\në˜í•œ ê´€ë¦¬ë¥¼ ìœ„í•œ Operator Lifecycle Managerë‚˜ Operator Metering ê°™ì€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì¢€ë” ê´€ë¦¬ì¸¡ë©´ì—ì„œ ê°•í™”í•˜ê³ ì í•˜ëŠ” CoreOSì§„ì˜ì˜ ë…¸ë ¥ì´ ë³´ì´ëŠ”ë“¯ í•˜ë‹¤.\n\nì•„ì§ alpha, betaë‹¨ê³„ì˜ operator í”„ë¡œì íŠ¸ë“¤ì´ ëŒ€ë¶€ë¶„ì´ì§€ë§Œ helmì°¨íŠ¸ì™€ ê°™ì´ kubernetes API ìŠ¤í™ì„ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ì‰½ê²Œ ìš´ì˜ìê°€ ê¸°ë°˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ê´€ë¦¬ í• ìˆ˜ ìˆë‹¤ëŠ”ê²ƒìœ¼ë¡œ ë³´ì•„ í–¥í›„ RedHatì´ë‚˜ Oracle ì§„ì˜ì—ì„œ ë³¸ì¸ë“¤ kubernetes ê´€ë ¨ ì œí’ˆë“¤ì„ í™ë³´í•˜ê³  ì„œë¹„ìŠ¤ë¼ì¸ì— í¬í•¨ì‹œí‚¤ëŠ” ë°©í–¥ìœ¼ë¡œ ì ê·¹ì ìœ¼ë¡œ ê°œë°œì„ í•˜ê³  ìˆëŠ”ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. ì•ìœ¼ë¡œ mysql, redis, kakfa ë“±ì„ operatorë¡œ ë°°í¬í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì¼ì´ ë” ë§ì•„ ì§ˆê²ƒ ê°™ë‹¤."
    },
    {
      "id": "kubernetes/cilium-1/",
      "metadata": {
        "permalink": "/kubernetes/cilium-1/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-06-cilium-1.md",
        "source": "@site/blog/2018-07-06-cilium-1.md",
        "title": "Cilium",
        "description": "Ciliumì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
        "date": "2018-07-06T00:00:00.000Z",
        "formattedDate": "July 6, 2018",
        "tags": [
          {
            "label": "Cilium",
            "permalink": "/tags/cilium"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "network policy",
            "permalink": "/tags/network-policy"
          },
          {
            "label": "Istio",
            "permalink": "/tags/istio"
          },
          {
            "label": "BPF",
            "permalink": "/tags/bpf"
          },
          {
            "label": "CNI",
            "permalink": "/tags/cni"
          }
        ],
        "readingTime": 16.09,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Cilium",
          "comments": true,
          "classes": "wide",
          "description": "Ciliumì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
          "slug": "kubernetes/cilium-1/",
          "date": "2018-07-06T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Cilium",
            "Kubernetes",
            "network policy",
            "Istio",
            "BPF",
            "CNI"
          ]
        },
        "prevItem": {
          "title": "Operators & CRDs(CustomResourceDefinitions) on Kubernetes",
          "permalink": "/kubernetes/operator/"
        },
        "nextItem": {
          "title": "Spinnaker on Kubernetes #1",
          "permalink": "/kubernetes/spinnaker-advanced-1/"
        }
      },
      "content": "## Cilium ëˆ„êµ¬ëƒ ë„Œ?\nì²˜ìŒì— ë†€ëë‹¤. ë²ˆì—­í•˜ë©´ 'ìê¶', 'ì„¬ëª¨', 'ì†ëˆˆì¹'ë“± ìµìˆ™ì¹˜ ì•Šì€ ë‹¨ì–´ë¼ì„œ ë†€ëì§€ë§Œ ì°¨ê·¼íˆ ë³´ë‹¤ë³´ë‹ˆ ê²°êµ­ OSë‚´ë¶€(ë¦¬ëˆ…ìŠ¤ ì»¤ë„)ì—ì„œë¶€í„° ì»¨í…Œì´ë„ˆê°„ ë˜ëŠ” ì™¸ë¶€ì™€ì˜ ì—°ê²°ì„ ë³´í˜¸í•˜ëŠ” ì—­í• ì´ë¼ê³  í•˜ë‹ˆ ì´í•´ê°€ ë˜ëŠ” ê²ƒ ê°™ë‹¤.\n\ní™ˆí˜ì´ì§€ì— ì •ì˜ëœ ë‚´ìš©ì„ ë³´ë©´ ì•„ë˜ ë‚´ìš©ê³¼ ê°™ë‹¤. \n\n>[Cilium](https://cilium.readthedocs.io/en/v1.1/intro/#what-is-cilium) - Docker ë° Kubernetesì™€ ê°™ì€ Linux ì»¨í…Œì´ë„ˆ ê´€ë¦¬ í”Œë«í¼ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ëœ ì‘ìš© í”„ë¡œê·¸ë¨ ì„œë¹„ìŠ¤ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ë³´í˜¸í•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´\n\ní˜ë¶ì— [í•œêµ­ ë¦¬ëˆ…ìŠ¤ ì‚¬ìš©ì ê·¸ë£¹](https://www.facebook.com/groups/korelnxuser/)ì—ì„œë„ [Tommy Lee](https://www.facebook.com/tommy.lee.98229)ë‹˜ì´ë‚˜ [ì†¡ì°½ì•ˆ](https://www.facebook.com/changan.song)ë‹˜ì´ ëª‡ëª‡ ê²Œì‹œë¬¼ì„ ì˜¬ë ¤ì£¼ì…”ì„œ ê´€ì‹¬ìˆê²Œ ë³´ë˜ì¤‘ì— ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì„ ë³´ê³  ì´ê±°ë‹¤ í•˜ê³  íŒŒë³´ê¸° ì‹œì‘í–ˆë‹¤.\n\n>Ciliumì€ Docker ë° Kubernetesì™€ ê°™ì€ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ í”„ë ˆì„ ì›Œí¬ì— API ê¸°ë°˜ì˜ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ í•„í„°ë§ì„ ì œê³µí•˜ë©°, \në˜í•œ, BPFë¼ëŠ” ìƒˆë¡œìš´ Linux ì»¤ë„ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ/POD IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ê³„ì¸µ ë° ì‘ìš© í”„ë¡œê·¸ë¨ ê³„ì¸µ ë³´ì•ˆ ì •ì±…ì„ ì •ì˜ ë° ì ìš©í•˜ëŠ” ê²ƒì— ìˆì–´ì„œ ê°„ë‹¨í•˜ë©´ì„œ íš¨ìœ¨ì ì¸ ë°©ë²•ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\nìœ—ë¶„ë“¤ì²˜ëŸ¼ ì»¤ë„ ìì²´ë¥¼ ë¶„ì„í•˜ê³  ê³µë¶€í•˜ê³  ê¸°ì—¬í•˜ë ¤ë©´ ì†Œìš”ë˜ëŠ” ì‹œê°„ì´ ë” ê±¸ë¦´ê±° ê°™ê³  ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•˜ê³  ê°œë°œí•˜ëŠ” ì…ì¥ì—ì„œëŠ” ë‚´ í”„ë¡œì íŠ¸ì— ì ìš© ê°€ëŠ¥ì„±ì„ ê²€ì¦í•˜ëŠ”ê²ƒì´ ë‚˜ì„ê²ƒ ê°™ì•„ ì •ë¦¬ë¥¼ í•´ë³¸ë‹¤.\n\niptablesì„ ê¸°ë°˜ìœ¼ë¡œ IPì™€ Portê¸°ë°˜ì˜ ì „í†µì ì¸ í¬ì›Œë”© ê¸°ìˆ ì€ ë²Œì¨ 20ë…„ì´ë¼ëŠ” ì„¸ì›”ë™ì•ˆ ë„ë¦¬ ì‚¬ìš©ë˜ì–´ ì™”ë‹¤. íŠ¹íˆ í¼ë¸”ë¦­/í”„ë¼ì´ë¹— í´ë¼ìš°ë“œ ì œí’ˆêµ°ë“¤ ëª¨ë‘ iptablesê¸°ë°˜ì˜ Security Groupë“±ì„ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ê³  ìˆê³  Kubernetes ë§ˆì €ë„ CNI í•µì‹¬ìœ¼ë¡œ iptablesì„ í™œìš©í•˜ê³  ìˆë‹¤.  \n\në™ì ìœ¼ë¡œ ë³€í™”í•˜ê³  ë§¤ìš° ë³µì¡í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹œëŒ€ì— ì „í†µì ì¸ ë°©ì‹ì˜ IP, Portê´€ë¦¬ëŠ” ë¹„íš¨ìœ¨ì ì¸ ì¸¡ë©´ì´ ì—†ì§€ ì•Šë‹¤. BPF(ì•„ë˜ì¸ìš©)ì„ í™œìš©í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ë‚´ì—ì„œ ë°ì´í„° í¬ì›Œë”©ì„ í•  ìˆ˜ ìˆê³  Kubernetes Serviceê¸°ë°˜ Load Balancingì´ë‚˜ istioì™€ ê°™ì€ Service Meshë¥¼ ìœ„í•œ Proxy Injection ì„ í†µí•´ ì—¬ëŸ¬ í™œìš©ì„ í•  ìˆ˜ ìˆì„ê±°ë¼ê³  Cilium í”„ë¡œì íŠ¸ëŠ” ì´ì•¼ê¸° í•˜ê³  ìˆë‹¤. \n\n> ë²„í´ë¦¬ íŒ¨í‚· í•„í„°(Berkeley Packet Filter, BPF)\n> \n>BPFëŠ” ë²„í´ë¦¬ íŒ¨í‚· í•„í„°(Berkeley Packet Filter)ì˜ ì¤„ì„ë§ì´ë‹¤. ì´ë¦„ ê·¸ëŒ€ë¡œ íŒ¨í‚·ì„ ê±¸ëŸ¬ë‚´ëŠ” í•„í„°ì´ë‹¤. ê·¸ëŸ°ë° BSDì—ì„œì˜ BPFëŠ” ë„¤íŠ¸ì›Œí¬ íƒ­(ë¦¬ëˆ…ìŠ¤ì˜ PF_PACKET)ê¹Œì§€ ì•„ìš°ë¥´ëŠ” ê°œë…ì´ë‹¤. ì˜›ë‚  ì˜›ì ì— ìœ ë‹‰ìŠ¤ì—ëŠ” CSPF(CMU/Stanford Packet Filter)ë¼ëŠ” ê²Œ ìˆì—ˆëŠ”ë° BPFë¼ëŠ” ìƒˆ êµ¬ì¡°ê°€ ì´ë¥¼ ëŒ€ì²´í–ˆë‹¤. ì´í›„ ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ íƒ­ì„ ë‚˜ë¦„ì˜ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ê³  íŒ¨í‚· í•„í„° ë¶€ë¶„ë§Œ ê°€ì ¸ì™”ë‹¤. ë¦¬ëˆ…ìŠ¤ì˜ íŒ¨í‚· í•„í„°ë¥¼ ë¦¬ëˆ…ìŠ¤ ì†Œì¼“ í•„í„°ë§(LSF: Linux Socket Filtering)ì´ë¼ê³ ë„ í•œë‹¤.  \n(ë°œì·Œ) https://wariua.github.io/facility/extended-bpf.html \n\nCiliumì€ Dockercon 2017ì—ì„œ ìµœì´ˆ [announce](https://www.youtube.com/watch?v=ilKlmTDdFgk)ë¥¼ í•˜ì˜€ê³  2018ë…„ 4ì›” 24ì¼ì— 1.0ì´ ì •ì‹ Releaseëœ ì´í›„ ë§ì€ ê´€ì‹¬ì„ ë°›ì„ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ì–´ ì‹¤ì œ ì„œë¹„ìŠ¤ì— ì ìš©í•´ë³¼ í•„ìš”ê°€ ìˆì„ê±° ê°™ì•„ minikubeë¡œ í…ŒìŠ¤íŠ¸í•œ ë‚´ìš©ì„ ë„ì ¹ì—¬ ë³¸ë‹¤. \n\n## Cilium Architecture\n![Cilium Architecture](/img/cilium_arch.png)\n\n## Main Feature\n* ê³ íš¨ìœ¨ BPF Datapath  \n  * ëª¨ë“  ë°ì´í„° ê²½ë¡œê°€ í´ëŸ¬ìŠ¤í„° ì „ì²´ì— ì™„ì „ ë¶„ì‚°\n  * Envoyê°™ì€ proxy injection ì œê³µ, ì¶”í›„ sidecar proxy í˜•íƒœ ì œê³µì˜ˆì •\n* CNI, CMM plugins  \n  * Kubernetes, Mesos, Dockerì— ì‰½ê²Œ í†µí•©ê°€ëŠ¥\n* Packet, API ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ  \n  íŒ¨í‚·ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆê³¼ API ì¸ì¦ì„ ê²°í•©í•˜ì—¬ ì „í†µì ì¸ íŒ¨í‚·ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆê³¼ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ëª¨ë‘ì—ê²Œ ë³´ì•ˆ ì œê³µê°€ëŠ¥  \n  * [IDê¸°ë°˜](http://docs.cilium.io/en/doc-1.0/concepts/#arch-id-security) - Source IPì—ë§Œ ì˜ì¡´í•˜ì§€ ì•Šê³  ëª¨ë“ íŒ¨í‚·ì— workload identityë¥¼ encodingí•˜ì—¬ ì‹ë³„ì„± ê°•í™”  \n  * [IP/CIDRê¸°ë°˜](http://docs.cilium.io/en/doc-1.0/policy/language/#ip-cidr-based)ì´ì™¸ì—ë„ [Kubernetes Serviceê¸°ë°˜](http://docs.cilium.io/en/doc-1.0/policy/language/#services-based)ìœ¼ë¡œ ì •ì±… ì„¤ì •ê°€ëŠ¥\n  * L7ê¸°ë°˜ [APIë³´ì•ˆ](http://docs.cilium.io/en/doc-1.0/policy/language/#layer-7-examples) ì ìš©ê°€ëŠ¥\n* ë¶„ì‚°,í™•ì¥ê°€ëŠ¥í•œ Load Balacing\n  BPFë¥¼ ì‚¬ìš©í•œ ê³ ì„±ëŠ¥ L3,L4 Load Balancer ì œê³µ\n  (Hasing, Weighted round-robin)\n  * kube-proxy ëŒ€ì²´ - Kubernetes ClusterIPê°€ ìƒì„±ë ë•Œ BPFê¸°ë°˜ìœ¼ë¡œ ìë™ìœ¼ë¡œ ì ìš©ë¨ \n  * [API driven](http://docs.cilium.io/en/doc-1.0/api/) - ì§ì ‘ APIë¥¼ í™œìš©í•˜ì—¬ í™•ì¥ê°€ëŠ¥\n* ë‹¨ìˆœí™”ëœ ë„¤íŠ¸ì›Œí¬ ëª¨ë¸  \n  Overlay/VXLAN, Direct/Native Routing ì§€ì›\n* ê°€ì‹œì„±  \n   * [Microscope](https://github.com/cilium/microscope) - í´ëŸ¬ìŠ¤í„° ë ˆë²¨ì—ì„œ ëª¨ë“  ì´ë²¤íŠ¸ í•„í„°ë§ ê°€ëŠ¥\n   * APIê¸°ë°˜ ê°€ì‹œì„± ì œê³µ\n* ìš´ì˜\n  * í´ëŸ¬ìŠ¤í„° í—¬ìŠ¤ì²´í¬ - HTTP, ICMPê¸°ì¤€ í´ëŸ¬ìŠ¤í„° latency ì²´í¬ê°€ëŠ¥\n  * Prometheus í†µí•© - ëª¨ë“  ë©”íŠ¸ë¦­ì„ Prometheusë¡œ ì „ë‹¬ê°€ëŠ¥\n  * í´ëŸ¬ìŠ¤í„° ë¶„ì„ ë° [ë¦¬í¬íŠ¸íˆ´](http://docs.cilium.io/en/doc-1.0/troubleshooting/#cluster-diagnosis-tool) \n\n## Requirement\n- kubectl >= 1.7.0\n- minikube >= 0.22.3\n\n[kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) ì„¤ì¹˜ì™€ [minikube](https://github.com/kubernetes/minikube/releases) êµ¬ì„±ì€ ë³„ë„ë¡œ í•´ì•¼í•œë‹¤.\n\n## Start minikube\në„‰ë„‰í•˜ê²Œ 4GB ì´ìƒ ë©”ëª¨ë¦¬ë¡œ minikubeë¥¼ êµ¬ë™í•œë‹¤.\n```\n$ minikube start --kubernetes-version v1.9.0 --network-plugin=cni --extra-config=kubelet.network-plugin=cni --memory=5120 \n```\n\n## Check minikube cluster status\nminikubeêµ¬ì„±ì´ ì™„ë£Œë˜ë©´ ì•„ë˜ì™€ ê°™ì´ í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ í™•ì¸í• ìˆ˜ ìˆë‹¤. \n```\n$ kubectl get cs\nNAME                 STATUS    MESSAGE              ERROR\ncontroller-manager   Healthy   ok\nscheduler            Healthy   ok\netcd-0               Healthy   {\"health\": \"true\"}\n```\n\n## Install etcd (dependency of cilium)\ncilium ì˜ì¡´ì„±ì„ ìœ„í•´ etcdë¥¼ ë³„ë„ë¡œ ë°°í¬í•œë‹¤. \n```\n$ kubectl create -n kube-system -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/addons/etcd/standalone-etcd.yaml  \nservice \"etcd-cilium\" created\nstatefulset.apps \"etcd-cilium\" created\n```\n\n## Check all pods (etcd)\nëª¨ë“  podê°€ ```Running``` ìƒíƒœì¸ì§€ í™•ì¸í•œë‹¤.\n```\n$ kubectl get pods --all-namespaces\nNAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE\nkube-system   etcd-cilium-0                      1/1       Running   0          1m\nkube-system   etcd-minikube                      1/1       Running   0          3m\nkube-system   kube-addon-manager-minikube        1/1       Running   0          4m\nkube-system   kube-apiserver-minikube            1/1       Running   0          3m\nkube-system   kube-controller-manager-minikube   1/1       Running   0          3m\nkube-system   kube-dns-86f4d74b45-lhzfv          3/3       Running   0          4m\nkube-system   kube-proxy-tcd7h                   1/1       Running   0          4m\nkube-system   kube-scheduler-minikube            1/1       Running   0          4m\nkube-system   storage-provisioner                1/1       Running   0          4m\n```\n\n## Install Cilium\nKubernetes í´ëŸ¬ìŠ¤í„°ì— Ciliumì„ ì¸ìŠ¤í†¨í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ DaemonSet í˜•íƒœë¡œ ë°°í¬ë˜ê¸° ë•Œë¬¸ì— Nodeë‹¹ í•œê°œì˜ Cilium Podë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. Ciliumì€ ```kube-system``` namespaceì—ì„œ ì‹¤í–‰ëœë‹¤.\n```\n$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/1.9/cilium.yaml\nconfigmap \"cilium-config\" created\nsecret \"cilium-etcd-secrets\" created\ndaemonset.extensions \"cilium\" created\nclusterrolebinding.rbac.authorization.k8s.io \"cilium\" created\nclusterrole.rbac.authorization.k8s.io \"cilium\" created\nserviceaccount \"cilium\" created\n```\nkube-system namespaceì— RBACì„¤ì •ê³¼ í•¨ê»˜ Ciliumì´ ë°°í¬ë˜ê³ , ConfigMap, DaemonSet í˜•íƒœë¡œ ë°°í¬ê°€ ëœë‹¤. \n\n## Check deployment\n\nCilium Deploymentê°€ ```READY``` ìƒíƒœë¡œ ë°”ë€”ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.\n\n\n```\n$ kubectl get daemonsets -n kube-system\nNAME      DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\ncilium    1         1         1         1            0           <none>          2m\n```\n\n## Deploy Demo App.\n\nì•„ë˜ ë°ëª¨ê·¸ë¦¼ì„ ë³´ë©´ ìŠ¤íƒ€ì›Œì¦ˆì˜ ì˜ê°ì„ ë°›ì•„ì„œì¸ì§€ deathstar, xwing ë“±ìœ¼ë¡œ êµ¬ë¶„í•œê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. deathstar deploymentsì˜ ê²½ìš° 80í¬íŠ¸ë¡œ http ì›¹ì„œë²„ê°€ 2ê°œì˜ pod replicaë¡œ Load Balancingë˜ê³  ìˆë‹¤. deathstar ì„œë¹„ìŠ¤ëŠ” ìš°ì£¼ì„ ì´ ì°©ë¥™í• ìˆ˜ ìˆë„ë¡ í™œì£¼ë¡œë¥¼ ì„œë¹„ìŠ¤í•˜ê³  ìˆë‹¤. í•˜ì§€ë§Œ ì œêµ­êµ°ì˜ tiefighter ë§Œ ì°©ë¥™í•˜ë„ë¡ í•´ì•¼í•˜ë¯€ë¡œ ë³´ì•ˆì„¤ì •ì„ í•´ì•¼í•˜ëŠ” ìƒí™©ì´ë‹¤. \n\n![starwars](https://cilium.readthedocs.io/en/v1.1/_images/cilium_http_gsg.png)\n\nì•„ë˜ ```http-sw-app.yaml``` ì€ ì„¸ê°€ì§€ deploymentë¥¼ ê°€ì§€ê³  ìˆê³  ê°ê°ì˜ deploymentëŠ” ```(org=empire, class=deathstar)```, ```(org=empire, class=tiefighter)```, ```(org=alliance, class=xwing)```ì™€ ê°™ì´ label ì •ë³´ë¥¼ ê°€ì§„ë‹¤. deathstar ServiceëŠ” ```(org=empire, class=deathstar)``` labelì„ ê°€ì§€ê³  Load Balancingì„ í•œë‹¤. \n\n```\n$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/http-sw-app.yaml\nservice \"deathstar\" created\ndeployment \"deathstar\" created\ndeployment \"tiefighter\" created\ndeployment \"xwing\" created\n```\n\nì´ 4ê°œì˜ podì™€ 1ê°œì˜ ì„œë¹„ìŠ¤ë¥¼ í™•ì¸í• ìˆ˜ ìˆë‹¤.\n```\n$ kubectl get pods,svc\nNAME                             READY     STATUS    RESTARTS   AGE\npod/deathstar-566c89f458-mqgfs   1/1       Running   0          1h\npod/deathstar-566c89f458-wlc4c   1/1       Running   0          1h\npod/tiefighter                   1/1       Running   0          1h\npod/xwing                        1/1       Running   0          1h\n\nNAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/deathstar    ClusterIP   10.109.80.174   <none>        80/TCP    1h\nservice/kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP   4h\n```\n\nê°ê°ì˜ podëŠ” Ciliumì—ì„œëŠ” [Endpoints](https://cilium.readthedocs.io/en/v1.1/concepts/#endpoint)í˜•íƒœë¡œ í‘œí˜„ëœë‹¤. ì•„ë˜ì™€ ê°™ì´ ingress, egress policyë¥¼ í™•ì¸í• ìˆ˜ ìˆê³  ì•„ì§ ì•„ë¬´ëŸ° network policy ì ìš©ì„ í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ëª¨ë‘ ```Disabled``` ìƒíƒœë¡œ ë³´ì¸ë‹¤.\n\n```\n$ kubectl -n kube-system get pods -l k8s-app=cilium\nNAME           READY     STATUS    RESTARTS   AGE\ncilium-jmxk2   1/1       Running   0          4h\n\n$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list\nENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                    IPv6                 IPv4            STATUS\n           ENFORCEMENT        ENFORCEMENT\n5023       Disabled           Disabled          2008       k8s:io.cilium.k8s.policy.serviceaccount=istio-ingress-service-account          f00d::a0f:0:0:139f   10.15.170.241   ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=ingress\n7415       Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:1cf7   10.15.16.224    ready\n                                                           k8s:io.cilium.k8s.policy.serviceaccount=default\n                                                           k8s:io.kubernetes.pod.namespace=default\n                                                           k8s:org=empire\n7979       Disabled           Disabled          4          reserved:health                                                                f00d::a0f:0:0:1f2b   10.15.96.215    ready\n17917      Disabled           Disabled          60941      k8s:class=tiefighter                                                           f00d::a0f:0:0:45fd   10.15.58.61     ready\n                                                           k8s:io.cilium.k8s.policy.serviceaccount=default\n                                                           k8s:io.kubernetes.pod.namespace=default\n                                                           k8s:org=empire\n22602      Disabled           Disabled          53004      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:584a   10.15.190.2     ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio-mixer-type=telemetry\n                                                           k8s:istio=mixer\n31992      Disabled           Disabled          33709      k8s:io.cilium.k8s.policy.serviceaccount=istio-egressgateway-service-account    f00d::a0f:0:0:7cf8   10.15.85.192    ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=egressgateway\n33958      Disabled           Disabled          64389      k8s:io.cilium.k8s.policy.serviceaccount=istio-citadel-service-account          f00d::a0f:0:0:84a6   10.15.59.151    ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=citadel\n49215      Disabled           Disabled          40629      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:c03f   10.15.48.171    ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio-mixer-type=policy\n                                                           k8s:istio=mixer\n55129      Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:d759   10.15.17.253    ready\n                                                           k8s:io.cilium.k8s.policy.serviceaccount=default\n                                                           k8s:io.kubernetes.pod.namespace=default\n                                                           k8s:org=empire\n55930      Disabled           Disabled          46893      k8s:app=prometheus                                                             f00d::a0f:0:0:da7a   10.15.196.220   ready\n                                                           k8s:io.cilium.k8s.policy.serviceaccount=prometheus\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n57491      Disabled           Disabled          775        k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:e093   10.15.253.210   ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=statsd-prom-bridge\n57651      Disabled           Disabled          44171      k8s:io.cilium.k8s.policy.serviceaccount=istio-ingressgateway-service-account   f00d::a0f:0:0:e133   10.15.74.164    ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=ingressgateway\n61352      Disabled           Disabled          888        k8s:io.cilium.k8s.policy.serviceaccount=istio-pilot-service-account            f00d::a0f:0:0:efa8   10.15.118.68    ready\n                                                           k8s:io.kubernetes.pod.namespace=istio-system\n                                                           k8s:istio=pilot\n61355      Disabled           Disabled          36797      k8s:class=xwing                                                                f00d::a0f:0:0:efab   10.15.56.79     ready\n                                                           k8s:io.cilium.k8s.policy.serviceaccount=default\n                                                           k8s:io.kubernetes.pod.namespace=default\n                                                           k8s:org=alliance\n```\n\ní˜„ì¬ ìƒíƒœì—ì„œëŠ” ëª¨ë“  ìš°ì£¼ì„ ì´ deathstarì— ì°©ë¥™ì´ ê°€ëŠ¥í•˜ë‹¤.\n```\n$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing\nShip landed\n\n$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing\nShip landed\n```\n\n## L3/L4 Policy ì ìš©\n\nê²°êµ­ í•˜ê³  ì‹¶ì€ê±´ ì œêµ­êµ° ìš°ì£¼ì„  ì¦‰, tiefighterë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ ì•„ë˜ì²˜ëŸ¼ ì •ì±…ì„ ì„¤ì •í•œë‹¤. \n\nì •ì±…ì€ ì§ê´€ì ìœ¼ë¡œ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤.\n\n```org=empire, class=deathstar``` labelì„ ê°€ì§„ endpointë¡œì˜ ingress ë°©í–¥ì˜ 80í¬íŠ¸ ì ‘ê·¼ì€ ```org=empire``` labelì„ ê°€ì§„ podë§Œ ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤. \n\n```\napiVersion: \"cilium.io/v2\"\nkind: CiliumNetworkPolicy\ndescription: \"L3-L4 policy to restrict deathstar access to empire ships only\"\nmetadata:\n  name: \"rule1\"\nspec:\n  endpointSelector:\n    matchLabels:\n      org: empire\n      class: deathstar\n  ingress:\n  - fromEndpoints:\n    - matchLabels:\n        org: empire\n    toPorts:\n    - ports:\n      - port: \"80\"\n        protocol: TCP\n```\n\në˜ëŠ” \n```\n$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_policy.yaml\n```\n\nìœ„ì™€ ê°™ì´ ì„¤ì •í•˜ê³  ë‚˜ì„œ tiefighterë¥¼ ì°©ë¥™ì‹œì¼œë³´ì.\n```\n$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing\nShip landed\n```\nì •ìƒì°©ë¥™!  \nì´ë²ˆì—ëŠ” xwing ì°¨ë¡€\n```\n$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing\n\n```\nì°©ë¥™ì‹¤íŒ¨!\n\nì´ì–´ì„œ ì •ì±…ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ë©´ Enabledë¡œ ë³€í•œ ì •ì±… 2ê°œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  \n(podê°€ 2ê°œì´ë¯€ë¡œ 2ê°œì˜ ì •ì±…ì„ ë³¼ ìˆ˜ ìˆë‹¤)\n```\n$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list\n```\n\nìƒì„¸ ì •ì±… í™•ì¸ (Very Simple!!)\n```\n$ kubectl get cnp\nNAME            AGE\nistio-sidecar   2h\nrule1           5m\n\n$  kubectl describe cnp rule1\nName:         rule1\nNamespace:    default\nLabels:       <none>\nAnnotations:  <none>\nAPI Version:  cilium.io/v2\nKind:         CiliumNetworkPolicy\nMetadata:\n  Cluster Name:\n  Creation Timestamp:  2018-07-06T07:25:15Z\n  Generation:          0\n  Resource Version:    30312\n  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1\n  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c\nSpec:\n  Endpoint Selector:\n    Match Labels:\n      Any : Class:  deathstar\n      Any : Org:    empire\n  Ingress:\n    From Endpoints:\n      Match Labels:\n        Any : Org:  empire\n    To Ports:\n      Ports:\n        Port:      80\n        Protocol:  TCP\nStatus:\n  Nodes:\n    Minikube:\n      Enforcing:              true\n      Last Updated:           0001-01-01T00:00:00Z\n      Local Policy Revision:  65\n      Ok:                     true\nEvents:                       <none>\n```\n\n## L7 ì •ì±… ì ìš©\në§ˆì§€ë§‰ìœ¼ë¡œ deathstar APIë¥¼ í˜¸ì¶œí•˜ëŠ” ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì •ì±…ì„ ì œì–´í•˜ëŠ”ê²ƒì„ í…ŒìŠ¤íŠ¸í•´ë³¸ë‹¤.\n\n\nì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ exhaust-port API(í¬íŠ¸ë¥¼ ì†Œì§„ì‹œí‚¤ëŠ” API)ë¥¼ ìˆ˜í–‰í•˜ë©´ íŠ¹ì • podê°€ ì—ëŸ¬ê°€ ë‚˜ê³  ì¬ê¸°ë™ ë˜ëŠ”ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤. \n```\n$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port\n\nPanic: deathstar exploded\n\ngoroutine 1 [running]:\nmain.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)\n        /code/src/github.com/empire/deathstar/\n        temp/main.go:9 +0x64\nmain.main()\n        /code/src/github.com/empire/deathstar/\n        temp/main.go:5 +0x85\n\n$ kubectl get pod\nNAME                         READY     STATUS    RESTARTS   AGE\ndeathstar-566c89f458-mqgfs   0/1       Error     0          1h\ndeathstar-566c89f458-wlc4c   1/1       Running   0          1h\ntiefighter                   1/1       Running   0          1h\nxwing                        1/1       Running   0          1h\n\n$ kubectl get pod\nNAME                         READY     STATUS    RESTARTS   AGE\ndeathstar-566c89f458-mqgfs   1/1       Running   1          1h\ndeathstar-566c89f458-wlc4c   1/1       Running   0          1h\ntiefighter                   1/1       Running   0          1h\nxwing                        1/1       Running   0          1h\n```\n\nê·¸ë˜ì„œ ì´ë²ˆì—ëŠ” exhaust-port APIëŠ” ì°¨ë‹¨í•˜ê³  request-landing APIë§Œ í—ˆìš©í•˜ëŠ” ì •ì±…ì„ í…ŒìŠ¤íŠ¸í•´ë³¸ë‹¤.\n```\napiVersion: \"cilium.io/v2\"\nkind: CiliumNetworkPolicy\ndescription: \"L7 policy to restrict access to specific HTTP call\"\nmetadata:\n  name: \"rule1\"\nspec:\n  endpointSelector:\n    matchLabels:\n      org: empire\n      class: deathstar\n  ingress:\n  - fromEndpoints:\n    - matchLabels:\n        org: empire\n    toPorts:\n    - ports:\n      - port: \"80\"\n        protocol: TCP\n      rules:\n        http:\n        - method: \"POST\"\n          path: \"/v1/request-landing\"\n```\në˜ëŠ”\n```\n$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_l7_policy.yaml\n\nciliumnetworkpolicy.cilium.io/rule1 configured\n```\n\nì´í›„ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´ ë‹¤ë¥¸ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. \n```\n$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing\nShip landed\n\n$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port\nAccess denied\n```\n\në‹¤ì‹œí•œë²ˆ ìƒì„¸ ì •ì±… í™•ì¸ì„ í•´ë³´ë©´ ingress POST í—ˆìš©ì •ì±…ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n```\n$ kubectl describe ciliumnetworkpolicies rule1\nName:         rule1\nNamespace:    default\nLabels:       <none>\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration={\"apiVersion\":\"cilium.io/v2\",\"description\":\"L7 policy to restrict access to specific HTTP call\",\"kind\":\"CiliumNetworkPolicy\",\"metadata\":{\"annotations\":...\nAPI Version:  cilium.io/v2\nKind:         CiliumNetworkPolicy\nMetadata:\n  Cluster Name:\n  Creation Timestamp:  2018-07-06T07:25:15Z\n  Generation:          0\n  Resource Version:    32814\n  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1\n  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c\nSpec:\n  Endpoint Selector:\n    Match Labels:\n      Any : Class:  deathstar\n      Any : Org:    empire\n  Ingress:\n    From Endpoints:\n      Match Labels:\n        Any : Org:  empire\n    To Ports:\n      Ports:\n        Port:      80\n        Protocol:  TCP\n      Rules:\n        Http:\n          Method:  POST\n          Path:    /v1/request-landing\nStatus:\n  Nodes:\n    Minikube:\n      Annotations:\n        Kubectl . Kubernetes . Io / Last - Applied - Configuration:  {\"apiVersion\":\"cilium.io/v2\",\"description\":\"L7 policy to restrict access to specific HTTP call\",\"kind\":\"CiliumNetworkPolicy\",\"metadata\":{\"annotations\":{},\"name\":\"rule1\",\"namespace\":\"default\"},\"spec\":{\"endpointSelector\":{\"matchLabels\":{\"class\":\"deathstar\",\"org\":\"empire\"}},\"ingress\":[{\"fromEndpoints\":[{\"matchLabels\":{\"org\":\"empire\"}}],\"toPorts\":[{\"ports\":[{\"port\":\"80\",\"protocol\":\"TCP\"}],\"rules\":{\"http\":[{\"method\":\"POST\",\"path\":\"/v1/request-landing\"}]}}]}]}}\n\n      Enforcing:              true\n      Last Updated:           0001-01-01T00:00:00Z\n      Local Policy Revision:  70\n      Ok:                     true\nEvents:                       <none>\n```\n\ncilium CLIë¡œë„ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.\n```\nî‚° kubectl -n kube-system exec cilium-jmxk2 cilium policy get\n[\n  {\n    \"endpointSelector\": {\n      \"matchLabels\": {\n        \"reserved:init\": \"\"\n      }\n    },\n    \"ingress\": [\n      {\n        \"fromEntities\": [\n          \"host\"\n        ]\n      }\n    ],\n    \"egress\": [\n      {\n        \"toPorts\": [\n          {\n            \"ports\": [\n              {\n                \"port\": \"53\",\n                \"protocol\": \"UDP\"\n              }\n            ]\n          }\n        ],\n        \"toEntities\": [\n          \"all\"\n        ]\n      },\n      {\n        \"toEndpoints\": [\n          {\n            \"matchLabels\": {\n              \"k8s:io.kubernetes.pod.namespace\": \"istio-system\"\n            }\n          }\n        ]\n      }\n    ],\n    \"labels\": [\n      {\n        \"key\": \"io.cilium.k8s.policy.name\",\n        \"value\": \"istio-sidecar\",\n        \"source\": \"k8s\"\n      },\n      {\n        \"key\": \"io.cilium.k8s.policy.namespace\",\n        \"value\": \"default\",\n        \"source\": \"k8s\"\n      }\n    ]\n  },\n  {\n    \"endpointSelector\": {\n      \"matchLabels\": {\n        \"any:class\": \"deathstar\",\n        \"any:org\": \"empire\",\n        \"k8s:io.kubernetes.pod.namespace\": \"default\"\n      }\n    },\n    \"ingress\": [\n      {\n        \"fromEndpoints\": [\n          {\n            \"matchLabels\": {\n              \"any:org\": \"empire\",\n              \"k8s:io.kubernetes.pod.namespace\": \"default\"\n            }\n          }\n        ],\n        \"toPorts\": [\n          {\n            \"ports\": [\n              {\n                \"port\": \"80\",\n                \"protocol\": \"TCP\"\n              }\n            ],\n            \"rules\": {\n              \"http\": [\n                {\n                  \"path\": \"/v1/request-landing\",\n                  \"method\": \"POST\"\n                }\n              ]\n            }\n          }\n        ]\n      }\n    ],\n    \"labels\": [\n      {\n        \"key\": \"io.cilium.k8s.policy.name\",\n        \"value\": \"rule1\",\n        \"source\": \"k8s\"\n      },\n      {\n        \"key\": \"io.cilium.k8s.policy.namespace\",\n        \"value\": \"default\",\n        \"source\": \"k8s\"\n      }\n    ]\n  }\n]\nRevision: 71\n```\n\nì´ì™¸ì—ë„ Cilium Metricì„ Prometheusì—ì„œ í™•ì¸í•˜ëŠ”ê²ƒë„ ê°„ë‹¨í•˜ê²Œ í• ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. \n\nì—¬ê¸°ê¹Œì§€ê°€ ê¸°ë³¸ì ìœ¼ë¡œ L3/L4, L7 ê¸°ë°˜ network policyë¥¼ ì ìš©í•´ë³¸ê²ƒì´ê³  ë‹¤ìŒë²ˆì—ëŠ” istioì™€ ì—°ê³„ ë¶€ë¶„ì´ë‚˜ ì‹¤ì œ Cluster êµ¬ì„±ë°©ë²•ì— ëŒ€í•´ì„œ ë‹¤ë¤„ë³´ë„ë¡ í•˜ê² ë‹¤."
    },
    {
      "id": "kubernetes/spinnaker-advanced-1/",
      "metadata": {
        "permalink": "/kubernetes/spinnaker-advanced-1/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-03-spinnaker-advanced-1.md",
        "source": "@site/blog/2018-07-03-spinnaker-advanced-1.md",
        "title": "Spinnaker on Kubernetes #1",
        "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #1",
        "date": "2018-07-03T00:00:00.000Z",
        "formattedDate": "July 3, 2018",
        "tags": [
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Spinnaker",
            "permalink": "/tags/spinnaker"
          }
        ],
        "readingTime": 3.725,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Spinnaker on Kubernetes #1",
          "comments": true,
          "classes": "wide",
          "description": "Spinnakerì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤ #1",
          "slug": "kubernetes/spinnaker-advanced-1/",
          "date": "2018-07-03T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "CI/CD",
            "Kubernetes",
            "Spinnaker"
          ]
        },
        "prevItem": {
          "title": "Cilium",
          "permalink": "/kubernetes/cilium-1/"
        },
        "nextItem": {
          "title": "Provisioning Dedicated Game Server on Kubernetes Cluster",
          "permalink": "/kubernetes/openinfraday18/"
        }
      },
      "content": "ì§€ë‚œë²ˆ [OpenInfraDayë°œí‘œ](https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster)ë•Œ ì§ˆë¬¸ì„ í•´ì£¼ì…¨ëŠ”ë° ìš”ì¦˜ Spinnakerë¥¼ ë§ì´ë“¤ ì“°ê±°ë‚˜ ê²€í† ë¥¼ ë§ì´ í•˜ëŠ”ê²ƒìœ¼ë¡œ ì•Œê³  ìˆë‹¤.  \n\nSpinnakerë¥¼ ì„¤ì¹˜í•˜ëŠ” ë‚´ìš©ì€ ë§ì´ ìˆìœ¼ë‹ˆ ì•„ë˜ halyardë¡œ ì„¤ì¹˜í•˜ëŠ” í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ë©´ ëœë‹¤.\n\n[ìœ¤ìƒì¤€ì˜ ê¸°ìˆ  ë¸”ë¡œê·¸ - Spinnaker ì„¤ì¹˜í•˜ê¸°](https://yunsangjun.github.io/blog/spinnaker/2018/06/03/installing-spinnaker.html)\n\nì´ë²ˆì— ì´ì•¼ê¸°í•˜ê³ ì í•˜ëŠ” ë¶€ë¶„ì€ ì‹¤ì œ Spinnakerë¥¼ ì„¤ì¹˜í•˜ê³  ë‚œ í›„ ìš´ì˜ìƒì— ê³ ë ¤í•´ì•¼í•  ë¶€ë¶„ë“¤ê³¼ íŒë“¤ì„ ê³µìœ í•´ë³´ë ¤ê³  í•œë‹¤.\n\nì‚¬ì‹¤ Spinnakerë¥¼ êµ¬ì„±í•˜ë©´ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ë¶€ë¶„ë“¤ì€ ìš©ì–´, halyard config ê´€ë¦¬ì™€ custom resourse ì¸ì‹ë¶€ë¶„ ì´ì˜€ë‹¤. ë‚˜ë¨¸ì§€ë“¤ì€ ë­ íŠœí† ë¦¬ì–¼ì„ ë”°ë¼ê°€ë©´ ë³„ë¡œ ì–´ë µì§„ ì•Šìœ¼ë‹ˆ ì•„ë˜ ë‚´ìš©ì„ ì°¨ê·¼ì°¨ê·¼ ë”°ë¼ê°€ë©´ì„œ ì´í•´í•˜ë©´ ë ê²ƒ ê°™ë‹¤. \n\n## ìš©ì–´ë“¤\n\nì‚¬ìš©í•˜ë©´ì„œ í˜¼ëˆì´ ë§ì´ ìƒê¸°ëŠ” ë¶€ë¶„ì´ë‹¤ ì´ê²Œ GCEë‚˜ EC2ë¥¼ ì“°ë©´ ìš©ì–´ ë§¤ì¹­ì´ ì‰¬ìš´ë° k8së¥¼ ìœ„í•œ ë³„ë„ì˜ ë©”ë‰´ê°€ ì•„ë‹Œ ê¸°ëŠ¥ì„ í†µí•©í•˜ë‹¤ë³´ë‹ˆ ìš©ì–´ê°€ ì¡°ê¸ˆ í˜¼ë™ìŠ¤ëŸ½ê²Œ êµ¬ì„±ì´ ë˜ì—ˆë‹¤.  \níŠ¹íˆ Load Balancer ë¶€ë¶„ì€ Serviceë¡œ ë§¤í•‘ë˜ê³  í¼ë¸”ë¦­ k8sì—ì„œ ì œê³µí•˜ëŠ” Type LoadBalancerëŠ” ë¯¸ì§€ì›í•œë‹¤.  \nê·¸ë¦¬ê³  ëª¨ë“  Resourceë“¤ì€ Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)ì„ ì§€ì›í•˜ë©° Versioningì´ ì§€ì›ëœë‹¤.  Versioningì€ [ì—¬ê¸°](https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy)ì— ì„¤ëª…ëœ ëŒ€ë¡œ ```strategy.spinnaker.io/versioned``` annotationì„ í†µí•´ manifestë³„ë¡œ ì¬ì •ì˜ê°€ ê°€ëŠ¥í•˜ë‹¤.\n\n| Spinnaker | Kubernetes | ë¹„ê³  |\n|:----------:|:----------:|:-----------:|\n| Server Group | [Workloads](https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads) | [CRDì˜ ê²½ìš° ë³„ë„ Build](https://www.spinnaker.io/guides/developer/crd-extensions/) |\n| Clusters | Logical Server Group\t |  |\n| Load Balancer | Services | LoadBalancer(k8s) ë¯¸ì§€ì› |\n| Firewall | NetworkPolicies |  |\n\n\nSpinnaker Server Groupìœ¼ë¡œ ë¶„ë¥˜ ëœ í•­ëª©ì€ ëª¨ë‘ Spinnakerì˜ í´ëŸ¬ìŠ¤í„° íƒ­ì— í‘œì‹œê°€ ëœë‹¤. ê°€ëŠ¥í•œ ê²½ìš° ëª¨ë“  í¬ë“œê°€ í‘œê¸°ë˜ì§€ë§Œ, í•´ë‹¹ [Workloads](https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads) ì´ì™¸ì˜ CRD(Custom Resource Definition)ëŠ” halconfigì—ì„œ ì•„ë˜ì™€ ê°™ì´ customResources configë¥¼ ì¶”ê°€í•˜ë©´ deployëŠ” ê°€ëŠ¥í•˜ë‚˜ Spinnaker UIì—ì„œ ë³´ì´ì§€ëŠ” ì•ŠëŠ”ë‹¤.  \n\n```\nkubernetes:\n      enabled: true\n      accounts:\n      - name: my-k8s-account\n        customResources:\n        - kubernetesKind: GameServer\n```\n\nì´ìœ ëŠ” ë°”ë¡œ ë‹¤ìŒ ë§í¬ì²˜ëŸ¼ [(CRDì˜ ê²½ìš° ë³„ë„ Buildí•„ìš”)](https://www.spinnaker.io/guides/developer/crd-extensions/) \në³„ë„ë¡œ Javaë¥¼ ë¹Œë“œí•´ì•¼ í•œë‹¤. Spinnaker Slackì— ë¬¸ì˜ë¥¼ ëª‡ë²ˆí–ˆëŠ”ë° ì§ˆë¬¸í•˜ëŠ” ì‚¬ëŒë§Œ ìˆê³  ë‹µì€ ì•„ë¬´ë„ ì•ˆí•´ì¤€ë‹¤ëŠ”...  \nhttps://spinnakerteam.slack.com/\n\n\n\n## Jenkins ì—°ë™\n\n[Spinnaker, Jenkins integration ìƒì„¸ë‚´ìš© ê³µì‹ë¬¸ì„œ ](https://www.spinnaker.io/setup/ci/jenkins/)\n\nJenkinsì™€ ì—°ë™í•˜ë©´ì„œ ê°€ì¥ ì–´ì´ì—†ì´ í—¤ë§¨ë¶€ë¶„ì€ ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ ë˜ì–´ìˆì–´ì•¼ í•˜ëŠ”ë° Security Realmì„ Jenkins Default admin ê³„ì •ë§Œì„ ê°€ì§€ê³  integration í•˜ë ¤ë‹¤ê°€ ê³„ì† ì‹¤íŒ¨í•˜ì˜€ë‹¤. Delegate to servlet container ë§ê³  Jenkins ìì²´ ì‚¬ìš©ì DBë¡œ ë³„ë„ ê³„ì •ì„ ìƒì„±í•˜ê³  ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ ì„¤ì •ì„ í•´ì•¼í•œë‹¤.\n\n![Jenkins Config](/img/jenkins_config.png)\n\nìœ„ ì„¤ì • ì´í›„ ì•„ë˜ì™€ ê°™ì´ Spinnaker UIì—ì„œ Jenkins APIì—°ë™ì´ ê°€ëŠ¥í•˜ë‹¤.  \n\n![Spinnaker Jenkins](/img/spin_jenkins.png)\n\n\nì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ë§Œ í•˜ê³  ë‹¤ìŒê¸€ì—ì„œëŠ” ë°°í¬ì „ëµì´ë‚˜ Network Policy ì—°ë™ë“±ì„ ìƒì„¸íˆ ì ì–´ë³¼ ì˜ˆì •ì´ë‹¤."
    },
    {
      "id": "kubernetes/openinfraday18/",
      "metadata": {
        "permalink": "/kubernetes/openinfraday18/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-07-01-openinfraday18.md",
        "source": "@site/blog/2018-07-01-openinfraday18.md",
        "title": "Provisioning Dedicated Game Server on Kubernetes Cluster",
        "description": "Provisioning Dedicated Game Server on Kubernetes Cluster",
        "date": "2018-07-01T00:00:00.000Z",
        "formattedDate": "July 1, 2018",
        "tags": [
          {
            "label": "CI/CD",
            "permalink": "/tags/ci-cd"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Agones",
            "permalink": "/tags/agones"
          },
          {
            "label": "Spinnaker",
            "permalink": "/tags/spinnaker"
          }
        ],
        "readingTime": 0.2,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "title": "Provisioning Dedicated Game Server on Kubernetes Cluster",
          "comments": true,
          "classes": "wide",
          "description": "Provisioning Dedicated Game Server on Kubernetes Cluster",
          "slug": "kubernetes/openinfraday18/",
          "date": "2018-07-01T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "CI/CD",
            "Kubernetes",
            "Agones",
            "Spinnaker"
          ]
        },
        "prevItem": {
          "title": "Spinnaker on Kubernetes #1",
          "permalink": "/kubernetes/spinnaker-advanced-1/"
        },
        "nextItem": {
          "title": "Mutating Webhook",
          "permalink": "/kubernetes/mutating-web-hook/"
        }
      },
      "content": "6ì›” 28ì¼ì— Openinfradayì—ì„œ ë°œí‘œí•œ ë‚´ìš©\n\n[![Slideshare](https://image.slidesharecdn.com/43dgs06270307-180628163517/95/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster-1-638.jpg?cb=1530203766)\n](https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster)\n\n\n## ë°œí‘œ ì˜ìƒ\n  \n[![Video](http://img.youtube.com/vi/LtGGzKBoVZQ/0.jpg)](https://youtu.be/LtGGzKBoVZQ?t=0s)\n\nCustom Resource ì— ëŒ€í•œ ë‚´ìš©ì€ ìƒì„¸í•˜ê²Œ ë” ì •ë¦¬í•´ì•¼ê² ë‹¤."
    },
    {
      "id": "kubernetes/mutating-web-hook/",
      "metadata": {
        "permalink": "/kubernetes/mutating-web-hook/",
        "editUrl": "https://github.com/ddiiwoong/newblog/tree/main/blog/2018-06-27-mutating-web-hook.md",
        "source": "@site/blog/2018-06-27-mutating-web-hook.md",
        "title": "Mutating Webhook",
        "description": "Mutating Webhookì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
        "date": "2018-06-27T00:00:00.000Z",
        "formattedDate": "June 27, 2018",
        "tags": [
          {
            "label": "Mutating Webhook",
            "permalink": "/tags/mutating-webhook"
          },
          {
            "label": "Kubernetes",
            "permalink": "/tags/kubernetes"
          },
          {
            "label": "Admission Controller",
            "permalink": "/tags/admission-controller"
          },
          {
            "label": "Istio",
            "permalink": "/tags/istio"
          },
          {
            "label": "Agones",
            "permalink": "/tags/agones"
          }
        ],
        "readingTime": 8.435,
        "truncated": false,
        "authors": [],
        "frontMatter": {
          "layout": "single",
          "classes": "wide",
          "title": "Mutating Webhook",
          "description": "Mutating Webhookì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤",
          "slug": "kubernetes/mutating-web-hook/",
          "date": "2018-06-27T00:00:00.000Z",
          "categories": [
            "Kubernetes"
          ],
          "tags": [
            "Mutating Webhook",
            "Kubernetes",
            "Admission Controller",
            "Istio",
            "Agones"
          ]
        },
        "prevItem": {
          "title": "Provisioning Dedicated Game Server on Kubernetes Cluster",
          "permalink": "/kubernetes/openinfraday18/"
        }
      },
      "content": "## Admission controller í™•ì¥\n\nKubernetes(ì´í•˜ k8s)ê¸°ë°˜ ê°œë°œ ê³¼ì œë¥¼ ìˆ˜í–‰í•˜ë‹¤ë³´ë‹ˆ Custom Resourceë¥¼ ì‚¬ìš©í• ìˆ˜ ë°–ì— ì—†ëŠ” ìƒí™©ë“¤ì´ ë°œìƒí•˜ì˜€ë‹¤.  \nê·¸ëŸ° ì™€ì¤‘ì— istioì™€ ê°™ì€ Service Mesh Layerë¥¼ ë¦¬ì„œì¹˜í•˜ë˜ ì¤‘ì— íŠ€ì–´ë‚˜ì˜¨ MutatingAdmissionWebhook ìš©ì–´ë¥¼ ì´í•´í•˜ê¸° ìœ„ì— ì¡°ì‚¬í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ë³¸ë‹¤.\n\n<https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/>\n\n\nAdmission controllerëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ api-serverì˜ ì˜¤ë¸Œì íŠ¸(Pod,ë“±) ìƒì„± ìš”ì²­ì„ ê°€ë¡œì²´ì–´ ì œì–´ë¥¼ í•  ìˆ˜ ìˆëŠ” í™•ì¥ ê¸°ëŠ¥ìœ¼ë¡œ í”ŒëŸ¬ê·¸ì¸ í˜•íƒœë¡œ ì‚¬ìš©ìê°€ ì¶”ê°€ í•  ìˆ˜ ìˆë‹¤.   \nì¢€ë” ìì„¸íˆ í™•ì¸í•´ë³´ì \n- í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ìê°€ kube-apië¥¼ ì§ì ‘ ì»´íŒŒì¼ í•˜ê³  êµ¬ì„±í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìœ ì—°í•˜ê²Œ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ì›€\n- 1.7 ë²„ì „ ì´í›„ë¶€í„°ëŠ” ì´ëŸ¬í•œ ì œí•œì‚¬í•­ì„ í•´ê²°í•˜ê¸° ìœ„í•´ alpha featureë¡œ  [Initializers](https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#initializers) ì™€ [External Admission Webhooks](https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#external-admission-webhooks) ê¸°ëŠ¥ì´ ë„ì…ë¨\n- External Admission Webhooks ëŠ” k8s ë¦¬ì†ŒìŠ¤ì˜ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ëŠ”ë° í™œìš©, ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼ í•˜ì§€ ëª»í•˜ë©´ í•´ ë‹¹ ë¦¬ì†ŒìŠ¤ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ìƒì„±ë˜ì§ˆ ì•Šê²Œ í•  ìˆ˜ ìˆìŒ.\n- 1.9 ë²„ì „ì—ì„œëŠ” External Admission Webhooks ì€ betaë¡œ ìŠ¹ê²©ë˜ì–´ MutatingAdmissionWebhook ë° ValidatingAdmissionWebhookìœ¼ë¡œ ë‚˜ëˆ ì¡Œì§€ë§Œ Initializers ëŠ” alpha ë¡œ ìœ ì§€ë¨\n- MutatingAdmissionWebhook ì€ ìœ íš¨ì„± ê²€ì‚¬ ì´ì™¸ì—ë„ ìŠ¹ì¸ ê³¼ì •ì‹œ k8s objectì— ë³€ê²½ì„ í• ìˆ˜ ìˆìŒ\n  - ì˜ˆë¥¼ ë“¤ë©´ resource quotaë¥¼ ë³€ê²½í•œë‹¤ë˜ì§€  Agones ë° istioì™€ ê°™ì€ Custom Resource ë¥¼ ìˆ˜ì •í•˜ì—¬ objectë¥¼ ìƒì„±ì´ ê°€ëŠ¥í•¨\n  - Webhook ë°©ì‹ì€ gRPC í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” ë° ê°œë°œì–¸ì–´ì— êµ¬ì•  ë°›ì§€ ì•Šê³  í™•ì¥ì„ í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆìŒ\n\n\n## Webhookì„ ì–¸ì œ ì“°ëŠ”ê°€?\nWebhookì„ ì‚¬ìš©í•˜ì—¬ k8s cluster-adminì´ api-serverë¥¼ ë‹¤ì‹œ ì»´íŒŒì¼í•˜ì§€ ì•Šê³ ë„ objectìƒì„± ìš”ì²­ì‹œ mutating(ë³€ê²½) ë° validation(ìœ íš¨ì„±ê²€ì¦) ì„ í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. \n\nì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ëª¨ë“  resource ì—ì„œ ì—¬ëŸ¬ ì‘ì—… ( \"CREATE\", \"UPDATE\", \"DELETE\"...)ì— ëŒ€í•œ ìŠ¹ì¸ ë¡œì§ì— ëŒ€í•´ ì‚¬ìš©ì ì •ì˜ í•  ìˆ˜ìˆëŠ” ìœ ì—°ì„±ì„ ì œê³µë°›ëŠ”ë‹¤.\n\n\n## Use-Case\n- resourceë¥¼ ìƒì„±í•˜ê¸° ì „ì— ë³€ê²½  \n(ì˜ˆ, Istio ì—ì„œ ì²˜ëŸ¼ traffic management ì™€ policy enforcement ì„ ìœ„í•´ Envoy sidecar containerë¥¼ injection)\n- StorageClass Provisioning ìë™í™”  \n(PersistentVolumeClaim object ìƒì„±ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ë¯¸ë¦¬ ì •ì˜ ëœ ì •ì±…ì— ë”°ë¼ ê°ì²´ì— storageë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€. ì‚¬ìš©ìëŠ” StorageClass ìƒì„± ì— ì‹ ê²½ ì“¸ í•„ìš”ê°€ ì—†ìŒ)\n- ë³µì¡í•œ custom resource ê²€ì¦ (Agonesì™€ ê°™ì€)namespace ì œí•œ  \në©€í‹° í…Œë„ŒíŠ¸ ì‹œìŠ¤í…œì—ì„œëŠ” reserved namespaceì— resourceìƒì„±ì„ ê¸ˆì§€ì‹œí‚¬ë•Œ ì‚¬ìš©í• ìˆ˜ ìˆìŒ\n\n- ì°¸ê³  ì˜ˆì‹œ  \n<https://github.com/kelseyhightower/denyenv-validating-admission-webhook>\n\n\n\n## ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ê°€?\nMutatingWebhookConfiguration ë‚´ì— ì •ì˜ëœ ë£°ì— ë”°ë¼ etcdë¡œ ì „ë‹¬ë˜ê¸° ì „ì— requestë¥¼ interceptí•œë‹¤.  \nwebhook ì„œë²„ì— ìŠ¹ì¸ ìš”ì²­ì„ ì „ì†¡í•˜ì—¬ ë³€ì´ë¥¼ ì‹¤í–‰í•œë‹¤.  \nwebhook ì„œë²„ëŠ” APIë¥¼ ì¤€ìˆ˜í•˜ëŠ” ë‹¨ìˆœí•œ httpì„œë²„.\n\n![Alt text](/img/mutating.jpg)\n\n## íŠœí† ë¦¬ì–¼\n<https://github.com/morvencao/kube-mutating-webhook-tutorial>  \n\nìœ„ íŠœí† ë¦¬ì–¼ì€ objectê°€ ìƒì„±ë˜ê¸° ì „ì— podì— nginx sidecar containerë¥¼ injectí•˜ëŠ” MutatingAdmissionWebhookì„ ë°°í¬í•˜ëŠ” ë‚´ìš©ì„ ë‹´ê³  ìˆë‹¤.\n\nìš°ì„  admissionregistration.k8s.io/v1beta1 APIë¥¼ ì‚¬ìš©í• ìˆ˜ ìˆëŠ” k8s 1.9+ ì´ìƒì˜ í´ëŸ¬ìŠ¤í„°ê°€ í•„ìš”í•˜ë‹¤.  \n\n## í™•ì¸ë°©ë²•\n```\n$ kubectl api-versions | grep admissionregistration.k8s.io/v1beta1\n```\nì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì™€ì•¼í•¨\n```\nadmissionregistration.k8s.io/v1beta1\n```\n\n## Buildí•˜ê¸°\n\nì¼ë‹¨ Goê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.\n```~/go/src``` ì•„ë˜ì— cloneì„ í•˜ì˜€ìŒ.\n\n```\n$ cd ~/go/src\n$ git clone https://github.com/morvencao/kube-mutating-webhook-tutorial.git\n```\n\nì˜ì¡´ì„± ê´€ë¦¬ë¥¼ ìœ„í•´ repoëŠ” depë¥¼ ì‚¬ìš©í•¨\n```\n$ cd kube-mutating-webhook-tutorial\n$ go get -u github.com/golang/dep/cmd/dep\n```\n\nbuild íŒŒì¼ í™•ì¸í•˜ê³  registry ìœ„ì¹˜ë¥¼ ë°”ê¿ˆ\n```\ndep ensure\nCGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o kube-mutating-webhook-tutorial .\ndocker build --no-cache -t registry.*****.io/agones/sidecar-injector:v1 .\nrm -rf kube-mutating-webhook-tutorial\n\ndocker push registry.*****.io/agones/sidecar-injector:v1\n```\n\nbuildí•˜ê³  docker image push\n```\n$ ./build\nSending build context to Docker daemon  44.29MB\nStep 1/3 : FROM alpine:latest\n ---> 3fd9065eaf02\nStep 2/3 : ADD kube-mutating-webhook-tutorial /kube-mutating-webhook-tutorial\n ---> 8679ccbab536\nStep 3/3 : ENTRYPOINT [\"./kube-mutating-webhook-tutorial\"]\n ---> Running in 7699ff5c0885\nRemoving intermediate container 7699ff5c0885\n ---> 2014100d460e\nSuccessfully built 2014100d460e\nSuccessfully tagged registry.*****.io/agones/sidecar-injector:v1\nThe push refers to repository [registry.*****.io/agones/sidecar-injector]\n2456c1309a51: Pushed\ncd7100a72410: Layer already exists\nv1: digest: sha256:15c335daeba40ddcbfbc3631ab6daa7cf623b63420f0ae8b657755322ef0582d size: 739\n```\n\n\nsidecar deploymentì— ì‚¬ìš©ë˜ëŠ” secret(cert/key)ì„ ìƒì„±í•œë‹¤.\n```\n./deployment/webhook-create-signed-cert.sh \\\n    --service sidecar-injector-webhook-svc \\\n    --secret sidecar-injector-webhook-certs \\\n    --namespace default\n```\n\nìœ„ì—ì„œ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ì˜ caBundleê°’ì„ ê°€ì§€ê³  MutatingWebhookConfiguration ìƒì„±í•œë‹¤.\n```\ncat deployment/mutatingwebhook.yaml | \\\n    deployment/webhook-patch-ca-bundle.sh > \\\n    deployment/mutatingwebhook-ca-bundle.yaml\n```\n\nresourceë“¤ deploy\n```\n$ kubectl create -f deployment/nginxconfigmap.yaml\nkubectl create -f deployment/configmap.yaml\nkubectl create -f deployment/deployment.yaml\nkubectl create -f deployment/service.yaml\nkubectl create -f deployment/mutatingwebhook-ca-bundle.yaml\n\nconfigmap \"nginx-configmap\" created\nconfigmap \"sidecar-injector-webhook-configmap\" created\ndeployment.extensions \"sidecar-injector-webhook-deployment\" created\nservice \"sidecar-injector-webhook-svc\" created\nmutatingwebhookconfiguration.admissionregistration.k8s.io \"sidecar-injector-webhook-cfg\" created\n```\n\nwebhook deployment í™•ì¸\n\n```\n$ kubectl get pods\nNAME                                                   READY     STATUS    RESTARTS   AGE\nsidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          3m\n\n$ kubectl get deployment\nNAME                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nsidecar-injector-webhook-deployment   1         1         1            1           3m\n```\n\ndefault ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— sidecar-injector ë¼ë²¨ë§ì„ í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìƒì„±ë˜ëŠ” ëª¨ë“  appì— ìë™ìœ¼ë¡œ injectioní•˜ê²Œ ë¨\n```\n$ kubectl get namespace -L sidecar-injector\nNAME             STATUS    AGE       SIDECAR-INJECTOR\nagones-system    Active    1d\ndefault          Active    19d       enabled\nibm-cert-store   Active    19d\nibm-system       Active    19d\ningress-test     Active    6d\nkube-public      Active    19d\nkube-system      Active    19d\nspinnaker        Active    12d\nxonotic          Active    1d\n```\n\nìƒ˜í”Œì•±ì„ ë””í”Œë¡œì´ í•´ë³´ì\n```\n$ cat <<EOF | kubectl create -f -\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: sleep\nspec:\n  replicas: 1\n  template:\n    metadata:\n      annotations:\n        sidecar-injector-webhook.morven.me/inject: \"yes\"\n      labels:\n        app: sleep\n    spec:\n      containers:\n      - name: sleep\n        image: tutum/curl\n        command: [\"/bin/sleep\",\"infinity\"]\n        imagePullPolicy:\nEOF\ndeployment.extensions \"sleep\" created\n```\n\nsidecar container injection í™•ì¸  \nì•„ë˜ ê²°ê³¼ë¥¼ ë³´ë©´ í•˜ë‚˜ì˜ deployment í•˜ë‚˜ì˜ container ìƒì„±ì„ ìš”ì²­í–ˆì§€ë§Œ nginx sidecar ì»¨í…Œì´ë„ˆê°€ injection ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n```\n$ kubectl get pod\nNAME                                                   READY     STATUS    RESTARTS   AGE\nsidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          2h\nsleep-74b46f8bd7-r9l7f                                 2/2       Running   0          42s\n\n$ kubectl describe pod sleep-74b46f8bd7-r9l7f\nName:           sleep-74b46f8bd7-r9l7f\nNamespace:      default\nNode:           10.178.188.16/10.178.188.16\nStart Time:     Wed, 27 Jun 2018 13:12:47 +0900\nLabels:         app=sleep\n                pod-template-hash=3060294683\nAnnotations:    kubernetes.io/psp=ibm-privileged-psp\n                sidecar-injector-webhook.morven.me/inject=yes\n                sidecar-injector-webhook.morven.me/status=injected\nStatus:         Running\nIP:             172.30.169.30\nControlled By:  ReplicaSet/sleep-74b46f8bd7\nContainers:\n  sleep:\n    Container ID:  docker://728ca7f8e741ad29369312bc006c79683e7e605f3b04586df2477e233f93e451\n    Image:         tutum/curl\n    Image ID:      docker-pullable://tutum/curl@sha256:b6f16e88387acd4e6326176b212b3dae63f5b2134e69560d0b0673cfb0fb976f\n    Port:          <none>\n    Host Port:     <none>\n    Command:\n      /bin/sleep\n      infinity\n    State:          Running\n      Started:      Wed, 27 Jun 2018 13:13:01 +0900\n    Ready:          True\n    Restart Count:  0\n    Environment:    <none>\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-czzpj (ro)\n  sidecar-nginx:\n    Container ID:   docker://94fd41a0e153de6d5639873ccbd6b6325cee1ea8351dd02ab4a48ab4004d0b58\n    Image:          nginx:1.12.2\n    Image ID:       docker-pullable://nginx@sha256:72daaf46f11cc753c4eab981cbf869919bd1fee3d2170a2adeac12400f494728\n    Port:           80/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Wed, 27 Jun 2018 13:13:08 +0900\n    Ready:          True\n    Restart Count:  0\n    Environment:    <none>\n    Mounts:\n      /etc/nginx from nginx-conf (rw)\nConditions:\n  Type           Status\n  Initialized    True\n  Ready          True\n  PodScheduled   True\nVolumes:\n  default-token-czzpj:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName:  default-token-czzpj\n    Optional:    false\n  nginx-conf:\n    Type:        ConfigMap (a volume populated by a ConfigMap)\n    Name:        nginx-configmap\n    Optional:    false\nQoS Class:       BestEffort\nNode-Selectors:  <none>\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason                 Age   From                    Message\n  ----    ------                 ----  ----                    -------\n  Normal  Scheduled              1m    default-scheduler       Successfully assigned sleep-74b46f8bd7-r9l7f to 10.178.188.16\n  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume \"nginx-conf\"\n  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume \"default-token-czzpj\"\n  Normal  Pulling                1m    kubelet, 10.178.188.16  pulling image \"tutum/curl\"\n  Normal  Pulled                 55s   kubelet, 10.178.188.16  Successfully pulled image \"tutum/curl\"\n  Normal  Created                55s   kubelet, 10.178.188.16  Created container\n  Normal  Started                55s   kubelet, 10.178.188.16  Started container\n  Normal  Pulling                55s   kubelet, 10.178.188.16  pulling image \"nginx:1.12.2\"\n  Normal  Pulled                 48s   kubelet, 10.178.188.16  Successfully pulled image \"nginx:1.12.2\"\n  Normal  Created                48s   kubelet, 10.178.188.16  Created container\n  Normal  Started                48s   kubelet, 10.178.188.16  Started container\n```\n\n## ì •ë¦¬\nê²°êµ­ ìœ„ì—ì„œ ì–¸ê¸‰í•œê²ƒ ì²˜ëŸ¼ MutationWebhookì€ istio RouteRuleê°™ì€ ë³„ë„ì˜ CustomResourceë“±ì„ injection í•˜ê±°ë‚˜ agones ë“±ê³¼ ê°™ì´ ê²Œì„ì„œë²„ì™¸ì— client sdk í†µì‹ ì„ ìœ„í•œ injection í˜•íƒœë¡œ ê¸°ì¡´ resourceì— ì¶”ê°€ì ì¸ ë³€ê²½(mutation) ë˜ëŠ” ê²€ì¦(validation)ë“±ì˜ ì¶”ê°€ì ì¸ ì‘ì—…ì„ kube-apiì˜ ì»´íŒŒì¼ì—†ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ”ë° ëª©ì ì´ ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤. ì¶”ê°€ì ìœ¼ë¡œ ê¸°ëŠ¥ì— ëŒ€í•œ ë‚´ìš©ì€ ì´í›„ ë‹¤ì‹œ ì •ë¦¬í•´ë³¼ ì˜ˆì •ì´ë‹¤."
    }
  ]
}