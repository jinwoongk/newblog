<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">4 posts tagged with &quot;istio&quot; | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/tags/istio/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="4 posts tagged with &quot;istio&quot; | Cloud Catalyst"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/tags/istio/"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/istio/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/istio/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.b94385cb.js" as="script">
<link rel="preload" href="/assets/js/main.0346262c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere-adv/">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere/">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/what-is-tailscale/">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/prometheus/synology-prometheus/">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/vSphere-with-Tanzu-homelab-2/">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>4 posts tagged with &quot;istio&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/eks-anywhere-adv/">EKS Anywhere Advanced Usages</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-18T00:00:00.000Z" itemprop="datePublished">March 18, 2022</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/e8bfebcbeacb5b9a0c90614e792febf2?s=80" alt="Jinwoong Kim"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jinwoong Kim</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>지난글에 이어 이번에는 홈랩으로 구성한 EKS Anywhere 클러스터에서 운영, 개발환경 구성을 위한 여러가지 도구를 설치해보는 과정을 정리하고자 한다. </p><p>지난 포스팅은 다음 링크에서 확인할 수 있다.</p><blockquote><p>이전글 - <a href="https://ddii.dev/kubernetes/eks-anywhere/" target="_blank" rel="noopener noreferrer">vSphere homelab 환경에서 EKS Anywhere 구성하기</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vsphere/">vsphere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks-anywhere/">eks anywhere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks-connector/">eks connector</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks/">eks</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/opentelemetry/">opentelemetry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cilium/">cilium</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/observability/">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prometheus/">prometheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/grafana/">grafana</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/loki/">loki</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microservice/">microservice</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">istio</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about EKS Anywhere Advanced Usages" href="/kubernetes/eks-anywhere-adv/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/microservices-demo/">Cloud-Native Microservices Demo Application with OpenCensus</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-07T00:00:00.000Z" itemprop="datePublished">March 7, 2019</time> · <!-- -->14 min read</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/microservices-demo</a>에서 소개된 Demo Application인 <code>Hipster Shop</code>을 Kubernetes 기반으로 배포하고 관련 오픈소스들을 더 알아보고자 한다.</p><p>위 링크에 가서 보면 알수 있지만 <code>Hipster Shop</code> 아래 그림처럼 10개의 Microservice로 구성되어 있고 상품을 검색 및 구매할 수있는 웹 기반 이커머스 Application으로 구성 되어있다.</p><p><img loading="lazy" src="https://github.com/GoogleCloudPlatform/microservices-demo/raw/master/docs/img/architecture-diagram.png" alt="arch" class="img_E7b_"></p><p>각각의 서비스는 <strong>gRPC</strong> 로 통신하고 외부 사용자만 HTTP로 접근한다. 모든 서비스는 서로 다른 언어(Go, C#, Node.js, Python, Java)로 구성되어 있고 대부분의 Microservice들은 <code>Istio</code> service mesh 형태로 구성할수 있도록 되어있다. <code>Skaffold</code>를 통해 배포하고 <code>OpenCensus</code>라고 하는 gRPC/HTTP기반 Tracing tool을 활용하여 Google <code>Stackdriver</code>로 보내도록 되어있지만  Prometheus에 통합하는 방향으로 작성하기 위해서 Prometheus 기반으로 Metric을 수집하는 Fork된 데모 Application을 검색을 통해 찾을수 있었다.<br>
<a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/census-ecosystem/opencensus-microservices-demo</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opencensus">OpenCensus<a class="hash-link" href="#opencensus" title="Direct link to heading">​</a></h2><p><a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">OpenCensus(OC)</a>는 Microservice 및 Monolith 서비스를 Tracing 및 Metric Monitoring 할 수 있는 라이브러리를 제공하는 오픈소스이다.</p><p>아래와 같이 다양한 언어를 지원 한다.</p><ul><li>Java , Go, Python, C++, Nodejs, Erlang, Ruby, PHP, C#</li></ul><p>또한 수집된 데이터를 Prometheus, Stackdriver Tracing and Monitoring, DataDog, Graphite, Zipkin, Jaeger, Azure Insights 등 과 같은 백엔드 Application으로 내보낼 수 있기 때문에 개발자, 운영자 측면에서 좋은 선택사항이 될 수 있다.  </p><p>Microservice와 같은 분산 시스템에서 개발자/운영자 관점의 가장 중요한 미션은 각각의 수행되는 서비스들의 실행 시간을 확인하고 상호 API간 통신이 얼마나 걸리는지를 확인하고 Span(아래 그림참조)에서 가장 지연이 발생하는 서비스를 빨리 찾아내 확인하고 조치하는 것이라 할 수 있다.</p><p><img loading="lazy" src="https://www.jaegertracing.io/img/spans-traces.png" alt="span" class="img_E7b_"></p><p>OpenCensus는 주로 두가지 기능으로 활용된다.<br>
<!-- -->첫번째는 Metric 수집이고 두번째는 Tracing 기능이다.<br>
<!-- -->Log같은 경우 현재 미지원이지만 다음 메이저 릴리즈에 추가될 예정이라고 하니 조금더 지켜보면 좋을것 같다.</p><ul><li><p>Metrics</p><ul><li>데이터베이스 및 API의 응답시간, 요청 content length, open file descriptor 수와 같이 추적하고자하는 정량 데이터를 말한다. Metric 을 시각화해서 보면 응용 프로그램 및 서비스의 성능과 품질을 측정하는 데 도움이 될 수 있다. 예를 들면 요청 응답시간의 평균값이나 cache hit/miss 수와 같은 것들이 될 수 있다. </li></ul></li><li><p>Traces</p><ul><li>서비스 요청에 대한 애플리케이션 또는 서비스 구조를 확인할수 있고 모든 서비스 간 데이터 흐름을 시각화하여 아키텍처상의 병목 현상을 파악하는 데 도움이 된다.</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hipster-shop-demo">Hipster Shop Demo<a class="hash-link" href="#hipster-shop-demo" title="Direct link to heading">​</a></h2><p>위에서 언급했던 내용처럼 GCP에서 작성한 <a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">Hipster Shop Demo</a>는 minikube 및 GCP 데모로 되어있고 코드안에 기본 Metric 설정이 Stackdriver으로 되어있어 Prometheus Exporter 적용을 하려면 코드 수정이 필요하기 때문에 Prometheus기반으로 작성된 <a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">Forked Repo</a>를 살펴보기로 하였다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h3><p>현재 가지고 있는 MacOS 환경에서 구동하였다. 최소 스펙은 따로 기재하지 않았으나 K8s 1.11 이상을 권장한다.</p><ul><li>kubectl : v1.10.7</li><li>Minikube : v0.34.1</li><li>Kubernetes : v1.13.3</li><li><a href="https://github.com/GoogleContainerTools/skaffold/#installation" target="_blank" rel="noopener noreferrer">skaffold</a> : v0.24</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="minikube-기동">minikube 기동<a class="hash-link" href="#minikube-기동" title="Direct link to heading">​</a></h3><p>최소 3 CPU, 6Gb Memory가 필요하다. 그냥 minikube를 구동시기면 4 CPU, 8Gb 로 구동이 되기 때문에 별다른 옵션 없이 default로 구동하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minikube   Ready     master    6h        v1.13.3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="repository-clone">Repository Clone<a class="hash-link" href="#repository-clone" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/census-ecosystem/opencensus-microservices-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> opencensus-microservices-demo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>내부 구조를 살펴보면 기본적으로 <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank" rel="noopener noreferrer">skaffold</a>를 활용하여 배포를 진행을 하는 것을 알수있다.<br>
<code>skaffold</code>는 로컬에서 Kubernetes 기반 어플리케이션 개발과 배포(CD)를 빠르게 도와주는 CLI tool이다. 소스코드의 변화를 감지하여 build, registry push/tagging, deploy까지 자동으로 할 수 있는 로컬 기반 도구이다.</p><p><code>skaffold dev</code>는 로컬 환경의 반복적인 개발에 활용하고 실제 배포는 CI Process에서 <code>skaffold run</code>을 통해 배포를 진행할 수 있다.  </p><p><img loading="lazy" src="https://github.com/GoogleContainerTools/skaffold/raw/master/docs/static/img/intro.gif" alt="skaffold demo" class="img_E7b_"></p><p>Kubernetes 배포툴에 대해 비교한 글은 <a href="https://blog.hasura.io/draft-vs-gitkube-vs-helm-vs-ksonnet-vs-metaparticle-vs-skaffold-f5aa9561f948/" target="_blank" rel="noopener noreferrer">블로그 링크</a>를 통해 확인할 수 있다.</p><p>아래에서는 <code>skaffold</code>에 대한 자세한 내용은 미뤄두고 배포하는 도구로서만 설명한다.  </p><p>기본적으로 구성을 하고자 하는 내용은 helm처럼 template 파일을 사용하게 되는데 프로젝트 root에 <code>skaffold.yaml</code> 에 build를 위한 image name, tag, src 위치등 기본적인 내용을 기재한다. 파일내용을 살펴보면 build에 관련된 내용들을 작성하고 deploy할 manifests의 위치까지 지정하도록 되어있다. 로컬환경에서 확인을 위해 grafana, prometheus, jaeger가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skaffold/v1alpha2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tagPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gitCommit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">artifacts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">manifests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manifests/</span><span class="token important">**.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Go로 작성된 Frontend microservice을 살펴보자. <!-- -->[<strong>./src/frontend/main.go</strong>]</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="library-추가-및-http-handler-초기화">library 추가 및 http handler 초기화<a class="hash-link" href="#library-추가-및-http-handler-초기화" title="Direct link to heading">​</a></h3><p>Go기반 exporter 패키지(jaeger,prometheus)를 추가적으로 import 하고 http handler를 위한 <a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener noreferrer">ochttp 패키지</a>를 추가하였다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/jaeger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp/propagation/b3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> handler http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">logHandler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensureSessionID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// add opencensus instrumentation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ochttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Propagation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPFormat</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting server on &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> addr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvPort</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">srvPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="exporter-등록jaeger-tracing-및-prometheus-exporter">exporter 등록(Jaeger Tracing 및 Prometheus exporter)<a class="hash-link" href="#exporter-등록jaeger-tracing-및-prometheus-exporter" title="Direct link to heading">​</a></h3><p>예시처럼 각각의 서비스에 jaeger와 prometheus exporter Endpoint를 쉽게 등록할수 있다.<br>
<!-- -->또한 initTracing() 에서는 데모를 위해 trace.AlwaysSample()을 사용하였다. 실제 운영환경에서는 <a href="https://github.com/census-instrumentation/opencensus-specs/blob/master/trace/Sampling.md" target="_blank" rel="noopener noreferrer">다음 링크</a>를 참고해서 사용하는 것을 권고하고 있다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Register the Jaeger exporter to be able to retrieve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// the collected spans.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://jaeger:14268&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Process</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Process</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ServiceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;frontend&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is a demo app with low QPS. trace.AlwaysSample() is used here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// to make sure traces are available for observation and analysis.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In a production environment or high QPS setup please use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// trace.ProbabilitySampler set at the desired probability.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ApplyConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DefaultSampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initPrometheusStatsExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error registering prometheus exporter&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startPrometheusExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:9090&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting prometheus server at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/metrics&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="demo-application-배포">Demo Application 배포<a class="hash-link" href="#demo-application-배포" title="Direct link to heading">​</a></h3><p>minikube에 Hipster Shop Demo를 배포한다. 단순하게 <code>skaffold run</code> 명령으로 진행하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold run</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 사용중인 2018 Macbook Pro(3.1 GHz Intel Core i7, 16GB) 상의 Docker기반 minikube 환경으로도 배포를 하였는데 시간이 꽤 소요되었다.(20분이상)<br>
<!-- -->코드를 실시간으로 수정하고 빌드, 배포되는 것은 <code>skaffold dev</code> 명령으로 확인할 수 있다. 진행되는 과정을 보면 <a href="https://draft.sh/" target="_blank" rel="noopener noreferrer">draft.sh</a> 프로젝트와도 꽤 유사하다고 볼 수 있다.  </p><p>에러없이 run이 실행되고 난후 minikube에 배포된 pod와 service를 확인한다. 중간에 loadgenerator가 init인 이유는 minikube 자원이 부족해서 발생하는 현상이다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS     RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice-7c7d687dcb-xzr4m               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice-f54bcb9ff-tcfgn              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice-576446687b-95bwj         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice-5bd99bf97d-28mtz         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice-6cb587798d-wwzdh            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-6bf9796f7b-ch9pl                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-6678c5c5d9-2qx75                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-5b66bdf7f7-csdzx                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loadgenerator-7c4f446774-68djg           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1       Init:0/1   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice-fc4c8589-wrfg7            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice-84878c8b9c-jhgnw   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-58d98b7578-87td6              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice-8564f9d894-smlpf   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart-798bc66d58-xn6ff              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice-789656f6bc-rgzrp         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice               ClusterIP      </span><span class="token number" style="color:#36acaa">10.107</span><span class="token plain">.196.115   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9555</span><span class="token plain">/TCP,9090/TCP                                                  4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice             ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.151.164    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7070</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.9.197      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5050</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.112.225   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice            ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.184.174    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend                ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.40.138    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP,9090/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-external       LoadBalancer   </span><span class="token number" style="color:#36acaa">10.108</span><span class="token plain">.170.241   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:31944/TCP                                                       4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana                 ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.141.254   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-external        LoadBalancer   </span><span class="token number" style="color:#36acaa">10.102</span><span class="token plain">.166.138   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:30459/TCP                                                     4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger                  ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.71.173     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain">/TCP,5775/UDP,6831/UDP,6832/UDP,5778/TCP,16686/TCP,14268/TCP   4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-external         LoadBalancer   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.164.126    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">16686</span><span class="token plain">:32362/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes              ClusterIP      </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.1        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                                                            6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice          ClusterIP      </span><span class="token number" style="color:#36acaa">10.109</span><span class="token plain">.31.241    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.124.106   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3550</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus              ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.107.213   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.225.28    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart              ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.24.157    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">6379</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.224.18    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="서비스-접속-및-metrictracing-확인">서비스 접속 및 Metric/Tracing 확인<a class="hash-link" href="#서비스-접속-및-metrictracing-확인" title="Direct link to heading">​</a></h3><p>로컬 minikube환경이기 때문에 external service가 pending이므로 service를 minikube NAT IP로 expose 시킨다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> frontend-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> grafana-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> jaeger-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAMESPACE  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         NAME          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">             URL             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> adservice             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cartservice           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> checkoutservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> currencyservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> emailservice          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend-external     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:31944 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana-external      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:30459 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger-external       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:32362 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubernetes            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paymentservice        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> productcatalogservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> prometheus            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> recommendationservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> redis-cart            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shippingservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-system </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-dns              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3개의 서비스로 각각 접속이 되는것을 확인할수 있다.
Grafana 대시보드로 들어가면 현재 수집되는 prometheus source(http://prometheus:9090)를 통해 OpenCensus기반 Application Metric을 확인할 수 있다.</p><p><img loading="lazy" alt="hipster_grafana" src="/assets/images/hipster_grafana-13ab198ab40c06a5c6ba6bc61e3725ad.png" width="2878" height="1488" class="img_E7b_"></p><p>그림에서 보면 전체 서비스 응답에 대한 99% 백분위 지연시간이 944ms 인것을 확인할 수 있다. </p><p>또한 Jaeger를 통해 DAG(Directed acyclic graph) 및 서비스간 Tracing 을 확인할 수 있다.</p><p><img loading="lazy" alt="DAG" src="/assets/images/dag-0e49356be3f8676a292785832fbc1981.png" width="3146" height="1782" class="img_E7b_"></p><p><img loading="lazy" alt="tracing" src="/assets/images/tracing-b9038c7a3151b467c5f7d4dc08786f75.png" width="3172" height="1442" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>OpenCensus 기반으로 개발자가 코드를 작성하고 Microservice를 minikube에서 배포하고 Prometheus, Jaeger Exporter 연동을 통해 시스템뿐만이 아닌 Application기반 Metrics/Stats을 수집하고 개발자가 작성한 코드를 직접 Tracing하는 간단한 데모를 진행하였다. (Istio를 포함해서 Public환경에 배포해봐도 좋은 공부가 될 것 같다)  </p><p>향후 <a href="https://openmetrics.io/" target="_blank" rel="noopener noreferrer">OpenMetric</a>과 <a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">Opencensus</a>가 실제 개발자 기반으로 활성화되고 적용이 된다면 Telemetric 측면에서 많은 Use-Case가 도출될 수 있을것 같다.  </p><p>위에서 언급했듯이 Prometheus기반 Kubernetes 클러스터를 운영하고 있는 팀의 경우 개발자의 작성 코드를 최소화할 수 있는 도구로서 충분히 활용될 수 있어 보인다.  </p><p>꼭 Cloud Native 기반 Web 개발이 아니더라도 기존 공장, 금융, 병원 등 의 IoT나 센서/설비를 위한 비즈니스에도 Backend로서 확장성있는 도구로서 활용이 될 수 있을것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stackdriver/">Stackdriver</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prometheus/">Prometheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/g-rpc/">gRPC</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/open-census/">OpenCensus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/skaffold/">skaffold</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud-Native Microservices Demo Application with OpenCensus" href="/kubernetes/microservices-demo/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/cilium-1/">Cilium</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2018</time> · <!-- -->17 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-누구냐-넌">Cilium 누구냐 넌?<a class="hash-link" href="#cilium-누구냐-넌" title="Direct link to heading">​</a></h2><p>처음에 놀랐다. 번역하면 &#x27;자궁&#x27;, &#x27;섬모&#x27;, &#x27;속눈썹&#x27;등 익숙치 않은 단어라서 놀랐지만 차근히 보다보니 결국 OS내부(리눅스 커널)에서부터 컨테이너간 또는 외부와의 연결을 보호하는 역할이라고 하니 이해가 되는 것 같다.</p><p>홈페이지에 정의된 내용을 보면 아래 내용과 같다. </p><blockquote><p><a href="https://cilium.readthedocs.io/en/v1.1/intro/#what-is-cilium" target="_blank" rel="noopener noreferrer">Cilium</a> - Docker 및 Kubernetes와 같은 Linux 컨테이너 관리 플랫폼을 사용하여 배포된 응용 프로그램 서비스 간의 네트워크 연결을 보호하는 오픈 소스 소프트웨어</p></blockquote><p>페북에 <a href="https://www.facebook.com/groups/korelnxuser/" target="_blank" rel="noopener noreferrer">한국 리눅스 사용자 그룹</a>에서도 <a href="https://www.facebook.com/tommy.lee.98229" target="_blank" rel="noopener noreferrer">Tommy Lee</a>님이나 <a href="https://www.facebook.com/changan.song" target="_blank" rel="noopener noreferrer">송창안</a>님이 몇몇 게시물을 올려주셔서 관심있게 보던중에 아래와 같은 내용을 보고 이거다 하고 파보기 시작했다.</p><blockquote><p>Cilium은 Docker 및 Kubernetes와 같은 리눅스 컨테이너 프레임 워크에 API 기반의 네트워크 보안 필터링을 제공하며,
또한, BPF라는 새로운 Linux 커널 기술을 사용하여 컨테이너/POD ID를 기반으로 네트워크 계층 및 응용 프로그램 계층 보안 정책을 정의 및 적용하는 것에 있어서 간단하면서 효율적인 방법을 제공하고 있습니다.</p></blockquote><p>윗분들처럼 커널 자체를 분석하고 공부하고 기여하려면 소요되는 시간이 더 걸릴거 같고 서비스를 운영하고 개발하는 입장에서는 내 프로젝트에 적용 가능성을 검증하는것이 나을것 같아 정리를 해본다.</p><p>iptables을 기반으로 IP와 Port기반의 전통적인 포워딩 기술은 벌써 20년이라는 세월동안 널리 사용되어 왔다. 특히 퍼블릭/프라이빗 클라우드 제품군들 모두 iptables기반의 Security Group등을 기본으로 제공하고 있고 Kubernetes 마저도 CNI 핵심으로 iptables을 활용하고 있다.  </p><p>동적으로 변화하고 매우 복잡한 마이크로서비스를 사용하는 시대에 전통적인 방식의 IP, Port관리는 비효율적인 측면이 없지 않다. BPF(아래인용)을 활용하여 리눅스 커널내에서 데이터 포워딩을 할 수 있고 Kubernetes Service기반 Load Balancing이나 istio와 같은 Service Mesh를 위한 Proxy Injection 을 통해 여러 활용을 할 수 있을거라고 Cilium 프로젝트는 이야기 하고 있다. </p><blockquote><p>버클리 패킷 필터(Berkeley Packet Filter, BPF)</p><p>BPF는 버클리 패킷 필터(Berkeley Packet Filter)의 줄임말이다. 이름 그대로 패킷을 걸러내는 필터이다. 그런데 BSD에서의 BPF는 네트워크 탭(리눅스의 PF_PACKET)까지 아우르는 개념이다. 옛날 옛적에 유닉스에는 CSPF(CMU/Stanford Packet Filter)라는 게 있었는데 BPF라는 새 구조가 이를 대체했다. 이후 리눅스에서는 네트워크 탭을 나름의 방식으로 구현하고 패킷 필터 부분만 가져왔다. 리눅스의 패킷 필터를 리눅스 소켓 필터링(LSF: Linux Socket Filtering)이라고도 한다.<br>
<!-- -->(발췌) <a href="https://wariua.github.io/facility/extended-bpf.html" target="_blank" rel="noopener noreferrer">https://wariua.github.io/facility/extended-bpf.html</a> </p></blockquote><p>Cilium은 Dockercon 2017에서 최초 <a href="https://www.youtube.com/watch?v=ilKlmTDdFgk" target="_blank" rel="noopener noreferrer">announce</a>를 하였고 2018년 4월 24일에 1.0이 정식 Release된 이후 많은 관심을 받을것으로 예상되어 실제 서비스에 적용해볼 필요가 있을거 같아 minikube로 테스트한 내용을 끄젹여 본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-architecture">Cilium Architecture<a class="hash-link" href="#cilium-architecture" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="Cilium Architecture" src="/assets/images/cilium_arch-96f6efd4a70465e9cbfd890e9da1f159.png" width="700" height="624" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="main-feature">Main Feature<a class="hash-link" href="#main-feature" title="Direct link to heading">​</a></h2><ul><li>고효율 BPF Datapath  <ul><li>모든 데이터 경로가 클러스터 전체에 완전 분산</li><li>Envoy같은 proxy injection 제공, 추후 sidecar proxy 형태 제공예정</li></ul></li><li>CNI, CMM plugins  <ul><li>Kubernetes, Mesos, Docker에 쉽게 통합가능</li></ul></li><li>Packet, API 네트워크 보안<br>패킷기반 네트워크 보안과 API 인증을 결합하여 전통적인 패킷기반 네트워크 보안과 마이크로서비스 아키텍처 모두에게 보안 제공가능  <ul><li><a href="http://docs.cilium.io/en/doc-1.0/concepts/#arch-id-security" target="_blank" rel="noopener noreferrer">ID기반</a> - Source IP에만 의존하지 않고 모든패킷에 workload identity를 encoding하여 식별성 강화  </li><li><a href="http://docs.cilium.io/en/doc-1.0/policy/language/#ip-cidr-based" target="_blank" rel="noopener noreferrer">IP/CIDR기반</a>이외에도 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#services-based" target="_blank" rel="noopener noreferrer">Kubernetes Service기반</a>으로 정책 설정가능</li><li>L7기반 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#layer-7-examples" target="_blank" rel="noopener noreferrer">API보안</a> 적용가능</li></ul></li><li>분산,확장가능한 Load Balacing
BPF를 사용한 고성능 L3,L4 Load Balancer 제공
(Hasing, Weighted round-robin)<ul><li>kube-proxy 대체 - Kubernetes ClusterIP가 생성될때 BPF기반으로 자동으로 적용됨 </li><li><a href="http://docs.cilium.io/en/doc-1.0/api/" target="_blank" rel="noopener noreferrer">API driven</a> - 직접 API를 활용하여 확장가능</li></ul></li><li>단순화된 네트워크 모델<br>Overlay/VXLAN, Direct/Native Routing 지원</li><li>가시성  <ul><li><a href="https://github.com/cilium/microscope" target="_blank" rel="noopener noreferrer">Microscope</a> - 클러스터 레벨에서 모든 이벤트 필터링 가능</li><li>API기반 가시성 제공</li></ul></li><li>운영<ul><li>클러스터 헬스체크 - HTTP, ICMP기준 클러스터 latency 체크가능</li><li>Prometheus 통합 - 모든 메트릭을 Prometheus로 전달가능</li><li>클러스터 분석 및 <a href="http://docs.cilium.io/en/doc-1.0/troubleshooting/#cluster-diagnosis-tool" target="_blank" rel="noopener noreferrer">리포트툴</a> </li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h2><ul><li>kubectl &gt;= 1.7.0</li><li>minikube &gt;= 0.22.3</li></ul><p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a> 설치와 <a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="noopener noreferrer">minikube</a> 구성은 별도로 해야한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="start-minikube">Start minikube<a class="hash-link" href="#start-minikube" title="Direct link to heading">​</a></h2><p>넉넉하게 4GB 이상 메모리로 minikube를 구동한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start --kubernetes-version v1.9.0 --network-plugin=cni --extra-config=kubelet.network-plugin=cni --memory=5120 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-minikube-cluster-status">Check minikube cluster status<a class="hash-link" href="#check-minikube-cluster-status" title="Direct link to heading">​</a></h2><p>minikube구성이 완료되면 아래와 같이 클러스터 상태를 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE              ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   {&quot;health&quot;: &quot;true&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-etcd-dependency-of-cilium">Install etcd (dependency of cilium)<a class="hash-link" href="#install-etcd-dependency-of-cilium" title="Direct link to heading">​</a></h2><p>cilium 의존성을 위해 etcd를 별도로 배포한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -n kube-system -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/addons/etcd/standalone-etcd.yaml  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service &quot;etcd-cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps &quot;etcd-cilium&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-all-pods-etcd">Check all pods (etcd)<a class="hash-link" href="#check-all-pods-etcd" title="Direct link to heading">​</a></h2><p>모든 pod가 <code>Running</code> 상태인지 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-cilium-0                      1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-minikube                      1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-addon-manager-minikube        1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-apiserver-minikube            1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-controller-manager-minikube   1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-86f4d74b45-lhzfv          3/3       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-tcd7h                   1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-scheduler-minikube            1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   storage-provisioner                1/1       Running   0          4m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-cilium">Install Cilium<a class="hash-link" href="#install-cilium" title="Direct link to heading">​</a></h2><p>Kubernetes 클러스터에 Cilium을 인스톨한다. 기본적으로 DaemonSet 형태로 배포되기 때문에 Node당 한개의 Cilium Pod를 볼 수 있다. Cilium은 <code>kube-system</code> namespace에서 실행된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/1.9/cilium.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap &quot;cilium-config&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret &quot;cilium-etcd-secrets&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.extensions &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io &quot;cilium&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount &quot;cilium&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kube-system namespace에 RBAC설정과 함께 Cilium이 배포되고, ConfigMap, DaemonSet 형태로 배포가 된다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-deployment">Check deployment<a class="hash-link" href="#check-deployment" title="Direct link to heading">​</a></h2><p>Cilium Deployment가 <code>READY</code> 상태로 바뀔때까지 기다린다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get daemonsets -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium    1         1         1         1            0           &lt;none&gt;          2m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploy-demo-app">Deploy Demo App.<a class="hash-link" href="#deploy-demo-app" title="Direct link to heading">​</a></h2><p>아래 데모그림을 보면 스타워즈의 영감을 받아서인지 deathstar, xwing 등으로 구분한것을 확인할수 있다. deathstar deployments의 경우 80포트로 http 웹서버가 2개의 pod replica로 Load Balancing되고 있다. deathstar 서비스는 우주선이 착륙할수 있도록 활주로를 서비스하고 있다. 하지만 제국군의 tiefighter 만 착륙하도록 해야하므로 보안설정을 해야하는 상황이다. </p><p><img loading="lazy" src="https://cilium.readthedocs.io/en/v1.1/_images/cilium_http_gsg.png" alt="starwars" class="img_E7b_"></p><p>아래 <code>http-sw-app.yaml</code> 은 세가지 deployment를 가지고 있고 각각의 deployment는 <code>(org=empire, class=deathstar)</code>, <code>(org=empire, class=tiefighter)</code>, <code>(org=alliance, class=xwing)</code>와 같이 label 정보를 가진다. deathstar Service는 <code>(org=empire, class=deathstar)</code> label을 가지고 Load Balancing을 한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/http-sw-app.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service &quot;deathstar&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;deathstar&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;tiefighter&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;xwing&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>총 4개의 pod와 1개의 서비스를 확인할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-mqgfs   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/deathstar    ClusterIP   10.109.80.174   &lt;none&gt;        80/TCP    1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>각각의 pod는 Cilium에서는 <a href="https://cilium.readthedocs.io/en/v1.1/concepts/#endpoint" target="_blank" rel="noopener noreferrer">Endpoints</a>형태로 표현된다. 아래와 같이 ingress, egress policy를 확인할수 있고 아직 아무런 network policy 적용을 하지 않았기 때문에 모두 <code>Disabled</code> 상태로 보인다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system get pods -l k8s-app=cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-jmxk2   1/1       Running   0          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                    IPv6                 IPv4            STATUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ENFORCEMENT        ENFORCEMENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5023       Disabled           Disabled          2008       k8s:io.cilium.k8s.policy.serviceaccount=istio-ingress-service-account          f00d::a0f:0:0:139f   10.15.170.241   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7415       Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:1cf7   10.15.16.224    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7979       Disabled           Disabled          4          reserved:health                                                                f00d::a0f:0:0:1f2b   10.15.96.215    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17917      Disabled           Disabled          60941      k8s:class=tiefighter                                                           f00d::a0f:0:0:45fd   10.15.58.61     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">22602      Disabled           Disabled          53004      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:584a   10.15.190.2     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=telemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">31992      Disabled           Disabled          33709      k8s:io.cilium.k8s.policy.serviceaccount=istio-egressgateway-service-account    f00d::a0f:0:0:7cf8   10.15.85.192    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=egressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">33958      Disabled           Disabled          64389      k8s:io.cilium.k8s.policy.serviceaccount=istio-citadel-service-account          f00d::a0f:0:0:84a6   10.15.59.151    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=citadel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">49215      Disabled           Disabled          40629      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:c03f   10.15.48.171    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55129      Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:d759   10.15.17.253    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55930      Disabled           Disabled          46893      k8s:app=prometheus                                                             f00d::a0f:0:0:da7a   10.15.196.220   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57491      Disabled           Disabled          775        k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:e093   10.15.253.210   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=statsd-prom-bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57651      Disabled           Disabled          44171      k8s:io.cilium.k8s.policy.serviceaccount=istio-ingressgateway-service-account   f00d::a0f:0:0:e133   10.15.74.164    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61352      Disabled           Disabled          888        k8s:io.cilium.k8s.policy.serviceaccount=istio-pilot-service-account            f00d::a0f:0:0:efa8   10.15.118.68    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=pilot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61355      Disabled           Disabled          36797      k8s:class=xwing                                                                f00d::a0f:0:0:efab   10.15.56.79     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=alliance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 상태에서는 모든 우주선이 deathstar에 착륙이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l3l4-policy-적용">L3/L4 Policy 적용<a class="hash-link" href="#l3l4-policy-적용" title="Direct link to heading">​</a></h2><p>결국 하고 싶은건 제국군 우주선 즉, tiefighter만 접근이 가능해야 하므로 아래처럼 정책을 설정한다. </p><p>정책은 직관적으로 설정이 가능하다.</p><p><code>org=empire, class=deathstar</code> label을 가진 endpoint로의 ingress 방향의 80포트 접근은 <code>org=empire</code> label을 가진 pod만 가능하도록 한다는 의미이다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;cilium.io/v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: &quot;L3-L4 policy to restrict deathstar access to empire ships only&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;rule1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는 </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_policy.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 설정하고 나서 tiefighter를 착륙시켜보자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상착륙!<br>
<!-- -->이번에는 xwing 차례</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>착륙실패!</p><p>이어서 정책을 다시 확인해보면 Enabled로 변한 정책 2개를 확인할 수 있다.<br>
<!-- -->(pod가 2개이므로 2개의 정책을 볼 수 있다)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>상세 정책 확인 (Very Simple!!)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cnp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar   2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule1           5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$  kubectl describe cnp rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    30312</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  65</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l7-정책-적용">L7 정책 적용<a class="hash-link" href="#l7-정책-적용" title="Direct link to heading">​</a></h2><p>마지막으로 deathstar API를 호출하는 서비스에 대한 정책을 제어하는것을 테스트해본다.</p><p>아래 예시처럼 exhaust-port API(포트를 소진시키는 API)를 수행하면 특정 pod가 에러가 나고 재기동 되는것을 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Panic: deathstar exploded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goroutine 1 [running]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:9 +0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:5 +0x85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   0/1       Error     0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   1/1       Running   1          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그래서 이번에는 exhaust-port API는 차단하고 request-landing API만 허용하는 정책을 테스트해본다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;cilium.io/v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: &quot;L7 policy to restrict access to specific HTTP call&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: &quot;rule1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - method: &quot;POST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path: &quot;/v1/request-landing&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_l7_policy.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ciliumnetworkpolicy.cilium.io/rule1 configured</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 동일한 테스트를 해보면 다른 결과를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access denied</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다시한번 상세 정책 확인을 해보면 ingress POST 허용정책을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe ciliumnetworkpolicies rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  kubectl.kubernetes.io/last-applied-configuration={&quot;apiVersion&quot;:&quot;cilium.io/v2&quot;,&quot;description&quot;:&quot;L7 policy to restrict access to specific HTTP call&quot;,&quot;kind&quot;:&quot;CiliumNetworkPolicy&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    32814</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Method:  POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Path:    /v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Kubectl . Kubernetes . Io / Last - Applied - Configuration:  {&quot;apiVersion&quot;:&quot;cilium.io/v2&quot;,&quot;description&quot;:&quot;L7 policy to restrict access to specific HTTP call&quot;,&quot;kind&quot;:&quot;CiliumNetworkPolicy&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;rule1&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;endpointSelector&quot;:{&quot;matchLabels&quot;:{&quot;class&quot;:&quot;deathstar&quot;,&quot;org&quot;:&quot;empire&quot;}},&quot;ingress&quot;:[{&quot;fromEndpoints&quot;:[{&quot;matchLabels&quot;:{&quot;org&quot;:&quot;empire&quot;}}],&quot;toPorts&quot;:[{&quot;ports&quot;:[{&quot;port&quot;:&quot;80&quot;,&quot;protocol&quot;:&quot;TCP&quot;}],&quot;rules&quot;:{&quot;http&quot;:[{&quot;method&quot;:&quot;POST&quot;,&quot;path&quot;:&quot;/v1/request-landing&quot;}]}}]}]}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cilium CLI로도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl -n kube-system exec cilium-jmxk2 cilium policy get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;endpointSelector&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;reserved:init&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ingress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fromEntities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;host&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;egress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toPorts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ports&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;port&quot;: &quot;53&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;protocol&quot;: &quot;UDP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toEntities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;all&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toEndpoints&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;istio-system&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;labels&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;istio-sidecar&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;endpointSelector&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;any:class&quot;: &quot;deathstar&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;any:org&quot;: &quot;empire&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ingress&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fromEndpoints&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;matchLabels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;any:org&quot;: &quot;empire&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;k8s:io.kubernetes.pod.namespace&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;toPorts&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ports&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;port&quot;: &quot;80&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;protocol&quot;: &quot;TCP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;rules&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;http&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;path&quot;: &quot;/v1/request-landing&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;method&quot;: &quot;POST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;labels&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;rule1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;key&quot;: &quot;io.cilium.k8s.policy.namespace&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;value&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;source&quot;: &quot;k8s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision: 71</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이외에도 Cilium Metric을 Prometheus에서 확인하는것도 간단하게 할수 있다고 한다. </p><p>여기까지가 기본적으로 L3/L4, L7 기반 network policy를 적용해본것이고 다음번에는 istio와 연계 부분이나 실제 Cluster 구성방법에 대해서 다뤄보도록 하겠다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cilium/">Cilium</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/network-policy/">network policy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bpf/">BPF</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cni/">CNI</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cilium" href="/kubernetes/cilium-1/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/mutating-web-hook/">Mutating Webhook</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-06-27T00:00:00.000Z" itemprop="datePublished">June 27, 2018</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="admission-controller-확장">Admission controller 확장<a class="hash-link" href="#admission-controller-확장" title="Direct link to heading">​</a></h2><p>Kubernetes(이하 k8s)기반 개발 과제를 수행하다보니 Custom Resource를 사용할수 밖에 없는 상황들이 발생하였다.<br>
<!-- -->그런 와중에 istio와 같은 Service Mesh Layer를 리서치하던 중에 튀어나온 MutatingAdmissionWebhook 용어를 이해하기 위에 조사한 내용을 정리해본다.</p><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/</a></p><p>Admission controller는 쿠버네티스 api-server의 오브젝트(Pod,등) 생성 요청을 가로체어 제어를 할 수 있는 확장 기능으로 플러그인 형태로 사용자가 추가 할 수 있다.<br>
<!-- -->좀더 자세히 확인해보자 </p><ul><li>클러스터 관리자가 kube-api를 직접 컴파일 하고 구성해야 하기 때문에 유연하게 사용하기 어려움</li><li>1.7 버전 이후부터는 이러한 제한사항을 해결하기 위해 alpha feature로  <a href="https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#initializers" target="_blank" rel="noopener noreferrer">Initializers</a> 와 <a href="https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#external-admission-webhooks" target="_blank" rel="noopener noreferrer">External Admission Webhooks</a> 기능이 도입됨</li><li>External Admission Webhooks 는 k8s 리소스의 유효성 검사를 하는데 활용, 유효성 검사를 통과 하지 못하면 해 당 리소스는 쿠버네티스에서 생성되질 않게 할 수 있음.</li><li>1.9 버전에서는 External Admission Webhooks 은 beta로 승격되어 MutatingAdmissionWebhook 및 ValidatingAdmissionWebhook으로 나눠졌지만 Initializers 는 alpha 로 유지됨</li><li>MutatingAdmissionWebhook 은 유효성 검사 이외에도 승인 과정시 k8s object에 변경을 할수 있음<ul><li>예를 들면 resource quota를 변경한다던지  Agones 및 istio와 같은 Custom Resource 를 수정하여 object를 생성이 가능함</li><li>Webhook 방식은 gRPC 프로토콜을 사용하는 데 개발언어에 구애 받지 않고 확장을 할 수 있다는 장점이 있음</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="webhook을-언제-쓰는가">Webhook을 언제 쓰는가?<a class="hash-link" href="#webhook을-언제-쓰는가" title="Direct link to heading">​</a></h2><p>Webhook을 사용하여 k8s cluster-admin이 api-server를 다시 컴파일하지 않고도 object생성 요청시 mutating(변경) 및 validation(유효성검증) 을 하는 플러그인을 만들 수 있다. </p><p>이를 통해 개발자는 모든 resource 에서 여러 작업 ( &quot;CREATE&quot;, &quot;UPDATE&quot;, &quot;DELETE&quot;...)에 대한 승인 로직에 대해 사용자 정의 할 수있는 유연성을 제공받는다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="use-case">Use-Case<a class="hash-link" href="#use-case" title="Direct link to heading">​</a></h2><ul><li><p>resource를 생성하기 전에 변경<br>
<!-- -->(예, Istio 에서 처럼 traffic management 와 policy enforcement 을 위해 Envoy sidecar container를 injection)</p></li><li><p>StorageClass Provisioning 자동화<br>
<!-- -->(PersistentVolumeClaim object 생성을 모니터링하고 미리 정의 된 정책에 따라 객체에 storage를 자동으로 추가. 사용자는 StorageClass 생성 에 신경 쓸 필요가 없음)</p></li><li><p>복잡한 custom resource 검증 (Agones와 같은)namespace 제한<br>
<!-- -->멀티 테넌트 시스템에서는 reserved namespace에 resource생성을 금지시킬때 사용할수 있음</p></li><li><p>참고 예시<br>
<a href="https://github.com/kelseyhightower/denyenv-validating-admission-webhook" target="_blank" rel="noopener noreferrer">https://github.com/kelseyhightower/denyenv-validating-admission-webhook</a></p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="어떻게-동작하는가">어떻게 동작하는가?<a class="hash-link" href="#어떻게-동작하는가" title="Direct link to heading">​</a></h2><p>MutatingWebhookConfiguration 내에 정의된 룰에 따라 etcd로 전달되기 전에 request를 intercept한다.<br>
<!-- -->webhook 서버에 승인 요청을 전송하여 변이를 실행한다.<br>
<!-- -->webhook 서버는 API를 준수하는 단순한 http서버.</p><p><img loading="lazy" alt="Alt text" src="/assets/images/mutating-b4b8965d675e621d8560c81accf497c7.jpg" width="1600" height="1643" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="튜토리얼">튜토리얼<a class="hash-link" href="#튜토리얼" title="Direct link to heading">​</a></h2><p><a href="https://github.com/morvencao/kube-mutating-webhook-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/morvencao/kube-mutating-webhook-tutorial</a>  </p><p>위 튜토리얼은 object가 생성되기 전에 pod에 nginx sidecar container를 inject하는 MutatingAdmissionWebhook을 배포하는 내용을 담고 있다.</p><p>우선 admissionregistration.k8s.io/v1beta1 API를 사용할수 있는 k8s 1.9+ 이상의 클러스터가 필요하다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="확인방법">확인방법<a class="hash-link" href="#확인방법" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl api-versions | grep admissionregistration.k8s.io/v1beta1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>아래와 같은 결과가 나와야함</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">admissionregistration.k8s.io/v1beta1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build하기">Build하기<a class="hash-link" href="#build하기" title="Direct link to heading">​</a></h2><p>일단 Go가 설치되어 있어야 한다.
<code>~/go/src</code> 아래에 clone을 하였음.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd ~/go/src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/morvencao/kube-mutating-webhook-tutorial.git</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>의존성 관리를 위해 repo는 dep를 사용함</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go get -u github.com/golang/dep/cmd/dep</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build 파일 확인하고 registry 위치를 바꿈</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">dep ensure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o kube-mutating-webhook-tutorial .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build --no-cache -t registry.*****.io/agones/sidecar-injector:v1 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push registry.*****.io/agones/sidecar-injector:v1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build하고 docker image push</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sending build context to Docker daemon  44.29MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1/3 : FROM alpine:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 3fd9065eaf02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2/3 : ADD kube-mutating-webhook-tutorial /kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 8679ccbab536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3/3 : ENTRYPOINT [&quot;./kube-mutating-webhook-tutorial&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; Running in 7699ff5c0885</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Removing intermediate container 7699ff5c0885</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 2014100d460e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully built 2014100d460e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully tagged registry.*****.io/agones/sidecar-injector:v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The push refers to repository [registry.*****.io/agones/sidecar-injector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2456c1309a51: Pushed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd7100a72410: Layer already exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v1: digest: sha256:15c335daeba40ddcbfbc3631ab6daa7cf623b63420f0ae8b657755322ef0582d size: 739</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>sidecar deployment에 사용되는 secret(cert/key)을 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./deployment/webhook-create-signed-cert.sh \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --service sidecar-injector-webhook-svc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret sidecar-injector-webhook-certs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 생성된 클러스터의 caBundle값을 가지고 MutatingWebhookConfiguration 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat deployment/mutatingwebhook.yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deployment/webhook-patch-ca-bundle.sh &gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deployment/mutatingwebhook-ca-bundle.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>resource들 deploy</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f deployment/nginxconfigmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/configmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/mutatingwebhook-ca-bundle.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap &quot;nginx-configmap&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap &quot;sidecar-injector-webhook-configmap&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions &quot;sidecar-injector-webhook-deployment&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service &quot;sidecar-injector-webhook-svc&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mutatingwebhookconfiguration.admissionregistration.k8s.io &quot;sidecar-injector-webhook-cfg&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>webhook deployment 확인</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment   1         1         1            1           3m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>default 네임스페이스에 sidecar-injector 라벨링을 한다. 이렇게 하면 해당 네임스페이스에 생성되는 모든 app에 자동으로 injection하게 됨</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespace -L sidecar-injector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             STATUS    AGE       SIDECAR-INJECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agones-system    Active    1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default          Active    19d       enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ibm-cert-store   Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ibm-system       Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-test     Active    6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public      Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system      Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spinnaker        Active    12d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xonotic          Active    1d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>샘플앱을 디플로이 해보자</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat &lt;&lt;EOF | kubectl create -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sidecar-injector-webhook.morven.me/inject: &quot;yes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: tutum/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command: [&quot;/bin/sleep&quot;,&quot;infinity&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions &quot;sleep&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>sidecar container injection 확인<br>
<!-- -->아래 결과를 보면 하나의 deployment 하나의 container 생성을 요청했지만 nginx sidecar 컨테이너가 injection 된것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleep-74b46f8bd7-r9l7f                                 2/2       Running   0          42s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe pod sleep-74b46f8bd7-r9l7f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:           sleep-74b46f8bd7-r9l7f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:      default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node:           10.178.188.16/10.178.188.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start Time:     Wed, 27 Jun 2018 13:12:47 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:         app=sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pod-template-hash=3060294683</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:    kubernetes.io/psp=ibm-privileged-psp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sidecar-injector-webhook.morven.me/inject=yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sidecar-injector-webhook.morven.me/status=injected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:         Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP:             172.30.169.30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controlled By:  ReplicaSet/sleep-74b46f8bd7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sleep:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container ID:  docker://728ca7f8e741ad29369312bc006c79683e7e605f3b04586df2477e233f93e451</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:         tutum/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image ID:      docker-pullable://tutum/curl@sha256:b6f16e88387acd4e6326176b212b3dae63f5b2134e69560d0b0673cfb0fb976f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:          &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:     &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Wed, 27 Jun 2018 13:13:01 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Restart Count:  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:    &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-czzpj (ro)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sidecar-nginx:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container ID:   docker://94fd41a0e153de6d5639873ccbd6b6325cee1ea8351dd02ab4a48ab4004d0b58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:          nginx:1.12.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image ID:       docker-pullable://nginx@sha256:72daaf46f11cc753c4eab981cbf869919bd1fee3d2170a2adeac12400f494728</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:           80/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:      0/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Wed, 27 Jun 2018 13:13:08 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Restart Count:  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:    &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/nginx from nginx-conf (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Conditions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Type           Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Initialized    True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ready          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PodScheduled   True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default-token-czzpj:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type:        Secret (a volume populated by a Secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SecretName:  default-token-czzpj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional:    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx-conf:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type:        ConfigMap (a volume populated by a ConfigMap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name:        nginx-configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional:    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QoS Class:       BestEffort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node-Selectors:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Type    Reason                 Age   From                    Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ----    ------                 ----  ----                    -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Scheduled              1m    default-scheduler       Successfully assigned sleep-74b46f8bd7-r9l7f to 10.178.188.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume &quot;nginx-conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume &quot;default-token-czzpj&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulling                1m    kubelet, 10.178.188.16  pulling image &quot;tutum/curl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulled                 55s   kubelet, 10.178.188.16  Successfully pulled image &quot;tutum/curl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Created                55s   kubelet, 10.178.188.16  Created container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Started                55s   kubelet, 10.178.188.16  Started container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulling                55s   kubelet, 10.178.188.16  pulling image &quot;nginx:1.12.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulled                 48s   kubelet, 10.178.188.16  Successfully pulled image &quot;nginx:1.12.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Created                48s   kubelet, 10.178.188.16  Created container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Started                48s   kubelet, 10.178.188.16  Started container</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>결국 위에서 언급한것 처럼 MutationWebhook은 istio RouteRule같은 별도의 CustomResource등을 injection 하거나 agones 등과 같이 게임서버외에 client sdk 통신을 위한 injection 형태로 기존 resource에 추가적인 변경(mutation) 또는 검증(validation)등의 추가적인 작업을 kube-api의 컴파일없이 가능하다는데 목적이 있다고 볼 수 있다. 추가적으로 기능에 대한 내용은 이후 다시 정리해볼 예정이다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/mutating-webhook/">Mutating Webhook</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/admission-controller/">Admission Controller</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/agones/">Agones</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Mutating Webhook" href="/kubernetes/mutating-web-hook/"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.b94385cb.js"></script>
<script src="/assets/js/main.0346262c.js"></script>
</body>
</html>