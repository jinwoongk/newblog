<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://ddii.dev/</id>
    <title>Act as a catalyst</title>
    <updated>2022-03-18T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://ddii.dev/"/>
    <subtitle>Act as a cloud catalyst</subtitle>
    <icon>https://ddii.dev/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[EKS Anywhere Advanced Usages]]></title>
        <id>/2022/03/18/eks-anywhere-adv</id>
        <link href="https://ddii.dev/2022/03/18/eks-anywhere-adv"/>
        <updated>2022-03-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[EKS Anywhere 로 구성된 쿠버네티스 클러스터 활용 ]]></summary>
        <content type="html"><![CDATA[<p>지난글에 이어 이번에는 홈랩으로 구성한 EKS Anywhere 클러스터에서 운영, 개발환경 구성을 위한 여러가지 도구를 설치해보는 과정을 정리하고자 한다. </p><p>지난 포스팅은 다음 링크에서 확인할 수 있다.</p><blockquote><p>이전글 - <a href="https://ddii.dev/kubernetes/eks-anywhere/" target="_blank" rel="noopener noreferrer">vSphere homelab 환경에서 EKS Anywhere 구성하기</a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-connector">EKS Connector<a class="hash-link" href="#eks-connector" title="Direct link to heading">​</a></h2><p>EKS Connector를 통해 EKS Anywhere를 포함한 외부의 모든 클러스터를 AWS 콘솔에 연결할 수 있다. eks connector 컨테이너를 통해 proxy 형태로 외부 쿠버네티스 클러스터의 API서버에서 정보를 가져와 AWS System Manager로 전달하는 비동기 방식으로 워크로드 관리를 진행한다.</p><ul><li>유저가이드 - <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html</a>  </li><li>AWS 블로그 - <a href="https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-등록">클러스터 등록<a class="hash-link" href="#클러스터-등록" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-03-at-4.28.27-PM.png" alt="overview" class="img_E7b_"></p><p>EKS Anywhere를 포함한 외부 K8s 클러스터는 AWS CLI, eksctl, 콘솔을 사용해서 등록(register)이 가능하다. eksctl로 등록을 진행하면 먼저 관련된 Role을 생성해주고 또한 ClusterRole, ClusterRoleBinding 및 Connector StatefulSet을 배포할 수 있도록 자동으로 manifest를 생성해주기 때문에 eksctl로 클러스터 등록을 진행하는 것이 편하다. AWS Managed IAM 역할인 <code>AWSServiceRoleForAmazonEKSConnector</code>을 생성하는 과정을 진행하기 때문에 에러가 발생을 한다. 에러가 난 이후에 AWS 콘솔이나 CLI를 통해 확인하면 새롭게 생성된 <code>AWSServiceRoleForAmazonEKSConnector</code> IAM 역할과 해당 역할에 연결된 Policy인 <code>AmazonEKSConnectorServiceRolePolicy</code>를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-09 18:50:44 [ℹ]  creating IAM role "eksctl-20220309185044427640"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-09 18:50:49 [ℹ]  deleting IAM role "eksctl-20220309185044427640"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: error registering cluster: error calling RegisterCluster: ResourcePropagationDelayException: Service linked role 'arn:aws:iam::492935017096:role/aws-service-role/eks-connector.amazonaws.com/AWSServiceRoleForAmazonEKSConnector' is propagating, please retry later.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>실패를 진행한 후에 다시 등록 시도를 하면 아래 출력로그와 같이 명령어를 실행한 디렉토리에 EKS Connector 관련 리소스 manifests(eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml)를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:15 [ℹ️]  creating IAM role "eksctl-20220308225915739385"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  registered cluster "homelab" successfully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector-clusterrole.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector-console-dashboard-full-access-group.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [!]  note: "eks-connector-clusterrole.yaml" and "eks-connector-console-dashboard-full-access-group.yaml" give full EKS Console access to IAM identity "arn:aws:iam::492935017096:user/jinwoong", edit if required; read https://docs.aws.amazon.com/eks/latest/userguide/connector-grant-access.html for more info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  run kubectl apply -f eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml before 11 Mar 22 13:59 UTC to connect the cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>eks-connector.yaml 에는 <code>Namespace</code>, <code>Secret</code>, <code>Role</code>, <code>ServiceAccount</code>, <code>RoleBinding</code>, <code>ConfigMap</code>과 배포될 <code>StatefulSet</code> 이 담겨있어 해당 파일은 그대로 사용하면 된다.</p><p>하지만 실제 콘솔에서 노드와 워크로드 정보를 보기 위해서 eks-connector-console-dashboard-full-access-group.yaml에 콘솔 접속이 필요한 IAM 사용자와 접근을 위한 특정 네임스페이스 정보를 <code>ClusterRole</code> 및 <code>ClusterRoleBinding</code>에 추가해야 한다. </p><p>자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html</a>에서 확인이 가능하다. </p><p>위에서 생성된 manifests가 EKS Anywhere 클러스터에 적용되면 StatefulSet 형태로 배포된 EKS Connect 에이전트는 Amazon EventBridge를 통해 EKS에 알림을 보내는 System Manager 서비스에 연결한다. 이후 EKS Connect는 연결된 클러스터의 kubernetes API 서버에 EKS 콘솔 요청을 전달하므로 생성한 서비스 어카운트를 EKS Connect 역할과 연결하여 AWS IAM 엔티티를 가장(impersonate) 할 수있는 권한을 부여하게 된다. </p><p>statefulset을 좀더 살펴보면 위에서 이야기하는 에이전트 역할을 하는 <code>connector-agent</code> 와 프록시 역할을 하는 <code>connector-proxy</code> 컨테이너 두개가 떠있는걸 볼 수 있다. 사용자가 콘솔에서 해당 클러스터의 노드나 워크로드 정보를 조회하게 되면 EKS는 System Manager 서비스에게 세션을 요청하고 이후 System Manager가 비동기 방식으로 <code>connector-agent</code> 컨테이너를 invoke하면 <code>connector-proxy</code> 컨테이너 위에서 마운트된 서비스 어카운트로 인증을 하고 가장(impersonation)한 상태로 EKS Anywhere 클러스트의 API를 호출해서 관련된 내용을 가져와서 보여주게 된다.</p><p><img loading="lazy" src="https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-05-at-7.51.33-AM.png" alt="connector" class="img_E7b_"></p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl describe statefulset eks-connector -n eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:               eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:          eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CreationTimestamp:  Wed, 09 Mar 2022 22:53:23 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Selector:           app=eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:             app=eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:        &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Replicas:           2 desired | 2 total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Update Strategy:    RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition:        0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pods Status:        2 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pod Template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   connector-agent:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:      public.ecr.aws/amazon-ssm-agent/amazon-ssm-agent:3.1.90.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AWS_EC2_METADATA_DISABLED:  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/amazon/ssm/amazon-ssm-agent.json from eks-agent-config (rw,path="amazon-ssm-agent.json")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/amazon/ssm/seelog.xml from eks-agent-config (rw,path="seelog.xml")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/eks/shared from eks-connector-shared (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   connector-proxy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:      public.ecr.aws/eks-connector/eks-connector:0.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      POD_NAME:   (v1:metadata.name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/eks/shared from eks-connector-shared (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/run/secrets/kubernetes.io/serviceaccount from service-account-token (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-환경-구성">Istio 환경 구성<a class="hash-link" href="#istio-환경-구성" title="Direct link to heading">​</a></h2><p>Istio 환경에서 앱을 배포하고 Tracing 가시성 확보를 하는 실습을 진행하기 위해 간단하게 구성에 대한 그림을 그려봤다. </p><p><img loading="lazy" alt="istio" src="/assets/images/istio_o11y-120b56627de7c677da542503b0d01b49.png" width="1148" height="388" class="img_E7b_"></p><p>Istio 환경에서 sidecar 형태로 envoy proxy가 각 Observability 구성요소로 데이터가 전달되도록 구성한다. 이때 사용되는 오픈소스 스택은 다음과 같다.</p><ul><li><p>Tracing </p><ul><li>Collect : <a href="https://github.com/open-telemetry/opentelemetry-collector" target="_blank" rel="noopener noreferrer">OpenTelemetry Collector</a></li><li>Backend : <a href="https://github.com/grafana/tempo" target="_blank" rel="noopener noreferrer">Tempo</a></li></ul></li><li><p>Logging</p><ul><li>Collect : <a href="https://github.com/fluent/fluent-bit" target="_blank" rel="noopener noreferrer">Fluentbit</a></li><li>Backend : <a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki</a></li></ul></li><li><p>Metrics</p><ul><li>Collect : <a href="https://istio.io/latest/docs/ops/integrations/prometheus/" target="_blank" rel="noopener noreferrer">Exporters</a></li><li>Backend : <a href="https://github.com/prometheus" target="_blank" rel="noopener noreferrer">Prometheus</a></li></ul></li><li><p>Visualization</p><ul><li><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener noreferrer">Grafana</a></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-설치">Istio 설치<a class="hash-link" href="#istio-설치" title="Direct link to heading">​</a></h3><p>IstioOperator를 통해 Istio를 설치한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; istioctl operator init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>IstioOperator가 설치되면 리소스를 배포하여 istio 서비스를 생성할 수 있다. envoy proxy에는 다양한 헤더들을 통해 trace 정보를 propagate 할 수 있다. 다음과 같이 <code>x-b3-traceid</code>를 traceid로 로그 포맷을 구성하도록 하고 trace 활성화를 위해 <code>enableTracing: true</code> 를 설정하고 Prometheus에서 스크랩을 할 수 있도록 <code>enablePrometheusMerge: true</code>로 설정한다.</p><p>마지막으로 zipkin 프로토콜로 OpenTelemetry Collector로 전달할것이기 엔드포인드 정보도 미리 작성했다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> install.istio.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IstioOperator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">profile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">meshConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">accessLogFile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dev/stdout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">accessLogFormat</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% "%UPSTREAM_TRANSPORT_FAILURE_REASON%" %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%" %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME% traceID=%REQ(x-b3-traceid)%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableTracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enablePrometheusMerge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">sampling</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max_path_tag_length</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">99999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.tracing.svc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9411</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Istio의 대표적인 샘플앱인 <a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">bookinfo</a>를 <code>bookinfo</code> 네임스페이스에 설치한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl label namespace bookinfo istio-injection=enabled --overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -n bookinfo -f https://raw.githubusercontent.com/istio/istio/release-1.10/samples/bookinfo/platform/kube/bookinfo.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 접근을 위한 <code>Gateway</code>와 <code>VirtualService</code> 도 구성한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">istio</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ingressgateway </span><span class="token comment" style="color:#999988;font-style:italic"># use istio default controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Mind the hosts. This matches all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gateways</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tracing/bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> productpage.bookinfo.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9080</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 확인을 위해 <code>LoadBalancer</code>로 구성된 istio-ingressgateway EXTERNAL-IP인 <a href="http://192.168.31.10/productpage" target="_blank" rel="noopener noreferrer">http://192.168.31.10/productpage</a>로 접속을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl get svc -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway   LoadBalancer   10.97.92.31      192.168.31.10   15021:30184/TCP,80:32738/TCP,443:31058/TCP   2d23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istiod                 ClusterIP      10.107.186.201   &lt;none&gt;          15010/TCP,15012/TCP,443/TCP,15014/TCP        2d23h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="metric-server-설치">metric-server 설치<a class="hash-link" href="#metric-server-설치" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/metrics-server</a></p><p>HPA 나 Kubernetes 대시보드를 활용하기 위해서 metric-server를 설치한다. kubelet tls 인증서 에러가 날 경우 설치 파일을 받아서 ARG에 <code>--kubelet-insecure-tls</code> 플래그를 추가해서 설치하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl top nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.186   175m         9%     2228Mi          29%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.187   82m          4%     893Mi           11%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.188   64m          3%     795Mi           10%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.189   134m         6%     1817Mi          23%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.190   43m          2%     636Mi           8% </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="observability-stack-설치">Observability Stack 설치<a class="hash-link" href="#observability-stack-설치" title="Direct link to heading">​</a></h2><p>차트로 일괄배포를 위해 <a href="https://github.com/grafana/helm-charts/tree/main/charts/loki-stack" target="_blank" rel="noopener noreferrer">Loki-stack</a>를 사용했고, 테스트를 위한 구성으로 구성 변경을 한 chart values는 다음과 같다. </p><ul><li><a href="https://github.com/prometheus" target="_blank" rel="noopener noreferrer">Prometheus</a> - 시계열 데이터(메트릭)을 수집하고 저장하는 프로젝트이며, 키-밸류 형태로 쿼리와 연산이 가능한 모니터링 시스템이다. node-exporter, alertmanager, pushgateway 도 차트로 같이 설치한다. </li><li><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener noreferrer">Grafana</a> - 데이터를 시각화하는 플랫폼으로 다양한 로그, 메트릭, 트레이스 데이터를 시작화하고 알림 관리를 할 수 있다.</li><li><a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki</a> - 다른 로깅 시스템과 달리 로그를 제외한 메타데이터 인덱싱만 하기 때문에 Prometheus처럼 레이블을 염두에 두고 설계된 로깅 데이터스토어 시스템이다.</li><li><a href="https://github.com/fluent/fluent-bit" target="_blank" rel="noopener noreferrer">Fluent Bit</a> - 로깅 컬렉터(Collector)로 fluentd 보다 경량화되고 빠른 로그 프로세스이자 전달자(Forwarder)로 다른 로깅 컬렉터인 promtail, filebeat, logstash는 false로 설정한다. </li><li><a href="https://github.com/grafana/tempo" target="_blank" rel="noopener noreferrer">Tempo</a> - Tempo는 분산 추적(Tracing)을 위한 비용 효율적인 백엔드 데이터스토어 프로젝트로 위에서 구성한 Prometheus, Grafana, Loki 등과 같은 다른 Observability 프로젝트와 통합이 쉬운것이 특징이다.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prometheus-loki-설치">Prometheus, Loki 설치<a class="hash-link" href="#prometheus-loki-설치" title="Direct link to heading">​</a></h3><p><code>Prometheus</code>와 <code>Loki</code>는 Loki-Stack으로 구성한다. fluent-bit는 별도 구성 파일을 필요로 하기 때문에 나중에 설치할 예정이다. Prometheus는 Persistent Volume은 별도로 구성하지 않은 상태로 <code>persistentVolume</code>을 <code>false</code>로 설정하여 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns tracing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add grafana https://grafana.github.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install loki grafana/loki-stack --version 2.4.1 -n tracing -f - &lt;&lt; 'EOF'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fluent-bit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">promtail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    persistentVolume:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alertmanager:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    persistentVolume:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>Tempo</code>는 로그 정보와 tracing을 수신할 리시버 프로토콜 들(zipkin, otlp)을 정의한 채로 Chart로 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm install tempo grafana/tempo --version 0.7.4 -n tracing -f - &lt;&lt; 'EOF'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tempo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "distributor.log-received-traces": true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  receivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipkin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otlp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grpc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry-collector-구성">OpenTelemetry Collector 구성<a class="hash-link" href="#opentelemetry-collector-구성" title="Direct link to heading">​</a></h3><p>이제까지 observability 관련 데이터 저장소들을 구성했으니 마지막으로 트레이싱을 위한 도구인 <a href="https://opentelemetry.io/docs/collector/getting-started/" target="_blank" rel="noopener noreferrer">OpenTelemetry Collector</a>를 설치한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">otel-collector-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   receivers:   </span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     zipkin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        endpoint: 0.0.0.0:9411</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   exporters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     otlp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       endpoint: tempo.tracing.svc.cluster.local:55680</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       insecure: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     pipelines:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       traces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">         receivers: [zipkin]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">         exporters: [otlp]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 Collect 구성 컨피그는 다름과 같이 설정했다. 자세한 설정 방법은 <a href="https://opentelemetry.io/docs/collector/configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/collector/configuration/</a>에서 확인가능하다.</p><ul><li><code>spec.config.receivers.zipkin.endpoint</code>는 trace정보를 받을 엔드포인트 구성으로 zipkin 포맷으로 수신한다. </li><li><code>spec.config.exporters[]</code>에서는 Tempo로 보내기 위한 endpoint 설정을 한다.</li><li><code>spec.config.service</code>에서는 이후 collector에서 사용할 protocol이나 backend datasource 에 대한 설정이며 반드시 활성화가 되어야 사용이 가능하다.  </li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otlp </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for OpenTelemetry receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">grpc </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger gRPC receiver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">thrift</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14268</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zipkin </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Zipkin receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metrics </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for querying metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus </span><span class="token comment" style="color:#999988;font-style:italic"># prometheus exporter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8889</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Service에서 주료 사용하게될 포트는 <code>zipkin</code>의 <code>9411</code>이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/otelcontribcol"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--config=/conf/otel-collector-config.yaml"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--mem-ballast-size-mib=683"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--log-level=DEBUG"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel/opentelemetry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.29.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55679</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for ZPages.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for OpenTelemetry receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14268</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Zipkin receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for querying metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8889</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># prometheus exporter       </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">vol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">vol</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fluentbit-구성">Fluentbit 구성<a class="hash-link" href="#fluentbit-구성" title="Direct link to heading">​</a></h3><p>클러스터 dataplane과 controlplane의 logging 데이터를 <code>Loki</code> 엔드포인트로 전달하기 위한 config로 확인하고 Chart를 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add fluent https://fluent.github.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install fluent-bit fluent/fluent-bit --version 0.16.1 -n tracing -f - &lt;&lt; 'EOF'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logLevel: trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [SERVICE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flush 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Daemon Off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log_Level trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parsers_File custom_parsers.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Server On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Listen 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Port {{ .Values.service.port }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inputs: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [INPUT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path /var/log/containers/*.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parser cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tag kube.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mem_Buf_Limit 5MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputs: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [OUTPUT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        match *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host loki.tracing.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port 3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant_id ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        labels job=fluentbit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        label_keys $trace_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto_kubernetes_labels on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customParsers: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [PARSER]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Format regex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Regex ^(?&lt;time&gt;[^ ]+) (?&lt;stream&gt;stdout|stderr) (?&lt;logtag&gt;[^ ]*) (?&lt;message&gt;.*)$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Time_Key    time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Time_Format %Y-%m-%dT%H:%M:%S.%L%z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>마지막으로 위 3가지 데이터소스(Prometheus, Loki, Tempo)가 등록된 상태의 <code>Grafana</code> Chart를 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install grafana grafana/grafana -n tracing --version 6.13.5&nbsp; -f - &lt;&lt; 'EOF'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datasources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasources.yaml:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datasources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://tempo.tracing.svc:3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Prometehus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://loki-prometheus-server.tracing.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://loki.tracing.svc:3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jsonData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          derivedFields:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - datasourceName: Tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matcherRegex: "traceID=(\\w+)"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              name: TraceID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              url: "$${__value.raw}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              datasourceUid: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  JAEGER_AGENT_PORT: 6831</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adminUser: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adminPassword: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bookinfo-productpage-접속-및-trace-확인">bookinfo productpage 접속 및 trace 확인<a class="hash-link" href="#bookinfo-productpage-접속-및-trace-확인" title="Direct link to heading">​</a></h3><p><code>LoadBalancer</code>로 구성된 istio-ingressgateway EXTERNAL-IP인 <a href="http://192.168.31.10/productpage" target="_blank" rel="noopener noreferrer">http://192.168.31.10/productpage</a>로 접속하는 상태에서 trace를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; ISTIOINGRESSGW=$(kubectl get pod -n istio-system -l app=istio-ingressgateway -o jsonpath='{.items[0].status.hostIP}')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -e "PRODUCTPAGE UI URL = http://$ISTIOINGRESSGW/productpage"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRODUCTPAGE UI URL = http://192.168.31.187/productpage</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; for i in {1..100};  do curl -s $ISTIOINGRESSGW/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;" ; done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Grafana Explorer 메뉴에서 <code>Loki</code> 데이터소스를 선택하고 Log browser에 <code>{app="productpage"}</code>를 입력하게 되면 하나의 트랜잭션에 대한 트레이스 정보를 로그내에서 확인하고 해당 traceid 버튼을 클릭하거나 <code>Tempo</code> 메뉴에서 탐색을 하면 관련된 trace 정보를 확인할 수 있다.</p><p><img loading="lazy" alt="tempo" src="/assets/images/tempo-grafana-efca4b49fa3a35fde86bb842172288e4.png" width="1920" height="1091" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 eks-anywhere 클러스터에 여러가지 3rd party 구성요소들을 설치하고 실제 운영환경과 유사하게 테스트를 진행해봤다. EKS를 사용하는 관점에서 유사한 경험을 바탕으로 개발환경을 가져갈수 있기에 vSphere를 기반으로 사내 서비스를 개발하는 팀에게는 좋은 하나의 선택지가 추가되었다고 볼 수 있다. Direct Connect나 VPN과 같이 네트워크 연결성만 확보된다면 실제 기업환경에서는 AWS 네이티브 서비스와의 연계가 더 용이해지기 때문에 좋은 개발, 테스트 환경으로 다가갈 수 있을거라 생각한다.  </p><p>재미있는 경험이었고 당분간은 개인프로젝트를 진행하는 홈랩 환경은 EKS Anywhere로 정착해서 테스트를 계속 진행하려고 한다. </p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote>]]></content>
        <author>
            <name>Jinwoong Kim</name>
            <uri>https://www.linkedin.com/in/ddiiwoong/</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="vsphere" term="vsphere"/>
        <category label="eks anywhere" term="eks anywhere"/>
        <category label="eks connector" term="eks connector"/>
        <category label="eks" term="eks"/>
        <category label="opentelemetry" term="opentelemetry"/>
        <category label="cilium" term="cilium"/>
        <category label="observability" term="observability"/>
        <category label="prometheus" term="prometheus"/>
        <category label="grafana" term="grafana"/>
        <category label="loki" term="loki"/>
        <category label="microservice" term="microservice"/>
        <category label="istio" term="istio"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[EKS Anywhere on vSphere Homelab]]></title>
        <id>/2022/03/06/eks-anywhere</id>
        <link href="https://ddii.dev/2022/03/06/eks-anywhere"/>
        <updated>2022-03-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[vSphere homelab 환경에서 EKS Anywhere 구성하기]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-anywhere">EKS Anywhere<a class="hash-link" href="#eks-anywhere" title="Direct link to heading">​</a></h2><p><code>EKS Anywhere</code>는 eksctl를 사용하는 환경에서 <a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener noreferrer">Kubernetes Cluster API Provider vSphere</a> 인 CAPV를 통해 vSphere 기반으로 쿠버네티스 클러스터를 구성해주는 오픈소스이다. CAPV Spec은 <a href="https://cluster-api.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">Kubernetes Cluster API</a> 기반으로 쿠버네티스 스타일 API형태의 선언적(Declarative) 방식으로 쿠버네티스 클러스터의 Lifecycle을 관리하는 프로젝트이다. </p><p>Ubuntu 또는 Mac admin 환경에서 eksctl 명령어로 로컬 클러스터들을 관리하고 클러스터를 생성, 삭제할 수 있다. 일단 기본적으로 클러스터를 생성하고 관리하는 방식이 eksctl과 거의 유사하다. 또한 EKS 서비스의 배포 버전과 동일한 버전을 사용함으로써 (포스팅 당시 버전 1.21) vSphere 기반 하이브리드 환경에서의 쿠버네티스 클러스터 및 워크로드 관리를 편하게 할 수 있다.</p><p>크게 EKS native 서비스와 크게 다른점 몇가지는 다음과 같다. </p><ul><li>컴퓨팅 환경 : vSphere, Docker(개발환경 구성시)</li><li>노드 지원 OS :  BottleRocket, Ubuntu</li><li>CNI : Cilium</li></ul><p>자세한 내용은 <a href="https://anywhere.eks.amazonaws.com/docs/concepts/eksafeatures/" target="_blank" rel="noopener noreferrer">비교표</a>를 참고하자.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-준비사항">사전 준비사항<a class="hash-link" href="#사전-준비사항" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="로컬-관리-환경">로컬 관리 환경<a class="hash-link" href="#로컬-관리-환경" title="Direct link to heading">​</a></h3><ul><li>Docker 20.x 이상 버전  </li><li>Mac OS(10.15) / Ubuntu(20.04.2 LTS)</li><li>CPU 4코어</li><li>메모리 16GB</li><li>디스크 30GB</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vsphere">vSphere<a class="hash-link" href="#vsphere" title="Direct link to heading">​</a></h3><p><a href="https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-prereq/</a></p><ul><li>vCenter 환경의 vSphere 7.0 이상</li><li>최소 VM 4대 (각 2 vCPU, 8GB 메모리, 25GB 디스크 이상 권장)<ul><li>Control Plane 1대</li><li>etcd 노드 1대</li><li>worker 노드 2대</li></ul></li><li>DHCP 환경</li><li>API 서버 용 Static IP 1개</li><li>외부 바이너리, 이미지 다운로드를 위한 네트워크 환경<ul><li>클러스터 자체에서 방화벽 등으로 인한 인터넷이 안되는 경우 <a href="https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/proxy/" target="_blank" rel="noopener noreferrer">프록시 구성</a>을 통해 가능함</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="homelab-구성환경">Homelab 구성환경<a class="hash-link" href="#homelab-구성환경" title="Direct link to heading">​</a></h2><p>기존에 운영하던 ESXi 환경을 그대로 활용하도록 했다. 추가적으로 하드웨어를 구비하기 위해 비용이 발생한부분은 없다.   </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hardware">Hardware<a class="hash-link" href="#hardware" title="Direct link to heading">​</a></h3><ul><li>Dell Precision Tower 3620<ul><li>Intel(R) Xeon(R) CPU E3-1240L v5</li><li>TeamGroup DDR4-2666 16GB * 4ea</li><li>(VM 용) SAMSUNG NVMe SSD PM981 - 1TB</li><li>(ESXi 용) Sandisk SSD Z410- 240GB</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="software">Software<a class="hash-link" href="#software" title="Direct link to heading">​</a></h3><ul><li>vSphere 7.0 Update 3</li><li>vCenter 7.0.3 (VSCA)</li><li>Docker Desktop <a href="https://docs.docker.com/desktop/mac/release-notes/#docker-desktop-420" target="_blank" rel="noopener noreferrer">4.2.0</a>버전을 사용 <ul><li>4.3.0 버전 하위 호환 문제가있어 금번 테스트 환경에서는 4.2.0 사용</li><li>도커 리소스를 최소 <code>8vCPU</code>, <code>16GB</code>로 설정</li></ul></li><li><a href="https://kubernetes.io/ko/docs/tasks/tools/" target="_blank" rel="noopener noreferrer">kubectl</a> v1.23.4</li><li><a href="https://eksctl.io/introduction/#installation" target="_blank" rel="noopener noreferrer">eksctl</a> v0.85.0</li><li><a href="https://anywhere.eks.amazonaws.com/docs/getting-started/install/" target="_blank" rel="noopener noreferrer">eksctl-anywhere</a> v0.7.0</li><li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html" target="_blank" rel="noopener noreferrer">aws-iam-authenticator</a> v0.5.5</li><li><a href="https://anywhere.eks.amazonaws.com/docs/reference/artifacts/" target="_blank" rel="noopener noreferrer">bottlerocket OVA</a> v1.21 (자동 생성되는 OVA로 별도 구성이 필요없다)  </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-환경구성">클러스터 환경구성<a class="hash-link" href="#클러스터-환경구성" title="Direct link to heading">​</a></h2><p><a href="https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/" target="_blank" rel="noopener noreferrer">공식 홈페이지의 클러스터 생성, 삭제 워크플로우</a>를 참고하여 사전 구성된 Homelab에 적용한다. </p><p><img loading="lazy" src="https://anywhere.eks.amazonaws.com/images/eks-a_create_cluster.png" alt="workflow" class="img_E7b_"></p><p>처음에는 eksctl 명령으로 클러스터를 생성하는 과정으로 사전에 생성한 cluster config yaml을 통해 로컬 도커 엔진에 bootstrap을 하는 명령을 내린다. 이때 로컬 도커 엔진에서는 Docker in Docker 엔진인 <a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">kind</a>를 통해 클러스터 번들 컨피그를 생성한다. </p><p><a href="https://github.com/kubernetes-sigs/cluster-api/tree/main/cmd/clusterctl" target="_blank" rel="noopener noreferrer">clusterctl</a>를 통해 <a href="https://github.com/kubernetes-sigs/cluster-api/tree/main/test/infrastructure/docker" target="_blank" rel="noopener noreferrer">Cluster API Provider Docker</a>형태로 부모(bootstrap) 클러스터를 만드는 과정이 <code>eksctl anywhere</code> 명령으로 추상화 되는것이라 볼 수 있다. </p><p>해당 단계에서 먼저 Bastion Host나 관리 머신에 <code>kubectl</code>, <code>eksctl</code>, <code>eksctl-anywhere</code>, <code>aws-iam-authenticator</code> 등이 설치되어 있는지 확인한다.</p><p><a href="https://anywhere.eks.amazonaws.com/docs/getting-started/install/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/getting-started/install/</a></p><p><code>homelab</code> 이름으로 클러스터 컨피그를 생성한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">CLUSTER_NAME=homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksctl anywhere generate clusterconfig $CLUSTER_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   --provider vsphere &gt; $CLUSTER_NAME.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 컨피그에 대한 상세 설정은 <a href="https://anywhere.eks.amazonaws.com/docs/reference/clusterspec/vsphere/" target="_blank" rel="noopener noreferrer">vSphere configuration</a> 에서 확인할 수 있다. </p><p>생성된 컨피그를 하나씩 살펴보자. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">clusterNetwork</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cni</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">pods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.0.0/20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 10.96.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controlPlaneConfiguration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.31.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datacenterRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereDatacenterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">externalEtcdConfiguration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gitOpsRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitOpsConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gitops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubernetesVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.21"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">managementCluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workerNodeGroupConfigurations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>첫번째는 <code>Cluster</code> 리소스로 Cluster의 이름과 클러스터 전반 설정과 Control Plane, Data Plane, etcd VM의 버전, 개수 등을 정할 수 있다. </p><p>클러스터 이름은 <code>homelab</code>으로 설정한다. 기본적으로 CNI는 Cilium을 사용하는 구조이기 때문에 필수적으로 <code>cilium</code>로 설정해야 한다. 그리고 kubeadm 구성시 필요한 <code>pods.cidrBlocks</code>과 <code>services.cidrBlocks</code>에서 파드와 서비스가 사용할 네트워크 대역을 설정한다. 둘다 CNI에서 통신되는 가상 네트워크 대역이기 때문에 현재 사용중인 샤오미 공유기 대역(192.168.31.x)과 충돌하지 않으면서 라우팅에 문제되지 않고 현재 네트워크에 사용되지 않는 대역(192.168.0.0/20, 10.96.0.0/12) 으로 설정했다.  </p><blockquote><p>DHCP 유의사항: 본인의 경우 Xiaomi 공유기를 사용중인데 별도의 DHCP서버를 구성하지 않고 사용을 하고 있어서인지, 신규 노드를 위한 VM이 생성되고 <code>bottlerocket</code> OS가 기동될때 호스트명이 <code>MiWifi-R3600-SRV</code> 이런식으로 대소문자를 포함한 형태로 자동 생성되다 보니 부팅이 되지 않는 현상이 발생했다. 이에 <a href="https://anywhere.eks.amazonaws.com/docs/reference/vsphere/vsphere-dhcp/" target="_blank" rel="noopener noreferrer">별도의 DHCP 구성</a>을 통해 진행을 하면 해당 이슈를 피할수 있다. </p></blockquote><p><code>controlPlaneConfiguration</code> 필드에서는 controlPlane 노드의 <code>count</code>와 <code>endpoint</code>를 설정해야 한다. <code>count</code> 초기 값은 <code>2</code>로 되어 있지만 홈랩의 자원이 부족하기 때문에 <code>1</code>로 설정했다. 실제 프로덕션에서는 2이상을 권고한다. 그리고 <code>endpoint.host</code>는 쿠버네티스 API서버 엔드포인트로 실제 kubectl 명령 및 사용자와 인터페이스를 위한 접근 가능한 DHCP 할당으로 충돌되지 않는 네트워크 대역의 고정 IP로 설정한다. <code>machineGroupRef</code>는 이후 생성할 VM spec에 매칭시킬 label 값으로 자동 생성된다. </p><p><code>externalEtcdConfiguration</code>는 etcd 구성을 위한 필드로 <code>count</code>는 기본설정 값이 <code>3</code>이지만 홈랩 환경에서는 <code>1</code>로 구성하였다. 실제 프로덕션에서는 Raft 알고리즘 기반 Redundancy 구성을 위해 <code>3</code>이상을 권고한다.</p><p><code>gitOpsRef</code>는 GitOps 형태로 클러스터를 관리하기 위해 참조하는 값으로 아래 <code>GitOpsConfig</code> 에서 사용할 이름 <code>cluster-gitops</code> 를 명시한다. </p><p><code>kubernetesVersion</code>은 EKS 배포 버전와 동일한 <code>1.21</code>로 설정한다. </p><p><code>workerNodeGroupConfigurations</code>은 워커노드 구성으로 <code>count</code>를 <code>2</code>로 설정하였다. </p><p>다음은 배포되는 vSphere spec을 정의하는 리소스로 <code>VSphereDatacenterConfig</code>이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereDatacenterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datacenter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Datacenter"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">insecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">network</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"VM Network"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"192.168.31.2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">thumbprint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>spec</code>에서는 실제 vCenter의 엔드포인트, datacenter, network 정보 등을 입력한다. </p><blockquote><p>유의사항 : <code>insecure</code> 옵션의 경우 기본값이 false로 되어 있다. 해당 값이 <code>false</code>의 경우 아래 그림에 있는 것 처럼 보통 vCenter 메뉴에서 <code>thumbprint</code> 값을 확인할 수 있고 해당 값을 <code>**:89:91:5B:02:50:F6:41:D0:DE:6B:A0:B8:43:41:A4:81:03:**</code> 형태로 변경하여 사용하거나 <a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">govc</a>를 사용하여 <code>govc about.cert -thumbprint -k</code> 명령어로 확인이 가능하다.</p></blockquote><p><img loading="lazy" alt="cert" src="/assets/images/vsphere_cert-46b8ff831c6ea16844e8182f910d0650.png" width="1762" height="1214" class="img_E7b_"></p><p>마지막은 각 노드 역할(control plane, etcd, worker)별로 사용할 OS 및 리소스 spec을 정의하는 컨피그이다. 위 <code>Cluster</code> 리소스에서 설정된 <code>machineGroupRef.name</code>으로 매칭되는 값을 metadata로 자동 생성 해주고 모두 유사하기 때문에 이중 <code>VSphereMachineConfig</code>만 살펴본다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datastore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"datastore2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">diskGiB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">folder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">memoryMiB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8192</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">numCPUs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">osFamily</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourcePool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*/Resources"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ec2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sshAuthorizedKeys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ssh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rsa AAAAB3</span><span class="token important">******U=</span><span class="token plain"> vsphere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Datacenter에 구성한 <code>datastore</code>중 설치되는 VM 영역이 사용할 대상 datastore를 입력한다. VM디스크 <code>diskGiB</code>, Datacenter <code>folder</code>, VM메모리 <code>memoryMiB</code>, vCPU <code>numCPUs</code>를 입력하고, <code>resourcePool</code>은 지정 리소스 그룹을 별도로 설정하지 않았기 때문에 <code>"*/Resources"</code>로 설정한다. 그리고 <code>osFamily</code>는 ubuntu, bottlerocket두가지로 제공이 되는데 기본값은 bottlerocket이고, 해당 이미지의 기본 user는 <code>ec2-user</code>로 설정하고 해당 VM에 SSH접근을 위해서 별도로 생성한 <code>sshAuthorizedKeys</code>를 입력한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GitOpsConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gitops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">flux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">github</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">branch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">clusterConfigPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> clusters/homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fluxSystemNamespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flux</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">personal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">anywhere</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">homelab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>마지막은 클러스터를 GitOps 스타일로 관리하기 위해 <code>GitOpsConfig</code>를 추가한다. spec 에서 사용할 github의 <code>branch</code>, github 레포 아래 컨피그가 저장될 경로인 <code>clusterConfigPath</code>, gitops 오픈소스인 <a href="https://fluxcd.io/docs/get-started/" target="_blank" rel="noopener noreferrer">Flux</a>가 구성될 네임스페이스인 <code>fluxSystemNamespace</code>, github account인 <code>owner</code>, repo 이름이 되는 <code>repository</code> 까지 설정한다. 해당 구성을 포함한 채로 클러스터를 배포하게 되면 클러스터가 생성되는 중에 선언한 <code>repository</code>로 이후 관리될 클러스터 컨피그 및 kustomize 파일 등을 <code>commit</code>하게 된다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-생성">클러스터 생성<a class="hash-link" href="#클러스터-생성" title="Direct link to heading">​</a></h2><p>나머지 etcd, worker node 도 <code>VSphereMachineConfig</code>를 동일한 형식으로 작성하고, vSphere 관련 인증정보와 gitops로 활용할 레포의 github token을 환경변수로 입력하여 클러스터 생성을 진행한다. 홈랩으로 구성한 샘플 컨피그는 <a href="https://raw.githubusercontent.com/ddiiwoong/eks-anywhere-homelab/main/clusters/homelab/homelab/eksa-system/eksa-cluster.yaml" target="_blank" rel="noopener noreferrer">링크</a>에서 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_VSPHERE_USERNAME='administrator@ddii.local'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_VSPHERE_PASSWORD='***********'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; export EKSA_GITHUB_TOKEN=ghp_************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl anywhere create cluster -f homelab.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: The recommended size of an external etcd cluster is 3 or 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checking Github Access Token permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Github personal access token has the required repo permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Performing setup and validations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Connected to server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Authenticated to vSphere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datacenter validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Network validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Datastore validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Folder validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Resource pool validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Control plane and Workload templates validated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Vsphere Provider setup is valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Flux path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✅ Create preflight validations pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating new bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing cluster-api providers on bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Provider specific setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating new workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing networking on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing storage class on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing cluster-api providers on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing EKS-A secrets on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Moving cluster management from bootstrap to workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing EKS-A custom components (CRD and controller) on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating EKS-A CRDs instances on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installing AddonManager and GitOps Toolkit on workload cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Adding cluster configuration files to Git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enumerating objects: 20, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Counting objects: 100% (20/20), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compressing objects: 100% (12/12), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total 20 (delta 1), reused 19 (delta 0), pack-reused 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finalized commit and committed to local repository  {"hash": "ea4293c849725e593704c2a8ff71a708ad8cf8f2"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Writing cluster config file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deleting bootstrap cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">🎉 Cluster created!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>각 단계를 순서대로 간단히 살펴보면 처음 bootstrap cluster 구성 단계에서는 아래와 같은 일을 수행한다.</p><ul><li>Github Access Token 권한 확인</li><li>vSphere 인증</li><li>vSphere 리소스(Datacenter, Network, Datastore, Folder 등) 검증</li><li>Control Plane, Workload Plane 템플릿 검증</li><li>kind로 bootstrap cluster 생성</li><li>cluster-api provider 역할을 하는 CAPI(Cluster API) 설치</li></ul><p>다음은 생성된 bootstrap cluster의 CAPI 관리도구가 vSphere 클러스터에 연결후에 진행한다.</p><ul><li><a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">govc</a>를 사용해서 연결된 vSphere 클러스터에 새로운 etcd를 포함한 Control, Workload 노드 생성</li><li><a href="https://cilium.io/" target="_blank" rel="noopener noreferrer">Cilium</a> CNI 추가</li><li>Storage Class 추가</li><li>구성된 Workload Cluster에 CAPI 추가<ul><li>provider 셋업</li><li>추가적인 CRD 및 GitOps 컴포넌트 추가</li></ul></li><li>GitOps를 위해 최초 생성된 cluster config를 지정한 repo에 Commit </li><li>마지막으로 로컬 관리 머신에 cluster config를 저장</li></ul><p>각각의 단계에 대한 설명은 <a href="https://anywhere.eks.amazonaws.com/docs/concepts/clusterworkflow/#4-authenticate-and-create-bootstrap-cluster" target="_blank" rel="noopener noreferrer">다음 링크</a>에서 확인할 수 있다. </p><p>처음 몇번 시도를 하다보면 여러가지 에러사항을 만나게 된다. 해당 단계의 디버그 레벨 출력을 보기 위해서는 <code>-v 9</code> 플래그를 추가해서 설치를 진행하면 상세 내역을 확인할 수 있는데 debug 레벨로 마지막 몇줄 로그를  살펴보면 도커에서 kind로 도커내에 클러스터를 구성한 이후에 docker내 kind 클러스터를 삭제하는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:33.638+0900    V4      Deleting kind cluster   {"name": "homelab-eks-a-cluster"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:33.638+0900    V6      Executing command       {"cmd": "/usr/local/bin/docker exec -i eksa_1646374542969789000 kind delete cluster --name homelab-eks-a-cluster"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deleting cluster "homelab-eks-a-cluster" ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V0      🎉 Cluster upgraded!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      Task finished   {"task_name": "delete-kind-cluster", "duration": "4.560798797s"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      ----------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:36.244+0900    V4      Tasks completed {"duration": "7m50.030420843s"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:37.227+0900    V3      Cleaning up long running container      {"name": "eksa_1646374542969789000"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-04T15:23:37.228+0900    V6      Executing command       {"cmd": "/usr/local/bin/docker rm -f -v eksa_1646374542969789000"}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>몇가지 경험한 에러 사항을 나열해 보면 위에서도 언급한 내용과 같이 Cluster 컨피그 내 <code>vSphere thumbprint</code>를 반드시 넣어주는것이 좋다. 공식 가이드에는 <code>insecure</code> 필드를 true로 설정하고 <code>thumbprint</code>를 null로 진행할 경우 아래와 같이 kubeconfg secret을 구성단계에서 실패하거나 Workload 노드가 join할 때 에러가 발생하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl anywhere create cluster -f eksa-mgmt-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collecting management cluster diagnostics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⏳ Collecting support bundle from cluster, this can take a while {"cluster": "bootstrap-cluster", "bundle": "mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml", "since": 1646227532274217000, "kubeconfig": "mgmt/generated/mgmt.kind.kubeconfig"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Support bundle archive created  {"path": "support-bundle-2022-03-02T14_25_34.tar.gz"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Analyzing support bundle    {"bundle": "mgmt/generated/bootstrap-cluster-2022-03-02T23:25:32+09:00-bundle.yaml", "archive": "support-bundle-2022-03-02T14_25_34.tar.gz"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Analysis output generated   {"path": "mgmt/generated/bootstrap-cluster-2022-03-02T23:27:23+09:00-analysis.yaml"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collecting workload cluster diagnostics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: failed to create cluster: error checking availability of kubeconfig secret: kubeconfig secret does not exist</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 클러스터 배포가 되었으면 eksctl config yaml이 포함된 디렉토리 하위에 클러스터 이름으로 새로운 디렉토리와 <code>kubeconfig</code>와 실제 배포된 cluster config를 확인 할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── homelab-eks-a-cluster.kubeconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── homelab-eks-a-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── homelab.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존 kubeconfig와 merge를 위해 <a href="https://github.com/kubernetes-sigs/krew" target="_blank" rel="noopener noreferrer">krew</a>를 통해 설치한  <a href="https://github.com/corneliusweig/konfig" target="_blank" rel="noopener noreferrer">konfig</a> 도구를 사용해서 기존 컨피그와 병합한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl konfig merge ~/.kube/config ./homelab/homelab-eks-a-cluster.kubeconfig &gt; merged-and-flattened-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; mv merged-and-flattened-config ~/.kube/config</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성된 리소스를 확인해보면 <code>Bottlerocket</code> OS 이미지와 <code>containerd://1.5.8+bottlerocket</code> CRI를 확인할 수 있다. 노드 이름이 IP로 보이는 이유는 DHCP서버를 별도로 두지 않아 Prefix 할당이 되지 않는 가정용 공유기 환경에서 발생하는 현상이다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP      EXTERNAL-IP      OS-IMAGE                                  KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.186   Ready    control-plane,master   9m     v1.21.6   192.168.31.186   192.168.31.186   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.187   Ready    &lt;none&gt;                 8m     v1.21.6   192.168.31.187   192.168.31.187   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.188   Ready    &lt;none&gt;                 7m     v1.21.6   192.168.31.188   192.168.31.188   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.189   Ready    control-plane,master   7m     v1.21.6   192.168.31.189   192.168.31.189   Bottlerocket OS 1.5.3 (vmware-k8s-1.21)   5.10.93          containerd://1.5.8+bottlerocket</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>CRD 리스트를 확인해보자. 많은 CRD중에 <code>x-k8s.io</code>로 필터를 하면 <code>machine</code>, <code>vsphere</code>, <code>cluster</code> 관련된 정보를 확인할수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get crd | grep "x-k8s.io"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterclasses.cluster.x-k8s.io                              2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterresourcesetbindings.addons.cluster.x-k8s.io           2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterresourcesets.addons.cluster.x-k8s.io                  2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusters.cluster.x-k8s.io                                    2022-03-04T14:30:28Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadmclusters.etcdcluster.cluster.x-k8s.io                 2022-03-04T14:30:41Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:38Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmconfigs.bootstrap.cluster.x-k8s.io                    2022-03-04T14:30:34Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmconfigtemplates.bootstrap.cluster.x-k8s.io            2022-03-04T14:30:34Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmcontrolplanes.controlplane.cluster.x-k8s.io           2022-03-04T14:30:45Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadmcontrolplanetemplates.controlplane.cluster.x-k8s.io   2022-03-04T14:30:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinedeployments.cluster.x-k8s.io                          2022-03-04T14:30:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinehealthchecks.cluster.x-k8s.io                         2022-03-04T14:30:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinepools.cluster.x-k8s.io                                2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machines.cluster.x-k8s.io                                    2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machinesets.cluster.x-k8s.io                                 2022-03-04T14:30:30Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">providers.clusterctl.cluster.x-k8s.io                        2022-03-04T14:27:56Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclusteridentities.infrastructure.cluster.x-k8s.io     2022-03-04T14:30:51Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclusters.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vsphereclustertemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheredeploymentzones.infrastructure.cluster.x-k8s.io       2022-03-04T14:30:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspherefailuredomains.infrastructure.cluster.x-k8s.io        2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheremachines.infrastructure.cluster.x-k8s.io              2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspheremachinetemplates.infrastructure.cluster.x-k8s.io      2022-03-04T14:30:53Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vspherevms.infrastructure.cluster.x-k8s.io                   2022-03-04T14:30:54Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이중 <code>machine</code> CRD를 확인해보면 etcd를 볼 수 있는데 이는 VM인스턴스 형태의 외부 리소스 형태로 배포되기 때문에 쿠버네티스 노드 정보에서는 확인할수 없던 <code>etcd</code> 머신을 확인을 할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get machine -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   11m     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   11m     v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system   homelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   11m     v1.21.5-eks-1-21-8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 구성 파드들을 살펴보면 CAPI 관련 리소스, cert-manager, eks-anywhere, Cilium CNI, vSphere 관련 컨트롤러 등을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get pod -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-694cc79bb7-2h29c       1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-5b6b48dd8c-g6md4   1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capi-system                         capi-controller-manager-689cd9b4fd-vxpc8                         1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">capv-system                         capv-controller-manager-6b467446b9-n865b                         1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-7988d4fb6c-72fw7                                    1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-cainjector-6bc8dcdb64-7d7qg                         1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager                        cert-manager-webhook-68979bfb95-hjq8m                            1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eksa-system                         eksa-controller-manager-5c74596687-45v8t                         2/2     Running   0          3h41m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadm-bootstrap-provider-system   etcdadm-bootstrap-provider-controller-manager-74c86ffb56-cpw9k   1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdadm-controller-system           etcdadm-controller-controller-manager-7894945688-js7z4           1/1     Running   0          3h42m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-bq5gq                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-fn2f7                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-lgptt                                                     1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-operator-86d59d5c88-76z2t                                 1/1     Running   1          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-operator-86d59d5c88-9p4s9                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-w55nc                                                     1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         cilium-wk89j                                                     1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         coredns-745c7986c7-k729b                                         1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         coredns-745c7986c7-thtbm                                         1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-apiserver-192.168.31.189                                    1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-controller-manager-192.168.31.189                           1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-6xcdk                                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-d4qbv                                                 1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-mhzb4                                                 1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-vrw2p                                                 1/1     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-proxy-xkfmh                                                 1/1     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-scheduler-192.168.31.189                                    1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         kube-vip-192.168.31.189                                          1/1     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-bxp4t                           1/1     Running   2          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jdncv                           1/1     Running   3          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jhbbp                           1/1     Running   2          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-jpn89                           1/1     Running   2          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-cloud-controller-manager-qblld                           1/1     Running   1          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-controller-576c9c8dc8-9k2lm                          5/5     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-9fbs2                                           3/3     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-ffjlv                                           3/3     Running   0          3h44m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-lrkqk                                           3/3     Running   0          68m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-s49x6                                           3/3     Running   0          3h46m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system                         vsphere-csi-node-z5hdz                                           3/3     Running   0          3h44m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="로드밸런서-구성">로드밸런서 구성<a class="hash-link" href="#로드밸런서-구성" title="Direct link to heading">​</a></h2><p>쿠버네티스 v1.14.2 이후 버전부터는 <code>IPVS</code>모드에서 kube-proxy 사용을 위해 MetalLB 구성전에 <a href="https://metallb.universe.tf/installation/#preparation" target="_blank" rel="noopener noreferrer">strict ARP 모드를 활성화</a>해야한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -e "s/strictARP: false/strictARP: true/" | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl describe configmap -n kube-system kube-proxy | grep ARP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strictARP: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>미리 서비스에서 사용할 IP 대역을 지정하기 위해 helm chart configmap value를 미리 생성한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; 'EOF' &gt;&gt; values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configInline:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address-pools:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: layer2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addresses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - 192.168.31.10-192.168.31.19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>metallb가 사용할 네임스페이스 <code>metallb-system</code>를 만들고 위 configmap value파일로 metalLB를 설치한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add metallb https://metallb.github.io/metallb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns metallb-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install metallb metallb/metallb -n metallb-system -f values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get all -n metallb-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-controller-69bbb4669c-2pdnk   1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-2km46                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-cm9xw                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-dptbx                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-jk7hn                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-kgfkl                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/metallb-speaker-t7qkw                 1/1     Running   0          115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps/metallb-speaker   6         6         6       6            6           kubernetes.io/os=linux   115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/metallb-controller   1/1     1            1           115s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                            DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/metallb-controller-69bbb4669c   1         1         1       115s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>metallb 리소스가 모두 정상으로 올라오면 서비스 하나를 LoadBalancer 타입으로 배포하고 해당 서비스로 접속해본다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f https://anywhere.eks.amazonaws.com/manifests/hello-eks-a.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl expose deployment hello-eks-a --port=80 --type=LoadBalancer --name=hello-eks-a-lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; SVC1EXIP=$(kubectl get svc hello-eks-a-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; curl $SVC1EXIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thank you for using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████╗██╗  ██╗███████╗                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔════╝██║ ██╔╝██╔════╝                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">█████╗  █████╔╝ ███████╗                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══╝  ██╔═██╗ ╚════██║                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████╗██║  ██╗███████║                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">╚══════╝╚═╝  ╚═╝╚══════╝                                             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> █████╗ ███╗   ██╗██╗   ██╗██╗    ██╗██╗  ██╗███████╗██████╗ ███████╗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══██╗████╗  ██║╚██╗ ██╔╝██║    ██║██║  ██║██╔════╝██╔══██╗██╔════╝</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">███████║██╔██╗ ██║ ╚████╔╝ ██║ █╗ ██║███████║█████╗  ██████╔╝█████╗  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██╔══██║██║╚██╗██║  ╚██╔╝  ██║███╗██║██╔══██║██╔══╝  ██╔══██╗██╔══╝  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">██║  ██║██║ ╚████║   ██║   ╚███╔███╔╝██║  ██║███████╗██║  ██║███████╗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝    ╚══╝╚══╝ ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You have successfully deployed the hello-eks-a pod hello-eks-a-9644dd8dc-647bq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For more information check out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://anywhere.eks.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢⬡⬢</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="인그레스-컨트롤러-설치">인그레스 컨트롤러 설치<a class="hash-link" href="#인그레스-컨트롤러-설치" title="Direct link to heading">​</a></h2><p>API Gateway 오픈소스인 <a href="https://docs.solo.io/gloo-edge/latest/" target="_blank" rel="noopener noreferrer">Gloo Edge</a>를 인그레스 컨트롤러로 사용할 수 있다. <code>Envoy</code> 기반의 경량화된 오픈소스로 쿠버네티스 네이티브한 옵션들을 제공하기 때문에 개인적으로 선호하는편이다. 공식 설치 문서는 다음 링크에서 확인할 수 있다.</p><p><a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/" target="_blank" rel="noopener noreferrer">https://docs.solo.io/gloo-edge/latest/installation/ingress/</a></p><p>공식 CLI인 <a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-glooctl" target="_blank" rel="noopener noreferrer">glooctl</a>나 <a href="https://docs.solo.io/gloo-edge/latest/installation/ingress/#installing-on-kubernetes-with-helm" target="_blank" rel="noopener noreferrer">Helm Chart</a>로 설치를 진행할 수 있다. ingress를 구성하기 위해 <code>gateway.enabled</code> value값을 <code>false</code>로 <code>ingress.enabled</code> value를 <code>true</code>로 변경하여 inline 구성으로 배포를 진행한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add gloo https://storage.googleapis.com/solo-public-helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install gloo gloo/gloo --namespace gloo-system \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set gateway.enabled=false,ingress.enabled=true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get all -n gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/discovery-9694c78f6-zrf4l        1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/gloo-7cd566cb69-bfghh            1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ingress-7fb5c9687d-qq98j         1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ingress-proxy-5cc555c45b-9mj9n   1/1     Running   0          88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                               AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/gloo            ClusterIP      10.100.162.70   &lt;none&gt;          9977/TCP,9976/TCP,9988/TCP,9979/TCP   88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/ingress-proxy   LoadBalancer   10.107.107.38   192.168.31.11   80:32207/TCP,443:32228/TCP            88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/discovery       1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/gloo            1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/ingress         1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/ingress-proxy   1/1     1            1           88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                       DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/discovery-9694c78f6        1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/gloo-7cd566cb69            1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/ingress-7fb5c9687d         1         1         1       88s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/ingress-proxy-5cc555c45b   1         1         1       88s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>샘플 <code>petstore</code> 서비스를 배포하고, 인그레스 클래스 어노테이션을 <code>kubernetes.io/ingress.class: gloo</code>로 선언하고 <code>ddiiwoong.com</code> 호스트 이름으로 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://raw.githubusercontent.com/solo-io/gloo/v1.2.9/example/petstore/petstore.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF | kubectl apply -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: petstore-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # note: this annotation is only required if you've set </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # REQUIRE_INGRESS_CLASS=true in the environment for </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # the ingress deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/ingress.class: gloo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: ddiiwoong.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - path: /.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pathType: ImplementationSpecific</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name: petstore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            port:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              number: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME               CLASS    HOSTS           ADDRESS         PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">petstore-ingress   &lt;none&gt;   ddiiwoong.com   192.168.31.11   80      7m41s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 호스트로 정상 라우팅되어 접속되는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; curl -H "Host: ddiiwoong.com" 192.168.31.11/api/pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{"id":1,"name":"Dog","status":"available"},{"id":2,"name":"Cat","status":"pending"}]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gitops-컨트롤러로-클러스터-관리">GitOps 컨트롤러로 클러스터 관리<a class="hash-link" href="#gitops-컨트롤러로-클러스터-관리" title="Direct link to heading">​</a></h2><p>gitops 오픈소스인 <a href="https://fluxcd.io/docs/get-started/" target="_blank" rel="noopener noreferrer">Flux</a>를 사용해서 여러가지 클러스터 관리를 수행할 수 있다. 위에서 생성한 <code>desired state</code>인 클러스터 컨피그를 github repo에서 Flux 컨트롤러를 통해 클러스터 운영을 수행할 수 있다. </p><p><a href="https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/" target="_blank" rel="noopener noreferrer">https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-flux/</a></p><p>Worker 노드와 Control Plan, Etcd등의 vSphere에서 관리하는 datastore, 디스크, 메모리, CPU, resourcepool 등을 관리할 수 있다. 단, EKS의 관리형 노드그룹과 유사한 방식으로 노드그룹의 VM의 숫자를 늘리거나 줄일수 있지만 아직까지 신규로 worker 노드그룹을 생성하거나 삭제하는 기능은 제공하지 않는다.</p><p>초기 클러스터 컨피그에 아래와 같이 기존 노드그룹 <code>md-0</code>에 신규 VM 1대를 추가해보자. (2대-&gt;3대)</p><ul><li><code>clusters/$CLUSTER_NAME/eksa-system/eksa-cluster.yaml</code></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> anywhere.eks.amazonaws.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workerNodeGroupConfigurations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">machineGroupRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VSphereMachineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 환경에서 구성된 gitops repo에 수정된 파일을 커밋한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git add clusters/homelab/eksa-system/eksa-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git commit -m 'Scale from 2 to 3 at WorkerNodeGroup md-0 '</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push origin main</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>md-0</code> 노드그룹에 VM이 새롭게 추가된 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get machine -n eksa-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            CLUSTER   NODENAME         PROVIDERID                                       PHASE     AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-etcd-jrhvt              homelab                    vsphere://421b44b1-6017-8469-734b-01bcf68cb459   Running   75m   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-j5mql                   homelab   192.168.31.186   vsphere://421b4382-0727-3afc-5c47-b73455010d35   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-j68fd   homelab   192.168.31.190   vsphere://421bc1ee-eac7-f1db-b351-5fac25b45fc0   Running   11m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-jszj4   homelab   192.168.31.187   vsphere://421b4dc9-b7c6-f0a2-0b50-e5379748b9a9   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-md-0-76478bb486-rpxlm   homelab   192.168.31.188   vsphere://421b20a4-9870-cd20-4cff-67bb4a9d8372   Running   75m   v1.21.5-eks-1-21-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">homelab-w6bq8                   homelab   192.168.31.189   vsphere://421befe9-e26a-3f18-9ccf-3fe32dd57fd2   Running   75m   v1.21.5-eks-1-21-8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 eks-anywhere 오픈소스를 vSphere 홈서버에서 테스트를 진행한 경험을 정리했다. </p><p>설치를 진행하면서 에러가 나면 하나하나 공식 문서를 확인하고, 회사 슬랙 찬스도 사용하면서 힘들게 설치를 완료했다. 생각보다 디버깅을 하는데 많은 시간을 허비했는데 실제로 2일 이상 고생을 했다. 대부분의 경우 디버그 레벨의 로그를 보면서 트러블슈팅을 통해 문제 해결이 가능했고 그 과정에서 EKS Anywhere의 내부 구성요소들과 실제 Cluster API 워크플로우를 이해할 수 있었다. </p><p>다만 아직까지 문서화나 커뮤니티에 많은 유스케이스가 없다는 점과 Cilium을 메인 CNI로 활용함에도 불구하고 <code>CiliumNetworkPolicy</code> API를 사용하지 못하는 점이나 Cilium 유저 인터페이스인 <a href="https://github.com/cilium/hubble-ui" target="_blank" rel="noopener noreferrer">Hubble UI</a>를 활성화해서 사용할 수가 없는 <a href="https://anywhere.eks.amazonaws.com/docs/tasks/workload/networking-and-security/#additional-cilium-features" target="_blank" rel="noopener noreferrer">제약사항</a>등이 있었고, 쿠버네티스 관련해서는 <code>Persistent Volume</code> 관련하여 vSAN을 사용하지 않은 환경에서는 VMDK를 수동으로 생성하고 해당 볼륨을 매핑시켜야 활용이 가능한 제약사항이 존재하는 것이 조금 아쉬운 부분이다.</p><p>실제 프로덕션 환경에서 사용할 정도라기 보단 EKS를 사용하는 관점에서 유사한 경험을 바탕으로 개발환경을 가져갈수 있고 tanzu나 다른 cluster-api를 활용한 도구들 보다 좀더 유연하고 오픈소스에 가까운 경험성을 제공한다고 생각한다. 게다가 Flux의 <code>Server-side reconciliation</code> 기반 <a href="https://kubernetes.io/docs/reference/using-api/server-side-apply/" target="_blank" rel="noopener noreferrer">쿠버네티스 리소스 관리 방식</a>으로 클러스터를 매우 유연하게 관리할 수 있다는 것도 주목해볼만한 내용이라 생각한다. 클러스터 자체도 인프라 리소스라 가정하고 최초에 원하는 형태로 선언하고 구성이후에도 쿠버네티스 CRD 형식으로 노드그룹과 인스턴스 등의 여러 리소스를 GitOps 방식으로 관리하는 방식을 채택하고 있기 때문에 실제 인프라 관리를 하는 운영자를 위한 가장 효과적인 방법을 채택했다고 볼 수 있다.</p><p>그리고 표준규격의 Managed 하드웨어를 사용하는 Outpost와 비교하는 자료들이 최근 많이 올라오고 있는데 EKS Anywhere의 가장 큰 장점은 내가 가진 하드웨어를 EKS Distro기반의 오픈소스를 통해 사용할 수 있고 AWS 환경과의 직접적인 통신이 없이도 자체적인 워크로드 운영이 가능한게 가장 큰 장점이라고 생각한다. </p><p>현재 재직중인 회사의 제품과 관련해서 로드맵을 자세히 언급하지는 못하지만 엔터프라이즈 vSphere 환경과 동시에 EKS를 사용하는 조직에서는 중요한 하나의 선택지가 될 수 있다는 점에서도 지켜볼만하다고 생각한다. </p><p>다음 포스팅에서는 해당 클러스터에 OpenTelemetry collector, Loki, Prometheus 구성을 통한 observability 환경 구성을 진행해볼 예정이다.</p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="vsphere" term="vsphere"/>
        <category label="eks anywhere" term="eks anywhere"/>
        <category label="eks" term="eks"/>
        <category label="flux" term="flux"/>
        <category label="gitops" term="gitops"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[What is Tailscale?]]></title>
        <id>/2022/02/05/what-is-tailscale</id>
        <link href="https://ddii.dev/2022/02/05/what-is-tailscale"/>
        <updated>2022-02-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[wireguard와 tailscale을 비교하고 kubernetes 환경에서 활용방안 검토]]></summary>
        <content type="html"><![CDATA[<blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote><p>이직을 하고 블로그에 손을 놓고 있다가 페이스북 <a href="https://ko-kr.facebook.com/groups/" target="_blank" rel="noopener noreferrer">Kubernetes Korea Group</a>에 올라온 <a href="https://gasidaseo.notion.site/c9cd413265ea4ea1b1ae38eb36dfda94" target="_blank" rel="noopener noreferrer">쿠버네티스 네트워킹 스터디 모집 공고</a>를 보게되었다. 이직후에 대부분의 프로젝트가 쿠버네티스 기반으로 진행되다 보니 네트워크 전문가 이신 <a href="https://www.facebook.com/jongho.seo.5811" target="_blank" rel="noopener noreferrer">가시다</a>님의 <a href="https://cloudneta.github.io/" target="_blank" rel="noopener noreferrer">팀 블로그</a>나 이나 여러 양질의 게시글들을 참고만 하다가 조금더 깊이 학습을 하고 싶어 스터디를 신청했고, 간단한 면접(??)후에 정식으로 스터디에 참여하게 되었다.  </p><p>본론으로 돌아가서 calico 스터디를 진행하다가 <a href="https://www.wireguard.com/" target="_blank" rel="noopener noreferrer">wireguard</a>라는 opensource vpn을 알게 되었고 해당 패키지를 이것저것 테스트하다가 기존에 사용중인 <a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer">tailscale</a> 과 유사하다는 것을 인지하고 내부 구성을 조금 찾아보기로 했다.  </p><p>확인해보니 tailscale은 wireguard 기반으로 하는 동일 기술의 상용 솔루션이였고, 이에 몇가지 공부차 정리를 위해 해당 포스트를 작성하게 되었다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="wireguard">Wireguard<a class="hash-link" href="#wireguard" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.wireguard.com/" target="_blank" rel="noopener noreferrer">https://www.wireguard.com/</a></li></ul><p>먼저 WireGuard를 간단하게 정의하면 보안에 초점을 두고 단순함과 쉬운 사용을 대표적인 특징으로 내세우는 오픈소스 기반 VPN 소프트웨어로 IPsec과 OpenVPN보다 사용하기 용이하고 가벼운 것을 강점으로 <a href="https://lore.kernel.org/wireguard/CAHmME9qOpDeraWo5rM31EWQW574KEduRBTL-+0A2ZyqBNDeYkg@mail.gmail.com/T/#u" target="_blank" rel="noopener noreferrer">Linux 5.6 커널 이후부터 기본 패키지</a>로 탑재가 되었다. 제이슨 도넨필드(Jason Donenfeld, <a href="https://twitter.com/zx2c4" target="_blank" rel="noopener noreferrer">@zx2c4</a>)가 설계한 WireGuard는 암호화 민첩성, 즉 다양한 암호화, 키 교환, 해싱 알고리즘에 대한 선택권을 제공한다는 개념을 버리고 아주 간결한 코드 구조를 통해 커널에서 직접 동작하고 주요 암호 알고리즘에 대해서 병렬처리하므로 빠른 속도를 자랑한다.  </p><p>홈페이지에 게시된 몇가지 특징을 정리하면 </p><ul><li>Simple &amp; Easy-to-use : SSH 처럼 키교환 방식으로 진행되고 WireGuard에 의해 관리되기 때문에 쉽게 사용이 가능하고, IP가 변경되는 모바일 로밍중에서 연결이 보장되는 것이 특징이다. </li><li>Cryptographically Sound : <a href="http://www.noiseprotocol.org/" target="_blank" rel="noopener noreferrer">Noise protocol framework</a>, <a href="http://cr.yp.to/ecdh.html" target="_blank" rel="noopener noreferrer">Curve25519</a>, <a href="http://cr.yp.to/chacha.html" target="_blank" rel="noopener noreferrer">ChaCha20</a>, <a href="http://cr.yp.to/mac.html" target="_blank" rel="noopener noreferrer">Poly1305</a>, <a href="https://blake2.net/" target="_blank" rel="noopener noreferrer">BLAKE2</a>, <a href="https://131002.net/siphash/" target="_blank" rel="noopener noreferrer">SipHash24</a>, <a href="https://eprint.iacr.org/2010/264" target="_blank" rel="noopener noreferrer">HKDF</a> 와 같은 가장 빠르고 최신의 암호, 해시 알고리즘을 사용한다.  </li><li>Minimal Attack Surface : WireGuard는 구현 용이성과 단순성을 염두에 두고 설계되었다. 매우 적은 코드 라인으로 구현되서 보안 취약점에 대해 쉽게 감사할 수 있다. 그만큼 철저히 검증될 가능성이 높고, 예상치 못한 곳에서의 버그로 인한 취약점이 발생할 가능성이 상대적으로 적다는 얘기가 된다.  </li><li>High Performance : 모든 것이 kernel에서 동작하고 안전한 네트워킹이 매우 빠른 속도 로 동작하기 때문에 스마트폰과 백본 라우터와 같은 작은 임베디드 장치 등 모두에 적합하다.  </li><li>Well Defined &amp; Thoroughly Considered : Wireguard는 <a href="https://www.wireguard.com/papers/wireguard.pdf" target="_blank" rel="noopener noreferrer">백서</a>가 발행될 정도로 기술적으로 여러가지 고려사항들을 명확하게 정의해놨다.</li></ul><p>관련한 자세한 내용은 <a href="https://www.wireguard.com/papers/wireguard.pdf" target="_blank" rel="noopener noreferrer">백서</a> 를 참고한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="wireguard-in-calico-cni">Wireguard in Calico CNI<a class="hash-link" href="#wireguard-in-calico-cni" title="Direct link to heading">​</a></h3><p>스터디를 진행할때는 쿠버네티스 파드와 파드 사이의 패킷을 네트워크 레벨로 암호화 하는 도구로 Calico에 내장된 WireGuard 플러그인을 사용해서 파드간 터널을 설정하고 트래픽을 암호화 하는 테스트를 진행하게 되었다. Calico CNI에서 구성하는 방법은 <code>calicoctl</code>를 사용해서 설정하기 때문에 간단하다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ calicoctl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ calicoctl get felixconfiguration default -o yaml | grep wireguardEnabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wireguardEnabled: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>파드간의 ping test를 진행하고 난 이후 파드 레벨에서 패킷 덤프한 내용을 wireshark로 확인한 내용이다. 그림에서처럼 icmp 패킷은 확인이 안되고 udp와 wireguard 프로토콜을 통해 데이터가 암호화 된것을 확인할 수 있다.</p><p><img loading="lazy" alt="wg" src="/assets/images/wg-9118a771c7d571be3495eeef652b7e06.png" width="1002" height="575" class="img_E7b_"></p><p>이번 포스팅에서는 tailscale 활용방안을 소개하는 것으로 간단하게 calico를 통해 wireguard 설정하는 것은 넘어간다. 다른 좋은 내용들은 다음 링크들에서 확인할 수 있다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="참고자료">참고자료<a class="hash-link" href="#참고자료" title="Direct link to heading">​</a></h3><ul><li><a href="https://tech.devsisters.com/posts/wireguard-vpn-1/" target="_blank" rel="noopener noreferrer">WireGuard로 멋진 VPN 서버 구축하기 - devsisters</a></li><li><a href="https://slowbootkernelhacks.blogspot.com/2020/09/wireguard-vpn.html" target="_blank" rel="noopener noreferrer">WireGuard VPN 해부 - Slowboot</a></li><li><a href="https://github.com/squat/kilo" target="_blank" rel="noopener noreferrer">Kilo - multi-cloud k8s network overlay built on WireGuard</a></li><li><a href="https://git.zx2c4.com/wireguard-go/about/" target="_blank" rel="noopener noreferrer">Go implementation of WireGuard</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tailscale">Tailscale<a class="hash-link" href="#tailscale" title="Direct link to heading">​</a></h2><ul><li><a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer">https://tailscale.com/</a></li></ul><p>TailScale은 서버, 컴퓨터 및 클라우드 인스턴스간에 보안 네트워크를 만드는 VPN으로 Wireguard 프로토콜을 사용해서 만든 클라우드 서비스이다. Tailscale이 어떻게 동작하는지는 <a href="https://tailscale.com/blog/how-tailscale-works/" target="_blank" rel="noopener noreferrer">공식 블로그</a>에서 간단히 확인할 수 있다. </p><p>간단하게 블로그 내용을 정리해보면 기존의 VPN 방식은 Hub-and-spoke 방식으로 아래 그림과 같이 Gateway 방식으로 모든 클라이언트와 서버를 연결하는게 기존의 방식이다. 새로운 클라이언트나 서버가 추가될 경우 새로운 키를 모든 사용자에게 배포하게 되고 이는 장비가 증가함에 따라 많은 작업이 필요로 하게 된다.</p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/hub-and-spoke-single.svg" alt="hub" class="img_E7b_"></p><p>Wireguard 터널을 이용하면 노드간의 연결이 직접 이뤄지게 되고 이는 아래 그림과 같이 메쉬 형태로 구성되게 된다. </p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/mesh-network.svg" alt="mesh" class="img_E7b_"></p><p>이런 메쉬방식의 가장 큰 단점은 피어끼리 연결하는 노드 네트워크의 경우 연결되는 경우의 수가 <code>n(n-1)</code>으로 그림의 예시에서도 10*9 = 90개의 연결 구성이 필요하게 된다. 모든 노드가 해당 사항으로 Wireguard의 key를 로테이트하거나 사용자를 추가, 제거할때마다 각 노드에 업데이트가 되어야 한다. 만약에라도 각 노드에 static ip가 없을 경우 노드끼리 찾는일이 결고 쉽지는 않을 것이다. 특히 방화벽을 운영하는 엔터프라이즈 조직의 경우에 더욱더 까다로운 일이 된다고 말한다.</p><p>그래서 Tailscale에서 이야기하는 가장 핵심은 노드 간의 트래픽을 감사, 통제할 수 있는 컨트롤 플레인을 두는것이다. 방화벽이나 static ip가 없는 환경에서도 노드, 피어간의 통제가 가능한 환경을 제공하는 것이 기본 사상이다. </p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/mesh-coordination-server.svg" alt="controlplane" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기본-작동방식">기본 작동방식<a class="hash-link" href="#기본-작동방식" title="Direct link to heading">​</a></h3><ul><li>각 노드(클라이언트)는 랜덤 공개키와 개인키를 생성하고 공개키를 ID(tailscale account)와 연결한다.</li><li>노드는 중앙의 tailscale서버에 공개키와 해당 노드가 현재 연결가능한지와 도메인 정보(client name) 정보를 전달한다. </li><li>노드는 tailscale서버 업데이트된 도메인의 공개키 및 주소 목록을 다운로드 한다.</li><li>노드는 내려받은 공개 키 세트로 Wireguard 인스턴스를 구성한다.</li></ul><p>이는 다시 hub-and-spoke 모델로 돌아간것 같지만 실제 컨트롤 플레인과 데이터 플레인을 분리해서 처리하기 때문에 실제 중앙 서버가 관리하는 것은 공개키 세트와 연결가능한 노드 리스트 정보뿐이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tailscale-테스트">Tailscale 테스트<a class="hash-link" href="#tailscale-테스트" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="talescale-설치-macos-기준">talescale 설치 (macOS 기준)<a class="hash-link" href="#talescale-설치-macos-기준" title="Direct link to heading">​</a></h3><ul><li><a href="https://tailscale.com/download" target="_blank" rel="noopener noreferrer">https://tailscale.com/download</a></li></ul><p>macOS용 CLI 설치 정보는 아래 링크에서 확인할 수 있다. </p><ul><li><a href="https://tailscale.com/kb/1065/macos-variants/" target="_blank" rel="noopener noreferrer">https://tailscale.com/kb/1065/macos-variants/</a></li></ul><p>macOS용 GUI 클라이언트에 CLI도 내장되어 있기 때문에 <code>.zshrc</code>에 alias를 추가했다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>2022년 2월 5일자 기준으로 1.20.2 버전을 사용한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1.20.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tailscale commit: 312750ddd288cf4073cfaef56a45102b9c1e8421</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  other commit: 2c164d9c7443e2f3014fa54ea45e946b35152680</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  go version: go1.17.6-tse44d304e54</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>windows에서도 쉽게 설치가 가능하고, 물론 애정하는 Synology에도 패키지를 설치할 수 있다. </p><p><a href="https://github.com/tailscale/tailscale-synology" target="_blank" rel="noopener noreferrer">https://github.com/tailscale/tailscale-synology</a></p><p>설치된 클라이언트 모두를 tailscale 계정으로 로그인하면 VPN연결이 끝난다. </p><p>연결된 머신리스트는 아래와 같이 <a href="https://login.tailscale.com/admin/machines" target="_blank" rel="noopener noreferrer">Machines</a> 메뉴 에서 확인할 수 있고 각 노드나 클라이언트로 할당된 <code>100.*</code> 대역 IP로 접속이 가능하다. </p><p><img loading="lazy" alt="machine" src="/assets/images/tailscale-web-3a41c37cafdc8bbc9c7868e3dfe96040.png" width="948" height="1024" class="img_E7b_"></p><p>여기서 machine name으로 직접 접속이 가능하기 위해서는 MagicDNS 기능을 사용해야 하는데 <code>beta</code> 기능으로 <a href="https://login.tailscale.com/admin/dns" target="_blank" rel="noopener noreferrer">활성화</a>를 할 수 있고 네트워크에 있는 장치의 DNS 이름을 자동으로 등록하는 기능이다.</p><ul><li>DNS 설정가이드 : <a href="https://tailscale.com/kb/1081/magicdns/" target="_blank" rel="noopener noreferrer">https://tailscale.com/kb/1081/magicdns/</a></li></ul><p>CLI로 현재 연결된 client 정보나 publickey 등을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   proxy                ddiiwoong@   linux   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status --json | jq '.Self.PublicKey'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"nodekey:97c4dc44ecdf56******************adb3246d87fd9e270"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>DNS 등록 방식은 아래와 같이 구성되고</p><p><img loading="lazy" src="https://tailscale.com/kb/1081/magicdns/magic-dns-naming.png" alt="magicdns" class="img_E7b_"></p><p>내가 등록한 머신리스트에서 win11 은 다음 정보로 도메인이 등록된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">win11.ddiiwoong.gmail.com.beta.tailscale.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>두가지 방식으로 해당 머신에 ping check를 할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ping win11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=124.031 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.180 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.776 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping win11.ddiiwoong.gmail.com.beta.tailscale.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=5.086 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.060 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.213 ms</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-환경구성">kubernetes 환경구성<a class="hash-link" href="#kubernetes-환경구성" title="Direct link to heading">​</a></h3><p>kubernetes 리소스로 tailscale을 구성을 해보자. 먼저 <code>1.16</code> 버전 이상의 kubernetes 클러스터를 준비한다. 아래 구성환경은 <code>1.21.5</code> 버전으로 eksctl로 설치한 기본 EKS 클러스터이다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-101-195.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-134-35.ap-northeast-2.compute.internal    Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-186-235.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="authkey-발급-및-secret-등록">authKey 발급 및 Secret 등록<a class="hash-link" href="#authkey-발급-및-secret-등록" title="Direct link to heading">​</a></h3><p>authKey는 tailscale 네트워크에 등록하기 위한 Key로 아래와 같이 관리를 Web에서 할 수 있다.</p><p><img loading="lazy" alt="key" src="/assets/images/tailscale-key-7bc957707fe91c3c4465cb95ad0af640.png" width="1119" height="700" class="img_E7b_"></p><p><a href="https://login.tailscale.com/admin/settings/keys" target="_blank" rel="noopener noreferrer">Keys</a> 메뉴로 이동해서 auth Key를 발급받는다. 발급을 할때 여러머신에서 사용할 경우는 <code>Reusable</code>, 임시로 키를 사용할때는 <code>Ephemeral</code> 옵션을 사용할 수도 있다. 아래와 같은 형식으로 발급되고, 해당 key는 kubernetes <code>Secret</code> 리소스에 등록을 해서 사용할 것이다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">tskey-kZAinb5CNTRL-********************</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 auth Key를 Secret으로 생성한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stringData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AUTH_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tskey</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kZAinb5CNTRL</span><span class="token punctuation" style="color:#393A34">-</span><span class="token important">********************</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE                                  DATA   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-fww2j     kubernetes.io/service-account-token   3      18h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale-auth          Opaque                                3      18h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale-token-7cgsc   kubernetes.io/service-account-token   3      17h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="image-build--push">image build &amp; push<a class="hash-link" href="#image-build--push" title="Direct link to heading">​</a></h3><p>tailscale image를 빌드한다. 자세한 내용은 아래 링크를 참고한다.  </p><ul><li><a href="https://github.com/tailscale/tailscale/tree/main/docs/k8s" target="_blank" rel="noopener noreferrer">https://github.com/tailscale/tailscale/tree/main/docs/k8s</a></li></ul><p>Dockerfile은 다음과 같이 공식 이미지를 사용한다. </p><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ghcr.io/tailscale/tailscale:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY run.sh /run.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD "/run.sh"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a href="https://github.com/tailscale/tailscale/blob/main/docs/k8s/run.sh" target="_blank" rel="noopener noreferrer">run.sh</a>을 살펴보면 <code>tailscaled</code> 데몬을 실행할때 몇가지 환경변수를 입력받아 처리하는 것을 알 수 있다. </p><p><code>AUTH_KEY</code>와 <code>KUBE_SECRET</code>은 위 Secret으로 처리를 하고 여러 사용 모드(router, userspace)도 컨테이너 실행시 입력받아 처리한다. 또한, 마지막 구문을 보면 목적지 IP DNAT 처리를 위한 iptables 등록 옵션도 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#! /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/tailscale/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AUTH_KEY="${AUTH_KEY:-}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ROUTES="${ROUTES:-}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEST_IP="${DEST_IP:-}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXTRA_ARGS="${EXTRA_ARGS:-}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USERSPACE="${USERSPACE:-true}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KUBE_SECRET="${KUBE_SECRET:-tailscale}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TAILSCALED_ARGS="--state=kube:${KUBE_SECRET} --socket=/tmp/tailscaled.sock"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ "${USERSPACE}" == "true" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -z "${DEST_IP}" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo "IP forwarding is not supported in userspace mode"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TAILSCALED_ARGS="${TAILSCALED_ARGS} --tun=userspace-networking"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -d /dev/net ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p /dev/net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -c /dev/net/tun ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mknod /dev/net/tun c 10 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo "Starting tailscaled"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscaled ${TAILSCALED_ARGS} &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PID=$!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UP_ARGS="--accept-dns=false"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z "${ROUTES}" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS="--advertise-routes=${ROUTES} ${UP_ARGS}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z "${AUTH_KEY}" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS="--authkey=${AUTH_KEY} ${UP_ARGS}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z "${EXTRA_ARGS}" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS="${UP_ARGS} ${EXTRA_ARGS:-}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo "Running tailscale up"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale --socket=/tmp/tailscaled.sock up ${UP_ARGS}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z "${DEST_IP}" ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo "Adding iptables rule for DNAT"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  iptables -t nat -I PREROUTING -d "$(tailscale --socket=/tmp/tailscaled.sock ip -4)" -j DNAT --to-destination "${DEST_IP}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wait ${PID}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build하고 레지스트리로 push 하자.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export IMAGE_TAG=ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker build . -t $(IMAGE_TAG)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker push $(IMAGE_TAG)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker images ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REPOSITORY            TAG       IMAGE ID       CREATED        SIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ddiiwoong/tailscale-k8s   latest    9dc489da64c4   18 hours ago   44.1MB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="rbac-리소스-생성">RBAC 리소스 생성<a class="hash-link" href="#rbac-리소스-생성" title="Direct link to heading">​</a></h3><p>rbac 설정을 위해서 <code>role</code>, <code>rolebinding</code>, <code>serviceaccount</code>를 생성한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export SA_NAME=tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export KUBE_SECRET=tailscale-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 ENV값을 치환해서 생성한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># "" indicates the core API group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"secrets"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Create can not be restricted to a resource name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"create"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># "" indicates the core API group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourceNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"tailscale-auth"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"secrets"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"get"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"update"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sidecar-배포">sidecar 배포<a class="hash-link" href="#sidecar-배포" title="Direct link to heading">​</a></h3><p>sidecar 생성을 위해 manifest를 확인한다. 자세히 살펴보면 <code>ts-sidecar</code> 컨테이너 securityContext에 <code>NET_ADMIN</code> 권한이 추가된것을 볼수 있다. 이는 sidecar 파드가 터널 인터페이스를 구성하기 위해 상위 노드 <code>CAP_NET_ADMIN</code> 권한을 취득하기 위함이다. 자세한 내용은 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container" target="_blank" rel="noopener noreferrer">Set capabilities for a Container</a> 문서를 확인하자. </p><p>그리고 추가 sidecar로 <code>nicolaka/netshoot</code>를 추가했는데 이는 <a href="https://github.com/nicolaka/netshoot" target="_blank" rel="noopener noreferrer">네트워크 장애 처리에 유용한 프로젝트</a>로 여러가지 네트워크 정보를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> netshoot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nicolaka/netshoot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"tail"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"-f"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/dev/null"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Store the state in a k8s secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"false"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> NET_ADMIN</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성을 하고 살펴보면 sidecar nginx 파드가 생성된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod nginx -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   3/3     Running   0          25s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>tailscale sidecar 로그를 잠깐 살펴보자. 새로운 <code>tailscale0</code> tun 인터페이스가 추가되고 원래 pod eth0 인터페이스 ip도 확인이 된다. 또한 <code>wireguard</code> device도 올라오는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl logs nginx ts-sidecar -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting tailscaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running tailscale up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 logtail started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Program starting: v1.20.2-t8e643357d, Go 1.17.6-tse44d304e54: []string{"tailscaled", "--state=kube:tailscale-auth", "--socket=/tmp/tailscaled.sock"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 LogID: 31416c9a454e3667661bf0f21ccde8ebf72604d7434660b0db55e838be372bc4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 logpolicy: using system state directory "/var/lib/tailscale"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logpolicy.Read /var/lib/tailscale/tailscaled.log.conf: open /var/lib/tailscale/tailscaled.log.conf: no such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 wgengine.NewUserspaceEngine(tun "tailscale0") ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 router: disabling tunneled IPv6 due to system IPv6 config: disable_ipv6 is set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 dns: [rc=unknown ret=direct]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 dns: using *dns.directManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 link state: interfaces.State{defaultRoute=eth0 ifs={eth0:[192.168.118.89/32]} v4=true v6=false}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 magicsock: disco key = d:1b04c57ebf000fe0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Creating wireguard device...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Bringing wireguard device up...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Bringing router up...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 external route: up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Clearing router settings...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Starting link monitor...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Engine created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 netmap packet filter: (not ready yet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 using backend prefs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 active login: ddiiwoong@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 netmap packet filter: 1 filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: Set: {DefaultResolvers:[] Routes:{} SearchDomains:[] Hosts:4}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: Resolvercfg: {Routes:{} Hosts:4 LocalDomains:[]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: OScfg: {Nameservers:[] SearchDomains:[] MatchDomains:[]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 Taildrop disabled; no state directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 peerapi starting without Taildrop directory configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 peerapi: serving on http://100.95.209.95:34980</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>netshoot 파드내에서도 <code>tailscale0</code> 인터페이스가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it nginx -c netshoot -- ip -c addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 6e:f8:f5:f3:47:11 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 192.168.118.89/32 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4: tailscale0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc pfifo_fast state UNKNOWN group default qlen 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 100.95.209.95/32 scope global tailscale0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>로컬에서 <code>tailscale</code> CLI를 통해 IP정보도 동일한 것을 확인 할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   nginx                ddiiwoong@   linux   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>먼저 어떠한 kubernetes 서비스도 없는 것을 확인하고, 미리 magicdns를 구성해놨기 때문에 <code>nginx</code> 주소로 직접 통신을 시도해보자. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found in A namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING nginx.ddiiwoong.gmail.com.beta.tailscale.net (100.95.209.95): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=0 ttl=255 time=193.606 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=1 ttl=255 time=95.747 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=2 ttl=255 time=94.441 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="userspace-sidecar-테스트">Userspace Sidecar 테스트<a class="hash-link" href="#userspace-sidecar-테스트" title="Direct link to heading">​</a></h3><p>userspace 모드로 실행해보자. 위와 차이점은 <code>NET_ADMIN</code> 권한을 빼고, <code>runAsUser: 1000</code>와 <code>runAsGroup: 1000</code>을 추가했다. 해당 클라이언트나 노드가 외부로 통신을 위해서는 <a href="https://tailscale.com/kb/1112/userspace-networking/" target="_blank" rel="noopener noreferrer">SOCKS5 이나 HTTP proxy 모드</a>로 실행되어야 한다. 이번 데모에서는 구성하지 않는다.</p><p>userspace 모드는 주로 서버리스 워크로드(Heroku, Google Cloud Run, AWS Lambda, Github Action)에서 활용을 할 때 좋다. 단 보안을 위해 authKey를 <code>ephemeral</code> 형태로 구성하는게 좋다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: netshoot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nicolaka/netshoot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command: ["tail"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args: ["-f", "/dev/null"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: ts-sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      runAsUser: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      runAsGroup: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          key: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          optional: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>동일하게 접속이 가능한데, userspace 모드 이기 때문에 netshoot 컨테이너로 인터페이스를 확인하면 권한이 없기 때문에 eth0 만 확인 가능하다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it nginx -c netshoot -- ip -c addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 3a:c5:b6:cf:d1:bd brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 192.168.117.251/32 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="proxy-모드-테스트">Proxy 모드 테스트<a class="hash-link" href="#proxy-모드-테스트" title="Direct link to heading">​</a></h3><p>기존의 배포된 Service 리소스에 연결하는 방식이다. 미리 nginx를 띄워 놓고 ClusterIP를 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create deployment nginx --image nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl expose deployment nginx --port 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc nginx -o=jsonpath='{.spec.clusterIP}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/nginx created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/nginx exposed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.100.213.92%</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Proxy 파드를 배포한다. 참고할 사항은 <code>sysctler</code> 컨테이너인데, 기본적으로 <code>net.ipv4.ip_forward</code> 플래그는 <code>Kubelet</code>에서 화이트리스트 처리가 되어 있지 않으므로 내부에서 IP Forwarding을 위해서 추가 설정이 필요하다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  initContainers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: sysctler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      privileged: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command: ["/bin/sh"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - sysctl -w net.ipv4.ip_forward=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memory: 1Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: "false"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          key: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          optional: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: DEST_IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: 10.100.213.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - NET_ADMIN</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          5m59s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxy                    1/1     Running   0          22s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 배포된 proxy 컨테이너로 접속해보면 동일하게 접근이 되는 것을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   proxy                ddiiwoong@   linux   idle, tx 788 rx 1452</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl https://proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="subnet-router-모드-테스트">Subnet Router 모드 테스트<a class="hash-link" href="#subnet-router-모드-테스트" title="Direct link to heading">​</a></h3><p>Tailscale에서 Subnet Router 모드를 사용하면 전체 클러스터의 subnet 대역으로 접근이 가능하다. </p><p>기본적으로 EKS API는 서비스 subnet으로 <code>10.100.0.0/16</code> 또는 <code>172.20.0.0/16</code> 을 사용한다. 배포한 eksctl로 구성한 EKS 클러스터 subnet은 3개 AZ에 19bit로 나뉘어 배포되었고 <code>192.168.96.0/19</code>, <code>192.168.128.0/19</code>, <code>192.168.160.0/19</code>으로 구성되어 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 STATUS   ROLES    AGE   VERSION               INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-101-195.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.101.195   &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-134-35.ap-northeast-2.compute.internal    Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.134.35    &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-186-235.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.186.235   &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE     IP                NODE                                                 NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          11m     192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxy                    1/1     Running   0          5m39s   192.168.155.196   ip-192-168-134-35.ap-northeast-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   ClusterIP   10.100.213.92   &lt;none&gt;        80/TCP    11m   app=nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 subnet 대역을 접속하기 위해서 서비스 대역인 <code>10.100.0.0/16</code>와 파드 대역인 <code>192.168.96.0/19</code>, <code>192.168.128.0/19</code>, <code>192.168.160.0/19</code>를 설정해서 router 모드로 tailscale을 실행하자.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> subnet</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">router</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"true"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ROUTES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.100.0.0/16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.96.0/19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.128.0/19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.160.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">runAsUser</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">runAsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포된 router 디바이스와, 내부의 서비스에 접근하기 위해 파드와 서비스 IP를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   subnet-router        ddiiwoong@   linux   idle, tx 1556 rx 2908</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet-router            1/1     Running   0          9m47s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n tailscale -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE   IP                NODE                                                 NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          39m   192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet-router            1/1     Running   0          10m   192.168.137.188   ip-192-168-134-35.ap-northeast-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   ClusterIP   10.100.213.92   &lt;none&gt;        80/TCP    40m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>바로 접속을 해보면 접속이 안된다는걸 알수 있다. <a href="https://login.tailscale.com/admin/machines" target="_blank" rel="noopener noreferrer">tailscale 서비스</a>로 이동해 route 설정에서 접근할 대역을 아래와 같이 활성화하고 curl로 접속해보면 정상적으로 접근이 된다는걸 알수 있다. 이걸로 생각해봤을 때 <code>NetworkPolicy</code> 등과 함께 설정을 하면 내부 리소스 접근 통제도 가능할 것으로 생각된다. </p><p><img loading="lazy" alt="router" src="/assets/images/subnetmode-1a9c172f146ddde3e0182a3f40eb7393.png" width="1172" height="720" class="img_E7b_"></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 192.168.112.183</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 10.100.213.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="활용방안">활용방안<a class="hash-link" href="#활용방안" title="Direct link to heading">​</a></h2><p>기존에는 집 내부에 있는 자원 NAS나 macOS 등을 원격으로 관리하기 위한 용도였다면, 이번 테스트를 통해 기본 Personal 무료 Plan으로도 활용가능한 몇가지 유스케이스를 생각해봤다.  </p><ul><li>추가적인 VPN 구성없이 원격지 쿠버네티스 클러스터에 존재하는 애플리케이션 디버깅 및 관리 가능 (Telepresence 대체)</li><li>sidecar 모드로 활용시 Private 리소스에 대한 서비스 구성 및 IP관리 불필요 </li><li>Prometheus Service Discovry를 tailscale로 진행하여 개인 관리 디바이스 전체 모니터링</li><li>모바일 웹앱 테스트시 본인 휴대폰으로 직접 액세스 가능</li><li>현재 개인 프로젝트로 활용중인 Plex(미디어서버), 노트 앱 등을 서비스 구성없이 ACL 및 MFA 적용을 통한 보안 강화</li><li>wireguard 프로토콜을 활용하기 때문에 어디서든 끊김없이 클러스터 리소스 접근</li><li>현재 구성중인 site-to-site vpn 대체 (OCI-OCI간)</li></ul><p>더 많은 활용방안이 있을텐데 일단 생각나는 것들만 적어보았다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅은 네트워크 스터디를 진행하면서 과제로 작성된 부분이 없지 않다. 정말 이번 스터디는 역대급으로 퀄리티나 여러가지면에서 좋은 점이 많다. 항상 대단하다고 느끼는 분들과 함께하고 있어서 마지막까지 완주할 수 있도록 조금 더 공부해야 겠다는 생각이 든다. 다시한번 <a href="https://www.facebook.com/jongho.seo.5811" target="_blank" rel="noopener noreferrer">가시다</a>님을 <code>shout-out</code> 하고 2022년 첫 포스팅은 이것으로 마무리한다.</p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="wireguard" term="wireguard"/>
        <category label="tailscale" term="tailscale"/>
        <category label="vpn" term="vpn"/>
        <category label="network" term="network"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Synology monitoring with Prometheus and snmp exporter]]></title>
        <id>/2021/06/11/synology-prometheus</id>
        <link href="https://ddii.dev/2021/06/11/synology-prometheus"/>
        <updated>2021-06-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Prometheus로 시놀로지 NAS Monitoring하는 방법 정리]]></summary>
        <content type="html"><![CDATA[<p>이번 포스팅에서는 아재라면 다들 하나씩 구비하고 있을 시놀로지(Synology) NAS를 Prometheus와 snmp_exporter를 활용해서 모니터링 하는 방법을 정리한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구성방안">구성방안<a class="hash-link" href="#구성방안" title="Direct link to heading">​</a></h2><p>총 5개의 구성으로 모니터링 스택을 구성하려고 한다.  </p><p>구성방법은 아래와 같다. 모든 구성요소는 시놀로지내 도커 컨테이너로 구성될 예정이다.</p><ul><li>Prometheus : 데이터 수집 및 저장을 담당하는 시계열 데이터베이스</li><li>Alertmanager : Prometheus에서 발생된 알림을 수신하여 메시지를 전달</li><li>Node Exporter : Linux Node의 모니터링 데이터를 Expose</li><li>SNMP Exporter : SNMP 기반 디바이스의 모니터링 데이터를 Expose</li><li>Grafana : 시각화 도구</li></ul><p><img loading="lazy" alt="arch" src="/assets/images/arch-8407219cefc78aa4cd1559137fe51bd4.png" width="511" height="152" class="img_E7b_">  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="시놀로지-모니터링">시놀로지 모니터링<a class="hash-link" href="#시놀로지-모니터링" title="Direct link to heading">​</a></h2><p>기본적으로 시놀로지 UI에서도 관련된 데이터들을 확인할수 있고 디스크 오류나 전원 등 특별한 이벤트가 발생했을 경우는 별도로 이메일이나 커스텀 스크립트를 통해 알림을 받을 수 있지만 메트릭을 기반으로 하는 특정 상황에서 알림을 받거나 내가 원하는 모니터링 대시보드를 꾸미기 위한 용으로 시놀로지는 SNMP기반의 모니터링을 제공한다. 다른 NMS 또는 모니터링 도구등을 사용하기 보다는 업무와 관련있는 실제 SNMP exporter를 구성해보고 프로메테우스와 그라파나 대시보드를 통해 모니터링을 하는데 목적이 있다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="시놀로지-설정">시놀로지 설정<a class="hash-link" href="#시놀로지-설정" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-요구사항">사전 요구사항<a class="hash-link" href="#사전-요구사항" title="Direct link to heading">​</a></h3><ul><li><a href="https://www.synology.com/en-global/dsm/packages/Docker" target="_blank" rel="noopener noreferrer">시놀로지 Docker</a></li><li>SSH 허용</li><li>Admin 권한</li><li>SNMP 설정</li></ul><p>SNMP 설정을 제외한 3가지 구성은 기본적으로 되어있다 가정하고 진행한다.  </p><p>시놀로지는 기본적으로 SNMP 설정이 비활성화 상태이기 때문에 변경이 필요하다. 아래 그림과 같이 시놀로지의 제어판 - 터미널 및 SNMP - SNMP탭 으로 이동해서 SNMP 서비스를 활성화를 체크하고 이후 snmp exporter 설정에서 사용될 community값을 원하는 값으로 변경한 후 저장한다.  </p><p><img loading="lazy" alt="snmp" src="/assets/images/snmp-1dd8d97d83c6837b21f36919cc3e5c1c.png" width="991" height="559" class="img_E7b_"></p><p>그럼 이제 시놀로지는 외부 통신을 위한 Port인 UDP 161 port로 snmpd을 실행하게 된다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">root@DSM2:~# netstat -unlp | grep 161</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">udp        0      0 0.0.0.0:161             0.0.0.0:*                           9437/snmpd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">udp6       0      0 :::161                  :::*                                9437/snmpd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="snmp-exporter">SNMP Exporter<a class="hash-link" href="#snmp-exporter" title="Direct link to heading">​</a></h2><p><a href="https://github.com/prometheus/snmp_exporter" target="_blank" rel="noopener noreferrer">https://github.com/prometheus/snmp_exporter</a></p><p>SNMP Exporter는 프로메테우스가 수집할 수 있는 형식으로 SNMP 메트릭 데이터를 Expose 할때 사용하는 방법으로 전통적인 모니터링 도구와 마찬가지로 MIB를 사용하게 된다. 레포지토리 컨셉에도 설명이 적혀있듯이 SNMP 데이터는 계층형 데이터 구조를 가지고 있고 프로메테우스는 다차원 매트릭스를 사용하고 있기 때문에 두 시스템은 잘 맞는다고 볼 수 있다.</p><p>SNMP 데이터 구조를 여기서 자세히 설명하지는 않겠지만  SNMP index와 label을 매핑하는 방식으로 데이터를 처리한다. 다른 익스포터와 동일하게 daemon 형태로 실행이 되고 <code>http://localhost:9116/snmp?module=if_mib&amp;target=1.2.3.4</code> 와 같이 module과 target을 설정하는 방식으로 데이터 수집을 할 수 있다.</p><p>기본 config 파일을 <code>snmp.yml</code>을 참조하게 되는데 수동으로 작성하는 것이 아니라 generator를 통해 생성하게 된다.<br>
<a href="https://github.com/prometheus/snmp_exporter/tree/main/generator" target="_blank" rel="noopener noreferrer">https://github.com/prometheus/snmp_exporter/tree/main/generator</a></p><p>해당 링크에서 확인할 수 있듯이 generator에서 벤더별 MIB 파일과 generator.yml를 참조해서 빌드, 실행하고 결과값으로 snmp.yml이 생성되게 된다. 따로 만들어도 되지만 시놀로지에만 해당 파일을 바로 사용할 수 있도록 미리 만들어 두신 분이 계셔서 <a href="https://grafana.com/orgs/tumak" target="_blank" rel="noopener noreferrer">tumak</a>의 그라파나 대시보드를 참조하였다. 그리고 이후 시놀로지 대시보드로도 사용할 예정이다.  </p><p><a href="https://grafana.com/grafana/dashboards/14284" target="_blank" rel="noopener noreferrer">https://grafana.com/grafana/dashboards/14284</a></p><p>만들어진 <code>snmp.yml</code>에서 변경해야 할 부분은 현재 시놀로지에서 설정된 SNMP community 설정이다. snmp.yml 맨 아래 community 값을 시놀로지에 설정한 값과 일치하게 변경한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">community</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> synology</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prometheus-alertmanager-exporter-grafana-구성">Prometheus, Alertmanager, Exporter, Grafana 구성<a class="hash-link" href="#prometheus-alertmanager-exporter-grafana-구성" title="Direct link to heading">​</a></h2><p>간단한 아키텍처 구성도로 시놀로지 자체 또는 OS기반에서 발생하는 모니터링 데이터를 수집하는 각각의 Exporter를 구성하고 해당 데이터를 수집하는 Prometheus 서버와 관련 데이터를 시각화하는 Grafana까지 한번에 구성하기 위해 Docker-compose를 사용할 예정이다.  </p><p>Docker Compose 파일을 맨 아래 snmp exporter 부터 하나씩 쪼개서 살펴보자.  </p><p>SNMP Exporter는 위에서 만든 snmp.yml 파일을 마운트해서 실행되도록 한다. 그러면 SNMP exporter가 실행되면서 snmp파일을 참조해서 실행이 되고 prometheus.yaml에서 정의한 target과 SNMP 프로토콜을 통해 관련된 메트릭 값을 수집해서 Expose하게 될 것이다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">snmp-exporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prom/snmp</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> snmp_exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./snmp_exporter/</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/snmp_exporter/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9116</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9116</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./snmp</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">synology/snmp.yml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/snmp_exporter/snmp.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--config.file=/etc/snmp_exporter/snmp.yml"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다음은 Node Exporter를 실행하는 부분으로 시스템에 관련된 권한이 필요하므로 <code>/proc, /sys, /</code> 등 파일시스템의 read only 권한과 <code>privileged: true</code> 설정을 통해 실행되게 될 것이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">node-exporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privileged</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prom/node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"9100:9100"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /proc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/host/proc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /sys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/host/sys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/rootfs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--path.procfs=/host/proc"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--path.sysfs=/host/sys"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--collector.filesystem.ignored-mount-points"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"^/(rootfs/)?(dev|etc|host|proc|run|sys|volume1)($$|/)"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다음은 시각화와 알림을 담당할 Grafana와 Alertmanager 부분으로 Alertmanager의 경우 기본적인 config를 마운트해서 실행을 할 예정이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">grafana</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3000:3000"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">alertmanager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alertmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prom/alertmanager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.21.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9093</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9093</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./config/alertmanager.yml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/alertmanager/alertmanager.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>마지막으로, Prometheus는 알림룰을 생성하기 위해서 별도로 rules 디렉토리와 미리 생성해둔 config를 mount 시킨다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3.8"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/prometheus/prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v2.26.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./config/prometheus.yml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/prometheus/prometheus.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/etc/prometheus/rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 9090</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9090</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>prometheus.yml config를 살펴보면 수집주기는 1분으로, 나머지 얼럿매니저와 수집할 대상인 exporter들의 target endpoint를 추가하여 실행할 예정이다. 여기서는 시놀로지 SNMP 서비스와 통신하기 위해 SNMP Exporter의 target을 실제 사용중인 시놀로지 IP를 등록하도록 한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">evaluation_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">alerting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">alertmanagers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'alertmanager:9093'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rule_files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/etc/prometheus/rules/*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'prometheus'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'localhost:9090'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'prometheus'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'node-exporter:9100'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'snmp-exporter'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'192.168.0.100'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /snmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">synology</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">relabel_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__address__</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __param_target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source_labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__param_target</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">target_label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> __address__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">replacement</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.0.100</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9116</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The SNMP exporter's real synology hostname:port. </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="stack-실행">Stack 실행<a class="hash-link" href="#stack-실행" title="Direct link to heading">​</a></h2><p>모든 설정이 완료되면 일단 기본적인 실행이 가능한 상태로 시놀로지 CLI를 실행한다. 기본적으로 시놀로지는 admin계정으로 로그인해서 sudo 권한을 통해 Docker Compose 실행을 해야 한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ssh admin@192.168.31.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo -i</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a href="https://github.com/ddiiwoong/synology-prometheus.git" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/synology-prometheus.git</a>을 clone해서 /snmp-synology/snmp.yml 파일의 community 값을 본인의 synology 값으로 변경한 후 Docker Compose를 데몬형태로 실행한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up -d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>본인의 <code>http://&lt;시놀로지 IP&gt;:9090/targets</code> 으로 접속해서 3개의 target이 정상인지 확인한다. 그리고 표현식 브라우저로 돌아와서 <code>node_cpu_seconds_total</code> 과 <code>diskModel</code>을 통해 두개의 exporter에서 데이터가 수집되고 있는지 확인할 수 있다. <code>diskModel</code>은 시놀로지에 장착된 하드디스크 모델 정보를 보여주는 메트릭이다.  </p><p><img loading="lazy" alt="diskmodel" src="/assets/images/diskmodel-bf2516bf4a6315cc67bf93a4daf244c8.png" width="751" height="425" class="img_E7b_"></p><p>그라파나 대시보드는 <code>http://&lt;시놀로지 IP&gt;:3000</code> 로 접속해서 초기 계정인 <code>admin:admin</code>을 입력하면 다음과 같이 기본 화면을 볼수 있다. 여기서 좌측의 기어모양 메뉴(Configuration)의 <code>Data Sources</code>를 클릭하고 프로메테우스 데이터소스를 등록한다.  </p><p>Docker Compose로 실행할 때 아래와 같이 <code>prometheus</code> 이름으로 실행했기 때문에 HTTP URL에 <code>prometheus:9090</code>을 입력하고 <code>Save &amp; Test</code>로 데이터 소스를 저장한다.  </p><p><img loading="lazy" alt="grafana" src="/assets/images/grafana-0f11cac8c12e28ca7f02fe4835593ede.png" width="906" height="1144" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="시놀로지-대시보드-구성">시놀로지 대시보드 구성<a class="hash-link" href="#시놀로지-대시보드-구성" title="Direct link to heading">​</a></h2><p>마지막으로 <a href="https://grafana.com/grafana/dashboards/14284" target="_blank" rel="noopener noreferrer">https://grafana.com/grafana/dashboards/14284</a>의 대시보드를 추가하는 과정을 진행한다.  </p><p>좌측의 + 메뉴(Create)의 <code>Import</code>를 클릭하고 위 대시보드 ID <code>14284</code>를 입력하고 등록하면 아래와 같이 시놀로지의 모니터링 대시보드를 확인할 수 있다. </p><p><img loading="lazy" alt="synology" src="/assets/images/synology-0fb30768e59fa34c0bf2890f96e7b5aa.png" width="1286" height="1015" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>간단(?)하게 시놀로지 나스를 모니터링하는 방법에 대해서 정리해봤다. 누군가에게는 재미로 누군가에게는 도움이 되길 바라며, 포스팅과 관련된 모든것은 개인 취미로 작성된 내용으로 회사나 나스와 관련된 제품과 관계가 없음을 알린다.</p>]]></content>
        <category label="Prometheus, Synology, 시놀로지" term="Prometheus, Synology, 시놀로지"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[vSphere with Tanzu homelab running on ASUS PN50 (2/2)]]></title>
        <id>/2020/12/06/vSphere-with-Tanzu-homelab-2</id>
        <link href="https://ddii.dev/2020/12/06/vSphere-with-Tanzu-homelab-2"/>
        <updated>2020-12-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이번 포스트에서는 Tanzu Cluster를 단일 홈랩 vSphere 서버에 올려본다]]></summary>
        <content type="html"><![CDATA[<p>지난글에 이어 이번에는 네트워크 구성하는 방법과 vSphere Cluster에 추가적인 Kubernetes 클러스터를 배포하는 것에 대해 이야기 하고자 한다. 이번 글도 지난글과 동일하게 <a href="https://www.virtuallyghetto.com/" target="_blank" rel="noopener noreferrer">virtuallyGhetto</a> 블로그 포스팅을 참고하여 그대로 진행한 내용이라고 보면 된다.</p><p><a href="https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html" target="_blank" rel="noopener noreferrer">https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html</a></p><p>지난 포스팅은 다음 링크에서 확인할 수 있다.</p><blockquote><p>이전글 - <a href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab/" target="_blank" rel="noopener noreferrer">vSphere with Tanzu homelab running on ASUS PN50 (1/2)</a></p></blockquote><p><img loading="lazy" alt="vcsa" src="/assets/images/vcsa-21b40b1ba6ed8f23180bd647230b492b.png" width="1143" height="625" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vdsvsphere-distributed-switch-구성">VDS(vSphere Distributed Switch) 구성<a class="hash-link" href="#vdsvsphere-distributed-switch-구성" title="Direct link to heading">​</a></h2><p>이번 구성의 경우에는 usb nic를 하나만을 사용해서 진행하기 때문에 위에서 설정했던 3개의 네트워크(Management, Frontend, Workload)로 분리하기 위해 VDS를 신규로 생성하고 기존 네트워크 어댑터를 변경하는 작업을 수행해야 한다.  </p><p>먼저 신규 구성한 vCenter UI(<a href="https://vcsa.tanzu.local/ui" target="_blank" rel="noopener noreferrer">https://vcsa.tanzu.local/ui</a>)로 접속해 <code>Networking</code> 메뉴로 이동해서 <code>VDS</code> 메뉴 우클릭 후 <code>Add and Manage Hosts</code>를 선택한다. </p><p><img loading="lazy" alt="network" src="/assets/images/vcsa_network_menu-7d5081225e5a1d27d8ffc03e95c166cf.png" width="911" height="451" class="img_E7b_"></p><p>VDS 설정하는 6단계를 진행한다. </p><ul><li>1단계 -  <code>Add hosts</code>를 선택한다.</li><li>2단계 - ESXi host를 선택한다. </li><li>3단계 - pyhysical adapter를 생성한 후에 선택하게 되는데 구성한 랩에서는 USB TYPE NIC를 사용하여 <code>vusb0</code> 어댑터를 선택하고 <code>Assign uplink</code>에서 <code>dvUplink1</code>를 Assign한다.</li><li>4단계 - VMkernel adapter에서 vmk0을 선택하고 <code>Assign port group</code>에서 Network를 Management를 Assign한다.</li><li>5단계 - VM Migration은 생략한다.</li><li>6단계 - 설정되는 내용을 확인하고 Finish를 하게 되면 기존 VCSA의 기본 네트워크가 <code>vSwitch</code>에서 <code>VDS</code>로 변경되었기 때문에 VSCA Client 접속이 끊어지게 된다. </li></ul><p>다시 ESXi Client로 접속해서 VCSA Port Group(네트워크)을 아래와 같이 기존 <code>VM Network</code>에서 <code>Management</code>로 변경하면 다시 VSCA Client로 접속이 가능하게 된다.</p><p><img loading="lazy" alt="network_adapter" src="/assets/images/vcsa_network-8a0d605b125e949f2ff5adf466e9867c.png" width="720" height="502" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="routervm의-network-port-group-추가frontend-workload">RouterVM의 Network Port Group 추가(Frontend, Workload)<a class="hash-link" href="#routervm의-network-port-group-추가frontend-workload" title="Direct link to heading">​</a></h2><p>이전 포스팅에서 생성한 Router VM은 구성할 내부 네트워크(10.10.0.0/24 &amp; 10.20.0.0/24)로의 라우팅과 외부 네트워크로 NAT 및 포워딩을 위해서 필요하기 때문에 vSphere 또는 VCSA Client에서 <code>router.tanzu.local</code>의 네트워크 어댑터를 <code>Frontend</code>, <code>Workload</code>로 추가하는 작업이 필요하다.</p><p><img loading="lazy" alt="routervm" src="/assets/images/routervm-0ec21646dbb1c8a57fee486e93e78920.png" width="723" height="502" class="img_E7b_"></p><p>구성을 완료한 후에 간단한 네트워크 구성을 보면 다음과 같다.  </p><p><img loading="lazy" alt="vswitch" src="/assets/images/vswitch-cd0a014db46be6a31193bca2c2a153cd.png" width="789" height="604" class="img_E7b_"></p><p>물리 인터페이스 <code>vusb0</code> 아래 가상 스위치가 3개 구성되어 있고 외부에서도 RouterVM을 통해 접속이 가능하도록 접속하는 로컬 머신에서 라우팅 경로 추가가 필요하다.</p><ul><li><p>Windows<br>
<code>route print</code> 명령으로 인터페이스 ID를 먼저 확인하고 아래와 같이 설정한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">route ADD 10.10.0.0 MASK 255.255.255.0 192.168.0.201 METRIC 3 IF 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">route ADD 10.20.0.0 MASK 255.255.255.0 192.168.0.201 METRIC 3 IF 5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>MacOS</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sudo route -n add -net 10.10.0.0/24 192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo route -n add -net 10.20.0.0/24 192.168.0.201</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>WSL</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sudo route -n add -net 10.10.0.0/24 gw &lt;Gateway IP&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo route -n add -net 10.20.0.0/24 gw &lt;Gateway IP&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="haproxyvm-설정">HAProxyVM 설정<a class="hash-link" href="#haproxyvm-설정" title="Direct link to heading">​</a></h2><p>이전 포스팅에서 생성한 HAProxy도 추가된 네트워크 환경으로 설정을 하기 위해 다음 스크립트를 사용한다.   </p><ul><li><a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/deploy_3nic_haproxy.ps1" target="_blank" rel="noopener noreferrer">https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/deploy_3nic_haproxy.ps1</a></li></ul><p>구성한 환경에 맞게 스크립트내 변수들을 수정한 후 실행한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyOVA = "C:\esxi\vmware-haproxy-v0.1.8.ova"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Cluster = "Tanzu-Cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VMHost = "esxi-01.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Datastore = "datastore1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyDisplayName = "haproxy.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyHostname = "haproxy.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyDNS = "192.168.0.201"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyManagementNetwork = "Management"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyManagementIPAddress = "192.168.0.203/24" # Format is IP Address/CIDR Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyManagementGateway = "192.168.0.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyFrontendNetwork = "Frontend"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyFrontendIPAddress = "10.10.0.2/24" # Format is IP Address/CIDR Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyFrontendGateway = "10.10.0.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyWorkloadNetwork = "Workload"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyWorkloadIPAddress = "10.20.0.2/24" # Format is IP Address/CIDR Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyWorkloadGateway = "10.20.0.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyLoadBalanceIPRange = "10.10.0.64/26" # Format is Network CIDR Notation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyOSPassword = "VMware1!"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyPort = "5556"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyUsername = "wcp"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$HAProxyPassword = "VMware1!"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./deploy_3nic_haproxy.ps1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 HAProxy VM내에서 여러 인터페이스에서 <code>Reverse Path Filtering</code>을 <code>Disable</code>하기 위해 다음 스크립트를 실행한다. </p><p>*<a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_haproxy.sh" target="_blank" rel="noopener noreferrer">setup_haproxy.sh</a>  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">touch /etc/sysctl.d/999-tanzu.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x /etc/sysctl.d/999-tanzu.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IFS=$'\n'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for i in $(sysctl -a | grep rp_filter | grep 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SYSCTL_SETTING=$(echo ${i} | awk '{print $1}')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Update live system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sysctl -w ${SYSCTL_SETTING}=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Persist settings upon reboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo "${SYSCTL_SETTING}=0" &gt;&gt; /etc/sysctl.d/999-tanzu.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p><code>Reverse Path Filtering</code>는 기본적으로 하나의 인스턴스에서 여러개의 인터페이스로 들어오는 패킷의 소스IP에 대해서 라우팅 테이블을 확인한 후 패킷이 들어온 동일한 인터페이스로 다시 나가는지 확인하는 것을 말한다. <code>rp_filter</code>가 1로 설정이 되어있으면, 특정 인터페이스로 들어온 패킷 정보와 OS의 FIB(Forward Information Base)에 정의된 정보와 일치하지 않을경우, 들어온 패킷을 버리는 기능을 하기 때문에 위 스크립트를 통해 rp_filter 값을 모두 0으로 변경하는 것이다. 자세한 내용은 <a href="https://access.redhat.com/solutions/53031" target="_blank" rel="noopener noreferrer">https://access.redhat.com/solutions/53031</a>를 참고하자.</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="content-library-구성">Content Library 구성<a class="hash-link" href="#content-library-구성" title="Direct link to heading">​</a></h2><p><code>Content Library</code>는 레포지토리의 개념으로 여러 vApp 템플릿과 ISO 이미지 등과 같은 파일들과 컨테이너 개체를 저장하고 관리할 수 있는 도구이다. 레지스트리(Registry)와 유사하지만 <code>Content Library</code>에는 VM templates, OVA, OVF 파일 등이 저장된다.  </p><p><code>Menu</code> -&gt; <code>Content Libraries</code>로 이동해서 새로운 라이브러리를 추가를 한다. 이름과 vCenter Server를 선택하고 2번째 단계에서 Subscribed content library를 선택하고 <code>Subscription URL</code>에 <a href="https://wp-content.vmware.com/v2/latest/lib.json" target="_blank" rel="noopener noreferrer">https://wp-content.vmware.com/v2/latest/lib.json</a> 를 입력하고 3번째 단계에서 저장될 데이터스토어를 선택하면 된다.  </p><p>실제 위 URL은 <code>OVF Template</code> 여러개를 다운받는데 Tanzu Cluster내에서 Master와 Worker Node들로 쓰일 Kubernetes 1.16 ~ 1.18까지 여러개의 VM이미지 (photon OS)들이 추가가 되는것을 알 수 있다. 아래 그림을 보면 현재 Tanzu에서 사용되는 Kubernetes 클러스터 버전이 1.18.5라는 것을 알 수 있다.</p><p><img loading="lazy" alt="tkg" src="/assets/images/content_tkg-375173ad9665d2e90a26db7433cc49d4.png" width="1259" height="692" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="workload-management-구성">Workload Management 구성<a class="hash-link" href="#workload-management-구성" title="Direct link to heading">​</a></h2><p>Workload Management란 쉽게 생각하면 vSphere 기반에서 Kubernetes 클러스트를 프로비저닝하는 역할을 하는 도구라 보면 된다.  </p><p>Workload Management는 다음과 같은 역할을 한다.  </p><ul><li>Kubernetes 클러스터의 컴퓨팅, 스토리지 리소스에 대한 사이징 및 네임스페이스 관리</li><li>Kubernetes 클러스터의 네트워크 및 DNS, NTP 및 VDS같은 네트워크 관리</li><li>Kubernetes 클러스터 상세 정보 (Node 개수 및 상태 정보)</li></ul><p>Workload Management에서 클러스터 생성을 스크립트로 진행하기 전에 PowerCLI를 통해 접속 테스트를 한다. </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Connect-VIServer -Server vcsa.tanzu.local -User administrator@vsphere.local -Password VMware1!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect-CisServer -Server vcsa.tanzu.local -User administrator@vsphere.local -Password VMware1!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 PowerCLI Workload Management 모듈을 설치하고 여러 환경변수들을 설정한다. 기존에 사용한 정보들과 위에서 만든 Content Library 이름으로 변경하고 실행한다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Import-Module VMware.WorkloadManagement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vSphereWithTanzuParams = @{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClusterName = "Tanzu-Cluster";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TanzuvCenterServer = "vcsa.tanzu.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TanzuvCenterServerUsername = "administrator@vsphere.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TanzuvCenterServerPassword = "VMware1!";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TanzuContentLibrary = "TKG"; # Content Library 이름</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ControlPlaneSize = "TINY";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetwork = "Management";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkStartIP = "192.168.0.220";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkSubnet = "255.255.255.0";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkGateway = "192.168.0.1";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkDNS = @("192.168.0.201");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkDNSDomain = "tanzu.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MgmtNetworkNTP = @("162.159.200.123");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetwork = "Workload";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkStartIP = "10.20.0.10";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkIPCount = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkSubnet = "255.255.255.0";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkGateway = "10.20.0.1";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkDNS = @("192.168.0.201");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkloadNetworkServiceCIDR = "10.96.0.0/24";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StoragePolicyName = "Tanzu-Storage-Policy";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyVMvCenterServer = "vcsa.tanzu.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyVMvCenterUsername = "administrator@vsphere.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyVMvCenterPassword = "VMware1!";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyVMName = "haproxy.tanzu.local";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyIPAddress = "192.168.0.203";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyRootPassword = "VMware1!";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HAProxyPassword = "VMware1!";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LoadBalancerStartIP = "10.10.0.64";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LoadBalancerIPCount = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-WorkloadManagement2 @vSphereWithTanzuParams</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>클러스터를 생성하는 시간은 약 40분 이상 소요되는데 Tanzu-Cluster의 Control Plane Node (Master Node) 생성이 완료되면 IP가 10.10.0.64(HAProxy Load Balancer에서 할당된 첫번째 주소)로 할당이 되는 것을 확인할 수 있다.  </p><p>다음은 Namespace를 생성하는 과정을 진행한다. <code>Workload Management</code>에서 <code>NEW NAMESPACE</code>메뉴를 클릭하고 위에서 생성한 <code>Tanzu-Cluster</code>를 선택하고 이름(test)을 입력하고 Namespace를 생성한다. </p><p><img loading="lazy" alt="tkg_permission" src="/assets/images/tkg_permission-9ef770e7197c1de2636adb2d065b4f58.png" width="568" height="367" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cluster-접속--kubernetes-cli">Cluster 접속  (Kubernetes CLI)<a class="hash-link" href="#cluster-접속--kubernetes-cli" title="Direct link to heading">​</a></h2><p>생성된걸 확인한 후 브라우저에 해당 클러스터의 Control Plane IP (<a href="https://10.10.0.64)%EB%A1%9C" target="_blank" rel="noopener noreferrer">https://10.10.0.64)로</a> 접속하면 OS별(Linux, MacOS, Windows)로 CLI 플러그인을 설치할 수 있다.  </p><p>설치 및 PATH 설정을 진행하고 아래와 같이 Control Plane으로 CLI 로그인을 하면 현재 설정된 Context 확인이 가능하다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl vsphere login --server=10.10.0.64 -u administrator@vsphere.local --insecure-skip-tls-verify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        🥳vSphere with Tanzu Basic Cluster enabled by William Lam's Script 🥳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Logged in successfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You have access to the following contexts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   10.10.0.64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   docker-desktop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   nexclipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If the context you wish to use is not in this list, you may need to try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging in again later, or contact your cluster administrator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To change context, use `kubectl config use-context &lt;workload name&gt;`</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl config use-context nexclipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Switched to context "nexclipper".</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">422f46864113e3de3361943d14073728   Ready    master   4d21h   v1.18.2-6+38ac483e736488</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">422faddc15554b09d82907c0dfb57752   Ready    master   4d21h   v1.18.2-6+38ac483e736488</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>nexclipper namespace로 context를 전환하고 node를 확인하면 master node를 2개 확인할 수 있는데 이는 <code>nexclipper</code>라는 네임스페이스를 총괄하는 Super Master(Control Plane) 같은 개념이라고 볼 수 있다. 처음에 클러스터 배포전에 Namespace 리소스를 만들길래 다소 헷갈리긴 했지만 Tanzu에서의 Namespace는 기존 쿠버네티스의 리소스를 논리적으로 나누는 컨셉이 아닌, 정해진 리소스와 유저와 그룹의 권한을 먼저 Namespace로 할당하고 그담에 다시 조직이나 어플리케이션 별로 Kubernetes Workload를 다시 제공하는 컨셉이라고 보면된다.  </p><p>최근에 <code>SKT</code>나 <code>Kakao Enterprise</code> 처럼 쿠버네티스 클러스터의 라이프사이클을 쿠버네티스로 관리하는 컨셉으로 이해하면 좋다. 아래 그림을 참고하면 쉽게 이해할 수 있을 것이다.  </p><p><img loading="lazy" src="https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/img/GUID-DF8905E1-C098-4882-BFC1-B0BAC668B424-high.png" alt="tanzu" class="img_E7b_"><br>
<!-- -->참조 : <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/img/GUID-DF8905E1-C098-4882-BFC1-B0BAC668B424-high.png" target="_blank" rel="noopener noreferrer">https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/img/GUID-DF8905E1-C098-4882-BFC1-B0BAC668B424-high.png</a></p><p>TanzuKubernetesCluster CRD를 통해 클러스터를 신규로 생성한다.<br>
<code>namespace: nexclipper</code>로 설정하고 원하는 배포 버전과 이름, CNI, Control Plane, Worker Node 개수 등을 기재하게 되는데 특이한 것은 CNI는 <a href="https://github.com/vmware-tanzu/antrea" target="_blank" rel="noopener noreferrer">Antrea</a>를 사용하는것을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> run.tanzu.vmware.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TanzuKubernetesCluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nexclipper</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nexclipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">distribution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1.17.8+vmware.1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tkg.1.5417466</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">settings</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">network</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cni</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> antrea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">pods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 193.0.2.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> managedcluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cidrBlocks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 195.51.100.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">topology</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">controlPlane</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">class</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> best</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">effort</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xsmall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">storageClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tanzu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">class</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> best</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">effort</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xsmall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">storageClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tanzu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>신규 TKG 클러스터를 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f tkc.yaml  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tanzukubernetescluster.run.tanzu.vmware.com/nexclipper-cluster created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포하고 tanzukubernetescluster 를 조회해보면 Control Plane 1개, Worker Node 1개의  v1.17.8 버전의 클러스터가 배포된것을 알 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get tanzukubernetescluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 CONTROL PLANE   WORKER   DISTRIBUTION                     AGE   PHASE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexclipper-cluster   1               1        v1.17.8+vmware.1-tkg.1.5417466   33m   running</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성한 tanzukubernetescluster로 접속하여 클러스터 정보를 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl-vsphere login --server=10.10.0.64 -u administrator@vsphere.local --insecure-skip-tls-verify --tanzu-kubernetes-cluster-name nexclipper-cluster --tanzu-kubernetes-cluster-namespace nexclipper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl config use-context nexclipper-cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Switched to context "nexclipper-cluster".</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                STATUS   ROLES    AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexclipper-cluster-control-plane-95nhv              Ready    master   3h10m   v1.17.8+vmware.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nexclipper-cluster-workers-kp68q-78df45db5c-jzmmv   Ready    &lt;none&gt;   3h6m    v1.17.8+vmware.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성한 클러스터에 간단한 앱을 배포한다.<br>
<a href="https://github.com/storax/kubedoom" target="_blank" rel="noopener noreferrer">Kubedoom</a>은 Doom 게임내에서 애플리케이션(괴물)을 일부러 종료시켜 복원성을 보게하는 재미있는 앱이다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; git clone https://github.com/storax/kubedoom.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; cd kubedoom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f manifest/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl -n kubedoom port-forward deployment/kubedoom 5900:5900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from 127.0.0.1:5900 -&gt; 5900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from [::1]:5900 -&gt; 5900</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포한후에 포트포워딩을 한 앱으로 VNC viewer로 접속하면 재미있는 화면을 볼 수 있을 것이다. VNC 패스워드는 <code>idbehold</code>이다.</p><p><img loading="lazy" alt="doom" src="/assets/images/doom-05a849f186a914571aa3c73ce8d9070c.png" width="642" height="512" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tanzu-장단점-개인의견">Tanzu 장단점 (개인의견)<a class="hash-link" href="#tanzu-장단점-개인의견" title="Direct link to heading">​</a></h2><p>하드웨서 고민, 구매, ESXi 설치, vCenter, TKG을 설치하고 아키텍처들을 찾아보면서 몇가지 장단점이 눈에 보였는데 가장 큰 장점은 하나의 네임스페이스를 만들어 Super Master(Control Plane)를 먼저 구성하고 자원(컴퓨팅, 네트워크, 스토리지 등)과 기존에 보유하고 있는 권한 체계로 할당을 한 뒤 필요할때 마다 특정 팀이나 조직에게 별도의 클러스터를 할당하는 아키텍처를 추구하고 있어 VMware 환경에서 Kubernetes를 신규 도입하고 엔터프라이즈에 적용하기 용이하다는 점이다.  </p><p>또한 기본적으로 갖춰야 하는 Security Policy나 리소스 할당이 클러스터 구축이후에 되는 것이 아니라 이미 정의된 규칙으로 클러스터 구성이 이후에 진행되기 때문에 관리적인 측면에서도 장점이 있다고 볼 수 있다. </p><p>하지만 개인적으로 생각하는 단점들도 몇가지 있는데 첫번째는 용어의 중복으로 인한 혼동이 있었다는점이다. 네임스페이스나 기존 쿠버네티스에서 많이 사용되는 용어보다는 VMware에서 만든 CRD등을 미리 학습하거나 알고 있지 않으면 기존 경험이 있는 유저도 접근성이 떨어질 것 같다는 생각이 들었다. </p><p>비용 측면에서는 일단 <code>vCenter</code> 이외에 <code>Workload Management</code> 라이센스가 별도로 필요하기 때문에 자세히 알아보진 않았지만 적지 않은 비용이 들 것으로 예상된다. 게다가 많은 구성요소로 인한 자원이 소요가 있어 하나의 작은 클러스터만 띄웠음에도 64GB 머신의 메모리 사용량이 거의 60GB에 육박했기 때문에 기존 인프라 비용에 추가적인 비용에 대한 고려가 반드시 필요할 것 같다. </p><p>위에도 언급했지만 러닝커브에 대한 부분도 문제점이 될 수 있을것이다. NSX기반의 새로운 CNI뿐만 아니라 기존 VMware 운영을 하던 DevOps팀이나 인프라 운영조직의 러닝커브, 추상화 레벨이 높아져서 내가 원하는 클러스터의 이벤트나 로그를 확인할 때 탐색적으로 메뉴를 찾기가 쉽지 않은 부분들이 있었다. 그래서 트러블슈팅 때에도 로그의 원천을 찾는데 시간이 다소 걸리기도 했다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>한 일주일동안 스토리지 오류로 씨름하다가 겨우 앱을 배포했지만 거의 2주동안 재미있게 구성해볼수 있었다. 솔직히 이야기하자면 개인 클러스터로 구성하는데는 추천하지 않지만 Tanzu를 공부하고 운영해야 하는 경우나 자격증을 취득하는 부분이 필요하다면 한번쯤은 해볼 가치가 있다고 생각한다.  </p><p>거의 1년만에 포스팅을 작성했는데 다음 포스팅에는 Security Policy 관련한 테스트를 진행하면서 연말을 정리해볼 생각이다.</p>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Tanzu" term="Tanzu"/>
        <category label="vSphere" term="vSphere"/>
        <category label="Homelab" term="Homelab"/>
        <category label="ASUS" term="ASUS"/>
        <category label="PN50" term="PN50"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[vSphere with Tanzu homelab running on ASUS PN50 (1/2)]]></title>
        <id>/2020/11/30/vSphere-with-Tanzu-homelab</id>
        <link href="https://ddii.dev/2020/11/30/vSphere-with-Tanzu-homelab"/>
        <updated>2020-11-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이번 포스트에서는 Tanzu Cluster를 단일 홈랩 vSphere 서버에 올려본다]]></summary>
        <content type="html"><![CDATA[<p>스타트업으로 이직후 정신없는 6개월을 보냈고 집에서 하는 사이드 프로젝트나 공부하는 것들이 소홀해지는것 같아 마음을 다잡고자 작성하는 포스팅이다. 최근 몇개월 간은 회사 블로그 글만 작성하다보니 개인 블로그를 거의 못하고 있어서 회사 제품과는 아직까지 거리가 있는 플랫폼 공부차 작성한다. 순수하게 정보공유차 작성하는 것이며, 특정회사의 회사의 제품이나 플랫폼을 홍보하고자 함은 아니다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tanzu">Tanzu<a class="hash-link" href="#tanzu" title="Direct link to heading">​</a></h2><p><a href="https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio" target="_blank" rel="noopener noreferrer">https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio</a>  </p><p>Tanzu는 애플리케이션을 개발, 구동, 운영하는 모든 컨테이너 환경을 통합 관리하는 쿠버네티스를 상용화 한 제품으로 이해하는 것이 가장 쉽다. </p><p><img loading="lazy" alt="tanzu" src="/assets/images/tanzu-31ee2ad3f4e378ea6b48dd7368fad618.png" width="550" height="272" class="img_E7b_"><br>
<!-- -->(출처 : VM웨어 코리아 발표자료 갈무리)</p><p>포트폴리오를 간단히 살펴보면 기존 인프라를 구성하는 레이어인 vSphere 위에 <code>VMware Tanzu Kubernetes Grid</code>를 볼 수 있다.  </p><p>오늘은 기존 Pivotal 이나 Spring Boot를 제외한 플랫폼 레이어의 TKG(Tanzu Kubernetes Grid)를 홈랩으로 구성하는 과정을 정리했다. </p><p>모든 과정은 virtuallyGhetto 블로그를 참고하여 작성했고 가장 따라한 부분은 아래 포스팅이니 NUC으로 구성하려면 원문을 참고하면 된다.<br>
<a href="https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments" target="_blank" rel="noopener noreferrer">https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="준비사항hardware">준비사항(Hardware)<a class="hash-link" href="#준비사항hardware" title="Direct link to heading">​</a></h2><ul><li><p>ASUS PN50<br>
<a href="https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/" target="_blank" rel="noopener noreferrer">https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/</a></p><p>PN50 베어본을 선택한 이유는 일단 AMD Ryzen 4800u CPU가 저전력인데도 불구하고 8코어 16스레드, 64GB sodimm이 지원되며, 2.5인치와 M.2 SSD가 동시 장착이 가능하다는 점이다. 온보드 NIC 드라이버가 vSphere 7.0에서 지원되지 않지만 USB Network Adapter를 통해 구성이 가능했기 때문에 망설임 없이 구매를 결정했다. 구입은 네이버 검색(asus pn50 4800u)을 통해 71만원 정도에 구매를 했다. 이도 스마일 캐시를 직접 구매해서 실제 구매금액은 65만원 정도가 소요되었다.</p></li><li><p>SODIMM DDR4 32G PC4-25600 (TeamGroup)<br>
<!-- -->해당 제품은 가성비로 가장 저렴하게 살 수 있는 국내 워런티가 가능한 SODIMM 메모리로 32G 2개를 구매했으며 네이버 검색으로 2개 25만원 정도로 구매했다.</p></li><li><p>2.5 SSD (ADATA SU655 240GB)<br>
<!-- -->ESXi 서버 설치용으로 사용하기 위해 기존에 갖고 있던 ADATA SU655 240GB를 사용했고 현재 3.5만원 정도에 구매가능하다. </p></li><li><p>M.2 SSD (WD BLACK SN750 M.2 NVMe 500GB)<br>
<!-- -->아마존에서 직구한 녀석으로 69.99달러 소요되었다. 배대지 가격을 합치면 8.5만원 정도 소요되었다. </p></li><li><p>Gigabit USB Lancard (tplink UE300C)<br>
<!-- -->ESXi 7.0버전에서 온보드 NIC 인식이 불가능한 이유로 별도로 기기비트 유선 랜카드를 구매했다. 1.5만원 정도에 구매가능 하고 3년 보증이 되는 TPLINK제품으로 선택하였다.<br>
<a href="https://coupa.ng/bM0lN8" target="_blank" rel="noopener noreferrer">https://coupa.ng/bM0lN8</a> -&gt; <code>해당 링크를 통해 구매하면 저에게 쿠팡 파트너스를 통해 적립금이 지급되니 필요하신 분은 아래를 통해 구매를 부탁드립니다</code></p></li></ul><p>실제 위 스펙으로 대충 구매를 진행하게 되면 <code>104만원</code> 정도 소요가 될것으로 예상된다. 환율이나 할인을 전혀 받지 않고 1개의 SSD로 구성한다고 가정해도 약 8코어 16스레드 64GB 머신을 <code>110만원</code> 정도로 구성이 가능하다. 물론 서버나 워크스테이션이나 Intel NUC기반으로도 구성이 가능하지만 전력소모와 집안을 차지하는 부피를 고려하면 금액적으로 메리트가 있다고 생각한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="준비사항software">준비사항(Software)<a class="hash-link" href="#준비사항software" title="Direct link to heading">​</a></h2><ul><li><p>Windows PC (with Powershell, WSL) or MAC
Window를 사용을 하지 않고 MAC이나 리눅스로 구성하려 했으나 온보드 NIC 인식을 위한 드라이버 통합 커스텀 이미지 작성 편의를 위해 Window 환경을 사용하였다.</p></li><li><p><a href="https://www.ventoy.net/en/index.html" target="_blank" rel="noopener noreferrer">ventoy</a><br>
<!-- -->ESXi 부팅 이미지 제작을 위한 툴이며 <a href="https://rufus.ie/" target="_blank" rel="noopener noreferrer">rufus</a>에 비해 활용도가 높다.</p></li><li><p><a href="https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0" target="_blank" rel="noopener noreferrer">vSphere 7.0 Update 1</a><br>
<!-- -->평가판은 <a href="https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7</a> 에서 다운로드가 가능하다.</p></li><li><p><a href="https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0" target="_blank" rel="noopener noreferrer">PowerShell 7.10</a><br>
<!-- -->기본적으로 Window에는 6.x 버전의 PowerShell이 설치되어 있기 때문에 7.1.0 버전을 신규로 설치해야 한다.</p></li><li><p><a href="https://www.powershellgallery.com/packages?q=VMware.PowerCLI" target="_blank" rel="noopener noreferrer">PowerCLI</a><br>
<a href="https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493" target="_blank" rel="noopener noreferrer">https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493</a>
커스텀 ESXi 7.0 이미지 제작을 위해 필요하다.</p></li><li><p><a href="https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip" target="_blank" rel="noopener noreferrer">USB Network Native Driver for ESXi</a><br>
<!-- -->PN50 USB NIC(RTL8153) 인식을 위한 네이티브 드라이버.</p></li><li><p><a href="https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&amp;productId=974" target="_blank" rel="noopener noreferrer">OVFTool</a><br>
<!-- -->OVA를 배포하기 위한 도구로 Linux 64 bundle로 WSL에 설치한다. </p></li><li><p><a href="https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">vcsa-deploy</a><br>
<!-- -->vCenter를 배포하는 도구로 이미지내에 포함되어 있기 때문에 vCenter Server Appliance ISO를 다운받아 압축을 풀면 확인할 수 있다. </p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="최종-예상-구성요소">최종 예상 구성요소<a class="hash-link" href="#최종-예상-구성요소" title="Direct link to heading">​</a></h2><ul><li>vCenter Server Appliance</li><li>VMFS Storage</li><li>vSphere with Tanzu Cluster</li><li>HAProxy</li><li>Router (Forwarding, DNS)</li><li>Supervisor Control Plane VMs (Master 2ea, Worker 3ea)</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-설치">ESXi 설치<a class="hash-link" href="#esxi-설치" title="Direct link to heading">​</a></h2><p>초반에도 이야기 했듯이 ESXi 7.0이상에서는 ASUS PN50의 온보드 인터페이스를 사용하지 못한다. 그래서 별도로 구매한 USB 인터페이스의 RTL8153 칩셋을 이미지에 통합시키는 작업이 필요하다.  </p><p>드라이버 이미지 통합을 위한 내용은 아래 포스팅을 참고했다.  </p><ul><li><a href="https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/" target="_blank" rel="noopener noreferrer">https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/</a></li><li><a href="https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/" target="_blank" rel="noopener noreferrer">https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-다운로드">ESXi 다운로드<a class="hash-link" href="#esxi-다운로드" title="Direct link to heading">​</a></h3><p>다음 링크에서 <code>VMware vSphere 7.0 Update 1</code> 를 다운로드 한다.  </p><ul><li><a href="https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0</a></li></ul><p>기본적으로 VMware 회원가입이 필요하며 라이센스가 없는 경우 60일 trial로 가능하다.  </p><ul><li><a href="https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="usb-network-native-driver-for-esxi">USB Network Native Driver for ESXi<a class="hash-link" href="#usb-network-native-driver-for-esxi" title="Direct link to heading">​</a></h3><p>USB NIC Fling 드라이버를 준비한다. </p><ul><li><a href="https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip" target="_blank" rel="noopener noreferrer">https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip
</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="powershell-710-설치">PowerShell 7.1.0 설치<a class="hash-link" href="#powershell-710-설치" title="Direct link to heading">​</a></h3><p>기본적으로 Window에는 6.x 버전의 PowerShell이 설치되어 있기 때문에 특정 스크립트를 구동하기 위해서는 7.1.0 버전을 신규로 설치해야 한다.  </p><ul><li><a href="https://github.com/PowerShell/PowerShell" target="_blank" rel="noopener noreferrer">https://github.com/PowerShell/PowerShell</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="powercli-준비">PowerCLI 준비<a class="hash-link" href="#powercli-준비" title="Direct link to heading">​</a></h3><p>PowerCLI 다운로드 및 설치</p><ul><li><a href="https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493" target="_blank" rel="noopener noreferrer">https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493</a></li></ul><p>관리자 권한으로 PowerShell을 실행하고 PowerCLI 모듈 설치전에 실행 권한을 수정한다.  </p><ul><li>참고 : <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1</a></li></ul><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>PowerCLI를 설치한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Install-Module -Name VMware.PowerCLI -Scope CurrentUser</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="image-profile-확인">Image Profile 확인<a class="hash-link" href="#image-profile-확인" title="Direct link to heading">​</a></h3><p>포스팅을 하는 20년 11월 29일 최신 ESXi 이미지는 <code>ESXi-7.0U1b-17168206-standard</code>로 vSphere ESXi 7.0 이미지 프로필은 아래에서 확인이 가능하다.  </p><ul><li><a href="https://www.virten.net/vmware/vmware-esxi-image-profiles/" target="_blank" rel="noopener noreferrer">https://www.virten.net/vmware/vmware-esxi-image-profiles/</a></li></ul><p>stable 릴리스로 구성하기 위해 이전 릴리스인 <code>ESXi-7.0.1-16850804-standard</code> 이미지 프로필로 설치를 진행한다.  </p><p>설치 프로세스를 살펴보면 <code>Add-EsxSoftwareDepot</code>로 repo설정을 하고 <code>Export-ESXImageProfile</code>를 통해 원하는 이미지 프로필의 bundle을 다운로드 받는다. 위에서 다운로드 받은 드라이버를 <code>Add-EsxSoftwarePackage</code>로 패키지를 추가하고 새로운 ISO이미지를 생성하는 과정을 알 수 있다.  </p><p>이미지 프로필 변경을 통해 원하는 이미지 버전으로 구성이 가능하다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile "ESXi-7.0.1-16850804-standard" -ExportToBundle -filepath  ESXi-7.0.1-16850804-standard.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remove-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot .\ESXi-7.0.0-15843807-standard.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot .\ESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-EsxImageProfile -CloneProfile "ESXi-7.0.1-16850804-standard" -name "ESXi-7.0.1-16850804-USBNIC" -Vendor "virten.net"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwarePackage -ImageProfile "ESXi-7.0.1-16850804-USBNIC" -SoftwarePackage "vmkusb-nic-fling"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile "ESXi-7.0.1-16850804-USBNIC" -ExportToIso -filepath ESXi-7.0.1-16850804-USBNIC.iso</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile "ESXi-7.0.1-16850804-USBNIC" -ExportToBundle -filepath ESXi-7.0.1-16850804-USBNIC.zip</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-설치-이미지-제작">ESXi 설치 이미지 제작<a class="hash-link" href="#esxi-설치-이미지-제작" title="Direct link to heading">​</a></h3><p>ESXi 부팅 이미지 제작은 <a href="https://rufus.ie/" target="_blank" rel="noopener noreferrer">rufus</a>, <a href="https://www.ventoy.net/en/index.html" target="_blank" rel="noopener noreferrer">ventoy</a> 둘 중 편한 도구로 선택하면 되는데 ventoy가 조금 더 활용도가 높다고 판단하여 진행했고, OS설치 USB 생성은 생략한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="부팅-및-설치">부팅 및 설치<a class="hash-link" href="#부팅-및-설치" title="Direct link to heading">​</a></h3><p>일반적인 바이오스 설정과 동일하게 Boot 우선순위를 USB로 설정하고 다음과 같은 ventoy화면에서 앞서 생성한 <code>ESXi-7.0.1-16850804-USBNIC.iso</code> 이미지로 ESXi 설치를 진행한다.</p><p><img loading="lazy" src="https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png" alt="ventoy" class="img_E7b_">
<a href="https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png" target="_blank" rel="noopener noreferrer">https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png</a>  </p><p>이후 친숙한 DCUI(Direct Console User Interface)로 접속하여 F2모드로 접속하여 Static IP 설정과 network 테스트를 진행한다.  </p><p><img loading="lazy" alt="esxi" src="/assets/images/esxi7-5ef7454cef904dde1696b3ce9d0028a2.png" width="640" height="480" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vsphere-web-client-접속">vSphere Web Client 접속<a class="hash-link" href="#vsphere-web-client-접속" title="Direct link to heading">​</a></h3><p>설정한 Static IP로 접속하여 환경을 점검한다.  </p><p><img loading="lazy" alt="nw" src="/assets/images/esxi_network-290297edf5689dc50b1a67459aed6a37.png" width="1138" height="687" class="img_E7b_"></p><p>Management Network에 vSwitch0이 구성된 것을 확인할 수 있다.  </p><p>그리고 설치한 M.2 SSD로 datastore2를 추가하여 vCenter 설치를 진행하도록 한다.</p><p><img loading="lazy" alt="storage" src="/assets/images/esxi_storage-564ca3d7a6401db1e1aef917ab9048b3.png" width="1143" height="458" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-설치-및-환경-구성">Router 설치 및 환경 구성<a class="hash-link" href="#router-설치-및-환경-구성" title="Direct link to heading">​</a></h2><p>Router VM은 DNS 서버의 역할뿐 아니라 앞으로 구성될 내부 네트워크(10.10.0.0/24 &amp; 10.20.0.0/24)와 외부 네트워크의 포워딩과 NAT 역할을 수행한다.  </p><p>Photon OS 3.0 OVA로 배포되며 <a href="https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&amp;productId=974" target="_blank" rel="noopener noreferrer">OVFTool</a>를 사용하여 배포를 진행하는데 이미 작성된 배포 스크립트를 활용한다. </p><ul><li><a href="https://packages.vmware.com/photon/3.0/Rev3/ova/photon-hw13_uefi-3.0-a383732.ova" target="_blank" rel="noopener noreferrer">Photon OS 3.0 OVA</a></li><li><a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git" target="_blank" rel="noopener noreferrer">https://github.com/lamw/vsphere-with-tanzu-homelab-scripts</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-설치">Router 설치<a class="hash-link" href="#router-설치" title="Direct link to heading">​</a></h3><p>스크립트 실행은 동일한 PowerShell이 동작하는 Window WSL2 환경에서 수행했기 때문에 Window <code>hosts</code> 파일과 WSL환경의 <code>/etc/hosts</code> 파일에 아래와 같이 사용하고자 하는 IP주소를 미리 등록해놓는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.10    esxi-01.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.201   router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.202   vcsa.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.203   haproxy.tanzu.local</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git" target="_blank" rel="noopener noreferrer">스크립트 레포</a>의 <code>deploy_photon_router_ova.sh</code>를 자신의 환경에 맞게 수정한다. WSL내에서 Window 시스템내에 다운로드한 OVA파일 경로는 WSL내에서 실행될 것이기에 <code>/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova</code>로 변경하였다. Router와 ESXi hostname, password등을 확인하고 Network과 Datastore는 위에서 확인한 내용으로 수정한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># William Lam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># www.virtuallyghetto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonOVA="/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterVMName="router.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiHostname="esxi-01.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiUsername="root"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiPassword='VMware1!'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterNetwork="VM Network"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterDatastore="datastore1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### DO NOT EDIT BEYOND HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ovftool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name=${PhotonRouterVMName} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--X:waitForIpv4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--powerOn \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--acceptAllEulas \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--noSSLVerify \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--datastore=${PhotonRouterDatastore} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--net:"None=${PhotonRouterNetwork}" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${PhotonOVA} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"vi://${ESXiUsername}:${ESXiPassword}@${ESXiHostname}"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>스크립드를 실행하면 OVA파일을 배포하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./deploy_photon_router_ova.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opening OVA source: /mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The manifest validates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The provided certificate is in valid period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source is signed and the certificate validates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Certificate information:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CertIssuer:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CertSubject:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -----BEGIN CERTIFICATE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -----END CERTIFICATE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Line -1: Unsupported value 'uefi.secureBoot.enabled' for attribute 'key' on element 'ExtraConfig'.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opening VI target: vi://root@esxi-01.tanzu.local:443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deploying to VI: vi://root@esxi-01.tanzu.local:443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer Completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Powering on VM: router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Task Completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Received IP address: 192.168.0.47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed successfully</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 DHCP를 통해 임의의 주소(192.168.0.47)를 할당 받게 되고 해당 IP로 SSH접속하여 기본 패스워드(<code>changeme</code>)를 원하는 패스워드로 변경한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh root@192.168.0.47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host '192.168.0.47 (192.168.0.47)' can't be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECDSA key fingerprint is SHA256:ESpN1DMTIu9PKWW4QZIYs4DZ602SsdhjxEYhugkmi+g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added '192.168.0.47' (ECDSA) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/network/10-static-eth0.network &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You are required to change your password immediately (administrator enforced)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Changing password for root.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Retype new password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 08:58:54 up 32 min,  0 users,  load average: 0.00, 0.00, 0.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tdnf update info not available yet!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@photon-machine [ ~ ]#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@photon-machine [ ~ ]# exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection to 192.168.0.47 closed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-환경-구성">Router 환경 구성<a class="hash-link" href="#router-환경-구성" title="Direct link to heading">​</a></h3><p>위 스크립트 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts" target="_blank" rel="noopener noreferrer">레포지토리</a>에서 DNS역할, 포워딩을 수행하도록 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_photon_router.sh" target="_blank" rel="noopener noreferrer"><code>setup_photon_router.sh</code></a>를 수정한다. </p><ul><li><code>PHOTON_ROUTER_IP</code>=192.168.0.201 : Router 설정할 IP</li><li><code>PHOTON_ROUTER_GW</code>=192.168.0.1 : Router의 게이트웨이</li><li><code>PHOTON_ROUTER_DNS</code>=192.168.0.1 : Router의 Forwader DNS</li><li><code>SETUP_DNS_SERVER</code>=1 : Router가 클러스터 내 DNS 역할을 수행</li></ul><p>위 설정 이외에도 추후 내부 네트워크 구성을 위한 iptables 구성이 포함되어 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_IP=192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_GW=192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_DNS=192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SETUP_DNS_SERVER=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tdnf -y update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ ${SETUP_DNS_SERVER} -eq 1 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tdnf install -y unbound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat &gt; /etc/unbound/unbound.conf &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interface: 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do-ip4: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do-udp: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 192.168.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 10.10.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 10.20.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        verbosity: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-zone: "tanzu.local." static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: "router.tanzu.local A 192.168.0.201"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: "192.168.0.201 router.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: "vcsa.tanzu.local A 192.168.0.202"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: "192.168.0.202 vcsa.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: "haproxy.tanzu.local A 192.168.0.203"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: "192.168.0.203 haproxy.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: "esxi-01.tanzu.local A 192.168.0.10"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: "192.168.0.10 esxi-01.tanzu.local"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 스크립트를 수행하고 나면 IP가 변경되고 외부에서도 Router DNS를 통해 쿼리가 가능한것을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\rokak&gt; nslookup vmware.com 192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">서버:    router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address:  192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">권한 없는 응답:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">이름:    vmware.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Addresses:  2a02:e980:b5::b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2a02:e980:b1::b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            45.60.101.183</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            45.60.11.183</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vcsavcenter-server-appliance-배포-및-구성">VCSA(vCenter Server Appliance) 배포 및 구성<a class="hash-link" href="#vcsavcenter-server-appliance-배포-및-구성" title="Direct link to heading">​</a></h3><p><code>vcsa-deploy</code>를 사용하여 배포를 진행한다. <code>vcsa-deploy</code>는 VCSA 이미지내에 바이너리 형태로 존재하기 때문에 먼저 VCSA 7.0 Update 1 ISO를 다운로드한다.  </p><ul><li><a href="https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7</a></li></ul><p>위 스크립트 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts" target="_blank" rel="noopener noreferrer">레포지토리</a>에서 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/vcsa.tanzu.local.json" target="_blank" rel="noopener noreferrer"><code>vcsa.tanzu.local.json</code></a>를 수정한다.  </p><p>패스워드, <code>Network</code>와 <code>Datastore</code>를 설정하고 <code>dns_servers</code>를 Router IP로 변경한다. 나머지는 기본값으로 설정한다. </p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"deployment_network"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"VM Network"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"datastore"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"datastore2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"appliance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"__comments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"thin_disk_mode"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"deployment_option"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tiny"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"vcsa.tanzu.local"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"network"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ip_family"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ipv4"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"mode"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"static"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"system_name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"vcsa.tanzu.local"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ip"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"192.168.0.202"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"prefix"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"24"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"gateway"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"192.168.0.1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"dns_servers"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"192.168.0.201"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 다운로드 받았던 VCSA ISO를 압축을 풀고 위 스크립트를 참조하여 배포 명령을 실행한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd VMware-VCSA-all-7.0.1-17004997/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vcsa-deploy install --accept-eula --acknowledge-ceip --no-ssl-certificate-verification /mnt/c/esxi/vsphere-with-tanzu-homelab-scripts/vcsa.tanzu.local.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>vCenter가 설치가 완료된 후 SSH로 접속한다. 기본 Shell이 Bash가 아니므로 <code>shell</code> 명령으로 접속한후 <code>chsh -s /bin/bash</code>로 기본 Shell을 Bash로 변경한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh root@192.168.0.202</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host '192.168.0.202 (192.168.0.202)' can't be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECDSA key fingerprint is SHA256:oMr5nJ9RDeZS9E3m586kSFDoNXM76yNiLYaIyDQ6ca4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added '192.168.0.202' (ECDSA) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VMware vCenter Server 7.0.1.00100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type: vCenter Server with an embedded Platform Services Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@192.168.0.202's password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected to service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * List APIs: "help api list"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * List Plugins: "help pi list"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Launch BASH: "shell"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Command&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Command&gt; shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shell access is granted to root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@vcsa [ ~ ]# chsh -s /bin/bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vcsa-설정-변경">VCSA 설정 변경<a class="hash-link" href="#vcsa-설정-변경" title="Direct link to heading">​</a></h3><p>메모리 절약을 위해 마스터 노드 개수를 변경한다. <code>/etc/vmware/wcp/wcpsvc.yaml</code> 에서 <code>clusterconfig.minmasters</code> 와 <code>clusterconfig.maxmasters</code> 값을 2로 변경하면 된다. 자세한 내용은 다음 링크를 참조한다.</p><ul><li><a href="https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html" target="_blank" rel="noopener noreferrer">https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html</a></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">logging</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxsizemb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># By default, WCP Agent VM OVF URL points to the ovf bundled in vCSA, served</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># through lighttpd web server. To override it, set kubevmconfig.ovfurl param.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#kubevm:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  ovfurl: 'https://this_vc_pnid:5480/wcpagent/photon-ova-%%SIZE%%.ovf'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  apiserverport: 6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  authproxyport: 443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rhttpproxy_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clusterconfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minmasters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxmasters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">disable_ssl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace_graceful_disable_duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">upgrade_precheck_timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># force_upgrade_clusters:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">force_version_for_enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1\.18\..*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">logging_fluentbit_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># logging_fluentbit_rsyslog: ""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">csisetting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">csi_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">hdcsconfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ovf_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'file:///storage/lifecycle/vmware-hdcs'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>vCenter UI사용을 위해 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_vcsa.ps1" target="_blank" rel="noopener noreferrer"><code>setup_vcsa.ps1</code></a> 스크립트를 수정한다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.\setup_vcsa.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect-VIServer: C:\esxi\vsphere-with-tanzu-homelab-scripts\setup_vcsa.ps1:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Line |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  17 |  $vc = Connect-VIServer $VCSAHostname -User $VCSAUsername -Password $V …</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | 2020-11-30 오전 12:45:18 Connect-VIServer  The SSL connection could not be established,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | see inner exception.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 SSL connection 에러가 발생하기 때문에 인증서 체크를 무시하는 설정을 먼서 한다. </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Set-PowerCLIConfiguration -InvalidCertificateAction:Ignore</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>$VCSAPassword</code>, <code>$DatastoreName</code>, <code>$ESXiPassword</code> 등을 수정하고 스크립트를 실행한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\esxi\vsphere-with-tanzu-homelab-scripts&gt; .\setup_vcsa.ps1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>설치가 완료되면 신규UI로 접속이 가능해진다. 이제부터는 VCSA로 직접 접속이 가능하다.<br>
<!-- -->기본 로그인 아이디는 <code>administrator@vsphere.local</code>로 <code>vcsa.tanzu.local.json</code> 에서 설정한 패스워드로 접속하면 vCenter 기반의 Client UI를 확인할 수 있다. 정상적으로 클러스터에 연결된 ESXi 호스트 정보를 확인할 수 있다.  </p><p><img loading="lazy" alt="VCSA" src="/assets/images/vcsa_home-4abc614139248554017057d16eaf1911.png" width="1007" height="460" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>일단 아주 작은 하드웨어로 가성비 좋은 클러스터를 구축할 수 있는 PN50으로 Tanzu 클러스터 구성을 하기 위한 기초작업이 완료되었다.  </p><p>글이 길어지는 관계로 VDS(vSphere Distributed Switch)를 구성하는 이후 부분은 다음 포스팅에서 계속 이어나갈 예정이다. </p><blockquote><p>다음글 - <a href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab-2/" target="_blank" rel="noopener noreferrer">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></p></blockquote>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Tanzu" term="Tanzu"/>
        <category label="vSphere" term="vSphere"/>
        <category label="Homelab" term="Homelab"/>
        <category label="ASUS" term="ASUS"/>
        <category label="PN50" term="PN50"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[2019 Retrospective]]></title>
        <id>/2020/01/03/2020plan</id>
        <link href="https://ddii.dev/2020/01/03/2020plan"/>
        <updated>2020-01-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[19년도를 돌아보며]]></summary>
        <content type="html"><![CDATA[<p>또 한해가 지나갔다. 2019년 한일 정리하면서 2020년 플랜 기록용으로 끄적거려본다.</p><ul><li><p>Work</p><ul><li>18년도 까지 서비스 개발을 맡았지만 갑작스럽게 부서 이동으로 인해 FaaS 개발을 손을 떼고 신규 부서로 이전하게 되었다. 작년 초에도 큰 변화였는데 이번에도 더 큰 변화였다.</li><li>문제는 개발보다는 기획쪽에 더 가까운 업무였고 데이터 분석 관련한 플랫폼을 개발하는 TF에 포함되게 되었다. 머신러닝, 데이터 엔지니어링과는 담을 쌓았었지만 어쩔수 없이 분석 관련하여 과제 수행</li><li>1-3월에는 주로 모빌리티 관련 에코파트너들과 협력 및 사업개발을 위한 기술검토 및 검증.</li><li>4-6월에는 그룹 관계사들의 데이터레이크에 대한 정의와 설계, 플랫폼 구현을 위한 Design-Thinking, 서비스 포털 기획 등을 수행하고 그룹 관계사들의 데이터레이크에 대한 정의와 설계 진행.</li><li>7-9월에는 서비스 포털 개발을 위한 CI/CD 선정 및 devops 파이프라인 구성, 데이터 preparation 툴 검토 및 AWS Managed 서비스 검증 및 구현 업무를 수행했다. 또한 프론트엔드 서비스 처리를 위한 람다함수 개발 및 documents 레포지토리 구축 진행.</li><li>10-12월까지는 서비스 포털 오픈 및 고도화, 다음 단계 서비스 기획 수행함.</li></ul></li><li><p>Main Tools</p><ul><li>Python, Node.js, Java(Springboot)</li><li>AWS - ECS, Lambda, CloudFront, Athena, Glue, S3, SageMaker</li><li>IBM Cloud - Object Storage</li><li>Github Team</li><li>CircleCI, Github Action</li></ul></li><li><p>Side (Community포함)</p><ul><li>번역 : <a href="http://acornpub.co.kr/book/monitoring-prometheus" target="_blank" rel="noopener noreferrer">프로메테우스 인프라스트럭처 모니터링 [가상머신, 컨테이너 환경의 프로메테우스 모니터링 실습과 활용]</a></li><li>블로그 포스팅 - 13회 (목표 25회 미달성)</li><li>사내 연구 과제 - 멀티클라우드 구현을 위한 IaC 연구 (5-10월)<ul><li>Terraform, Terratest, Ansible, Kubespary, CircleCI 조합으로 하나의 파이프라인에서 Bastion 없이 멀티 클라우드(AWS, IBM, GCP) 환경에 Elastic 및 K8s 클러스터 배포 및 테스트 자동화 환경 구성</li></ul></li><li>Istio 스터디 (9-11월)<ul><li>다양한 회사분들과 스터디 진행 (카카오뱅크, 이베이, 하이퍼커넥트)<ul><li>다양한 경험을 들을수 있어서 좋은 경험!!</li></ul></li><li>자료 : <a href="https://github.com/dev-chulbuji/istio-study" target="_blank" rel="noopener noreferrer">https://github.com/dev-chulbuji/istio-study</a></li></ul></li><li>K8s Korea Group 모니터링 소모임 진행<ul><li>1차 (4/25) SK u-tower<ul><li>발표1 : OpenCensus with Prometheus and Kubernetes (김진웅)</li><li>발표2 - Service Mesh(Istio) Monitoring (나정호)</li></ul></li><li>2차(6/4) 메가존<ul><li>발표1 : 쿠버네티스 운영 관리 오픈소스: NexClipper 소개 (김진용)</li><li>발표2 : 난상토의 (모니터링, 아키텍처 경험 등 자유주제 공유, 토의)</li></ul></li></ul></li><li>AWS Korea User 소모임 참여<ul><li>판교, 컨테이너, 서버리스, 데이터 사이언스, 머신러닝 스터디, 데브옵스</li></ul></li><li>CircleCI 밋업 참여<ul><li>1차 (5/14), 2차 (8/27)</li></ul></li><li>Open Infrastructure &amp; Cloud Native Days Korea 2019 참여 (7/18-19)</li><li>Kubernetes Forum Seoul 참여 (12/9)<ul><li>CFP 탈락 ㅠㅠ</li></ul></li><li>개인 서버, NAS 2대 Shutdown (전기세 압박에서 해방됨)<ul><li>G Suite Business 로 갈아탐</li></ul></li><li>미디어 환경 개편<ul><li>스마트TV 직구 (75SM8670PUA)</li><li>PS4 구매 (닌텐도 스위치, Xbox 기존보유)</li></ul></li><li>K3s Home Lab구성 및 이더패드 서비스 운영<ul><li>1.16 클러스터 : 1 Master, 3 Workers</li></ul></li><li>독서<ul><li>20권 내외 (기술서 포함)</li></ul></li><li>교육<ul><li>Google Study Jam - 클라우드 4회, 머신러닝 4회 수료</li><li>Udemy - CKA, CKAD</li><li>Elasticsearch Engineer I, II</li></ul></li></ul></li><li><p>Speak</p><ul><li>2018년에 비해 대외 발표가 많이 적었다. 실제 K8s 관련 업무를 하지 않아 그런 듯 하다.</li><li>4월 AWS Korea User Group 판교소모임<ul><li><a href="https://www.slideshare.net/JinwoongKim8/eks-workshop-140043415" target="_blank" rel="noopener noreferrer">Amazon EKS Workshop 살펴보기</a></li></ul></li><li>4월 Kubernetes Korea Group 모니터링 소모임<ul><li><a href="https://www.slideshare.net/JinwoongKim8/open-census-with-prometheus-and-kubernetes" target="_blank" rel="noopener noreferrer">Opencensus with prometheus and kubernetes</a></li></ul></li><li>4월 Google Cloud Next ‘19 Extended Korea<ul><li><a href="https://www.slideshare.net/JinwoongKim8/knative" target="_blank" rel="noopener noreferrer">Knative로 서버리스 워크로드 구현</a></li></ul></li><li>6월 Korea DevOps MeetUP ‘19 - 4월 발표 수정<ul><li><a href="https://www.slideshare.net/JinwoongKim8/opencensus-with-prometheus-and-kubernetes" target="_blank" rel="noopener noreferrer">OpenCensus with Prometheus and Kubernetes</a></li></ul></li><li>7월 CircleCI Korea User Group 2nd Meetup<ul><li><a href="https://www.slideshare.net/JinwoongKim8/dataops-with-circleci" target="_blank" rel="noopener noreferrer">Data(?)Ops with CircleCI</a></li></ul></li><li>9월 AWS Korea User Group 판교소모임<ul><li><a href="https://www.slideshare.net/JinwoongKim8/dataops-with-circleci" target="_blank" rel="noopener noreferrer">DataOps with CircleCI</a></li></ul></li><li>11월 사내 Open Tech Lounge 발표<ul><li>멀티클라우드 구현을 위한 IaC 연구</li></ul></li></ul></li><li><p>2020 목표</p><ul><li>커뮤니티 활동은 최대한 줄이기 (필수적인 부분만)<ul><li>SRE group 활성화 방안 고민</li><li>밋업, 세미나 관련 캘린더 연동 자동화 방안 고민</li></ul></li><li>번역 및 책 쓰는건 고민을 더...</li><li>Level Up<ul><li>영어!! - 발표까지</li><li>Full-Stack ??</li><li>머신러닝, 딥러닝</li><li>ELK 쿼리 잘짜기</li><li>NoSQL</li></ul></li><li>기존업무 K8s 전환 및 고도화<ul><li>서버리스, 매니지드 방향으로</li></ul></li><li>사이드 프로젝트<ul><li>홈 미디어 관리 고도화 (Plex)</li><li><a href="https://nextcloud.com/" target="_blank" rel="noopener noreferrer">nextcloud</a> 서비스 오픈 (지인 대상)</li><li>모바일 웹앱 3개 만들기 (미디어 관리, 코믹 뷰어, 스트리밍)</li><li>오픈소스 기여</li></ul></li></ul></li></ul>]]></content>
        <category label="Retrospective" term="Retrospective"/>
        <category label="2019" term="2019"/>
        <category label="2020" term="2020"/>
        <category label="Planning" term="Planning"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[CircleCI로 AWS BATCH(ECS) CI/CD Pipeline 구성]]></title>
        <id>/2019/06/30/circleci-ecs</id>
        <link href="https://ddii.dev/2019/06/30/circleci-ecs"/>
        <updated>2019-06-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이전 포스팅에서 EKS 클러스터와 어플리케이션 배포 및 테스트를 간단하게 해봤다.  이번에는 AWS ECS 또는 AWS Batch Application을 CircleCI를 통해 배포 및 업데이트 하는 것을 알아본다.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://ddii.dev/devops/circleci/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>에서 EKS 클러스터와 어플리케이션 배포 및 테스트를 간단하게 해봤다.  이번에는 AWS ECS 또는 AWS Batch Application을 CircleCI를 통해 배포 및 업데이트 하는 것을 알아본다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="application-요구사항">Application 요구사항<a class="hash-link" href="#application-요구사항" title="Direct link to heading">​</a></h2><p>기본적으로 현재 업무 중에 IBM클라우드에서 AWS로 데이터를 가져와야 하는 업무가 생겨서 시작되었고 정기적으로 매일 새벽에 크롤링(Pull)방식으로 데이터를 복제해야하는 Use-Case를 구현해야 했다.<br>
<!-- -->CI/CD Pipeline구성이 주 목적으로 Application구현은 포스팅 내용에서 제외하였다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기본-요구사항">기본 요구사항<a class="hash-link" href="#기본-요구사항" title="Direct link to heading">​</a></h3><ul><li>Github Account</li><li>CircleCI Account (Github Auth)</li><li>AWS ECR(Elastic Container Registry)</li><li>AWS Batch(ECS) </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cicd-구성안">CI/CD 구성안<a class="hash-link" href="#cicd-구성안" title="Direct link to heading">​</a></h2><p>실제 프로젝트에 적용할 구성안이다.<br>
<!-- -->기본적으로 모든 구성은 최대한 비용이 들지 않고 AWS 종속성을 제거한 방법으로 구성하였다.  </p><ul><li>Code Repository : Github</li><li>CI : CircleCI</li><li>Registry : AWS ECR</li><li>CD : CircleCI</li><li>Target : AWS Batch(ECS)</li><li>Notification : Slack</li></ul><p>이번 데모에서는 다음과 같은 시나리오로 진행하려고 한다.  </p><ol><li>Terraform으로 AWS Batch 생성</li><li>Github에 수정된 Batch Code(Shell Script) Commit &amp; Triggering CircleCI</li><li>Docker Build &amp; AWS ECR로 Push</li><li>S3로 myjob shell 파일 복사</li><li>AWS Batch(ECS) Job Definition 변경(Change Image)</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-batch">AWS Batch<a class="hash-link" href="#aws-batch" title="Direct link to heading">​</a></h3><p>기본적으로 Batch 컴퓨팅을 목적으로 하는 서비스로 컴퓨팅 타입을 Fargate 또는 EC2 중 하나를 선택하여 동적으로 프로비저닝하는 서비스이다.<br>
<!-- -->초기 설정이 번거롭긴 하지만 한번 구성하고 나면 별도 관리가 필요없고 Batch작업이 발생하는것과 컨테이너 이미지 보관비용 이외에는 추가 비용이 발생하지 않기 때문에 비용측면에서 장점이 있는 서비스이다.<br>
<!-- -->위에서 이야기한 정기적으로 새벽마다 크롤링(Pull)방식으로 데이터를 복제해야하는 Use-Case를 구현하는것이 적당한 워크로드 구현방법이라 생각했기 때문에 AWS Batch 서비스를 사용하게 되었다.  </p><p>간단한 Batch demo는 <a href="https://github.com/awslabs/aws-batch-helpers/" target="_blank" rel="noopener noreferrer">https://github.com/awslabs/aws-batch-helpers/</a>에서 확인이 가능하며 CircleCI연동을 위해 Fork후  진행하였다.</p><p>Demo Repository : <a href="https://github.com/ddiiwoong/aws-batch-helpers/" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/aws-batch-helpers/</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci">CircleCI<a class="hash-link" href="#circleci" title="Direct link to heading">​</a></h3><p>모든 Pipeline은 CircleCI기반으로 작성하였다.  혹자는 AWS Code Commit, Pipeline을 사용하지 않느냐고 문의하시는 분들도 있는데 다음과 같은 이유로 CircleCI를 선택하였다.  </p><ul><li>Fully Managed (Serverless)</li><li>AWS 종속성 최소화  </li><li>Git, Registry, CD영역의 확장성 고려</li><li>AWS Console 접속 최소화</li><li>쉽고 단순하게 빌드 환경구성</li><li>소규모 프로젝트 빠르게 시작 가능</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="amazon-elastic-container-registry-ecr">Amazon Elastic Container Registry (ECR)<a class="hash-link" href="#amazon-elastic-container-registry-ecr" title="Direct link to heading">​</a></h3><p>개인적으로 Registry는 구축형보다는 Managed서비스를 사용하는것이 좋다고 보기 때문에 Webhook을 Native하게 지원하는 DockerHub도 대체 가능하다고 생각한다.  </p><ul><li>Fully Managed</li><li>Security (IAM) 연동</li><li>CircleCI Orbs 제공</li><li>EKS, ECS 연동 용이</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="terraform">Terraform<a class="hash-link" href="#terraform" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/providers/aws/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/aws/index.html</a>  </p><p>선언적 인프라스트럭처 관리 도구로 많이 사용하고 있는 도구이며 Docs와 블로그 자료가 많은 관계로 따로 설명하지 않겠다.<br>
<!-- -->이번 포스트에서는 AWS Batch를 생성하는 영역을 Terraform이 담당한다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-config-작성">CircleCI Config 작성<a class="hash-link" href="#circleci-config-작성" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@6.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-ecs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecs@0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-s3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3@1.0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-cli</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli@0.1.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">docker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'circleci/python:2.7'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-s3/copy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./myjob.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'s3://batch-ecr-test/myjob.sh'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Update AWS Batch Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties '{ "image": "823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623", "vcpus": 1, "memory": 512}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build-and-deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-ecr/build-and-push-image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_RESOURCE_NAME_PREFIX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v20190623</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">upload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr/build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">upload</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>단계별 설명을 위해 부분적으로 설명하도록 하겠다.  </p><ol><li><p>Terraform으로 Batch 배포</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_batch_compute_environment"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"default"</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compute_environment_name = </span><span class="token string" style="color:#e3116c">"env_fetch_and_run"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compute_resources </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance_role = </span><span class="token string" style="color:#e3116c">"arn:aws:iam::823928750534:instance-profile/ecsInstanceRole"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance_type = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"optimal"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desired_vcpus = </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_vcpus = </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_vcpus = </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_group_ids = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"sg-0632cf81b5c4dff17"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnets = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"subnet-0c4f8135b536e8fab"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"subnet-0a261950d894cf27e"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = </span><span class="token string" style="color:#e3116c">"EC2"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_role = </span><span class="token string" style="color:#e3116c">"arn:aws:iam::823928750534:role/service-role/AWSBatchServiceRole"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type =</span><span class="token string" style="color:#e3116c">"MANAGED"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Batch Computing 환경을 구성하게 되는데 <code>"aws_batch_compute_environment"</code>를 사용한다.  </p><ul><li>compute_environment_name : (필수) 컴퓨팅 환경 이름</li><li>compute_resources.instance_role : (필수) EC2에 적용되는 Role</li><li>compute_resources.instance_type : (필수) 사용 가능한 instance 유형</li><li>compute_resources.desired_vcpus : (옵션) 원하는 CPU수</li><li>compute_resources.max_vcpus : (필수) 최대 CPU수  </li><li>compute_resources.min_vcpus : (필수) 최소 CPU수</li><li>compute_resources.security_group_ids : (필수) EC2에 적용되는 Security Group</li><li>compute_resources.subnets : (필수) Subnets 목록</li><li>compute_resources.type : (필수) EC2를 기반으로 생성, SPOT instance 사용가능  </li><li>service_role : (필수) AWS Batch가 다른 AWS 서비스를 호출 할수있게 해주는 IAM Role(ARN)</li><li>type : (필수) MANAGED나 UNMANAGED를 선택할 수 있고, MANAGED의 경우 compute_resources에 세부 사항을 설정할 수 있다.  </li></ul><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_batch_job_definition"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"default"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = </span><span class="token string" style="color:#e3116c">"fetch_and_run"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = </span><span class="token string" style="color:#e3116c">"container"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container_properties = &lt;&lt;CONTAINER_PROPERTIES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"command"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"image"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"vcpus"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"memory"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"volumes"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"environment"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"mountPoints"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"ulimits"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_PROPERTIES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Job Definition 정의("aws_batch_job_definition")에서는 Resource spec 및 Command(Docker RUN), Container IMAGE 등을 선언하게 된다.  </p><ul><li>name : (필수) Job Definition 이름</li><li>type : (필수) Job Definition 유형, ECS로 처리하기 위해 container로 선택</li><li>container_properties : (선택) JSON 형태로 작성하는 container 속성정보 (Image, Resources, Command, MountPoint 등)</li></ul></li><li><p>.circleci/config.yml에 CircleCI 버전 명시 및 관련 orb(ecr,ecs,s3,cli) 추가<br>
<!-- -->기본적으로 2.1로 설정을 해야 ecs, eks orb 사용이 가능하다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@6.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecs@0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-s3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3@1.0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-cli</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli@0.1.13</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>workflow 구성</p><p><code>build-and-push-image</code> -&gt; <code>sh-s3-upload</code> -&gt; <code>deploy-batch</code> 순으로 순차적으로 pipeline구성을 하였다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">workflows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  build-and-deploy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - aws-ecr/build-and-push-image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          repo: $AWS_RESOURCE_NAME_PREFIX # data-crawler-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          tag: v20190623</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # create-repo: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # dockerfile: Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - sh-s3-upload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: sh-s3-upload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requires:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - aws-ecr/build-and-push-image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - deploy-batch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: deploy-batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requires:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - sh-s3-upload</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기본적으로 CircleCI에서는 orb job을 <!-- -->[orb name]<!-- -->/<!-- -->[predefined-job]<!-- --> 형식으로 선언한다.  </p><p>I. 첫번째 step에서는 container image를 build하고 push하는 Job을 수행하므로 <code>aws-ecr/build-and-push-image</code>을 선언한다.<br>
<!-- -->자세한 내용은 <a href="https://circleci.com/orbs/registry/orb/circleci/aws-ecr" target="_blank" rel="noopener noreferrer">https://circleci.com/orbs/registry/orb/circleci/aws-ecr</a>를 확인하자.  </p><p>II. 두번째 step에서는 S3에 배치스크립트를 올리는 Custom Job을 수행한다.  Job은 Step의 모음으로 선행되어야할 Job은 상위에 <code>requires:</code> 에서 선언하면 된다.  </p><p>III. 세번째 step에서는 AWS Batch job definition의 container image를 교체(revision 변경)하는 Custom Job을 수행한다.  </p></li><li><p>custom job 구성
Workflow에서 선언한 Custom Job의 상세 definition을 기재한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">docker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'circleci/python:2.7'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-s3/copy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./myjob.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'s3://batch-ecr-test/myjob.sh'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Update AWS Batch Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties '{ "image": "823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623", "vcpus": 1, "memory": 512}'</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>I. <code>sh-s3-upload</code> 에서는 <code>aws-s3/copy</code> 를 사용하여 원하는 S3버킷에 사용할 스크립트를 업로드 한다.  <code>checkout</code>에서는 현재 상태의 git repo를 clone하게 된다.  </p><p>II. <code>deploy-batch</code> 에서는 <code>aws-cli/install</code> 를 사용하여 기존에 작성한 Batch Job definition을 awscli로 원하는 새로운 image로 업데이트 하게 된다.  </p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-실행">CircleCI 실행<a class="hash-link" href="#circleci-실행" title="Direct link to heading">​</a></h2><p>빌드 및 배포과정을 간단하게 설명하면 코드가 업데이트되면 CircleCI는 해당 저장소의 <code>.circleci/config.yml</code> 을 기준으로 빌드 및 배포를 시작하게 된다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="readmemd에-build-status-badge-달기">README.md에 Build Status Badge 달기<a class="hash-link" href="#readmemd에-build-status-badge-달기" title="Direct link to heading">​</a></h2><p><a href="https://circleci.com/docs/2.0/status-badges/" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/status-badges/</a>  </p><p><img loading="lazy" alt="badge" src="/assets/images/circle-badge-24ad544bce8cfd19a433ce635078fa5c.png" width="1000" height="660" class="img_E7b_">
위 링크와 설정을 참고하여 아래 그림과 같이 Build Statud Badge를 달 수 있다.  </p><p><img loading="lazy" alt="badge" src="/assets/images/circle-badge-ss-0aa981c32cb500f9508dd854153420ae.png" width="854" height="374" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번에는 CircleCI를 가지고 AWS Batch job을 구성하는 데모를 진행하였다.  </p><p>얼마전인가에도 <a href="https://github.com/leoh0" target="_blank" rel="noopener noreferrer">어형부형</a>님께서도 언급하신 선언적인 구성 기반에 최대한 serverless 환경에서의 배포를 추구하게 되다 보니 아래와 같은 <code>CI/CD Pipeline 시나리오</code>를 구상하게 되었다.  </p><p><img loading="lazy" alt="cicd" src="/assets/images/circlecicd-01a869820c0d70040071bbc7a5704933.png" width="972" height="599" class="img_E7b_"></p><p>새로운 기능의 브랜치(New Feature)가 Git에 push되면 빌드와 테스트가 트리거되어 자동으로 진행되고 동시에 개발자가 PR을 작성하면 동료 및 담당 상급자에게 코드 리뷰를 받게 된다.  </p><p>리뷰가 통과되고 CircleCI에서 빌드가 성공했다면 승인단계를 통해 Merge를 하고 CircleCI 가 한 번 더 빌드를 시작하고 배포까지 수행하게 된다.  </p><p>ECS나 Batch로 배포는 CircleCI를 통해 직접 배포를 하고 EC2나 EKS로의 배포는 Terraform 및 ArgoCD를 통해 배포를 진행하는 방식이다.  </p><p>다음번 포스팅에는 위 그림 기반으로 CircleCI와 ArgoCD를 활용하여 EKS기반 배포과정을 정리할 예정이다.  </p><p><a href="https://ko-fi.com/X8X1W6OZ" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://www.ko-fi.com/img/githubbutton_sm.svg" alt="ko-fi" class="img_E7b_"></a></p>]]></content>
        <category label="DevOps" term="DevOps"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Pipeline" term="Pipeline"/>
        <category label="CircleCI" term="CircleCI"/>
        <category label="GitHub" term="GitHub"/>
        <category label="GitOps" term="GitOps"/>
        <category label="ECS" term="ECS"/>
        <category label="AWS Batch" term="AWS Batch"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[CircleCI - GitHub 연동 및 EKS 구성하기]]></title>
        <id>/2019/06/18/circleci</id>
        <link href="https://ddii.dev/2019/06/18/circleci"/>
        <updated>2019-06-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[CI/CD는 개발단계에서 지속적인 통합, 배포를 통해 효율성을 높여주는 도구라고 말할수 있다.  특히 GitOps가 중요시 되는 최근 트렌드에서 Public Git서비스와 통합은 필수적인 요소이다.]]></summary>
        <content type="html"><![CDATA[<p>CI/CD는 개발단계에서 지속적인 통합, 배포를 통해 효율성을 높여주는 도구라고 말할수 있다.  특히 GitOps가 중요시 되는 최근 트렌드에서 Public Git서비스와 통합은 필수적인 요소이다. </p><p><a href="https://github.com/marketplace" target="_blank" rel="noopener noreferrer">GitHub MarketPlace</a>에서 <code>CI</code> 라고 검색하면 다음과 같은 결과를 얻을수 있다.  </p><p><img loading="lazy" alt="github-ci" src="/assets/images/github-ci-a6a8bfaf143484e079fd19a79207b6c2.png" width="2020" height="1370" class="img_E7b_"></p><p>CircleCI, Travis CI, Google Cloud Build 등 최근 트렌드한 도구들을 확인할 수 있다.  </p><p>이번 포스팅에서는 <code>CircleCI</code>를 <code>GitHub</code>과 연동해서 AWS ECR Push 및 EKS로 배포하는 간단한 Pipeline을 구성하는 방법을 적어보고자 한다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci---github-accout-연동">CircleCI - GitHub Accout 연동<a class="hash-link" href="#circleci---github-accout-연동" title="Direct link to heading">​</a></h2><p><a href="https://circleci.com" target="_blank" rel="noopener noreferrer">circleci.com</a>에 접속하여 Sign Up을 진행하면 GitHub과 BitBucket 계정을 연동할 수 있는데 일반적인 GitHub 3rd Party OAuth연동 진행을 하게된다.  </p><p><img loading="lazy" alt="init" src="/assets/images/circleci-init-b44a7c81c0dbf4cf4ff0a4b775427186.png" width="2482" height="1928" class="img_E7b_"></p><p>위 그림처럼 모든 Repository가 확인되고 Follow할 Repository를 선택하면 초기 구성이 완료된다.  </p><p><img loading="lazy" alt="error" src="/assets/images/init-error-dde1c8ca577589b364d02c1f94c47230.png" width="2476" height="2024" class="img_E7b_"></p><p>첫 연동이 되면 Build를 진행하게 되는데 위 그림과 같이 error를 보게 되는데 이는 기본적으로 circleci가 필요로 하는 기본 설정값(.circleci/config.yaml)이 없어서 발생하는 오류이다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh -eo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># No configuration was found in your project. Please refer to https://circleci.com/docs/2.0/ to get started with your configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Warning: This configuration was auto-generated to show you the message above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Don't rerun this job. Rerunning will have no effect.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 보이는것 처럼 config를 체크하는것도 하나의 가상머신(컨테이너)이 진행하는데 CircleCI콘솔에서 <code>Spin up Environment</code> 로그를 보면 Docker(18.09.6)로 aws Linux기반으로 환경구성을 하는 것을 알 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Build-agent version 1.0.11727-b0960fc9 (2019-05-23T02:12:54+0000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker Engine Version: 18.09.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel Version: Linux 9a20a41aeae4 4.15.0-1035-aws #37-Ubuntu SMP Mon Mar 18 16:15:14 UTC 2019 x86_64 Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting container bash:4.4.19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  using image bash@sha256:9f0a4aa3c9931bd5fdda51b1b2b74a0398a8eabeaf9519d807e010b9d9d41993</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-grossary">CircleCI Grossary<a class="hash-link" href="#circleci-grossary" title="Direct link to heading">​</a></h2><p>아래 링크는 CircleCI에서 자주 사용하는 용어들을 따로 정리한 페이지이다.  주로 컨테이너 기반으로 동작하기 때문에 용어들은 Docker에서 사용하는 용어과 겹치는 부분이 많다.   </p><p><a href="https://circleci.com/docs/2.0/glossary/" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/glossary/</a></p><p>위 링크 내용을 확인하면 <code>Orbs</code>라는 용어가 나오는데 이는 공유가능한 패키지로 Jenkins의 Plugin과 유사한 개념이라고 보면 된다. CircleCI에서 제공하는 자체 패키지 뿐만 아니라 3rd Party orbs를 제공하고 있다. </p><p>MacOS에서는 brew를 통해 cli를 설치하고 orb 리스트를 확인하거나 <a href="https://circleci.com/orbs/registry/" target="_blank" rel="noopener noreferrer">https://circleci.com/orbs/registry/</a>에서 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install circleci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ circleci orb list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Orbs found: 43. Showing only certified orbs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add --uncertified for a list of all orbs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/android (0.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/artifactory (1.0.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-cli (0.1.13)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-code-deploy (0.0.9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-ecr (6.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-ecs (0.0.8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-eks (0.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-s3 (1.0.11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/jira (1.0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/jq (1.9.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/kubernetes (0.3.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/lein-nvd (0.0.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/maven (0.0.8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/node (1.0.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/slack (3.2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/twilio (0.0.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/welcome-orb (0.3.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In order to see more details about each orb, type: `circleci orb info orb-namespace/orb-name`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Search, filter, and view sources for all Orbs online at https://circleci.com/orbs/registry/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circle-architecture">Circle Architecture<a class="hash-link" href="#circle-architecture" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="https://circleci.com/docs/assets/img/docs/arch.png" alt="circle-arch" class="img_E7b_"></p><p>GitHub 또는 Bitbucket에서 관리하는 Repository가 CircleCI 프로젝트로 승인되면 최초에는 컨테이너나 가상머신환경(2core 4GB)이 프로비저닝 되고 자동으로 테스트가 진행된다.  </p><p>테스트가 완료된 후 성공 또는 실패에 대한 Alert설정(Email, Slack)이 가능하고 각 단계(job, workflow)에 대한 결과는 각 단계별 세부 정보 페이지에서 확인할 수 있다.  </p><p>또한 배포는 AWS CodeDeploy, AWS ECS, AWS S3, AWS EKS, Google Kubernetes Engine (GKE) 및 Heroku 등 다양한 환경에 코드를 배포하도록 구성 할 수 있다. 이외의 클라우드 서비스 배포는 SSH를 통해 직접 사용하거나 terraform과 같은 도구를 가지고 해당 클라우드 서비스의 API통해 자동화가 가능한 구조로 되어있다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circelci-aws-eks">CircelCI AWS EKS<a class="hash-link" href="#circelci-aws-eks" title="Direct link to heading">​</a></h2><p><a href="https://github.com/CircleCI-Public/circleci-demo-aws-eks" target="_blank" rel="noopener noreferrer">https://github.com/CircleCI-Public/circleci-demo-aws-eks</a></p><p>위 demo는 CircleCI를 이용하여 다음과 같은 workflow (상세내용 아래 config.yaml 참고)를 수행한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-eks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks@0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@3.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/kubernetes@0.3.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>공통적으로 orb를 3가지를 추가하였기 때문에 각단계마다 관련 orb를 추가하는 단계를 거치게 된다.</p><ol><li>환경설정 및 Docker Build 및 ECR로 Push<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-ecr/build_and_push_image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">account-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS_ECR_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks_orb_demo_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">dockerfile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ~/project/demo_app/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ~/project/demo_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CIRCLE_SHA1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># repository가 없을 경우 생성하는 옵션</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># create-repo: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>environment variables 설정 <ul><li>Project - BUILD SETTINGS - Environment Variables 에서 Key-Value형태로 입력  <ul><li>AWS_DEFAULT_REGION : <code>us-west-2</code></li><li>AWS_ECR_URL : <code>219547004475.dkr.ecr.us-west-2.amazonaws.com/eks_orb_demo_app</code>  </li></ul></li></ul></li><li>github 연동 (ssh-key 연동 및 repo clone)</li><li>aws cli 설치 및 AWS Access, Secret Key설정</li><li>ECR Login</li><li>Image Build (<a href="https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile</a>)</li><li>Push Image to ECR</li></ul><ol><li>EKS클러스터 생성 (No Scripts)<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/create-cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치</li><li>kubectl config 설정 (aws iam authenticator)</li><li>eksctl 설치</li><li>eksctl로 클러스터 생성 및 검증 (Cloudformation)<ul><li>variables 사전 설정가능 ($AWS_DEFAULT_REGION)</li></ul></li></ul><ol start="2"><li>Demo Application 배포<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Create deployment manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            BUILD_DATE=$(date '+%Y%m%d%H%M%S')</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            cat deployment/demo-app-deployment.yaml.template |\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              sed "s|DOCKER_IMAGE_NAME|&lt;&lt; parameters.docker-image-name &gt;&gt;|\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                g;s|BUILD_DATE_VALUE|$BUILD_DATE|g;s|VERSION_INFO_VALUE|\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                &lt;&lt; parameters.version-info &gt;&gt;|g" &gt; deployment/demo-app-deployment.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/create-or-update-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-file-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deployment/demo-app-deployment.yaml"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">get-rollout-status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deployment/demoapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/create-or-update-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-file-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deployment/demo-app-service.yaml"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">deploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">docker-image-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${AWS_ECR_URL}/eks_orb_demo_app:${CIRCLE_SHA1}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">version-info</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${CIRCLE_SHA1}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/create</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>deployment manifest생성 (deployment template)</li><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>resource(deployment, service) 배포 (orb설정: aws-eks,kubernetes)</li><li>rollout 수행 (0-&gt;3)</li></ul><ol start="3"><li>application test<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">test-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">expected-version-info</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"${CIRCLE_SHA1}"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> deploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for service to be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get services</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sleep 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            for attempt in {1..20}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              EXTERNAL_IP=$(kubectl get service demoapp | awk '{print $4}' | tail -n1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              echo "Checking external IP: ${EXTERNAL_IP}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              if [ -n "${EXTERNAL_IP}" ] &amp;&amp; [ -z $(echo "${EXTERNAL_IP}" | grep "pending") ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                break</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              echo "Waiting for external IP to be ready: ${EXTERNAL_IP}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              sleep 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            done</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sleep 180</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            curl -s --retry 10 "http://$EXTERNAL_IP" | grep "&lt;&lt; parameters.expected-version-info &gt;&gt;"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>External IP 체크 및 curl 테스트</li></ul><ol start="4"><li>Demo Application 삭제<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">undeploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/delete-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-types</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deployment,service"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">label-selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"app=demo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check on pod status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">undeploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>deployment 삭제 및 상태 체크</li></ul><ol start="5"><li>EKS클러스터 삭제 (No Scripts)<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/delete-cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> undeploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>eksctl 설치</li><li>eksctl로 클러스터 삭제 및 검증 (Cloudformation)</li></ul><p>상세 config는 다음 링크에서 확인할 수 있다.<br>
<a href="https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pipeline-수행">pipeline 수행<a class="hash-link" href="#pipeline-수행" title="Direct link to heading">​</a></h2><p>위 Workflow를 수행하게 되면 마지막에 어플리케이션과 클러스터를 삭제하기 때문에 해당 workflow는 제외하고 수행한다. 해당 config를 commit하면 바로 해당 CI가 트리거 되어 시작되게 된다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># - undeploy-application:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     cluster-name: eks-orb-demo-app-deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     aws-region: $AWS_DEFAULT_REGION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     requires:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#       - test-application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># - aws-eks/delete-cluster:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     cluster-name: eks-orb-demo-app-deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     aws-region: $AWS_DEFAULT_REGION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     wait: true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     requires:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     - undeploy-application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="result" src="/assets/images/workflow-result-1507577220f3902e6add662d37db5fcf.png" width="1218" height="473" class="img_E7b_"></p><p>클러스터 구성포함해서 총 20분정도 소요되었다. 실제 <code>eksctl</code>로 프로비저닝하게 되면 CloudFormation으로 수행되기 때문에 약 15-20분 정도 소요되니 간단한 빌드,배포,테스트는 5분정도 소요된것을 알 수 있다.  </p><p>삭제는 역순으로 진행하거나 위에 주석 처리된 영역만 수행하면 된다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>간단하게 CircleCI를 가지고 GitOps와 CI/CD를 구성하는 데모를 진행하였다.  </p><p>CircleCI는 Jenkins와 유사하지만 Public서비스이고 Slave관리에 대해서 의존적이지 않기 때문에 기존에 Jenkins를 사용한 경험이 있다면 아주 쉽게 구성할 수 있다.  </p><p><a href="https://circleci.com/docs/2.0/migrating-from-jenkins" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/migrating-from-jenkins</a>를 참고하면 Jenkins와 차이점을 알 수 있는데 가장 큰 장점은 병렬로 테스트나 Job을 수행할수 있다는 점과 Lambda와 같은 서버리스 앱을 배포할때 정말 서버리스 환경으로 구성할수 있다는 점이다.  </p><p>이는 Git Repository를 연동할때도 Java Plugin을 설치해야하는 번거로움을 덜 수 있다. 가장 중요한건 SaaS라는 장점도 무시할수 없다. Travis 무료 플랜과 비교해도 작은 프로젝트의 경우 별도의 Docker environment(2core, 4GB)를 제공받기 때문에 지연없이 바로 빌드가 가능하다는 점이다.  </p><p>다음번 포스팅에는 terraform을 통해 ECR과 ECS로 배포하는 workflow를 살펴보려고 한다.</p>]]></content>
        <category label="DevOps" term="DevOps"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Pipeline" term="Pipeline"/>
        <category label="CircleCI" term="CircleCI"/>
        <category label="GitHub" term="GitHub"/>
        <category label="GitOps" term="GitOps"/>
        <category label="EKS" term="EKS"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Yaml 작성 기본 Tip]]></title>
        <id>/2019/06/10/CKAD-1</id>
        <link href="https://ddii.dev/2019/06/10/CKAD-1"/>
        <updated>2019-06-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[CKAD검정시 YAML 작성 tip]]></summary>
        <content type="html"><![CDATA[<p>최근 포스팅을 할 여유가 되지 않아 일단 틈틈히 준비중인 CKAD 준비하는 팁이나 정보등을 먼저 정리하고자 한다.<br>
<!-- -->그중 기본이 되는 YAML을 최초 작성할때 팁을 정리해봤다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="manifest-yaml작성-tip">Manifest YAML작성 Tip<a class="hash-link" href="#manifest-yaml작성-tip" title="Direct link to heading">​</a></h2><p>CLI안에서 Manifest YAML파일을 작성하는것은 쉽지 않다. 특히 시험중에 Copy/Paste를 하는것은 어렵고 느리게 진행될수 있으므로 CLI안에서 해결하는것이 좋다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-run-활용">kubectl run 활용<a class="hash-link" href="#kubectl-run-활용" title="Direct link to heading">​</a></h3><p><a href="https://kubernetes.io/docs/reference/kubectl/conventions/#generators" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/kubectl/conventions/</a></p><p>위 링크를 잘 기억해놓고 실제 시험을 볼때 template작성을 위해 아래와 같이 Manifest를 해보는것이 가장 좋다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pod-manifest-yaml">Pod Manifest YAML<a class="hash-link" href="#pod-manifest-yaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run --generator=run-pod/v1 nginx --image=nginx --dry-run -o yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deployment-yaml">Deployment YAML<a class="hash-link" href="#deployment-yaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run --generator=deployment/v1beta1 nginx --image=nginx --dry-run --replicas=4 -o yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="yaml로-저장">YAML로 저장<a class="hash-link" href="#yaml로-저장" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run --generator=deployment/v1beta1 nginx --image=nginx --dry-run --replicas=4 -o yaml &gt; nginx-deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="CKAD" term="CKAD"/>
        <category label="Exam" term="Exam"/>
        <category label="Tip" term="Tip"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Knative on EKS]]></title>
        <id>/2019/05/14/knative-on-aws</id>
        <link href="https://ddii.dev/2019/05/14/knative-on-aws"/>
        <updated>2019-05-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[EKS에서도 Knative를 구성해보자]]></summary>
        <content type="html"><![CDATA[<p>이번에는 Knative를 EKS에 구성해보려고 한다. 4월은 발표 및 여러가지 업무로 인해서 포스팅을 할 시간이 부족했지만 5월부터 조금씩 여유가 생겨서 더 바빠지기전에 좀 써보려고 한다. 사실 <a href="https://www.facebook.com/yongho1037" target="_blank" rel="noopener noreferrer">Facebook @최용호</a>님께서 한번 해보는것도 좋겠다고 하셔서 테스트를 진행하였다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-on-eks">Knative on EKS<a class="hash-link" href="#knative-on-eks" title="Direct link to heading">​</a></h2><p>제목만 보면 Lambda나 ECS, Batch 서비스가 있는데 왜 이걸 써야하지? 라는 생각부터 하는 사람도 있을것 같다. 하지만 이전 포스팅들과 발표에서도 여러번 이야기 한것처럼 Knative는 간단하게 서버리스 워크로드를 빌드, 배포, 관리하기 위한 Kubernetes기반 FaaS플랫폼이고 현재 <a href="https://landscape.cncf.io/" target="_blank" rel="noopener noreferrer">CNCF Landscape</a>에서 가장 빠른 속도로 개발되고 있는 오픈소스 프로젝트 중 하나이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-배포">EKS 배포<a class="hash-link" href="#eks-배포" title="Direct link to heading">​</a></h2><p>앞선 <a href="https://ddii.dev/kubernetes/eksworkshop/" target="_blank" rel="noopener noreferrer">eksworkshop 포스팅</a>에서처럼 간단한 배포를 위해 <code>eksctl</code>로 2-node 클러스터를 배포한다.<br>
<!-- -->사전 준비사항은 <a href="https://ddii.dev/kubernetes/eksworkshop/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>이나 <a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">https://eksctl.io/</a>을 참고하자.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster --name=eksworkshop-eksctl --nodes=2 --node-ami=auto</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성된 클러스터 상태를 확인한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-24-168.ap-northeast-2.compute.internal   Ready     &lt;none&gt;    2m        v1.11.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-78-204.ap-northeast-2.compute.internal   Ready     &lt;none&gt;    2m        v1.11.9</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-설치">istio 설치<a class="hash-link" href="#istio-설치" title="Direct link to heading">​</a></h2><p>Knative는 istio 의존성을 가지고 있기 때문에 Istio를 먼저 배포한다. 물론 <a href="https://ddii.dev/kubernetes/knative-using-gloo/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>에서 설명한것 처럼 Gloo를 사용해도 되지만 이번에는 Istio를 설치하였다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio-crds.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포된 Pods, Services, Replicasets 을 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway-65c8b667c8-269cf   1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel-76bd44d8f7-5cltj           1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-cleanup-secrets-7jpth              0/1       Completed   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway-b9d56b4f8-pdjhs      1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley-7db7db89db-5stkp            1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway-f77fbc787-npw9d     1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-4dq4d             2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-q9g8g             2/2       Running     0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-tnm92             2/2       Running     0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy-8db48cbcd-dl2th             2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-security-post-install-xv8z6        0/1       Completed   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector-cd54ffccd-kj2n6   1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry-d78cd45db-8x2cw          2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)                                                                                                                   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway    ClusterIP      10.100.97.146    &lt;none&gt;                                                                        80/TCP,443/TCP,31400/TCP,15011/TCP,8060/TCP,15030/TCP,15031/TCP                                                           17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel            ClusterIP      10.100.147.235   &lt;none&gt;                                                                        8060/TCP,9093/TCP                                                                                                         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway      ClusterIP      10.100.25.44     &lt;none&gt;                                                                        80/TCP,443/TCP                                                                                                            17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley             ClusterIP      10.100.158.45    &lt;none&gt;                                                                        443/TCP,9093/TCP                                                                                                          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway     LoadBalancer   10.100.62.157    a4e1d5201758f11e9b7f402c4d4b0376-510368564.ap-northeast-2.elb.amazonaws.com   80:31000/TCP,443:30753/TCP,31400:31922/TCP,15011:31331/TCP,8060:30389/TCP,853:30257/TCP,15030:30827/TCP,15031:30153/TCP   17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot              ClusterIP      10.100.25.194    &lt;none&gt;                                                                        15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                                     17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy             ClusterIP      10.100.73.149    &lt;none&gt;                                                                        9091/TCP,15004/TCP,9093/TCP                                                                                               17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector   ClusterIP      10.100.117.18    &lt;none&gt;                                                                        443/TCP                                                                                                                   17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry          ClusterIP      10.100.87.12     &lt;none&gt;                                                                        9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                                     17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get rs -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               DESIRED   CURRENT   READY     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway-65c8b667c8   1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel-76bd44d8f7           1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway-b9d56b4f8      1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley-7db7db89db            1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway-f77fbc787     1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f             3         3         3         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy-8db48cbcd             1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector-cd54ffccd   1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry-d78cd45db          1         1         1         17m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Istio injection을 하기 위해 배포할 defaults namespace 전체에 Labeling을 한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label namespace default istio-injection=enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/default labeled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespaces --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           STATUS    AGE       LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default        Active    43m       istio-injection=enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-system   Active    27m       istio-injection=disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public    Active    43m       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system    Active    43m       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-설치">Knative 설치<a class="hash-link" href="#knative-설치" title="Direct link to heading">​</a></h2><p>build, evening, serving 및 모니터링 리소스를 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/serving.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/build/releases/download/v0.5.0/build.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/eventing/releases/download/v0.5.0/release.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/eventing-sources/releases/download/v0.5.0/eventing-sources.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/serving/releases/download/v0.5.0/monitoring.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://raw.githubusercontent.com/knative/serving/v0.5.0/third_party/config/build/clusterrole.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 Knative namespaces 및 resources를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespaces | grep knative</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-build        Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-eventing     Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-monitoring   Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serving      Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-sources      Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-serving</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activator-664b5b9598-dsjvq    2/2       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoscaler-64d5bd84b8-bqghq   2/2       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-658b9d5c6c-tnwvz   1/1       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-5dffbfbb8b-525vt      1/1       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-build </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-controller-86f5b5b96d-zg8j2   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-webhook-6fddd7c6df-68fkw      1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-eventing </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                            READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventing-controller-6fdccd8c95-bckws            1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in-memory-channel-controller-6fddb6655f-vbc64   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in-memory-channel-dispatcher-7684cd7c7d-ftqhc   2/2       Running   2          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-d496c66bd-688xz                         1/1       Running   0          11m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-monitoring </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-logging-0               1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-logging-1               1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-754bc795bb-wxwml              1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kibana-logging-7f7b9698bc-rrnw6       1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-state-metrics-5bccdf746f-fhv7t   4/4       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-exporter-w9jlq                   2/2       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-exporter-wgv2j                   2/2       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-system-0                   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-system-1                   1/1       Running   0          14m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모니터링 리소스도 확인한다. 위의 리소스를 보면 Fluentd가 배포되지 않은 상태이므로 DaemonSet으로 동작할수 있도록 아래와 같이 설정하면 DaemonSet을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label nodes --all beta.kubernetes.io/fluentd-ds-ready="true"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build에서-사용할-docker-credential-설정">Build에서 사용할 Docker Credential 설정<a class="hash-link" href="#build에서-사용할-docker-credential-설정" title="Direct link to heading">​</a></h2><p>일단 Knative Build를 수행할때 일반적으로 Container Registry를 많이 사용하기 때문에 Registry Credential 설정을 해야한다.  </p><p>ECR의 경우 <a href="https://github.com/knative/build-templates" target="_blank" rel="noopener noreferrer">https://github.com/knative/build-templates</a>의 ecr_helper를 사용하면 쉽게 ECR account를 설정할 수 있지만 <code>Serving</code>단계에서 401에러가 나는 이유를 잡지 못해서 일단 Dockerhub를 가지고 진행하였다.</p><p>간단한 데모코드는 아래 repository에 미리 작성해놨다.  </p><p><a href="https://github.com/ddiiwoong/hello-python.git" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/hello-python.git</a></p><p><code>docker-secret.yaml</code> 을 보면 dockerhub push를 위해 basic-auth를 수행하게 되는데 dockerhub id/password 를 base64로 encoding해서 Secret으로 저장한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build.knative.dev/docker-0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//index.docker.io/v1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use 'echo -n "username" | base64' to generate this string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BASE64_ENCODED_USERNAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use 'echo -n "password" | base64' to generate this string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BASE64_ENCODED_PASSWORD</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 ServiceAccount <code>build-bot</code>을 생성하기 위한 yaml (sa.yaml)를 작성한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pass</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 작성한 Secret(basic-user-pass)과 ServiceAccount(build-bot)를 배포한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f docker-secret.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret "basic-user-pass" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f sa.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount "build-bot" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>저장된 Secret(basic-user-pass)과 ServiceAccount(build-bot)를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        TYPE                                  DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">basic-user-pass             kubernetes.io/basic-auth              2         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-bot-token-gfkg9       kubernetes.io/service-account-token   3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder-token-kp7ww         kubernetes.io/service-account-token   3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-9cpp5         kubernetes.io/service-account-token   3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecr-creds                   kubernetes.io/basic-auth              2         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.build-bot             istio.io/key-and-cert                 3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.builder               istio.io/key-and-cert                 3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.default               istio.io/key-and-cert                 3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.knative-serve         istio.io/key-and-cert                 3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serve-token-9j82l   kubernetes.io/service-account-token   3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            SECRETS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-bot       2         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder         2         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default         1         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serve   2         2h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="python-코드-및-dockerfile-작성">Python 코드 및 Dockerfile 작성<a class="hash-link" href="#python-코드-및-dockerfile-작성" title="Direct link to heading">​</a></h2><p>TARGET 환경변수를 받아서 Hello World와 같이 출력하는 간단한 Flask기반 앱을 작성한다.  </p><p>간단한 데모코드는 아래 repository에 미리 작성해놨다.  </p><p><a href="https://github.com/ddiiwoong/hello-python.git" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/hello-python.git</a></p><div class="codeBlockContainer_I0IT language-py theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-py codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'TARGET'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NOT SPECIFIED'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Hello World: {}!\n'</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'0.0.0.0'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'PORT'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 앱(app.py)을 배포하는 Dockerfile을 작성한다.</p><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV APP_HOME /app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT ["python"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD ["app.py"]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-build">Knative Build<a class="hash-link" href="#knative-build" title="Direct link to heading">​</a></h2><p>미리 Dockerhub에서 <code>hello-python</code> repository(docker.io/ddiiwoong/hello-python)를 생성한다.<br>
<!-- -->그리고 위에서 생성한 <code>build-bot</code> 계정과 image tag <code>hello-python</code>정보를 Build template에 작성하여 배포한다.<br>
<!-- -->아래 Knative Build 과정은 <code>kaniko executor</code>를 사용하여 다음과 같은 과정을 수행한다.  </p><ol><li><code>spec.source</code> 에서 Source Clone (git)를 수행하고 이후  </li><li><code>spec.steps</code> 에서 Docker Build, Tag, Registry Login, Push를 수행한다.  </li></ol><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> python</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">git</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">revision</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/kaniko</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project/executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dockerfile=/workspace/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">destination=docker.io/ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>build</code>를 수행한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f build.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build.build.knative.dev/python-build created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           SUCCEEDED   REASON    STARTTIME   COMPLETIONTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python-build   True                  18m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 Build가 완료되면 Dockerhub에 정의한 TAG(ddiiwoong/hello-python)로 이미지가 등록된걸 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker pull ddiiwoong/hello-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using default tag: latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">latest: Pulling from ddiiwoong/hello-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e7c96db7181b: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">799a5534f213: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">913b50bbe755: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11154abc6081: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c805e63f69fe: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6eabcf0f7a50: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">74101057f4ec: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:51dc4a7ce38a5e7894adcfc00eaee6c5ea6aca1ef6c7521f9b7ea6382c013b9b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status: Downloaded newer image for ddiiwoong/hello-python:latest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-serving-으로-배포">Knative Serving 으로 배포<a class="hash-link" href="#knative-serving-으로-배포" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serviceyaml">service.yaml<a class="hash-link" href="#serviceyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> serving.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">runLatest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">revisionTemplate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Python Sample v1 with Knative on EKS"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>빌드된 image (ddiiwoong/hello-python:latest)로 Knative Service를 생성한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.serving.knative.dev/helloworld-python created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>istio-system</code> Namespace에 <code>istio-ingressgateway</code> Service를 확인한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc istio-ingressgateway --namespace istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP                                                                    PORT(S)                                                                                                                   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway   LoadBalancer   10.100.208.80   a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com   80:31581/TCP,443:31490/TCP,31400:30367/TCP,15011:32495/TCP,8060:31418/TCP,853:30310/TCP,15030:32405/TCP,15031:31410/TCP   13h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ALB: a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com  </p><p>위와 같이 AWS LoadBalancer로 배포면 ALB가 자동으로 생성되므로 추후 eksctl로 클러스터를 삭제하기 전에 반드시 LoadBalancer 형태로 배포된 서비스를 삭제하고 진행해야 한다.  </p><p>Knative Service를 확인한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ksvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                DOMAIN                                  LATESTCREATED             LATESTREADY               READY     REASON</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helloworld-python   helloworld-python.default.example.com   helloworld-python-4rw95   helloworld-python-4rw95   True</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 얻은 두가지 정보(LoadBalancer, Domain)로 생성된 app을 테스트한다.<br>
<!-- -->Knative는 내부적으로 example.com이라고 하는 기본 domain을 사용하므로 내부적으로는 <code>helloworld-python.default.example.com</code>으로 curl을 실행하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Host:helloworld-python.default.example.com" http://a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello World: Python Sample v1 with Knative on EKS!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>Cold Start</code>(default timeout 5분) 때문에 잠시 응답이 늦어질 수도 있지만(2-5초) 잠시 기다리면 위처럼 결과를 확인할 수 있다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>위에서도 잠깐 언급했지만 Lambda나 ECS, Batch 서비스가 있는데 Knative on EKS 를 구지 왜 하느냐라고 궁금해하는 분들이 계실지도 모른다. 하지만 다들 아래와 같은 고민을 해봤을거라 생각한다.  </p><p>컨테이너와 Kubernetes가 DevOps도구로서의 표준이 되어가는 시대에 Lambda를 쓸지 오픈소스를 쓸지에 대한 고민은 결국 이식성과 벤더 종속성을 제거하고 운영효율화 측면에서 그 답을 찾을수 있을것 같다.  </p><p>현재 몸담고 있는 최근 프로젝트에서 Lambda, ECS, Batch 등을 사용하는 경우가 많아졌는데 실제 엔터프라이즈에서 정해진 자원내에서 정해진 일을 할때는 매니지드 서비스가 적합하다고 생각한다. 하지만 On-Premise 또는 그에 준하는 Kubernetes 클러스터를 운영하는 조직에서는 Knative를 사용하여 컨테이너 기반 서비리스 워크로드를 구현하는 것이 향후 Hybrid 관점에서 확장성과 벤더 종속성을 제거하는데 큰 도움이 될것이라 생각한다.  </p><p>조금씩 Kubernetes 및 생태계 Learning에 대한 피로도가 증가하고 있고 Hype Driven Development(설레발 주도개발)가 되는것 같아서 아쉬운 부분은 있지만 현재 가장 핫한 기술이고 관심도가 높기 때문에 배워두면 언젠가는 써먹게 될거라 확신한다.  </p><p>다시한번 Conference driven development(architecture)가 되지 않도록 자중하고 Loudest Guy가 되지 않도록 조심해야할 것 같다.</p>]]></content>
        <category label="Knative" term="Knative"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="FaaS" term="FaaS"/>
        <category label="AWS" term="AWS"/>
        <category label="Lambda" term="Lambda"/>
        <category label="Serverless" term="Serverless"/>
        <category label="EKS" term="EKS"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[eksworkshop]]></title>
        <id>/2019/03/29/eksworkshop</id>
        <link href="https://ddii.dev/2019/03/29/eksworkshop"/>
        <updated>2019-03-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[eskworkshop 튜토리얼을 실행하고 간단한 Microservice앱을 배포해보자]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="amazon-eks-elastic-container-service-for-kubernetes">Amazon EKS (Elastic Container Service for Kubernetes)<a class="hash-link" href="#amazon-eks-elastic-container-service-for-kubernetes" title="Direct link to heading">​</a></h2><p>Kubernetes Managed Service인 Amazon EKS가 2018년 7월 출시되고 2019년 1월 정식으로 서울리전에 출시되었다. 개인적으로 완전관리형 Kubernetes 출시가 늦어져서 AWS 행보가 다소 늦다고 생각은 했으나 ALB와 VPC연동, 여러가지 기존 OpenSource와의 연결고리를 배제하고 자체 Managed서비스와 연동할것들이 많기 때문에 당연히 타사에 비해 늦어진걸로 보인다. 언제나 그랬지만 오픈소스를 받아들이는 느낌이 아니라 뭔가 완성된 제품을 쓰는 느낌(?)이다. 물론 불편한 부분과 감수해야할 내용들은 조금 있지만 기존 AWS 충성 User에게 호응을 얻을수 있기 때문이 아닐까라는 생각을 해보면서 포스팅을 시작하려고 한다.  </p><p>오픈소스가 아닌 Managed서비스에 대한 리뷰는 처음이지만 4월 10일 <a href="https://www.meetup.com/ko-KR/awskrug/events/260024327/" target="_blank" rel="noopener noreferrer">AWS판교소모임</a> 발표도 있고, 실제 고려중인 아키텍처에 포함이 되어야 하는 EKS에 대해서 살펴보고 eskworkshop 튜토리얼을 실행해보면서 다른 관리형 Kubernetes 서비스들에 비해 어떤 사항을 좀더 고민해야 하는지 정리해보고 넘어가면 좋을듯 하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksworkshopcom">eksworkshop.com<a class="hash-link" href="#eksworkshopcom" title="Direct link to heading">​</a></h2><p><a href="https://eksworkshop.com/" target="_blank" rel="noopener noreferrer">https://eksworkshop.com/</a><br>
<!-- -->Kubernete를 처음접하는 유저를 위한 기본 개념과 아키텍처, 그리고 VPC, ALB를 활용하여 EKS에 대한 설치, 구성, 데모앱 배포 등을 해볼수 있는 튜토리얼 사이트이다.  </p><p><a href="https://www.facebook.com/groups/awskrug/" target="_blank" rel="noopener noreferrer">AWSKRUG</a>에서 한글화 작업도 진행중이다.  <a href="https://awskrug.github.io/eks-workshop/deploy/" target="_blank" rel="noopener noreferrer">한글화 링크</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksworkshop-따라하기전-사전-준비사항">eksworkshop 따라하기전 사전 준비사항<a class="hash-link" href="#eksworkshop-따라하기전-사전-준비사항" title="Direct link to heading">​</a></h2><p>eksworkshop에서는 기본적으로 workshop이라는 신규 IAM 계정을 생성하고 Cloud9 Workspace 와 몇가지 설정들을 진행하지만 <a href="https://www.meetup.com/ko-KR/awskrug/events/260024327/" target="_blank" rel="noopener noreferrer">AWS판교소모임</a>을 위해 최대한 비용이 드는 구성요소를 배제하고 작성하고자 한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-account">AWS account<a class="hash-link" href="#aws-account" title="Direct link to heading">​</a></h3><p>Free Tier는 EKS를 자유롭게 활용할수 없다.<br>
<!-- -->관련 issue - <a href="https://github.com/aws/containers-roadmap/issues/78" target="_blank" rel="noopener noreferrer">https://github.com/aws/containers-roadmap/issues/78</a>  </p><p>실제 사용중인 계정이나 Credit이 확보된 계정이 필요하다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="iam-설정-json-template">IAM 설정 (JSON template)<a class="hash-link" href="#iam-설정-json-template" title="Direct link to heading">​</a></h3><p>EKSworkshop에서는 Full administrator 계정을 필요로 하지만 eksctl로 배포를 진행하므로 그 기준으로 IAM설정을 진행한다.  </p><p><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/examples/eks_test_fixture/README.md" target="_blank" rel="noopener noreferrer">terraform eks iam 설정</a>을 참고하려고 했지만 eksctl과 terraform과의 약간 다른 방식의 배포로 인해 어쩔수없이 EKS Full Access권한을 할당하였다.<br>
<!-- -->(다른 유경험자의 도움이 필요한 상황 ㅠㅠ)</p><p>자세한 JSON 내용은 <a href="https://github.com/ddiiwoong/eksworkshop/blob/master/iam_for_eksworkshop.json" target="_blank" rel="noopener noreferrer">링크</a>를 참고한다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-aws-iam-authenticator">kubectl, aws-iam-authenticator<a class="hash-link" href="#kubectl-aws-iam-authenticator" title="Direct link to heading">​</a></h3><ul><li>kubectl : kubernetes CLI</li><li>aws-iam-authenticator : AWS IAM Authenticator CLI</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-config를-저장하기-위해-kube-directory를-생성">kubectl config를 저장하기 위해 .kube directory를 생성<a class="hash-link" href="#kubectl-config를-저장하기-위해-kube-directory를-생성" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p ~/.kube</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-linux">kubectl 설치 (linux)<a class="hash-link" href="#kubectl-설치-linux" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --silent --location -o /usr/local/bin/kubectl </span><span class="token string" style="color:#e3116c">"https://amazon-eks.s3-us-west-2.amazonaws.com/1.11.5/2018-12-06/bin/linux/amd64/kubectl"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /usr/local/bin/kubectl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-macos-homebrew">kubectl 설치 (MacOS Homebrew)<a class="hash-link" href="#kubectl-설치-macos-homebrew" title="Direct link to heading">​</a></h4><p>MacOS는 brew로 설치하였다.<br>
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos</a></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> kubernetes-cli</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-windows-powershell">kubectl 설치 (windows PowerShell)<a class="hash-link" href="#kubectl-설치-windows-powershell" title="Direct link to heading">​</a></h4><p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o kubectl.exe https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/kubectl.exe</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-확인">kubectl 설치 확인<a class="hash-link" href="#kubectl-설치-확인" title="Direct link to heading">​</a></h4><p>현재 MacOS에서는 1.11.7 버전이 설치되어 있다. (다른경로로 설치됨)</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl version --short --client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Client Version: v1.11.7-dispatcher</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-설치">aws-iam-authenticator 설치<a class="hash-link" href="#aws-iam-authenticator-설치" title="Direct link to heading">​</a></h4><p>Amazon EKS는 IAM을 사용하여 Kubernetes용 AWS IAM Authenticator를 통해 Kubernetes 클러스터에 인증을 제공한다.  Go(버전 1.7이상)가 설치되어 있으면 아래와 같이 진행하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ go get -u -v github.com/kubernetes-sigs/aws-iam-authenticator/cmd/aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> ~/go/bin/aws-iam-authenticator /usr/local/bin/aws-iam-authenticator</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>만약 Go설치가 안되어 있다면 다음 링크를 통해 설치 진행할수 있다.<br>
<a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-binary-다운로드">aws-iam-authenticator binary 다운로드<a class="hash-link" href="#aws-iam-authenticator-binary-다운로드" title="Direct link to heading">​</a></h4><p>Linux: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator</a><br>
<!-- -->MacOS: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</a><br>
<!-- -->Windows: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe</a></p><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos의-경우">MacOS의 경우<a class="hash-link" href="#macos의-경우" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x ./aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ./aws-iam-authenticator </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/bin/aws-iam-authenticator </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/bin:</span><span class="token environment constant" style="color:#36acaa">$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-bash-환경변수-추가">MacOS bash 환경변수 추가<a class="hash-link" href="#macos-bash-환경변수-추가" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'export PATH=$HOME/bin:$PATH'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> ~/.bash_profile</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-zsh-환경변수-추가">MacOS zsh 환경변수 추가<a class="hash-link" href="#macos-zsh-환경변수-추가" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'export PATH=$HOME/bin:$PATH'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> ~/.zshrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-binary-확인">aws-iam-authenticator binary 확인<a class="hash-link" href="#aws-iam-authenticator-binary-확인" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws-iam-authenticator </span><span class="token builtin class-name">help</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl">eksctl<a class="hash-link" href="#eksctl" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://github.com/weaveworks/eksctl/blob/master/logo/eksctl.png?raw=true" alt="mascot" class="img_E7b_"></p><p>eksctl은 weaveworks에서 contribute하고 있는 오픈소스로 EKS 클러스터를 생성하는 간단한 CLI 도구이다. Go로 작성되어 있고 CloudFormation을 기본으로 동작한다.  </p><p><a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">https://eksctl.io/</a><br>
<a href="https://github.com/weaveworks/eksctl" target="_blank" rel="noopener noreferrer">https://github.com/weaveworks/eksctl</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl-binary-다운로드">eksctl binary 다운로드<a class="hash-link" href="#eksctl-binary-다운로드" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --silent --location </span><span class="token string" style="color:#e3116c">"https://github.com/weaveworks/eksctl/releases/download/latest_release/eksctl_</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -s</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">_amd64.tar.gz"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xz -C /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> -v /tmp/eksctl /usr/local/bin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-homebrew-설치">MacOS Homebrew 설치<a class="hash-link" href="#macos-homebrew-설치" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew tap weaveworks/tap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> weaveworks/tap/eksctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="windows-설치-powershell-chocolatey">Windows 설치 (PowerShell, chocolatey)<a class="hash-link" href="#windows-설치-powershell-chocolatey" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">chocolatey install eksctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl-동작확인">eksctl 동작확인<a class="hash-link" href="#eksctl-동작확인" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl version</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cli-api-자격증명-구성">CLI API 자격증명 구성<a class="hash-link" href="#cli-api-자격증명-구성" title="Direct link to heading">​</a></h4><p>사전설정한 aws configure가 있는지 확인. 기존 Terraform이나 kops 사용한적이 있으면 건너뛰어도 된다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain">  ~/.aws</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>없을경우 aws 자격증명을 생성한다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="awscredentials">~/.aws/credentials<a class="hash-link" href="#awscredentials" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[default]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws_access_key_id={EXAMPLE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws_secret_access_key={EXAMPLEKEY}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="awsconfig">~/.aws/config<a class="hash-link" href="#awsconfig" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[default]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">region=ap-northeast-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output=json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-배포">EKS 배포<a class="hash-link" href="#eks-배포" title="Direct link to heading">​</a></h2><p>kubectl, aws-iam-authenticator, eksctl, AWS 자격증명 환경까지 구성되어 있으면 바로 배포가 가능하다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster --name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">eksworkshop-eksctl --nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> --node-ami</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  using region ap-northeast-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  setting availability zones to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ap-northeast-2a ap-northeast-2c ap-northeast-2a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2a - public:192.168.0.0/19 private:192.168.96.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2c - public:192.168.32.0/19 private:192.168.128.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2a - public:192.168.64.0/19 private:192.168.160.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">"ng-cfb3cb01"</span><span class="token plain"> will use </span><span class="token string" style="color:#e3116c">"ami-0c7972077aa002104"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AmazonLinux2/1.11</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating EKS cluster </span><span class="token string" style="color:#e3116c">"eksworkshop-eksctl"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ap-northeast-2"</span><span class="token plain"> region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will create </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> separate CloudFormation stacks </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> cluster itself and the initial nodegroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> you encounter any issues, check CloudFormation console or try </span><span class="token string" style="color:#e3116c">'eksctl utils describe-stacks --region=ap-northeast-2 --name=eksworkshop-eksctl'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating cluster stack </span><span class="token string" style="color:#e3116c">"eksctl-eksworkshop-eksctl-cluster"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating nodegroup stack </span><span class="token string" style="color:#e3116c">"eksctl-eksworkshop-eksctl-nodegroup-ng-cfb3cb01"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  --nodes-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> was </span><span class="token builtin class-name">set</span><span class="token plain"> automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  --nodes-max</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> was </span><span class="token builtin class-name">set</span><span class="token plain"> automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  all EKS cluster resource </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eksworkshop-eksctl"</span><span class="token plain"> had been created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  saved kubeconfig as </span><span class="token string" style="color:#e3116c">"/Users/ddii/.kube/config"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">"ng-cfb3cb01"</span><span class="token plain"> has </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> at least </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to become ready </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ng-cfb3cb01"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">"ng-cfb3cb01"</span><span class="token plain"> has </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ip-192-168-42-42.ap-northeast-2.compute.internal"</span><span class="token plain"> is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ip-192-168-66-165.ap-northeast-2.compute.internal"</span><span class="token plain"> is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  kubectl </span><span class="token builtin class-name">command</span><span class="token plain"> should work with </span><span class="token string" style="color:#e3116c">"/Users/ddii/.kube/config"</span><span class="token plain">, try </span><span class="token string" style="color:#e3116c">'kubectl get nodes'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  EKS cluster </span><span class="token string" style="color:#e3116c">"eksworkshop-eksctl"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ap-northeast-2"</span><span class="token plain"> region is ready</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서울리전(ap-northeast-2)기준 약 15-20분이 소요되며 <code>eksctl</code> 기본 설정값은 다음과 같다.</p><ul><li>클러스터명은 자동생성, --name 옵션으로 지정가능 (eksworkshop-eksctl)</li><li>CloudFormation : eksctl-{$Cluster_Name}-cluster</li><li>m5.large * 2 instances (<a href="https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/amazon-eks-nodegroup.yaml" target="_blank" rel="noopener noreferrer">EKS Instance Type</a> NodeInstanceType.AllowedValues 참고)</li><li>Default AMI : AWS EKS AMI (custom EKS AMI 가능 - Packer활용)</li><li>Default Region : us-west-2</li><li>dedicated VPC : 192.168.0.0/16 </li><li>kubernetes version : 1.11.x (<a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/platform-versions.html" target="_blank" rel="noopener noreferrer">EKS Version</a> 참고)</li><li>StorageClass : gp2 (<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs" target="_blank" rel="noopener noreferrer">AWS EBS</a> 참고)</li><li>CNI : <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="noopener noreferrer">Amazon VPC</a></li><li>Node Autoscaler : --node-min, --node-max Auto Scaling 설정</li><li>기본 Pod 개수 : <a href="https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/files/eni-max-pods.txt" target="_blank" rel="noopener noreferrer">참고</a></li><li>nodegroup : worker가 포함되는 group </li><li>kubeconfig : ~/.kube/config 로 통합됨</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="config-file-사용">Config File 사용<a class="hash-link" href="#config-file-사용" title="Direct link to heading">​</a></h3><p><a href="https://github.com/weaveworks/eksctl/tree/master/examples" target="_blank" rel="noopener noreferrer">https://github.com/weaveworks/eksctl/tree/master/examples</a>를 참고하여 <code>YAML</code>형태로 작성하여 배포가능하다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster -f example.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존에 관리하는 VPC subnet정보 및 AutoScaling, AZ(availabilityZones)설정, nodegroup 관리, node Instance에 preBootstrapCommand등을 아래 예시와 같이 미리 작성하면 GitOps측면에서 활용도가 더욱 높아질수 있다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="05-advanced-nodegroupsyaml">05-advanced-nodegroups.yaml<a class="hash-link" href="#05-advanced-nodegroupsyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># An advanced example of ClusterConfig object with customised nodegroups:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eksctl.io/v1alpha4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">west</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">nodeGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> m5.xlarge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">minSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">iam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">withAddonPolicies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">autoScaler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">private</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> m5.large</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">desiredCapacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> backend</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">addons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privateNetworking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">preBootsrapCommand</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># allow docker registries to be deployed as cluster service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'echo {\"insecure-registries\": [\"172.20.0.0/16\",\"10.100.0.0/16\"]} &gt; /etc/docker/daemon.json'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"systemctl restart docker"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">private</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> c3.8xlarge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">desiredCapacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> very</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">special</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">science</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privateNetworking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">availabilityZones</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"eu-west-2a"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># use single AZ to optimise data transfer between isntances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">preBootstrapCommand</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># disable hyperthreading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"for n in $(cat /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | cut -s -d, -f2- | tr ',' '\n' | sort -un); do echo 0 &gt; /sys/devices/system/cpu/cpu${n}/online; done"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># cluster AZs must be set explicitly for single AZ nodegroup example to work</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">availabilityZones</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"eu-west-2a"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eu-west-2b"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eu-west-2c"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-대시보드-배포">Kubernetes 대시보드 배포<a class="hash-link" href="#kubernetes-대시보드-배포" title="Direct link to heading">​</a></h2><p>Kubernetes 공식 대시보드는 기본으로 배포되지 않기 때문에 수동으로 배포해야한다. 설치 방법은 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener noreferrer">공식 문서</a>에서 확인가능하다.  </p><p>위에서 구성된 클러스터에서 Kubernetes 대시보드를 배포한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>접속을 위해 kube-proxy 기능을 활용하여 8080포트로 expose를 진행한다. 모든 인터페이스에서 필터링없이 접속이 가능하도록 옵션을 지정한다.
아래 명령은 터미널에서 백그라운드로 계속 동작한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl proxy --port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"> --address</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'0.0.0.0'</span><span class="token plain"> --disable-filter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0328 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:09.061754    </span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"> proxy.go:139</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>TOKEN으로 접속하기 위해 aws-iam-authenticator를 통해 해당 클러스터 token을 확인한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws-iam-authenticator token -i eksworkshop-eksctl --token-only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-aws-v1.aHR0cHM6Ly9zdHMuYXAtbm9ydGhlYXN0LTIuYW1hem9uYXdzLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMS0wNi0xNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFKMjVNVjJSVVZQNlRWTURBJTJGMjAxOTAzMjglMkZhcC1ub3J0aGVhc3QtMiUyRnN0cyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMTkwMzI4VDA3NDEwNVomWC1BbXotRXhwaXJlcz0wJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TaWduYXR1cmU9Yjc0NzkzYzUwOTU5NDYwMzMxMjY2YjExYWY4ODBkM2Q2OWQ5MWRhYzFhZWY1NjZmZTAwNTNlNWY2MTM0NGFlZQ</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그냥 localhost:8080 으로만 접속하면 구성된 클러스터 kube API list를 확인되므로 아래 경로로 접속한다.<br>
<!-- -->위에서 출력된 TOKEN값으로 로그인한다. Token 세션 Timeout이 있으니 세션만료시 <code>aws-iam-authenticator</code> 명령을 통해 갱신값을 입력하면 된다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">http://localhost:8080/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="dashboard" src="/assets/images/k8s_dashboard-b1c80ac04a6d1ec9d73b613952ef37c1.png" width="1950" height="1118" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="microservice-app-배포">Microservice app 배포<a class="hash-link" href="#microservice-app-배포" title="Direct link to heading">​</a></h2><p>가장 기본적인 <a href="https://microservices-demo.github.io/" target="_blank" rel="noopener noreferrer">Sock Shop</a>을 배포하기 위해 Git Clone 수행</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/microservices-demo/microservices-demo.git sockshop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> sockshop/deploy/kubernetes</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>NodePort</code>로 되어있는 Front-End Service를 <code>LoadBalancer</code>로 수정한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">'s/NodePort/LoadBalancer/g'</span><span class="token plain"> complete-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> complete-demo.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type: LoadBalancer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>namespace 생성 및 sock-shop 배포</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace sock-shop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f complete-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 접속확인을 위해서는 ALB배포시간(DNS전파)이 일정 소요되므로 잠시후 접속을 시도한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP                                                                 PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">carts          ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.84.58     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">carts-db       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.227.156   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalogue      ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.206.52    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalogue-db   ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.119.66    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">3306</span><span class="token plain">/TCP       1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">front-end      LoadBalancer   </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.249.164   a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:30001/TCP   1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orders         ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.160.17    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orders-db      ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.70.203    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payment        ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.57.233    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">queue-master   ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.146.109   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.32.115    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">5672</span><span class="token plain">/TCP       1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shipping       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.180.174   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user           ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.211.41    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user-db        ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.87.142    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>브라우저에서 ALB주소 <code>a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com</code> 로 접속하여 sock-shop Demo Web을 확인할수 있다.  </p><p><img loading="lazy" alt="sockshop" src="/assets/images/sock-shop-42ee8cb05cf4ad155e4890fd1370a6d8.png" width="719" height="800" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-클러스터-및-삭제">EKS 클러스터 및 삭제<a class="hash-link" href="#eks-클러스터-및-삭제" title="Direct link to heading">​</a></h2><p>위에서 외부접속을 위해 LoadBalancer를 수동으로 설정하였으므로 EC2 - Load Balancer서 프로비저닝된 ALB를 삭제하고 진행해야 한다.  </p><p>클러스터에서 실행 중인 모든 서비스를 다시 확인하고 EXTERNAL-IP값과 연결된 모든 서비스를 삭제한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete svc front-end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ALB와 VPC 삭제가 완료된것을 확인하고 클러스터를 삭제하자.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl delete cluster --name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">eksworkshop-eksctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  deleting EKS cluster </span><span class="token string" style="color:#e3116c">"eksworkshop-eksctl"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will delete stack </span><span class="token string" style="color:#e3116c">"eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> stack </span><span class="token string" style="color:#e3116c">"eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7"</span><span class="token plain"> to get deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will delete stack </span><span class="token string" style="color:#e3116c">"eksctl-eksworkshop-eksctl-cluster"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  kubeconfig has been updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  the following EKS cluster resource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"eksworkshop-eksctl"</span><span class="token plain"> will be deleted: cluster. If </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doubt, check CloudFormation console</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>서울 리전(ap-northeast-2)에 EKS가 오픈되고 Production환경을 EKS로 넘어가는 기업들이 많아지고 있는건 아주 긍정적인 현상이다.<br>
<!-- -->또한 엄청난 속도의 기술개발과 다양한 툴들로 Kubernetes Cluster를 구성하거나 Microservice형태의 App을 배포하는것은 점점 대중화 되어가고 있다.<br>
<!-- -->실제 Production에서 구현을 하기 위해서는 보안 및 성능을 동시에 고려한 네트워크(CNI), Ingress 설정이나 전체 클러스터 퍼포먼스 측면에서의 파라미터 튜닝이 더욱 더 중요해지고 관련된 DevOps(SRE) 인력들의 중요도가 높아질것은 분명해 보인다.  </p><p>EKS를 오픈소스 측면에서 고려했을때에는 예전에 페이스북이나 다른곳에서 종종 이야기 했던것처럼 AWS 고유의 Lock-in 전략을 엄청나게 고민하고 발표한듯한 생각이 한 느낌을 지울수는 없는건 사실이지만 훌륭한 제품인건 확실하고 단기간에 서비스 성장속도를 낼 수 있는 서비스라 생각한다.  </p><p>마지막으로 Managed Kubernetes의 선택은 엔지니어의 몫으로 보고 각 벤더별 비교한 아래 링크를 참조해서 선정 기준을 잡으면 더욱 좋을것 같다.<br>
<a href="https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0" target="_blank" rel="noopener noreferrer">https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0</a></p>]]></content>
        <category label="eks" term="eks"/>
        <category label="aws" term="aws"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="eskworkshop" term="eskworkshop"/>
        <category label="kubectl" term="kubectl"/>
        <category label="Managed Kubernetes" term="Managed Kubernetes"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[git-sync]]></title>
        <id>/2019/03/21/git-sync</id>
        <link href="https://ddii.dev/2019/03/21/git-sync"/>
        <updated>2019-03-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[git-sync에 대해서 알아본다.]]></summary>
        <content type="html"><![CDATA[<p>git repo를 kubernetes volume으로 구현할수 있는 sidecar pattern <code>git-sync</code> 프로젝트에 대해서 알아본다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync">git-sync<a class="hash-link" href="#git-sync" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Github</a>에 방문하면 다양한 프로젝트들을 볼 수 있다.<br>
<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Project</a>부터 minikube, kubeadm, kubectl, kubelet, dashboard등 필수적으로 필요하거나 많이 사용되는 프로젝트를 볼 수 있는데,
기존에 storage volume 으로 활용되던 <a href="https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo" target="_blank" rel="noopener noreferrer">gitrepo</a>가 <code>deprecated</code> 되어서 방법을 찾다가 유사한 프로젝트를 공식 repo에서 우연히 발견하게 되었다.  </p><p><a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a>는 sidecar 방식으로 git repository를 clone하는 프로젝트이다.  </p><p>최초 한번 clone도 가능하고 일정한 간격으로 끌어와서 응용프로그램에 사용할 수 있고 원하는 branch, Tag 또는 특정 git hash 기반으로 pulling이 가능하다.  </p><p>upstream의 repository에서 대상이 변경되었을때 다시 pulling하고, webhook기능을 추가하여 비동기성으로 POST 요청이 있을때만 git-sync를 수행할수 있기 때문에
Continuous Deployment를 간단하게 구현하는데 활용될 수 있다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="github-ssh설정">GitHub SSH설정<a class="hash-link" href="#github-ssh설정" title="Direct link to heading">​</a></h2><p>git 내용을 pulling을 할때 https, ssh 방법을 사용하는데 GitHub ssh key를 kubernetes cluster의 secret으로 사용을 할수 있기 때문에 ssh 방식을 사용하는 방법을 작성하였다.  </p><p>아래 모든 과정은 MacOS에서 진행하였고 다른 OS는 아래 링크에서 확인 가능하다.<br>
<a href="https://help.github.com/en/articles/connecting-to-github-with-ssh" target="_blank" rel="noopener noreferrer">https://help.github.com/en/articles/connecting-to-github-with-ssh</a></p><p>사용하고자 하는 터미널에서 등록키를 확인하자.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기존에-등록된-ssh-key-확인">기존에 등록된 SSH key 확인<a class="hash-link" href="#기존에-등록된-ssh-key-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -al ~/.ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="새로운-ssh-key-생성">새로운 SSH key 생성<a class="hash-link" href="#새로운-ssh-key-생성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keygen -t rsa -b 4096 -C "ddiiwoong@gmail.com"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start the SSH key creation process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter file in which the key is (/Users/you/.ssh/id_rsa): [Hit enter]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Key has comment '/Users/you/.ssh/id_rsa'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter new passphrase (empty for no passphrase): [Type new passphrase]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter same passphrase again: [One more time for luck]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Your identification has been saved with the new passphrase.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ssh-agent-실행중인지-확인">ssh agent 실행중인지 확인<a class="hash-link" href="#ssh-agent-실행중인지-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">eval “$(ssh-agent -s)”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Agent pid 59566</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="생성된-키를-keychain에-저장-및-확인">생성된 키를 keychain에 저장 및 확인<a class="hash-link" href="#생성된-키를-keychain에-저장-및-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-add -K ~/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="복사-및-github에-추가">복사 및 github에 추가<a class="hash-link" href="#복사-및-github에-추가" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ pbcopy &lt; ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Setting - SSH and GPG keys - SSH keys - New SSH key<br>
<code>Title</code>은 구분자로 입력하고 GitHub password를 한번더 입력하고 완료한다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="터미널에서-ssh접속-확인">터미널에서 SSH접속 확인<a class="hash-link" href="#터미널에서-ssh접속-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh -T git@github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi ddiiwoong! You've successfully authenticated, but GitHub does not provide shell access.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync를-위한-secret-등록">git-sync를 위한 secret 등록<a class="hash-link" href="#git-sync를-위한-secret-등록" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="secret-생성">secret 생성<a class="hash-link" href="#secret-생성" title="Direct link to heading">​</a></h3><p>위에서 생성한 SSH key를 Kubernetes Cluster에 Secret resource로 저장을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keyscan github.com &gt; /tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>known_hosts와 key를 Secret으로 저장한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret generic git-creds \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=ssh=$HOME/.ssh/id_rsa \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=known_hosts=/tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME        TYPE      DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git-creds   Opaque    2         1d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sample-ngnix-배포">sample ngnix 배포<a class="hash-link" href="#sample-ngnix-배포" title="Direct link to heading">​</a></h2><p>기본적으로 <code>git-sync/cmd/git-sync/main.go</code> 소스를 확인하면 여러가지 flag를 확인할 수 있는데 주로 사용하는 옵션은 다음과 같다.</p><ul><li>ssh : pulling 방식 (default=false)</li><li>root : git clone이 수행되는 root directory (default="$HOME/git")</li><li>repo : clone 대상 Repository (default="")</li><li>branch : branch (default=master)</li><li>rev : git revision (tag or hash) to check out</li><li>depth : commit depth (default=0)</li><li>dest : repository 배포 directory</li></ul><p>기타 옵션들은 <code>git-sync/cmd/git-sync/main.go</code> 에서 확인이 가능하며 해당 옵션들을 변수로 처리하여 활용하면 된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync-demoyaml-작성">git-sync-demo.yaml 작성<a class="hash-link" href="#git-sync-demoyaml-작성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-ssh"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-repo=git@github.com:ddiiwoong/git-sync-demo.git"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-root=/usr/share/nginx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-dest=html"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-branch=master"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "-depth=1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fsGroup: 65533 # to make SSH key readable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: 80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="확인사항">확인사항<a class="hash-link" href="#확인사항" title="Direct link to heading">​</a></h3><p>일단 ngnix로 1.14-alpine Image를 기본으로 하고 git-sync container가 sidecar로 들어가도록 작성하였다.<br>
<!-- -->실제 동작하는 순서대로 manifest를 아래서부터 살펴보자.</p><ul><li>git-sync-volume은 <code>emptyDir</code>, git-secret은 <code>secret</code> volume 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>sidecar container image를 <code>k8s.gcr.io/git-sync:v3.1.1</code>로 설정</li><li><code>git-sync-volume</code>, <code>git-sync-volume</code> volume을 <code>git-sync</code> sidecar에 마운트</li><li>위에서 이야기한 <code>git-sync</code> flag, args로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-ssh"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-repo=git@github.com:ddiiwoong/git-sync-demo.git"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-root=/usr/share/nginx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-dest=html"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-branch=master"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - "-depth=1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>nginx 기본 위치가 <code>/usr/share/nginx</code> 이므로 mount 위치를 git-sync-volume으로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><p>위 nginx를 배포하고 접속하면 <code>Hello git-sync demo v1.0</code>를 확인할 수 있다.</p><p>결국 git repo code (static html page)는 <code>/usr/share/nginx/html</code> 위치에 clone 되는것처럼 보이지만
실제 clone 위치를 확인해보면 symbolic link로 특정 revision dir를 가리키고 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it git-sync-demo-665c9c9ddf-6nwc4 sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulting container name to nginx.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use 'kubectl describe pod/git-sync-demo-665c9c9ddf-6nwc4 -n default' to see all of the containers in this pod.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # cd /usr/share/nginx/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 06:54 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 06:54 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 06:54 html -&gt; rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 06:54 rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.0&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>github에 있는 위 index.html 내용을 수정하고 commit을 하게 되면 실시간으로 아래와 같이 revision 정보 및 내용이 바뀐것을 확인할수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 13:40 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 13:40 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 13:40 html -&gt; rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 13:40 rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.1&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>git-sync를 간단하게 테스트해봤다.<br>
<!-- -->간단하게 <code>sidecar</code> 방식의 clone tool로서 <code>git-sync</code>를 활용하면 여러가지로 충분히 활용이 가능할 것이다.<br>
<!-- -->포스팅을 작성하면서 떠오른 활용용도를 정리하면 아래와 같다. 어찌보면 sidecar pattern의 활용방안이라고도 볼수 있다.</p><ul><li>CDN을 사용하지 않고 git에서 소규모로 컨텐츠를 가져올때</li><li>DBMS가 필요없을 정도의 적은 데이터를 가져올때</li><li>jekyll이나 hugo 같은 정적 사이트(블로그)의 sidecar 패턴 (GitPage처럼 markdown을 추가하고 git commit하면 바로 사이트에 반영되는 방식)</li><li>nginx, haproxy, apache와 같이 config 변경이 필요할때 webhook방식으로 설정을 변경한후 pod를 재기동하는 GitOps 구현</li></ul>]]></content>
        <category label="git-sync" term="git-sync"/>
        <category label="GitOps" term="GitOps"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="ssh git" term="ssh git"/>
        <category label="sidecar" term="sidecar"/>
        <category label="sidecar pattern" term="sidecar pattern"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[VScode Server]]></title>
        <id>/2019/03/20/vscode-server</id>
        <link href="https://ddii.dev/2019/03/20/vscode-server"/>
        <updated>2019-03-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[code-server를 사용하여 로컬 VScode 설치없이 원격 환경에서 사용해보자.]]></summary>
        <content type="html"><![CDATA[<p>IntelliJ IDEA를 사용하다가 개발업무를 거의 손놓다시피 하다보니 라이센스를 연장하지 못하게 되었고 주로 Local에서 VScode를 사용하고 있다. 현재 부서와 업무도 바뀌었고 워낙 고가다보니 IDE를 부서비로 구매하도 어렵다. 뭐 얼마나 한다고 말할수도 있겠지만 업무특성상 개발툴을 사달라고 할수 없고 최근 크롬북이나 아이패드 프로같은 태블릿을 가지고 다니시는 분들도 많고 단순 필기나 메모가 아닌 온라인 환경에서 블로깅 포스팅 정도는 할수 있다는 가정으로 Web IDE를 구성하는 포스팅을 시작해본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="web-ide">Web IDE<a class="hash-link" href="#web-ide" title="Direct link to heading">​</a></h2><p>이번 포스팅을 쓰기 시작하면서 2017년 AWS re;invent에선가 Cloud9 제품이 출시되어서 Lambda에서 사용했던 장면이 갑자기 떠올랐다. Cloud 9은 <a href="https://github.com/c9/core" target="_blank" rel="noopener noreferrer">https://github.com/c9/core</a>를 기반으로 instance를 띄는것을 기본으로 한다. Lambda의 기본 에디터도 나쁘진 않지만 Cloud9에서 강조하는 부분은 코드 협업이다. </p><p><img loading="lazy" src="https://d1.awsstatic.com/product-marketing/Tulip/C9-Collab-Image@3x.e03a65d9488633c154358430540ab363dd1e8f45.png" alt="cloud9" class="img_E7b_"></p><p>AWS에서 서비스로 출시되기 이전에도 Dockerhub에서도 종종 확인할수 있었지만 현재는 찾아보기 어렵다. </p><p>국내에는 Cloud 형태로 <a href="https://ide.goorm.io/" target="_blank" rel="noopener noreferrer">GoormIDE</a> 제품이 있다.<br>
<!-- -->Free 에디션도 있으니 따로 확인해보면 된다. (응원합니다!)</p><p>이외에도 <a href="https://github.com/theia-ide/theia" target="_blank" rel="noopener noreferrer">https://github.com/theia-ide/theia</a>, <a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server</a>와 같은 Web기반 오픈소스가 존재하고 둘다 상용이나 Beta형태로 서비스 중이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server">code-server<a class="hash-link" href="#code-server" title="Direct link to heading">​</a></h2><p><a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">code-server</a>는 원격서버 형태로 동작하는 브라우저 기반 <a href="https://github.com/Microsoft/vscode" target="_blank" rel="noopener noreferrer">VSCode</a> IDE이다.</p><p>그런데 왜 구지 VScode 설치형을 냅두고 Server로 구동하느냐? 아래와 같이 설명하고 있다.</p><ul><li>Chromebook, Table(IPAD) 에서 Coding 가능</li><li>저사양 Client에서도 Cloud 기반 Server의 이점 사용가능</li><li>Battery! (제일 중요포인트) </li></ul><p>구동방식은 여러방식이 존재한다. </p><ul><li>Hosted : <a href="https://coder.com/" target="_blank" rel="noopener noreferrer">coder</a> - Enterprise </li><li>Docker<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -t -p 127.0.0.1:8443:8443 -v "${PWD}:/root/project" codercom/code-server code-server --allow-http --no-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>Bianry<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ code-server &lt;initial directory to open&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server-kubernetes에-배포">code-server kubernetes에 배포<a class="hash-link" href="#code-server-kubernetes에-배포" title="Direct link to heading">​</a></h2><p>공식 <a href="https://hub.docker.com/r/codercom/code-server" target="_blank" rel="noopener noreferrer">Image</a>와 <a href="https://github.com/codercom/code-server/blob/master/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile</a>는 해당 링크를 참조한다.
살짝 변경해서 재빌드하려고 했는데 맥북 메모리가 부족한지 <code>yarn build</code>할때 <code>Serve fails with Error Code 137</code> 가 발생하였다. 이문제는 나중에 해결하기로 하고 일단 배포하자.  </p><p>로컬 minikube에서 테스트하기 위해<br>
<a href="https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml</a> 에서 ClusterIP를  NodePort로 수정하고 패스워드를 로그에서 확인하지 않고 사용할수 있도록 <code>1234</code>로 설정하고 배포한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploymentyaml">deployment.yaml<a class="hash-link" href="#deploymentyaml" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - port: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - image: codercom/code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - "--password=1234"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 서비스 확인 및 minikube service로 expose 시킨다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code-server   NodePort   10.111.206.64   &lt;none&gt;        8443:32665/TCP   15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  NAMESPACE  |     NAME      |             URL             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| code-server | code-server   | http://192.168.99.102:32665 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | git-sync-demo | http://192.168.99.102:31595 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | kubernetes    | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| kube-system | kube-dns      | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 URL로 접속하여 패스워드 <code>1234</code>를 입력하면 vscode가 원격으로 실행된 것을 확인할수 있다.
<img loading="lazy" alt="vscode" src="/assets/images/vscode-9cbf83b87dd9237022b17c9f3a7c07b2.png" width="1810" height="1263" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>실제 사용을 해보면 아직 버그가 많다. 애드온이나 플러그인 설치시 제대로 동작을 하지 않는 경우도 있었고
<a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a> 프로젝트와 연동을 통해 실제 gitOPS를 구현해보고자 하였으나 배포후에 mount된 repository volume에 변경사항이 발생시 갑자기 UI가 먹통이 되는 경우가 발생하기도 하였다. Kubernetes플랫폼을 개발자에게 PaaS형태로 제공하는 경우 webIDE의 좋은 옵션이 될수 있을것 같다.</p>]]></content>
        <category label="vscode" term="vscode"/>
        <category label="code-server" term="code-server"/>
        <category label="kubernetes" term="kubernetes"/>
        <category label="online coding" term="online coding"/>
        <category label="GoormIDE" term="GoormIDE"/>
        <category label="Cloud9" term="Cloud9"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[K3s on Raspberry Pi Cluster]]></title>
        <id>/2019/03/11/k3s-homelab</id>
        <link href="https://ddii.dev/2019/03/11/k3s-homelab"/>
        <updated>2019-03-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[이번 포스트에서는 k3s를 라즈베리파이 클러스터에 올려보고 활용방안에 대해서 고민해본다]]></summary>
        <content type="html"><![CDATA[<p>이번에는 경량 Kubernetes라고 이야기하는 <a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s</a>를 Raspberry Pi 클러스터상에 구동하려고 한다.
순수하게 개인의견으로 작성하였고 절대 제품이나 부품홍보를 하고자 하는 의도는 전혀 없다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s">K3s?<a class="hash-link" href="#k3s" title="Direct link to heading">​</a></h2><p><strong>K3s</strong>는 Rancher Lab에서 최소자원을 사용하는 Kubernetes 클러스터 구성을 위한 솔루션으로 시작되었고 2019년 3월 12일 현재 0.2버전이 릴리즈된 상태이다. 바이너리 전체가 40mb가 되지 않고 설치가 쉽다는 점에서 최근 트위터 상에서 이슈가 되고 있는 프로젝트라고 할 수 있다. </p><p>주로 Edge, IoT 등 저전력, 저사양 기반 ARM계열 컴퓨팅에 최적화 되어 있고 실제 실험적이긴 하지만 간단한 기능이나 baremetal 기반 클러스터 테스트를 집에서 해보기에는 딱 좋은 프로젝트라 할 수 있다. 이미 vSphere, OpenStack기반으로 테스트는 차고 넘치게 해봤지만 일단 물리적인 케이스부터 보고나면 하드웨어를 좋아하는 사람들에게는 아주 재미있는 장난감이 아닐수 없을 것이다. </p><p><a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s Github</a> 상세 설명에 보면 Cloud Provider, Storage Plugin은 제거하였고  default 저장소가 <code>etcd</code>가 아닌 <code>sqlite3</code>으로 되어있다고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-준비사항">사전 준비사항<a class="hash-link" href="#사전-준비사항" title="Direct link to heading">​</a></h2><ul><li><p>최소 2개 이상의 Raspberry Pi 2B/3B/3B+, 4ea<br>
<!-- -->오픈마켓에서 할인쿠폰 적용해서 Raspberry Pi 3B+, 4ea를 <code>166,820원</code>(대당 42,000원) 정도에 구매하였다.<br>
<!-- -->최저가 검색으로 대당 46,000원 정도 했던것 같다. </p></li><li><p>Stackable Case<br>
<a href="https://www.amazon.com/gp/product/B07CTG5N3V/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&amp;psc=1" target="_blank" rel="noopener noreferrer">iUniker Raspberry Pi Cluster Case</a> 강추!! (개인적으로 쿨러와 디자인이 맘에 듬)<br>
<!-- -->배송비포함 29.19달러, 약 <code>33,000원</code></p></li><li><p>micro SDHC 4ea<br>
<!-- -->16GB로도 충분하지만 삼성전자 micro SDHC CLASS10 UHS-I EVO (32GB), 4ea를 오픈마켓에서 사게되면 배송료 포함해서 8,500원 * 4ea = <code>34,000원</code>에 구매가 가능하다. 오픈마켓에서는 개당 배송료를 내야한다. 하지만 쿠팡에서는 2ea를 로켓배송으로 15,380원에 구매가 가능하므로 약 <code>31,000원</code>에 4개를 구매할수 있다. </p></li><li><p>멀티충전기<br>
<!-- -->1만원대 후반에서 2만원 초반이면 6포트 충전기를 구매할수 있는데 구매했던 가장 큰 기준은 Pi 4대를 동시에 2.5A 전류를 안정적으로 공급하려면 최대 10A를 지원하는 멀티 충전기를 사야했었고 4-5포트 짜리 충전기들은 대부분 최대 전류가 8A로 충족하지 못해 4포트만 사용하더라도 안정적인 전류 공급을 위해 6포트 충전기로 선택하였다.<br>
<!-- -->쿠팡 로켓배송 - 포*지 가정용 6포트 급속 멀티 충전기, <code>22,900원</code></p></li><li><p>micro 5pin 20cm 2.4A 지원 케이블 4ea<br>
<!-- -->Pi 권장 전류가 2.5A라고 했지만 2.4A, 3A 짜리중에 저렴한 2.4A 지원 숏케이블로 구매하였다.<br>
<!-- -->오픈마켓에서 배송료 포함, <code>7800원</code></p></li><li><p>UTP Cat5e 30cm 케이블 4ea<br>
<!-- -->그냥 제일싼걸로 오픈마켓에서 배송료 포함 <code>4,100원</code>에 구매하였다.</p></li><li><p>기가비트 지원되는 5포트 이상 스위치 허브(공유기)<br>
<!-- -->집에 있던 공유기 활용 (iptime A1004) 하였지만 최저 5포트 이상 스위치 허브중 제일 싼 모델은 <code>16,000원</code>대로 가격 형성중이다. </p></li></ul><p>실제 위 스펙으로 대충 구매를 진행하게 되면 18.4 + 3.3 + 3.1 + 2.3 + 0.8 + 0.4 + 1.6 = <code>29.9만원</code> 정도 소요가 될 것으로 예상된다. 집에 굴러다는 부품이나 충전기, 케이블, SD카드들을 활용하면 <code>25만원</code> 이내로도 충분히 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구매-제품-조립">구매 제품 조립<a class="hash-link" href="#구매-제품-조립" title="Direct link to heading">​</a></h2><p>조립은 그다지 어렵지 않은데 케이스 구매시 제공되는 방열판(CPU, GPU, RAM)을 꼼꼼하게 붙이고 쿨러를 GPIO에 연결한다.<br>
<!-- -->그렇게 어려운 점은 없지만 본체를 케이스에 고정할때 너트가 작아 손이 큰 사람은 조금 힘들 수도 있을 것 같다. </p><p>케이스의 CPU 쿨러가 화룡점정이다.</p><p><img loading="lazy" alt="cases" src="/assets/images/cases-614af9823c3d08feb1cdfd6feecda887.jpg" width="1224" height="689" class="img_E7b_"><br>
<img loading="lazy" alt="heat" src="/assets/images/heat-7b312fa5a5ca45bc55e98323ffdbb690.jpg" width="689" height="1224" class="img_E7b_"><br>
<img loading="lazy" alt="cooler" src="/assets/images/cooler-01a1339b8c2d113ec8cdd527cd9a51f8.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="3stack" src="/assets/images/3stack-c5510bb36fd5f49a56c318a4a175f3fb.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="charger" src="/assets/images/charger-fbc5086db8ea25c819ef915b0f298f5e.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="full" src="/assets/images/fullstack-a0ea32c22662582ec85641753804eaf0.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="complete" src="/assets/images/complete-8db0eac9257463f0ad669a0bc12541ef.jpg" width="1224" height="689" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="os-설치">OS 설치<a class="hash-link" href="#os-설치" title="Direct link to heading">​</a></h2><p>SD카드에 설치는 MacOS상에서 진행하였다.</p><p><a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="noopener noreferrer">Raspbian Lite</a>를 내려받아 <a href="https://www.balena.io/etcher/" target="_blank" rel="noopener noreferrer">Etcher</a>를 사용하여 OS를 설치한다. </p><p>자세한 추가적인 설치방법은 다음 링크를 통해서도 확인이 가능하다.<br>
<a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md" target="_blank" rel="noopener noreferrer">Installing operating system images</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="환경-설정">환경 설정<a class="hash-link" href="#환경-설정" title="Direct link to heading">​</a></h2><p>Mac에서는 <code>/Volumes/boot</code>에 마운트가 된다. OS마다 다르지만 Linux에서는 <code>/mnt/boot</code>, Windows에서는 <code>boot</code> 로 마운트가 된다.</p><p>SSH Service 자동 활성화를 위해 위 OS별 mount된 root 경로에 ssh 빈 파일을 생성하게 되면 reboot이후에 SSH 접속이 가능해진다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo touch /Volumes/boot/ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또한 container 사용을 위해 root경로의 <code>cmdline.txt</code> 파일 마지막에 cgroup 설정을 추가한다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cgroup_memory=1 cgroup_enable=memory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>SD카드를 만들고 각각의 Pi에 장착후에 UTP케이블과 전원을 모두 연결한다.
부팅이 완료되면 default id/pass 인 <code>pi/raspberry</code>로 로그인 하고 <code>sudo raspi-config</code> 를 통해 패스워드 변경, hostname 설정, GPU memory split 설정 등을 완료하자.<br>
<!-- -->나중에는 PXE booting 및 ansible 자동화로 구현하면 무인환경 설치가 가능할것 같다. (Edge Computing)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────┤ Raspberry Pi Software Configuration Tool (raspi-config) ├────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        1 Change User Password Change password for the current user                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        2 Network Options      Configure network settings                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        3 Boot Options         Configure options for start-up                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        4 Localisation Options Set up language and regional settings to match your location       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        5 Interfacing Options  Configure connections to peripherals                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        6 Overclock            Configure overclocking for your Pi                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        7 Advanced Options     Configure advanced settings                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        8 Update               Update this tool to the latest version                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        9 About raspi-config   Information about this configuration tool                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           &lt;Select&gt;                           &lt;Finish&gt;                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>1 Change User Password</li><li>2 Network Options - hostname<ul><li>k3s-master, k3s-slave-01, k3s-slave-02, k3s-slave-03</li></ul></li><li>4 Localisation Options - TimeZone<ul><li>Asia, Seoul</li></ul></li><li>7 Advanced Options - GPU Memory split <ul><li>16mb</li></ul></li></ul><p>모두 완료가 되었으면 pi들을 재기동하자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo reboot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s-클러스터-생성">k3s 클러스터 생성<a class="hash-link" href="#k3s-클러스터-생성" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="server-기동">Server 기동<a class="hash-link" href="#server-기동" title="Direct link to heading">​</a></h3><p>armhf(arm hard float) 지원이 되는 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Master node 기동 (백그라운드)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s server &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 node를 Control plane 형태로 분리시켜 workload에서 제외하려면 <code>--disable-agent</code> 옵션을 사용한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&amp; k3s server --disable-agent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 k3s 기동이 완료되면 <code>/etc/rancher/k3s/k3s.yaml</code>에서 Kubeconfig를 확인할수 있다. 그리고 node 상태도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   21h   v1.13.4-k3s.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="node-추가">node 추가<a class="hash-link" href="#node-추가" title="Direct link to heading">​</a></h3><p><code>/var/lib/rancher/k3s/server/manifests</code> 에서 TOKEN을 확인한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo cat /var/lib/rancher/k3s/server/node-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>worker node에 접속한다음 동일하게 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 나온 TOKEN값과 Kube API Endpoint정보로 node들을 차례로 추가 시키면 모든 작업이 완료된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export NODE_TOKEN="K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export MASTER_IP="https://192.168.0.14:6443"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s agent --server https://${MASTER_IP}:6443 --token ${NODE_TOKEN} &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>완성된 클러스터를 확인한다. 외부 로컬에서 확인하려면 <code>/etc/rancher/k3s/k3s.yaml</code> 파일을 <code>~/.kube/config</code>에 추가하면 된다. 클러스터 내부에서 kubectl 명령은 k3s 바이너리 내부에 포함되어 있으므로 <code>sudo k3s kubectl</code> 명령을 사용하였다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   22h   v1.13.4-k3s.1   192.168.1.14   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave01   Ready    &lt;none&gt;   21h   v1.13.4-k3s.1   192.168.1.15   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave02   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.16   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave03   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.17   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>node 상세정보를 보면 기본적으로 K8s <code>v1.13.4</code>, runtime은 <code>containerd</code>를 사용하고 있음을 알 수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get svc --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME         TYPE           CLUSTER-IP     EXTERNAL-IP                 PORT(S)                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default       kubernetes   ClusterIP      10.43.0.1      &lt;none&gt;                      443/TCP                      21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns     ClusterIP      10.43.0.10     &lt;none&gt;                      53/UDP,53/TCP,9153/TCP       21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik      LoadBalancer   10.43.19.160   192.168.1.14,192.168.1.15   80:32304/TCP,443:31690/TCP   21h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Rancher쪽에서도 오늘날짜(3/12)로 F5가 Nginx를 인수하는것을 예견했던 것일까?<br>
<!-- -->Service를 확인하면 traefik이 기본으로 되어있다. 아래처럼 기본적으로 loadbalancer로 활용되고 있는 traefik을 Helm Chart CRD를 통해 배포된것을 확인할 수 있다. 또한 얼마전 졸업한 CoreDNS도 보인다.   </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                             READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   coredns-7748f7f6df-qflx9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   helm-install-traefik-dqqg9       0/1     Completed   0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-4xtkf   2/2     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-vbsqv   2/2     Running     0          19h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik-6876857645-2sqg9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get crd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            CREATED AT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addons.k3s.cattle.io            2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helmcharts.k3s.cattle.io        2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listenerconfigs.k3s.cattle.io   2019-03-11T16:46:22Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>아주 적은비용(?)으로 취미삼아 k3s 클러스터를 구성해봤다.<br>
<!-- -->아직 ARM계열에서 kubernetes workload를 구동하는 것은 시기상조이긴 하지만 기존에 kubeadm을 가지고 pi에 배포하는것에 비하면 설치 난이도나 자원사용량 측면에서 장점이 많은 프로젝트이다.<br>
<!-- -->해외 블로그나 트위터를 보면 최근 <code>k3s</code>에 대한 관심도가 높아지는것을 확인할 수 있는데 단순히 취미생활만이 아니라 IoT, Edge에서의 Serverless Workload 수행이라던지 ARM 계열 최적화된 모습만으로도 충분히 가능성은 보여준것 같다.<br>
<!-- -->Rancher 2.0 이후로 Kubernetes 연관된 관심도가 떨어졌었는데 엔지니어들의 관심을 끄는데는 성공한듯 하고 AWS의 Greengrass, Firecracker와 동일선상에서 봐도 견줄만한 가치가 있다고 생각된다.</p>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Rancher" term="Rancher"/>
        <category label="K3s" term="K3s"/>
        <category label="Raspberry" term="Raspberry"/>
        <category label="Homelab" term="Homelab"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cloud-Native Microservices Demo Application with OpenCensus]]></title>
        <id>/2019/03/07/microservices-demo</id>
        <link href="https://ddii.dev/2019/03/07/microservices-demo"/>
        <updated>2019-03-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hipster Shop: Cloud-Native Microservices Demo Application 를 살펴보고 안에 들어있는 여러가지 오픈소스들을 알아본다]]></summary>
        <content type="html"><![CDATA[<p><a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/microservices-demo</a>에서 소개된 Demo Application인 <code>Hipster Shop</code>을 Kubernetes 기반으로 배포하고 관련 오픈소스들을 더 알아보고자 한다.</p><p>위 링크에 가서 보면 알수 있지만 <code>Hipster Shop</code> 아래 그림처럼 10개의 Microservice로 구성되어 있고 상품을 검색 및 구매할 수있는 웹 기반 이커머스 Application으로 구성 되어있다.</p><p><img loading="lazy" src="https://github.com/GoogleCloudPlatform/microservices-demo/raw/master/docs/img/architecture-diagram.png" alt="arch" class="img_E7b_"></p><p>각각의 서비스는 <strong>gRPC</strong> 로 통신하고 외부 사용자만 HTTP로 접근한다. 모든 서비스는 서로 다른 언어(Go, C#, Node.js, Python, Java)로 구성되어 있고 대부분의 Microservice들은 <code>Istio</code> service mesh 형태로 구성할수 있도록 되어있다. <code>Skaffold</code>를 통해 배포하고 <code>OpenCensus</code>라고 하는 gRPC/HTTP기반 Tracing tool을 활용하여 Google <code>Stackdriver</code>로 보내도록 되어있지만  Prometheus에 통합하는 방향으로 작성하기 위해서 Prometheus 기반으로 Metric을 수집하는 Fork된 데모 Application을 검색을 통해 찾을수 있었다.<br>
<a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/census-ecosystem/opencensus-microservices-demo</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opencensus">OpenCensus<a class="hash-link" href="#opencensus" title="Direct link to heading">​</a></h2><p><a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">OpenCensus(OC)</a>는 Microservice 및 Monolith 서비스를 Tracing 및 Metric Monitoring 할 수 있는 라이브러리를 제공하는 오픈소스이다.</p><p>아래와 같이 다양한 언어를 지원 한다.</p><ul><li>Java , Go, Python, C++, Nodejs, Erlang, Ruby, PHP, C#</li></ul><p>또한 수집된 데이터를 Prometheus, Stackdriver Tracing and Monitoring, DataDog, Graphite, Zipkin, Jaeger, Azure Insights 등 과 같은 백엔드 Application으로 내보낼 수 있기 때문에 개발자, 운영자 측면에서 좋은 선택사항이 될 수 있다.  </p><p>Microservice와 같은 분산 시스템에서 개발자/운영자 관점의 가장 중요한 미션은 각각의 수행되는 서비스들의 실행 시간을 확인하고 상호 API간 통신이 얼마나 걸리는지를 확인하고 Span(아래 그림참조)에서 가장 지연이 발생하는 서비스를 빨리 찾아내 확인하고 조치하는 것이라 할 수 있다.</p><p><img loading="lazy" src="https://www.jaegertracing.io/img/spans-traces.png" alt="span" class="img_E7b_"></p><p>OpenCensus는 주로 두가지 기능으로 활용된다.<br>
<!-- -->첫번째는 Metric 수집이고 두번째는 Tracing 기능이다.<br>
<!-- -->Log같은 경우 현재 미지원이지만 다음 메이저 릴리즈에 추가될 예정이라고 하니 조금더 지켜보면 좋을것 같다.</p><ul><li><p>Metrics</p><ul><li>데이터베이스 및 API의 응답시간, 요청 content length, open file descriptor 수와 같이 추적하고자하는 정량 데이터를 말한다. Metric 을 시각화해서 보면 응용 프로그램 및 서비스의 성능과 품질을 측정하는 데 도움이 될 수 있다. 예를 들면 요청 응답시간의 평균값이나 cache hit/miss 수와 같은 것들이 될 수 있다. </li></ul></li><li><p>Traces</p><ul><li>서비스 요청에 대한 애플리케이션 또는 서비스 구조를 확인할수 있고 모든 서비스 간 데이터 흐름을 시각화하여 아키텍처상의 병목 현상을 파악하는 데 도움이 된다.</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hipster-shop-demo">Hipster Shop Demo<a class="hash-link" href="#hipster-shop-demo" title="Direct link to heading">​</a></h2><p>위에서 언급했던 내용처럼 GCP에서 작성한 <a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">Hipster Shop Demo</a>는 minikube 및 GCP 데모로 되어있고 코드안에 기본 Metric 설정이 Stackdriver으로 되어있어 Prometheus Exporter 적용을 하려면 코드 수정이 필요하기 때문에 Prometheus기반으로 작성된 <a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">Forked Repo</a>를 살펴보기로 하였다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h3><p>현재 가지고 있는 MacOS 환경에서 구동하였다. 최소 스펙은 따로 기재하지 않았으나 K8s 1.11 이상을 권장한다.</p><ul><li>kubectl : v1.10.7</li><li>Minikube : v0.34.1</li><li>Kubernetes : v1.13.3</li><li><a href="https://github.com/GoogleContainerTools/skaffold/#installation" target="_blank" rel="noopener noreferrer">skaffold</a> : v0.24</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="minikube-기동">minikube 기동<a class="hash-link" href="#minikube-기동" title="Direct link to heading">​</a></h3><p>최소 3 CPU, 6Gb Memory가 필요하다. 그냥 minikube를 구동시기면 4 CPU, 8Gb 로 구동이 되기 때문에 별다른 옵션 없이 default로 구동하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minikube   Ready     master    6h        v1.13.3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="repository-clone">Repository Clone<a class="hash-link" href="#repository-clone" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/census-ecosystem/opencensus-microservices-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> opencensus-microservices-demo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>내부 구조를 살펴보면 기본적으로 <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank" rel="noopener noreferrer">skaffold</a>를 활용하여 배포를 진행을 하는 것을 알수있다.<br>
<code>skaffold</code>는 로컬에서 Kubernetes 기반 어플리케이션 개발과 배포(CD)를 빠르게 도와주는 CLI tool이다. 소스코드의 변화를 감지하여 build, registry push/tagging, deploy까지 자동으로 할 수 있는 로컬 기반 도구이다.</p><p><code>skaffold dev</code>는 로컬 환경의 반복적인 개발에 활용하고 실제 배포는 CI Process에서 <code>skaffold run</code>을 통해 배포를 진행할 수 있다.  </p><p><img loading="lazy" src="https://github.com/GoogleContainerTools/skaffold/raw/master/docs/static/img/intro.gif" alt="skaffold demo" class="img_E7b_"></p><p>Kubernetes 배포툴에 대해 비교한 글은 <a href="https://blog.hasura.io/draft-vs-gitkube-vs-helm-vs-ksonnet-vs-metaparticle-vs-skaffold-f5aa9561f948/" target="_blank" rel="noopener noreferrer">블로그 링크</a>를 통해 확인할 수 있다.</p><p>아래에서는 <code>skaffold</code>에 대한 자세한 내용은 미뤄두고 배포하는 도구로서만 설명한다.  </p><p>기본적으로 구성을 하고자 하는 내용은 helm처럼 template 파일을 사용하게 되는데 프로젝트 root에 <code>skaffold.yaml</code> 에 build를 위한 image name, tag, src 위치등 기본적인 내용을 기재한다. 파일내용을 살펴보면 build에 관련된 내용들을 작성하고 deploy할 manifests의 위치까지 지정하도록 되어있다. 로컬환경에서 확인을 위해 grafana, prometheus, jaeger가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skaffold/v1alpha2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tagPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gitCommit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">artifacts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">manifests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manifests/</span><span class="token important">**.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Go로 작성된 Frontend microservice을 살펴보자. <!-- -->[<strong>./src/frontend/main.go</strong>]</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="library-추가-및-http-handler-초기화">library 추가 및 http handler 초기화<a class="hash-link" href="#library-추가-및-http-handler-초기화" title="Direct link to heading">​</a></h3><p>Go기반 exporter 패키지(jaeger,prometheus)를 추가적으로 import 하고 http handler를 위한 <a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener noreferrer">ochttp 패키지</a>를 추가하였다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"go.opencensus.io/exporter/jaeger"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"go.opencensus.io/exporter/prometheus"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"go.opencensus.io/plugin/ochttp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"go.opencensus.io/plugin/ochttp/propagation/b3"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> handler http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">logHandler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensureSessionID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// add opencensus instrumentation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ochttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Propagation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPFormat</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"starting server on "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> addr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvPort</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">":"</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">srvPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="exporter-등록jaeger-tracing-및-prometheus-exporter">exporter 등록(Jaeger Tracing 및 Prometheus exporter)<a class="hash-link" href="#exporter-등록jaeger-tracing-및-prometheus-exporter" title="Direct link to heading">​</a></h3><p>예시처럼 각각의 서비스에 jaeger와 prometheus exporter Endpoint를 쉽게 등록할수 있다.<br>
<!-- -->또한 initTracing() 에서는 데모를 위해 trace.AlwaysSample()을 사용하였다. 실제 운영환경에서는 <a href="https://github.com/census-instrumentation/opencensus-specs/blob/master/trace/Sampling.md" target="_blank" rel="noopener noreferrer">다음 링크</a>를 참고해서 사용하는 것을 권고하고 있다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Register the Jaeger exporter to be able to retrieve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// the collected spans.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http://jaeger:14268"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Process</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Process</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ServiceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"frontend"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is a demo app with low QPS. trace.AlwaysSample() is used here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// to make sure traces are available for observation and analysis.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In a production environment or high QPS setup please use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// trace.ProbabilitySampler set at the desired probability.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ApplyConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DefaultSampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initPrometheusStatsExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"error registering prometheus exporter"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startPrometheusExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":9090"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"starting prometheus server at %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="demo-application-배포">Demo Application 배포<a class="hash-link" href="#demo-application-배포" title="Direct link to heading">​</a></h3><p>minikube에 Hipster Shop Demo를 배포한다. 단순하게 <code>skaffold run</code> 명령으로 진행하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold run</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 사용중인 2018 Macbook Pro(3.1 GHz Intel Core i7, 16GB) 상의 Docker기반 minikube 환경으로도 배포를 하였는데 시간이 꽤 소요되었다.(20분이상)<br>
<!-- -->코드를 실시간으로 수정하고 빌드, 배포되는 것은 <code>skaffold dev</code> 명령으로 확인할 수 있다. 진행되는 과정을 보면 <a href="https://draft.sh/" target="_blank" rel="noopener noreferrer">draft.sh</a> 프로젝트와도 꽤 유사하다고 볼 수 있다.  </p><p>에러없이 run이 실행되고 난후 minikube에 배포된 pod와 service를 확인한다. 중간에 loadgenerator가 init인 이유는 minikube 자원이 부족해서 발생하는 현상이다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS     RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice-7c7d687dcb-xzr4m               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice-f54bcb9ff-tcfgn              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice-576446687b-95bwj         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice-5bd99bf97d-28mtz         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice-6cb587798d-wwzdh            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-6bf9796f7b-ch9pl                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-6678c5c5d9-2qx75                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-5b66bdf7f7-csdzx                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loadgenerator-7c4f446774-68djg           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1       Init:0/1   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice-fc4c8589-wrfg7            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice-84878c8b9c-jhgnw   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-58d98b7578-87td6              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice-8564f9d894-smlpf   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart-798bc66d58-xn6ff              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice-789656f6bc-rgzrp         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice               ClusterIP      </span><span class="token number" style="color:#36acaa">10.107</span><span class="token plain">.196.115   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9555</span><span class="token plain">/TCP,9090/TCP                                                  4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice             ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.151.164    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7070</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.9.197      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5050</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.112.225   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice            ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.184.174    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend                ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.40.138    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP,9090/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-external       LoadBalancer   </span><span class="token number" style="color:#36acaa">10.108</span><span class="token plain">.170.241   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:31944/TCP                                                       4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana                 ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.141.254   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-external        LoadBalancer   </span><span class="token number" style="color:#36acaa">10.102</span><span class="token plain">.166.138   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:30459/TCP                                                     4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger                  ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.71.173     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain">/TCP,5775/UDP,6831/UDP,6832/UDP,5778/TCP,16686/TCP,14268/TCP   4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-external         LoadBalancer   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.164.126    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">16686</span><span class="token plain">:32362/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes              ClusterIP      </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.1        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                                                            6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice          ClusterIP      </span><span class="token number" style="color:#36acaa">10.109</span><span class="token plain">.31.241    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.124.106   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3550</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus              ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.107.213   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.225.28    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart              ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.24.157    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">6379</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.224.18    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="서비스-접속-및-metrictracing-확인">서비스 접속 및 Metric/Tracing 확인<a class="hash-link" href="#서비스-접속-및-metrictracing-확인" title="Direct link to heading">​</a></h3><p>로컬 minikube환경이기 때문에 external service가 pending이므로 service를 minikube NAT IP로 expose 시킨다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> frontend-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> grafana-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> jaeger-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAMESPACE  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         NAME          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">             URL             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> adservice             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cartservice           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> checkoutservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> currencyservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> emailservice          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend-external     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:31944 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana-external      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:30459 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger-external       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:32362 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubernetes            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paymentservice        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> productcatalogservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> prometheus            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> recommendationservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> redis-cart            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shippingservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-system </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-dns              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3개의 서비스로 각각 접속이 되는것을 확인할수 있다.
Grafana 대시보드로 들어가면 현재 수집되는 prometheus source(http://prometheus:9090)를 통해 OpenCensus기반 Application Metric을 확인할 수 있다.</p><p><img loading="lazy" alt="hipster_grafana" src="/assets/images/hipster_grafana-13ab198ab40c06a5c6ba6bc61e3725ad.png" width="2878" height="1488" class="img_E7b_"></p><p>그림에서 보면 전체 서비스 응답에 대한 99% 백분위 지연시간이 944ms 인것을 확인할 수 있다. </p><p>또한 Jaeger를 통해 DAG(Directed acyclic graph) 및 서비스간 Tracing 을 확인할 수 있다.</p><p><img loading="lazy" alt="DAG" src="/assets/images/dag-0e49356be3f8676a292785832fbc1981.png" width="3146" height="1782" class="img_E7b_"></p><p><img loading="lazy" alt="tracing" src="/assets/images/tracing-b9038c7a3151b467c5f7d4dc08786f75.png" width="3172" height="1442" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>OpenCensus 기반으로 개발자가 코드를 작성하고 Microservice를 minikube에서 배포하고 Prometheus, Jaeger Exporter 연동을 통해 시스템뿐만이 아닌 Application기반 Metrics/Stats을 수집하고 개발자가 작성한 코드를 직접 Tracing하는 간단한 데모를 진행하였다. (Istio를 포함해서 Public환경에 배포해봐도 좋은 공부가 될 것 같다)  </p><p>향후 <a href="https://openmetrics.io/" target="_blank" rel="noopener noreferrer">OpenMetric</a>과 <a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">Opencensus</a>가 실제 개발자 기반으로 활성화되고 적용이 된다면 Telemetric 측면에서 많은 Use-Case가 도출될 수 있을것 같다.  </p><p>위에서 언급했듯이 Prometheus기반 Kubernetes 클러스터를 운영하고 있는 팀의 경우 개발자의 작성 코드를 최소화할 수 있는 도구로서 충분히 활용될 수 있어 보인다.  </p><p>꼭 Cloud Native 기반 Web 개발이 아니더라도 기존 공장, 금융, 병원 등 의 IoT나 센서/설비를 위한 비즈니스에도 Backend로서 확장성있는 도구로서 활용이 될 수 있을것 같다.</p>]]></content>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Istio" term="Istio"/>
        <category label="Stackdriver" term="Stackdriver"/>
        <category label="Prometheus" term="Prometheus"/>
        <category label="gRPC" term="gRPC"/>
        <category label="OpenCensus" term="OpenCensus"/>
        <category label="skaffold" term="skaffold"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Knative with Gloo]]></title>
        <id>/2019/02/28/knative-using-gloo</id>
        <link href="https://ddii.dev/2019/02/28/knative-using-gloo"/>
        <updated>2019-02-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Istio에 종속되어있는 Knative가 아닌 경량화된 Ingress 오픈소스 Gloo를 활용한 Knative 설치 및 활용]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-routing">Knative Routing<a class="hash-link" href="#knative-routing" title="Direct link to heading">​</a></h2><p>Knative는 앞에서도 몇번 언급하였지만 기본적으로 <code>Routing</code>을 사용하여 외부에 노출할 서비스들에 대한 HTTP Endpoint를 제공한다. 어떻게 보면 기본적으로 API Gateway 역할을 하기도 하고 Ingress 역할을 하기도 한다. 보통 Service mesh인 <code>Istio</code>를 사용하여 ingress를 구현하는것이 당연하다고 생각하기도 하지만 Istio의 모든 기능이 Knative에 필요하지는 않고 설치되는것 자체가 리소스 소모가 꽤 된다는것은 설치 해본사람은 알고 있을것이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="service">Service<a class="hash-link" href="#service" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes">Kubernetes<a class="hash-link" href="#kubernetes" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://www.nginx.com/wp-content/uploads/2017/09/NGINX-Plus-Features-Kubernetes-Ingress-Controller-644x372@2x.png" alt="ingress" class="img_E7b_"><br>
<!-- -->이미지출처 : <a href="https://www.nginx.com/blog/announcing-nginx-ingress-controller-for-kubernetes-release-1-3-0/" target="_blank" rel="noopener noreferrer">https://www.nginx.com/blog/announcing-nginx-ingress-controller-for-kubernetes-release-1-3-0/</a></p><p>Kubernetes에서는 일반적으로 서비스 접속을 구현하게 되면 기본적으로 Pod와 Service를 생성하고 Ingress를 사용하여 클러스터 내부로 들어오는 트래픽을 처리하게 된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative">Knative<a class="hash-link" href="#knative" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://i1.wp.com/blog.openshift.com/wp-content/uploads/intro.png?w=499&amp;ssl=1" alt="Serving" class="img_E7b_"><br>
<!-- -->이미지출처 : <a href="https://blog.openshift.com/knative-serving-your-serverless-services/" target="_blank" rel="noopener noreferrer">https://blog.openshift.com/knative-serving-your-serverless-services/</a></p><p>Knative에서는 앞선 Knative 관련 포스팅에서도 설명했듯이 <code>Automatic scaling up and down to zero</code> 특성을 가지고 있기에 Pod가 최초 실행되어있지 않은 상태에서 트래픽이 들어오게 되면 <a href="https://github.com/knative/serving/blob/master/docs/scaling/DEVELOPMENT.md" target="_blank" rel="noopener noreferrer">Knative Serving Activator</a>에 의해서 Pod가 없는 Revision을 확인하고 Cold Start 형태로 프로비저닝하게 된다. 나는 이게 진정한 서버리스라고 생각하지만 주변에 반박하시는 분들도 간혹 있다.</p><p>이후 Pod가 Warm 상태가 되고 나면 Istio Route(Ingress Gateway)를 통해 트래픽이 Pod로 전달되어 통신이 이뤄지게 된다.</p><p>현재 Knative는 현재 Ingress Gateway 의존성을 가지고 있고 Envoy기반 Service Mesh인 <code>Istio</code>, Envoy기반 API Gateway인 <code>Gloo</code> 두가지 옵션으로 Ingress 구현이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio">Istio<a class="hash-link" href="#istio" title="Direct link to heading">​</a></h2><p>Knative는 기본적으로 Ingress Gateway기능을 탑재하고 있는데 이는 Istio의 기능중 하나다.<br>
<!-- -->Istio는 다음과 같은 Core Feature를 가진다. 상세한 내용은 <a href="https://istio.io/docs/concepts/what-is-istio/" target="_blank" rel="noopener noreferrer">https://istio.io/docs/concepts/what-is-istio/</a> 에서 확인하면 된다.</p><ul><li>Traffic management</li><li>Security</li><li>Policies and Telemetry</li><li>Performance and Scalability</li></ul><p>Istio는 48개의 <code>CRDs</code>(CustomResourceDefinition objects)를 가지고 있는데 이중 Knative Serving에서 사용하는건 <code>VirtualService</code> 단 하나다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gloo">Gloo<a class="hash-link" href="#gloo" title="Direct link to heading">​</a></h2><p><a href="https://gloo.solo.io/" target="_blank" rel="noopener noreferrer">Gloo</a>는 Kubernetes-native ingress controller이자 <a href="https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600" target="_blank" rel="noopener noreferrer">Next Generation API Gateway</a> 를 위해 시작된 프로젝트이다. 실제 Redhat에서 Openshift기반 Microservice 및 Istio 개발업무를 하다가 최근에 solo.io의 CTO로 이직한 <a href="https://blog.christianposta.com/" target="_blank" rel="noopener noreferrer">Christian Posta</a>가 밀고 있는 프로젝트이기도 하다. </p><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/0*Z0Jb5DJFOyeY91sN." alt="gloo" class="img_E7b_"></p><p><code>Gloo</code>는 Envoy Proxy 기반으로 동작하며
기존 Legacy부터 Container서비스, FaaS(AWS Lambda, Azure Functions, GCP Functions)영역의 Application들을 REST, gRPC, SOAP, Web Socker기반으로 Aggregate 해서 Function 기반 추상화를 구현해 주는 오픈소스 프로젝트라 정의 할 수 있다. </p><p>Istio의 Ingress기능외의 여러가지 부가 기능(Telemetry, Security, Policy Enforcement)들은 Knative에서는 필요로 하지 않는다. </p><p>Knative API Gateway 로서 Istio가 아닌 Gloo가 조금더 경량화된 대안으로 결정되었고 Gloo를 통해 Knative 설치가 가능하게 되었다. 단, Knative Eventing 컴포넌트는 현재 지원하지 않는다고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-knative-with-gloo">Install Knative with Gloo<a class="hash-link" href="#install-knative-with-gloo" title="Direct link to heading">​</a></h2><p>참고: <a href="https://github.com/knative/docs/blob/master/install/Knative-with-Gloo.md" target="_blank" rel="noopener noreferrer">Install with Gloo</a></p><p>간단하게 gloo와 Knative 설치를 해보자.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h3><ul><li>Kubernetes cluster v1.11 or newer </li><li>Enable <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#how-do-i-turn-on-an-admission-controller" target="_blank" rel="noopener noreferrer">MutatingAdmissionWebhook admission controller</a></li><li>kubectl v1.10 or newer</li><li>Bash in Mac or Linux</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-glooctl">Install Glooctl<a class="hash-link" href="#install-glooctl" title="Direct link to heading">​</a></h3><p>gloo CLI (glooctl) Download<br>
<a href="https://github.com/solo-io/gloo/releases" target="_blank" rel="noopener noreferrer">https://github.com/solo-io/gloo/releases</a></p><p>또는 직접 Download</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -sL https://run.solo.io/gloo/install | sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to download glooctl version v0.8.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading glooctl-darwin-amd64...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Download complete!, validating checksum...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checksum valid.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gloo was successfully installed 🎉</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add the gloo CLI to your path with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export PATH=$HOME/.gloo/bin:$PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Now run:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install gateway     # install gloo's function gateway functionality into the 'gloo-system' namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Please see visit the Gloo Installation guides for more:  https://gloo.solo.io/installation/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>PATH 등록</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export PATH=$HOME/.gloo/bin:$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>gloo CLI 확인</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glooctl version 0.8.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>GCP 무료플랜으로 3-node 클러스터를 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcloud container clusters create gloo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region=asia-east1-a \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cluster-version=latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type=n1-standard-2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-autorepair \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --num-nodes=3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cluster 생성된것을 확인하고 cluster-admin 권한을 할당한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-f8v9   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-fl78   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-gfgw   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create clusterrolebinding cluster-admin-binding \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;   --clusterrole=cluster-admin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;   --user=$(gcloud config get-value core/account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your active configuration is: [cloudshell-25974]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io "cluster-admin-binding" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Gloo와 Knative 설치를 한다. 미리 <code>glooctl install knative --dry-run</code> 으로 전체 manifest를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl install knative</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 설치 과정은 생략했지만 Istio에 비해 CRD 개수가 적은 것을 알수있다. 또한 설치된 컴포넌트 역시 Istio에 비해서 간소화된 것을 알수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --namespace gloo-system                                                                                         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusteringress-proxy-59fd6fb56-dmwwm   1/1       Running   0          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">discovery-779884d4cc-xlql2             1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gloo-844fc79445-f4zvg                  1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-7d75c99874-s4m76               1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --namespace knative-serving</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activator-746f6bb684-49tfh    1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoscaler-955f679cd-tx5vw    1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-7fc84c6584-jbn69   1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-7797ffb6bf-6pgsw      1/1       Running   0          12m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이전 포스팅에서도 사용했던 <code>gcr.io/knative-sample/helloworld-go</code> 이미지를 활용하여 샘플앱 Knative Service를 만든다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serviceyaml">service.yaml<a class="hash-link" href="#serviceyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ vi service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: serving.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: helloworld-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runLatest:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      revisionTemplate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          container:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            image: gcr.io/knative-sample/helloworld-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - name: TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value: "Go Sample v1"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply --filename service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.serving.knative.dev "helloworld-go" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>앞에서도 설명했지만 <code>Automatic scaling up and down to zero</code> 으로 Cold Start가 되고 잠시후에 아래와 같이 Knative Service를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.domain]($ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">omain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helloworld-go   helloworld-go.default.example.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Gloo Ingress를 확인한다. GKE에서 설치했기 때문에 자동으로 LoadBalancer가 연동되어 있는것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusteringress-proxy   LoadBalancer   10.3.244.54    34.**.**.54   80:30978/TCP,443:32448/TCP   39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gloo                   ClusterIP      10.3.243.231   &lt;none&gt;        9977/TCP                     39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl proxy url --name clusteringress-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http://34.**.**.54:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 얻은 두가지 정보로 생성된 app을 테스트한다. Cold Start(default timeout 5분) 때문에 응답이 늦어질 수도 있지만 잠시 기다리면 응답을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Host: helloworld-go.default.example.com" http://34.**.**.54:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Go Sample v1!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>물론 <code>Revision</code>이나 <code>Route</code>를 활용하여 Knative의 기능에 대해서도 확인이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>Gloo는 Knative ClusterIngress CRD를 기반으로 동작하는 Istio의 대안으로서 가능성을 보여주고 있다. 이외에도 The Service Mesh Orchestration Platform <code>SuperGloo</code>, Debugger for microservices <code>Squash</code> 등 다양한 Mesh Layer기반의 오픈소스들을 확인할수 있다. 또다른 스쳐지나갈수도 있는 오픈소스일수도 있겠지만 현재 개발되는 로드맵(<a href="https://www.solo.io/)%EC%9D%84" target="_blank" rel="noopener noreferrer">https://www.solo.io/)을</a> 보면 Knative가 고도화되는 여정에 같이 가는 모습을 확인할 수 있다. </p><p>next-generation API Gateway로서 다양한 프로토콜을 지원하기 때문에 (HTTP1, HTTP2, gRPC, REST/OpenAPISpec, SOAP, WebSockets, Lambda/Cloud Functions) 더욱더 Microservices 및 Serverless Workload를 수행하기에 더욱 적합한 오픈소스로 보인다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="다음-주제">다음 주제<a class="hash-link" href="#다음-주제" title="Direct link to heading">​</a></h2><p>현재 해보고 싶은것은 베어메탈 Kubernetes Cluster기반 BGP로 동작하는 <a href="https://metallb.universe.tf/" target="_blank" rel="noopener noreferrer">MetalLB</a>나 <a href="https://cilium.io/try-eks/" target="_blank" rel="noopener noreferrer">Cillium on AWS</a> 인데 시간나는 대로 테스트 해봐야 겠다.</p>]]></content>
        <category label="Knative" term="Knative"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="FaaS" term="FaaS"/>
        <category label="Serverless" term="Serverless"/>
        <category label="CRDs" term="CRDs"/>
        <category label="CloudEvents" term="CloudEvents"/>
        <category label="Mesh" term="Mesh"/>
        <category label="Gloo" term="Gloo"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Knative CLI - knctl]]></title>
        <id>/2019/02/18/knative-knctl</id>
        <link href="https://ddii.dev/2019/02/18/knative-knctl"/>
        <updated>2019-02-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Knative CLI tool knctl에 대해 알아보자]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knctl">knctl<a class="hash-link" href="#knctl" title="Direct link to heading">​</a></h2><p><code>knctl</code> 은 Knative CLI 툴로 간단하게 knative cluster를 만들고 Knative를 추상화해서 앱까지 배포할 수 있는 오픈소스이다. </p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="참고">참고<a class="hash-link" href="#참고" title="Direct link to heading">​</a></h4><ul><li><a href="https://github.com/cppforlife/knctl" target="_blank" rel="noopener noreferrer">https://github.com/cppforlife/knctl</a>  </li><li><a href="https://developer.ibm.com/blogs/2018/11/12/knctl-a-simpler-way-to-work-with-knative/" target="_blank" rel="noopener noreferrer">https://developer.ibm.com/blogs/2018/11/12/knctl-a-simpler-way-to-work-with-knative/</a>  </li><li><a href="https://starkandwayne.com/blog/public-traffic-into-knative-on-gke/" target="_blank" rel="noopener noreferrer">https://starkandwayne.com/blog/public-traffic-into-knative-on-gke/</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-다시-살펴보기">Knative 다시 살펴보기<a class="hash-link" href="#knative-다시-살펴보기" title="Direct link to heading">​</a></h3><p><a href="https://ddii.dev/kubernetes/knative/" target="_blank" rel="noopener noreferrer">앞선 포스팅에서도 이야기</a> 했지만 기존 FaaS(AWS Lambda, Google Cloud Funtions, Azure Function) 과는 다른 Serverless 개념으로 받아들어야 한다.</p><p>다시 한번 특징을 나열해보면 아래와 같다.</p><ul><li>Serverless Container의 신속한 배치 </li><li>Automatic scaling up and down to zero</li><li>Istio를 백엔드로 활용하여 Routing 구현</li><li>배포 된 코드 및 config의 특정 시점 스냅 샷</li></ul><p>그리고 다음과 같은 CRDs(Custom Resource Definitions)로 구성된 오브젝트들로 정의된다.</p><ul><li><code>Route</code>는 사용자 서비스에 대한 HTTP endpoint와 Routing을 제공한다.</li><li><code>Revisions</code>은 code(function)와 config로 구성된 불변의 스냅샷. Route를 통해 endpoint를 할당받지 못한 Revision은 자동으로 kubernetes resource에서 삭제됨</li><li><code>Configuration</code>은 요구되는 Revision 최신 상태를 기록하고 생성하고 추적할수 있음. 소스 패키지(git repo나 archive)를 컨테이너로 변환하기 위한 내용이나 메타데이터등을 포함시킬수 있음. </li><li><code>Service</code>는 <code>Routes</code>와 <code>Configurations</code> 리소스의 추상화된 집합체. 모든 워크로드의 lifecycle을 관리함. 트래픽을 항상 최신의 Revision으로 route되도록 정의할수 있음</li></ul><p>하나씩 조금 자세히 이야기 하면 아래처럼 정리 할수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="route">Route<a class="hash-link" href="#route" title="Direct link to heading">​</a></h3><p><strong>Route</strong>는 사용자 서비스(Code와 Configuration의 Revision정보)의 네트워크 Endpoint를 제공한다. kubernetes namespace는 여러개의 <code>Route</code>를 가질수 있다. <code>Route</code>는 하나 이상의 <code>Revisions</code>을 가지면서 수명이 길고 안정적인 HTTP Endpoint를 제공한다. 기본구성은 <code>Route</code> 객체가 <code>Configuration</code>에 의해 생성된 최신의 Revision으로 트래픽을 자동으로 지정한다. 조금더 복잡한 경우로는 istio의 기능을 활용하여 트래픽을 백분율 기준으로 <code>Route</code>를 지정할 수 있다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="revision">Revision<a class="hash-link" href="#revision" title="Direct link to heading">​</a></h3><p><strong>Revision</strong>은 Code와 Configuration의 불변의 스냅샷이다. 하나의 <code>Revision</code>은 컨테이너 이미지를 참조하고 선택적으로 <code>Build</code>를 참조할 수 있다. <code>Revision</code>은 <strong>Configuration</strong>이 업데이트 시 생성된다.<br>
<code>Route</code>를 통해 http주소 지정이 불가능한 <code>Revision</code>은 폐기 되고 관련된 kubernetes 리소스가 삭제가 된다. 시간이 지남에 따라 <code>Configuration</code>이 생성한 <code>Revision</code> 히스토리가 제공되고 사용자는 이전 <code>Revision</code>로 쉽게 롤백 할 수 있다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h3><p><code>Configuration</code>은 최신의 <code>Revision</code>상태를 설명하고, 생성하고, 원하는 상태가 갱신될때 <code>Revision</code>의 상태를 추적한다. <code>Configuration</code>은 <code>Build</code>를 참조하여 소스(git repo 또는 archive)를 컨테이너로 변환하는 방법에 대한 가이드가 포함되어 있거나 단순히 컨테이너 이미지 및 수정에서 필요한 메타 데이터 만 참조 할 수 있다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="product-integration">Product Integration<a class="hash-link" href="#product-integration" title="Direct link to heading">​</a></h3><p>2019년 2월 현재 0.3이 릴리스되고 있고 벌써 여러 제품에 통합이 되고 있다. </p><p>최근 IBMthink 2019에서 Managed Knative (Experimental)를 내놓기도 하였다.<br>
<a href="https://www.ibm.com/blogs/bluemix/2019/02/announcing-managed-knative-on-ibm-cloud-kubernetes-service-experimental/" target="_blank" rel="noopener noreferrer">https://www.ibm.com/blogs/bluemix/2019/02/announcing-managed-knative-on-ibm-cloud-kubernetes-service-experimental/</a> </p><p>Istio를 포함한 Knative 마저도 품는 모습으로 managed kubernetes 영역에서 글로벌 플레이어들 모두 서로 치고나가는 모습들을 볼수 있다. </p><p>작년 11월에는 Gitlab 제품안에 serverless라는 extension형태의 서비스가 추가 되기도 하였고,<br>
<a href="https://about.gitlab.com/press/releases/2018-12-11-gitlab-and-triggermesh-announce-gitlab-serverless.html" target="_blank" rel="noopener noreferrer">https://about.gitlab.com/press/releases/2018-12-11-gitlab-and-triggermesh-announce-gitlab-serverless.html</a></p><p>triggermesh 라는 곳에서는 serverless management platform이라는 이름으로 knative 기반 멀티 서버리스 플랫폼을 출시하기도 하였다.<br>
<a href="https://triggermesh.com/serverless_management_platform/" target="_blank" rel="noopener noreferrer">https://triggermesh.com/serverless_management_platform/</a></p><p>Pivotal Function Service (PFS), Google GKE SERVERLESS ADD-ON 등은 아직 early access 신청만 받고 있는 상태이다.</p><p>오늘은 간단하게 배포할수 있는 툴 knctl과 관련 use-case를 소개하고자 한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-cluster-생성">Kubernetes Cluster 생성<a class="hash-link" href="#kubernetes-cluster-생성" title="Direct link to heading">​</a></h3><p>일단 GKE Free tier에서 Cluster를 하나 생성하자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container clusters create knative \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region=asia-east1-a \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cluster-version=latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type=n1-standard-2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-autoscaling --min-nodes=1 --max-nodes=5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-autorepair \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --scopes=service-control,service-management,compute-rw,storage-ro,cloud-platform,logging-write,monitoring-write,pubsub,datastore \  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --num-nodes=3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cluster 생성된것을 확인하고 cluster-admin 권한을 할당한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-knative-default-pool-d1a39347-5m5t   Ready     &lt;none&gt;    1m        v1.11.7-gke.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-knative-default-pool-d1a39347-l6zh   Ready     &lt;none&gt;    1m        v1.11.7-gke.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-knative-default-pool-d1a39347-qv5r   Ready     &lt;none&gt;    1m        v1.11.7-gke.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create clusterrolebinding cluster-admin-binding \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --clusterrole=cluster-admin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --user=$(gcloud config get-value core/account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your active configuration is: [cloudshell-4728]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io "cluster-admin-binding" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knctl-설치">knctl 설치<a class="hash-link" href="#knctl-설치" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 Mac OS 설치 기준으로 작성하였다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="homebrew-설치">homebrew 설치<a class="hash-link" href="#homebrew-설치" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">brew install starkandwayne/kubernetes/knctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="binary">binary<a class="hash-link" href="#binary" title="Direct link to heading">​</a></h4><p><a href="https://github.com/cppforlife/knctl/releases" target="_blank" rel="noopener noreferrer">https://github.com/cppforlife/knctl/releases</a> </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://github.com/cppforlife/knctl/releases/download/v0.1.0/knctl-darwin-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mv knctl-* /usr/local/bin/knctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ chmod +x /usr/local/bin/knctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knctl-로-knative-배포">knctl 로 Knative 배포<a class="hash-link" href="#knctl-로-knative-배포" title="Direct link to heading">​</a></h2><p>설치한 knctl로 Knative 배포를 진행한다. 설치되는 내용을 지켜보고 있으면 <code>istio</code>를 먼저 배포하고 그다음에 <code>Knative</code>를 설치하는 것을 확인할 수 있다. 배포되는 모듈들의 상태를 하나하나 체크해서 배포하기 때문에 설치상에 과정들을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl install --exclude-monitoring</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>테스트를 위한 namespace <code>hello-test</code>를 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace hello-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace "hello-test" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>knctl deploy 명령으로 최초 revision을 배포한다.<br>
<!-- -->아래 결과를 보면 hello-00001 이라고 하는 최초의 revision을 작성하기 때문에 <code>latest</code> tag를 달고 배포를 하게 된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl deploy \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --namespace hello-test \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --service hello \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --image gcr.io/knative-samples/helloworld-go \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --env TARGET=Rev1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name  hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision to be created...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging new revision 'hello-00001' as 'latest'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging new revision 'hello-00001' as 'previous'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotating new revision 'hello-00001'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision 'hello-00001' to be ready for up to 5m0s (logs below)...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00001 &gt; hello-00001-deployment-5cdbfc9bc9-hks6t | 2019/02/17 22:27:50 Hello world sample started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision 'hello-00001' became ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Continuing to watch logs for 5s before exiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc knative-ingressgateway -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                                                                                                   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-ingressgateway   LoadBalancer   10.63.253.209   34.***.***.248   80:32380/TCP,443:32390/TCP,31400:32400/TCP,15011:30082/TCP,8060:31125/TCP,853:32009/TCP,15030:31102/TCP,15031:31631/TCP   6h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위처럼 Knative가 프로비저닝 되면서 ingress-gateway가 하나 생성이 되어있는 것을 확인할 수 있고 knctl로도 ingress를 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl ingress list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ingresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name                    Addresses     Ports  Age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-ingressgateway  34.***.***.248  80     6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        31400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        15011</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        8060</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        853</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        15030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        15031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 ingresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-custom-domain-연결">Knative custom domain 연결<a class="hash-link" href="#knative-custom-domain-연결" title="Direct link to heading">​</a></h2><p>Domain이 별도로 없기 때문에 Knative는 내부적으로 example.com이라고 하는 기본 domain을 사용한다. 그래서 실제 <code>knctl curl</code> 명령은 내부적으로 <code>hello.hello-test.example.com</code>으로 curl을 실행하게 되고 해당 결과를 아래와 같이 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl curl --service hello -n hello-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running: curl '-sS' '-H' 'Host: hello.hello-test.example.com' 'http://34.***.***.248:80'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Rev1!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kubernetes node가 3개이므로 3개의 pod가 생성된 것을 확인할 수 있다. 일정시간(default:5분)이 지나면 <code>zero to scale</code> 관점에서 pod가 종료되므로 다시 확인할때는 다시 curl 명령을 날리게 되면 다시 pod가 올라오게 된다. 해당 개념은 FaaS또는 AWS Lambda에서 Cold-Start와 동일한 것이라 볼 수 있다.  </p><p>AWS Cold Start 참고 : <a href="https://novemberde.github.io/aws/2018/02/02/Lambda_coldStart.html" target="_blank" rel="noopener noreferrer">https://novemberde.github.io/aws/2018/02/02/Lambda_coldStart.html</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get po</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                      READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00001-deployment-5cdbfc9bc9-hks6t   3/3       Running   0          4m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>가지고 있는 도메인이 있다면 위에서 나온 <code>34.***.***.248</code> IP를 domain에 매핑해보자.
아래에서는 기존 보유중인 skcloud.io 도메인을 연결하였다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ dig knative.skcloud.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;; ANSWER SECTION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative.skcloud.io.     603     IN      A       34.***.***.248</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>knctl domain을 이용하여 default domain을 <code>knative.skcloud.io</code>로 변경한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl domain create -d knative.skcloud.io --default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>knctl routes 명령으로 해당 hello-test app의 Endpoint 정보를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl routes list -n hello-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Routes in namespace 'hello-test'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name   Domain                               Traffic        Annotations  Conditions  Age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello  hello.hello-test.knative.skcloud.io  100% -&gt; hello  -            3 OK / 3    1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 routes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>5분이상 기다렸다가 curl로 확인하면 Cold-Start 되는 시간(몇초) 지연이 발생하고 결과를 확인할 수 있다.
이후에는 바로 응답을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://hello.hello-test.knative.skcloud.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Rev1!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="revision-추가">revision 추가<a class="hash-link" href="#revision-추가" title="Direct link to heading">​</a></h2><p>이번에는 revision을 추가해보자. TARGET environment 변수를 <code>Rev2</code>로 수정하고 배포를 한다.
기존 hello-00002 revision이 최신 revision으로 갱신되어 배포가 되는것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl deploy --service hello \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --image gcr.io/knative-samples/helloworld-go \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --env TARGET=Rev2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name  hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision (after revision 'hello-00001') to be created...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging new revision 'hello-00002' as 'latest'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging older revision 'hello-00001' as 'previous'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotating new revision 'hello-00002'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision 'hello-00002' to be ready for up to 5m0s (logs below)...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00002 &gt; hello-00002-deployment-6cf86bbfc7-sblz9 | 2019/02/17 23:25:43 Hello world sample started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision 'hello-00002' became ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Continuing to watch logs for 5s before exiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>신규 <code>revision</code> 서비스를 추가된것을 확인할 수 있다. 마찬가지로 몇초간의 Cold-Start delay가 발생할 수도 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://hello.hello-test.knative.skcloud.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Rev2!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl curl --service hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running: curl '-sS' '-H' 'Host: hello.hello-test.knative.skcloud.io' 'http://34.***.***.248:80'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Rev2!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>revision list를 확인해보면 현재 latest, previous TAG정보를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl revision list --service hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revisions for service 'hello'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name         Tags      Annotations  Conditions  Age  Traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00002  latest    -            1 OK / 4    14m  100% -&gt; hello.hello-test.knative.skcloud.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00001  previous  -            1 OK / 4    4h   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 revisions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bluegreen-배포">Blue/Green 배포<a class="hash-link" href="#bluegreen-배포" title="Direct link to heading">​</a></h2><p>Blue/Green Deploy는 knctl rollout 명령으로 수행할수 있다.<br>
<!-- -->rollout 할때 <code>--managed-route=false</code> 옵션을 줘야 특정 비율로 routing이 가능하다.<br>
<!-- -->아래 예시는 TARGET environment 변수를 <code>blue</code>, <code>green</code>으로 바꿔가면서 배포를 진행하였다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl deploy --service hello \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --image gcr.io/knative-samples/helloworld-go \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --env TARGET=blue \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --managed-route=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name  hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision (after revision 'hello-00002') to be created...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging new revision 'hello-00003' as 'latest'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tagging older revision 'hello-00002' as 'previous'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotating new revision 'hello-00003'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for new revision 'hello-00003' to be ready for up to 5m0s (logs below)...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision 'hello-00003' became ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Continuing to watch logs for 5s before exiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00003 &gt; hello-00003-deployment-99478dcc5-jf267 | 2019/02/17 23:48:20 Hello world sample started.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>revision list를 확인하면 아래와 같이 <code>latest</code>로 Traffic 전체가 routing 되는 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl revision list --service hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revisions for service 'hello'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name         Tags      Annotations  Conditions  Age  Traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00005  latest    -            4 OK / 4    44s  100% -&gt; hello.hello-test.knative.skcloud.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00004  previous  -            4 OK / 4    2m   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00003  -         -            1 OK / 4    5m   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00002  -         -            1 OK / 4    28m  -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello-00001  -         -            1 OK / 4    4h   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 revisions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후에 rollout을 통해 previous로 90%, latest로 10%로 변경을 하면 즉시 반영이 되고 실제 트래픽도 분산되어 들어온다. %가 낮은 쪽으로 routing이 될 경우 Cold-Start가 발생하게 되면 delay는 발생하게 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl rollout --route hello -p hello:latest=10% -p hello:previous=90%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ knctl revision list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revisions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service  Name         Tags      Annotations  Conditions  Age  Traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello    hello-00005  latest    -            2 OK / 4    1h   10% -&gt; hello.hello-test.knative.skcloud.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~        hello-00004  previous  -            2 OK / 4    1h   90% -&gt; hello.hello-test.knative.skcloud.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~        hello-00003  -         -            1 OK / 4    1h   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~        hello-00002  -         -            1 OK / 4    1h   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~        hello-00001  -         -            1 OK / 4    5h   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 revisions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Succeeded</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>간단하게 curl 반복문을 작성하여 돌려보자. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -sS --max-time 3 http://hello.hello-test.knative.skcloud.io/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>간단하게 위 sh을 돌리면 아래와 같이 Cold-Start delay가 발생할때 time out이 발생하고 이후 green revision으로 접속이 되는것을 볼 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./test.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl: (28) Operation timed out after 3002 milliseconds with 0 bytes received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl: (28) Operation timed out after 3003 milliseconds with 0 bytes received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello green!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello blue!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>지금까지 <code>knctl</code>을 사용하여 간단하게 knative를 배포하고 custom domain을 연결하여 blue-green 배포까지 해봤다.
이외에도 Knative Build를 활용하여 Docker image 작업을 하거나 서비스 카탈로그 등을 연동하여 외부 DBaaS를 연동하는 use-case등을 찾아볼수 있다.</p><p>아직 초기 단계이지만 Knative는 istio와 함께 IBM, Google, Pivotal등 global player들의 차세대 오픈소스로 부상하고 있다고 볼 수 있다.  </p><p><code>Zero to scale</code> 이라는 슬로건아래 Serverless, FaaS 사상을 기반으로 build, serving, event, routing이라고 하는 Cloud Computing 추상화의 끝판으로 진화하고 있다. 앞으로 어떤 모습으로 진화될지 궁금하고 다음번에는 MQ나 Pub/sub를 연동하거나 멀티 클라우드 환경에서 동작하는 모습을 보여주는 것도 좋을것 같다. 희망사항이지만 올해 OpenInfraDay나 Kubernetes Day Korea 행사에서 Hands-on을 진행해보는것도 좋지 않을까?</p>]]></content>
        <category label="Knative" term="Knative"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="FaaS" term="FaaS"/>
        <category label="Serverless" term="Serverless"/>
        <category label="CRDs" term="CRDs"/>
        <category label="CloudEvents" term="CloudEvents"/>
        <category label="Mesh" term="Mesh"/>
        <category label="knctl" term="knctl"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hybrid Cloud]]></title>
        <id>/2019/02/10/Hybrid</id>
        <link href="https://ddii.dev/2019/02/10/Hybrid"/>
        <updated>2019-02-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Hybrid Cloud]]></summary>
        <content type="html"><![CDATA[<p>오늘도 기술적인 이야기보다는 화두가 되고 있는 하이브리드 클라우드 이야기를 해보고자 한다.</p><p>업계 사람들도 하이브리드, 엣지 클라우드 서비스를 긍정적인 시각으로 보고있지만 성숙도 측면에서 문제가 있어 도입을 꺼려왔던게 사실이다. 최근 동향을 봤을때 퍼블릭 클라우드 공급사에서도 프라이빗 클라우드를 포섭해야할 대상으로 인정하고 공격적으로 하이브리드 클라우드 솔루션을 개발하여 제공하려고 하는 움직임을 보이고 있다.</p><p>엔터프라이즈에서는 입장에서는 Scale, DR측면에서 On-Prem 에서 퍼블릭으로 확장을 도모하고 있고 글로벌플레이어 입장에서는 퍼블릭에서 On-Prem으로 전이하는 모습으로 비즈니스를 진행하고 있다. 하지만 구글은 특별하게 컨테이너 기반으로 진행중이다. 누가 끝까지 살아남아 승자가 될지 아무도 모른다. </p><p>앞으로 열릴 시장은 확실하고 꼭 필요하다는 것은 알지만 기술의 성숙도가 높지 않고 넘어야할 허들이 많다. 아직까지 연계 기술이나 생태계가 비어 있는 부분들이 존재하기 때문에 올해 말쯤 되면 여러 상품들이 출시되면서 정리 되지 않을까 싶다. </p><p><a href="https://wikibon.com/aws-outposts-enables-hybrid-cloud/" target="_blank" rel="noopener noreferrer">https://wikibon.com/aws-outposts-enables-hybrid-cloud/</a></p><p>위 포스팅에서도 2가지 의문점을 제기한다.</p><ul><li><p>Will a data egress charge be applied to data resident on the disks to other on-premise workloads?<br>
<code>예시) S3 → Outpost egress 트래픽(private n/w 이긴 하지만 aws가 돈을 안 받을것인가?, 결국 direct-link는 필수인건지?)</code></p></li><li><p>Is the data on site under the legal control of AWS or the customer?<br>
<code>데이터의 소유권 문제(이게 심각한 문제가 될수 있다)</code></p></li></ul><p>그래서 AWS가 작년에 내놓은 Outpost의 첫그림은 <a href="https://aws.amazon.com/ko/outposts/features/" target="_blank" rel="noopener noreferrer">VMware on AWS</a>로 작년 reinvent이후 많은 관심을 받았던 프로젝트이다. </p><p>이외에도 메이저 사들도 <a href="https://azure.microsoft.com/ko-kr/overview/azure-stack/" target="_blank" rel="noopener noreferrer">Azure Stack</a>, <a href="https://www.ibm.com/kr-ko/cloud/vmware" target="_blank" rel="noopener noreferrer">VMware on IBM Cloud</a>, <a href="https://www.ncloud.com/product/hybridPrivateCloud/vmwareOnNcloud" target="_blank" rel="noopener noreferrer">VMware on Ncloud</a>와 같은 하이브리드 서비스를 내놓고 있다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="product별-기본-전략">Product별 기본 전략<a class="hash-link" href="#product별-기본-전략" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="azure-stack">Azure Stack<a class="hash-link" href="#azure-stack" title="Direct link to heading">​</a></h4><ul><li>호환성 인증받은 서버를 On-prem에 구매/설치하고 Azure UI 및 API와 동일한 UI/UX로 private cloud 사용</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-outpost">AWS Outpost<a class="hash-link" href="#aws-outpost" title="Direct link to heading">​</a></h4><ul><li>고객 On-prem에 EC2 cloud instances 제공 (전용 HPC 하드웨어 - EC2 Nitro Platform)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-outpostvmware-based">AWS Outpost(VMware based)<a class="hash-link" href="#aws-outpostvmware-based" title="Direct link to heading">​</a></h4><ul><li>baremetal 전용 플랫폼으로 VMware - software, AWS - hardware 에 집중</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="google-cloud">Google Cloud<a class="hash-link" href="#google-cloud" title="Direct link to heading">​</a></h4><ul><li>K8s On-prem전략을 기본으로 Cisco와 하이브리드 전략 (based on Istio)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ibm-cloud">IBM Cloud<a class="hash-link" href="#ibm-cloud" title="Direct link to heading">​</a></h4><ul><li>구글과 유사하게 Istio를 기본으로 하여 멀티, 하이브리드 클라우드 제품 출시</li><li>IKS on Vmware on IBM Cloud Baremetal 와 같은 상품도 출시</li></ul><p>대부분 VMware 협력을 기반으로 하이브리드 클라우드 전략을 전개하고 있고 내면을 들여다보면 물리적으로 다른곳에 있는 Overlay 네트워크에 대한 해결이 가장 문제이기 때문에 Direct-link나 VPN을 통해 연결하는것도 결국 클라우드 사업자가 네트워크 트래픽 비용을 가져가지 위한 전략으로서 보인다. </p><p>실제 퍼블릭 클라우드 벤더의 Cash Cow는 Compute 자원보다는 네트워크 비용과 Blob Storage, API과금 등 에 대한 매출이 큰 비중을 차지한다고 봐야 한다. 혹자는 글로벌 네트워크 전용선에 대한 투자나 고성능 HPC도입 투자 비용에 대한 말들을 하지만 IBM같은 경우 글로벌 네트워크 무료 정책을 통해 Market Share를 획득하고자 하는 부분들을 보면 네트워크가 가장 핵심이 아닐까 싶다.  </p><p>클라우드를 이야기 할때 기술 성숙도를 보면 Compute &gt; Storage &gt; Network 순으로 전이가 되는데 OpenStack이나 Kubernetes 프로젝트와 같은 오픈소스나 VMware NSX 플랫폼만 봐도 정말 네트워크가 중요한 영역이 되고 있음을 알수 있다. </p><p>결국 핵심적으로 봐야하는 부분은 네트워크다. 네트워크 부분에서 아주 강력한 솔루션이 나와야 한다. 결국 회선 비용이 문제고 최근 넷플릭스와 SKB의 속도 분쟁만 봐도 결국 강자의 논리로 네트워크 문제가 해결되는 시대가 온 것이다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h3><p>내가 생각한 서비스 사용자 측면에서 우리가 고려해야할 클라우드 옵션들을 정리해보면 아래와 같다.</p><ul><li><p>멀티 클라우드 : 퍼블릭 클라우드 to 퍼블릭 클라우드 운영 솔루션으로 프라이빗 클라우드 영역에는 거의 관여를 안하며, 솔루션에 따라 일부 가상화된 Computing 자원까지 모니터링 지원하기도 함. 멀티 클라우드 운영 플랫폼은 주로 클라우드 Brokerage Service 형태로 제공되어야 하므로 MSP역할이 중요해질 것 같다. 메가존, 베스핀글로벌과 같은곳 뿐아니라 자체적인 클라우드를 운영하는 대형 SI회사를 포함한 기존 IaaS 운영조직의 변화들도 눈여겨 봐야할것 같다. 마진율이 낮은 레드오션 싸움에서 누가 이기느냐가 중요하기 보다는 미래를 보고 투자하는 자세가 필요하다고 본다. </p></li><li><p>프라이빗 클라우드 : 프라이빗 클라우드 전용 솔루션으로 벤더 또는 특정 IaaS 서비스에 최적화된 경우가 많으므로 VMware, OpenShift, OpenStack Managed 서비스등 기존 제품에서의 연장선에서 얼마나 오픈소스를 이해하고 프로덕션에 적용할수 있는 역량을 기르는것이 중요하다. </p></li><li><p>하이브리드 클라우드 : 퍼블릭 클라우드 to 프라이빗 클라우드 운영 솔루션으로 프라이빗 클라우드의 인프라스트럭처까지 관여를 하며, 퍼블릭 클라우드 영역은 일반적으로 IaaS 영역과 일부 PaaS / 컨테이너까지 구성, 모니터링 지원해야 하고 이를 위한 3rd Party 솔루션들이 등장하고 있고 점차 영역을 확대할것이다. 이에 있어 컨테이너 플랫폼을 도입하는것이 가장 글로벌 플레이어와 격차를 줄이는데 효과적인 도구라 생각한다. 결국 하이브리드 클라우드 구현은 기존 Public과 Local Cloud간 네트워크 연계가 중요한 포인트이다.</p></li><li><p>간단히 구현해 볼수 있는 General Hybrid Kubernetes Architecture를 간단히 그려봤다. 기본적으로 StrongSwan VPN을 가지고 CI/CD를 고려한 DevOps관점에서의 구성도이다.
<img loading="lazy" alt="hybrid-cloud" src="/assets/images/hybrid-cloud-b89fa6a20fd326ec117dbdf490a43f37.png" width="791" height="799" class="img_E7b_"></p></li></ul><p>위에 내용과 함께 하이브리드 클라우드를 고려할때 <code>데이터 소유권 측면에서의 거버넌스</code> 와 <code>overlay 네트워크</code>에 대한 고민이 동행되었을때 성공적인 하이브리드 클라우드를 구축할수 있다라는 나 혼자만의 생각을 정리해봤다.</p>]]></content>
        <category label="Hybrid" term="Hybrid"/>
        <category label="Multi" term="Multi"/>
        <category label="Outpost" term="Outpost"/>
        <category label="VMware" term="VMware"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SRE (Site Reliablity Engineering)]]></title>
        <id>/2019/01/30/SRE</id>
        <link href="https://ddii.dev/2019/01/30/SRE"/>
        <updated>2019-01-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[SRE 소개]]></summary>
        <content type="html"><![CDATA[<p>그동안 DevOps 담당자라고 부르짖던 사람들의 Role이 인프라 담당자인지 플랫폼 담당자인지 아니면 개발하는 운영자인지 헷갈릴때가 많았다.</p><p>갑자기 국내에서도 SRE 채용 공고가 많아지는것을 보면서 내 자신도 한번 정리를 하고 가야할것 같은 생각이 들었다.</p><p><a href="https://docs.microsoft.com/ko-kr/learn/modules/intro-to-site-reliability-engineering/" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ko-kr/learn/modules/intro-to-site-reliability-engineering/</a></p><p>개념정리 측면에서 위 MS Azure의 온라인 교육내용을 정리해봤다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sre">SRE<a class="hash-link" href="#sre" title="Direct link to heading">​</a></h2><p>SRE(사이트 안정성 엔지니어링)란 조직이 해당 시스템, 서비스 및 제품에서 적절한 수준의 안정성을 달성하도록 지원하는 엔지니어링 분야이다. </p><p>출처 : <a href="https://landing.google.com/sre/sre-book/chapters/introduction/" target="_blank" rel="noopener noreferrer">https://landing.google.com/sre/sre-book/chapters/introduction/</a></p><p>기본적으로 운영경험이 있는 sysadmin, IT전문가, DevOps실행 담당자 등이 대상이 될 수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="적절한-수준의-안정성">적절한 수준의 안정성<a class="hash-link" href="#적절한-수준의-안정성" title="Direct link to heading">​</a></h3><p>가장 핵심이 되는 단어는 <code>안정성</code>이다. 조직에서 만든 애플리케이션이 안정성이 부족하여 작동하지 않거나 불안정한 경우 실제 비즈니스에 피해를 줄 수 있다는건 누구나 알고 있는 당연한 이야기이지만 100%의 안정적인 시스템은 존재하지 않으므로 적절한 수준(정량적으로 측정하긴 어렵지만 이해관계자들이 납들할만한 수준)의 안정성을 달성하기 위한 일련의 작업들을 수행하는 것이 SRE의 기본 속성이라고 볼수 있다. </p><p>SRE는 Google에서 2003년부터 7명의 소프트웨어 엔지니어로 구성된 팀에서 시작된 이후 (자세한 내용은 위 링크 ebook 참조) Google 사내에 널리 확산되고 내부적인 문화로 조성되는 중에 밖에서는 DevOps라고 하는 문화가 동시에 확산되었다 한다. 결국 동일한 문제를 해결하기 위한 측면에서 두개의 방법론은 다르다고 봐야한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="차이점">차이점<a class="hash-link" href="#차이점" title="Direct link to heading">​</a></h3><ul><li>SRE - 안정성을 위한 엔지니어링, DevOps - 개발과 운영조직 각각의 사일로를 해체하기 위한 문화적인 움직임</li><li>SRE - 저는 SRE 입니다, DevOps - 저는 DevOps를 하는 운영자 또는 개발자 입니다.</li><li>SRE - 규범으로 인식, DevOps - 문화로 인식</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="공통점">공통점<a class="hash-link" href="#공통점" title="Direct link to heading">​</a></h3><ul><li>모니터링/식별 가능, 자동화</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="주요-sre원칙--선순환">주요 SRE원칙 : 선순환<a class="hash-link" href="#주요-sre원칙--선순환" title="Direct link to heading">​</a></h2><p>새로운 서비스의 상태의 지표는 어떻게 정의할까? 보통은 무엇을 <code>SLI(서비스 수준 지표)</code>로 사용할지를 정하는것으로 본다. 일반적으로 성공 및 실패 측정값(200 OK,500 Error), 응답시간(ms), 처리량 등의 조합으로 결정될 수 있다. 보통  카나리아 분석을 통해 Scoring을 한 <code>SLI</code>를 200 OK와 500 또는 에러코드의 비율로 결정하는 방법을 사용하는 경우가 많다.</p><p>서비스 상태를 식별하는 지표를 정하고 나면 고객이나 우리가 원하는 안정성 수준을 결정해야 한다. 개발팀과 운영팀이 같이 만든 원하는 안전성 수준을 <code>SLO(서비스 수준 목표)</code>라고 말하면 된다. </p><p><code>SLO</code>는 Prometheus나 Datadog과 같은 모니터링 시스템을 활용하여 정확하게 측정하고 표시해야 한다. 서비스의 안정성에 대해서 명확하게 이해할수 있는 목표이기도 하다. 반드시 <code>SLO</code>를 만족하는지 못하는지 명확한 측정값으로 데이터가 존재해야 하고 <code>SLO</code>를 충족하지 못하면 문제가 있는것으로 판단하고 문제를 해결해야 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="오류-예산">오류 예산<a class="hash-link" href="#오류-예산" title="Direct link to heading">​</a></h3><p>오류 예산이라는 말을 명확히 이해하려면 흔히 고객과 체결하는 계약서 상의 명시된 서비스 가동율(SLA)을 생각하면 될 것 같다. 보통 99.9% 의 <code>SLO</code>를 정한다고 한다면 1년에 8시간 45분 57초의 서비스 다운타임을 허용하는 것이다. 오류 예산은 서비스의 완벽한 안정성과 원하는 안정성의 차이(100%-99.9%=0.01%)를 말한다. 0.01%로 즉 8시간정도의 오류 예산을 가지는 것은 그 시간을 모두 사용할 때까지 추가 릴리스나 패치를 진행할 수 있다는 이야기와 같다. 어떤 팀은 해당 예산을 신규 기능을 릴리스하는데 사용하기도 하고 장애가 발생했을때 문제의 원인을 발견하고 개선하는데 사용하기도 한다. </p><p>일반적으로 서비스에 대한 오류 예산이 모두 사용되면 서비스가 원하는 안정성 수준으로 돌아갈때 까지 해당 서비스의 추가적인 릴리스를 보류하는게 일반적이긴 하지만 특정기간(월 또는 분기 또는 연간) 기준으로 계산되기 때문에 서비스 안정성이 정상 상태라면 오류 예산은 다시 주어지게 되므로 <code>선순환</code> 구조를 가진다고 볼 수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="비난-없는-장애-회고">비난 없는 장애 회고<a class="hash-link" href="#비난-없는-장애-회고" title="Direct link to heading">​</a></h3><p>일반적으로 비즈니스에 크리티컬한 장애가 발생했을때 사후 분석(회고)을 하게 되는데 이때는 <code>비난 없는</code> 분석을 해야한다. 오래전 기억이지만 예전 직장 특정팀에서는 장애가 발생하면 유관자들이 모두 엔지니어 책상 뒤에 서서 모든 화살과 눈총을 주기 때문에 도저히 일을 할 수 없게 만든 경우가 많았었다. </p><p>특정 운영자의 작업 실수로 인해 장애가 발생했다 하더라도 해당 이벤트가 발생하게 된 프로세스나 기술기반에 실패 원인을 파악하는데 중점을 두어야 할것이다.</p><p>시스템의 안정성을 저하시키고 서비스를 중단시킨 작업(릴리스, 패치 등)을 사유로 개인에게 페널티를 주거나 고과에 반영하는 방법은 장애로 부터 교훈을 얻을수가 없고 해당 담당자의 충성도나 생산성 저하를 유발하는 안좋은 장치가 될 수 있다. 내 경험이기도 하지만 한동안 두려워서 아무 변경도 하지 못하는 경우가 종종 있었다. </p><p>회사나 조직, 팀은 시스템 중단으로부터 교훈을 얻고 지속적으로 시스템을 개선할수 있다. 적절한 분석을 통해 후속조치를 수행함으로써 실패를 수용하는 것이 SRE의 핵심 원칙이다. 이러한 내용을 모두에게 공유하고 타 조직이나 팀에게 인사이트를 제공하는 선순환 구조를 만드는것 또한 SRE의 기본 원칙이라고 볼 수 있다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="주요-sre원칙--사람측면">주요 SRE원칙 : 사람측면<a class="hash-link" href="#주요-sre원칙--사람측면" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="toil수고스런-일-번거로운-작업">Toil(수고스런 일, 번거로운 작업)<a class="hash-link" href="#toil수고스런-일-번거로운-작업" title="Direct link to heading">​</a></h3><p>항상 SRE에서는 Toil에 초점을 맞춰야 한다. Toil은 사람이 수행하는 운영 작업 중 특정한 패턴이나 특성이 있는 작업을 말한다. 종종 반복적이고 자동화 될 수 있는 작업일지라도 대부분 수동작업으로 처리를 한다. 서비스의 규모가 커지거나 고객이 많아지게 되면 보통 우리가 이야기 하는 티켓(또는 SR)의 수가 많아지고 공수가 많이 필요하게 된다. </p><p>배포때마다 Config를 적용하거나 계정 등록, 볼륨이나 디스크 프로비저닝 등 수동으로 처리해야하는 모든 작업이 운영자에게는 부하로 다가올수 있다. 이러한 반복적인 작업을 티켓시스템을 통해 처리를 하게 되면 티켓 생성, 작업계획서 작성, 검토, 승인 단계를 그때 마다 해야하는 아주 번거로운 작업(Toil)을 해야한다.</p><p>SRE는 최대한 이러한 반복적이고 번거로운 작업을 제거하기 위해 노력해야하고 자동화와 Self-Service로 개발자가 편하게 직접 사용할수 있도록 환경을 제공해 주어야 한다. 이러한 요청이나 티켓을 자동으로 처리할 수 있으면 조금 더 생산적인 일을 수행할수 있다. </p><p>위에서 이야기한 적절한 안정성과 비슷한 맥락으로 생각하면 될 것 같다. 번거로운 작업을 없애는것이 다른 중요한 작업보다 우선순위가 떨어지기도 하지만 서비스 상에서 Toil을 제거하는것도 SRE의 주된 업무이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="운영작업의-비율">운영작업의 비율<a class="hash-link" href="#운영작업의-비율" title="Direct link to heading">​</a></h2><p>Toil을 제거하거나 서비스/시스템 안정성을 개선하기 위해 SRE는 장애를 해결하고 티켓을 처리하는 시간 비중을 50%를 넘겨서는 안된다. 티켓이 필요하지 않도록 개발자 Self-Service를 구성/제공하고 효율성을 증대시키기 위해서 IaC등(Shell, Ansible, Terraform)과 같이 자동화를 위한 코드를 만드는데에도 집중을 해야한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>지금까지 SRE에 대해서 간단하게 소개하고 이해하는 측면에서 정리해 봤다. </p><p><a href="https://landing.google.com/sre/sre-book/chapters/part3/" target="_blank" rel="noopener noreferrer">Service Reliability Hierarchy</a></p><p><img loading="lazy" src="https://lh3.googleusercontent.com/3gX2qgys2I-9HnEIvXUA10ed3AILvg5MclnKWBquEkJKP3g5_kD6WR7Ptwp3TwAGla1DuSmHv64MdTtACNLlArFVq7BwbTrTVhigsA=s0" alt="hierarchy" class="img_E7b_"></p><p>그림과 같이 서비스 안정성 계층 구조에서는 기본적으로 모든 서비스를 모니터링 하는 시스템을 갖추어야 한다고 말한다. 모니터링 시스템이 준비가 되면 서비스에 대한 SLI, SLO를 만들고 모니터링 시스템에서 구현하는것이 첫번째 SRE를 적용하는 방법이라고 할 수 있을 것이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="참고-서적">참고 서적<a class="hash-link" href="#참고-서적" title="Direct link to heading">​</a></h2><ul><li><a href="http://shop.oreilly.com/product/0636920041528.do" target="_blank" rel="noopener noreferrer">Site Reliability Engineering: How Google Runs Production Systems(“The SRE Book”)</a></li><li><a href="http://landing.google.com/sre/workbook/toc/" target="_blank" rel="noopener noreferrer">The Site Reliability Workbook: Practical Ways to Implement SRE(“The SRE Workbook”)</a></li><li><a href="http://shop.oreilly.com/product/0636920063964.do" target="_blank" rel="noopener noreferrer">Seeking SRE: Conversations About Running Production Systems at Scale</a></li></ul>]]></content>
        <category label="SRE" term="SRE"/>
        <category label="DevOps" term="DevOps"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[2018 Retrospective]]></title>
        <id>/2019/01/03/newyear-plan</id>
        <link href="https://ddii.dev/2019/01/03/newyear-plan"/>
        <updated>2019-01-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[18년도를 돌아보며...]]></summary>
        <content type="html"><![CDATA[<p>한해가 또 훅 가버렸다. 18년도 Retrospective 시작한다.</p><ul><li><p>Work</p><ul><li>17년까지 팀 막내였지만 새로운 부서로 이동하여 서비스개발 파트장을 맞게 되었음. 17년도에 개발이라고는 python를 사용하여 vmware vm을 openstack instance로 migration하는 프로젝트 및 kubernetes 기반 tensorflow 플랫폼을 개발하는 초보개발자 수준이였던 내가 인프라와 클라우드 플랫폼(openstack, vsphere, kubernetes) 경력이 인정되어 서비스 개발 파트를 맡게 되었다. 인생에서 가장 큰 변혁중 하나였다고 생각하고 항상 감사하는 마음으로 일을 하고 있다.  </li><li>CNCF OpenSource들을 활용하여 FaaS(Function as a Service), IaC(Infra as Code) 플랫폼 개발을 진행하였다. 서비스 기획 및 두개 프로젝트의 Scrum Master 역할을 수행하였고 메인 업무는 SRE역할로 Kubernetes 설계 구축, 클러스터 및 스토리지 관리, LB, 인증서 등 클라우드 인프라 자원관리 정도였던것 같다. </li></ul></li><li><p>Tech.</p><ul><li>Public Cloud : AWS, DigitalOcean, IBM Cloud, GCP, Azure, nCloud</li><li>Provisioning : Harbor, Ansible, Portus, Clair, Kubicorn, Terraform, Vault</li><li>Runtime : Rook, Minio, OpenEBS, Calico, REX-ray, WeaveNet, Cilium</li><li>Orchestration : Kubernetes, Envoy, etcd, gRPC, Kong, HAProxy, Istio, Kong, NGINX, Traefik</li><li>App : NATS, Helm, Kafka, Docker-compose, Draft, Gitlab, minikube, Operator, Jenkins, JenkisX, Packer, RabbitMQ, Spinnaker</li><li>Serverless : Dispatch, Fission, Knative, Nuclio, OpenWhisk, OpenFaas</li><li>Monitoring, Logging : Prometheus, Fluentd, Elastic, Grafana, influx, WeaveScope</li><li>기타 : Cert-Manager, Dex, Agones</li></ul></li><li><p>Speak
쓰다보니 사내외 발표를 10번을 넘게 한거 같다.</p><ul><li>4월 사내 Cloud Tech : 컨테이너 기반 SaaS 개발을 위한 고려사항</li><li>5월 사내 DT 솔루션 행사, 클라우드사업부 세션 : Advanced Cloud (Road to Serverless)</li><li>5월 사내 통신사업부문 Tech세션 : Road to Serverless (Functions as Applications)</li><li>6월 Open Infra Days Korea 2018 : <a href="https://www.slideshare.net/JinwoongKim8/provisioning-dedicated-game-server-on-kubernetes-cluster" target="_blank" rel="noopener noreferrer">Provisioning Dedicated Game Server on Kubernetes Cluster</a></li><li>8월 SK DNA 2018 : <a href="https://www.slideshare.net/JinwoongKim8/cloud-z-serverless-118143924" target="_blank" rel="noopener noreferrer">Cloud Z 의 오픈소스 서비스 소개 및 Serverless로 게임 개발하기</a></li><li>10월 DT Labs Meetup : <a href="https://www.slideshare.net/JinwoongKim8/continuous-delivery-with-spinnaker-on-k8skubernetes-cluster-118140930" target="_blank" rel="noopener noreferrer">Continuous Delivery with Spinnaker on K8s(kubernetes) Cluster</a></li><li>10월 NCsoft IO : <a href="https://www.slideshare.net/JinwoongKim8/cloud-native-serverless/JinwoongKim8/cloud-native-serverless" target="_blank" rel="noopener noreferrer">Cloud Native 오픈소스 서비스 소개 및 Serverless로 실제 게임 개발하기</a></li><li>11월 IBM Developer Day : <a href="http://public.dhe.ibm.com/software/kr/TrackB/B3.pdf" target="_blank" rel="noopener noreferrer">Continuous Delivery using Spinnaker on Kubernetes Multi Cluster</a></li><li>11월 "Kubernetes Meetup" 1Day : <a href="https://www.slideshare.net/JinwoongKim8/spinnaker-on-kubernetes-123752186" target="_blank" rel="noopener noreferrer">Spinnaker on Kubernetes</a></li></ul></li></ul><p>쓰고나서 보니 2018년도 회고라기 보다 거의 개발에 필요한 잡일(DevOps라고 두둔하면서)과 발표만 한거 같네...
19년도 부터는 다른업무를 하게 될거 같은데 초심을 잃지 말아야 하겠다.</p><p>최근 화두가 되었던 <code>노력중독</code> 이였던것 같은 18년은 털어버리고
내가 진짜로 좋아하고 하고 싶은 공부와 업무, 그리고 가족을 위해서 로드밸런싱 하면서 지내야 하겠다. </p><p>2006년에 쓴 미래의 내 모습과 어느정도 일치하는거 같지만 목표를 좀더 높이 잡아야할듯 하다.</p><p>번역에 참여하거나 책을 써본다던지 커뮤니티 활동을 좀더 적극적으로 해보고
회사에서 시키는 밋업이 아닌 자발적으로 참여하는 외부 강연이나 밋업을 위주로 해봐야겠다. </p><p>또한 점점 개발영역과 멀어지는거 같은 내모습이 나이가 들면서 더 심화될거 같아서 지인들과 별도의 개발 프로젝트를 진행해보려고 한다.</p><p>내 13년간 직장 생활중 가장 바쁘고 다이내믹하면서 바빴던 한해이자 많은 경험과 공부가 되었던 일년이였던것 같다.</p><p>나를 땡겨주셨던 <code>June</code>, 항상 분위기를 리드했던 <code>Joonbum</code>, 언제나 열정가득하고 최고의 DevOps 플레이어 <code>Jeongho</code>, 든든한 Backender <code>Donghun</code>, Excellent/Free/Kind(a.k.a EFK)한 <code>Minyoung</code>, 내가 인정하는 Frontier <code>Sanghun</code>, Best Rookie <code>Minsoo</code>, sorry because the hy <code>HyunSang</code>, Moontoring <code>Jinsoo</code>, Forever Mentor <code>Jaemoon</code>, Guru of CNI <code>Youngchae</code> 모두에게 감사의 말씀을 전하고 싶다. (무슨 수상소감도 아니고 ㅋㅋ)</p><p>19년에도 남들에게 존경을 받는 사람보다는 무슨일을 하든지 대중에게 욕먹지 않고 필요할때 도움을 요청을 할수 있는 그런 편한 사람이 되어야 겠다.</p>]]></content>
        <category label="Retrospective" term="Retrospective"/>
        <category label="2018" term="2018"/>
        <category label="Planning" term="Planning"/>
        <category label="Change" term="Change"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cloud Enginner]]></title>
        <id>/2018/12/25/cloud</id>
        <link href="https://ddii.dev/2018/12/25/cloud"/>
        <updated>2018-12-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Cloud Enginner]]></summary>
        <content type="html"><![CDATA[<p>오늘은 쓸데없는 이야기를 주저리 적어본다. </p><p>페친한분이 말씀하신 구절이 떠오른다.
<code>"엔지니어라고 해서 정치력이 필요없는것이 아니다. 오히려 혁신적인 기술은 정치력, 권력이 없으면 적용될 수 없다"</code> - 제프리 페퍼교수의 "권력의 기술"</p><p>나이 40을 넘긴 엔지니어로서 나는 어떤 위치인가?</p><p>Cloud 관련 오픈소스로 비즈니스를 진행하면서 현 직장에서 2년을 보냈다.
보람도 있었고 실패도 있었다.<br>
<!-- -->올해는 기획한 오픈소스 기반 프로젝트로 여러사람의 힘을 합쳐서 서비스를 런칭하기도 하였지만 몇년간 글로벌 플레이어들을 보면서 느낀점은  </p><p>회사가 글로벌 플레이어가 되기위해 노력하는 방법은 다양하지만<br>
<!-- -->결국 이윤을 목적으로 회사에서 허용하고 투자하는것이고<br>
<!-- -->그걸로 돈을 못벌면 바로 쳐낼수 있다는 경영층의 생각은 변함이 없을것이다. </p><p>이런 마음가짐을 변화시키지 않는다면 훌륭한 프로젝트라도 성공이든 실패든 끝까지 가는것은 어렵다고 생각한다. </p><p>처음 클라우드 관련 업무를 시작할때를 생각해본다.</p><ul><li><p>2010년<br>
<!-- -->팀장: 너 클라우드 할래?<br>
<!-- -->나 : 무슨일하는데요?<br>
<!-- -->팀장: 가상화 프로젝트하는데 같이 한번 비즈니스 만들어보자, 너가 하고 싶은대로 기획하고 해봐~<br>
<!-- -->나 : 네^^ 열심히 하겠습니다.  </p></li><li><p><code>개인 성과 및 팀의 목표는 어느정도 달성하였으나 ROI 달성은 쉽지 않았음</code></p></li><li><p>2016년<br>
<!-- -->팀장: 너 주간보고 똑바로 안해?, 지난번 장애보고는 어떻게 된거야?<br>
<!-- -->나: ㅠㅠ<br>
<!-- -->팀장: 우리 팀 수치가 이게 뭐냐... 좀 잘좀 해봐<br>
<!-- -->나: ㅠㅠ<br>
</p></li><li><p><code>결국 퇴사</code></p></li><li><p>2017년<br>
<!-- -->팀장: 하고 싶은대로 해봐
나: 진짜요? 뚝딱뚝딱<br>
<!-- -->회사: 수익모델이 뭐지?<br>
<!-- -->나: ...  </p></li><li><p><code>출시하기도 전에 서비스 종료</code></p></li><li><p>2018년<br>
<!-- -->팀장: 하고 싶은거 해봐요. 대신 돈벌어와야해<br>
<!-- -->나: 진짜요? 뚝딱뚝딱<br>
<!-- -->회사: 흠 좀 부족하지만 앞으로 좀더 잘해주세요. 레퍼런스 확보에 힘써주세요.<br>
<!-- -->나: 서비스 기획자가 필요합니다.<br>
<!-- -->회사: ... 본인이 해야하는거 아닌가요?<br>
<!-- -->나: ...<br>
</p></li><li><p><code>기획을 해야하나 아직 기술력도 부족한데...</code>  </p></li></ul><p>벌써 직장생활 13년차에 마흔살이 넘어가고 있다. </p><p>엔지니어로 살아온날보다 살아가야할날이 적게 남았고 얼마 남지 않았다는 생각이 드는 우울한 하루다.
10년간 공부해왔던 것들보다 2년동안 공부한게 더 파격적이고 다양하고 복잡했다.</p><p>여러모로 아쉬운 한해였다...</p><p>앞으로 내가 부족한 부분을 기술력으로 메꿀것이냐? 협상과 정치력으로 메꿀것이냐?</p><p>잠이 안오는 12월이다.</p>]]></content>
        <category label="Cloud" term="Cloud"/>
        <category label="Enginner" term="Enginner"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spinnaker on Kubernetes #3 (Kayenta)]]></title>
        <id>/2018/12/04/spinnaker-advanced-3</id>
        <link href="https://ddii.dev/2018/12/04/spinnaker-advanced-3"/>
        <updated>2018-12-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Spinnaker에 대해 알아봅니다 #3 (Kayenta)]]></summary>
        <content type="html"><![CDATA[<p>3번째 포스팅이다.</p><p>11/23 "Kubernetes Meetup" 1Day에서 발표한 이야기 연장선으로 작성한다.</p><p>고객에게 오퍼링을 위해 준비한 내용과 Kubernetes monitoring과 연계한 내용에 대해서 적어보려고 한다.
최근 발표를 다니면서 많이 받는 질문이 실제 사용할만 한가?라는 질문과 어떻게 활용해야 하는지에 대한 질문들을 많이 받는다.
오늘 최근 Spinnaker Summit 2018에서 중요하게 다뤘던 Kayenta 프로젝트를 가지고 이야기 해보려고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kayenta">Kayenta<a class="hash-link" href="#kayenta" title="Direct link to heading">​</a></h2><p>Kayenta는 자동 Canary 분석 오픈소스(Automated Canary Service(ACA))로 Spinnaker의 마이크로서비스중 하나로 동작한다.<br>
<!-- -->Automated Canary Deployments에 사용되고 자세한 내용은 <a href="https://www.spinnaker.io/guides/user/canary/stage/" target="_blank" rel="noopener noreferrer">canary documentation</a>을 확인하면 된다.  </p><p>새 종류의 하나인 Canary는 1차 세계대전중에 인간이 해를 입기 전에 독성가스를 탐지하는 용도로 사용되었다고 한다.
DevOps에서는 CD(Continuous Deployment) 프로세스의 일부로 사용되며 Canary 릴리즈는 새로운 버전의 Software를 Production에 배포하는 위험을 줄여주는 기술이라고 생각하면 된다.</p><p>Canary 신규 버전의 Software를 안정적인 기존 버전과 함께 배포하고 특정사용자나 일부 대상에게 트래픽 일부를 흘려 기존 사용자에게 영향을 최소하하고 새로운 버전의 문제를 신속하게 발견하고 이전의 안정된 버전으로 트래픽을 다시 라우팅시키는것이 주요 기능이라고 보면 된다.  </p><p>보통 품질 테스트 용도로 현재 운영 버전과 신규 버전의 주요한 지표(주로 Prometheus Metric)를 비교하여 평가를 진행하는데 이를 단위 테스트나 통합 테스트를 대체하여 사용해서는 절대 안된다.<br>
<!-- -->위에서 언급하였듯이 예기치 않은 위험을 최소화 하거나 문제를 신속하게 발견하는 것을 주 목적으로 하기 때문이다.</p><p>Spinnaker에서는 기본적으로 3가지 Cluster(Logical Application Group)를 사용한다.</p><ul><li>Production Cluster - 현재 실행중인 운영 버전으로 Replica는 임의로 변경할 수 있다. </li><li>Baseline Cluster - Production Cluster와 동일한 버전으로 실행됨</li><li>Canary Cluster - 변경된 신규 버전의 Software로 실행됨</li></ul><p>기본적으로 수동으로 진행할 경우에는 로그와 수집된 메트릭을 분석하고 객관적인 지표로 평가를 진행하는게 기본이다.
하지만 직접 사람이 하는 일이라 메트릭 데이터를 보다 보면 편견과 착오가 발생할 수 밖에 없다.</p><p>그래서 Netflix는 ACA(Automated Canary Service)라고 하는 자동화된 접근 방식을 통해 카나리 분석을 진행하고 있다.
수동으로 계산된 여러가지 지표를 가중치 기반으로 점수를 내리고 원하는 점수에 도달하면 배포하는 자동화된 방식이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h2><ul><li>spinnaker cluster - 1.8+ (1.9.3 이상 추천)</li><li>halyard - 1.0+</li><li>kubernetes cluster - 1.9+</li><li>metric services - datadog, prometheus, stackdriver, signalfx</li><li>persistent storage - S3(or compatible S3), minio, GCS</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kayenta-service-추가하기">Kayenta Service 추가하기<a class="hash-link" href="#kayenta-service-추가하기" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 아래 환경으로 작성하였다.</p><ul><li>spinnaker cluster - 1.10.5</li><li>halyard - 1.11</li><li>kubernetes cluster - 1.9.7</li><li>metric services - prometheus</li><li>persistent storage - compatible S3(IBM Object Storage)</li></ul><p>일단 기존 halyard config를 백업하자. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal backup create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ Create backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ Successfully created a backup at location:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Users/ddii/halbackup-Wed_Nov_28_13-35-31_KST_2018.tar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>나중에 복구는 아래와 같이 하면 된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal backup restore --backup-path &lt;backup-name&gt;.tar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존 halyard config를 살펴보면 아래와 같이 canary.enabled=false 로 되어있는 것을 확인 할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">currentDeployment: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploymentConfigurations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>canary analysis을 활성화 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary enable</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 default judgement algorithm은 <code>NetflixACAJudge-v1.0</code> 로 되어있다 다른 걸 이용하려면 다음과 같이 설정할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-judge CUSTOM_JUDGE</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>메트릭 소스로 prometheus를 설정한다. 물론 기존에 사용중인 prometheus endpoint url이 필요하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">hal config canary prometheus enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hal config canary prometheus account add my-prometheus --base-url http://YOUR_PROMETHEUS_SERVER:PORT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>여기서는 IBM Cloud Object Storage(S3 Compatible)을 사용하였지만 aws로 설정한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws account add my-s3 --bucket spin-bucket --endpoint \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3.seo-ap-geo.objectstorage.service.networklayer.com --access-key-id ACCESS_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret-access-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws edit --s3-enabled=true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>여러개의 메트릭을 동시에 설정 및 수집이 가능하므로 그중 prometheus 및 관련 account를 기본으로 설정한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-metrics-store prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-metrics-account my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-storage-account my-s3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 spinnaker cluster가 준비된 상태의 컨피그는 아래와 같다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">currentDeployment: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploymentConfigurations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  canary:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceIntegrations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: google</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      gcsEnabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stackdriverEnabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endpoint:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          baseUrl: http://YOUR_PROMETHEUS_SERVER:PORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        supportedTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - METRICS_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: datadog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bucket: spin-bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rootFolder: kayenta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endpoint: s3.seo-ap-geo.objectstorage.service.networklayer.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accessKeyId: ACCESS_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretAccessKey: ACCESS_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        supportedTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - OBJECT_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - CONFIGURATION_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      s3Enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reduxLoggerEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultMetricsAccount: my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultStorageAccount: my-s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultJudge: NetflixACAJudge-v1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultMetricsStore: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stagesEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    templatesEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    showAllConfigsEnabled: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Spinnaker Cluster를 재배포하게 되면 아래와 같이 spin-kayenta deployments가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal deploy apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-clouddriver-555cfc9765-kvnl8   1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-deck-85845b5b48-49ncm          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-echo-5f9dd4d8ff-mvt7g          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-fiat-5b945645d8-s2qcq          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-front50-5c57fcf587-tqz28       1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-gate-57576b8c45-w5v6r          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-kayenta-6dcd7767d6-rgb9w       1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-orca-788df6b9cc-tk6lk          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-redis-6c87c456fc-6qbl2         1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-rosco-f6f845d49-btjnd          1/1       Running   0          6d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 Dashboard에 접속하고 application중 하나의 Config에 들어가면 Features에 Canary메뉴가 생긴것을 확인할 수 있다. 사용설정하고 캐싱하는데 시간이 다소 필요하고 Tasks 메뉴에서 해당 job에 대한 내용을 확인할수 있다. </p><p><img loading="lazy" alt="canary" src="/assets/images/canary_config-57ef01bd86dbbbe0b3463b2bb83c0243.png" width="1045" height="603" class="img_E7b_"></p><p>이후 application delivery 메뉴를 보면 pipelines, canary configs, canary reports라는 메뉴가 생기게 된다. </p><p><img loading="lazy" alt="delivery" src="/assets/images/delivery-eef9175b5a136e62f7cd72a689bcefde.png" width="766" height="169" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="simple-deploy-pipeline-추가">simple deploy pipeline 추가<a class="hash-link" href="#simple-deploy-pipeline-추가" title="Direct link to heading">​</a></h2><p><a href="https://cloud.google.com/solutions/automated-canary-analysis-kubernetes-engine-spinnaker" target="_blank" rel="noopener noreferrer">https://cloud.google.com/solutions/automated-canary-analysis-kubernetes-engine-spinnaker</a> 가이드 처럼 구성해봐도 되나 <code>stackdriver</code>를 써야하고 <code>prometheus metric</code>을 활용한 가이드가 필요해서 적어보고자 한다.</p><p>새로 파이프라인을 추가한 다음 </p><p><img loading="lazy" alt="newpipe" src="/assets/images/newpipe-d4e9f69e18fde50d33ae018234d68016.png" width="595" height="261" class="img_E7b_"></p><p>Pipeline Actions - Edit Pipeline JSON 에서
<a href="https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/simple-deploy.json" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/simple-deploy.json</a> 을 추가해준다.  </p><p>해당 json pipeline을 추가하고 나면 다음과 같은 화면을 확인할수 있다.
<img loading="lazy" alt="pipe1" src="/assets/images/samplepipe1-fb6117126a3a4c5b9d9f314a19f0aad9.png" width="1151" height="1314" class="img_E7b_">
<img loading="lazy" alt="pipe2" src="/assets/images/samplepipe2-8387265c6cb69906e7cb8adc4c304432.png" width="1058" height="871" class="img_E7b_"></p><p>반드시 Deploy Config, Deploy Stage에서 배포할 Account 지정을 해야한다. </p><p><code>sampleapp image - ddiiwoong/canary-demo-spinnaker:latest</code></p><p>해당 pipeline내의 sampleapp은 python flask 기반으로 구성되어 간단히 internal 500 error를 원하는 비율을 configmap 변수로 구현할 수 있다. <a href="https://github.com/prometheus/client_python#counter" target="_blank" rel="noopener noreferrer">prometheus python client</a>를 사용하여 Gauge, Counter, Metric 서버를 간단하게 구성을 해보았다. 그리고 코드내에서 500 error rate를 구한 이유는 18년 11월 기준 spinnaker kayenta 버전에서는 PromQL(rate,irate와 같은 함수) 지원이 되지 않는다. 개발중인 코드에 포함이 된것을 확인하였고 12월 kubecon때 정식 릴리즈에 포함될거라 생각한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from random import randrange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from flask import Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from prometheus_client import start_http_server, Gauge, Counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app = Flask('kayenta-tester')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c = Counter('requests', 'Number of requests served, by http code', ['http_code'])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">g = Gauge('rate_requests', 'Rate of success requests')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responce_500 = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responce_200 = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rate_responce = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@app.route('/')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def hello():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global responce_500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global responce_200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global rate_responce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if randrange(1, 100) &gt; int(os.environ['SUCCESS_RATE']):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.labels(http_code='500').inc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responce_500 = responce_500 + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate_responce = responce_500 / (responce_500+responce_200) * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g.set(rate_responce)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return "Internal Server Error\n", 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.labels(http_code = '200').inc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responce_200 = responce_200 + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate_responce = responce_500 / (responce_500+responce_200) * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g.set(rate_responce)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return "Hello World!\n"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start_http_server(8000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app.run(host = '0.0.0.0', port = 8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당앱을 Start Manual Execuction을 통해 배포한다. Comfirm Execution창에서 SUCCESS_RATE를 원하는 값(예:70%)으로 선택하고 배포를 하고 나면 Infrastructure - Clusters 메뉴에서 해당 샘플앱을 확인할 수 있다. </p><p><img loading="lazy" alt="manaul deploy" src="/assets/images/manual-e2292b9d8cb972b8689b76e151c51dae.png" width="1199" height="389" class="img_E7b_">
<img loading="lazy" alt="success rate" src="/assets/images/successrate-85ead10953b6d655a150d6471669df12.png" width="1212" height="483" class="img_E7b_">
<img loading="lazy" alt="manaul deploy2" src="/assets/images/manual2-7342db27f311edd70cc2d1b07d7c8500.png" width="938" height="383" class="img_E7b_"></p><p>실제 해당 서비스를 접속해보면 위에 설정한 SUCCESS_RATE 비율로 200화면과 500에러를 확인할 수 있다. </p><p><img loading="lazy" alt="flaskweb" src="/assets/images/flaskweb-99e15d6c7aaf0a8305fd3fad53916d95.png" width="606" height="176" class="img_E7b_">
<img loading="lazy" alt="flaskweb2" src="/assets/images/flaskweb2-ca32501038173b934174ce58ecea90a5.png" width="614" height="162" class="img_E7b_"></p><p>해당 메트릭의 통계를 확인하기 위해 curl을 반복적으로 실행하는 injection container 를 실행한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n default run injector --image=alpine -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /bin/sh -c "apk add --no-cache --yes curl; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while true; do curl -sS --max-time 3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http://sampleapp:8080/; done"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>5분정도 후에 Prometheus로 접속하여 코드내 작성한 rate_requests 메트릭을 확인해본다.<br>
<!-- -->PromQL은 아래 쿼리를 실행하였다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">rate_requests{app="sampleapp",version="prod"}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>아래 그림과 같이 4개의 pod에서 70% 정도 200 OK, 30% 정도 500 Error가 발생하는 것을 확인할 수 있다. </p><p><img loading="lazy" alt="500rate" src="/assets/images/500rate-09760c0ab86a09095865edd35592cec8.png" width="1215" height="837" class="img_E7b_"></p><p>이 메트릭을 Spinnaker 에서 확인하기 위해 Canary Pipeline을 만들자.</p><p><a href="https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/automated-canary.json" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/automated-canary.json</a>를 JSON으로 Pipeline을 생성한다. </p><p><img loading="lazy" alt="canary_auto" src="/assets/images/canary_auto-b1920304073dfe8192b4b35af39902ad.png" width="996" height="471" class="img_E7b_"></p><p>Stage별로 살펴 보기전에 </p><ul><li>Prerequisite<br>Canary Config 구성이 먼저 필요하다. Delivery - Canary Configs 메뉴에서 신규 컨피그를 작성한다. <ul><li>Configuration Name - <code>kayenta-test</code></li><li>Filter Templates 메뉴를 먼저 생성한다. Canary, Baseline구분을 위해 version 정보를 선택하였다. </li><li>Metrics - Add Metric 은 분석을 위한 Prometheus Metric을 설정하는 단계로 <code>error_rate</code>가 증가(increase)하면 Pipeline을 중단시키고 Metric은 앞에서 확인한 <code>rate_requests</code>를 지정한다. Filter Template은 위에서 지정한 version을 선택한다. <img loading="lazy" alt="metric config" src="/assets/images/metric_config-cf291dbd8899fdbbbc5c6ccad0f45988.png" width="894" height="663" class="img_E7b_"></li><li>SCORING - 어짜피 예제는 한가지 Metric분석으로 0점 아니면 100점으로 나올것이므로 Maginal 75, Pass 95를 설정한다.</li></ul></li></ul><ol><li>1st Stage<ul><li>Configuration - Pipeline 실행시 초기 입력값(0-100, 10단위)으로 설정가능한 successRate 라는 Parameter를 설정한다. </li></ul></li><li>2nd Stage<ul><li>Find Baseline - 위에서 작성한 기본 Deploy Pipeline이 선택되었는지와 확인한다.</li><li>Deploy Canary Config - 앞에서 선택한 새로운 Parameter(successRate)를 신규 배포할 Canary Pod ConfigMap으로 설정하는 단계이다.</li></ul></li><li>3rd Stage<ul><li>Deploy Canary - yaml manifest로 Canary 버전을 배포한다. Replicas는 1로 설정하였고 배포될 Account(K8s Cluster)를 지정한다. </li><li>Deploy Baseline - yaml manifest로 Baseline 버전을 배포한다. 위와 동일하게 Replicas는 1로 설정하였고 배포될 Account(K8s Cluster)를 지정한다. </li></ul></li><li>4th Stage<ul><li>Canary Analysis - 중요한 Canary 분석 단계로 아래와 같이 설정을 확인한다. Prerequisite에서 설정한 Config(<code>kayenta-test</code>)를 선택하고 짧은 분석을 위해 1분(60초) 간격으로 3번 수행을 하도록 한다.   Filter Template에서 지정한 version(<code>version="${scope}"</code>) 분석을 위해 Baseline, Canary 설정을 하고 Location은 Namespaces로 생각하면 된다. <img loading="lazy" alt="aca config" src="/assets/images/aca_config-a0aaf5a5c7a7867a01913ee1d9cca704.png" width="720" height="947" class="img_E7b_"></li></ul></li><li>5th Stage<ul><li>Deploy to Production - Canary 분석이 통과하였을 경우 운영에 배포</li><li>Delete Canary, Delete Baseline - 성공이던 실패이던 Canary, Baseline 배포본을 삭제 </li></ul></li><li>6th Stage<ul><li>Successful deployment - Canary 분석이 통과하였을 경우 최종 완료 표기하는 단계</li></ul></li></ol><p>설정이 마무리가 되면 저장을 하고 Canary 분석에 들어간다.
최초에 <code>successRate</code>을 70으로 배포했다면 그 이하로 설정했을 경우에는 아래와 같이 Score 0점으로 배포가 실패하고 Pipeline이 종료된다.   </p><p><img loading="lazy" alt="fail" src="/assets/images/canary_fail-6eb5d2e8dc82e42f62b21d41acce9f6f.png" width="853" height="1001" class="img_E7b_">  </p><p>70 이상으로 설정하게 되면 Score 100점으로 정상 배포됨을 확인할 수 있다.</p><p><img loading="lazy" alt="success" src="/assets/images/canary_success-27d5394bff7c7d0c7e17dd2697c2d267.png" width="865" height="793" class="img_E7b_">  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>간단하게 Spinnaker 와 Prometheus Metric을 활용하여 Kayenta 기반 Canary 배포를 해봤다. 현재 Spinnaker 1.10에서 istio가 지원된다고 하니 다시 한번 확인하고 istio 기반 canary 배포와 함께 사용하는 방법을 더 연구해봐야 할 것 같다.  </p><p>올해 AWS re:invent 끝나고 작년보다 큰 현자타임이 왔다. 오픈소스로 먹고사는 사람들의 기분은 다 비슷할거 같다고 생각이 든다. 12월 11일 부터 Kubecon이 열린다고 하니 Kubernetes 관련한 새로운 프로젝트와 기능들에 집중해서 남들보다 한발 나아가야하지 않을까? 오픈소스로 먹고사시는 분들 다들 힘냈으면 좋겠다.</p>]]></content>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Spinnaker" term="Spinnaker"/>
        <category label="Continuous Delivery" term="Continuous Delivery"/>
        <category label="Continuous Deployment" term="Continuous Deployment"/>
        <category label="Pipeline" term="Pipeline"/>
        <category label="Canary" term="Canary"/>
        <category label="Canary analysis" term="Canary analysis"/>
        <category label="Kayenta" term="Kayenta"/>
        <category label="Automated Canary Service" term="Automated Canary Service"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spinnaker on Kubernetes #2]]></title>
        <id>/2018/09/27/spinnaker-advanced-2</id>
        <link href="https://ddii.dev/2018/09/27/spinnaker-advanced-2"/>
        <updated>2018-09-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Spinnaker에 대해 알아봅니다 #2]]></summary>
        <content type="html"><![CDATA[<p>이전 포스팅 <a href="https://ddii.dev/kubernetes/spinnaker-advanced-1/" target="_blank" rel="noopener noreferrer">Spinnaker on Kubernetes #1</a>에서 검토할때는 많이 개념을 이해하기 어려웠던것 같지만 어느정도 시간이 지났고 또 몇일 후에 발표도 있어서 다른 이야기를 해보고자 한다.  </p><p>지난 포스팅에 대충 집고 넘어간 용어들에 대한 정리를 다시 하고 기본적인 사상들을 정리해보고자 한다. 허접한 플랫폼 엔지니어 생각이니 언제든 다른 의견을 환영하는 바이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="what-is-spinnaker-history">What is spinnaker? (+History)<a class="hash-link" href="#what-is-spinnaker-history" title="Direct link to heading">​</a></h2><p>최근 트렌드인 멀티 클라우드를 지향하는 오픈소스 플랫폼이다.<br>
<!-- -->2014년 Netflix의 Asgard로 시작되어 2015년에 오픈소스화 되었다.<br>
<!-- -->빠른 속도와 신뢰도있는 소프트웨어 릴리즈를 위해 만들어졌으며 대부분의 메이저 클라우드 프로바이더들을 지원한다.(AWS,GCP,Azure,openstack..)<br>
<!-- -->현재 Netflix, Google, MS, Veritas등이 Contribution을 하고 있다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="왜-spinnaker를-써야하지">왜 Spinnaker를 써야하지?<a class="hash-link" href="#왜-spinnaker를-써야하지" title="Direct link to heading">​</a></h2><p>여러가지 이유가 있겠지만</p><ul><li>Multi-Cloud용 Continuous Delivery/Deployment Platform 으로 대체가 가능</li><li>다양한 pipeline 형태로 배포가 가능하고 Rollback이 쉬움</li><li>빠른 배포가 가능하고 여러번 배포가 용이함</li><li>유연한 pipeline management system을 가지고 있음</li><li>다양한 배포전략을 가진다(Blue-Green, Rolling Red/Black, Canary)</li><li>community 활동 활발 (github, slack) - 답은 잘 안해줌 ㅠㅠ</li><li>VM과 Container 동시에 통합관리 가능</li><li>CI통합 용이(Jenkins)</li><li>CLI를 통한 설치 및 관리(halyard)</li><li>VM, Helm Packaging 가능</li><li>RBAC 지원</li><li>Notification - Email, Slack, Hipchat등</li><li>Safe Deployment - Judgement (승인기능)</li><li>Chaos Monkey Built-in</li></ul><p>이정도면 무조건 써야하지 않을까?</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jenkins-vs-spinnaker">Jenkins vs Spinnaker<a class="hash-link" href="#jenkins-vs-spinnaker" title="Direct link to heading">​</a></h2><table><thead><tr><th align="center">Jenkins</th><th align="center">Spinnaker</th></tr></thead><tbody><tr><td align="center">강력한 빌드서버</td><td align="center">클라우드 자원의 1차 연동</td></tr><tr><td align="center">완전한 deployment tool이 아님</td><td align="center">vm &amp; deployments 안에 빌드되어 있음</td></tr><tr><td align="center">스크립팅이 많이 필요함</td><td align="center">별도의 스크립팅이 많이 필요없음</td></tr><tr><td align="center">기능들이 모두 플러그인 형태</td><td align="center">CI tool이 아님(CI tools이 백엔드로)</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-vs-spinnaker">Kubernetes vs Spinnaker<a class="hash-link" href="#kubernetes-vs-spinnaker" title="Direct link to heading">​</a></h2><table><thead><tr><th align="center">Kubernetes</th><th align="center">Spinnaker</th></tr></thead><tbody><tr><td align="center">리소스 사용 제한</td><td align="center">정의한 퍼센트로 rollout</td></tr><tr><td align="center">slow rollout</td><td align="center">각 단계별 검증 가능</td></tr><tr><td align="center">High rollback cost</td><td align="center">Fast rollbacks</td></tr><tr><td align="center">Linear rollouts</td><td align="center">resource 사용량이 큼</td></tr><tr><td align="center">검증단계가 없음</td><td align="center"></td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploy-pipeline">Deploy Pipeline<a class="hash-link" href="#deploy-pipeline" title="Direct link to heading">​</a></h2><p>Spinnaker를 사용할때 기본적으로 아래와 같은 파이프라인으로 구성한다.<br>
<!-- -->수동으로 UI나 API로 트리거링할수 있고, 자동으로 Jenkins 등과 트리거 연동하여 빌드완료시 배포되도록 할수 있다.</p><p><img loading="lazy" alt="spinnaker-pipeline" src="/assets/images/spinnaker-pipeline-7b27fbf5bddf6d0c506c5f20a8a9f36a.png" width="942" height="399" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deployment-strategies">Deployment Strategies<a class="hash-link" href="#deployment-strategies" title="Direct link to heading">​</a></h2><p>Spinnaker에서의 배포전략은 다음과 같이 제공된다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/deployment-strategies.png" alt="deployment-strategies" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="red--black-same-as-blue--green">Red / Black (same as Blue / Green)<a class="hash-link" href="#red--black-same-as-blue--green" title="Direct link to heading">​</a></h3><ul><li>동일한 양의 instance로 이루어진 새로운 Server Group을 생성한다</li><li>신규 Server Group이 정상상태가 되면 LB는 신규 Server Group에 트래픽을 분산한다. </li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="rolling-redblack">Rolling red/black<a class="hash-link" href="#rolling-redblack" title="Direct link to heading">​</a></h3><ul><li>이전과 동일하지만 인스턴스별 또는 그룹별로 rolling</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="canary">Canary<a class="hash-link" href="#canary" title="Direct link to heading">​</a></h3><ul><li>가장 작은 개수의 인스턴스를 교체시키고</li><li>새로운 버전으로 트래픽을 분산시킨다 (1~5프로)</li><li>새로운 버전에 이슈가 없을때까지 테스트를 진행하고</li><li>특정시간까지 이슈가 없으면 배포를 늘려간다. </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="용어정리-2탄">용어정리 2탄<a class="hash-link" href="#용어정리-2탄" title="Direct link to heading">​</a></h2><p>이전 <a href="https://ddiiwoong.github.io/2018/spinnaker-advanced-1/" target="_blank" rel="noopener noreferrer">post</a>에서 정리한걸 다시 복기하고 추가적인 내용을들 적어봤다.</p><p>사용하면서 혼돈이 많이 생기는 부분이다 이게 GCE나 EC2를 쓰면 용어 매칭이 쉬운데 k8s를 위한 별도의 메뉴가 아닌 기능을 통합하다보니 용어가 조금 혼동스럽게 구성이 되었다.<br>
<!-- -->특히 Load Balancer 부분은 Service로 매핑되고 퍼블릭 k8s에서 제공하는 Type LoadBalancer는 미지원한다.<br>
<!-- -->그리고 모든 Resource들은 Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)을 지원하며 Versioning이 지원된다.  Versioning은 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy" target="_blank" rel="noopener noreferrer">여기</a>에 설명된 대로 <code>strategy.spinnaker.io/versioned</code> annotation을 통해 manifest별로 재정의가 가능하다.</p><table><thead><tr><th align="center">Spinnaker</th><th align="center">Kubernetes</th><th align="center">비고</th></tr></thead><tbody><tr><td align="center">Server Group</td><td align="center"><a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a></td><td align="center"><a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">CRD의 경우 별도 Build</a></td></tr><tr><td align="center">Clusters</td><td align="center">Logical Server Group</td><td align="center"></td></tr><tr><td align="center">Load Balancer</td><td align="center">Services</td><td align="center">LoadBalancer(k8s) 미지원</td></tr><tr><td align="center">Firewall</td><td align="center">NetworkPolicies</td><td align="center"></td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="application-management">Application Management<a class="hash-link" href="#application-management" title="Direct link to heading">​</a></h3><p>Spinnaker에서 Application 이란 배포하려는 서비스를 나타내는 구조라 생각하면 된다.  </p><ul><li>pipeline</li><li>Clusters, Server Group의 집합이며, firewall과 loadbalancer를 포함한다.</li><li>Canary Config</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cluster">Cluster<a class="hash-link" href="#cluster" title="Direct link to heading">​</a></h3><p>Kubernetes의 Cluster가 아니라 Spinnaker에서 Server Group의 논리적인 그룹</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="server-group">Server Group<a class="hash-link" href="#server-group" title="Direct link to heading">​</a></h3><p>기본자원인 서버그룹은 배포할수 있는 artifacts(vm image, docker image, source)와 인스턴스(pod) 수, Auto-Scaling, metadata 등 기본 구성등을 가지고 있다.<br>
<!-- -->서버그룹은 LoadBalacer나 Firewall 도 선택적으로 연결되고, vm이나 pod 형태로 배포된 application의 집합체라 볼수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cloud-provider">Cloud Provider<a class="hash-link" href="#cloud-provider" title="Direct link to heading">​</a></h3><ul><li>IaaS - AWS, GCP, Azure, Oracle, Openstack</li><li>PaaS -  Google App Engine</li><li>Orchestrator - K8s, DC/OS</li><li>Docker v2 Registry</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="account">Account<a class="hash-link" href="#account" title="Direct link to heading">​</a></h3><p>Cloud Provider에 인증하기 위한 Spinnaker에서만 사용하는 Account Name</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pipeline">Pipeline<a class="hash-link" href="#pipeline" title="Direct link to heading">​</a></h3><p>Pipeline은 주요 배포 관리도구로 사용된다.
Stage라고하는 일련의 Action으로 구성되며 파이프라인을 따라 Stage간 매개변수 전달이 가능하다.<br>
<!-- -->수동으로 시작하거나, Jenkins 작업완료, Docker Registry 신규 Docker 이미지, Cron일정 또는 다른 Stage와 같은 이벤트에 의해 자동으로 트리거링되도록 구성할수 있다.<br>
<!-- -->Pipeline 실행중에(시작/완료/실패) mail, slack, hipchat(사라짐)을 통해 Alert가 가능하다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/pipelines.png" alt="pipeline" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="stage-atomic-building-block">Stage (atomic building block)<a class="hash-link" href="#stage-atomic-building-block" title="Direct link to heading">​</a></h3><p>Pipeline이 수행할 동작을 말한다.<br>
<!-- -->Deploy, Resize, Disable, Manual Judgement 등을 수행할수 있다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/pipelines/pipeline-tasks.png" alt="stage" class="img_E7b_"></p><ul><li>Stage - Multiple steps</li><li>Step - 진행되기전에 교정/폴링이 필요한 tasks</li><li>Task - 특정 Cloud Platform으로 동시에 여러 API호출</li><li>Operation - 단위 API</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>용어나 개념은 어느정도 정리된듯 하고 다음 포스팅에서는 실제 multi cluster 환경에서 deploy하고 pipeline을 사용하는 내용을 적어볼 예정이다.</p>]]></content>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Spinnaker" term="Spinnaker"/>
        <category label="Continuous Delivery" term="Continuous Delivery"/>
        <category label="Continuous Deployment" term="Continuous Deployment"/>
        <category label="Pipeline" term="Pipeline"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[knative]]></title>
        <id>/2018/08/01/knative</id>
        <link href="https://ddii.dev/2018/08/01/knative"/>
        <updated>2018-08-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[knative 대해 알아봅니다]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative">Knative<a class="hash-link" href="#knative" title="Direct link to heading">​</a></h2><p>미친놈들 모여서 미친것을 만들었군.. ㅎㅎ
예상했던 내용들을 현실로 만드는 클라스</p><p>Kubernetes 관련 비지니스를 하고 있는 입장에서 봐도 놀랄일이지만
인프라 영역부터 개발자 영역까지 모두를 추상화시키는 클라우드 네이티브의 힘이란 참 대단하다.</p><p>오늘은 knative에서 주요기능들을 둘러보고자 한다.</p><p>개인적인 생각은 Kubernetes 진영이라고 해야하나 CNCF 진영이라고 해야하나..
그동안 노래를 부르고 주목했던 CRDs, Operators, Serverless Workload, CloudEvents, Mesh Layer 개념과 영역을 흡수해서 그 기반으로 확장시키고 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://storage.googleapis.com/knative-releases/serving/latest/release.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 코드 내용을 상세하게 보고있지만 담은것들이 정말 많다. 그래도 다 이해하려면 하나하나 챙겨봐야 한다.</p><p>오늘은 일단 코어 기능만 살펴본다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build">Build<a class="hash-link" href="#build" title="Direct link to heading">​</a></h2><p><code>build</code>는 Knative의 주요 <code>custom resource</code>이고 이를 이용하여 fetch, build, package를 수행한다. repo의 소스를 빌드하고 컨테이너로 이미지로 만들고 그다음에 Knative <code>Serving</code>으로 보낸다고 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build-용어">Build 용어<a class="hash-link" href="#build-용어" title="Direct link to heading">​</a></h3><ul><li><code>Build</code>는 여러 <code>steps</code>을 포함하고 <code>Builder</code>로 구체화된다</li><li><code>Builder</code>는 컨테이너 이미지 유형</li><li><code>Build</code>내 <code>steps</code>은 repository에 push를 할 수 있음</li><li><code>BuildTemplate</code> 는 재활용가능한 템플릿</li><li><code>Build</code>내 <code>source</code>는 kubernetes Volume으로 mount되는 데이터를 정의할수 있고 git, Google Cloud Storage, 컨테이너 이미지를 지원함.</li><li>kubernetes Secret을 사용하여 <code>ServiceAccount</code>로 인증함</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serving">Serving<a class="hash-link" href="#serving" title="Direct link to heading">​</a></h2><p>Knative <code>Serving</code>은 Kubernetes와 Istio를 기반으로 Serverless Workload가 클러스터에서 작동하는 방식을 정의하고 제어하는데 사용된다고 하지만 엄연히 Public FaaS(AWS Lambda등)와는 구별되어야 한다고 생각한다.</p><p>Serverless 라고 하는 용어를 쉽게 생각하는 사람들이 많은데 결국 나중에는 간단한 애플리케이션들은 다 Serverless 스타일로 전환될것이라는 사상을 서비스나 플랫폼에 넣고 있는 추세다. </p><p>CNCF 진형의 Cloud Event라고 하는 이벤트 그리드방식의 표준화를 따라 가는것인지 아니면 새로운 스타일을 정의하려고 하는것인지는 그들의 향후 Cloud Native 로드맵에 달려있다 해도 무방할것 같다. </p><ul><li>Serverless Container의 신속한 배치가 가능</li><li>Automatic scaling up and down to zero</li><li>Istio Component</li><li>배포 된 코드 및 config의 특정 시점 스냅 샷</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serving-resources"><code>Serving</code> Resources<a class="hash-link" href="#serving-resources" title="Direct link to heading">​</a></h3><p>CRDs로 정의한 Objects 집합체, 이러한 Object들은 Serverless 워크로드 형태로 정의되고 사용된다.
가장 인상깊고 중요한 문구는 <code>Request-driven compute that can scale to zero</code> 인 것 같다.</p><p>한동안 유행했던 OpenPaaS, CF기반의 PaaS 플랫폼을 뛰어넘는 구축형 그것도 스프링부트 영역까지도 kubernetes 기반 이벤트 드리븐 서버리스로 간다는 이야기...</p><p>이미 퍼블릭으로는 <a href="https://cloud.spring.io/spring-cloud-function/" target="_blank" rel="noopener noreferrer">GA</a>도 되었다.</p><p>우리 팀원들과 함께 열심히 vmware dispatch framework으로 개발하고 있지만 결국 pivotal과 vmware는 거의 한몸이기에 더욱 더 변화가 필요한 순간이다.</p><p><img loading="lazy" src="https://github.com/knative/serving/raw/master/docs/spec/img/object_model.png" alt="serving" class="img_E7b_"></p><ul><li><code>Route</code>는 사용자 서비스에 대한 HTTP endpoint를 제공.</li><li><code>Revisions</code>은 code(function)와 config로 구성된 불변의 스냅샷. Route를 통해 endpoint를 할당받지 못한 Revision은 자동으로 kubernetes resource에서 삭제됨</li><li><code>Configuration</code>은 요구되는 Revision 최신 상태를 기록하고 생성하고 추적할수 있음. 소스 패키지(git repo나 archive)를 컨테이너로 변환하기 위한 내용이나 메타데이터등을 포함시킬수 있음. </li><li><code>Service</code>는 <code>Routes</code>와 <code>Configurations</code> 리소스의 추상화된 집합체. 모든 워크로드의 lifecycle을 관리함. 트래픽을 항상 최신의 revision으로 route되도록 정의할수 있음</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="events">Events<a class="hash-link" href="#events" title="Direct link to heading">​</a></h2><p>CNCF의 <a href="https://www.cncf.io/events/" target="_blank" rel="noopener noreferrer">CloudEvent Spec.</a> 기반으로 하는 이벤트를 produce/comsume 하는 방법을 제공한다. 플러그인 형태로 이벤트를 수신할수 있고 다양한 pub/sub 스타일의 broker service를 통해 제공될수 있다. </p><p>Azure는 이미 <a href="https://azure.microsoft.com/ko-kr/services/event-grid/" target="_blank" rel="noopener noreferrer">EventGrid서비스</a>를 GA를 한 상황이고 <a href="https://pivotal.io/kr/knative" target="_blank" rel="noopener noreferrer">Pivotal</a> 진영도 Serverless Workload는 <code>Knative</code>기반으로 넘어간다고 했으니 <a href="https://github.com/vmware/dispatch" target="_blank" rel="noopener noreferrer">Dispatch</a> 도 결국 따라가지 않을까 생각해본다. </p><p><img loading="lazy" src="https://github.com/knative/docs/raw/master/eventing/concepts.png" alt="eventing_concept" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bus">Bus<a class="hash-link" href="#bus" title="Direct link to heading">​</a></h3><p>Kafka나 Nats와 같은 메시지 Bus를 통해 K8s기반의 pub/sub을 제공하는 개념. 이벤트는 Channel에 의해 게시되고 관심있는 사람에게 라우팅됨.</p><ul><li>Channel : 여기서 이야기 하는 채널은 특정 bus에 사용되는 이벤트를 받기 위한 네트워크 기반 엔드포인트</li><li>Subscription : Channel에서 수신한 이벤트를 관심있는 target, DNS이름으로 표현되는 이벤트에 연결함</li><li>Bus : (kafka topic에 이벤트가 전달되는것 처럼) 특정 지속성 전략을 사용하여 Channel과 Subscription을 구현하는데 필요한 적용 계층을 정의함</li></ul><p>현재 3가지의 Bus가 제공됨 (<a href="https://github.com/knative/eventing/tree/master/pkg/buses/kafka" target="_blank" rel="noopener noreferrer">Kafka</a>, <a href="https://github.com/knative/eventing/tree/master/pkg/buses/stub" target="_blank" rel="noopener noreferrer">Stub</a>, <a href="https://github.com/knative/eventing/tree/master/pkg/buses/gcppubsub" target="_blank" rel="noopener noreferrer">GCP PubSub</a>)</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sources">Sources<a class="hash-link" href="#sources" title="Direct link to heading">​</a></h3><p>Source는 K8s 외부의 데이터 소스를 프로비저닝하고 이를 클러스터로 라우팅하기 위한 추상화 레이어를 제공함. 아래와 같은 소스들을 제공하고 있음</p><ul><li>Feed : EventType과 Action (CloudEvents 호환 HTTP endpoint)간의 연결을 정의하는 기본 객체</li><li>EventType and ClusterEventType : EventSource에서 분리되는 공통스키마로 특정 이벤트의 집합, EventType은 Namespace 범위내에서 사용되고 ClusterEventType은 모든 Namespace에서 사용될수 있도록 관리자에 의해 설치됨</li><li>EventSource and ClusterEventSource : 하나 이상의 EventTypes를 생성 할 수있는 외부 시스템을 기술함</li></ul><p>현재 3가지 Sources를 제공함</p><ul><li>K8sevents : <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#event-v1-core" target="_blank" rel="noopener noreferrer">Kubernetes Events</a>를 수집하고 CloudEvents 타입으로 표시함</li><li>Github : PR(pull request) notification을 수집하고 CloudEvents 타입으로 표시함</li><li>GCP PubSub : GCP PubSub topic으로 publish된 이벤트를 수집하고 CloudEvents 타입으로 표시함</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="flows">Flows<a class="hash-link" href="#flows" title="Direct link to heading">​</a></h3><p>마지막으로 Source에서 Endpoint까지 묶어주는 Flow라고 부르는 높은 수준의 추상화가 있다.
Spec으로 이벤트가 라우팅된 Channel과 Bus를 기재하여 사용할 수 있다.
Flow는 Eventing에서 최상위 개념으로 사용자가 선택할수 있고, 외부 Source 이벤트에서 목적지까지 원하는 경로를 기술할수 있다.</p><h1>정리</h1><p>워낙 방대한 양을 가지고 있고 이해하려고 노력하면서 적다보니 번역위주로 되어버렸다.
원래 다음번에 Nats Streaming을 다룰 예정이였으나,
당분간은 knative 구성요소를 이해하고 적용하는 위주로 포스팅을 할 예정이다. 아마도 모듈별(Serving, Building, Eventing) 시리즈가 될 듯 하다.</p>]]></content>
        <category label="Knative" term="Knative"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="FaaS" term="FaaS"/>
        <category label="Serverless" term="Serverless"/>
        <category label="CRDs" term="CRDs"/>
        <category label="CloudEvents" term="CloudEvents"/>
        <category label="Mesh" term="Mesh"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dex]]></title>
        <id>/2018/07/26/dex</id>
        <link href="https://ddii.dev/2018/07/26/dex"/>
        <updated>2018-07-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Dex 대해 알아봅니다]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dex---a-federated-openid-connect-provider">Dex - A federated OpenID Connect provider<a class="hash-link" href="#dex---a-federated-openid-connect-provider" title="Direct link to heading">​</a></h2><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dex는-기본적으로-openid-connect를-사용하여-다른-애플리케이션의-인증을-하게-해주는-identity-서비스다">dex는 기본적으로 OpenID Connect를 사용하여 다른 애플리케이션의 인증을 하게 해주는 identity 서비스다.<a class="hash-link" href="#dex는-기본적으로-openid-connect를-사용하여-다른-애플리케이션의-인증을-하게-해주는-identity-서비스다" title="Direct link to heading">​</a></h3><p><a href="https://github.com/coreos/dex" target="_blank" rel="noopener noreferrer">https://github.com/coreos/dex</a></p><p>Dex는 "connectors"를 통해 다른 identity provider의 포털(게이트웨이, 중계자) 역할을 한다. 이를 통해 LDAP, SAML또는 GitHub, Google, AD(Active Directory)와 같은 기존 인증을 dex에게 위임할 수 있다. 클라이언트는 일단 인증 로직을 작성하여 dex와 통신하면 dex는 주어진 백엔드(여기서는 예시로 kubernetes 클러스터)에 대한 프로토콜을 처리하게 된다. </p><p>하지만 향후 Cloud Native 인증 카탈로그 중 하나로서 생각하고 있는 오픈소스이다 보니 테스트는 진행해봐야 할 것 같다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="openid-connect">OpenID Connect<a class="hash-link" href="#openid-connect" title="Direct link to heading">​</a></h3><p>기본적으로 Dex는 OIDC(OpenID Connect)를 사용한다.<br>
<!-- -->그러므로 <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#using-kubectl" target="_blank" rel="noopener noreferrer">kubernetes 클러스터 사용자 인증용도</a>로 Dex를 붙일수 있는 것이다.<br>
<!-- -->또한 위에서 말한것과 같이 다른 identity provider를 사용하여 사용자를 인증하는데 아래 그림과 같이 <a href="https://github.com/coreos/dex#connectors" target="_blank" rel="noopener noreferrer">connectors</a>를 사용한다. </p><p><img loading="lazy" alt="dex_image" src="/assets/images/dex-flow-1eef87ca6cace19b3f458729579af0bd.png" width="760" height="460" class="img_E7b_"></p><p>위 그림과 같이 "connectors"는 다른 identity provider를 통해 사용자를 인증하기 위해 dex에서 사용하는 기본 도구다. 결국 Dex는 기존에 활용하던 GitHub, LinkedIn 및 Microsoft AD와 같은 벤더 플랫폼이나 LDAP 및 SAML과 같은 기존 프로토콜 방식을 사용하여 kubernetes 클러스터 사용자 인증을 쉽게 구현할 수 있는 것이다. 큰 회사??들은 OpenLDAP이나 Microsoft Active Directory와 같은 사내 디렉토리 서비스를 운용하거나 내가 있는 작은 규모의 팀들은 대부분 Github이나 Google 계정은 가지고 있을 것이기 때문에 Dex와 같은 오픈소스를 사용함으로써 기존 identity provider 와 kubernetes를 쉽게 통합할 수 있다고 본다.</p><p><img loading="lazy" alt="dex_kube" src="/assets/images/dex_architect-a6de41c76b10157ce30883eb12fec059.png" width="561" height="321" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-oidc">Kubernetes OIDC<a class="hash-link" href="#kubernetes-oidc" title="Direct link to heading">​</a></h3><p>아래 그림처럼 Identity Provider 위치에 Dex를 구성하면 된다.</p><p><img loading="lazy" src="https://d33wubrfki0l68.cloudfront.net/d65bee40cabcf886c89d1015334555540d38f12e/c6a46/img/docs/admin/k8s_oidc_login.svg" alt="kube_openid" class="img_E7b_"></p><p>public managed kubernetes 환경에서는 현실적으로 kubeapi-server를 컨트롤하기 어렵기 때문에 일단 Native 클러스터에 구성을 하도록 한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="github-연동하기">Github 연동하기<a class="hash-link" href="#github-연동하기" title="Direct link to heading">​</a></h3><p>테스트로 Github을 연동해보자. 일단 아래와 같이 인증서를 생성하는 스크립트를 하나만든다.<br>
<!-- -->아래에서 DNS.1 부분은 /etc/hosts로 테스트로 등록할 도메인으로 가상으로 만들었다. (generator.sh)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt; EOF &gt; ssl/req.cnf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[req]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">req_extensions = v3_req</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguished_name = req_distinguished_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[req_distinguished_name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ v3_req ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">basicConstraints = CA:FALSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjectAltName = @alt_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[alt_names]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.1 = dex.newtech.academy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -out ssl/ca-key.pem 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -x509 -new -nodes -key ssl/ca-key.pem -days 10 -out ssl/ca.pem -subj "/CN=kube-ca"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -out ssl/key.pem 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -key ssl/key.pem -out ssl/csr.pem -subj "/CN=kube-ca" -config ssl/req.cnf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -req -in ssl/csr.pem -CA ssl/ca.pem -CAkey ssl/ca-key.pem -CAcreateserial -out ssl/cert.pem -days 10 -extensions v3_req -extfile ssl/req.cnf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Namespace도 하나 만들자. (dex-ns.yaml)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: dex</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kubernetest 클러스터용 인증서를 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./generator.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f dex-ns.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret tls dex.newtech.academy.tls -n dex --cert=ssl/cert.pem --key=ssl/key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cp ssl/ca.pem pki/openid-ca.pem</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Github에 가서 아래와 같이 Org OAuth App.을 신규로 생성한다.  </p><p><img loading="lazy" alt="github" src="/assets/images/dex_github-1ed6b600c442333faa787c6ced1743ff.png" width="556" height="407" class="img_E7b_"></p><p>만든 위 앱정보로 Github-Client Secret을 만든다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export GITHUB_CLIENT_ID=&lt;Client ID&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export GITHUB_CLIENT_SECRET=&lt;Client Secret&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generic github-client \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -n dex \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-literal=client-id=$GITHUB_CLIENT_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-literal=client-secret=$GITHUB_CLIENT_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                  TYPE                                  DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-f29fb   kubernetes.io/service-account-token   3         27m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex.newtech.academy.tls    kubernetes.io/tls                     2         27m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github-client         Opaque                                2         6s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret github-client -o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client-id: xxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client-secret: xxxxxxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: 2018-07-24T15:14:29Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: github-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceVersion: "7044721"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selfLink: /api/v1/namespaces/dex/secrets/github-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uid: 42dfa0e9-8f54-11e8-8d6d-2aaad36eb114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type: Opaque</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 이야기 했지만 여기까지 아무생각없이 퍼블릭에서 구성하다가 생각해보니 kube-apiserver를 변경하려면 직접 클러스터를 써야한다는 이런 바보같은 실수를 또 저지르고 말았다. 그래서 다시 VM에 재구성을 ㅜㅜ</p><p>그리고 kube-apiserver manifest 파일에 아래 내용을 추가한다.<br>
<!-- -->/etc/kubernetes/manifests/kube-apiserver.manifest</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-issuer-url=https://dex.newtech.academy:32000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-client-id=example-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-ca-file=/pki/openid-ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-username-claim=email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - --oidc-groups-claim=groups</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 kubelet 재시작을 한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl restart kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>테스트를 위해 dex sample app을 빌드하고 만든 인증서와 함께 실행하게 되면 아래와 같이 샘플페이지를 볼수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo apt-get install make golang-1.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/coreos/dex.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git checkout v2.10.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export PATH=$PATH:/usr/lib/go-1.9/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go get github.com/coreos/dex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ make bin/example-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export MY_IP=$(curl -s ifconfig.co)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./bin/example-app --issuer https://dex.newtech.academy:32000 --issuer-root-ca /pki/openid-ca.pem --listen http://${MY_IP}:5555 --redirect-uri http://${MY_IP}:5555/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2018/07/25 14:37:52 listening on http://169.56.94.55:5555</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="dex_sample" src="/assets/images/dex_sample-9a5c8b5247b98ec2212ebe08f1643d4b.png" width="334" height="181" class="img_E7b_"></p><p>그리고 로그인을 하게 되면 아래와 같이 Github 인증을 통해 kubernetes 클러스터에서 사용하려고 하는 Token을 획득할 수 있다.</p><p><img loading="lazy" alt="kube_dex" src="/assets/images/kube_dex-ccd37f6afcbbc44fd31782cf20991954.png" width="538" height="657" class="img_E7b_"></p><p><img loading="lazy" alt="dex_token" src="/assets/images/dex_token-4c8c3ec72343e5a92fc01a139b4e03e2.png" width="686" height="462" class="img_E7b_"></p><p>다음으로 위에서 만든 token을 사용하기 위해서 Role, RoleBinding과 실제 로그인할 github 계정을 User로 사용하도록 아래와 같이 작성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiGroups: [""] # "" indicates the core API group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources: ["pods"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  verbs: ["get", "watch", "list"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: exampleUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: User</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ddiiwoong@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>계정생성을 하고 위에서 만든 token을 가지고 developer 사용자를 설정하고 context설정로 dev-default로 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f user.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">role.rbac.authorization.k8s.io "exampleUser" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io "exampleUser" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export TOKEN=&lt;dex_sample_app_token&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config set-credentials developer --auth-provider=oidc --auth-provider-arg=idp-issuer-url=https://dex.newtech.academy:32000 --auth-provider-arg=client-id=example-app --auth-provider-arg=idp-certificate-authority=/pki/openid-ca.pem  --auth-provider-arg=id-token=${TOKEN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User "developer" set.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config set-context dev-default --cluster=kubernetes --namespace=default --user=developer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Context "dev-default" created.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위처럼 만들고 나면 현재 클러스터의 context들을 확인할수 있다. 확인후에 context를 dev-default로 바꿔보자.<br>
<!-- -->새로운 context를 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         admin-cluster.local   cluster.local   admin-cluster.local   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          dev-default           kubernetes      developer             default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config use-context dev-default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Switched to context "dev-default".</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                  CLUSTER         AUTHINFO              NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          admin-cluster.local   cluster.local   admin-cluster.local   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         dev-default           kubernetes      developer             default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                                    READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-42d44                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-r9p9d                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dex           dex-64c4fb5b44-w5s2m                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-2bqll                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-cljb2                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   calico-node-svh5n                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-apiserver-node1                    1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-controller-manager-node1           1/1       Running   2          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-7bd4d5fbb6-7bb2j               3/3       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-7bd4d5fbb6-g8lz8               3/3       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node1                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node2                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-node3                        1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-scheduler-node1                    1/1       Running   2          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kubedns-autoscaler-679b8b455-qxlvw      1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kubernetes-dashboard-55fdfd74b4-mbkm8   1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   nginx-proxy-node2                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   nginx-proxy-node3                       1/1       Running   0          13h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   tiller-deploy-5c688d5f9b-52tls          1/1       Running   0          13h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h3><p>처음에도 언급했듯이 kubernetes 인증을 위해 무거운 keycloak을 사용을 하는 경우들이 많은데 간단하게 사용할 수 있는 dex를 사용하여 여러가지 identity provider의 connector 역할로 사용하기에는 무난한것 같다.<br>
<!-- -->결국 Dex를 이용하면 GitHub를 비롯해 다양한 OpenID, OAuth 2.0 인증 서비스와 Kubernetes 클러스터를 엮기 쉬울수 있다.<br>
<!-- -->단, 최근 commit이 3-4달전이라는것과 처음 stable helm에 등록된 후 업데이트가 없었다는 점이 걱정되는 부분이긴 하다. (묘하게 Redhat과 합병 일정이 오버랩 되긴한다...)</p><p>거의 2주만에 포스팅인데 '18 Google Next 키노트에서 <a href="https://github.com/knative/" target="_blank" rel="noopener noreferrer">knative</a>라는 현재 개발중인 프로젝트와 유사한 오픈소스가 공개되었다. 다음번엔 knative도 한번 테스트를 해봐야 할듯 하다. </p><p>퍼블릭과 프라이빗 클러스터에 대한 고민이 생기기 시작한다. 다시금 오픈소스 플랫폼에 집중하기 위해 프라이빗으로 돌아가야 하나라는 고민에도 빠져있는 상태에서 knative, GKE on Premise 같은 엔터프라이즈에서 프라이빗 구축을 위한 것들도 나오고 있어서 더더욱 고민에 빠진 요즘이다...</p>]]></content>
        <category label="dex" term="dex"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="identity service" term="identity service"/>
        <category label="OIDC" term="OIDC"/>
        <category label="connectors" term="connectors"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cert-manager]]></title>
        <id>/2018/07/13/cert-manager</id>
        <link href="https://ddii.dev/2018/07/13/cert-manager"/>
        <updated>2018-07-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Cert-manager에 대해 알아봅니다]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tls-인증서">TLS 인증서<a class="hash-link" href="#tls-인증서" title="Direct link to heading">​</a></h2><p>제한된 예산과 시간, 인력으로 서비스를 만들다 보니 어려운 점들이 참 많다. 특히나 TLS 인증서 같은 경우 관리하는것이 은근히 귀찮다. 인증서 만료일 관리하는것 부터 어느 페이지까지를 평문으로만 두어야 하는지도... 그런데 바보같은 이슈를 저지르고 말았다. 도메인을 신청하고 fanout, Name based virtual hosting 방식중에 고민하다가 설계를 virtual host로 하였다.  </p><p>그런데 문제는 어이없는곳에서 나왔다. *.xxxxx.io 라고 wildcard SSL 인증서를 신청하였는데 virtual host방식으로 2차 subdomin (예, api.stg.xxxxx.io)으로 ingress를 마구잡이로 생성하고 인증서를 적용을 했다. 하지만 인증서 오류 ㅋㅋ</p><p>인터넷 비지니스를 거의 해보지 않아서 인지, 이런 기본적인 내용도 간과하고 서비스를 구상한 내가 모든걸 책임져야하는 상황이 와버렸다. </p><p>설계를 이상하게 해서 wildcard 도메인을 몇십개를 신규로 계약해야하는 쓸데없는 비용을 들어야하는 처지가 되었다. 하지만 그냥 죽으란 법은 없는게 사람사는 세상이고 이런 고민들을 분명 다른사람들도 했을거야라고 생각하면서 떠오른게 let's encrypt 였고 찾아보니 이걸 또 kubernetes에서 발급부터 갱신까지 해주는 오픈소스를 찾아 적용까지 하고 이렇게 포스팅을 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cert-manager">Cert-manager<a class="hash-link" href="#cert-manager" title="Direct link to heading">​</a></h3><p>인증서 없이 구성할수도 있지만 기본적으로 kubernetes 는 secret과 ingress의 간단한 설정만으로 TLS를 구성할 수 있다.  </p><ul><li>Cert-manager : K8s 클러스터내에서 TLS인증서를 자동으로 프로비저닝 및 관리하는 오픈소스</li><li>Let’s Encrypt :  자율적으로 작동하는 개방된 CA(Certificate authority-인증기관)으로 공공성(공공의 이익)을 위해서 운영되는 오픈소스</li></ul><p><a href="http://docs.cert-manager.io/en/latest/" target="_blank" rel="noopener noreferrer">Cert-manager</a>는 AWS의 Certificate Manager와 유사하게 인증서를 발급하고 설정할수 있다. 3개월 유효기간을 가지는 <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">let's encrypt</a>를 사용하기에 인증서 만료시 문제가 될거라 생각했지만 이것도 자동으로 갱신을 해주는 관리 app.을 같이 배포하기 때문에 인증서 관리에 대한 부담을 덜수 있다.  </p><p>기본적으로 Cert-manager는 <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">let's encrypt</a>, <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault</a> 같은 것을들 사용하여 인증서 발급을 할 수 있다. 인증서 발급후에도 만료가 되기 전에 바로 갱신을 자동으로 한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구성">구성<a class="hash-link" href="#구성" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="http://docs.cert-manager.io/en/latest/_images/high-level-overview.png" alt="certmanager" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전준비사항">사전준비사항<a class="hash-link" href="#사전준비사항" title="Direct link to heading">​</a></h3><ul><li><a href="https://docs.helm.sh/using_helm/#installing-helm-client" target="_blank" rel="noopener noreferrer">helm</a></li><li>k8s cluster (1.7+) - CRD 사용이 가능해야함</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="설치">설치<a class="hash-link" href="#설치" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm install --name cert-manager --version v0.3.1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace kube-system stable/cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm status cert-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Fri Jun 15 10:02:45 2018</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: DEPLOYED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESOURCES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1/Pod(related)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY  STATUS   RESTARTS  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager-5f76b676b4-5tdh8  1/1    Running  0         2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1/ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       SECRETS  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  1        28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/CustomResourceDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificates.certmanager.k8s.io    28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuers.certmanager.k8s.io  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">issuers.certmanager.k8s.io         28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; v1beta1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager-cert-manager  1        1        1           1          28d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-manager has been deployed successfully!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In order to begin issuing certificates, you will need to set up a ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or Issuer resource (for example, by creating a 'letsencrypt-staging' issuer).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">More information on the different types of issuers and how to configure them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">can be found in our documentation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://cert-manager.readthedocs.io/en/latest/reference/issuers.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For information on how to configure cert-manager to automatically provision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Certificates for Ingress resources, take a look at the `ingress-shim`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">documentation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://cert-manager.readthedocs.io/en/latest/reference/ingress-shim.html</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="인증서-설정-및-배포">인증서 설정 및 배포<a class="hash-link" href="#인증서-설정-및-배포" title="Direct link to heading">​</a></h3><p>인증서 등록 및 만료시 noti를 받기 위한 변수 설정을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export EMAIL=zaction@sk.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 issuer manifest를 배포한다.<br>
<!-- -->(letsencrypt-issuer.yaml)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Copyright 2018 Google Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Licensed under the Apache License, Version 2.0 (the "License");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># you may not use this file except in compliance with the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># You may obtain a copy of the License at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     https://www.apache.org/licenses/LICENSE-2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Unless required by applicable law or agreed to in writing, software</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># distributed under the License is distributed on an "AS IS" BASIS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># See the License for the specific language governing permissions and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># limitations under the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: letsencrypt-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: https://acme-staging-v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email: ''</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privateKeySecretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: letsencrypt-staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http01: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: https://acme-v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email: ''</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privateKeySecretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http01: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>두개의 endpoint를 생성한다. (Staging, Prod)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sed -e "s/email: ''/email: $EMAIL/g" letsencrypt-issuer.yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl apply -f-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuer "letsencrypt-staging" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterissuer "letsencrypt-prod" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Web App을 HTTP Ingress 형태로 배포한다. TLS발급전에 미리 HTTP(80) Ingress를 배포해야 한다. 이후 Let's encrypt TLS배포 후 TLS spec을 추가하고 재배포를 해야한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          serviceName: faas-auth-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          servicePort: 8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tls-인증서-발급">TLS 인증서 발급<a class="hash-link" href="#tls-인증서-발급" title="Direct link to heading">​</a></h3><p>인증서를 발급할때는 위에서 만든 Ingress로 생성하고namespace별 생성이 필요하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: certmanager.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-dev-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: auth #### namespace별 생성</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secretName: auth-dev-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  issuerRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: letsencrypt-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: ClusterIssuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commonName: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dnsNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  acme:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - http01:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ingress: auth-ingress ### 기존에 만든 HTTP ingress 명</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      domains:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - auth.dev.action.cloudz.co.kr</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f auth-dev-tls.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificate "auth-dev-tls" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 TLS 생성 상태를 확인한다. 이때 Message에서 <code>Normal   CeritifcateIssued     Certificated issued successfully</code> 문구가 확인되면 인증서 발급이 정상적으로 되었다고 볼 수 있다.<br>
<!-- -->이때 발급되는 시간이 네트워크 환경에 따라 1~5분정도 소요될때로 있는것으로 보인다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe -f auth-dev-tls.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type     Reason                Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----     ------                -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning  ErrorCheckCertificate Error checking existing TLS certificate: secret "auth-dev-tls" not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   PrepareCertificate    Preparing certificate with issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   PresentChallenge      Presenting http-01 challenge for domain foo.kubernetes.tips</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   SelfCheck             Performing self-check for domain auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   ObtainAuthorization   Obtained authorization for domain auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   IssueCertificate      Issuing certificate...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Normal   CeritifcateIssued     Certificated issued successfully</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>secret이 생성된것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret | grep tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth-dev-tls                 kubernetes.io/tls                     2         3h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 위에서 만든 Ingress에 TLS를 적용한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: auth-ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ingress.bluemix.net/hsts: enabled=true maxAge=&lt;31536000&gt; includeSubdomains=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ingress.bluemix.net/redirect-to-https: "True"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - host: auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          serviceName: faas-auth-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          servicePort: 8081</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - hosts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - auth.dev.action.cloudz.co.kr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretName: auth-dev-tls</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 설정을 적용하고 상태를 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f auth-tls-ingress.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           HOSTS                          ADDRESS         PORTS     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth-ingress   auth.dev.action.cloudz.co.kr   10.1.1.182   80, 443   14h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="cert-tls" src="/assets/images/cert-tls-44f1bafbb8d04958c83803b445548083.png" width="1174" height="1022" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>설계의 실수로 시작되었지만 정리하다보니 인증서 갱신이 자동을 된다는 점과 또한 Kubernetes환경에서 TLS관리가 간편하다는것을 알게 되었다. 인증서 비용을 아낀것도 하나의 성과이기도 하다. 인증서는 써야하겠고 정말 많은 애플리케이션들을 생성/삭제를 상시 해야하는 환경이라면 한번 적용해볼만한 가치가 있는것 같다.</p>]]></content>
        <category label="Cert-manager" term="Cert-manager"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="TLS" term="TLS"/>
        <category label="Manage TLS Certificates" term="Manage TLS Certificates"/>
        <category label="Security" term="Security"/>
        <category label="HTTPS" term="HTTPS"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Operators & CRDs(CustomResourceDefinitions) on Kubernetes]]></title>
        <id>/2018/07/09/operator</id>
        <link href="https://ddii.dev/2018/07/09/operator"/>
        <updated>2018-07-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Operators, CRD(Custom Resource Definitions)에 대해서 알 수 있다.]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-in-kubernetes">Operators in Kubernetes<a class="hash-link" href="#operators-in-kubernetes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-란">Operators 란?<a class="hash-link" href="#operators-란" title="Direct link to heading">​</a></h3><p>정의(<a href="https://coreos.com/operators/" target="_blank" rel="noopener noreferrer">Definition</a>) : Kubernetes Application 을 패키징, 배포, 관리하는 방법. Helm과는 조금 달라 따로 이야기 해보고자 한다.</p><p>기본적으로 Kubernetest Application은 kubernetes에 의해 배포되고 kubect과 kube-API를 사용하여 관리한다.</p><p>결론적으로 말하면 Kubernetes에 내가 만든 application을 서비스하고 관리하려면 결국 Kubernetes의 API들을 모두 이해하고 사용할수 있어야 한다. 일반적인 개발자에게 진입장벽이 어느정도 있다고 보여지며 이를 모두 이해시키는것도 조직적인 측면에서는 낭비일수 도 있다. 그래서 Helm등을 통한 application배포 전략을 세우기도 하지만 이것도 한계가 있을수 있다. 그래서 Operator는 Kubernetes상에서 application을 관리하는 런타임이라고 생각하는게 맞는것 같다.</p><p><img loading="lazy" src="https://coreos.com/sites/default/files/inline-images/Overview-etcd_0.png" alt="etcd" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators">Operators<a class="hash-link" href="#operators" title="Direct link to heading">​</a></h2><p>Operators는 application마다 운영정보를 넣을수 있다.</p><p>Kubernetes 에 배포된 응용프로그램의 모든 특성을 알 필요가 없고 이를 통해 사용자는 매니지드 클라우드 서비스 경험(기존 IaaS/PaaS관리와 유사)과 유사하게 운영이 가능하다.  </p><p>Operator가 배포되면 Kubernetes API확장 개념인 CRDs(Custom
Resource Definitions)을 사용하여 관리할수 있다.
Kubernetes에 Stateful 서비스를 배포하는 단순하고 좋은 방법이 될수 있다.  </p><p>예를 들면, Postgres 클러스터, Prometheus 클러스터, Etcd 클러스터 같이 운영측면의 application들을 유지, 운영하는데 쓰일수 있다. (자세한건 뒤쪽 예시로 설명하겠다)</p><p>그러면 먼저 CRDs(Custom Resource Definitions)에 대해서 먼저 알아본다. CRDs에 대해서는 별도로 정리하려 하다가 내용이 많이 않아 핵심적인 내용만 같이 적어본다.</p><ul><li>Custom Resource Definitions(a.k.a CRDs)</li><li>k8s Object를 확장해서 사용할 수 있는 가장 간단한 방법</li><li>CRDs는 Kubernetes의 확장 기능</li><li>Kubernetes 사용자가 클러스터내에서 직접 custom Object를 yaml형태로 생성, 수정, 삭제, 사용할수 있도록 하는 기능  <ul><li>K8s database(etcd)와 API를 그대로 활용할 수 있음)</li><li>CRUD 가능 (Create, Read, Update, Delete)</li></ul></li><li>모든 클러스터에 동적으로 resource 등록/삭제 가능</li><li>Operators는 CRDs를 포함하고 있음<ul><li>Operator를 추가하면 CRDs가 등록됨</li></ul></li><li>Resource 당 하나의 API 버전만 지원(~1.10버전, 1.11버전 이후 개수 제한 없어짐)</li><li>1.8+ 이후부터 JSON 스키마 유효성 검증 가능
<strong> *주의사항 : etcd가 별도 분리된 managed서비스나 etcd 인스턴스가 분리된 환경에서 사용권고</strong></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="주요-활용용도">주요 활용용도<a class="hash-link" href="#주요-활용용도" title="Direct link to heading">​</a></h3><ul><li>Operators</li><li>Application 정보 저장</li><li>RouteRule on istio</li><li>GameServer on Agones</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="crds-관련-발표자료">CRDs 관련 발표자료<a class="hash-link" href="#crds-관련-발표자료" title="Direct link to heading">​</a></h2><p><a href="https://ddiiwoong.github.io/2018/openinfraday18/" target="_blank" rel="noopener noreferrer">https://ddiiwoong.github.io/2018/openinfraday18/</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="operators-example">Operators example<a class="hash-link" href="#operators-example" title="Direct link to heading">​</a></h3><p><a href="https://coreos.com/operators/etcd/docs/latest" target="_blank" rel="noopener noreferrer">etcd</a>, <a href="https://github.com/rook/rook" target="_blank" rel="noopener noreferrer">Rook</a>, <a href="https://coreos.com/operators/prometheus/docs/latest" target="_blank" rel="noopener noreferrer">Prometheus</a>, <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault</a>, <a href="https://github.com/oracle/mysql-operator" target="_blank" rel="noopener noreferrer">MySQL</a>, <a href="https://github.com/CrunchyData/postgres-operator" target="_blank" rel="noopener noreferrer">Postgres</a>, <a href="https://github.com/spotahome/redis-operator" target="_blank" rel="noopener noreferrer">Redis</a>, <a href="https://github.com/nbogojevic/kafka-operator" target="_blank" rel="noopener noreferrer">kafka-비공식</a> 등 Operator로 배포될수 있는 예시들은 해당 링크를 보면 자세히 확인할 수 있다. (오라클이 공격적으로 K8s비지니스로 뛰어드는듯한 그림이다…)  </p><p>주로 저장소나 키-밸류 스토어, RDB등의 운영안정성을 위한 클러스터 구성을 위한것들이 대부분이며 점점 도입을 해나가는 추세이긴것 같긴 하다. 이번에 진행해보고자 하는건 분산 키-밸류 스토어이자 kubernetes의 메인저장소로 쓰이는 etcd 이다.</p><p>기본적으로 etcd cluster objects는 CRDs로 생성한다. Kubernetes 기본 resource가 아닌 CRDs 이기 때문에 안정성 측면에서 불안하다고 생각할수도 있다. 하지만 <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/aggregated-api-servers.md" target="_blank" rel="noopener noreferrer">User Aggregated API Servers</a> 를 적용하여 안정성, 유효성 검사 및 버전 관리가 개선되었다고 한다. Aggregated API를 사용하면 사용자에게 최소한의 영향을 주면서 Kubernetes objects가 생성되거나 사용자가 etcd operator를 배포,관리할수 있다. (말이 길어서 그렇지 그냥 etcd 클러스터 구성)</p><p>현재 프로젝트는 베타로 0.9.2까지 나와 있으며 RedHat이 CoreOS를 합병하는 바람에 문서들이 업데이트가 늦어지는것 같긴하지만 조만간에 1.0이 나올것 같긴 하다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="etcd-operator"><a href="https://github.com/coreos/etcd-operator/#overview" target="_blank" rel="noopener noreferrer">etcd-operator</a><a class="hash-link" href="#etcd-operator" title="Direct link to heading">​</a></h3><p>etcd operator는 기본적으로 다음과 같은 기능을 한다.</p><ul><li>Create and Destroy</li><li>Resize</li><li>Failover</li><li>Rolling upgrade</li><li>Backup and Restore</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h4><ul><li>Kubernetes 1.8+</li><li>etcd 3.2.13+</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="installation-guide">Installation guide<a class="hash-link" href="#installation-guide" title="Direct link to heading">​</a></h3><p>설치는 단순하다. 먼저 RBAC설정을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/coreos/etcd-operator.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ example/rbac/create_role.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 etcd-operator 배포</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: quay.io/coreos/etcd-operator:v0.9.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - etcd-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Uncomment to act for resources in all namespaces. More information in doc/clusterwide.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #- -cluster-wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: MY_POD_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: MY_POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fieldPath: metadata.name</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>deployment.yaml 내용을 보면 CustomResourceDefinition이 존재하지 않는다.
etcd-operator가 자동으로 CRD를 생성하기 때문에 아래와 같이 CRD를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get customresourcedefinitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                    KIND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdclusters.etcd.database.coreos.com   CustomResourceDefinition.v1beta1.apiextensions.k8s.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="etcd-cluster-createresizefailoverupgrade">etcd cluster create/resize/failover/upgrade<a class="hash-link" href="#etcd-cluster-createresizefailoverupgrade" title="Direct link to heading">​</a></h3><p>operator를 이용하여 etc cluster를 구성한다. operator를 통한 클러스터 구성내용을 확인하면 아주 단순하다. 버전과 사이즈뿐이다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: "etcd.database.coreos.com/v1beta2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: "EtcdCluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: "example-etcd-cluster"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Adding this annotation make this cluster managed by clusterwide operators</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## namespaced operators ignore it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #   etcd.database.coreos.com/scope: clusterwide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  size: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: "3.2.13"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcdcluster.etcd.database.coreos.com/example-etcd-cluster created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>순차적으로 etcd cluster가 구성되는것을 볼수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-wrhxz    1/1       Running   0          3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          1m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이번에는 scale-out 테스트를 진행한다.<br>
<!-- -->example/example-etcd-cluster.yaml 내용에서 <code>size: 3</code> 을 <code>size: 5</code> 로 변경하고 다시 적용하면 2 node가 추가로 생성된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f example/example-etcd-cluster.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-wrhxz    1/1       Running   0          3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          34s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          50s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          8m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>반대로 줄이는것도 동일하다.</p><p>failover 테스트의 경우에도 그냥 pod를 삭제하거나 worker를 날리는것으로도 동일하게 spec을 유지하는 kubernetes resource 특성으로 인해 바로 생성이 되는것을 확인할수 있다.</p><p>이번에는 operator만 날려보겠다. 아래처럼 operator deployment만 삭제를 해도 pods는 남아있는것을 볼수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment "etcd-operator" deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions "etcd-operator" deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2kd4t667j5   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          13m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>etcd pod 하나를 날려본다. 4개 pod만 남은것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete pod example-etcd-cluster-2kd4t667j5 --now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod "example-etcd-cluster-2kd4t667j5" deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          9m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          18m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          17m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다시한번 operator를 배포하게 되면 잠시후에 5개로 다시 pod가 복원된것을 확인할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f example/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions/etcd-operator created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-operator-69b559656f-8ks8m    1/1       Running   0          44s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-2pwm84lrf4   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-97qk6gs4sp   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-k4lxm96v7h   1/1       Running   0          20m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-kskgvlbsm9   1/1       Running   0          10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example-etcd-cluster-lm7mkhvldw   1/1       Running   0          19m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>업그레이드의 경우도 다른 resource와 동일하게 version 부분을 변경하여 rollout이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>다음 소스를 통해 직접 operator를 개발이 가능하다.<br>
<!-- -->(Source: <a href="https://coreos.com/operators/" target="_blank" rel="noopener noreferrer">https://coreos.com/operators/</a>)</p><p>Operator SDK를 사용하면 Kubernetes API 상세스펙을 배우지 않고도 쉽게 operator 빌드가 가능하다.
또한 관리를 위한 Operator Lifecycle Manager나 Operator Metering 같은 기능을 사용하여 좀더 관리측면에서 강화하고자 하는 CoreOS진영의 노력이 보이는듯 하다.</p><p>아직 alpha, beta단계의 operator 프로젝트들이 대부분이지만 helm차트와 같이 kubernetes API 스펙을 이해하고 사용하지 않고도 쉽게 운영자가 기반 어플리케이션을 관리 할수 있다는것으로 보아 향후 RedHat이나 Oracle 진영에서 본인들 kubernetes 관련 제품들을 홍보하고 서비스라인에 포함시키는 방향으로 적극적으로 개발을 하고 있는것으로 보인다. 앞으로 mysql, redis, kakfa 등을 operator로 배포하고 관리하는 일이 더 많아 질것 같다.</p>]]></content>
        <category label="Operators" term="Operators"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="CRDs" term="CRDs"/>
        <category label="CustomResourceDefinitions" term="CustomResourceDefinitions"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Cilium]]></title>
        <id>/2018/07/06/cilium-1</id>
        <link href="https://ddii.dev/2018/07/06/cilium-1"/>
        <updated>2018-07-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Cilium에 대해 알아봅니다]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-누구냐-넌">Cilium 누구냐 넌?<a class="hash-link" href="#cilium-누구냐-넌" title="Direct link to heading">​</a></h2><p>처음에 놀랐다. 번역하면 '자궁', '섬모', '속눈썹'등 익숙치 않은 단어라서 놀랐지만 차근히 보다보니 결국 OS내부(리눅스 커널)에서부터 컨테이너간 또는 외부와의 연결을 보호하는 역할이라고 하니 이해가 되는 것 같다.</p><p>홈페이지에 정의된 내용을 보면 아래 내용과 같다. </p><blockquote><p><a href="https://cilium.readthedocs.io/en/v1.1/intro/#what-is-cilium" target="_blank" rel="noopener noreferrer">Cilium</a> - Docker 및 Kubernetes와 같은 Linux 컨테이너 관리 플랫폼을 사용하여 배포된 응용 프로그램 서비스 간의 네트워크 연결을 보호하는 오픈 소스 소프트웨어</p></blockquote><p>페북에 <a href="https://www.facebook.com/groups/korelnxuser/" target="_blank" rel="noopener noreferrer">한국 리눅스 사용자 그룹</a>에서도 <a href="https://www.facebook.com/tommy.lee.98229" target="_blank" rel="noopener noreferrer">Tommy Lee</a>님이나 <a href="https://www.facebook.com/changan.song" target="_blank" rel="noopener noreferrer">송창안</a>님이 몇몇 게시물을 올려주셔서 관심있게 보던중에 아래와 같은 내용을 보고 이거다 하고 파보기 시작했다.</p><blockquote><p>Cilium은 Docker 및 Kubernetes와 같은 리눅스 컨테이너 프레임 워크에 API 기반의 네트워크 보안 필터링을 제공하며,
또한, BPF라는 새로운 Linux 커널 기술을 사용하여 컨테이너/POD ID를 기반으로 네트워크 계층 및 응용 프로그램 계층 보안 정책을 정의 및 적용하는 것에 있어서 간단하면서 효율적인 방법을 제공하고 있습니다.</p></blockquote><p>윗분들처럼 커널 자체를 분석하고 공부하고 기여하려면 소요되는 시간이 더 걸릴거 같고 서비스를 운영하고 개발하는 입장에서는 내 프로젝트에 적용 가능성을 검증하는것이 나을것 같아 정리를 해본다.</p><p>iptables을 기반으로 IP와 Port기반의 전통적인 포워딩 기술은 벌써 20년이라는 세월동안 널리 사용되어 왔다. 특히 퍼블릭/프라이빗 클라우드 제품군들 모두 iptables기반의 Security Group등을 기본으로 제공하고 있고 Kubernetes 마저도 CNI 핵심으로 iptables을 활용하고 있다.  </p><p>동적으로 변화하고 매우 복잡한 마이크로서비스를 사용하는 시대에 전통적인 방식의 IP, Port관리는 비효율적인 측면이 없지 않다. BPF(아래인용)을 활용하여 리눅스 커널내에서 데이터 포워딩을 할 수 있고 Kubernetes Service기반 Load Balancing이나 istio와 같은 Service Mesh를 위한 Proxy Injection 을 통해 여러 활용을 할 수 있을거라고 Cilium 프로젝트는 이야기 하고 있다. </p><blockquote><p>버클리 패킷 필터(Berkeley Packet Filter, BPF)</p><p>BPF는 버클리 패킷 필터(Berkeley Packet Filter)의 줄임말이다. 이름 그대로 패킷을 걸러내는 필터이다. 그런데 BSD에서의 BPF는 네트워크 탭(리눅스의 PF_PACKET)까지 아우르는 개념이다. 옛날 옛적에 유닉스에는 CSPF(CMU/Stanford Packet Filter)라는 게 있었는데 BPF라는 새 구조가 이를 대체했다. 이후 리눅스에서는 네트워크 탭을 나름의 방식으로 구현하고 패킷 필터 부분만 가져왔다. 리눅스의 패킷 필터를 리눅스 소켓 필터링(LSF: Linux Socket Filtering)이라고도 한다.<br>
<!-- -->(발췌) <a href="https://wariua.github.io/facility/extended-bpf.html" target="_blank" rel="noopener noreferrer">https://wariua.github.io/facility/extended-bpf.html</a> </p></blockquote><p>Cilium은 Dockercon 2017에서 최초 <a href="https://www.youtube.com/watch?v=ilKlmTDdFgk" target="_blank" rel="noopener noreferrer">announce</a>를 하였고 2018년 4월 24일에 1.0이 정식 Release된 이후 많은 관심을 받을것으로 예상되어 실제 서비스에 적용해볼 필요가 있을거 같아 minikube로 테스트한 내용을 끄젹여 본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cilium-architecture">Cilium Architecture<a class="hash-link" href="#cilium-architecture" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="Cilium Architecture" src="/assets/images/cilium_arch-96f6efd4a70465e9cbfd890e9da1f159.png" width="700" height="624" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="main-feature">Main Feature<a class="hash-link" href="#main-feature" title="Direct link to heading">​</a></h2><ul><li>고효율 BPF Datapath  <ul><li>모든 데이터 경로가 클러스터 전체에 완전 분산</li><li>Envoy같은 proxy injection 제공, 추후 sidecar proxy 형태 제공예정</li></ul></li><li>CNI, CMM plugins  <ul><li>Kubernetes, Mesos, Docker에 쉽게 통합가능</li></ul></li><li>Packet, API 네트워크 보안<br>패킷기반 네트워크 보안과 API 인증을 결합하여 전통적인 패킷기반 네트워크 보안과 마이크로서비스 아키텍처 모두에게 보안 제공가능  <ul><li><a href="http://docs.cilium.io/en/doc-1.0/concepts/#arch-id-security" target="_blank" rel="noopener noreferrer">ID기반</a> - Source IP에만 의존하지 않고 모든패킷에 workload identity를 encoding하여 식별성 강화  </li><li><a href="http://docs.cilium.io/en/doc-1.0/policy/language/#ip-cidr-based" target="_blank" rel="noopener noreferrer">IP/CIDR기반</a>이외에도 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#services-based" target="_blank" rel="noopener noreferrer">Kubernetes Service기반</a>으로 정책 설정가능</li><li>L7기반 <a href="http://docs.cilium.io/en/doc-1.0/policy/language/#layer-7-examples" target="_blank" rel="noopener noreferrer">API보안</a> 적용가능</li></ul></li><li>분산,확장가능한 Load Balacing
BPF를 사용한 고성능 L3,L4 Load Balancer 제공
(Hasing, Weighted round-robin)<ul><li>kube-proxy 대체 - Kubernetes ClusterIP가 생성될때 BPF기반으로 자동으로 적용됨 </li><li><a href="http://docs.cilium.io/en/doc-1.0/api/" target="_blank" rel="noopener noreferrer">API driven</a> - 직접 API를 활용하여 확장가능</li></ul></li><li>단순화된 네트워크 모델<br>Overlay/VXLAN, Direct/Native Routing 지원</li><li>가시성  <ul><li><a href="https://github.com/cilium/microscope" target="_blank" rel="noopener noreferrer">Microscope</a> - 클러스터 레벨에서 모든 이벤트 필터링 가능</li><li>API기반 가시성 제공</li></ul></li><li>운영<ul><li>클러스터 헬스체크 - HTTP, ICMP기준 클러스터 latency 체크가능</li><li>Prometheus 통합 - 모든 메트릭을 Prometheus로 전달가능</li><li>클러스터 분석 및 <a href="http://docs.cilium.io/en/doc-1.0/troubleshooting/#cluster-diagnosis-tool" target="_blank" rel="noopener noreferrer">리포트툴</a> </li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h2><ul><li>kubectl &gt;= 1.7.0</li><li>minikube &gt;= 0.22.3</li></ul><p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a> 설치와 <a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="noopener noreferrer">minikube</a> 구성은 별도로 해야한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="start-minikube">Start minikube<a class="hash-link" href="#start-minikube" title="Direct link to heading">​</a></h2><p>넉넉하게 4GB 이상 메모리로 minikube를 구동한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start --kubernetes-version v1.9.0 --network-plugin=cni --extra-config=kubelet.network-plugin=cni --memory=5120 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-minikube-cluster-status">Check minikube cluster status<a class="hash-link" href="#check-minikube-cluster-status" title="Direct link to heading">​</a></h2><p>minikube구성이 완료되면 아래와 같이 클러스터 상태를 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 STATUS    MESSAGE              ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-manager   Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler            Healthy   ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd-0               Healthy   {"health": "true"}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-etcd-dependency-of-cilium">Install etcd (dependency of cilium)<a class="hash-link" href="#install-etcd-dependency-of-cilium" title="Direct link to heading">​</a></h2><p>cilium 의존성을 위해 etcd를 별도로 배포한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -n kube-system -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/addons/etcd/standalone-etcd.yaml  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service "etcd-cilium" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset.apps "etcd-cilium" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-all-pods-etcd">Check all pods (etcd)<a class="hash-link" href="#check-all-pods-etcd" title="Direct link to heading">​</a></h2><p>모든 pod가 <code>Running</code> 상태인지 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-cilium-0                      1/1       Running   0          1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   etcd-minikube                      1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-addon-manager-minikube        1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-apiserver-minikube            1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-controller-manager-minikube   1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns-86f4d74b45-lhzfv          3/3       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-proxy-tcd7h                   1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-scheduler-minikube            1/1       Running   0          4m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   storage-provisioner                1/1       Running   0          4m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-cilium">Install Cilium<a class="hash-link" href="#install-cilium" title="Direct link to heading">​</a></h2><p>Kubernetes 클러스터에 Cilium을 인스톨한다. 기본적으로 DaemonSet 형태로 배포되기 때문에 Node당 한개의 Cilium Pod를 볼 수 있다. Cilium은 <code>kube-system</code> namespace에서 실행된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/kubernetes/1.9/cilium.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap "cilium-config" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret "cilium-etcd-secrets" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.extensions "cilium" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io "cilium" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io "cilium" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount "cilium" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>kube-system namespace에 RBAC설정과 함께 Cilium이 배포되고, ConfigMap, DaemonSet 형태로 배포가 된다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="check-deployment">Check deployment<a class="hash-link" href="#check-deployment" title="Direct link to heading">​</a></h2><p>Cilium Deployment가 <code>READY</code> 상태로 바뀔때까지 기다린다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get daemonsets -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium    1         1         1         1            0           &lt;none&gt;          2m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploy-demo-app">Deploy Demo App.<a class="hash-link" href="#deploy-demo-app" title="Direct link to heading">​</a></h2><p>아래 데모그림을 보면 스타워즈의 영감을 받아서인지 deathstar, xwing 등으로 구분한것을 확인할수 있다. deathstar deployments의 경우 80포트로 http 웹서버가 2개의 pod replica로 Load Balancing되고 있다. deathstar 서비스는 우주선이 착륙할수 있도록 활주로를 서비스하고 있다. 하지만 제국군의 tiefighter 만 착륙하도록 해야하므로 보안설정을 해야하는 상황이다. </p><p><img loading="lazy" src="https://cilium.readthedocs.io/en/v1.1/_images/cilium_http_gsg.png" alt="starwars" class="img_E7b_"></p><p>아래 <code>http-sw-app.yaml</code> 은 세가지 deployment를 가지고 있고 각각의 deployment는 <code>(org=empire, class=deathstar)</code>, <code>(org=empire, class=tiefighter)</code>, <code>(org=alliance, class=xwing)</code>와 같이 label 정보를 가진다. deathstar Service는 <code>(org=empire, class=deathstar)</code> label을 가지고 Load Balancing을 한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/http-sw-app.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service "deathstar" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment "deathstar" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment "tiefighter" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment "xwing" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>총 4개의 pod와 1개의 서비스를 확인할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods,svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-mqgfs   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/deathstar    ClusterIP   10.109.80.174   &lt;none&gt;        80/TCP    1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>각각의 pod는 Cilium에서는 <a href="https://cilium.readthedocs.io/en/v1.1/concepts/#endpoint" target="_blank" rel="noopener noreferrer">Endpoints</a>형태로 표현된다. 아래와 같이 ingress, egress policy를 확인할수 있고 아직 아무런 network policy 적용을 하지 않았기 때문에 모두 <code>Disabled</code> 상태로 보인다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system get pods -l k8s-app=cilium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cilium-jmxk2   1/1       Running   0          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                    IPv6                 IPv4            STATUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ENFORCEMENT        ENFORCEMENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5023       Disabled           Disabled          2008       k8s:io.cilium.k8s.policy.serviceaccount=istio-ingress-service-account          f00d::a0f:0:0:139f   10.15.170.241   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7415       Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:1cf7   10.15.16.224    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7979       Disabled           Disabled          4          reserved:health                                                                f00d::a0f:0:0:1f2b   10.15.96.215    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17917      Disabled           Disabled          60941      k8s:class=tiefighter                                                           f00d::a0f:0:0:45fd   10.15.58.61     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">22602      Disabled           Disabled          53004      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:584a   10.15.190.2     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=telemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">31992      Disabled           Disabled          33709      k8s:io.cilium.k8s.policy.serviceaccount=istio-egressgateway-service-account    f00d::a0f:0:0:7cf8   10.15.85.192    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=egressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">33958      Disabled           Disabled          64389      k8s:io.cilium.k8s.policy.serviceaccount=istio-citadel-service-account          f00d::a0f:0:0:84a6   10.15.59.151    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=citadel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">49215      Disabled           Disabled          40629      k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:c03f   10.15.48.171    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio-mixer-type=policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=mixer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55129      Disabled           Disabled          9270       k8s:class=deathstar                                                            f00d::a0f:0:0:d759   10.15.17.253    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55930      Disabled           Disabled          46893      k8s:app=prometheus                                                             f00d::a0f:0:0:da7a   10.15.196.220   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57491      Disabled           Disabled          775        k8s:io.cilium.k8s.policy.serviceaccount=istio-mixer-service-account            f00d::a0f:0:0:e093   10.15.253.210   ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=statsd-prom-bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57651      Disabled           Disabled          44171      k8s:io.cilium.k8s.policy.serviceaccount=istio-ingressgateway-service-account   f00d::a0f:0:0:e133   10.15.74.164    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=ingressgateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61352      Disabled           Disabled          888        k8s:io.cilium.k8s.policy.serviceaccount=istio-pilot-service-account            f00d::a0f:0:0:efa8   10.15.118.68    ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:istio=pilot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61355      Disabled           Disabled          36797      k8s:class=xwing                                                                f00d::a0f:0:0:efab   10.15.56.79     ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:io.kubernetes.pod.namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           k8s:org=alliance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 상태에서는 모든 우주선이 deathstar에 착륙이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l3l4-policy-적용">L3/L4 Policy 적용<a class="hash-link" href="#l3l4-policy-적용" title="Direct link to heading">​</a></h2><p>결국 하고 싶은건 제국군 우주선 즉, tiefighter만 접근이 가능해야 하므로 아래처럼 정책을 설정한다. </p><p>정책은 직관적으로 설정이 가능하다.</p><p><code>org=empire, class=deathstar</code> label을 가진 endpoint로의 ingress 방향의 80포트 접근은 <code>org=empire</code> label을 가진 pod만 가능하도록 한다는 의미이다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: "cilium.io/v2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: "L3-L4 policy to restrict deathstar access to empire ships only"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: "rule1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: "80"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는 </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_policy.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 설정하고 나서 tiefighter를 착륙시켜보자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상착륙!<br>
<!-- -->이번에는 xwing 차례</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>착륙실패!</p><p>이어서 정책을 다시 확인해보면 Enabled로 변한 정책 2개를 확인할 수 있다.<br>
<!-- -->(pod가 2개이므로 2개의 정책을 볼 수 있다)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n kube-system exec cilium-jmxk2 -- cilium endpoint list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>상세 정책 확인 (Very Simple!!)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get cnp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar   2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule1           5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$  kubectl describe cnp rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    30312</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  65</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="l7-정책-적용">L7 정책 적용<a class="hash-link" href="#l7-정책-적용" title="Direct link to heading">​</a></h2><p>마지막으로 deathstar API를 호출하는 서비스에 대한 정책을 제어하는것을 테스트해본다.</p><p>아래 예시처럼 exhaust-port API(포트를 소진시키는 API)를 수행하면 특정 pod가 에러가 나고 재기동 되는것을 확인할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Panic: deathstar exploded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goroutine 1 [running]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:9 +0x64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /code/src/github.com/empire/deathstar/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp/main.go:5 +0x85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   0/1       Error     0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-mqgfs   1/1       Running   1          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deathstar-566c89f458-wlc4c   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tiefighter                   1/1       Running   0          1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xwing                        1/1       Running   0          1h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그래서 이번에는 exhaust-port API는 차단하고 request-landing API만 허용하는 정책을 테스트해본다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: "cilium.io/v2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description: "L7 policy to restrict access to specific HTTP call"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: "rule1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpointSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      class: deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - fromEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org: empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toPorts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - port: "80"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - method: "POST"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path: "/v1/request-landing"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또는</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.1/examples/minikube/sw_l3_l4_l7_policy.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ciliumnetworkpolicy.cilium.io/rule1 configured</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 동일한 테스트를 해보면 다른 결과를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ship landed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access denied</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>다시한번 상세 정책 확인을 해보면 ingress POST 허용정책을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe ciliumnetworkpolicies rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"cilium.io/v2","description":"L7 policy to restrict access to specific HTTP call","kind":"CiliumNetworkPolicy","metadata":{"annotations":...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API Version:  cilium.io/v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kind:         CiliumNetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cluster Name:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Creation Timestamp:  2018-07-06T07:25:15Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Generation:          0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Resource Version:    32814</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Self Link:           /apis/cilium.io/v2/namespaces/default/ciliumnetworkpolicies/rule1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UID:                 ba0d7964-80ed-11e8-8077-080027b1075c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoint Selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Class:  deathstar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Any : Org:    empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From Endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Match Labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Any : Org:  empire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    To Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Port:      80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Protocol:  TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Method:  POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Path:    /v1/request-landing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nodes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Minikube:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Kubectl . Kubernetes . Io / Last - Applied - Configuration:  {"apiVersion":"cilium.io/v2","description":"L7 policy to restrict access to specific HTTP call","kind":"CiliumNetworkPolicy","metadata":{"annotations":{},"name":"rule1","namespace":"default"},"spec":{"endpointSelector":{"matchLabels":{"class":"deathstar","org":"empire"}},"ingress":[{"fromEndpoints":[{"matchLabels":{"org":"empire"}}],"toPorts":[{"ports":[{"port":"80","protocol":"TCP"}],"rules":{"http":[{"method":"POST","path":"/v1/request-landing"}]}}]}]}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enforcing:              true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Last Updated:           0001-01-01T00:00:00Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Local Policy Revision:  70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Ok:                     true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:                       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cilium CLI로도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl -n kube-system exec cilium-jmxk2 cilium policy get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "endpointSelector": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "matchLabels": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "reserved:init": ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "ingress": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "fromEntities": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "host"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "egress": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "toPorts": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ports": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "port": "53",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "protocol": "UDP"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "toEntities": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "all"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "toEndpoints": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "matchLabels": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "k8s:io.kubernetes.pod.namespace": "istio-system"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "labels": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "key": "io.cilium.k8s.policy.name",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "value": "istio-sidecar",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "source": "k8s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "key": "io.cilium.k8s.policy.namespace",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "value": "default",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "source": "k8s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "endpointSelector": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "matchLabels": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "any:class": "deathstar",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "any:org": "empire",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "k8s:io.kubernetes.pod.namespace": "default"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "ingress": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "fromEndpoints": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "matchLabels": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "any:org": "empire",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "k8s:io.kubernetes.pod.namespace": "default"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "toPorts": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "ports": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "port": "80",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "protocol": "TCP"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "rules": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "http": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "path": "/v1/request-landing",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "method": "POST"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "labels": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "key": "io.cilium.k8s.policy.name",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "value": "rule1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "source": "k8s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "key": "io.cilium.k8s.policy.namespace",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "value": "default",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "source": "k8s"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revision: 71</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이외에도 Cilium Metric을 Prometheus에서 확인하는것도 간단하게 할수 있다고 한다. </p><p>여기까지가 기본적으로 L3/L4, L7 기반 network policy를 적용해본것이고 다음번에는 istio와 연계 부분이나 실제 Cluster 구성방법에 대해서 다뤄보도록 하겠다.</p>]]></content>
        <category label="Cilium" term="Cilium"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="network policy" term="network policy"/>
        <category label="Istio" term="Istio"/>
        <category label="BPF" term="BPF"/>
        <category label="CNI" term="CNI"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spinnaker on Kubernetes #1]]></title>
        <id>/2018/07/03/spinnaker-advanced-1</id>
        <link href="https://ddii.dev/2018/07/03/spinnaker-advanced-1"/>
        <updated>2018-07-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Spinnaker에 대해 알아봅니다 #1]]></summary>
        <content type="html"><![CDATA[<p>지난번 <a href="https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster" target="_blank" rel="noopener noreferrer">OpenInfraDay발표</a>때 질문을 해주셨는데 요즘 Spinnaker를 많이들 쓰거나 검토를 많이 하는것으로 알고 있다.  </p><p>Spinnaker를 설치하는 내용은 많이 있으니 아래 halyard로 설치하는 포스트를 참고하면 된다.</p><p><a href="https://yunsangjun.github.io/blog/spinnaker/2018/06/03/installing-spinnaker.html" target="_blank" rel="noopener noreferrer">윤상준의 기술 블로그 - Spinnaker 설치하기</a></p><p>이번에 이야기하고자 하는 부분은 실제 Spinnaker를 설치하고 난 후 운영상에 고려해야할 부분들과 팁들을 공유해보려고 한다.</p><p>사실 Spinnaker를 구성하면서 가장 어려웠던 부분들은 용어, halyard config 관리와 custom resourse 인식부분 이였다. 나머지들은 뭐 튜토리얼을 따라가면 별로 어렵진 않으니 아래 내용을 차근차근 따라가면서 이해하면 될것 같다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="용어들">용어들<a class="hash-link" href="#용어들" title="Direct link to heading">​</a></h2><p>사용하면서 혼돈이 많이 생기는 부분이다 이게 GCE나 EC2를 쓰면 용어 매칭이 쉬운데 k8s를 위한 별도의 메뉴가 아닌 기능을 통합하다보니 용어가 조금 혼동스럽게 구성이 되었다.<br>
<!-- -->특히 Load Balancer 부분은 Service로 매핑되고 퍼블릭 k8s에서 제공하는 Type LoadBalancer는 미지원한다.<br>
<!-- -->그리고 모든 Resource들은 Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)을 지원하며 Versioning이 지원된다.  Versioning은 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy" target="_blank" rel="noopener noreferrer">여기</a>에 설명된 대로 <code>strategy.spinnaker.io/versioned</code> annotation을 통해 manifest별로 재정의가 가능하다.</p><table><thead><tr><th align="center">Spinnaker</th><th align="center">Kubernetes</th><th align="center">비고</th></tr></thead><tbody><tr><td align="center">Server Group</td><td align="center"><a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a></td><td align="center"><a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">CRD의 경우 별도 Build</a></td></tr><tr><td align="center">Clusters</td><td align="center">Logical Server Group</td><td align="center"></td></tr><tr><td align="center">Load Balancer</td><td align="center">Services</td><td align="center">LoadBalancer(k8s) 미지원</td></tr><tr><td align="center">Firewall</td><td align="center">NetworkPolicies</td><td align="center"></td></tr></tbody></table><p>Spinnaker Server Group으로 분류 된 항목은 모두 Spinnaker의 클러스터 탭에 표시가 된다. 가능한 경우 모든 포드가 표기되지만, 해당 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a> 이외의 CRD(Custom Resource Definition)는 halconfig에서 아래와 같이 customResources config를 추가하면 deploy는 가능하나 Spinnaker UI에서 보이지는 않는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-k8s-account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        customResources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - kubernetesKind: GameServer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이유는 바로 다음 링크처럼 <a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">(CRD의 경우 별도 Build필요)</a>
별도로 Java를 빌드해야 한다. Spinnaker Slack에 문의를 몇번했는데 질문하는 사람만 있고 답은 아무도 안해준다는...<br>
<a href="https://spinnakerteam.slack.com/" target="_blank" rel="noopener noreferrer">https://spinnakerteam.slack.com/</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jenkins-연동">Jenkins 연동<a class="hash-link" href="#jenkins-연동" title="Direct link to heading">​</a></h2><p><a href="https://www.spinnaker.io/setup/ci/jenkins/" target="_blank" rel="noopener noreferrer">Spinnaker, Jenkins integration 상세내용 공식문서 </a></p><p>Jenkins와 연동하면서 가장 어이없이 헤맨부분은 아래 그림처럼 되어있어야 하는데 Security Realm을 Jenkins Default admin 계정만을 가지고 integration 하려다가 계속 실패하였다. Delegate to servlet container 말고 Jenkins 자체 사용자 DB로 별도 계정을 생성하고 아래 그림처럼 설정을 해야한다.</p><p><img loading="lazy" alt="Jenkins Config" src="/assets/images/jenkins_config-ebc060e294614bf3e83967c95b1cb527.png" width="896" height="778" class="img_E7b_"></p><p>위 설정 이후 아래와 같이 Spinnaker UI에서 Jenkins API연동이 가능하다.  </p><p><img loading="lazy" alt="Spinnaker Jenkins" src="/assets/images/spin_jenkins-dd2e9b5ec5faf44637c141dba0020e45.png" width="1176" height="888" class="img_E7b_"></p><p>오늘은 여기까지만 하고 다음글에서는 배포전략이나 Network Policy 연동등을 상세히 적어볼 예정이다.</p>]]></content>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Spinnaker" term="Spinnaker"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Provisioning Dedicated Game Server on Kubernetes Cluster]]></title>
        <id>/2018/07/01/openinfraday18</id>
        <link href="https://ddii.dev/2018/07/01/openinfraday18"/>
        <updated>2018-07-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Provisioning Dedicated Game Server on Kubernetes Cluster]]></summary>
        <content type="html"><![CDATA[<p>6월 28일에 Openinfraday에서 발표한 내용</p><p><a href="https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://image.slidesharecdn.com/43dgs06270307-180628163517/95/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster-1-638.jpg?cb=1530203766" alt="Slideshare" class="img_E7b_"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="발표-영상">발표 영상<a class="hash-link" href="#발표-영상" title="Direct link to heading">​</a></h2><p><a href="https://youtu.be/LtGGzKBoVZQ?t=0s" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="http://img.youtube.com/vi/LtGGzKBoVZQ/0.jpg" alt="Video" class="img_E7b_"></a></p><p>Custom Resource 에 대한 내용은 상세하게 더 정리해야겠다.</p>]]></content>
        <category label="CI/CD" term="CI/CD"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Agones" term="Agones"/>
        <category label="Spinnaker" term="Spinnaker"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Mutating Webhook]]></title>
        <id>/2018/06/27/mutating-web-hook</id>
        <link href="https://ddii.dev/2018/06/27/mutating-web-hook"/>
        <updated>2018-06-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Mutating Webhook에 대해 알아봅니다]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="admission-controller-확장">Admission controller 확장<a class="hash-link" href="#admission-controller-확장" title="Direct link to heading">​</a></h2><p>Kubernetes(이하 k8s)기반 개발 과제를 수행하다보니 Custom Resource를 사용할수 밖에 없는 상황들이 발생하였다.<br>
<!-- -->그런 와중에 istio와 같은 Service Mesh Layer를 리서치하던 중에 튀어나온 MutatingAdmissionWebhook 용어를 이해하기 위에 조사한 내용을 정리해본다.</p><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/</a></p><p>Admission controller는 쿠버네티스 api-server의 오브젝트(Pod,등) 생성 요청을 가로체어 제어를 할 수 있는 확장 기능으로 플러그인 형태로 사용자가 추가 할 수 있다.<br>
<!-- -->좀더 자세히 확인해보자 </p><ul><li>클러스터 관리자가 kube-api를 직접 컴파일 하고 구성해야 하기 때문에 유연하게 사용하기 어려움</li><li>1.7 버전 이후부터는 이러한 제한사항을 해결하기 위해 alpha feature로  <a href="https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#initializers" target="_blank" rel="noopener noreferrer">Initializers</a> 와 <a href="https://v1-9.docs.kubernetes.io/docs/admin/extensible-admission-controllers/#external-admission-webhooks" target="_blank" rel="noopener noreferrer">External Admission Webhooks</a> 기능이 도입됨</li><li>External Admission Webhooks 는 k8s 리소스의 유효성 검사를 하는데 활용, 유효성 검사를 통과 하지 못하면 해 당 리소스는 쿠버네티스에서 생성되질 않게 할 수 있음.</li><li>1.9 버전에서는 External Admission Webhooks 은 beta로 승격되어 MutatingAdmissionWebhook 및 ValidatingAdmissionWebhook으로 나눠졌지만 Initializers 는 alpha 로 유지됨</li><li>MutatingAdmissionWebhook 은 유효성 검사 이외에도 승인 과정시 k8s object에 변경을 할수 있음<ul><li>예를 들면 resource quota를 변경한다던지  Agones 및 istio와 같은 Custom Resource 를 수정하여 object를 생성이 가능함</li><li>Webhook 방식은 gRPC 프로토콜을 사용하는 데 개발언어에 구애 받지 않고 확장을 할 수 있다는 장점이 있음</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="webhook을-언제-쓰는가">Webhook을 언제 쓰는가?<a class="hash-link" href="#webhook을-언제-쓰는가" title="Direct link to heading">​</a></h2><p>Webhook을 사용하여 k8s cluster-admin이 api-server를 다시 컴파일하지 않고도 object생성 요청시 mutating(변경) 및 validation(유효성검증) 을 하는 플러그인을 만들 수 있다. </p><p>이를 통해 개발자는 모든 resource 에서 여러 작업 ( "CREATE", "UPDATE", "DELETE"...)에 대한 승인 로직에 대해 사용자 정의 할 수있는 유연성을 제공받는다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="use-case">Use-Case<a class="hash-link" href="#use-case" title="Direct link to heading">​</a></h2><ul><li><p>resource를 생성하기 전에 변경<br>
<!-- -->(예, Istio 에서 처럼 traffic management 와 policy enforcement 을 위해 Envoy sidecar container를 injection)</p></li><li><p>StorageClass Provisioning 자동화<br>
<!-- -->(PersistentVolumeClaim object 생성을 모니터링하고 미리 정의 된 정책에 따라 객체에 storage를 자동으로 추가. 사용자는 StorageClass 생성 에 신경 쓸 필요가 없음)</p></li><li><p>복잡한 custom resource 검증 (Agones와 같은)namespace 제한<br>
<!-- -->멀티 테넌트 시스템에서는 reserved namespace에 resource생성을 금지시킬때 사용할수 있음</p></li><li><p>참고 예시<br>
<a href="https://github.com/kelseyhightower/denyenv-validating-admission-webhook" target="_blank" rel="noopener noreferrer">https://github.com/kelseyhightower/denyenv-validating-admission-webhook</a></p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="어떻게-동작하는가">어떻게 동작하는가?<a class="hash-link" href="#어떻게-동작하는가" title="Direct link to heading">​</a></h2><p>MutatingWebhookConfiguration 내에 정의된 룰에 따라 etcd로 전달되기 전에 request를 intercept한다.<br>
<!-- -->webhook 서버에 승인 요청을 전송하여 변이를 실행한다.<br>
<!-- -->webhook 서버는 API를 준수하는 단순한 http서버.</p><p><img loading="lazy" alt="Alt text" src="/assets/images/mutating-b4b8965d675e621d8560c81accf497c7.jpg" width="1600" height="1643" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="튜토리얼">튜토리얼<a class="hash-link" href="#튜토리얼" title="Direct link to heading">​</a></h2><p><a href="https://github.com/morvencao/kube-mutating-webhook-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/morvencao/kube-mutating-webhook-tutorial</a>  </p><p>위 튜토리얼은 object가 생성되기 전에 pod에 nginx sidecar container를 inject하는 MutatingAdmissionWebhook을 배포하는 내용을 담고 있다.</p><p>우선 admissionregistration.k8s.io/v1beta1 API를 사용할수 있는 k8s 1.9+ 이상의 클러스터가 필요하다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="확인방법">확인방법<a class="hash-link" href="#확인방법" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl api-versions | grep admissionregistration.k8s.io/v1beta1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>아래와 같은 결과가 나와야함</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">admissionregistration.k8s.io/v1beta1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build하기">Build하기<a class="hash-link" href="#build하기" title="Direct link to heading">​</a></h2><p>일단 Go가 설치되어 있어야 한다.
<code>~/go/src</code> 아래에 clone을 하였음.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd ~/go/src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/morvencao/kube-mutating-webhook-tutorial.git</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>의존성 관리를 위해 repo는 dep를 사용함</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go get -u github.com/golang/dep/cmd/dep</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build 파일 확인하고 registry 위치를 바꿈</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">dep ensure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o kube-mutating-webhook-tutorial .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build --no-cache -t registry.*****.io/agones/sidecar-injector:v1 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push registry.*****.io/agones/sidecar-injector:v1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build하고 docker image push</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sending build context to Docker daemon  44.29MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1/3 : FROM alpine:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 3fd9065eaf02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2/3 : ADD kube-mutating-webhook-tutorial /kube-mutating-webhook-tutorial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 8679ccbab536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3/3 : ENTRYPOINT ["./kube-mutating-webhook-tutorial"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; Running in 7699ff5c0885</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Removing intermediate container 7699ff5c0885</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---&gt; 2014100d460e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully built 2014100d460e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully tagged registry.*****.io/agones/sidecar-injector:v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The push refers to repository [registry.*****.io/agones/sidecar-injector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2456c1309a51: Pushed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd7100a72410: Layer already exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v1: digest: sha256:15c335daeba40ddcbfbc3631ab6daa7cf623b63420f0ae8b657755322ef0582d size: 739</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>sidecar deployment에 사용되는 secret(cert/key)을 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./deployment/webhook-create-signed-cert.sh \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --service sidecar-injector-webhook-svc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret sidecar-injector-webhook-certs \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 생성된 클러스터의 caBundle값을 가지고 MutatingWebhookConfiguration 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat deployment/mutatingwebhook.yaml | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deployment/webhook-patch-ca-bundle.sh &gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deployment/mutatingwebhook-ca-bundle.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>resource들 deploy</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f deployment/nginxconfigmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/configmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f deployment/mutatingwebhook-ca-bundle.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap "nginx-configmap" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap "sidecar-injector-webhook-configmap" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions "sidecar-injector-webhook-deployment" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service "sidecar-injector-webhook-svc" created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mutatingwebhookconfiguration.admissionregistration.k8s.io "sidecar-injector-webhook-cfg" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>webhook deployment 확인</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment   1         1         1            1           3m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>default 네임스페이스에 sidecar-injector 라벨링을 한다. 이렇게 하면 해당 네임스페이스에 생성되는 모든 app에 자동으로 injection하게 됨</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespace -L sidecar-injector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             STATUS    AGE       SIDECAR-INJECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agones-system    Active    1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default          Active    19d       enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ibm-cert-store   Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ibm-system       Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-test     Active    6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public      Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system      Active    19d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spinnaker        Active    12d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xonotic          Active    1d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>샘플앱을 디플로이 해보자</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat &lt;&lt;EOF | kubectl create -f -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sidecar-injector-webhook.morven.me/inject: "yes"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: tutum/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command: ["/bin/sleep","infinity"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.extensions "sleep" created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>sidecar container injection 확인<br>
<!-- -->아래 결과를 보면 하나의 deployment 하나의 container 생성을 요청했지만 nginx sidecar 컨테이너가 injection 된것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sidecar-injector-webhook-deployment-796955558f-js6bb   1/1       Running   0          2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleep-74b46f8bd7-r9l7f                                 2/2       Running   0          42s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe pod sleep-74b46f8bd7-r9l7f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:           sleep-74b46f8bd7-r9l7f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:      default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node:           10.178.188.16/10.178.188.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start Time:     Wed, 27 Jun 2018 13:12:47 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:         app=sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pod-template-hash=3060294683</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:    kubernetes.io/psp=ibm-privileged-psp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sidecar-injector-webhook.morven.me/inject=yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sidecar-injector-webhook.morven.me/status=injected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:         Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP:             172.30.169.30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controlled By:  ReplicaSet/sleep-74b46f8bd7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sleep:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container ID:  docker://728ca7f8e741ad29369312bc006c79683e7e605f3b04586df2477e233f93e451</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:         tutum/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image ID:      docker-pullable://tutum/curl@sha256:b6f16e88387acd4e6326176b212b3dae63f5b2134e69560d0b0673cfb0fb976f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:          &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:     &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Wed, 27 Jun 2018 13:13:01 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Restart Count:  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:    &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-czzpj (ro)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sidecar-nginx:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container ID:   docker://94fd41a0e153de6d5639873ccbd6b6325cee1ea8351dd02ab4a48ab4004d0b58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:          nginx:1.12.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image ID:       docker-pullable://nginx@sha256:72daaf46f11cc753c4eab981cbf869919bd1fee3d2170a2adeac12400f494728</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:           80/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:      0/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Wed, 27 Jun 2018 13:13:08 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Restart Count:  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:    &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/nginx from nginx-conf (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Conditions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Type           Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Initialized    True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ready          True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PodScheduled   True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default-token-czzpj:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type:        Secret (a volume populated by a Secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SecretName:  default-token-czzpj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional:    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nginx-conf:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type:        ConfigMap (a volume populated by a ConfigMap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name:        nginx-configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional:    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QoS Class:       BestEffort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node-Selectors:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Type    Reason                 Age   From                    Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ----    ------                 ----  ----                    -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Scheduled              1m    default-scheduler       Successfully assigned sleep-74b46f8bd7-r9l7f to 10.178.188.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume "nginx-conf"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  SuccessfulMountVolume  1m    kubelet, 10.178.188.16  MountVolume.SetUp succeeded for volume "default-token-czzpj"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulling                1m    kubelet, 10.178.188.16  pulling image "tutum/curl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulled                 55s   kubelet, 10.178.188.16  Successfully pulled image "tutum/curl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Created                55s   kubelet, 10.178.188.16  Created container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Started                55s   kubelet, 10.178.188.16  Started container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulling                55s   kubelet, 10.178.188.16  pulling image "nginx:1.12.2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Pulled                 48s   kubelet, 10.178.188.16  Successfully pulled image "nginx:1.12.2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Created                48s   kubelet, 10.178.188.16  Created container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Normal  Started                48s   kubelet, 10.178.188.16  Started container</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>결국 위에서 언급한것 처럼 MutationWebhook은 istio RouteRule같은 별도의 CustomResource등을 injection 하거나 agones 등과 같이 게임서버외에 client sdk 통신을 위한 injection 형태로 기존 resource에 추가적인 변경(mutation) 또는 검증(validation)등의 추가적인 작업을 kube-api의 컴파일없이 가능하다는데 목적이 있다고 볼 수 있다. 추가적으로 기능에 대한 내용은 이후 다시 정리해볼 예정이다.</p>]]></content>
        <category label="Mutating Webhook" term="Mutating Webhook"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Admission Controller" term="Admission Controller"/>
        <category label="Istio" term="Istio"/>
        <category label="Agones" term="Agones"/>
    </entry>
</feed>